{
  "hash": "7085aaf7ed69c8c01eb166f90f53c15f",
  "result": {
    "engine": "jupyter",
    "markdown": "---\ntitle: 【データ管理】DVCの設定まとめ\ndescription: |\n  サービスアカウントを使ったDVCの設定方法をまとめます。\ndate: 2025-06-01\ndate-modified: 2026-02-01\ncategories:\n- DVC\nimage: image/dvc_share_mail.png\naliases:\n- /pages/tips/250601_dvc/index.html\n---\n\n## はじめに\n\nDVCはデータのバージョン管理ツールで、GitHubの容量制限（100MiB）を超えるデータをGoogle Driveなどの外部ストレージで管理できます。\n\nDVCでGoogle Driveをリモートストレージとして使う場合、認証方法には主にOAuthとサービスアカウントの2つがあります。\n\n| | OAuth | サービスアカウント |\n|---|---|---|\n| 設定の手軽さ | やや複雑 | シンプル |\n| トークン管理 | 定期的に再認証が必要 | 不要（キーファイルで認証） |\n| 共有のしやすさ | 各自が認証を行う | キーファイルを共有するだけ |\n\n本記事ではサービスアカウントを使った方法を解説します。\n\n開発コンテナでの利用を想定していますが、それ以外の環境でも同様の手順で設定できます。開発コンテナの環境構築については[こちらの記事](/pages/tips/2024/12/241219_container/index.qmd)を参考にしてください。\n\n## 前提条件\n\n以下がインストールされていることを前提とします。\n\n- Python（pipが使える状態）\n- Git\n\nDVCとGoogle Drive用のパッケージをインストールしてください。\n\n``` {.sh filename=\"Terminal\"}\npip install dvc dvc-gdrive\n```\n\n## サービスアカウントの作成\n\nGoogle Cloudのサービスアカウントは、人ではなくアプリケーションがGoogle APIにアクセスするための仕組みです。DVCがGoogle Driveにアクセスするために使用します。\n\n1.  [Google Cloud Console](https://console.cloud.google.com/)へアクセス\n2.  画面上部のボックスからプロジェクトを作成\n    - 左上にGoogle Cloudと書いてある部分の右です。\n    - 出てくるウィンドウの右上から作れます。\n\n![](image/new_project.png){fig-align=\"center\" width=\"60%\"}\n\n3.  画面左のメニューから「IAMと管理」を選択\n    - 左にメニューがない場合は左上の3本線から開けます。\n4.  サイドバーの真ん中上あたりから「サービスアカウント」を選択\n5.  画面上部の「サービスアカウントを作成」へ進む\n6.  任意の名前と説明を入力し、完了を押下\n    - 権限のところはスキップで構いません。\n\n![](image/create_service_account.png){fig-align=\"center\" width=\"60%\"}\n\n7.  メールの列に書いてある長いメールアドレスをコピーしておく\n    - 後ほどGoogle Driveのフォルダにこのアドレスを共有します。\n8.  作成したサービスアカウントの一番右にある「操作」から「鍵を管理」を選択\n    - 長いメールアドレスの右側にある点々の部分です。\n9.  「キーを追加」→「新しい鍵を作成」→「JSON」を選択し、作成へ進む\n10. ファイルとして保存されるので、作業ディレクトリの`.secrets`フォルダに保存する\n    - `.secrets`フォルダがなければ作成してください。\n    - ファイル名は`key.json`などわかりやすいもので構いません。\n\n## Google Driveの設定\n\n1.  Google Driveの任意の場所にデータ保管用のフォルダを作成\n2.  フォルダの共有設定から、先ほどコピーしたサービスアカウントのメールアドレスを貼り付け、「編集者」権限で共有\n\n![メールアドレスを貼り付け、権限を「編集者」にして共有します](image/dvc_share_mail.png){fig-align=\"center\" width=\"50%\"}\n\n3.  フォルダのIDをコピー\n    - IDは、ドライブでフォルダを開いたときのURLで、最後のスラッシュ（\\~/folders/）より右側の部分です。\n\n## DVCの初期化とリモート設定\n\nターミナルで以下のコマンドを順番に実行します。\n\n### リモートの追加\n\nフォルダIDの部分を、先ほどコピーしたIDに置き換えてください。\n\n``` {.sh filename=\"Terminal\"}\ndvc init && dvc remote add -d myremote gdrive://[Google DriveのフォルダID]\n```\n\n### サービスアカウントの有効化\n\n``` {.sh filename=\"Terminal\"}\ndvc remote modify myremote gdrive_use_service_account true\n```\n\n### キーファイルのパスを設定\n\n`--local`を付けることで、この設定は`.dvc/config.local`に保存され、Gitには追跡されません。フォルダ名やファイル名を変更した場合は、適宜修正してください。\n\n``` {.sh filename=\"Terminal\"}\ndvc remote modify myremote --local \\\n    gdrive_service_account_json_file_path .secrets/key.json\n```\n\n## セキュリティ設定\n\n`.secrets`フォルダにはサービスアカウントのキーファイルが含まれています。これは機密情報なので、必ず`.gitignore`に追記してGitの追跡対象から外してください。\n\n``` {filename=\".gitignore\"}\n/.secrets/\n```\n\nこれで`.secrets`フォルダの中身がGitにコミットされることはありません。\n\n## データの追加とプッシュ\n\n以上で設定は完了です。あとはデータを管理していきましょう。\n\n1.  ワーキングディレクトリに`data`フォルダを作成し、データを追加\n2.  DVCにデータを登録\n\n``` {.sh filename=\"Terminal\"}\ndvc add data/\n```\n\n3.  Google Driveにプッシュ\n\n``` {.sh filename=\"Terminal\"}\ndvc push\n```\n\n4.  データをダウンロードしたい場合\n\n``` {.sh filename=\"Terminal\"}\ndvc pull\n```\n\n## 共同作業者の設定\n\n共同研究で他のメンバーとデータを共有する場合、以下の手順が必要です。\n\n### キーファイルの共有\n\n`.secrets`フォルダはGitで追跡されないため、クローンしただけでは含まれません。キーファイルはメールやチャットなど別の手段で共有し、ワーキングディレクトリに`.secrets/key.json`として配置してもらってください。\n\n### DVCの設定\n\n共同作業者は以下のコマンドを順番に実行して、リモートの設定を行います。\n\n``` {.sh filename=\"Terminal\"}\ndvc remote modify myremote gdrive_use_service_account true\n```\n\n``` {.sh filename=\"Terminal\"}\ndvc remote modify myremote --local \\\n    gdrive_service_account_json_file_path .secrets/key.json\n```\n\nこれにより、`.dvc/config.local`に以下のような内容が書き込まれます。\n\n```\n['remote \"myremote\"']\n    gdrive_service_account_json_file_path = ../.secrets/key.json\n```\n\n::: callout-note\nパスが`../.secrets/key.json`となるのは、`.dvc/config.local`から見た相対パスだからです。`.dvc/config.local`もGitで追跡されないため、各自が設定する必要があります。\n:::\n\n設定が完了したら、`dvc pull`でデータをダウンロードできます。\n\n``` {.sh filename=\"Terminal\"}\ndvc pull\n```\n\n## おわりに\n\nサービスアカウントを使ったDVCの設定方法を紹介しました。OAuthと比べてトークンの再認証が不要になるため、運用面でのストレスが軽減されます。\n\n何かあればコメントでお知らせください。\n\n",
    "supporting": [
      "index_files"
    ],
    "filters": [],
    "includes": {}
  }
}