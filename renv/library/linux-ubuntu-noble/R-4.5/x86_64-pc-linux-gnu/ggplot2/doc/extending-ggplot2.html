<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="ja" xml:lang="ja"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.9.13">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="description" content="Official extension mechanism provided in ggplot2.">

<title>Extending ggplot2 – Yosuke Abe</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
html { -webkit-text-size-adjust: 100%; }
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="../../../../../../../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../../../../../../../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../../../../../../../site_libs/clipboard/clipboard.min.js"></script>
<script src="../../../../../../../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../../../../../../../site_libs/quarto-search/fuse.min.js"></script>
<script src="../../../../../../../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../../../../../../../">
<link href="../../../../../../../assets/icons/favicon.ico" rel="icon">
<script src="../../../../../../../site_libs/quarto-html/quarto.js" type="module"></script>
<script src="../../../../../../../site_libs/quarto-html/tabsets/tabsets.js" type="module"></script>
<script src="../../../../../../../site_libs/quarto-html/axe/axe-check.js" type="module"></script>
<script src="../../../../../../../site_libs/quarto-html/popper.min.js"></script>
<script src="../../../../../../../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../../../../../../../site_libs/quarto-html/anchor.min.js"></script>
<link href="../../../../../../../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../../../../../../../site_libs/quarto-html/quarto-syntax-highlighting-ac077c1e730dfeb5e42400639d17284e.css" rel="stylesheet" class="quarto-color-scheme" id="quarto-text-highlighting-styles">
<link href="../../../../../../../site_libs/quarto-html/quarto-syntax-highlighting-dark-ea00d30dd9b950c7ecb6e17bc6ca0835.css" rel="stylesheet" class="quarto-color-scheme quarto-color-alternate" id="quarto-text-highlighting-styles">
<link href="../../../../../../../site_libs/quarto-html/quarto-syntax-highlighting-ac077c1e730dfeb5e42400639d17284e.css" rel="stylesheet" class="quarto-color-scheme-extra" id="quarto-text-highlighting-styles">
<script src="../../../../../../../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../../../../../../../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../../../../../../../site_libs/bootstrap/bootstrap-82143f91fd01f2dc60cbce86172fc9e5.min.css" rel="stylesheet" append-hash="true" class="quarto-color-scheme" id="quarto-bootstrap" data-mode="light">
<link href="../../../../../../../site_libs/bootstrap/bootstrap-dark-fee13de3c7405b6753882dfb8c345392.min.css" rel="stylesheet" append-hash="true" class="quarto-color-scheme quarto-color-alternate" id="quarto-bootstrap" data-mode="dark">
<link href="../../../../../../../site_libs/bootstrap/bootstrap-82143f91fd01f2dc60cbce86172fc9e5.min.css" rel="stylesheet" append-hash="true" class="quarto-color-scheme-extra" id="quarto-bootstrap" data-mode="light">
<link href="../../../../../../../site_libs/quarto-contrib/fontawesome6-6.7.2/all.min.css" rel="stylesheet">
<link href="../../../../../../../site_libs/quarto-contrib/fontawesome6-6.7.2/latex-fontsize.css" rel="stylesheet">
<script src="../../../../../../../site_libs/quarto-contrib/iconify-3.0.0/iconify-icon.min.js"></script>
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "language": {
    "search-no-results-text": "一致なし",
    "search-matching-documents-text": "一致した文書",
    "search-copy-link-title": "検索へのリンクをコピー",
    "search-hide-matches-text": "追加の検索結果を非表示",
    "search-more-match-text": "追加の検索結果",
    "search-more-matches-text": "追加の検索結果",
    "search-clear-button-title": "消去",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "キャンセル",
    "search-submit-button-title": "検索",
    "search-label": "サーチ"
  }
}</script>
<script async="" src="https://www.googletagmanager.com/gtag/js?id=G-N3ZP99BG08"></script>

<script type="text/javascript">

window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());
gtag('config', 'G-N3ZP99BG08', { 'anonymize_ip': true});
</script>


<meta property="og:title" content="Extending ggplot2 – Yosuke Abe">
<meta property="og:description" content="Official extension mechanism provided in ggplot2.">
<meta property="og:image" content="https://yo5uke.com/renv/library/linux-ubuntu-noble/R-4.5/x86_64-pc-linux-gnu/ggplot2/doc/extending-ggplot2_files/figure-html/unnamed-chunk-4-1.png">
<meta property="og:site_name" content="Yosuke Abe">
<meta property="og:image:alt" content="Scatterplot of engine displacement versus highway miles per gallon, for 234 cars. The convex hull of all the points is marked by a polygon with no fill.">
<meta property="og:image:height" content="1344">
<meta property="og:image:width" content="1344">
<meta name="twitter:title" content="Extending ggplot2 – Yosuke Abe">
<meta name="twitter:description" content="Official extension mechanism provided in ggplot2.">
<meta name="twitter:image" content="https://yo5uke.com/renv/library/linux-ubuntu-noble/R-4.5/x86_64-pc-linux-gnu/ggplot2/doc/extending-ggplot2_files/figure-html/unnamed-chunk-4-1.png">
<meta name="twitter:creator" content="@5uke_y">
<meta name="twitter:site" content="@5uke_y">
<meta name="twitter:image:alt" content="Scatterplot of engine displacement versus highway miles per gallon, for 234 cars. The convex hull of all the points is marked by a polygon with no fill.">
<meta name="twitter:image-height" content="1344">
<meta name="twitter:image-width" content="1344">
<meta name="twitter:card" content="summary_large_image">
</head>

<body class="nav-fixed quarto-light"><script id="quarto-html-before-body" type="application/javascript">
    const toggleBodyColorMode = (bsSheetEl) => {
      const mode = bsSheetEl.getAttribute("data-mode");
      const bodyEl = window.document.querySelector("body");
      if (mode === "dark") {
        bodyEl.classList.add("quarto-dark");
        bodyEl.classList.remove("quarto-light");
      } else {
        bodyEl.classList.add("quarto-light");
        bodyEl.classList.remove("quarto-dark");
      }
    }
    const toggleBodyColorPrimary = () => {
      const bsSheetEl = window.document.querySelector("link#quarto-bootstrap:not([rel=disabled-stylesheet])");
      if (bsSheetEl) {
        toggleBodyColorMode(bsSheetEl);
      }
    }
    const setColorSchemeToggle = (alternate) => {
      const toggles = window.document.querySelectorAll('.quarto-color-scheme-toggle');
      for (let i=0; i < toggles.length; i++) {
        const toggle = toggles[i];
        if (toggle) {
          if (alternate) {
            toggle.classList.add("alternate");
          } else {
            toggle.classList.remove("alternate");
          }
        }
      }
    };
    const toggleColorMode = (alternate) => {
      // Switch the stylesheets
      const primaryStylesheets = window.document.querySelectorAll('link.quarto-color-scheme:not(.quarto-color-alternate)');
      const alternateStylesheets = window.document.querySelectorAll('link.quarto-color-scheme.quarto-color-alternate');
      manageTransitions('#quarto-margin-sidebar .nav-link', false);
      if (alternate) {
        // note: dark is layered on light, we don't disable primary!
        enableStylesheet(alternateStylesheets);
        for (const sheetNode of alternateStylesheets) {
          if (sheetNode.id === "quarto-bootstrap") {
            toggleBodyColorMode(sheetNode);
          }
        }
      } else {
        disableStylesheet(alternateStylesheets);
        enableStylesheet(primaryStylesheets)
        toggleBodyColorPrimary();
      }
      manageTransitions('#quarto-margin-sidebar .nav-link', true);
      // Switch the toggles
      setColorSchemeToggle(alternate)
      // Hack to workaround the fact that safari doesn't
      // properly recolor the scrollbar when toggling (#1455)
      if (navigator.userAgent.indexOf('Safari') > 0 && navigator.userAgent.indexOf('Chrome') == -1) {
        manageTransitions("body", false);
        window.scrollTo(0, 1);
        setTimeout(() => {
          window.scrollTo(0, 0);
          manageTransitions("body", true);
        }, 40);
      }
    }
    const disableStylesheet = (stylesheets) => {
      for (let i=0; i < stylesheets.length; i++) {
        const stylesheet = stylesheets[i];
        stylesheet.rel = 'disabled-stylesheet';
      }
    }
    const enableStylesheet = (stylesheets) => {
      for (let i=0; i < stylesheets.length; i++) {
        const stylesheet = stylesheets[i];
        if(stylesheet.rel !== 'stylesheet') { // for Chrome, which will still FOUC without this check
          stylesheet.rel = 'stylesheet';
        }
      }
    }
    const manageTransitions = (selector, allowTransitions) => {
      const els = window.document.querySelectorAll(selector);
      for (let i=0; i < els.length; i++) {
        const el = els[i];
        if (allowTransitions) {
          el.classList.remove('notransition');
        } else {
          el.classList.add('notransition');
        }
      }
    }
    const isFileUrl = () => {
      return window.location.protocol === 'file:';
    }
    const hasAlternateSentinel = () => {
      let styleSentinel = getColorSchemeSentinel();
      if (styleSentinel !== null) {
        return styleSentinel === "alternate";
      } else {
        return false;
      }
    }
    const setStyleSentinel = (alternate) => {
      const value = alternate ? "alternate" : "default";
      if (!isFileUrl()) {
        window.localStorage.setItem("quarto-color-scheme", value);
      } else {
        localAlternateSentinel = value;
      }
    }
    const getColorSchemeSentinel = () => {
      if (!isFileUrl()) {
        const storageValue = window.localStorage.getItem("quarto-color-scheme");
        return storageValue != null ? storageValue : localAlternateSentinel;
      } else {
        return localAlternateSentinel;
      }
    }
    const toggleGiscusIfUsed = (isAlternate, darkModeDefault) => {
      const baseTheme = document.querySelector('#giscus-base-theme')?.value ?? 'light';
      const alternateTheme = document.querySelector('#giscus-alt-theme')?.value ?? 'dark';
      let newTheme = '';
      if(authorPrefersDark) {
        newTheme = isAlternate ? baseTheme : alternateTheme;
      } else {
        newTheme = isAlternate ? alternateTheme : baseTheme;
      }
      const changeGiscusTheme = () => {
        // From: https://github.com/giscus/giscus/issues/336
        const sendMessage = (message) => {
          const iframe = document.querySelector('iframe.giscus-frame');
          if (!iframe) return;
          iframe.contentWindow.postMessage({ giscus: message }, 'https://giscus.app');
        }
        sendMessage({
          setConfig: {
            theme: newTheme
          }
        });
      }
      const isGiscussLoaded = window.document.querySelector('iframe.giscus-frame') !== null;
      if (isGiscussLoaded) {
        changeGiscusTheme();
      }
    };
    const authorPrefersDark = false;
    const queryPrefersDark = window.matchMedia('(prefers-color-scheme: dark)');
    const darkModeDefault = queryPrefersDark.matches;
      document.querySelector('link#quarto-text-highlighting-styles.quarto-color-scheme-extra').rel = 'disabled-stylesheet';
      document.querySelector('link#quarto-bootstrap.quarto-color-scheme-extra').rel = 'disabled-stylesheet';
    let localAlternateSentinel = darkModeDefault ? 'alternate' : 'default';
    // Dark / light mode switch
    window.quartoToggleColorScheme = () => {
      // Read the current dark / light value
      let toAlternate = !hasAlternateSentinel();
      toggleColorMode(toAlternate);
      setStyleSentinel(toAlternate);
      toggleGiscusIfUsed(toAlternate, darkModeDefault);
      window.dispatchEvent(new Event('resize'));
    };
    queryPrefersDark.addEventListener("change", e => {
      if(window.localStorage.getItem("quarto-color-scheme") !== null)
        return;
      const alternate = e.matches
      toggleColorMode(alternate);
      localAlternateSentinel = e.matches ? 'alternate' : 'default'; // this is used alongside local storage!
      toggleGiscusIfUsed(alternate, darkModeDefault);
    });
    // Switch to dark mode if need be
    if (hasAlternateSentinel()) {
      toggleColorMode(true);
    } else {
      toggleColorMode(false);
    }
  </script>

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a class="navbar-brand" href="../../../../../../../index.html">
    <span class="navbar-title">Yosuke Abe</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="サーチ"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" role="menu" aria-expanded="false" aria-label="ナビゲーションを切り替える" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll ms-auto">
  <li class="nav-item">
    <a class="nav-link" href="../../../../../../../pages/about.html"> 
<span class="menu-text">About</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../../../../../../pages/tips/index.html"> 
<span class="menu-text">Tips</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../../../../../../pages/software/index.html"> 
<span class="menu-text">Software</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../../../../../../pages/gis_in_r/index.html"> 
<span class="menu-text">GIS in <i class="fa-brands fa-r-project" aria-label="r-project"></i></span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../../../../../../pages/blog/index.html"> 
<span class="menu-text">Blog</span></a>
  </li>  
</ul>
          </div> <!-- /navcollapse -->
            <div class="quarto-navbar-tools tools-wide">
    <div class="dropdown">
      <a href="" title="" id="quarto-navigation-tool-dropdown-0" class="quarto-navigation-tool dropdown-toggle px-1" data-bs-toggle="dropdown" aria-expanded="false" role="link" aria-label=""><i class="bi bi-github"></i></a>
      <ul class="dropdown-menu" aria-labelledby="quarto-navigation-tool-dropdown-0">
          <li>
            <a class="dropdown-item quarto-navbar-tools-item" href="https://github.com/yo5uke/yo5uke.github.io/">
            ソースコード
            </a>
          </li>
          <li>
            <a class="dropdown-item quarto-navbar-tools-item" href="https://github.com/yo5uke/yo5uke.github.io/issues/new/">
            問題を報告
            </a>
          </li>
      </ul>
    </div>
    <a href="../../../../../../../pages/tips/index.xml" title="RSS" class="quarto-navigation-tool px-1" aria-label="RSS"><i class="bi bi-rss"></i></a>
  <a href="" class="quarto-color-scheme-toggle quarto-navigation-tool  px-1" onclick="window.quartoToggleColorScheme(); return false;" title="ダークモードの切り替え"><i class="bi"></i></a>
</div>
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">目次</h2>
   
  <ul>
  <li><a href="#ggproto" id="toc-ggproto" class="nav-link active" data-scroll-target="#ggproto">ggproto</a></li>
  <li><a href="#creating-a-new-stat" id="toc-creating-a-new-stat" class="nav-link" data-scroll-target="#creating-a-new-stat">Creating a new stat</a>
  <ul class="collapse">
  <li><a href="#the-simplest-stat" id="toc-the-simplest-stat" class="nav-link" data-scroll-target="#the-simplest-stat">The simplest stat</a></li>
  <li><a href="#stat-parameters" id="toc-stat-parameters" class="nav-link" data-scroll-target="#stat-parameters">Stat parameters</a></li>
  <li><a href="#picking-defaults" id="toc-picking-defaults" class="nav-link" data-scroll-target="#picking-defaults">Picking defaults</a></li>
  <li><a href="#variable-names-and-default-aesthetics" id="toc-variable-names-and-default-aesthetics" class="nav-link" data-scroll-target="#variable-names-and-default-aesthetics">Variable names and default aesthetics</a></li>
  <li><a href="#exercises" id="toc-exercises" class="nav-link" data-scroll-target="#exercises">Exercises</a></li>
  </ul></li>
  <li><a href="#creating-a-new-geom" id="toc-creating-a-new-geom" class="nav-link" data-scroll-target="#creating-a-new-geom">Creating a new geom</a>
  <ul class="collapse">
  <li><a href="#a-simple-geom" id="toc-a-simple-geom" class="nav-link" data-scroll-target="#a-simple-geom">A simple geom</a></li>
  <li><a href="#collective-geoms" id="toc-collective-geoms" class="nav-link" data-scroll-target="#collective-geoms">Collective geoms</a></li>
  <li><a href="#inheriting-from-an-existing-geom" id="toc-inheriting-from-an-existing-geom" class="nav-link" data-scroll-target="#inheriting-from-an-existing-geom">Inheriting from an existing Geom</a></li>
  <li><a href="#exercises-1" id="toc-exercises-1" class="nav-link" data-scroll-target="#exercises-1">Exercises</a></li>
  </ul></li>
  <li><a href="#geoms-and-stats-with-multiple-orientation" id="toc-geoms-and-stats-with-multiple-orientation" class="nav-link" data-scroll-target="#geoms-and-stats-with-multiple-orientation">Geoms and Stats with multiple orientation</a>
  <ul class="collapse">
  <li><a href="#omnidirectional-stats" id="toc-omnidirectional-stats" class="nav-link" data-scroll-target="#omnidirectional-stats">Omnidirectional stats</a></li>
  <li><a href="#omnidirecitonal-geoms" id="toc-omnidirecitonal-geoms" class="nav-link" data-scroll-target="#omnidirecitonal-geoms">Omnidirecitonal geoms</a></li>
  <li><a href="#dealing-with-required-aesthetics" id="toc-dealing-with-required-aesthetics" class="nav-link" data-scroll-target="#dealing-with-required-aesthetics">Dealing with required aesthetics</a></li>
  <li><a href="#ambiguous-layers" id="toc-ambiguous-layers" class="nav-link" data-scroll-target="#ambiguous-layers">Ambiguous layers</a></li>
  </ul></li>
  <li><a href="#creating-your-own-theme" id="toc-creating-your-own-theme" class="nav-link" data-scroll-target="#creating-your-own-theme">Creating your own theme</a>
  <ul class="collapse">
  <li><a href="#overriding-elements" id="toc-overriding-elements" class="nav-link" data-scroll-target="#overriding-elements">Overriding elements</a></li>
  <li><a href="#global-elements" id="toc-global-elements" class="nav-link" data-scroll-target="#global-elements">Global elements</a></li>
  <li><a href="#complete-vs-incomplete" id="toc-complete-vs-incomplete" class="nav-link" data-scroll-target="#complete-vs-incomplete">Complete vs incomplete</a></li>
  </ul></li>
  <li><a href="#creating-a-new-faceting" id="toc-creating-a-new-faceting" class="nav-link" data-scroll-target="#creating-a-new-faceting">Creating a new faceting</a>
  <ul class="collapse">
  <li><a href="#creating-a-layout-specification" id="toc-creating-a-layout-specification" class="nav-link" data-scroll-target="#creating-a-layout-specification">Creating a layout specification</a></li>
  <li><a href="#mapping-data-into-panels" id="toc-mapping-data-into-panels" class="nav-link" data-scroll-target="#mapping-data-into-panels">Mapping data into panels</a></li>
  <li><a href="#laying-out-the-panels" id="toc-laying-out-the-panels" class="nav-link" data-scroll-target="#laying-out-the-panels">Laying out the panels</a></li>
  <li><a href="#assembling-the-facet-class" id="toc-assembling-the-facet-class" class="nav-link" data-scroll-target="#assembling-the-facet-class">Assembling the Facet class</a></li>
  <li><a href="#doing-more-with-facets" id="toc-doing-more-with-facets" class="nav-link" data-scroll-target="#doing-more-with-facets">Doing more with facets</a></li>
  </ul></li>
  <li><a href="#extending-existing-facet-function" id="toc-extending-existing-facet-function" class="nav-link" data-scroll-target="#extending-existing-facet-function">Extending existing facet function</a>
  <ul class="collapse">
  <li><a href="#exercises-2" id="toc-exercises-2" class="nav-link" data-scroll-target="#exercises-2">Exercises</a></li>
  </ul></li>
  <li><a href="#creating-new-guides" id="toc-creating-new-guides" class="nav-link" data-scroll-target="#creating-new-guides">Creating new guides</a>
  <ul class="collapse">
  <li><a href="#overriding-scale-extraction" id="toc-overriding-scale-extraction" class="nav-link" data-scroll-target="#overriding-scale-extraction">Overriding scale extraction</a></li>
  <li><a href="#guide-constructors" id="toc-guide-constructors" class="nav-link" data-scroll-target="#guide-constructors">Guide constructors</a></li>
  <li><a href="#custom-drawings" id="toc-custom-drawings" class="nav-link" data-scroll-target="#custom-drawings">Custom drawings</a></li>
  <li><a href="#exercises-3" id="toc-exercises-3" class="nav-link" data-scroll-target="#exercises-3">Exercises</a></li>
  </ul></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">


<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">Extending ggplot2</h1>
</div>

<div>
  <div class="description">
    <p>Official extension mechanism provided in ggplot2.</p>
  </div>
</div>


<div class="quarto-title-meta">

    
  
    
  </div>
  


</header>


<p>This vignette documents the official extension mechanism provided in ggplot2 2.0.0. This vignette is a high-level adjunct to the low-level details found in <code>?Stat</code>, <code>?Geom</code> and <code>?theme</code>. You’ll learn how to extend ggplot2 by creating a new stat, geom, or theme.</p>
<p>As you read this document, you’ll see many things that will make you scratch your head and wonder why on earth is it designed this way? Mostly it’s historical accident - I wasn’t a terribly good R programmer when I started writing ggplot2 and I made a lot of questionable decisions. We cleaned up as many of those issues as possible in the 2.0.0 release, but some fixes simply weren’t worth the effort.</p>
<section id="ggproto" class="level2">
<h2 class="anchored" data-anchor-id="ggproto">ggproto</h2>
<p>All ggplot2 objects are built using the ggproto system of object oriented programming. This OO system is used only in one place: ggplot2. This is mostly historical accident: ggplot2 started off using <a href="https://cran.r-project.org/package=proto">proto</a> because I needed mutable objects. This was well before the creation of (the briefly lived) <a href="http://vita.had.co.nz/papers/mutatr.html">mutatr</a>, reference classes and R6: proto was the only game in town.</p>
<p>But why ggproto? Well when we turned to add an official extension mechanism to ggplot2, we found a major problem that caused problems when proto objects were extended in a different package (methods were evaluated in ggplot2, not the package where the extension was added). We tried converting to R6, but it was a poor fit for the needs of ggplot2. We could’ve modified proto, but that would’ve first involved understanding exactly how proto worked, and secondly making sure that the changes didn’t affect other users of proto.</p>
<p>It’s strange to say, but this is a case where inventing a new OO system was actually the right answer to the problem! Fortunately Winston is now very good at creating OO systems, so it only took him a day to come up with ggproto: it maintains all the features of proto that ggplot2 needs, while allowing cross package inheritance to work.</p>
<p>Here’s a quick demo of ggproto in action:</p>
<div class="cell" data-layout-align="center">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a>A <span class="ot">&lt;-</span> <span class="fu">ggproto</span>(<span class="st">"A"</span>, <span class="cn">NULL</span>,</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">x =</span> <span class="dv">1</span>,</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">inc =</span> <span class="cf">function</span>(self) {</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a>    self<span class="sc">$</span>x <span class="ot">&lt;-</span> self<span class="sc">$</span>x <span class="sc">+</span> <span class="dv">1</span></span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a>A<span class="sc">$</span>x</span></code></pre></div><button title="コピー" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>#&gt; [1] 1</code></pre>
</div>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb3"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a>A<span class="sc">$</span><span class="fu">inc</span>()</span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>A<span class="sc">$</span>x</span></code></pre></div><button title="コピー" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>#&gt; [1] 2</code></pre>
</div>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb5"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a>A<span class="sc">$</span><span class="fu">inc</span>()</span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a>A<span class="sc">$</span><span class="fu">inc</span>()</span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a>A<span class="sc">$</span>x</span></code></pre></div><button title="コピー" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>#&gt; [1] 4</code></pre>
</div>
</div>
<p>The majority of ggplot2 classes are immutable and static: the methods neither use nor modify state in the class. They’re mostly used as a convenient way of bundling related methods together.</p>
<p>When you create new functionality, like a new geom or stat, the first decision to make is whether you want to build these from scratch or you want to re-use parts of pre-exiting classes. To create a new geom or stat from scratch, you will just create a new ggproto object that inherits from <code>Stat</code> or <code>Geom</code> and override the methods described below.</p>
</section>
<section id="creating-a-new-stat" class="level2">
<h2 class="anchored" data-anchor-id="creating-a-new-stat">Creating a new stat</h2>
<p>Stats are an important part of layers: they instruct what is displayed, not how it is displayed. They are declared in the <code>layer(stat)</code> argument which has a correspondence to <code>Stat*</code> ggproto classes which all inherit from the root <code>Stat</code> class.</p>
<section id="the-simplest-stat" class="level3">
<h3 class="anchored" data-anchor-id="the-simplest-stat">The simplest stat</h3>
<p>We’ll start by creating a very simple stat: one that gives the convex hull (the <em>c</em> hull) of a set of points. First we create a new ggproto object that inherits from <code>Stat</code>:</p>
<div class="cell" data-layout-align="center">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb7"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a>StatChull <span class="ot">&lt;-</span> <span class="fu">ggproto</span>(<span class="st">"StatChull"</span>, Stat,</span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">compute_group =</span> <span class="cf">function</span>(data, scales) {</span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a>    data[<span class="fu">chull</span>(data<span class="sc">$</span>x, data<span class="sc">$</span>y), , drop <span class="ot">=</span> <span class="cn">FALSE</span>]</span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a>  },</span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">required_aes =</span> <span class="fu">c</span>(<span class="st">"x"</span>, <span class="st">"y"</span>)</span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true" tabindex="-1"></a>)</span></code></pre></div><button title="コピー" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<p>The two most important components are the <code>compute_group()</code> method (which does the computation), and the <code>required_aes</code> field, which lists which aesthetics must be present in order for the stat to work.</p>
<p>Next we write a layer function. Unfortunately, due to an early design mistake I called these either <code>stat_()</code> or <code>geom_()</code>. A better decision would have been to call them <code>layer_()</code> functions: that’s a more accurate description because every layer involves a stat <em>and</em> a geom. Currently it is the convention to have <code>stat_()</code> wrappers with fixed <code>layer(stat)</code> arguments and <code>geom_()</code> wrappers with fixed <code>layer(geom)</code> arguments. The <code>stat_()</code> and <code>geom_()</code> functions both have the same ingredients and cook up new layers.</p>
<p>All layer functions follow the same form - you specify defaults in the function arguments and then call the <code>layer()</code> function, sending <code>...</code> into the <code>params</code> argument. The arguments in <code>...</code> will either be arguments for the geom (if you’re making a stat wrapper), arguments for the stat (if you’re making a geom wrapper), or aesthetics to be set. <code>layer()</code> takes care of teasing the different parameters apart and making sure they’re stored in the right place.</p>
<div class="cell" data-layout-align="center">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb8"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a>stat_chull <span class="ot">&lt;-</span> <span class="cf">function</span>(<span class="at">mapping =</span> <span class="cn">NULL</span>, <span class="at">data =</span> <span class="cn">NULL</span>, <span class="at">geom =</span> <span class="st">"polygon"</span>,</span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a>                       <span class="at">position =</span> <span class="st">"identity"</span>, <span class="at">na.rm =</span> <span class="cn">FALSE</span>, <span class="at">show.legend =</span> <span class="cn">NA</span>, </span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a>                       <span class="at">inherit.aes =</span> <span class="cn">TRUE</span>, ...) {</span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">layer</span>(</span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">stat =</span> StatChull, <span class="at">data =</span> data, <span class="at">mapping =</span> mapping, <span class="at">geom =</span> geom, </span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">position =</span> position, <span class="at">show.legend =</span> show.legend, <span class="at">inherit.aes =</span> inherit.aes,</span>
<span id="cb8-7"><a href="#cb8-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">params =</span> <span class="fu">list</span>(<span class="at">na.rm =</span> na.rm, ...)</span>
<span id="cb8-8"><a href="#cb8-8" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb8-9"><a href="#cb8-9" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div><button title="コピー" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<p>(Note that if you’re writing this in your own package, you’ll either need to call <code>ggplot2::layer()</code> explicitly, or import the <code>layer()</code> function into your package namespace.)</p>
<p>If you have standard expectations of a constructor with no side effects (e.g.&nbsp;checking arguments), you can also use the <code>make_constructor()</code> function to build one for you. There is no sensible default geom for a stat, so you have to set the default one yourself.</p>
<div class="cell" data-layout-align="center">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb9"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a>stat_chull <span class="ot">&lt;-</span> <span class="fu">make_constructor</span>(StatChull, <span class="at">geom =</span> <span class="st">"polygon"</span>)</span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(stat_chull)</span></code></pre></div><button title="コピー" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>#&gt; function (mapping = NULL, data = NULL, geom = "polygon", position = "identity", 
#&gt;     ..., na.rm = FALSE, show.legend = NA, inherit.aes = TRUE) 
#&gt; {
#&gt;     layer(mapping = mapping, data = data, geom = geom, stat = "chull", 
#&gt;         position = position, show.legend = show.legend, inherit.aes = inherit.aes, 
#&gt;         params = list2(na.rm = na.rm, ...))
#&gt; }
#&gt; &lt;environment: 0x55b3694977e0&gt;</code></pre>
</div>
</div>
<p>Once we have a layer function we can try our new stat:</p>
<div class="cell" data-layout-align="center">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb11"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(mpg, <span class="fu">aes</span>(displ, hwy)) <span class="sc">+</span> </span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>() <span class="sc">+</span> </span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">stat_chull</span>(<span class="at">fill =</span> <span class="cn">NA</span>, <span class="at">colour =</span> <span class="st">"black"</span>)</span></code></pre></div><button title="コピー" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="extending-ggplot2_files/figure-html/unnamed-chunk-4-1.png" class="img-fluid quarto-figure quarto-figure-center figure-img" alt="Scatterplot of engine displacement versus highway miles per gallon, for 234 cars. The convex hull of all the points is marked by a polygon with no fill." width="672"></p>
</figure>
</div>
</div>
</div>
<p>(We’ll see later how to change the defaults of the geom so that you don’t need to specify <code>fill = NA</code> every time.)</p>
<p>Once we’ve written this basic object, ggplot2 gives a lot for free. For example, ggplot2 automatically preserves aesthetics that are constant within each group:</p>
<div class="cell" data-layout-align="center">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb12"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(mpg, <span class="fu">aes</span>(displ, hwy, <span class="at">colour =</span> drv)) <span class="sc">+</span> </span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>() <span class="sc">+</span> </span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">stat_chull</span>(<span class="at">fill =</span> <span class="cn">NA</span>)</span></code></pre></div><button title="コピー" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="extending-ggplot2_files/figure-html/unnamed-chunk-5-1.png" class="img-fluid quarto-figure quarto-figure-center figure-img" alt="Scatterplot of engine displacement versus highway miles per gallon, for 234 cars. The convex hulls of points, grouped and coloured by three types of drive train, are marked by polygons with no fill but the outline matches the colours of the points." width="672"></p>
</figure>
</div>
</div>
</div>
<p>We can also override the default geom to display the convex hull in a different way:</p>
<div class="cell" data-layout-align="center">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb13"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(mpg, <span class="fu">aes</span>(displ, hwy)) <span class="sc">+</span> </span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">stat_chull</span>(<span class="at">geom =</span> <span class="st">"point"</span>, <span class="at">size =</span> <span class="dv">4</span>, <span class="at">colour =</span> <span class="st">"red"</span>) <span class="sc">+</span></span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>()</span></code></pre></div><button title="コピー" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="extending-ggplot2_files/figure-html/unnamed-chunk-6-1.png" class="img-fluid quarto-figure quarto-figure-center figure-img" alt="Scatterplot of engine displacement versus highway miles per gallon, for 234 cars. The points that are part of the convex hull of all points are marked with a red outline." width="672"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="stat-parameters" class="level3">
<h3 class="anchored" data-anchor-id="stat-parameters">Stat parameters</h3>
<p>A more complex stat will do some computation. Let’s implement a simple version of <code>geom_smooth()</code> that adds a line of best fit to a plot. We create a <code>StatLm</code> that inherits from <code>Stat</code> and a layer function, <code>stat_lm()</code>:</p>
<div class="cell" data-layout-align="center">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb14"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a>StatLm <span class="ot">&lt;-</span> <span class="fu">ggproto</span>(<span class="st">"StatLm"</span>, Stat, </span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">required_aes =</span> <span class="fu">c</span>(<span class="st">"x"</span>, <span class="st">"y"</span>),</span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">compute_group =</span> <span class="cf">function</span>(data, scales) {</span>
<span id="cb14-5"><a href="#cb14-5" aria-hidden="true" tabindex="-1"></a>    rng <span class="ot">&lt;-</span> <span class="fu">range</span>(data<span class="sc">$</span>x, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)</span>
<span id="cb14-6"><a href="#cb14-6" aria-hidden="true" tabindex="-1"></a>    grid <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">x =</span> rng)</span>
<span id="cb14-7"><a href="#cb14-7" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb14-8"><a href="#cb14-8" aria-hidden="true" tabindex="-1"></a>    mod <span class="ot">&lt;-</span> <span class="fu">lm</span>(y <span class="sc">~</span> x, <span class="at">data =</span> data)</span>
<span id="cb14-9"><a href="#cb14-9" aria-hidden="true" tabindex="-1"></a>    grid<span class="sc">$</span>y <span class="ot">&lt;-</span> <span class="fu">predict</span>(mod, <span class="at">newdata =</span> grid)</span>
<span id="cb14-10"><a href="#cb14-10" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb14-11"><a href="#cb14-11" aria-hidden="true" tabindex="-1"></a>    grid</span>
<span id="cb14-12"><a href="#cb14-12" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb14-13"><a href="#cb14-13" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb14-14"><a href="#cb14-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-15"><a href="#cb14-15" aria-hidden="true" tabindex="-1"></a>stat_lm <span class="ot">&lt;-</span> <span class="fu">make_constructor</span>(StatLm, <span class="at">geom =</span> <span class="st">"line"</span>)</span>
<span id="cb14-16"><a href="#cb14-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-17"><a href="#cb14-17" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(mpg, <span class="fu">aes</span>(displ, hwy)) <span class="sc">+</span> </span>
<span id="cb14-18"><a href="#cb14-18" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>() <span class="sc">+</span> </span>
<span id="cb14-19"><a href="#cb14-19" aria-hidden="true" tabindex="-1"></a>  <span class="fu">stat_lm</span>()</span></code></pre></div><button title="コピー" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="extending-ggplot2_files/figure-html/unnamed-chunk-7-1.png" class="img-fluid quarto-figure quarto-figure-center figure-img" alt="Scatterplot of engine displacement versus highway miles per gallon, for 234 cars. A straight line with a negative slope passes through the cloud of points." width="672"></p>
</figure>
</div>
</div>
</div>
<p><code>StatLm</code> is inflexible because it has no parameters. We might want to allow the user to control the model formula and the number of points used to generate the grid. To do so, we add arguments to the <code>compute_group()</code> method which will get picked up by <code>make_constructor()</code>.</p>
<div class="cell" data-layout-align="center">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb15"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a>StatLm <span class="ot">&lt;-</span> <span class="fu">ggproto</span>(<span class="st">"StatLm"</span>, Stat, </span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">required_aes =</span> <span class="fu">c</span>(<span class="st">"x"</span>, <span class="st">"y"</span>),</span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb15-4"><a href="#cb15-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">compute_group =</span> <span class="cf">function</span>(data, scales, <span class="at">params =</span> <span class="fu">list</span>(), <span class="at">n =</span> <span class="dv">100</span>, <span class="at">formula =</span> y <span class="sc">~</span> x) {</span>
<span id="cb15-5"><a href="#cb15-5" aria-hidden="true" tabindex="-1"></a>    rng <span class="ot">&lt;-</span> <span class="fu">range</span>(data<span class="sc">$</span>x, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)</span>
<span id="cb15-6"><a href="#cb15-6" aria-hidden="true" tabindex="-1"></a>    grid <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">x =</span> <span class="fu">seq</span>(rng[<span class="dv">1</span>], rng[<span class="dv">2</span>], <span class="at">length =</span> n))</span>
<span id="cb15-7"><a href="#cb15-7" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb15-8"><a href="#cb15-8" aria-hidden="true" tabindex="-1"></a>    mod <span class="ot">&lt;-</span> <span class="fu">lm</span>(formula, <span class="at">data =</span> data)</span>
<span id="cb15-9"><a href="#cb15-9" aria-hidden="true" tabindex="-1"></a>    grid<span class="sc">$</span>y <span class="ot">&lt;-</span> <span class="fu">predict</span>(mod, <span class="at">newdata =</span> grid)</span>
<span id="cb15-10"><a href="#cb15-10" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb15-11"><a href="#cb15-11" aria-hidden="true" tabindex="-1"></a>    grid</span>
<span id="cb15-12"><a href="#cb15-12" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb15-13"><a href="#cb15-13" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb15-14"><a href="#cb15-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-15"><a href="#cb15-15" aria-hidden="true" tabindex="-1"></a>stat_lm <span class="ot">&lt;-</span> <span class="fu">make_constructor</span>(StatLm, <span class="at">geom =</span> <span class="st">"line"</span>)</span>
<span id="cb15-16"><a href="#cb15-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-17"><a href="#cb15-17" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(mpg, <span class="fu">aes</span>(displ, hwy)) <span class="sc">+</span> </span>
<span id="cb15-18"><a href="#cb15-18" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>() <span class="sc">+</span> </span>
<span id="cb15-19"><a href="#cb15-19" aria-hidden="true" tabindex="-1"></a>  <span class="fu">stat_lm</span>(<span class="at">formula =</span> y <span class="sc">~</span> <span class="fu">poly</span>(x, <span class="dv">10</span>)) <span class="sc">+</span> </span>
<span id="cb15-20"><a href="#cb15-20" aria-hidden="true" tabindex="-1"></a>  <span class="fu">stat_lm</span>(<span class="at">formula =</span> y <span class="sc">~</span> <span class="fu">poly</span>(x, <span class="dv">10</span>), <span class="at">geom =</span> <span class="st">"point"</span>, <span class="at">colour =</span> <span class="st">"red"</span>, <span class="at">n =</span> <span class="dv">20</span>)</span></code></pre></div><button title="コピー" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="extending-ggplot2_files/figure-html/unnamed-chunk-8-1.png" class="img-fluid quarto-figure quarto-figure-center figure-img" alt="Scatterplot of engine displacement versus highway miles per gallon, for 234 cars. A wobbly line follows the point cloud over the horizontal direction. 20 points are placed on top of the line with constant horizontal intervals." width="672"></p>
</figure>
</div>
</div>
</div>
<p>If you’re defining a constructor function yourself, it is good practise to add the parameters as arguments. We don’t <em>have</em> to explicitly include the new parameters in the arguments for the layer, <code>...</code> will get passed to the right place anyway. But you’ll need to document them somewhere so the user knows about them. Here’s a brief example. Note <code>@inheritParams ggplot2::stat_identity</code>: that will automatically inherit documentation for all the parameters also defined for <code>stat_identity()</code>.</p>
<div class="cell" data-layout-align="center">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb16"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a><span class="co">#' @export</span></span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a><span class="co">#' @inheritParams ggplot2::stat_identity</span></span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a><span class="co">#' @param formula The modelling formula passed to \code{lm}. Should only </span></span>
<span id="cb16-4"><a href="#cb16-4" aria-hidden="true" tabindex="-1"></a><span class="co">#'   involve \code{y} and \code{x}</span></span>
<span id="cb16-5"><a href="#cb16-5" aria-hidden="true" tabindex="-1"></a><span class="co">#' @param n Number of points used for interpolation.</span></span>
<span id="cb16-6"><a href="#cb16-6" aria-hidden="true" tabindex="-1"></a>stat_lm <span class="ot">&lt;-</span> <span class="cf">function</span>(<span class="at">mapping =</span> <span class="cn">NULL</span>, <span class="at">data =</span> <span class="cn">NULL</span>, <span class="at">geom =</span> <span class="st">"line"</span>,</span>
<span id="cb16-7"><a href="#cb16-7" aria-hidden="true" tabindex="-1"></a>                    <span class="at">position =</span> <span class="st">"identity"</span>, <span class="at">na.rm =</span> <span class="cn">FALSE</span>, <span class="at">show.legend =</span> <span class="cn">NA</span>, </span>
<span id="cb16-8"><a href="#cb16-8" aria-hidden="true" tabindex="-1"></a>                    <span class="at">inherit.aes =</span> <span class="cn">TRUE</span>, <span class="at">n =</span> <span class="dv">50</span>, <span class="at">formula =</span> y <span class="sc">~</span> x, </span>
<span id="cb16-9"><a href="#cb16-9" aria-hidden="true" tabindex="-1"></a>                    ...) {</span>
<span id="cb16-10"><a href="#cb16-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">layer</span>(</span>
<span id="cb16-11"><a href="#cb16-11" aria-hidden="true" tabindex="-1"></a>    <span class="at">stat =</span> StatLm, <span class="at">data =</span> data, <span class="at">mapping =</span> mapping, <span class="at">geom =</span> geom, </span>
<span id="cb16-12"><a href="#cb16-12" aria-hidden="true" tabindex="-1"></a>    <span class="at">position =</span> position, <span class="at">show.legend =</span> show.legend, <span class="at">inherit.aes =</span> inherit.aes,</span>
<span id="cb16-13"><a href="#cb16-13" aria-hidden="true" tabindex="-1"></a>    <span class="at">params =</span> <span class="fu">list</span>(<span class="at">n =</span> n, <span class="at">formula =</span> formula, <span class="at">na.rm =</span> na.rm, ...)</span>
<span id="cb16-14"><a href="#cb16-14" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb16-15"><a href="#cb16-15" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div><button title="コピー" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<p><code>stat_lm()</code> must be exported if you want other people to use it. You could also consider exporting <code>StatLm</code> if you want people to extend the underlying object; this should be done with care.</p>
</section>
<section id="picking-defaults" class="level3">
<h3 class="anchored" data-anchor-id="picking-defaults">Picking defaults</h3>
<p>Sometimes you have calculations that should be performed once for the complete dataset, not once for each group. This is useful for picking sensible default values. For example, if we want to do a density estimate, it’s reasonable to pick one bandwidth for the whole plot. The following Stat creates a variation of the <code>stat_density()</code> that picks one bandwidth for all groups by choosing the mean of the “best” bandwidth for each group (I have no theoretical justification for this, but it doesn’t seem unreasonable).</p>
<p>To do this we override the <code>setup_params()</code> method. It’s passed the data and a list of params, and returns an updated list.</p>
<div class="cell" data-layout-align="center">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb17"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a>StatDensityCommon <span class="ot">&lt;-</span> <span class="fu">ggproto</span>(<span class="st">"StatDensityCommon"</span>, Stat, </span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">required_aes =</span> <span class="st">"x"</span>,</span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb17-4"><a href="#cb17-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">setup_params =</span> <span class="cf">function</span>(data, params) {</span>
<span id="cb17-5"><a href="#cb17-5" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="sc">!</span><span class="fu">is.null</span>(params<span class="sc">$</span>bandwidth))</span>
<span id="cb17-6"><a href="#cb17-6" aria-hidden="true" tabindex="-1"></a>      <span class="fu">return</span>(params)</span>
<span id="cb17-7"><a href="#cb17-7" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb17-8"><a href="#cb17-8" aria-hidden="true" tabindex="-1"></a>    xs <span class="ot">&lt;-</span> <span class="fu">split</span>(data<span class="sc">$</span>x, data<span class="sc">$</span>group)</span>
<span id="cb17-9"><a href="#cb17-9" aria-hidden="true" tabindex="-1"></a>    bws <span class="ot">&lt;-</span> <span class="fu">vapply</span>(xs, bw.nrd0, <span class="fu">numeric</span>(<span class="dv">1</span>))</span>
<span id="cb17-10"><a href="#cb17-10" aria-hidden="true" tabindex="-1"></a>    bw <span class="ot">&lt;-</span> <span class="fu">mean</span>(bws)</span>
<span id="cb17-11"><a href="#cb17-11" aria-hidden="true" tabindex="-1"></a>    <span class="fu">message</span>(<span class="st">"Picking bandwidth of "</span>, <span class="fu">signif</span>(bw, <span class="dv">3</span>))</span>
<span id="cb17-12"><a href="#cb17-12" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb17-13"><a href="#cb17-13" aria-hidden="true" tabindex="-1"></a>    params<span class="sc">$</span>bandwidth <span class="ot">&lt;-</span> bw</span>
<span id="cb17-14"><a href="#cb17-14" aria-hidden="true" tabindex="-1"></a>    params</span>
<span id="cb17-15"><a href="#cb17-15" aria-hidden="true" tabindex="-1"></a>  },</span>
<span id="cb17-16"><a href="#cb17-16" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb17-17"><a href="#cb17-17" aria-hidden="true" tabindex="-1"></a>  <span class="at">compute_group =</span> <span class="cf">function</span>(data, scales, <span class="at">bandwidth =</span> <span class="dv">1</span>) {</span>
<span id="cb17-18"><a href="#cb17-18" aria-hidden="true" tabindex="-1"></a>    d <span class="ot">&lt;-</span> <span class="fu">density</span>(data<span class="sc">$</span>x, <span class="at">bw =</span> bandwidth)</span>
<span id="cb17-19"><a href="#cb17-19" aria-hidden="true" tabindex="-1"></a>    <span class="fu">data.frame</span>(<span class="at">x =</span> d<span class="sc">$</span>x, <span class="at">y =</span> d<span class="sc">$</span>y)</span>
<span id="cb17-20"><a href="#cb17-20" aria-hidden="true" tabindex="-1"></a>  }  </span>
<span id="cb17-21"><a href="#cb17-21" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb17-22"><a href="#cb17-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-23"><a href="#cb17-23" aria-hidden="true" tabindex="-1"></a>stat_density_common <span class="ot">&lt;-</span> <span class="fu">make_constructor</span>(StatDensityCommon, <span class="at">geom =</span> <span class="st">"line"</span>)</span>
<span id="cb17-24"><a href="#cb17-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-25"><a href="#cb17-25" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(mpg, <span class="fu">aes</span>(displ, <span class="at">colour =</span> drv)) <span class="sc">+</span> </span>
<span id="cb17-26"><a href="#cb17-26" aria-hidden="true" tabindex="-1"></a>  <span class="fu">stat_density_common</span>()</span></code></pre></div><button title="コピー" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="extending-ggplot2_files/figure-html/unnamed-chunk-10-1.png" class="img-fluid quarto-figure quarto-figure-center figure-img" alt="A line plot showing three kernel density estimates of engine displacement, coloured for three types of drive trains. The lines are a little bit wobbly." width="672"></p>
</figure>
</div>
</div>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb18"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(mpg, <span class="fu">aes</span>(displ, <span class="at">colour =</span> drv)) <span class="sc">+</span> </span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">stat_density_common</span>(<span class="at">bandwidth =</span> <span class="fl">0.5</span>)</span></code></pre></div><button title="コピー" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="extending-ggplot2_files/figure-html/unnamed-chunk-10-2.png" class="img-fluid quarto-figure quarto-figure-center figure-img" alt="A line plot showing three kernel density estimates of engine displacement, coloured for three types of drive trains. The lines are fairly smooth." width="672"></p>
</figure>
</div>
</div>
</div>
<p>I recommend using <code>NULL</code> as a default value. If you pick important parameters automatically, it’s a good idea to <code>message()</code> to the user (and when printing a floating point parameter, using <code>signif()</code> to show only a few significant digits).</p>
</section>
<section id="variable-names-and-default-aesthetics" class="level3">
<h3 class="anchored" data-anchor-id="variable-names-and-default-aesthetics">Variable names and default aesthetics</h3>
<p>This stat illustrates another important point. If we want to make this stat usable with other geoms, we should return a variable called <code>density</code> instead of <code>y</code>. Then we can set up the <code>default_aes</code> to automatically map <code>density</code> to <code>y</code>, which allows the user to override it to use with different geoms:</p>
<div class="cell" data-layout-align="center">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb19"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a>StatDensityCommon <span class="ot">&lt;-</span> <span class="fu">ggproto</span>(<span class="st">"StatDensity2"</span>, Stat, </span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">required_aes =</span> <span class="st">"x"</span>,</span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">default_aes =</span> <span class="fu">aes</span>(<span class="at">y =</span> <span class="fu">after_stat</span>(density)),</span>
<span id="cb19-4"><a href="#cb19-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-5"><a href="#cb19-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">compute_group =</span> <span class="cf">function</span>(data, scales, <span class="at">bandwidth =</span> <span class="dv">1</span>) {</span>
<span id="cb19-6"><a href="#cb19-6" aria-hidden="true" tabindex="-1"></a>    d <span class="ot">&lt;-</span> <span class="fu">density</span>(data<span class="sc">$</span>x, <span class="at">bw =</span> bandwidth)</span>
<span id="cb19-7"><a href="#cb19-7" aria-hidden="true" tabindex="-1"></a>    <span class="fu">data.frame</span>(<span class="at">x =</span> d<span class="sc">$</span>x, <span class="at">density =</span> d<span class="sc">$</span>y)</span>
<span id="cb19-8"><a href="#cb19-8" aria-hidden="true" tabindex="-1"></a>  }  </span>
<span id="cb19-9"><a href="#cb19-9" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb19-10"><a href="#cb19-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-11"><a href="#cb19-11" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(mpg, <span class="fu">aes</span>(displ, drv, <span class="at">colour =</span> <span class="fu">after_stat</span>(density))) <span class="sc">+</span> </span>
<span id="cb19-12"><a href="#cb19-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">stat_density_common</span>(<span class="at">bandwidth =</span> <span class="dv">1</span>, <span class="at">geom =</span> <span class="st">"point"</span>)</span></code></pre></div><button title="コピー" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="extending-ggplot2_files/figure-html/unnamed-chunk-11-1.png" class="img-fluid quarto-figure quarto-figure-center figure-img" alt="A plot showing the engine displacement versus three types of drive trains. Every drive train is represented by a series of densely packed points that imitate a horizontal line, and their colour intensity indicates the kernel density estimate of the displacement." width="672"></p>
</figure>
</div>
</div>
</div>
<p>However, using this stat with the area geom doesn’t work quite right. The areas don’t stack on top of each other:</p>
<div class="cell" data-layout-align="center">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb20"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(mpg, <span class="fu">aes</span>(displ, <span class="at">fill =</span> drv)) <span class="sc">+</span> </span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">stat_density_common</span>(<span class="at">bandwidth =</span> <span class="dv">1</span>, <span class="at">geom =</span> <span class="st">"area"</span>, <span class="at">position =</span> <span class="st">"stack"</span>)</span></code></pre></div><button title="コピー" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="extending-ggplot2_files/figure-html/unnamed-chunk-12-1.png" class="img-fluid quarto-figure quarto-figure-center figure-img" alt="An area plot showing the kernel density estimates of engine displacement. Three areas are shown that indicate the estimates for three types of drive trains separately. All areas are floored to the x-axis and overlap one another." width="672"></p>
</figure>
</div>
</div>
</div>
<p>This is because each density is computed independently, and the estimated <code>x</code>s don’t line up. We can resolve that issue by computing the range of the data once in <code>setup_params()</code>.</p>
<div class="cell" data-layout-align="center">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb21"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a>StatDensityCommon <span class="ot">&lt;-</span> <span class="fu">ggproto</span>(<span class="st">"StatDensityCommon"</span>, Stat, </span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">required_aes =</span> <span class="st">"x"</span>,</span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">default_aes =</span> <span class="fu">aes</span>(<span class="at">y =</span> <span class="fu">after_stat</span>(density)),</span>
<span id="cb21-4"><a href="#cb21-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-5"><a href="#cb21-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">setup_params =</span> <span class="cf">function</span>(data, params) {</span>
<span id="cb21-6"><a href="#cb21-6" aria-hidden="true" tabindex="-1"></a>    min <span class="ot">&lt;-</span> <span class="fu">min</span>(data<span class="sc">$</span>x) <span class="sc">-</span> <span class="dv">3</span> <span class="sc">*</span> params<span class="sc">$</span>bandwidth</span>
<span id="cb21-7"><a href="#cb21-7" aria-hidden="true" tabindex="-1"></a>    max <span class="ot">&lt;-</span> <span class="fu">max</span>(data<span class="sc">$</span>x) <span class="sc">+</span> <span class="dv">3</span> <span class="sc">*</span> params<span class="sc">$</span>bandwidth</span>
<span id="cb21-8"><a href="#cb21-8" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb21-9"><a href="#cb21-9" aria-hidden="true" tabindex="-1"></a>    <span class="fu">list</span>(</span>
<span id="cb21-10"><a href="#cb21-10" aria-hidden="true" tabindex="-1"></a>      <span class="at">bandwidth =</span> params<span class="sc">$</span>bandwidth,</span>
<span id="cb21-11"><a href="#cb21-11" aria-hidden="true" tabindex="-1"></a>      <span class="at">min =</span> min,</span>
<span id="cb21-12"><a href="#cb21-12" aria-hidden="true" tabindex="-1"></a>      <span class="at">max =</span> max,</span>
<span id="cb21-13"><a href="#cb21-13" aria-hidden="true" tabindex="-1"></a>      <span class="at">na.rm =</span> params<span class="sc">$</span>na.rm</span>
<span id="cb21-14"><a href="#cb21-14" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb21-15"><a href="#cb21-15" aria-hidden="true" tabindex="-1"></a>  },</span>
<span id="cb21-16"><a href="#cb21-16" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb21-17"><a href="#cb21-17" aria-hidden="true" tabindex="-1"></a>  <span class="at">compute_group =</span> <span class="cf">function</span>(data, scales, min, max, <span class="at">bandwidth =</span> <span class="dv">1</span>) {</span>
<span id="cb21-18"><a href="#cb21-18" aria-hidden="true" tabindex="-1"></a>    d <span class="ot">&lt;-</span> <span class="fu">density</span>(data<span class="sc">$</span>x, <span class="at">bw =</span> bandwidth, <span class="at">from =</span> min, <span class="at">to =</span> max)</span>
<span id="cb21-19"><a href="#cb21-19" aria-hidden="true" tabindex="-1"></a>    <span class="fu">data.frame</span>(<span class="at">x =</span> d<span class="sc">$</span>x, <span class="at">density =</span> d<span class="sc">$</span>y)</span>
<span id="cb21-20"><a href="#cb21-20" aria-hidden="true" tabindex="-1"></a>  }  </span>
<span id="cb21-21"><a href="#cb21-21" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb21-22"><a href="#cb21-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-23"><a href="#cb21-23" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(mpg, <span class="fu">aes</span>(displ, <span class="at">fill =</span> drv)) <span class="sc">+</span> </span>
<span id="cb21-24"><a href="#cb21-24" aria-hidden="true" tabindex="-1"></a>  <span class="fu">stat_density_common</span>(<span class="at">bandwidth =</span> <span class="dv">1</span>, <span class="at">geom =</span> <span class="st">"area"</span>, <span class="at">position =</span> <span class="st">"stack"</span>)</span></code></pre></div><button title="コピー" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="extending-ggplot2_files/figure-html/unnamed-chunk-13-1.png" class="img-fluid quarto-figure quarto-figure-center figure-img" alt="A stacked area plot showing kernel density estimates of engine displacement. Three areas are shown that indicate the estimates for three types of drive trains separately. The areas are stacked on top of one another and show no overlap." width="672"></p>
</figure>
</div>
</div>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb22"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(mpg, <span class="fu">aes</span>(displ, drv, <span class="at">fill =</span> <span class="fu">after_stat</span>(density))) <span class="sc">+</span> </span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">stat_density_common</span>(<span class="at">bandwidth =</span> <span class="dv">1</span>, <span class="at">geom =</span> <span class="st">"raster"</span>)</span></code></pre></div><button title="コピー" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="extending-ggplot2_files/figure-html/unnamed-chunk-13-2.png" class="img-fluid quarto-figure quarto-figure-center figure-img" alt="A heatmap showing the density of engine displacement for three types of drive trains. The heatmap has three rows for the drive trains, but are continuous in the horizontal direction. The fill intensity of the heatmap shows the kernel density estimates." width="672"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="exercises" class="level3">
<h3 class="anchored" data-anchor-id="exercises">Exercises</h3>
<ol type="1">
<li><p>Extend <code>stat_chull</code> to compute the alpha hull, as from the <a href="https://cran.r-project.org/package=alphahull">alphahull</a> package. Your new stat should take an <code>alpha</code> argument.</p></li>
<li><p>Modify the final version of <code>StatDensityCommon</code> to allow the user to specify the <code>min</code> and <code>max</code> parameters. You’ll need to modify both the layer function and the <code>compute_group()</code> method.</p>
<p>Note: be careful when adding parameters to a layer function. The following names <em>col</em>, <em>color</em>, <em>pch</em>, <em>cex</em>, <em>lty</em>, <em>lwd</em>, <em>srt</em>, <em>adj</em>, <em>bg</em>, <em>fg</em>, <em>min</em>, and <em>max</em> are intentionally renamed to accommodate base graphical parameter names. For example, a value passed as <em>min</em> to a layer appears as <em>ymin</em> in the <code>setup_params</code> list of params. It is recommended you avoid using these names for layer parameters.</p></li>
<li><p>Compare and contrast <code>StatLm</code> to <code>ggplot2::StatSmooth</code>. What key differences make <code>StatSmooth</code> more complex than <code>StatLm</code>?</p></li>
</ol>
</section>
</section>
<section id="creating-a-new-geom" class="level2">
<h2 class="anchored" data-anchor-id="creating-a-new-geom">Creating a new geom</h2>
<p>Geoms are also important parts of layers: they instruct how data is displayed. They are declared in the <code>layer(geom)</code> argument which has a correspondence to <code>Geom*</code> ggproto classes which all inherit from the root <code>Geom</code> class.</p>
<p>It’s harder to create a new geom than a new stat because you also need to know some grid. ggplot2 is built on top of grid, so you’ll need to know the basics of drawing with grid. If you’re serious about adding a new geom, I’d recommend buying <a href="https://www.routledge.com/R-Graphics-Third-Edition/Murrell/p/book/9781498789059">R graphics</a> by Paul Murrell. It tells you everything you need to know about drawing with grid.</p>
<section id="a-simple-geom" class="level3">
<h3 class="anchored" data-anchor-id="a-simple-geom">A simple geom</h3>
<p>It’s easiest to start with a simple example. The code below is a simplified version of <code>geom_point()</code>:</p>
<div class="cell" data-layout-align="center">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb23"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a>GeomSimplePoint <span class="ot">&lt;-</span> <span class="fu">ggproto</span>(<span class="st">"GeomSimplePoint"</span>, Geom,</span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">required_aes =</span> <span class="fu">c</span>(<span class="st">"x"</span>, <span class="st">"y"</span>),</span>
<span id="cb23-3"><a href="#cb23-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">default_aes =</span> <span class="fu">aes</span>(<span class="at">shape =</span> <span class="dv">19</span>, <span class="at">colour =</span> <span class="st">"black"</span>),</span>
<span id="cb23-4"><a href="#cb23-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">draw_key =</span> draw_key_point,</span>
<span id="cb23-5"><a href="#cb23-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-6"><a href="#cb23-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">draw_panel =</span> <span class="cf">function</span>(data, panel_params, coord) {</span>
<span id="cb23-7"><a href="#cb23-7" aria-hidden="true" tabindex="-1"></a>    coords <span class="ot">&lt;-</span> coord<span class="sc">$</span><span class="fu">transform</span>(data, panel_params)</span>
<span id="cb23-8"><a href="#cb23-8" aria-hidden="true" tabindex="-1"></a>    grid<span class="sc">::</span><span class="fu">pointsGrob</span>(</span>
<span id="cb23-9"><a href="#cb23-9" aria-hidden="true" tabindex="-1"></a>      coords<span class="sc">$</span>x, coords<span class="sc">$</span>y,</span>
<span id="cb23-10"><a href="#cb23-10" aria-hidden="true" tabindex="-1"></a>      <span class="at">pch =</span> coords<span class="sc">$</span>shape,</span>
<span id="cb23-11"><a href="#cb23-11" aria-hidden="true" tabindex="-1"></a>      <span class="at">gp =</span> grid<span class="sc">::</span><span class="fu">gpar</span>(<span class="at">col =</span> coords<span class="sc">$</span>colour)</span>
<span id="cb23-12"><a href="#cb23-12" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb23-13"><a href="#cb23-13" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb23-14"><a href="#cb23-14" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb23-15"><a href="#cb23-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-16"><a href="#cb23-16" aria-hidden="true" tabindex="-1"></a><span class="co"># Default stat is `stat_identity()`, no need to specify</span></span>
<span id="cb23-17"><a href="#cb23-17" aria-hidden="true" tabindex="-1"></a>geom_simple_point <span class="ot">&lt;-</span> <span class="fu">make_constructor</span>(GeomSimplePoint)</span>
<span id="cb23-18"><a href="#cb23-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-19"><a href="#cb23-19" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(mpg, <span class="fu">aes</span>(displ, hwy)) <span class="sc">+</span> </span>
<span id="cb23-20"><a href="#cb23-20" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_simple_point</span>()</span></code></pre></div><button title="コピー" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="extending-ggplot2_files/figure-html/GeomSimplePoint-1.png" class="img-fluid quarto-figure quarto-figure-center figure-img" alt="Scatterplot of engine displacement versus highway miles per gallon, for 234 cars. The points are larger than the default." width="672"></p>
</figure>
</div>
</div>
</div>
<p>This is very similar to defining a new stat. You always need to provide fields/methods for the four pieces shown above:</p>
<ul>
<li><p><code>required_aes</code> is a character vector which lists all the aesthetics that the user must provide.</p></li>
<li><p><code>default_aes</code> lists the aesthetics that have default values.</p></li>
<li><p><code>draw_key</code> provides the function used to draw the key in the legend. You can see a list of all the build in key functions in <code>?draw_key</code></p></li>
<li><p><code>draw_panel()</code> is where the magic happens. This function takes three arguments and returns a grid grob. It is called once for each panel. It’s the most complicated part and is described in more detail below.</p></li>
</ul>
<p><code>draw_panel()</code> has three arguments:</p>
<ul>
<li><p><code>data</code>: a data frame with one column for each aesthetic.</p></li>
<li><p><code>panel_params</code>: a list of per-panel parameters generated by the coord. You should consider this an opaque data structure: don’t look inside it, just pass along to <code>coord</code> methods.</p></li>
<li><p><code>coord</code>: an object describing the coordinate system.</p></li>
</ul>
<p>You need to use <code>panel_params</code> and <code>coord</code> together to transform the data <code>coords &lt;- coord$transform(data, panel_params)</code>. This creates a data frame where position variables are scaled to the range 0–1. You then take this data and call a grid grob function. (Transforming for non-Cartesian coordinate systems is quite complex - you’re best off transforming your data to the form accepted by an existing ggplot2 geom and passing it.)</p>
</section>
<section id="collective-geoms" class="level3">
<h3 class="anchored" data-anchor-id="collective-geoms">Collective geoms</h3>
<p>Overriding <code>draw_panel()</code> is most appropriate if there is one graphic element per row. In other cases, you want graphic element per group. For example, take polygons: each row gives one vertex of a polygon. In this case, you should instead override <code>draw_group()</code>.</p>
<p>The following code makes a simplified version of <code>GeomPolygon</code>:</p>
<div class="cell" data-layout-align="center">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb24"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a>GeomSimplePolygon <span class="ot">&lt;-</span> <span class="fu">ggproto</span>(<span class="st">"GeomPolygon"</span>, Geom,</span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">required_aes =</span> <span class="fu">c</span>(<span class="st">"x"</span>, <span class="st">"y"</span>),</span>
<span id="cb24-3"><a href="#cb24-3" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb24-4"><a href="#cb24-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">default_aes =</span> <span class="fu">aes</span>(</span>
<span id="cb24-5"><a href="#cb24-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">colour =</span> <span class="cn">NA</span>, <span class="at">fill =</span> <span class="st">"grey20"</span>, <span class="at">linewidth =</span> <span class="fl">0.5</span>,</span>
<span id="cb24-6"><a href="#cb24-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">linetype =</span> <span class="dv">1</span>, <span class="at">alpha =</span> <span class="dv">1</span></span>
<span id="cb24-7"><a href="#cb24-7" aria-hidden="true" tabindex="-1"></a>  ),</span>
<span id="cb24-8"><a href="#cb24-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-9"><a href="#cb24-9" aria-hidden="true" tabindex="-1"></a>  <span class="at">draw_key =</span> draw_key_polygon,</span>
<span id="cb24-10"><a href="#cb24-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-11"><a href="#cb24-11" aria-hidden="true" tabindex="-1"></a>  <span class="at">draw_group =</span> <span class="cf">function</span>(data, panel_params, coord) {</span>
<span id="cb24-12"><a href="#cb24-12" aria-hidden="true" tabindex="-1"></a>    n <span class="ot">&lt;-</span> <span class="fu">nrow</span>(data)</span>
<span id="cb24-13"><a href="#cb24-13" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (n <span class="sc">&lt;=</span> <span class="dv">2</span>) <span class="fu">return</span>(grid<span class="sc">::</span><span class="fu">nullGrob</span>())</span>
<span id="cb24-14"><a href="#cb24-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-15"><a href="#cb24-15" aria-hidden="true" tabindex="-1"></a>    coords <span class="ot">&lt;-</span> coord<span class="sc">$</span><span class="fu">transform</span>(data, panel_params)</span>
<span id="cb24-16"><a href="#cb24-16" aria-hidden="true" tabindex="-1"></a>    <span class="co"># A polygon can only have a single colour, fill, etc, so take from first row</span></span>
<span id="cb24-17"><a href="#cb24-17" aria-hidden="true" tabindex="-1"></a>    first_row <span class="ot">&lt;-</span> coords[<span class="dv">1</span>, , drop <span class="ot">=</span> <span class="cn">FALSE</span>]</span>
<span id="cb24-18"><a href="#cb24-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-19"><a href="#cb24-19" aria-hidden="true" tabindex="-1"></a>    grid<span class="sc">::</span><span class="fu">polygonGrob</span>(</span>
<span id="cb24-20"><a href="#cb24-20" aria-hidden="true" tabindex="-1"></a>      coords<span class="sc">$</span>x, coords<span class="sc">$</span>y, </span>
<span id="cb24-21"><a href="#cb24-21" aria-hidden="true" tabindex="-1"></a>      <span class="at">default.units =</span> <span class="st">"native"</span>,</span>
<span id="cb24-22"><a href="#cb24-22" aria-hidden="true" tabindex="-1"></a>      <span class="at">gp =</span> grid<span class="sc">::</span><span class="fu">gpar</span>(</span>
<span id="cb24-23"><a href="#cb24-23" aria-hidden="true" tabindex="-1"></a>        <span class="at">col =</span> first_row<span class="sc">$</span>colour,</span>
<span id="cb24-24"><a href="#cb24-24" aria-hidden="true" tabindex="-1"></a>        <span class="at">fill =</span> scales<span class="sc">::</span><span class="fu">alpha</span>(first_row<span class="sc">$</span>fill, first_row<span class="sc">$</span>alpha),</span>
<span id="cb24-25"><a href="#cb24-25" aria-hidden="true" tabindex="-1"></a>        <span class="at">lwd =</span> first_row<span class="sc">$</span>linewidth <span class="sc">*</span> .pt,</span>
<span id="cb24-26"><a href="#cb24-26" aria-hidden="true" tabindex="-1"></a>        <span class="at">lty =</span> first_row<span class="sc">$</span>linetype</span>
<span id="cb24-27"><a href="#cb24-27" aria-hidden="true" tabindex="-1"></a>      )</span>
<span id="cb24-28"><a href="#cb24-28" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb24-29"><a href="#cb24-29" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb24-30"><a href="#cb24-30" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb24-31"><a href="#cb24-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-32"><a href="#cb24-32" aria-hidden="true" tabindex="-1"></a>geom_simple_polygon <span class="ot">&lt;-</span> <span class="fu">make_constructor</span>(GeomSimplePolygon, <span class="at">stat =</span> <span class="st">"chull"</span>)</span>
<span id="cb24-33"><a href="#cb24-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-34"><a href="#cb24-34" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(mpg, <span class="fu">aes</span>(displ, hwy)) <span class="sc">+</span> </span>
<span id="cb24-35"><a href="#cb24-35" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>() <span class="sc">+</span> </span>
<span id="cb24-36"><a href="#cb24-36" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_simple_polygon</span>(<span class="fu">aes</span>(<span class="at">colour =</span> class), <span class="at">fill =</span> <span class="cn">NA</span>)</span></code></pre></div><button title="コピー" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="extending-ggplot2_files/figure-html/unnamed-chunk-14-1.png" class="img-fluid quarto-figure quarto-figure-center figure-img" alt="Scatterplot of engine displacement versus highway miles per gallon, for 234 cars. The convex hulls of points, grouped by 7 types of cars, are displayed as multiple polygons with no fill, but the outer line is coloured by the type." width="672"></p>
</figure>
</div>
</div>
</div>
<p>There are a few things to note here:</p>
<ul>
<li><p>We override <code>draw_group()</code> instead of <code>draw_panel()</code> because we want one polygon per group, not one polygon per row.</p></li>
<li><p>If the data contains two or fewer points, there’s no point trying to draw a polygon, so we return a <code>nullGrob()</code>. This is the graphical equivalent of <code>NULL</code>: it’s a grob that doesn’t draw anything and doesn’t take up any space.</p></li>
<li><p>Note the units: <code>x</code> and <code>y</code> should always be drawn in “native” units. (The default units for <code>pointGrob()</code> is a native, so we didn’t need to change it there). <code>lwd</code> is measured in points, but ggplot2 uses mm, so we need to multiply it by the adjustment factor <code>.pt</code>.</p></li>
</ul>
<p>You might want to compare this to the real <code>GeomPolygon</code>. You’ll see it overrides <code>draw_panel()</code> because it uses some tricks to make <code>polygonGrob()</code> produce multiple polygons in one call. This is considerably more complicated, but gives better performance.</p>
</section>
<section id="inheriting-from-an-existing-geom" class="level3">
<h3 class="anchored" data-anchor-id="inheriting-from-an-existing-geom">Inheriting from an existing Geom</h3>
<p>Sometimes you just want to make a small modification to an existing geom. In this case, rather than inheriting from <code>Geom</code> you can inherit from an existing subclass. For example, we might want to change the defaults for <code>GeomPolygon</code> to work better with <code>StatChull</code>:</p>
<div class="cell" data-layout-align="center">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb25"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a>GeomPolygonHollow <span class="ot">&lt;-</span> <span class="fu">ggproto</span>(<span class="st">"GeomPolygonHollow"</span>, GeomPolygon,</span>
<span id="cb25-2"><a href="#cb25-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">default_aes =</span> <span class="fu">aes</span>(<span class="at">colour =</span> <span class="st">"black"</span>, <span class="at">fill =</span> <span class="cn">NA</span>, <span class="at">linewidth =</span> <span class="fl">0.5</span>, <span class="at">linetype =</span> <span class="dv">1</span>,</span>
<span id="cb25-3"><a href="#cb25-3" aria-hidden="true" tabindex="-1"></a>    <span class="at">alpha =</span> <span class="cn">NA</span>)</span>
<span id="cb25-4"><a href="#cb25-4" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb25-5"><a href="#cb25-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-6"><a href="#cb25-6" aria-hidden="true" tabindex="-1"></a>geom_chull <span class="ot">&lt;-</span> <span class="fu">make_constructor</span>(GeomPolygonHollow, <span class="at">stat =</span> <span class="st">"chull"</span>)</span>
<span id="cb25-7"><a href="#cb25-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-8"><a href="#cb25-8" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(mpg, <span class="fu">aes</span>(displ, hwy)) <span class="sc">+</span> </span>
<span id="cb25-9"><a href="#cb25-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>() <span class="sc">+</span> </span>
<span id="cb25-10"><a href="#cb25-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_chull</span>()</span></code></pre></div><button title="コピー" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="extending-ggplot2_files/figure-html/unnamed-chunk-15-1.png" class="img-fluid quarto-figure quarto-figure-center figure-img" alt="Scatterplot of engine displacement versus highway miles per gallon, for 234 cars. The convex hull of all the points is marked by a polygon with no fill." width="672"></p>
</figure>
</div>
</div>
</div>
<p>This doesn’t allow you to use different geoms with the stat, but that seems appropriate here since the convex hull is primarily a polygonal feature.</p>
</section>
<section id="exercises-1" class="level3">
<h3 class="anchored" data-anchor-id="exercises-1">Exercises</h3>
<ol type="1">
<li><p>Compare and contrast <code>GeomPoint</code> with <code>GeomSimplePoint</code>.</p></li>
<li><p>Compare and contrast <code>GeomPolygon</code> with <code>GeomSimplePolygon</code>.</p></li>
</ol>
</section>
</section>
<section id="geoms-and-stats-with-multiple-orientation" class="level2">
<h2 class="anchored" data-anchor-id="geoms-and-stats-with-multiple-orientation">Geoms and Stats with multiple orientation</h2>
<p>Some layers have a specific orientation. <code>geom_bar()</code> e.g.&nbsp;have the bars along one axis, <code>geom_line()</code> will sort the input by one axis, etc. The original approach to using these geoms in the other orientation was to add <code>coord_flip()</code> to the plot to switch the position of the x and y axes. Following ggplot2 v3.3 all the geoms will natively work in both orientations without <code>coord_flip()</code>. The mechanism is that the layer will try to guess the orientation from the mapped data, or take direction from the user using the <code>orientation</code> parameter. To replicate this functionality in new stats and geoms there’s a few steps to take. We will look at the boxplot layer as an example instead of creating a new one from scratch.</p>
<section id="omnidirectional-stats" class="level3">
<h3 class="anchored" data-anchor-id="omnidirectional-stats">Omnidirectional stats</h3>
<p>The actual guessing of orientation will happen in <code>setup_params()</code> using the <code>has_flipped_aes()</code> helper:</p>
<div class="cell" data-layout-align="center">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb26"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a>StatBoxplot<span class="sc">$</span>setup_params</span></code></pre></div><button title="コピー" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>#&gt; &lt;ggproto method&gt;
#&gt;   &lt;Wrapper function&gt;
#&gt;     function (...) 
#&gt; setup_params(..., self = self)
#&gt; 
#&gt;   &lt;Inner function (f)&gt;
#&gt;     function (self, data, params) 
#&gt; {
#&gt;     params$flipped_aes &lt;- has_flipped_aes(data, params, main_is_orthogonal = TRUE, 
#&gt;         group_has_equal = TRUE, main_is_optional = TRUE, default = NA)
#&gt;     if (is.na(params$flipped_aes) &amp;&amp; any(c("x", "y") %in% names(data))) {
#&gt;         cli::cli_warn("Orientation is not uniquely specified when both the x and y aesthetics are continuous. Picking default orientation 'x'.")
#&gt;         params$flipped_aes &lt;- FALSE
#&gt;     }
#&gt;     data &lt;- flip_data(data, params$flipped_aes)
#&gt;     has_x &lt;- !(is.null(data$x) &amp;&amp; is.null(params$x))
#&gt;     has_y &lt;- !(is.null(data$y) &amp;&amp; is.null(params$y))
#&gt;     if (!has_x &amp;&amp; !has_y) {
#&gt;         cli::cli_abort("{.fn {snake_class(self)}} requires an {.field x} or {.field y} aesthetic.")
#&gt;     }
#&gt;     params$width &lt;- params$width %||% (resolution(data$x %||% 
#&gt;         0, discrete = TRUE) * 0.75)
#&gt;     if (!is_mapped_discrete(data$x) &amp;&amp; is.double(data$x) &amp;&amp; !has_groups(data) &amp;&amp; 
#&gt;         any(data$x != data$x[1L])) {
#&gt;         cli::cli_warn(c("Continuous {.field {flipped_names(params$flipped_aes)$x}} aesthetic", 
#&gt;             i = "did you forget {.code aes(group = ...)}?"))
#&gt;     }
#&gt;     params
#&gt; }</code></pre>
</div>
</div>
<p>Following this is a call to <code>flip_data()</code> which will make sure the data is in horizontal orientation. The rest of the code can then simply assume that the data is in a specific orientation. The same thing happens in <code>setup_data()</code>:</p>
<div class="cell" data-layout-align="center">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb28"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a>StatBoxplot<span class="sc">$</span>setup_data</span></code></pre></div><button title="コピー" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>#&gt; &lt;ggproto method&gt;
#&gt;   &lt;Wrapper function&gt;
#&gt;     function (...) 
#&gt; setup_data(..., self = self)
#&gt; 
#&gt;   &lt;Inner function (f)&gt;
#&gt;     function (self, data, params) 
#&gt; {
#&gt;     data &lt;- flip_data(data, params$flipped_aes)
#&gt;     data$x &lt;- data$x %||% 0
#&gt;     data &lt;- remove_missing(data, na.rm = params$na.rm, vars = "x", 
#&gt;         name = "stat_boxplot")
#&gt;     flip_data(data, params$flipped_aes)
#&gt; }</code></pre>
</div>
</div>
<p>The data is flipped (if needed), manipulated, and flipped back as it is returned.</p>
<p>During the computation, this sandwiching between <code>flip_data()</code> is used as well, but right before the data is returned it will also get a <code>flipped_aes</code> column denoting if the data is flipped or not. This allows the stat to communicate to the geom that orientation has already been determined.</p>
</section>
<section id="omnidirecitonal-geoms" class="level3">
<h3 class="anchored" data-anchor-id="omnidirecitonal-geoms">Omnidirecitonal geoms</h3>
<p>The setup for geoms is pretty much the same, with a few twists. <code>has_flipped_aes()</code> is also used in <code>setup_params()</code>, where it will usually be picked up from the <code>flipped_aes</code> column given by the stat. In <code>setup_data()</code> you will often see that <code>flipped_aes</code> is reassigned, to make sure it exist prior to position adjustment. This is needed if the geom is used together with a stat that doesn’t handle orientation (often <code>stat_identity()</code>):</p>
<div class="cell" data-layout-align="center">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb30"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a>GeomBoxplot<span class="sc">$</span>setup_data</span></code></pre></div><button title="コピー" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>#&gt; &lt;ggproto method&gt;
#&gt;   &lt;Wrapper function&gt;
#&gt;     function (...) 
#&gt; setup_data(..., self = self)
#&gt; 
#&gt;   &lt;Inner function (f)&gt;
#&gt;     function (self, data, params) 
#&gt; {
#&gt;     data$flipped_aes &lt;- params$flipped_aes
#&gt;     data &lt;- flip_data(data, params$flipped_aes)
#&gt;     data &lt;- compute_data_size(data, params$width, default = self$default_aes$width, 
#&gt;         zero = FALSE, discrete = TRUE)
#&gt;     if (isFALSE(params$outliers)) {
#&gt;         data$outliers &lt;- NULL
#&gt;     }
#&gt;     if (!is.null(data$outliers)) {
#&gt;         suppressWarnings({
#&gt;             out_min &lt;- vapply(data$outliers, min, numeric(1))
#&gt;             out_max &lt;- vapply(data$outliers, max, numeric(1))
#&gt;         })
#&gt;         data$ymin_final &lt;- pmin(out_min, data$ymin)
#&gt;         data$ymax_final &lt;- pmax(out_max, data$ymax)
#&gt;     }
#&gt;     if (is.null(params) || is.null(params$varwidth) || !params$varwidth || 
#&gt;         is.null(data$relvarwidth)) {
#&gt;         data$xmin &lt;- data$x - data$width/2
#&gt;         data$xmax &lt;- data$x + data$width/2
#&gt;     }
#&gt;     else {
#&gt;         data$relvarwidth &lt;- data$relvarwidth/max(data$relvarwidth)
#&gt;         data$xmin &lt;- data$x - data$relvarwidth * data$width/2
#&gt;         data$xmax &lt;- data$x + data$relvarwidth * data$width/2
#&gt;     }
#&gt;     data$width &lt;- NULL
#&gt;     if (!is.null(data$relvarwidth)) 
#&gt;         data$relvarwidth &lt;- NULL
#&gt;     flip_data(data, params$flipped_aes)
#&gt; }</code></pre>
</div>
</div>
<p>In the <code>draw_*()</code> method you will once again sandwich any data manipulation between <code>flip_data()</code> calls. It is important to make sure that the data is flipped back prior to creating the grob or calling draw methods from other geoms.</p>
</section>
<section id="dealing-with-required-aesthetics" class="level3">
<h3 class="anchored" data-anchor-id="dealing-with-required-aesthetics">Dealing with required aesthetics</h3>
<p>Omnidirectional layers usually have two different sets of required aesthetics. Which set is used is often how it knows the orientation. To handle this gracefully the <code>required_aes</code> field of <code>Stat</code> and <code>Geom</code> classes understands the <code>|</code> (or) operator. Looking at <code>GeomBoxplot</code> we can see how it is used:</p>
<div class="cell" data-layout-align="center">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb32"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a>GeomBoxplot<span class="sc">$</span>required_aes</span></code></pre></div><button title="コピー" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>#&gt; [1] "x|y"            "lower|xlower"   "upper|xupper"   "middle|xmiddle"
#&gt; [5] "ymin|xmin"      "ymax|xmax"</code></pre>
</div>
</div>
<p>This tells ggplot2 that either all the aesthetics before <code>|</code> are required or all the aesthetics after are required.</p>
</section>
<section id="ambiguous-layers" class="level3">
<h3 class="anchored" data-anchor-id="ambiguous-layers">Ambiguous layers</h3>
<p>Some layers will not have a clear interpretation of their data in terms of orientation. A classic example is <code>geom_line()</code> which just by convention runs along the x-axis. There is nothing in the data itself that indicates that. For these geoms the user must indicate a flipped orientation by setting <code>orientation = "y"</code>. The stat or geom will then call <code>has_flipped_aes()</code> with <code>ambiguous = TRUE</code> to cancel any guessing based on data format. As an example we can see the <code>setup_params()</code> method of <code>GeomLine</code>:</p>
<div class="cell" data-layout-align="center">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb34"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb34-1"><a href="#cb34-1" aria-hidden="true" tabindex="-1"></a>GeomLine<span class="sc">$</span>setup_params</span></code></pre></div><button title="コピー" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>#&gt; &lt;ggproto method&gt;
#&gt;   &lt;Wrapper function&gt;
#&gt;     function (...) 
#&gt; setup_params(...)
#&gt; 
#&gt;   &lt;Inner function (f)&gt;
#&gt;     function (data, params) 
#&gt; {
#&gt;     params$flipped_aes &lt;- has_flipped_aes(data, params, ambiguous = TRUE)
#&gt;     params
#&gt; }</code></pre>
</div>
</div>
</section>
</section>
<section id="creating-your-own-theme" class="level2">
<h2 class="anchored" data-anchor-id="creating-your-own-theme">Creating your own theme</h2>
<p>Themes govern how non-data elements of the plot are displayed. If you’re going to create your own complete theme, there are a few things you need to know:</p>
<ul>
<li>Overriding existing elements, rather than modifying them</li>
<li>The four global elements that affect (almost) every other theme element</li>
<li>Complete vs.&nbsp;incomplete elements</li>
</ul>
<section id="overriding-elements" class="level3">
<h3 class="anchored" data-anchor-id="overriding-elements">Overriding elements</h3>
<p>By default, when you add a new theme element, it inherits values from the existing theme. For example, the following code sets the key colour to red, but it inherits the existing fill colour:</p>
<div class="cell" data-layout-align="center">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb36"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb36-1"><a href="#cb36-1" aria-hidden="true" tabindex="-1"></a><span class="fu">theme_grey</span>()<span class="sc">$</span>legend.key</span></code></pre></div><button title="コピー" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>#&gt; NULL</code></pre>
</div>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb38"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb38-1"><a href="#cb38-1" aria-hidden="true" tabindex="-1"></a>new_theme <span class="ot">&lt;-</span> <span class="fu">theme_grey</span>() <span class="sc">+</span> <span class="fu">theme</span>(<span class="at">legend.key =</span> <span class="fu">element_rect</span>(<span class="at">colour =</span> <span class="st">"red"</span>))</span>
<span id="cb38-2"><a href="#cb38-2" aria-hidden="true" tabindex="-1"></a>new_theme<span class="sc">$</span>legend.key</span></code></pre></div><button title="コピー" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>#&gt; &lt;ggplot2::element_rect&gt;
#&gt;  @ fill         : NULL
#&gt;  @ colour       : chr "red"
#&gt;  @ linewidth    : NULL
#&gt;  @ linetype     : NULL
#&gt;  @ linejoin     : NULL
#&gt;  @ inherit.blank: logi FALSE</code></pre>
</div>
</div>
<p>To override it completely, use <code>%+replace%</code> instead of <code>+</code>:</p>
<div class="cell" data-layout-align="center">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb40"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb40-1"><a href="#cb40-1" aria-hidden="true" tabindex="-1"></a>new_theme <span class="ot">&lt;-</span> <span class="fu">theme_grey</span>() <span class="sc">%+replace%</span> <span class="fu">theme</span>(<span class="at">legend.key =</span> <span class="fu">element_rect</span>(<span class="at">colour =</span> <span class="st">"red"</span>))</span>
<span id="cb40-2"><a href="#cb40-2" aria-hidden="true" tabindex="-1"></a>new_theme<span class="sc">$</span>legend.key</span></code></pre></div><button title="コピー" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>#&gt; &lt;ggplot2::element_rect&gt;
#&gt;  @ fill         : NULL
#&gt;  @ colour       : chr "red"
#&gt;  @ linewidth    : NULL
#&gt;  @ linetype     : NULL
#&gt;  @ linejoin     : NULL
#&gt;  @ inherit.blank: logi FALSE</code></pre>
</div>
</div>
</section>
<section id="global-elements" class="level3">
<h3 class="anchored" data-anchor-id="global-elements">Global elements</h3>
<p>There are four elements that affect the global appearance of the plot:</p>
<table class="caption-top table">
<colgroup>
<col style="width: 23%">
<col style="width: 33%">
<col style="width: 42%">
</colgroup>
<thead>
<tr class="header">
<th>Element</th>
<th>Theme function</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>line</td>
<td><code>element_line()</code></td>
<td>all line elements</td>
</tr>
<tr class="even">
<td>rect</td>
<td><code>element_rect()</code></td>
<td>all rectangular elements</td>
</tr>
<tr class="odd">
<td>text</td>
<td><code>element_text()</code></td>
<td>all text</td>
</tr>
<tr class="even">
<td>title</td>
<td><code>element_text()</code></td>
<td>all text in title elements (plot, axes &amp; legend)</td>
</tr>
</tbody>
</table>
<p>These set default properties that are inherited by more specific settings. These are most useful for setting an overall “background” colour and overall font settings (e.g.&nbsp;family and size).</p>
<div class="cell" data-layout-align="center">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb42"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb42-1"><a href="#cb42-1" aria-hidden="true" tabindex="-1"></a>df <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">x =</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">3</span>, <span class="at">y =</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">3</span>)</span>
<span id="cb42-2"><a href="#cb42-2" aria-hidden="true" tabindex="-1"></a>base <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(df, <span class="fu">aes</span>(x, y)) <span class="sc">+</span> </span>
<span id="cb42-3"><a href="#cb42-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>() <span class="sc">+</span> </span>
<span id="cb42-4"><a href="#cb42-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>()</span>
<span id="cb42-5"><a href="#cb42-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-6"><a href="#cb42-6" aria-hidden="true" tabindex="-1"></a>base</span></code></pre></div><button title="コピー" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="extending-ggplot2_files/figure-html/axis-line-ex-1.png" class="img-fluid quarto-figure quarto-figure-center figure-img" alt="Scatterplot of three observations arranged diagonally. The axis titles 'x' and 'y' are coloured in black" width="672"></p>
</figure>
</div>
</div>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb43"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb43-1"><a href="#cb43-1" aria-hidden="true" tabindex="-1"></a>base <span class="sc">+</span> <span class="fu">theme</span>(<span class="at">text =</span> <span class="fu">element_text</span>(<span class="at">colour =</span> <span class="st">"red"</span>))</span></code></pre></div><button title="コピー" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="extending-ggplot2_files/figure-html/axis-line-ex-2.png" class="img-fluid quarto-figure quarto-figure-center figure-img" alt="Scatterplot of three observations arranged diagonally. The axis titles 'x' and 'y' are coloured in red" width="672"></p>
</figure>
</div>
</div>
</div>
<p>You should generally start creating a theme by modifying these values.</p>
</section>
<section id="complete-vs-incomplete" class="level3">
<h3 class="anchored" data-anchor-id="complete-vs-incomplete">Complete vs incomplete</h3>
<p>It is useful to understand the difference between complete and incomplete theme objects. A <em>complete</em> theme object is one produced by calling a theme function with the attribute <code>complete = TRUE</code>.</p>
<p>Theme functions <code>theme_grey()</code> and <code>theme_bw()</code> are examples of complete theme functions. Calls to <code>theme()</code> produce <em>incomplete</em> theme objects, since they represent (local) modifications to a theme object rather than returning a complete theme object per se. When adding an incomplete theme to a complete one, the result is a complete theme.</p>
<p>Complete and incomplete themes behave somewhat differently when added to a ggplot object:</p>
<ul>
<li><p>Adding an incomplete theme augments the current theme object, replacing only those properties of elements defined in the call to <code>theme()</code>.</p></li>
<li><p>Adding a complete theme wipes away the existing theme and applies the new theme.</p></li>
</ul>
</section>
</section>
<section id="creating-a-new-faceting" class="level2">
<h2 class="anchored" data-anchor-id="creating-a-new-faceting">Creating a new faceting</h2>
<p>Facets are a way to draw small multiples of the data in different panels. One of the more daunting exercises in ggplot2 extensions is to create a new faceting system. The reason for this is that when creating new facetings you take on the responsibility of how (almost) everything is drawn on the screen, and many do not have experience with directly using <a href="https://cran.r-project.org/package=gtable">gtable</a> and <a href="https://cran.r-project.org/package=grid">grid</a> upon which the ggplot2 rendering is built. If you decide to venture into faceting extensions, it is highly recommended to gain proficiency with the above-mentioned packages.</p>
<p>The <code>Facet</code> class in ggplot2 is very powerful as it takes on responsibility of a wide range of tasks. The main tasks of a <code>Facet</code> object are:</p>
<ul>
<li><p>Define a layout; that is, a partitioning of the data into different plot areas (panels) as well as which panels share position scales.</p></li>
<li><p>Map plot data into the correct panels, potentially duplicating data if it should exist in multiple panels (e.g.&nbsp;margins in <code>facet_grid()</code>).</p></li>
<li><p>Assemble all panels into a final gtable, adding axes, strips and decorations in the process.</p></li>
</ul>
<p>Apart from these three tasks, for which functionality must be implemented, there are a couple of additional extension points where sensible defaults have been provided. These can generally be ignored, but adventurous developers can override them for even more control:</p>
<ul>
<li><p>Initialization and training of positional scales for each panel.</p></li>
<li><p>Decoration in front of and behind each panel.</p></li>
<li><p>Drawing of axis labels</p></li>
</ul>
<p>To show how a new faceting class is created we will start simple and go through each of the required methods in turn to build up <code>facet_duplicate()</code> that simply duplicate our plot into two panels. After this we will tinker with it a bit to show some of the more powerful possibilities.</p>
<section id="creating-a-layout-specification" class="level3">
<h3 class="anchored" data-anchor-id="creating-a-layout-specification">Creating a layout specification</h3>
<p>A layout in the context of facets is a <code>data.frame</code> that defines a mapping between data and the panels it should reside in as well as which positional scales should be used. The output should at least contain the columns <code>PANEL</code>, <code>SCALE_X</code>, and <code>SCALE_Y</code>, but will often contain more to help assign data to the correct panel (<code>facet_grid()</code> will e.g.&nbsp;also return the faceting variables associated with each panel). Let’s make a function that defines a duplicate layout:</p>
<div class="cell" data-layout-align="center">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb44"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb44-1"><a href="#cb44-1" aria-hidden="true" tabindex="-1"></a>layout <span class="ot">&lt;-</span> <span class="cf">function</span>(data, params) {</span>
<span id="cb44-2"><a href="#cb44-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">data.frame</span>(<span class="at">PANEL =</span> <span class="fu">c</span>(<span class="dv">1</span>L, <span class="dv">2</span>L), <span class="at">SCALE_X =</span> <span class="dv">1</span>L, <span class="at">SCALE_Y =</span> <span class="dv">1</span>L)</span>
<span id="cb44-3"><a href="#cb44-3" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div><button title="コピー" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<p>This is quite simple as the faceting should just define two panels irrespectively of the input data and parameters.</p>
</section>
<section id="mapping-data-into-panels" class="level3">
<h3 class="anchored" data-anchor-id="mapping-data-into-panels">Mapping data into panels</h3>
<p>In order for ggplot2 to know which data should go where it needs the data to be assigned to a panel. The purpose of the mapping step is to assign a <code>PANEL</code> column to the layer data identifying which panel it belongs to.</p>
<div class="cell" data-layout-align="center">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb45"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb45-1"><a href="#cb45-1" aria-hidden="true" tabindex="-1"></a>mapping <span class="ot">&lt;-</span> <span class="cf">function</span>(data, layout, params) {</span>
<span id="cb45-2"><a href="#cb45-2" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">is.null</span>(data) <span class="sc">||</span> <span class="fu">nrow</span>(data) <span class="sc">==</span> <span class="dv">0</span>) {</span>
<span id="cb45-3"><a href="#cb45-3" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(<span class="fu">cbind</span>(data, <span class="at">PANEL =</span> <span class="fu">integer</span>(<span class="dv">0</span>)))</span>
<span id="cb45-4"><a href="#cb45-4" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb45-5"><a href="#cb45-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rbind</span>(</span>
<span id="cb45-6"><a href="#cb45-6" aria-hidden="true" tabindex="-1"></a>    <span class="fu">cbind</span>(data, <span class="at">PANEL =</span> <span class="dv">1</span>L),</span>
<span id="cb45-7"><a href="#cb45-7" aria-hidden="true" tabindex="-1"></a>    <span class="fu">cbind</span>(data, <span class="at">PANEL =</span> <span class="dv">2</span>L)</span>
<span id="cb45-8"><a href="#cb45-8" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb45-9"><a href="#cb45-9" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div><button title="コピー" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<p>here we first investigate whether we have gotten an empty <code>data.frame</code> and if not we duplicate the data and assign the original data to the first panel and the new data to the second panel.</p>
</section>
<section id="laying-out-the-panels" class="level3">
<h3 class="anchored" data-anchor-id="laying-out-the-panels">Laying out the panels</h3>
<p>While the two functions above have been deceivingly simple, this last one is going to take some more work. Our goal is to draw two panels beside (or above) each other with axes etc.</p>
<div class="cell" data-layout-align="center">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb46"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb46-1"><a href="#cb46-1" aria-hidden="true" tabindex="-1"></a>render <span class="ot">&lt;-</span> <span class="cf">function</span>(panels, layout, x_scales, y_scales, ranges, coord, data,</span>
<span id="cb46-2"><a href="#cb46-2" aria-hidden="true" tabindex="-1"></a>                   theme, params) {</span>
<span id="cb46-3"><a href="#cb46-3" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Place panels according to settings</span></span>
<span id="cb46-4"><a href="#cb46-4" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (params<span class="sc">$</span>horizontal) {</span>
<span id="cb46-5"><a href="#cb46-5" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Put panels in matrix and convert to a gtable</span></span>
<span id="cb46-6"><a href="#cb46-6" aria-hidden="true" tabindex="-1"></a>    panels <span class="ot">&lt;-</span> <span class="fu">matrix</span>(panels, <span class="at">ncol =</span> <span class="dv">2</span>)</span>
<span id="cb46-7"><a href="#cb46-7" aria-hidden="true" tabindex="-1"></a>    panel_table <span class="ot">&lt;-</span> gtable<span class="sc">::</span><span class="fu">gtable_matrix</span>(<span class="st">"layout"</span>, panels, </span>
<span id="cb46-8"><a href="#cb46-8" aria-hidden="true" tabindex="-1"></a>      <span class="at">widths =</span> <span class="fu">unit</span>(<span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">1</span>), <span class="st">"null"</span>), <span class="at">heights =</span> <span class="fu">unit</span>(<span class="dv">1</span>, <span class="st">"null"</span>), <span class="at">clip =</span> <span class="st">"on"</span>)</span>
<span id="cb46-9"><a href="#cb46-9" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Add spacing according to theme</span></span>
<span id="cb46-10"><a href="#cb46-10" aria-hidden="true" tabindex="-1"></a>    panel_spacing <span class="ot">&lt;-</span> <span class="fu">calc_element</span>(<span class="st">"panel.spacing.x"</span>, theme)</span>
<span id="cb46-11"><a href="#cb46-11" aria-hidden="true" tabindex="-1"></a>    panel_table <span class="ot">&lt;-</span> gtable<span class="sc">::</span><span class="fu">gtable_add_col_space</span>(panel_table, panel_spacing)</span>
<span id="cb46-12"><a href="#cb46-12" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> {</span>
<span id="cb46-13"><a href="#cb46-13" aria-hidden="true" tabindex="-1"></a>    panels <span class="ot">&lt;-</span> <span class="fu">matrix</span>(panels, <span class="at">ncol =</span> <span class="dv">1</span>)</span>
<span id="cb46-14"><a href="#cb46-14" aria-hidden="true" tabindex="-1"></a>    panel_table <span class="ot">&lt;-</span> gtable<span class="sc">::</span><span class="fu">gtable_matrix</span>(<span class="st">"layout"</span>, panels, </span>
<span id="cb46-15"><a href="#cb46-15" aria-hidden="true" tabindex="-1"></a>      <span class="at">widths =</span> <span class="fu">unit</span>(<span class="dv">1</span>, <span class="st">"null"</span>), <span class="at">heights =</span> <span class="fu">unit</span>(<span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">1</span>), <span class="st">"null"</span>), <span class="at">clip =</span> <span class="st">"on"</span>)</span>
<span id="cb46-16"><a href="#cb46-16" aria-hidden="true" tabindex="-1"></a>    panel_spacing <span class="ot">&lt;-</span> <span class="cf">if</span> (<span class="fu">is.null</span>(theme<span class="sc">$</span>panel.spacing.y)) {</span>
<span id="cb46-17"><a href="#cb46-17" aria-hidden="true" tabindex="-1"></a>      theme<span class="sc">$</span>panel.spacing</span>
<span id="cb46-18"><a href="#cb46-18" aria-hidden="true" tabindex="-1"></a>    } <span class="cf">else</span> {</span>
<span id="cb46-19"><a href="#cb46-19" aria-hidden="true" tabindex="-1"></a>      theme<span class="sc">$</span>panel.spacing.y</span>
<span id="cb46-20"><a href="#cb46-20" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb46-21"><a href="#cb46-21" aria-hidden="true" tabindex="-1"></a>    panel_table <span class="ot">&lt;-</span> gtable<span class="sc">::</span><span class="fu">gtable_add_row_space</span>(panel_table, panel_spacing)</span>
<span id="cb46-22"><a href="#cb46-22" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb46-23"><a href="#cb46-23" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Name panel grobs so they can be found later</span></span>
<span id="cb46-24"><a href="#cb46-24" aria-hidden="true" tabindex="-1"></a>  panel_table<span class="sc">$</span>layout<span class="sc">$</span>name <span class="ot">&lt;-</span> <span class="fu">paste0</span>(<span class="st">"panel-"</span>, <span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">2</span>))</span>
<span id="cb46-25"><a href="#cb46-25" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb46-26"><a href="#cb46-26" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Construct the axes</span></span>
<span id="cb46-27"><a href="#cb46-27" aria-hidden="true" tabindex="-1"></a>  axes <span class="ot">&lt;-</span> <span class="fu">render_axes</span>(ranges[<span class="dv">1</span>], ranges[<span class="dv">1</span>], coord, theme, </span>
<span id="cb46-28"><a href="#cb46-28" aria-hidden="true" tabindex="-1"></a>    <span class="at">transpose =</span> <span class="cn">TRUE</span>)</span>
<span id="cb46-29"><a href="#cb46-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-30"><a href="#cb46-30" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Add axes around each panel</span></span>
<span id="cb46-31"><a href="#cb46-31" aria-hidden="true" tabindex="-1"></a>  panel_pos_h <span class="ot">&lt;-</span> <span class="fu">panel_cols</span>(panel_table)<span class="sc">$</span>l</span>
<span id="cb46-32"><a href="#cb46-32" aria-hidden="true" tabindex="-1"></a>  panel_pos_v <span class="ot">&lt;-</span> <span class="fu">panel_rows</span>(panel_table)<span class="sc">$</span>t</span>
<span id="cb46-33"><a href="#cb46-33" aria-hidden="true" tabindex="-1"></a>  axis_width_l <span class="ot">&lt;-</span> <span class="fu">unit</span>(grid<span class="sc">::</span><span class="fu">convertWidth</span>(</span>
<span id="cb46-34"><a href="#cb46-34" aria-hidden="true" tabindex="-1"></a>    grid<span class="sc">::</span><span class="fu">grobWidth</span>(axes<span class="sc">$</span>y<span class="sc">$</span>left[[<span class="dv">1</span>]]), <span class="st">"cm"</span>, <span class="cn">TRUE</span>), <span class="st">"cm"</span>)</span>
<span id="cb46-35"><a href="#cb46-35" aria-hidden="true" tabindex="-1"></a>  axis_width_r <span class="ot">&lt;-</span> <span class="fu">unit</span>(grid<span class="sc">::</span><span class="fu">convertWidth</span>(</span>
<span id="cb46-36"><a href="#cb46-36" aria-hidden="true" tabindex="-1"></a>    grid<span class="sc">::</span><span class="fu">grobWidth</span>(axes<span class="sc">$</span>y<span class="sc">$</span>right[[<span class="dv">1</span>]]), <span class="st">"cm"</span>, <span class="cn">TRUE</span>), <span class="st">"cm"</span>)</span>
<span id="cb46-37"><a href="#cb46-37" aria-hidden="true" tabindex="-1"></a>  <span class="do">## We do it reverse so we don't change the position of panels when we add axes</span></span>
<span id="cb46-38"><a href="#cb46-38" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (i <span class="cf">in</span> <span class="fu">rev</span>(panel_pos_h)) {</span>
<span id="cb46-39"><a href="#cb46-39" aria-hidden="true" tabindex="-1"></a>    panel_table <span class="ot">&lt;-</span> gtable<span class="sc">::</span><span class="fu">gtable_add_cols</span>(panel_table, axis_width_r, i)</span>
<span id="cb46-40"><a href="#cb46-40" aria-hidden="true" tabindex="-1"></a>    panel_table <span class="ot">&lt;-</span> gtable<span class="sc">::</span><span class="fu">gtable_add_grob</span>(panel_table, </span>
<span id="cb46-41"><a href="#cb46-41" aria-hidden="true" tabindex="-1"></a>      <span class="fu">rep</span>(axes<span class="sc">$</span>y<span class="sc">$</span>right, <span class="fu">length</span>(panel_pos_v)), <span class="at">t =</span> panel_pos_v, <span class="at">l =</span> i <span class="sc">+</span> <span class="dv">1</span>, </span>
<span id="cb46-42"><a href="#cb46-42" aria-hidden="true" tabindex="-1"></a>      <span class="at">clip =</span> <span class="st">"off"</span>)</span>
<span id="cb46-43"><a href="#cb46-43" aria-hidden="true" tabindex="-1"></a>    panel_table <span class="ot">&lt;-</span> gtable<span class="sc">::</span><span class="fu">gtable_add_cols</span>(panel_table, axis_width_l, i <span class="sc">-</span> <span class="dv">1</span>)</span>
<span id="cb46-44"><a href="#cb46-44" aria-hidden="true" tabindex="-1"></a>    panel_table <span class="ot">&lt;-</span> gtable<span class="sc">::</span><span class="fu">gtable_add_grob</span>(panel_table, </span>
<span id="cb46-45"><a href="#cb46-45" aria-hidden="true" tabindex="-1"></a>      <span class="fu">rep</span>(axes<span class="sc">$</span>y<span class="sc">$</span>left, <span class="fu">length</span>(panel_pos_v)), <span class="at">t =</span> panel_pos_v, <span class="at">l =</span> i, </span>
<span id="cb46-46"><a href="#cb46-46" aria-hidden="true" tabindex="-1"></a>      <span class="at">clip =</span> <span class="st">"off"</span>)</span>
<span id="cb46-47"><a href="#cb46-47" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb46-48"><a href="#cb46-48" aria-hidden="true" tabindex="-1"></a>  <span class="do">## Recalculate as gtable has changed</span></span>
<span id="cb46-49"><a href="#cb46-49" aria-hidden="true" tabindex="-1"></a>  panel_pos_h <span class="ot">&lt;-</span> <span class="fu">panel_cols</span>(panel_table)<span class="sc">$</span>l</span>
<span id="cb46-50"><a href="#cb46-50" aria-hidden="true" tabindex="-1"></a>  panel_pos_v <span class="ot">&lt;-</span> <span class="fu">panel_rows</span>(panel_table)<span class="sc">$</span>t</span>
<span id="cb46-51"><a href="#cb46-51" aria-hidden="true" tabindex="-1"></a>  axis_height_t <span class="ot">&lt;-</span> <span class="fu">unit</span>(grid<span class="sc">::</span><span class="fu">convertHeight</span>(</span>
<span id="cb46-52"><a href="#cb46-52" aria-hidden="true" tabindex="-1"></a>    grid<span class="sc">::</span><span class="fu">grobHeight</span>(axes<span class="sc">$</span>x<span class="sc">$</span>top[[<span class="dv">1</span>]]), <span class="st">"cm"</span>, <span class="cn">TRUE</span>), <span class="st">"cm"</span>)</span>
<span id="cb46-53"><a href="#cb46-53" aria-hidden="true" tabindex="-1"></a>  axis_height_b <span class="ot">&lt;-</span> <span class="fu">unit</span>(grid<span class="sc">::</span><span class="fu">convertHeight</span>(</span>
<span id="cb46-54"><a href="#cb46-54" aria-hidden="true" tabindex="-1"></a>    grid<span class="sc">::</span><span class="fu">grobHeight</span>(axes<span class="sc">$</span>x<span class="sc">$</span>bottom[[<span class="dv">1</span>]]), <span class="st">"cm"</span>, <span class="cn">TRUE</span>), <span class="st">"cm"</span>)</span>
<span id="cb46-55"><a href="#cb46-55" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (i <span class="cf">in</span> <span class="fu">rev</span>(panel_pos_v)) {</span>
<span id="cb46-56"><a href="#cb46-56" aria-hidden="true" tabindex="-1"></a>    panel_table <span class="ot">&lt;-</span> gtable<span class="sc">::</span><span class="fu">gtable_add_rows</span>(panel_table, axis_height_b, i)</span>
<span id="cb46-57"><a href="#cb46-57" aria-hidden="true" tabindex="-1"></a>    panel_table <span class="ot">&lt;-</span> gtable<span class="sc">::</span><span class="fu">gtable_add_grob</span>(panel_table, </span>
<span id="cb46-58"><a href="#cb46-58" aria-hidden="true" tabindex="-1"></a>      <span class="fu">rep</span>(axes<span class="sc">$</span>x<span class="sc">$</span>bottom, <span class="fu">length</span>(panel_pos_h)), <span class="at">t =</span> i <span class="sc">+</span> <span class="dv">1</span>, <span class="at">l =</span> panel_pos_h, </span>
<span id="cb46-59"><a href="#cb46-59" aria-hidden="true" tabindex="-1"></a>      <span class="at">clip =</span> <span class="st">"off"</span>)</span>
<span id="cb46-60"><a href="#cb46-60" aria-hidden="true" tabindex="-1"></a>    panel_table <span class="ot">&lt;-</span> gtable<span class="sc">::</span><span class="fu">gtable_add_rows</span>(panel_table, axis_height_t, i <span class="sc">-</span> <span class="dv">1</span>)</span>
<span id="cb46-61"><a href="#cb46-61" aria-hidden="true" tabindex="-1"></a>    panel_table <span class="ot">&lt;-</span> gtable<span class="sc">::</span><span class="fu">gtable_add_grob</span>(panel_table, </span>
<span id="cb46-62"><a href="#cb46-62" aria-hidden="true" tabindex="-1"></a>      <span class="fu">rep</span>(axes<span class="sc">$</span>x<span class="sc">$</span>top, <span class="fu">length</span>(panel_pos_h)), <span class="at">t =</span> i, <span class="at">l =</span> panel_pos_h, </span>
<span id="cb46-63"><a href="#cb46-63" aria-hidden="true" tabindex="-1"></a>      <span class="at">clip =</span> <span class="st">"off"</span>)</span>
<span id="cb46-64"><a href="#cb46-64" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb46-65"><a href="#cb46-65" aria-hidden="true" tabindex="-1"></a>  panel_table</span>
<span id="cb46-66"><a href="#cb46-66" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div><button title="コピー" class="code-copy-button"><i class="bi"></i></button></div>
</div>
</section>
<section id="assembling-the-facet-class" class="level3">
<h3 class="anchored" data-anchor-id="assembling-the-facet-class">Assembling the Facet class</h3>
<p>Usually all methods are defined within the class definition in the same way as is done for <code>Geom</code> and <code>Stat</code>. Here we have split it out so we could go through each in turn. All that remains is to assign our functions to the correct methods as well as making a constructor</p>
<div class="cell" data-layout-align="center">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb47"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb47-1"><a href="#cb47-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Constructor: shrink is required to govern whether scales are trained on </span></span>
<span id="cb47-2"><a href="#cb47-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Stat-transformed data or not.</span></span>
<span id="cb47-3"><a href="#cb47-3" aria-hidden="true" tabindex="-1"></a>facet_duplicate <span class="ot">&lt;-</span> <span class="cf">function</span>(<span class="at">horizontal =</span> <span class="cn">TRUE</span>, <span class="at">shrink =</span> <span class="cn">TRUE</span>) {</span>
<span id="cb47-4"><a href="#cb47-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggproto</span>(<span class="cn">NULL</span>, FacetDuplicate,</span>
<span id="cb47-5"><a href="#cb47-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">shrink =</span> shrink,</span>
<span id="cb47-6"><a href="#cb47-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">params =</span> <span class="fu">list</span>(</span>
<span id="cb47-7"><a href="#cb47-7" aria-hidden="true" tabindex="-1"></a>      <span class="at">horizontal =</span> horizontal</span>
<span id="cb47-8"><a href="#cb47-8" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb47-9"><a href="#cb47-9" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb47-10"><a href="#cb47-10" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb47-11"><a href="#cb47-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-12"><a href="#cb47-12" aria-hidden="true" tabindex="-1"></a>FacetDuplicate <span class="ot">&lt;-</span> <span class="fu">ggproto</span>(<span class="st">"FacetDuplicate"</span>, Facet,</span>
<span id="cb47-13"><a href="#cb47-13" aria-hidden="true" tabindex="-1"></a>  <span class="at">compute_layout =</span> layout,</span>
<span id="cb47-14"><a href="#cb47-14" aria-hidden="true" tabindex="-1"></a>  <span class="at">map_data =</span> mapping,</span>
<span id="cb47-15"><a href="#cb47-15" aria-hidden="true" tabindex="-1"></a>  <span class="at">draw_panels =</span> render</span>
<span id="cb47-16"><a href="#cb47-16" aria-hidden="true" tabindex="-1"></a>)</span></code></pre></div><button title="コピー" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<p>Now with everything assembled, lets test it out:</p>
<div class="cell" data-layout-align="center">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb48"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb48-1"><a href="#cb48-1" aria-hidden="true" tabindex="-1"></a>p <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(mtcars, <span class="fu">aes</span>(<span class="at">x =</span> hp, <span class="at">y =</span> mpg)) <span class="sc">+</span> <span class="fu">geom_point</span>()</span>
<span id="cb48-2"><a href="#cb48-2" aria-hidden="true" tabindex="-1"></a>p</span></code></pre></div><button title="コピー" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="extending-ggplot2_files/figure-html/unnamed-chunk-27-1.png" class="img-fluid quarto-figure quarto-figure-center figure-img" alt="Scatterplot showing horsepower against miles per gallon for 32 cars." width="672"></p>
</figure>
</div>
</div>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb49"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb49-1"><a href="#cb49-1" aria-hidden="true" tabindex="-1"></a>p <span class="sc">+</span> <span class="fu">facet_duplicate</span>()</span></code></pre></div><button title="コピー" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="extending-ggplot2_files/figure-html/unnamed-chunk-27-2.png" class="img-fluid quarto-figure quarto-figure-center figure-img" alt="Scatterplot with two panels showing horsepower against miles per gallon for 32 cars. The left and right panels are identical." width="672"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="doing-more-with-facets" class="level3">
<h3 class="anchored" data-anchor-id="doing-more-with-facets">Doing more with facets</h3>
<p>The example above was pretty useless and we’ll now try to expand on it to add some actual usability. We are going to make a faceting that adds panels with y-transformed axes:</p>
<div class="cell" data-layout-align="center">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb50"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb50-1"><a href="#cb50-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(scales)</span>
<span id="cb50-2"><a href="#cb50-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-3"><a href="#cb50-3" aria-hidden="true" tabindex="-1"></a>facet_trans <span class="ot">&lt;-</span> <span class="cf">function</span>(trans, <span class="at">horizontal =</span> <span class="cn">TRUE</span>, <span class="at">shrink =</span> <span class="cn">TRUE</span>) {</span>
<span id="cb50-4"><a href="#cb50-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggproto</span>(<span class="cn">NULL</span>, FacetTrans,</span>
<span id="cb50-5"><a href="#cb50-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">shrink =</span> shrink,</span>
<span id="cb50-6"><a href="#cb50-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">params =</span> <span class="fu">list</span>(</span>
<span id="cb50-7"><a href="#cb50-7" aria-hidden="true" tabindex="-1"></a>      <span class="at">trans =</span> scales<span class="sc">::</span><span class="fu">as.transform</span>(trans),</span>
<span id="cb50-8"><a href="#cb50-8" aria-hidden="true" tabindex="-1"></a>      <span class="at">horizontal =</span> horizontal</span>
<span id="cb50-9"><a href="#cb50-9" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb50-10"><a href="#cb50-10" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb50-11"><a href="#cb50-11" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb50-12"><a href="#cb50-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-13"><a href="#cb50-13" aria-hidden="true" tabindex="-1"></a>FacetTrans <span class="ot">&lt;-</span> <span class="fu">ggproto</span>(<span class="st">"FacetTrans"</span>, Facet,</span>
<span id="cb50-14"><a href="#cb50-14" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Almost as before but we want different y-scales for each panel</span></span>
<span id="cb50-15"><a href="#cb50-15" aria-hidden="true" tabindex="-1"></a>  <span class="at">compute_layout =</span> <span class="cf">function</span>(data, params) {</span>
<span id="cb50-16"><a href="#cb50-16" aria-hidden="true" tabindex="-1"></a>    <span class="fu">data.frame</span>(<span class="at">PANEL =</span> <span class="fu">c</span>(<span class="dv">1</span>L, <span class="dv">2</span>L), <span class="at">SCALE_X =</span> <span class="dv">1</span>L, <span class="at">SCALE_Y =</span> <span class="fu">c</span>(<span class="dv">1</span>L, <span class="dv">2</span>L))</span>
<span id="cb50-17"><a href="#cb50-17" aria-hidden="true" tabindex="-1"></a>  },</span>
<span id="cb50-18"><a href="#cb50-18" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Same as before</span></span>
<span id="cb50-19"><a href="#cb50-19" aria-hidden="true" tabindex="-1"></a>  <span class="at">map_data =</span> <span class="cf">function</span>(data, layout, params) {</span>
<span id="cb50-20"><a href="#cb50-20" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="fu">is.null</span>(data) <span class="sc">||</span> <span class="fu">nrow</span>(data) <span class="sc">==</span> <span class="dv">0</span>) {</span>
<span id="cb50-21"><a href="#cb50-21" aria-hidden="true" tabindex="-1"></a>      <span class="fu">return</span>(<span class="fu">cbind</span>(data, <span class="at">PANEL =</span> <span class="fu">integer</span>(<span class="dv">0</span>)))</span>
<span id="cb50-22"><a href="#cb50-22" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb50-23"><a href="#cb50-23" aria-hidden="true" tabindex="-1"></a>    <span class="fu">rbind</span>(</span>
<span id="cb50-24"><a href="#cb50-24" aria-hidden="true" tabindex="-1"></a>      <span class="fu">cbind</span>(data, <span class="at">PANEL =</span> <span class="dv">1</span>L),</span>
<span id="cb50-25"><a href="#cb50-25" aria-hidden="true" tabindex="-1"></a>      <span class="fu">cbind</span>(data, <span class="at">PANEL =</span> <span class="dv">2</span>L)</span>
<span id="cb50-26"><a href="#cb50-26" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb50-27"><a href="#cb50-27" aria-hidden="true" tabindex="-1"></a>  },</span>
<span id="cb50-28"><a href="#cb50-28" aria-hidden="true" tabindex="-1"></a>  <span class="co"># This is new. We create a new scale with the defined transformation</span></span>
<span id="cb50-29"><a href="#cb50-29" aria-hidden="true" tabindex="-1"></a>  <span class="at">init_scales =</span> <span class="cf">function</span>(layout, <span class="at">x_scale =</span> <span class="cn">NULL</span>, <span class="at">y_scale =</span> <span class="cn">NULL</span>, params) {</span>
<span id="cb50-30"><a href="#cb50-30" aria-hidden="true" tabindex="-1"></a>    scales <span class="ot">&lt;-</span> <span class="fu">list</span>()</span>
<span id="cb50-31"><a href="#cb50-31" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="sc">!</span><span class="fu">is.null</span>(x_scale)) {</span>
<span id="cb50-32"><a href="#cb50-32" aria-hidden="true" tabindex="-1"></a>      scales<span class="sc">$</span>x <span class="ot">&lt;-</span> <span class="fu">lapply</span>(<span class="fu">seq_len</span>(<span class="fu">max</span>(layout<span class="sc">$</span>SCALE_X)), <span class="cf">function</span>(i) x_scale<span class="sc">$</span><span class="fu">clone</span>())</span>
<span id="cb50-33"><a href="#cb50-33" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb50-34"><a href="#cb50-34" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="sc">!</span><span class="fu">is.null</span>(y_scale)) {</span>
<span id="cb50-35"><a href="#cb50-35" aria-hidden="true" tabindex="-1"></a>      y_scale_orig <span class="ot">&lt;-</span> y_scale<span class="sc">$</span><span class="fu">clone</span>()</span>
<span id="cb50-36"><a href="#cb50-36" aria-hidden="true" tabindex="-1"></a>      y_scale_new <span class="ot">&lt;-</span> y_scale<span class="sc">$</span><span class="fu">clone</span>()</span>
<span id="cb50-37"><a href="#cb50-37" aria-hidden="true" tabindex="-1"></a>      y_scale_new<span class="sc">$</span>trans <span class="ot">&lt;-</span> params<span class="sc">$</span>trans</span>
<span id="cb50-38"><a href="#cb50-38" aria-hidden="true" tabindex="-1"></a>      <span class="co"># Make sure that oob values are kept</span></span>
<span id="cb50-39"><a href="#cb50-39" aria-hidden="true" tabindex="-1"></a>      y_scale_new<span class="sc">$</span>oob <span class="ot">&lt;-</span> <span class="cf">function</span>(x, ...) x</span>
<span id="cb50-40"><a href="#cb50-40" aria-hidden="true" tabindex="-1"></a>      scales<span class="sc">$</span>y <span class="ot">&lt;-</span> <span class="fu">list</span>(y_scale_orig, y_scale_new)</span>
<span id="cb50-41"><a href="#cb50-41" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb50-42"><a href="#cb50-42" aria-hidden="true" tabindex="-1"></a>    scales</span>
<span id="cb50-43"><a href="#cb50-43" aria-hidden="true" tabindex="-1"></a>  },</span>
<span id="cb50-44"><a href="#cb50-44" aria-hidden="true" tabindex="-1"></a>  <span class="co"># We must make sure that the second scale is trained on transformed data</span></span>
<span id="cb50-45"><a href="#cb50-45" aria-hidden="true" tabindex="-1"></a>  <span class="at">train_scales =</span> <span class="cf">function</span>(x_scales, y_scales, layout, data, params) {</span>
<span id="cb50-46"><a href="#cb50-46" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Transform data for second panel prior to scale training</span></span>
<span id="cb50-47"><a href="#cb50-47" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="sc">!</span><span class="fu">is.null</span>(y_scales)) {</span>
<span id="cb50-48"><a href="#cb50-48" aria-hidden="true" tabindex="-1"></a>      data <span class="ot">&lt;-</span> <span class="fu">lapply</span>(data, <span class="cf">function</span>(layer_data) {</span>
<span id="cb50-49"><a href="#cb50-49" aria-hidden="true" tabindex="-1"></a>        match_id <span class="ot">&lt;-</span> <span class="fu">match</span>(layer_data<span class="sc">$</span>PANEL, layout<span class="sc">$</span>PANEL)</span>
<span id="cb50-50"><a href="#cb50-50" aria-hidden="true" tabindex="-1"></a>        y_vars <span class="ot">&lt;-</span> <span class="fu">intersect</span>(y_scales[[<span class="dv">1</span>]]<span class="sc">$</span>aesthetics, <span class="fu">names</span>(layer_data))</span>
<span id="cb50-51"><a href="#cb50-51" aria-hidden="true" tabindex="-1"></a>        trans_scale <span class="ot">&lt;-</span> layer_data<span class="sc">$</span>PANEL <span class="sc">==</span> <span class="dv">2</span>L</span>
<span id="cb50-52"><a href="#cb50-52" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> (i <span class="cf">in</span> y_vars) {</span>
<span id="cb50-53"><a href="#cb50-53" aria-hidden="true" tabindex="-1"></a>          layer_data[trans_scale, i] <span class="ot">&lt;-</span> y_scales[[<span class="dv">2</span>]]<span class="sc">$</span><span class="fu">transform</span>(layer_data[trans_scale, i])</span>
<span id="cb50-54"><a href="#cb50-54" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb50-55"><a href="#cb50-55" aria-hidden="true" tabindex="-1"></a>        layer_data</span>
<span id="cb50-56"><a href="#cb50-56" aria-hidden="true" tabindex="-1"></a>      })</span>
<span id="cb50-57"><a href="#cb50-57" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb50-58"><a href="#cb50-58" aria-hidden="true" tabindex="-1"></a>    Facet<span class="sc">$</span><span class="fu">train_scales</span>(x_scales, y_scales, layout, data, params)</span>
<span id="cb50-59"><a href="#cb50-59" aria-hidden="true" tabindex="-1"></a>  },</span>
<span id="cb50-60"><a href="#cb50-60" aria-hidden="true" tabindex="-1"></a>  <span class="co"># this is where we actually modify the data. It cannot be done in $map_data as that function</span></span>
<span id="cb50-61"><a href="#cb50-61" aria-hidden="true" tabindex="-1"></a>  <span class="co"># doesn't have access to the scales</span></span>
<span id="cb50-62"><a href="#cb50-62" aria-hidden="true" tabindex="-1"></a>  <span class="at">finish_data =</span> <span class="cf">function</span>(data, layout, x_scales, y_scales, params) {</span>
<span id="cb50-63"><a href="#cb50-63" aria-hidden="true" tabindex="-1"></a>    match_id <span class="ot">&lt;-</span> <span class="fu">match</span>(data<span class="sc">$</span>PANEL, layout<span class="sc">$</span>PANEL)</span>
<span id="cb50-64"><a href="#cb50-64" aria-hidden="true" tabindex="-1"></a>    y_vars <span class="ot">&lt;-</span> <span class="fu">intersect</span>(y_scales[[<span class="dv">1</span>]]<span class="sc">$</span>aesthetics, <span class="fu">names</span>(data))</span>
<span id="cb50-65"><a href="#cb50-65" aria-hidden="true" tabindex="-1"></a>    trans_scale <span class="ot">&lt;-</span> data<span class="sc">$</span>PANEL <span class="sc">==</span> <span class="dv">2</span>L</span>
<span id="cb50-66"><a href="#cb50-66" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> (i <span class="cf">in</span> y_vars) {</span>
<span id="cb50-67"><a href="#cb50-67" aria-hidden="true" tabindex="-1"></a>      data[trans_scale, i] <span class="ot">&lt;-</span> y_scales[[<span class="dv">2</span>]]<span class="sc">$</span><span class="fu">transform</span>(data[trans_scale, i])</span>
<span id="cb50-68"><a href="#cb50-68" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb50-69"><a href="#cb50-69" aria-hidden="true" tabindex="-1"></a>    data</span>
<span id="cb50-70"><a href="#cb50-70" aria-hidden="true" tabindex="-1"></a>  },</span>
<span id="cb50-71"><a href="#cb50-71" aria-hidden="true" tabindex="-1"></a>  <span class="co"># A few changes from before to accommodate that axes are now not duplicate of each other</span></span>
<span id="cb50-72"><a href="#cb50-72" aria-hidden="true" tabindex="-1"></a>  <span class="co"># We also add a panel strip to annotate the different panels</span></span>
<span id="cb50-73"><a href="#cb50-73" aria-hidden="true" tabindex="-1"></a>  <span class="at">draw_panels =</span> <span class="cf">function</span>(panels, layout, x_scales, y_scales, ranges, coord,</span>
<span id="cb50-74"><a href="#cb50-74" aria-hidden="true" tabindex="-1"></a>                         data, theme, params) {</span>
<span id="cb50-75"><a href="#cb50-75" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Place panels according to settings</span></span>
<span id="cb50-76"><a href="#cb50-76" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (params<span class="sc">$</span>horizontal) {</span>
<span id="cb50-77"><a href="#cb50-77" aria-hidden="true" tabindex="-1"></a>      <span class="co"># Put panels in matrix and convert to a gtable</span></span>
<span id="cb50-78"><a href="#cb50-78" aria-hidden="true" tabindex="-1"></a>      panels <span class="ot">&lt;-</span> <span class="fu">matrix</span>(panels, <span class="at">ncol =</span> <span class="dv">2</span>)</span>
<span id="cb50-79"><a href="#cb50-79" aria-hidden="true" tabindex="-1"></a>      panel_table <span class="ot">&lt;-</span> gtable<span class="sc">::</span><span class="fu">gtable_matrix</span>(<span class="st">"layout"</span>, panels, </span>
<span id="cb50-80"><a href="#cb50-80" aria-hidden="true" tabindex="-1"></a>        <span class="at">widths =</span> <span class="fu">unit</span>(<span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">1</span>), <span class="st">"null"</span>), <span class="at">heights =</span> <span class="fu">unit</span>(<span class="dv">1</span>, <span class="st">"null"</span>), <span class="at">clip =</span> <span class="st">"on"</span>)</span>
<span id="cb50-81"><a href="#cb50-81" aria-hidden="true" tabindex="-1"></a>      <span class="co"># Add spacing according to theme</span></span>
<span id="cb50-82"><a href="#cb50-82" aria-hidden="true" tabindex="-1"></a>      panel_spacing <span class="ot">&lt;-</span> <span class="fu">calc_element</span>(<span class="st">"panel.spacing.x"</span>, theme)</span>
<span id="cb50-83"><a href="#cb50-83" aria-hidden="true" tabindex="-1"></a>      panel_table <span class="ot">&lt;-</span> gtable<span class="sc">::</span><span class="fu">gtable_add_col_space</span>(panel_table, panel_spacing)</span>
<span id="cb50-84"><a href="#cb50-84" aria-hidden="true" tabindex="-1"></a>    } <span class="cf">else</span> {</span>
<span id="cb50-85"><a href="#cb50-85" aria-hidden="true" tabindex="-1"></a>      panels <span class="ot">&lt;-</span> <span class="fu">matrix</span>(panels, <span class="at">ncol =</span> <span class="dv">1</span>)</span>
<span id="cb50-86"><a href="#cb50-86" aria-hidden="true" tabindex="-1"></a>      panel_table <span class="ot">&lt;-</span> gtable<span class="sc">::</span><span class="fu">gtable_matrix</span>(<span class="st">"layout"</span>, panels, </span>
<span id="cb50-87"><a href="#cb50-87" aria-hidden="true" tabindex="-1"></a>        <span class="at">widths =</span> <span class="fu">unit</span>(<span class="dv">1</span>, <span class="st">"null"</span>), <span class="at">heights =</span> <span class="fu">unit</span>(<span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">1</span>), <span class="st">"null"</span>), <span class="at">clip =</span> <span class="st">"on"</span>)</span>
<span id="cb50-88"><a href="#cb50-88" aria-hidden="true" tabindex="-1"></a>      panel_spacing <span class="ot">&lt;-</span> <span class="fu">calc_element</span>(<span class="st">"panel.spacing.y"</span>, theme)</span>
<span id="cb50-89"><a href="#cb50-89" aria-hidden="true" tabindex="-1"></a>      panel_table <span class="ot">&lt;-</span> gtable<span class="sc">::</span><span class="fu">gtable_add_row_space</span>(panel_table, panel_spacing)</span>
<span id="cb50-90"><a href="#cb50-90" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb50-91"><a href="#cb50-91" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Name panel grobs so they can be found later</span></span>
<span id="cb50-92"><a href="#cb50-92" aria-hidden="true" tabindex="-1"></a>    panel_table<span class="sc">$</span>layout<span class="sc">$</span>name <span class="ot">&lt;-</span> <span class="fu">paste0</span>(<span class="st">"panel-"</span>, <span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">2</span>))</span>
<span id="cb50-93"><a href="#cb50-93" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb50-94"><a href="#cb50-94" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Construct the axes</span></span>
<span id="cb50-95"><a href="#cb50-95" aria-hidden="true" tabindex="-1"></a>    axes <span class="ot">&lt;-</span> <span class="fu">render_axes</span>(ranges[<span class="dv">1</span>], ranges, coord, theme, </span>
<span id="cb50-96"><a href="#cb50-96" aria-hidden="true" tabindex="-1"></a>      <span class="at">transpose =</span> <span class="cn">TRUE</span>)</span>
<span id="cb50-97"><a href="#cb50-97" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb50-98"><a href="#cb50-98" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Add axes around each panel</span></span>
<span id="cb50-99"><a href="#cb50-99" aria-hidden="true" tabindex="-1"></a>    grobWidths <span class="ot">&lt;-</span> <span class="cf">function</span>(x) {</span>
<span id="cb50-100"><a href="#cb50-100" aria-hidden="true" tabindex="-1"></a>      <span class="fu">unit</span>(<span class="fu">vapply</span>(x, <span class="cf">function</span>(x) {</span>
<span id="cb50-101"><a href="#cb50-101" aria-hidden="true" tabindex="-1"></a>        grid<span class="sc">::</span><span class="fu">convertWidth</span>(</span>
<span id="cb50-102"><a href="#cb50-102" aria-hidden="true" tabindex="-1"></a>          grid<span class="sc">::</span><span class="fu">grobWidth</span>(x), <span class="st">"cm"</span>, <span class="cn">TRUE</span>)</span>
<span id="cb50-103"><a href="#cb50-103" aria-hidden="true" tabindex="-1"></a>      }, <span class="fu">numeric</span>(<span class="dv">1</span>)), <span class="st">"cm"</span>)</span>
<span id="cb50-104"><a href="#cb50-104" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb50-105"><a href="#cb50-105" aria-hidden="true" tabindex="-1"></a>    panel_pos_h <span class="ot">&lt;-</span> <span class="fu">panel_cols</span>(panel_table)<span class="sc">$</span>l</span>
<span id="cb50-106"><a href="#cb50-106" aria-hidden="true" tabindex="-1"></a>    panel_pos_v <span class="ot">&lt;-</span> <span class="fu">panel_rows</span>(panel_table)<span class="sc">$</span>t</span>
<span id="cb50-107"><a href="#cb50-107" aria-hidden="true" tabindex="-1"></a>    axis_width_l <span class="ot">&lt;-</span> <span class="fu">grobWidths</span>(axes<span class="sc">$</span>y<span class="sc">$</span>left)</span>
<span id="cb50-108"><a href="#cb50-108" aria-hidden="true" tabindex="-1"></a>    axis_width_r <span class="ot">&lt;-</span> <span class="fu">grobWidths</span>(axes<span class="sc">$</span>y<span class="sc">$</span>right)</span>
<span id="cb50-109"><a href="#cb50-109" aria-hidden="true" tabindex="-1"></a>    <span class="do">## We do it reverse so we don't change the position of panels when we add axes</span></span>
<span id="cb50-110"><a href="#cb50-110" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (params<span class="sc">$</span>horizontal) {</span>
<span id="cb50-111"><a href="#cb50-111" aria-hidden="true" tabindex="-1"></a>      <span class="cf">for</span> (i <span class="cf">in</span> <span class="fu">rev</span>(<span class="fu">seq_along</span>(panel_pos_h))) {</span>
<span id="cb50-112"><a href="#cb50-112" aria-hidden="true" tabindex="-1"></a>        panel_table <span class="ot">&lt;-</span> gtable<span class="sc">::</span><span class="fu">gtable_add_cols</span>(panel_table, axis_width_r[i], panel_pos_h[i])</span>
<span id="cb50-113"><a href="#cb50-113" aria-hidden="true" tabindex="-1"></a>        panel_table <span class="ot">&lt;-</span> gtable<span class="sc">::</span><span class="fu">gtable_add_grob</span>(panel_table,</span>
<span id="cb50-114"><a href="#cb50-114" aria-hidden="true" tabindex="-1"></a>          axes<span class="sc">$</span>y<span class="sc">$</span>right[i], <span class="at">t =</span> panel_pos_v, <span class="at">l =</span> panel_pos_h[i] <span class="sc">+</span> <span class="dv">1</span>,</span>
<span id="cb50-115"><a href="#cb50-115" aria-hidden="true" tabindex="-1"></a>          <span class="at">clip =</span> <span class="st">"off"</span>)</span>
<span id="cb50-116"><a href="#cb50-116" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-117"><a href="#cb50-117" aria-hidden="true" tabindex="-1"></a>        panel_table <span class="ot">&lt;-</span> gtable<span class="sc">::</span><span class="fu">gtable_add_cols</span>(panel_table, axis_width_l[i], panel_pos_h[i] <span class="sc">-</span> <span class="dv">1</span>)</span>
<span id="cb50-118"><a href="#cb50-118" aria-hidden="true" tabindex="-1"></a>        panel_table <span class="ot">&lt;-</span> gtable<span class="sc">::</span><span class="fu">gtable_add_grob</span>(panel_table,</span>
<span id="cb50-119"><a href="#cb50-119" aria-hidden="true" tabindex="-1"></a>          axes<span class="sc">$</span>y<span class="sc">$</span>left[i], <span class="at">t =</span> panel_pos_v, <span class="at">l =</span> panel_pos_h[i],</span>
<span id="cb50-120"><a href="#cb50-120" aria-hidden="true" tabindex="-1"></a>          <span class="at">clip =</span> <span class="st">"off"</span>)</span>
<span id="cb50-121"><a href="#cb50-121" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb50-122"><a href="#cb50-122" aria-hidden="true" tabindex="-1"></a>    } <span class="cf">else</span> {</span>
<span id="cb50-123"><a href="#cb50-123" aria-hidden="true" tabindex="-1"></a>        panel_table <span class="ot">&lt;-</span> gtable<span class="sc">::</span><span class="fu">gtable_add_cols</span>(panel_table, axis_width_r[<span class="dv">1</span>], panel_pos_h)</span>
<span id="cb50-124"><a href="#cb50-124" aria-hidden="true" tabindex="-1"></a>        panel_table <span class="ot">&lt;-</span> gtable<span class="sc">::</span><span class="fu">gtable_add_grob</span>(panel_table,</span>
<span id="cb50-125"><a href="#cb50-125" aria-hidden="true" tabindex="-1"></a>          axes<span class="sc">$</span>y<span class="sc">$</span>right, <span class="at">t =</span> panel_pos_v, <span class="at">l =</span> panel_pos_h <span class="sc">+</span> <span class="dv">1</span>,</span>
<span id="cb50-126"><a href="#cb50-126" aria-hidden="true" tabindex="-1"></a>          <span class="at">clip =</span> <span class="st">"off"</span>)</span>
<span id="cb50-127"><a href="#cb50-127" aria-hidden="true" tabindex="-1"></a>        panel_table <span class="ot">&lt;-</span> gtable<span class="sc">::</span><span class="fu">gtable_add_cols</span>(panel_table, axis_width_l[<span class="dv">1</span>], panel_pos_h <span class="sc">-</span> <span class="dv">1</span>)</span>
<span id="cb50-128"><a href="#cb50-128" aria-hidden="true" tabindex="-1"></a>        panel_table <span class="ot">&lt;-</span> gtable<span class="sc">::</span><span class="fu">gtable_add_grob</span>(panel_table,</span>
<span id="cb50-129"><a href="#cb50-129" aria-hidden="true" tabindex="-1"></a>          axes<span class="sc">$</span>y<span class="sc">$</span>left, <span class="at">t =</span> panel_pos_v, <span class="at">l =</span> panel_pos_h,</span>
<span id="cb50-130"><a href="#cb50-130" aria-hidden="true" tabindex="-1"></a>          <span class="at">clip =</span> <span class="st">"off"</span>)</span>
<span id="cb50-131"><a href="#cb50-131" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb50-132"><a href="#cb50-132" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-133"><a href="#cb50-133" aria-hidden="true" tabindex="-1"></a>    <span class="do">## Recalculate as gtable has changed</span></span>
<span id="cb50-134"><a href="#cb50-134" aria-hidden="true" tabindex="-1"></a>    panel_pos_h <span class="ot">&lt;-</span> <span class="fu">panel_cols</span>(panel_table)<span class="sc">$</span>l</span>
<span id="cb50-135"><a href="#cb50-135" aria-hidden="true" tabindex="-1"></a>    panel_pos_v <span class="ot">&lt;-</span> <span class="fu">panel_rows</span>(panel_table)<span class="sc">$</span>t</span>
<span id="cb50-136"><a href="#cb50-136" aria-hidden="true" tabindex="-1"></a>    axis_height_t <span class="ot">&lt;-</span> <span class="fu">unit</span>(grid<span class="sc">::</span><span class="fu">convertHeight</span>(</span>
<span id="cb50-137"><a href="#cb50-137" aria-hidden="true" tabindex="-1"></a>      grid<span class="sc">::</span><span class="fu">grobHeight</span>(axes<span class="sc">$</span>x<span class="sc">$</span>top[[<span class="dv">1</span>]]), <span class="st">"cm"</span>, <span class="cn">TRUE</span>), <span class="st">"cm"</span>)</span>
<span id="cb50-138"><a href="#cb50-138" aria-hidden="true" tabindex="-1"></a>    axis_height_b <span class="ot">&lt;-</span> <span class="fu">unit</span>(grid<span class="sc">::</span><span class="fu">convertHeight</span>(</span>
<span id="cb50-139"><a href="#cb50-139" aria-hidden="true" tabindex="-1"></a>      grid<span class="sc">::</span><span class="fu">grobHeight</span>(axes<span class="sc">$</span>x<span class="sc">$</span>bottom[[<span class="dv">1</span>]]), <span class="st">"cm"</span>, <span class="cn">TRUE</span>), <span class="st">"cm"</span>)</span>
<span id="cb50-140"><a href="#cb50-140" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> (i <span class="cf">in</span> <span class="fu">rev</span>(panel_pos_v)) {</span>
<span id="cb50-141"><a href="#cb50-141" aria-hidden="true" tabindex="-1"></a>      panel_table <span class="ot">&lt;-</span> gtable<span class="sc">::</span><span class="fu">gtable_add_rows</span>(panel_table, axis_height_b, i)</span>
<span id="cb50-142"><a href="#cb50-142" aria-hidden="true" tabindex="-1"></a>      panel_table <span class="ot">&lt;-</span> gtable<span class="sc">::</span><span class="fu">gtable_add_grob</span>(panel_table, </span>
<span id="cb50-143"><a href="#cb50-143" aria-hidden="true" tabindex="-1"></a>        <span class="fu">rep</span>(axes<span class="sc">$</span>x<span class="sc">$</span>bottom, <span class="fu">length</span>(panel_pos_h)), <span class="at">t =</span> i <span class="sc">+</span> <span class="dv">1</span>, <span class="at">l =</span> panel_pos_h, </span>
<span id="cb50-144"><a href="#cb50-144" aria-hidden="true" tabindex="-1"></a>        <span class="at">clip =</span> <span class="st">"off"</span>)</span>
<span id="cb50-145"><a href="#cb50-145" aria-hidden="true" tabindex="-1"></a>      panel_table <span class="ot">&lt;-</span> gtable<span class="sc">::</span><span class="fu">gtable_add_rows</span>(panel_table, axis_height_t, i <span class="sc">-</span> <span class="dv">1</span>)</span>
<span id="cb50-146"><a href="#cb50-146" aria-hidden="true" tabindex="-1"></a>      panel_table <span class="ot">&lt;-</span> gtable<span class="sc">::</span><span class="fu">gtable_add_grob</span>(panel_table, </span>
<span id="cb50-147"><a href="#cb50-147" aria-hidden="true" tabindex="-1"></a>        <span class="fu">rep</span>(axes<span class="sc">$</span>x<span class="sc">$</span>top, <span class="fu">length</span>(panel_pos_h)), <span class="at">t =</span> i, <span class="at">l =</span> panel_pos_h, </span>
<span id="cb50-148"><a href="#cb50-148" aria-hidden="true" tabindex="-1"></a>        <span class="at">clip =</span> <span class="st">"off"</span>)</span>
<span id="cb50-149"><a href="#cb50-149" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb50-150"><a href="#cb50-150" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb50-151"><a href="#cb50-151" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Add strips</span></span>
<span id="cb50-152"><a href="#cb50-152" aria-hidden="true" tabindex="-1"></a>    strips <span class="ot">&lt;-</span> <span class="fu">render_strips</span>(</span>
<span id="cb50-153"><a href="#cb50-153" aria-hidden="true" tabindex="-1"></a>      <span class="at">x =</span> <span class="fu">data.frame</span>(<span class="at">name =</span> <span class="fu">c</span>(<span class="st">"Original"</span>, <span class="fu">paste0</span>(<span class="st">"Transformed ("</span>, params<span class="sc">$</span>trans<span class="sc">$</span>name, <span class="st">")"</span>))),</span>
<span id="cb50-154"><a href="#cb50-154" aria-hidden="true" tabindex="-1"></a>      <span class="at">labeller =</span> label_value, <span class="at">theme =</span> theme)</span>
<span id="cb50-155"><a href="#cb50-155" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb50-156"><a href="#cb50-156" aria-hidden="true" tabindex="-1"></a>    panel_pos_h <span class="ot">&lt;-</span> <span class="fu">panel_cols</span>(panel_table)<span class="sc">$</span>l</span>
<span id="cb50-157"><a href="#cb50-157" aria-hidden="true" tabindex="-1"></a>    panel_pos_v <span class="ot">&lt;-</span> <span class="fu">panel_rows</span>(panel_table)<span class="sc">$</span>t</span>
<span id="cb50-158"><a href="#cb50-158" aria-hidden="true" tabindex="-1"></a>    strip_height <span class="ot">&lt;-</span> <span class="fu">unit</span>(grid<span class="sc">::</span><span class="fu">convertHeight</span>(</span>
<span id="cb50-159"><a href="#cb50-159" aria-hidden="true" tabindex="-1"></a>      grid<span class="sc">::</span><span class="fu">grobHeight</span>(strips<span class="sc">$</span>x<span class="sc">$</span>top[[<span class="dv">1</span>]]), <span class="st">"cm"</span>, <span class="cn">TRUE</span>), <span class="st">"cm"</span>)</span>
<span id="cb50-160"><a href="#cb50-160" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> (i <span class="cf">in</span> <span class="fu">rev</span>(<span class="fu">seq_along</span>(panel_pos_v))) {</span>
<span id="cb50-161"><a href="#cb50-161" aria-hidden="true" tabindex="-1"></a>      panel_table <span class="ot">&lt;-</span> gtable<span class="sc">::</span><span class="fu">gtable_add_rows</span>(panel_table, strip_height, panel_pos_v[i] <span class="sc">-</span> <span class="dv">1</span>)</span>
<span id="cb50-162"><a href="#cb50-162" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> (params<span class="sc">$</span>horizontal) {</span>
<span id="cb50-163"><a href="#cb50-163" aria-hidden="true" tabindex="-1"></a>        panel_table <span class="ot">&lt;-</span> gtable<span class="sc">::</span><span class="fu">gtable_add_grob</span>(panel_table, strips<span class="sc">$</span>x<span class="sc">$</span>top, </span>
<span id="cb50-164"><a href="#cb50-164" aria-hidden="true" tabindex="-1"></a>          <span class="at">t =</span> panel_pos_v[i], <span class="at">l =</span> panel_pos_h, <span class="at">clip =</span> <span class="st">"off"</span>)</span>
<span id="cb50-165"><a href="#cb50-165" aria-hidden="true" tabindex="-1"></a>      } <span class="cf">else</span> {</span>
<span id="cb50-166"><a href="#cb50-166" aria-hidden="true" tabindex="-1"></a>        panel_table <span class="ot">&lt;-</span> gtable<span class="sc">::</span><span class="fu">gtable_add_grob</span>(panel_table, strips<span class="sc">$</span>x<span class="sc">$</span>top[i], </span>
<span id="cb50-167"><a href="#cb50-167" aria-hidden="true" tabindex="-1"></a>          <span class="at">t =</span> panel_pos_v[i], <span class="at">l =</span> panel_pos_h, <span class="at">clip =</span> <span class="st">"off"</span>)</span>
<span id="cb50-168"><a href="#cb50-168" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb50-169"><a href="#cb50-169" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb50-170"><a href="#cb50-170" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb50-171"><a href="#cb50-171" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb50-172"><a href="#cb50-172" aria-hidden="true" tabindex="-1"></a>    panel_table</span>
<span id="cb50-173"><a href="#cb50-173" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb50-174"><a href="#cb50-174" aria-hidden="true" tabindex="-1"></a>)</span></code></pre></div><button title="コピー" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<p>As is very apparent, the <code>draw_panel</code> method can become very unwieldy once it begins to take multiple possibilities into account. The fact that we want to support both horizontal and vertical layout leads to a lot of if/else blocks in the above code. In general, this is the big challenge when writing facet extensions so be prepared to be very meticulous when writing these methods.</p>
<p>Enough talk - lets see if our new and powerful faceting extension works:</p>
<div class="cell" data-layout-align="center">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb51"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb51-1"><a href="#cb51-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(mtcars, <span class="fu">aes</span>(<span class="at">x =</span> hp, <span class="at">y =</span> mpg)) <span class="sc">+</span> <span class="fu">geom_point</span>() <span class="sc">+</span> <span class="fu">facet_trans</span>(<span class="st">'sqrt'</span>)</span></code></pre></div><button title="コピー" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="extending-ggplot2_files/figure-html/unnamed-chunk-29-1.png" class="img-fluid quarto-figure quarto-figure-center figure-img" alt="Scatterplot with two panels showing horsepower against miles per gallon for 32 cars. Both panels show the same datapoints. The left panel is titled 'original' and the right panel is titled 'transformed (sqrt)'. On the right panel, the miles per gallon are displayed on a square root transformed scale." width="672"></p>
</figure>
</div>
</div>
</div>
</section>
</section>
<section id="extending-existing-facet-function" class="level2">
<h2 class="anchored" data-anchor-id="extending-existing-facet-function">Extending existing facet function</h2>
<p>As the rendering part of a facet class is often the difficult development step, it is possible to piggyback on the existing faceting classes to achieve a range of new facetings. Below we will subclass <code>facet_wrap()</code> to make a <code>facet_bootstrap()</code> class that splits the input data into a number of panels at random.</p>
<div class="cell" data-layout-align="center">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb52"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb52-1"><a href="#cb52-1" aria-hidden="true" tabindex="-1"></a>facet_bootstrap <span class="ot">&lt;-</span> <span class="cf">function</span>(<span class="at">n =</span> <span class="dv">9</span>, <span class="at">prop =</span> <span class="fl">0.2</span>, <span class="at">nrow =</span> <span class="cn">NULL</span>, <span class="at">ncol =</span> <span class="cn">NULL</span>, </span>
<span id="cb52-2"><a href="#cb52-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">scales =</span> <span class="st">"fixed"</span>, <span class="at">shrink =</span> <span class="cn">TRUE</span>, <span class="at">strip.position =</span> <span class="st">"top"</span>) {</span>
<span id="cb52-3"><a href="#cb52-3" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb52-4"><a href="#cb52-4" aria-hidden="true" tabindex="-1"></a>  facet <span class="ot">&lt;-</span> <span class="fu">facet_wrap</span>(<span class="sc">~</span>.bootstrap, <span class="at">nrow =</span> nrow, <span class="at">ncol =</span> ncol, <span class="at">scales =</span> scales, </span>
<span id="cb52-5"><a href="#cb52-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">shrink =</span> shrink, <span class="at">strip.position =</span> strip.position)</span>
<span id="cb52-6"><a href="#cb52-6" aria-hidden="true" tabindex="-1"></a>  facet<span class="sc">$</span>params<span class="sc">$</span>n <span class="ot">&lt;-</span> n</span>
<span id="cb52-7"><a href="#cb52-7" aria-hidden="true" tabindex="-1"></a>  facet<span class="sc">$</span>params<span class="sc">$</span>prop <span class="ot">&lt;-</span> prop</span>
<span id="cb52-8"><a href="#cb52-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggproto</span>(<span class="cn">NULL</span>, FacetBootstrap,</span>
<span id="cb52-9"><a href="#cb52-9" aria-hidden="true" tabindex="-1"></a>    <span class="at">shrink =</span> shrink,</span>
<span id="cb52-10"><a href="#cb52-10" aria-hidden="true" tabindex="-1"></a>    <span class="at">params =</span> facet<span class="sc">$</span>params</span>
<span id="cb52-11"><a href="#cb52-11" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb52-12"><a href="#cb52-12" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb52-13"><a href="#cb52-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-14"><a href="#cb52-14" aria-hidden="true" tabindex="-1"></a>FacetBootstrap <span class="ot">&lt;-</span> <span class="fu">ggproto</span>(<span class="st">"FacetBootstrap"</span>, FacetWrap,</span>
<span id="cb52-15"><a href="#cb52-15" aria-hidden="true" tabindex="-1"></a>  <span class="at">compute_layout =</span> <span class="cf">function</span>(data, params) {</span>
<span id="cb52-16"><a href="#cb52-16" aria-hidden="true" tabindex="-1"></a>    id <span class="ot">&lt;-</span> <span class="fu">seq_len</span>(params<span class="sc">$</span>n)</span>
<span id="cb52-17"><a href="#cb52-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-18"><a href="#cb52-18" aria-hidden="true" tabindex="-1"></a>    dims <span class="ot">&lt;-</span> <span class="fu">wrap_dims</span>(params<span class="sc">$</span>n, params<span class="sc">$</span>nrow, params<span class="sc">$</span>ncol)</span>
<span id="cb52-19"><a href="#cb52-19" aria-hidden="true" tabindex="-1"></a>    layout <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">PANEL =</span> <span class="fu">factor</span>(id))</span>
<span id="cb52-20"><a href="#cb52-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-21"><a href="#cb52-21" aria-hidden="true" tabindex="-1"></a>    layout<span class="sc">$</span>ROW <span class="ot">&lt;-</span> <span class="fu">as.integer</span>((id <span class="sc">-</span> <span class="dv">1</span>L) <span class="sc">%/%</span> dims[<span class="dv">2</span>] <span class="sc">+</span> <span class="dv">1</span>L)</span>
<span id="cb52-22"><a href="#cb52-22" aria-hidden="true" tabindex="-1"></a>    layout<span class="sc">$</span>COL <span class="ot">&lt;-</span> <span class="fu">as.integer</span>((id <span class="sc">-</span> <span class="dv">1</span>L) <span class="sc">%%</span> dims[<span class="dv">2</span>] <span class="sc">+</span> <span class="dv">1</span>L)</span>
<span id="cb52-23"><a href="#cb52-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-24"><a href="#cb52-24" aria-hidden="true" tabindex="-1"></a>    layout <span class="ot">&lt;-</span> layout[<span class="fu">order</span>(layout<span class="sc">$</span>PANEL), , drop <span class="ot">=</span> <span class="cn">FALSE</span>]</span>
<span id="cb52-25"><a href="#cb52-25" aria-hidden="true" tabindex="-1"></a>    <span class="fu">rownames</span>(layout) <span class="ot">&lt;-</span> <span class="cn">NULL</span></span>
<span id="cb52-26"><a href="#cb52-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-27"><a href="#cb52-27" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Add scale identification</span></span>
<span id="cb52-28"><a href="#cb52-28" aria-hidden="true" tabindex="-1"></a>    layout<span class="sc">$</span>SCALE_X <span class="ot">&lt;-</span> <span class="cf">if</span> (params<span class="sc">$</span>free<span class="sc">$</span>x) id <span class="cf">else</span> <span class="dv">1</span>L</span>
<span id="cb52-29"><a href="#cb52-29" aria-hidden="true" tabindex="-1"></a>    layout<span class="sc">$</span>SCALE_Y <span class="ot">&lt;-</span> <span class="cf">if</span> (params<span class="sc">$</span>free<span class="sc">$</span>y) id <span class="cf">else</span> <span class="dv">1</span>L</span>
<span id="cb52-30"><a href="#cb52-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-31"><a href="#cb52-31" aria-hidden="true" tabindex="-1"></a>    <span class="fu">cbind</span>(layout, <span class="at">.bootstrap =</span> id)</span>
<span id="cb52-32"><a href="#cb52-32" aria-hidden="true" tabindex="-1"></a>  },</span>
<span id="cb52-33"><a href="#cb52-33" aria-hidden="true" tabindex="-1"></a>  <span class="at">map_data =</span> <span class="cf">function</span>(data, layout, params) {</span>
<span id="cb52-34"><a href="#cb52-34" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="fu">is.null</span>(data) <span class="sc">||</span> <span class="fu">nrow</span>(data) <span class="sc">==</span> <span class="dv">0</span>) {</span>
<span id="cb52-35"><a href="#cb52-35" aria-hidden="true" tabindex="-1"></a>      <span class="fu">return</span>(<span class="fu">cbind</span>(data, <span class="at">PANEL =</span> <span class="fu">integer</span>(<span class="dv">0</span>)))</span>
<span id="cb52-36"><a href="#cb52-36" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb52-37"><a href="#cb52-37" aria-hidden="true" tabindex="-1"></a>    n_samples <span class="ot">&lt;-</span> <span class="fu">round</span>(<span class="fu">nrow</span>(data) <span class="sc">*</span> params<span class="sc">$</span>prop)</span>
<span id="cb52-38"><a href="#cb52-38" aria-hidden="true" tabindex="-1"></a>    new_data <span class="ot">&lt;-</span> <span class="fu">lapply</span>(<span class="fu">seq_len</span>(params<span class="sc">$</span>n), <span class="cf">function</span>(i) {</span>
<span id="cb52-39"><a href="#cb52-39" aria-hidden="true" tabindex="-1"></a>      <span class="fu">cbind</span>(data[<span class="fu">sample</span>(<span class="fu">nrow</span>(data), n_samples), , <span class="at">drop =</span> <span class="cn">FALSE</span>], <span class="at">PANEL =</span> i)</span>
<span id="cb52-40"><a href="#cb52-40" aria-hidden="true" tabindex="-1"></a>    })</span>
<span id="cb52-41"><a href="#cb52-41" aria-hidden="true" tabindex="-1"></a>    <span class="fu">do.call</span>(rbind, new_data)</span>
<span id="cb52-42"><a href="#cb52-42" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb52-43"><a href="#cb52-43" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb52-44"><a href="#cb52-44" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-45"><a href="#cb52-45" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(diamonds, <span class="fu">aes</span>(carat, price)) <span class="sc">+</span> </span>
<span id="cb52-46"><a href="#cb52-46" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">alpha =</span> <span class="fl">0.1</span>) <span class="sc">+</span> </span>
<span id="cb52-47"><a href="#cb52-47" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_bootstrap</span>(<span class="at">n =</span> <span class="dv">9</span>, <span class="at">prop =</span> <span class="fl">0.05</span>)</span></code></pre></div><button title="コピー" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="extending-ggplot2_files/figure-html/unnamed-chunk-30-1.png" class="img-fluid quarto-figure quarto-figure-center figure-img" alt="Scatterplot with three-by-three panels showing the weight versus the price of about 10.000 diamonds in every panel. The panels are titled 1 to 9 and show different points, but are visually similar." width="672"></p>
</figure>
</div>
</div>
</div>
<p>What we are doing above is to intercept the <code>compute_layout</code> and <code>map_data</code> methods and instead of dividing the data by a variable we randomly assigns rows to a panel based on the sampling parameters (<code>n</code> determines the number of panels, <code>prop</code> determines the proportion of data in each panel). It is important here that the layout returned by <code>compute_layout</code> is a valid layout for <code>FacetWrap</code> as we are counting on the <code>draw_panel</code> method from <code>FacetWrap</code> to do all the work for us. Thus if you want to subclass FacetWrap or FacetGrid, make sure you understand the nature of their layout specification.</p>
<section id="exercises-2" class="level3">
<h3 class="anchored" data-anchor-id="exercises-2">Exercises</h3>
<ol type="1">
<li>Rewrite FacetTrans to take a vector of transformations and create an additional panel for each transformation.</li>
<li>Based on the FacetWrap implementation rewrite FacetTrans to take the strip.placement theme setting into account.</li>
<li>Think about which caveats there are in FacetBootstrap specifically related to adding multiple layers with the same data.</li>
</ol>
</section>
</section>
<section id="creating-new-guides" class="level2">
<h2 class="anchored" data-anchor-id="creating-new-guides">Creating new guides</h2>
<p>Guides are closely related to scales and aesthetics, so an important part of guides is taking information from the scale and translating it to a graphic. This information is passed around inside guides as a <code>key</code> dataframe. For existing guides, you can glance at what a key contains by using the <code>get_guide_data()</code> function. Typical variables you may see in guides are the aesthetic mapped by the scale, such as the hexadecimal colours in the example below, what those aesthetic represent in the <code>.value</code> column and how they should be labelled in the <code>.label</code> column. Sometimes, the aesthetic is used in computations. To avoid interpreting the values and labels as aesthetics, it is customary to prefix these with <code>.</code>.</p>
<div class="cell" data-layout-align="center">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb53"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb53-1"><a href="#cb53-1" aria-hidden="true" tabindex="-1"></a>p <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(mpg, <span class="fu">aes</span>(displ, hwy, <span class="at">colour =</span> drv)) <span class="sc">+</span></span>
<span id="cb53-2"><a href="#cb53-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>() <span class="sc">+</span></span>
<span id="cb53-3"><a href="#cb53-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_colour_discrete</span>(</span>
<span id="cb53-4"><a href="#cb53-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">labels =</span> <span class="fu">c</span>(<span class="st">"4-wheel drive"</span>, <span class="st">"front wheel drive"</span>, <span class="st">"rear wheel drive"</span>)</span>
<span id="cb53-5"><a href="#cb53-5" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb53-6"><a href="#cb53-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-7"><a href="#cb53-7" aria-hidden="true" tabindex="-1"></a><span class="fu">get_guide_data</span>(p, <span class="st">"colour"</span>)</span></code></pre></div><button title="コピー" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>#&gt;    colour .value            .label
#&gt; 1 #F8766D      4     4-wheel drive
#&gt; 2 #00BA38      f front wheel drive
#&gt; 3 #619CFF      r  rear wheel drive</code></pre>
</div>
</div>
<section id="overriding-scale-extraction" class="level3">
<h3 class="anchored" data-anchor-id="overriding-scale-extraction">Overriding scale extraction</h3>
<p>Let’s now make a first guide extension by adjusting the guide’s key. Axes are most straightforward to extend, because they are the least complicated. We’ll build an axis that accepts custom values for the guide’s <code>key</code>. We can begin by making a custom ggproto class that inherits from the axis guide. An important extension point is the <code>extract_key()</code> method, which determines how break information is transferred from the scale to the guide. In our class, we reject the scale’s reality and substitute our own.</p>
<div class="cell" data-layout-align="center">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb55"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb55-1"><a href="#cb55-1" aria-hidden="true" tabindex="-1"></a>GuideKey <span class="ot">&lt;-</span> <span class="fu">ggproto</span>(</span>
<span id="cb55-2"><a href="#cb55-2" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Guide"</span>, GuideAxis,</span>
<span id="cb55-3"><a href="#cb55-3" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb55-4"><a href="#cb55-4" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Some parameters are required, so it is easiest to copy the base Guide's</span></span>
<span id="cb55-5"><a href="#cb55-5" aria-hidden="true" tabindex="-1"></a>  <span class="co"># parameters into our new parameters.</span></span>
<span id="cb55-6"><a href="#cb55-6" aria-hidden="true" tabindex="-1"></a>  <span class="co"># We add a new 'key' parameter for our own guide.</span></span>
<span id="cb55-7"><a href="#cb55-7" aria-hidden="true" tabindex="-1"></a>  <span class="at">params =</span> <span class="fu">c</span>(GuideAxis<span class="sc">$</span>params, <span class="fu">list</span>(<span class="at">key =</span> <span class="cn">NULL</span>)),</span>
<span id="cb55-8"><a href="#cb55-8" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb55-9"><a href="#cb55-9" aria-hidden="true" tabindex="-1"></a>  <span class="co"># It is important for guides to have a mapped aesthetic with the correct name</span></span>
<span id="cb55-10"><a href="#cb55-10" aria-hidden="true" tabindex="-1"></a>  <span class="at">extract_key =</span> <span class="cf">function</span>(scale, aesthetic, key, ...) {</span>
<span id="cb55-11"><a href="#cb55-11" aria-hidden="true" tabindex="-1"></a>    key<span class="sc">$</span>aesthetic <span class="ot">&lt;-</span> scale<span class="sc">$</span><span class="fu">map</span>(key<span class="sc">$</span>aesthetic)</span>
<span id="cb55-12"><a href="#cb55-12" aria-hidden="true" tabindex="-1"></a>    <span class="fu">names</span>(key)[<span class="fu">names</span>(key) <span class="sc">==</span> <span class="st">"aesthetic"</span>] <span class="ot">&lt;-</span> aesthetic</span>
<span id="cb55-13"><a href="#cb55-13" aria-hidden="true" tabindex="-1"></a>    key</span>
<span id="cb55-14"><a href="#cb55-14" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb55-15"><a href="#cb55-15" aria-hidden="true" tabindex="-1"></a>)</span></code></pre></div><button title="コピー" class="code-copy-button"><i class="bi"></i></button></div>
</div>
</section>
<section id="guide-constructors" class="level3">
<h3 class="anchored" data-anchor-id="guide-constructors">Guide constructors</h3>
<p>Now we can make a guide constructor that creates a custom key to pass along on. The <code>new_guide()</code> function instantiates a new guide with the given parameters. This function automatically rejects any parameters that are not in the class’ <code>params</code> field, so it is important to declare these.</p>
<div class="cell" data-layout-align="center">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb56"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb56-1"><a href="#cb56-1" aria-hidden="true" tabindex="-1"></a>guide_key <span class="ot">&lt;-</span> <span class="cf">function</span>(</span>
<span id="cb56-2"><a href="#cb56-2" aria-hidden="true" tabindex="-1"></a>  aesthetic, <span class="at">value =</span> aesthetic, <span class="at">label =</span> <span class="fu">as.character</span>(aesthetic),</span>
<span id="cb56-3"><a href="#cb56-3" aria-hidden="true" tabindex="-1"></a>  ...,</span>
<span id="cb56-4"><a href="#cb56-4" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Standard guide arguments</span></span>
<span id="cb56-5"><a href="#cb56-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">theme =</span> <span class="cn">NULL</span>, <span class="at">title =</span> <span class="fu">waiver</span>(), <span class="at">order =</span> <span class="dv">0</span>, <span class="at">position =</span> <span class="fu">waiver</span>()</span>
<span id="cb56-6"><a href="#cb56-6" aria-hidden="true" tabindex="-1"></a>) {</span>
<span id="cb56-7"><a href="#cb56-7" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb56-8"><a href="#cb56-8" aria-hidden="true" tabindex="-1"></a>  key <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(aesthetic, <span class="at">.value =</span> value, <span class="at">.label =</span> label, ...)</span>
<span id="cb56-9"><a href="#cb56-9" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb56-10"><a href="#cb56-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">new_guide</span>(</span>
<span id="cb56-11"><a href="#cb56-11" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Arguments passed on to the GuideKey$params field</span></span>
<span id="cb56-12"><a href="#cb56-12" aria-hidden="true" tabindex="-1"></a>    <span class="at">key =</span> key, <span class="at">theme =</span> theme, <span class="at">title =</span> title, <span class="at">order =</span> order, <span class="at">position =</span> position,</span>
<span id="cb56-13"><a href="#cb56-13" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Declare which aesthetics are supported</span></span>
<span id="cb56-14"><a href="#cb56-14" aria-hidden="true" tabindex="-1"></a>    <span class="at">available_aes =</span> <span class="fu">c</span>(<span class="st">"x"</span>, <span class="st">"y"</span>),</span>
<span id="cb56-15"><a href="#cb56-15" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Set the guide class</span></span>
<span id="cb56-16"><a href="#cb56-16" aria-hidden="true" tabindex="-1"></a>    <span class="at">super =</span> GuideKey</span>
<span id="cb56-17"><a href="#cb56-17" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb56-18"><a href="#cb56-18" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div><button title="コピー" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<p>Our new guide can now be used inside the <code>guides()</code> function or as the <code>guide</code> argument in a position scale.</p>
<div class="cell" data-layout-align="center">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb57"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb57-1"><a href="#cb57-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(mpg, <span class="fu">aes</span>(displ, hwy)) <span class="sc">+</span></span>
<span id="cb57-2"><a href="#cb57-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>() <span class="sc">+</span></span>
<span id="cb57-3"><a href="#cb57-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_x_continuous</span>(</span>
<span id="cb57-4"><a href="#cb57-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">guide =</span> <span class="fu">guide_key</span>(<span class="at">aesthetic =</span> <span class="dv">2</span><span class="sc">:</span><span class="dv">6</span> <span class="sc">+</span> <span class="fl">0.5</span>)</span>
<span id="cb57-5"><a href="#cb57-5" aria-hidden="true" tabindex="-1"></a>  )</span></code></pre></div><button title="コピー" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="extending-ggplot2_files/figure-html/key_example-1.png" class="img-fluid quarto-figure quarto-figure-center figure-img" alt="Scatterplot of engine displacement versus highway miles per  gallon. The x-axis axis ticks are at 2.5, 3.5, 4.5, 5.5 and 6.5." width="672"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="custom-drawings" class="level3">
<h3 class="anchored" data-anchor-id="custom-drawings">Custom drawings</h3>
<p>If we are feeling more adventurous, we can also alter they way guides are drawn. The majority of drawing code is in the <code>Guide$build_*()</code> methods, which is all orchestrated by the <code>Guide$draw()</code> method. For derived guides, such as the custom key guide we’re extending here, overriding a <code>Guide$build_*()</code> method should be sufficient. If you are writing a completely novel guide that does not resemble the structure of any existing guide, overriding the <code>Guide$draw()</code> method might be wise.</p>
<p>In this example, we are changing the way the labels are drawn, so we should edit the <code>Guide$build_labels()</code> method. We’ll edit the method so that the labels are drawn with a <code>colour</code> set in the key. In addition to the <code>key</code> and <code>params</code> variable we’ve seen before, we now also have an <code>elements</code> variable, which is a list of precomputed theme elements. We can use the <code>elements$text</code> element to draw a graphical object (grob) in the style of axis text. Perhaps the most finicky thing about drawing guides is that a lot of settings depend on the guide’s <code>position</code> parameter.</p>
<div class="cell" data-layout-align="center">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb58"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb58-1"><a href="#cb58-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Same as before</span></span>
<span id="cb58-2"><a href="#cb58-2" aria-hidden="true" tabindex="-1"></a>GuideKey <span class="ot">&lt;-</span> <span class="fu">ggproto</span>(</span>
<span id="cb58-3"><a href="#cb58-3" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Guide"</span>, GuideAxis,</span>
<span id="cb58-4"><a href="#cb58-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">params =</span> <span class="fu">c</span>(GuideAxis<span class="sc">$</span>params, <span class="fu">list</span>(<span class="at">key =</span> <span class="cn">NULL</span>)),</span>
<span id="cb58-5"><a href="#cb58-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">extract_key =</span> <span class="cf">function</span>(scale, aesthetic, key, ...) {</span>
<span id="cb58-6"><a href="#cb58-6" aria-hidden="true" tabindex="-1"></a>    key<span class="sc">$</span>aesthetic <span class="ot">&lt;-</span> scale<span class="sc">$</span><span class="fu">map</span>(key<span class="sc">$</span>aesthetic)</span>
<span id="cb58-7"><a href="#cb58-7" aria-hidden="true" tabindex="-1"></a>    <span class="fu">names</span>(key)[<span class="fu">names</span>(key) <span class="sc">==</span> <span class="st">"aesthetic"</span>] <span class="ot">&lt;-</span> aesthetic</span>
<span id="cb58-8"><a href="#cb58-8" aria-hidden="true" tabindex="-1"></a>    key</span>
<span id="cb58-9"><a href="#cb58-9" aria-hidden="true" tabindex="-1"></a>  },</span>
<span id="cb58-10"><a href="#cb58-10" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb58-11"><a href="#cb58-11" aria-hidden="true" tabindex="-1"></a>  <span class="co"># New method to draw labels</span></span>
<span id="cb58-12"><a href="#cb58-12" aria-hidden="true" tabindex="-1"></a>  <span class="at">build_labels =</span> <span class="cf">function</span>(key, elements, params) {</span>
<span id="cb58-13"><a href="#cb58-13" aria-hidden="true" tabindex="-1"></a>    position <span class="ot">&lt;-</span> params<span class="sc">$</span>position</span>
<span id="cb58-14"><a href="#cb58-14" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Downstream code expects a list of labels</span></span>
<span id="cb58-15"><a href="#cb58-15" aria-hidden="true" tabindex="-1"></a>    <span class="fu">list</span>(<span class="fu">element_grob</span>(</span>
<span id="cb58-16"><a href="#cb58-16" aria-hidden="true" tabindex="-1"></a>      elements<span class="sc">$</span>text,</span>
<span id="cb58-17"><a href="#cb58-17" aria-hidden="true" tabindex="-1"></a>      <span class="at">label =</span> key<span class="sc">$</span>.label,</span>
<span id="cb58-18"><a href="#cb58-18" aria-hidden="true" tabindex="-1"></a>      <span class="at">x =</span> <span class="cf">switch</span>(position, <span class="at">left =</span> <span class="dv">1</span>, <span class="at">right =</span> <span class="dv">0</span>, key<span class="sc">$</span>x),</span>
<span id="cb58-19"><a href="#cb58-19" aria-hidden="true" tabindex="-1"></a>      <span class="at">y =</span> <span class="cf">switch</span>(position, <span class="at">top =</span> <span class="dv">0</span>, <span class="at">bottom =</span> <span class="dv">1</span>, key<span class="sc">$</span>y),</span>
<span id="cb58-20"><a href="#cb58-20" aria-hidden="true" tabindex="-1"></a>      <span class="at">margin_x =</span> position <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">"left"</span>, <span class="st">"right"</span>),</span>
<span id="cb58-21"><a href="#cb58-21" aria-hidden="true" tabindex="-1"></a>      <span class="at">margin_y =</span> position <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">"top"</span>, <span class="st">"bottom"</span>),</span>
<span id="cb58-22"><a href="#cb58-22" aria-hidden="true" tabindex="-1"></a>      <span class="at">colour =</span> key<span class="sc">$</span>colour</span>
<span id="cb58-23"><a href="#cb58-23" aria-hidden="true" tabindex="-1"></a>    ))</span>
<span id="cb58-24"><a href="#cb58-24" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb58-25"><a href="#cb58-25" aria-hidden="true" tabindex="-1"></a>)</span></code></pre></div><button title="コピー" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<p>Because we are incorporating the <code>...</code> argument to <code>guide_key()</code> in the key, adding a <code>colour</code> column to the key is straightforward. We can check that are guide looks correct in the different positions around the panel.</p>
<div class="cell" data-layout-align="center">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb59"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb59-1"><a href="#cb59-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(mpg, <span class="fu">aes</span>(displ, hwy)) <span class="sc">+</span></span>
<span id="cb59-2"><a href="#cb59-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>() <span class="sc">+</span></span>
<span id="cb59-3"><a href="#cb59-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">guides</span>(</span>
<span id="cb59-4"><a href="#cb59-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> <span class="fu">guide_key</span>(</span>
<span id="cb59-5"><a href="#cb59-5" aria-hidden="true" tabindex="-1"></a>      <span class="at">aesthetic =</span> <span class="dv">2</span><span class="sc">:</span><span class="dv">6</span> <span class="sc">+</span> <span class="fl">0.5</span>,</span>
<span id="cb59-6"><a href="#cb59-6" aria-hidden="true" tabindex="-1"></a>      <span class="at">colour =</span> <span class="fu">c</span>(<span class="st">"red"</span>, <span class="st">"grey"</span>, <span class="st">"red"</span>, <span class="st">"grey"</span>, <span class="st">"red"</span>)</span>
<span id="cb59-7"><a href="#cb59-7" aria-hidden="true" tabindex="-1"></a>    ),</span>
<span id="cb59-8"><a href="#cb59-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">x.sec =</span> <span class="fu">guide_key</span>(</span>
<span id="cb59-9"><a href="#cb59-9" aria-hidden="true" tabindex="-1"></a>      <span class="at">aesthetic =</span> <span class="fu">c</span>(<span class="dv">2</span>, <span class="dv">4</span>, <span class="dv">6</span>), </span>
<span id="cb59-10"><a href="#cb59-10" aria-hidden="true" tabindex="-1"></a>      <span class="at">colour =</span> <span class="fu">c</span>(<span class="st">"tomato"</span>, <span class="st">"limegreen"</span>, <span class="st">"dodgerblue"</span>)</span>
<span id="cb59-11"><a href="#cb59-11" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb59-12"><a href="#cb59-12" aria-hidden="true" tabindex="-1"></a>  )</span></code></pre></div><button title="コピー" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="extending-ggplot2_files/figure-html/key_example_2-1.png" class="img-fluid quarto-figure quarto-figure-center figure-img" alt="Scatterplot of engine displacement versus highway miles per  gallon. There are two x-axes at the bottom and top of the plot. The bottom has labels alternating in red and gray, and the top has red, green and blue labels." width="672"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="exercises-3" class="level3">
<h3 class="anchored" data-anchor-id="exercises-3">Exercises</h3>
<ul>
<li>Extend <code>guide_key()</code> to also pass on <code>family</code>, <code>face</code> and <code>size</code> aesthetics from the key to the labels.</li>
<li>Override the <code>GuideKey$build_ticks()</code> method to also pass on <code>colour</code> and <code>linewidth</code> settings to the tick marks. Looking at <code>Guide$build_ticks()</code> is a good starting point.</li>
<li>Compare <code>GuideKey$extract_key()</code> to <code>Guide$extract_key()</code>. What steps have been skimmed over in the example?</li>
</ul>


</section>
</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
  window.document.addEventListener("DOMContentLoaded", function (event) {
    // Ensure there is a toggle, if there isn't float one in the top right
    if (window.document.querySelector('.quarto-color-scheme-toggle') === null) {
      const a = window.document.createElement('a');
      a.classList.add('top-right');
      a.classList.add('quarto-color-scheme-toggle');
      a.href = "";
      a.onclick = function() { try { window.quartoToggleColorScheme(); } catch {} return false; };
      const i = window.document.createElement("i");
      i.classList.add('bi');
      a.appendChild(i);
      window.document.body.appendChild(a);
    }
    setColorSchemeToggle(hasAlternateSentinel())
    const icon = "";
    const anchorJS = new window.AnchorJS();
    anchorJS.options = {
      placement: 'right',
      icon: icon
    };
    anchorJS.add('.anchored');
    const isCodeAnnotation = (el) => {
      for (const clz of el.classList) {
        if (clz.startsWith('code-annotation-')) {                     
          return true;
        }
      }
      return false;
    }
    const onCopySuccess = function(e) {
      // button target
      const button = e.trigger;
      // don't keep focus
      button.blur();
      // flash "checked"
      button.classList.add('code-copy-button-checked');
      var currentTitle = button.getAttribute("title");
      button.setAttribute("title", "コピーしました");
      let tooltip;
      if (window.bootstrap) {
        button.setAttribute("data-bs-toggle", "tooltip");
        button.setAttribute("data-bs-placement", "left");
        button.setAttribute("data-bs-title", "コピーしました");
        tooltip = new bootstrap.Tooltip(button, 
          { trigger: "manual", 
            customClass: "code-copy-button-tooltip",
            offset: [0, -8]});
        tooltip.show();    
      }
      setTimeout(function() {
        if (tooltip) {
          tooltip.hide();
          button.removeAttribute("data-bs-title");
          button.removeAttribute("data-bs-toggle");
          button.removeAttribute("data-bs-placement");
        }
        button.setAttribute("title", currentTitle);
        button.classList.remove('code-copy-button-checked');
      }, 1000);
      // clear code selection
      e.clearSelection();
    }
    const getTextToCopy = function(trigger) {
      const outerScaffold = trigger.parentElement.cloneNode(true);
      const codeEl = outerScaffold.querySelector('code');
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
    const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
      text: getTextToCopy
    });
    clipboard.on('success', onCopySuccess);
    if (window.document.getElementById('quarto-embedded-source-code-modal')) {
      const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
        text: getTextToCopy,
        container: window.document.getElementById('quarto-embedded-source-code-modal')
      });
      clipboardModal.on('success', onCopySuccess);
    }
      var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
      var mailtoRegex = new RegExp(/^mailto:/);
        var filterRegex = new RegExp("https:\/\/yo5uke\.com");
      var isInternal = (href) => {
          return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
      }
      // Inspect non-navigation links and adorn them if external
     var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
      for (var i=0; i<links.length; i++) {
        const link = links[i];
        if (!isInternal(link.href)) {
          // undo the damage that might have been done by quarto-nav.js in the case of
          // links that we want to consider external
          if (link.dataset.originalHref !== undefined) {
            link.href = link.dataset.originalHref;
          }
            // target, if specified
            link.setAttribute("target", "_blank");
            if (link.getAttribute("rel") === null) {
              link.setAttribute("rel", "noopener");
            }
        }
      }
    function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
      const config = {
        allowHTML: true,
        maxWidth: 500,
        delay: 100,
        arrow: false,
        appendTo: function(el) {
            return el.parentElement;
        },
        interactive: true,
        interactiveBorder: 10,
        theme: 'quarto',
        placement: 'bottom-start',
      };
      if (contentFn) {
        config.content = contentFn;
      }
      if (onTriggerFn) {
        config.onTrigger = onTriggerFn;
      }
      if (onUntriggerFn) {
        config.onUntrigger = onUntriggerFn;
      }
      window.tippy(el, config); 
    }
    const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
    for (var i=0; i<noterefs.length; i++) {
      const ref = noterefs[i];
      tippyHover(ref, function() {
        // use id or data attribute instead here
        let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
        try { href = new URL(href).hash; } catch {}
        const id = href.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note) {
          return note.innerHTML;
        } else {
          return "";
        }
      });
    }
    const xrefs = window.document.querySelectorAll('a.quarto-xref');
    const processXRef = (id, note) => {
      // Strip column container classes
      const stripColumnClz = (el) => {
        el.classList.remove("page-full", "page-columns");
        if (el.children) {
          for (const child of el.children) {
            stripColumnClz(child);
          }
        }
      }
      stripColumnClz(note)
      if (id === null || id.startsWith('sec-')) {
        // Special case sections, only their first couple elements
        const container = document.createElement("div");
        if (note.children && note.children.length > 2) {
          container.appendChild(note.children[0].cloneNode(true));
          for (let i = 1; i < note.children.length; i++) {
            const child = note.children[i];
            if (child.tagName === "P" && child.innerText === "") {
              continue;
            } else {
              container.appendChild(child.cloneNode(true));
              break;
            }
          }
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(container);
          }
          return container.innerHTML
        } else {
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(note);
          }
          return note.innerHTML;
        }
      } else {
        // Remove any anchor links if they are present
        const anchorLink = note.querySelector('a.anchorjs-link');
        if (anchorLink) {
          anchorLink.remove();
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        if (note.classList.contains("callout")) {
          return note.outerHTML;
        } else {
          return note.innerHTML;
        }
      }
    }
    for (var i=0; i<xrefs.length; i++) {
      const xref = xrefs[i];
      tippyHover(xref, undefined, function(instance) {
        instance.disable();
        let url = xref.getAttribute('href');
        let hash = undefined; 
        if (url.startsWith('#')) {
          hash = url;
        } else {
          try { hash = new URL(url).hash; } catch {}
        }
        if (hash) {
          const id = hash.replace(/^#\/?/, "");
          const note = window.document.getElementById(id);
          if (note !== null) {
            try {
              const html = processXRef(id, note.cloneNode(true));
              instance.setContent(html);
            } finally {
              instance.enable();
              instance.show();
            }
          } else {
            // See if we can fetch this
            fetch(url.split('#')[0])
            .then(res => res.text())
            .then(html => {
              const parser = new DOMParser();
              const htmlDoc = parser.parseFromString(html, "text/html");
              const note = htmlDoc.getElementById(id);
              if (note !== null) {
                const html = processXRef(id, note);
                instance.setContent(html);
              } 
            }).finally(() => {
              instance.enable();
              instance.show();
            });
          }
        } else {
          // See if we can fetch a full url (with no hash to target)
          // This is a special case and we should probably do some content thinning / targeting
          fetch(url)
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.querySelector('main.content');
            if (note !== null) {
              // This should only happen for chapter cross references
              // (since there is no id in the URL)
              // remove the first header
              if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
                note.children[0].remove();
              }
              const html = processXRef(null, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      }, function(instance) {
      });
    }
        let selectedAnnoteEl;
        const selectorForAnnotation = ( cell, annotation) => {
          let cellAttr = 'data-code-cell="' + cell + '"';
          let lineAttr = 'data-code-annotation="' +  annotation + '"';
          const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
          return selector;
        }
        const selectCodeLines = (annoteEl) => {
          const doc = window.document;
          const targetCell = annoteEl.getAttribute("data-target-cell");
          const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
          const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
          const lines = annoteSpan.getAttribute("data-code-lines").split(",");
          const lineIds = lines.map((line) => {
            return targetCell + "-" + line;
          })
          let top = null;
          let height = null;
          let parent = null;
          if (lineIds.length > 0) {
              //compute the position of the single el (top and bottom and make a div)
              const el = window.document.getElementById(lineIds[0]);
              top = el.offsetTop;
              height = el.offsetHeight;
              parent = el.parentElement.parentElement;
            if (lineIds.length > 1) {
              const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
              const bottom = lastEl.offsetTop + lastEl.offsetHeight;
              height = bottom - top;
            }
            if (top !== null && height !== null && parent !== null) {
              // cook up a div (if necessary) and position it 
              let div = window.document.getElementById("code-annotation-line-highlight");
              if (div === null) {
                div = window.document.createElement("div");
                div.setAttribute("id", "code-annotation-line-highlight");
                div.style.position = 'absolute';
                parent.appendChild(div);
              }
              div.style.top = top - 2 + "px";
              div.style.height = height + 4 + "px";
              div.style.left = 0;
              let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
              if (gutterDiv === null) {
                gutterDiv = window.document.createElement("div");
                gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
                gutterDiv.style.position = 'absolute';
                const codeCell = window.document.getElementById(targetCell);
                const gutter = codeCell.querySelector('.code-annotation-gutter');
                gutter.appendChild(gutterDiv);
              }
              gutterDiv.style.top = top - 2 + "px";
              gutterDiv.style.height = height + 4 + "px";
            }
            selectedAnnoteEl = annoteEl;
          }
        };
        const unselectCodeLines = () => {
          const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
          elementsIds.forEach((elId) => {
            const div = window.document.getElementById(elId);
            if (div) {
              div.remove();
            }
          });
          selectedAnnoteEl = undefined;
        };
          // Handle positioning of the toggle
      window.addEventListener(
        "resize",
        throttle(() => {
          elRect = undefined;
          if (selectedAnnoteEl) {
            selectCodeLines(selectedAnnoteEl);
          }
        }, 10)
      );
      function throttle(fn, ms) {
      let throttle = false;
      let timer;
        return (...args) => {
          if(!throttle) { // first call gets through
              fn.apply(this, args);
              throttle = true;
          } else { // all the others get throttled
              if(timer) clearTimeout(timer); // cancel #2
              timer = setTimeout(() => {
                fn.apply(this, args);
                timer = throttle = false;
              }, ms);
          }
        };
      }
        // Attach click handler to the DT
        const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
        for (const annoteDlNode of annoteDls) {
          annoteDlNode.addEventListener('click', (event) => {
            const clickedEl = event.target;
            if (clickedEl !== selectedAnnoteEl) {
              unselectCodeLines();
              const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
              if (activeEl) {
                activeEl.classList.remove('code-annotation-active');
              }
              selectCodeLines(clickedEl);
              clickedEl.classList.add('code-annotation-active');
            } else {
              // Unselect the line
              unselectCodeLines();
              clickedEl.classList.remove('code-annotation-active');
            }
          });
        }
    const findCites = (el) => {
      const parentEl = el.parentElement;
      if (parentEl) {
        const cites = parentEl.dataset.cites;
        if (cites) {
          return {
            el,
            cites: cites.split(' ')
          };
        } else {
          return findCites(el.parentElement)
        }
      } else {
        return undefined;
      }
    };
    var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
    for (var i=0; i<bibliorefs.length; i++) {
      const ref = bibliorefs[i];
      const citeInfo = findCites(ref);
      if (citeInfo) {
        tippyHover(citeInfo.el, function() {
          var popup = window.document.createElement('div');
          citeInfo.cites.forEach(function(cite) {
            var citeDiv = window.document.createElement('div');
            citeDiv.classList.add('hanging-indent');
            citeDiv.classList.add('csl-entry');
            var biblioDiv = window.document.getElementById('ref-' + cite);
            if (biblioDiv) {
              citeDiv.innerHTML = biblioDiv.innerHTML;
            }
            popup.appendChild(citeDiv);
          });
          return popup.innerHTML;
        });
      }
    }
  });
  </script>
</div> <!-- /content -->
<footer class="footer">
  <div class="nav-footer">
    <div class="nav-footer-left">
<p>© 2024-2025 Yosuke Abe <br> Content on this site is licensed under a <br> <i class="fa-brands fa-creative-commons" aria-label="creative-commons"></i> <i class="fa-brands fa-creative-commons-by" aria-label="creative-commons-by"></i> <i class="fa-brands fa-creative-commons-sa" aria-label="creative-commons-sa"></i> <a href="https://creativecommons.org/licenses/by-sa/4.0/">Creative Commons BY-SA 4.0</a></p>
</div>   
    <div class="nav-footer-center">
      <ul class="footer-items list-unstyled">
    <li class="nav-item compact">
    <a class="nav-link" href="https://x.com/5uke_y">
      <i class="bi bi-twitter-x" role="img">
</i> 
    </a>
  </li>  
    <li class="nav-item compact">
    <a class="nav-link" href="../../../../../../../pages/tips/index.xml">
      <i class="bi bi-rss" role="img">
</i> 
    </a>
  </li>  
</ul>
    </div>
    <div class="nav-footer-right">
<p>This website is created with <i class="fa-brands fa-r-project" aria-label="r-project"></i> and <iconify-icon role="img" inline="" icon="simple-icons:quarto" style="color:#74aadb;" aria-label="Quarto icon" title="Quarto icon"></iconify-icon> <a href="https://quarto.org">Quarto</a> <br> <i class="fa-brands fa-github" aria-label="github"></i> <a href="https://github.com/yo5uke/yo5uke.github.io">Source code</a> <br> <i class="fa-solid fa-location-dot" aria-label="location-dot"></i> <a href="https://maps.app.goo.gl/XFHvBiCdkQK4YXku9">Yokohama</a>, Kanagawa, Japan</p>
</div>
  </div>
</footer>




</body></html>