<?xml version="1.0" encoding="UTF-8"?>
<rss  xmlns:atom="http://www.w3.org/2005/Atom" 
      xmlns:media="http://search.yahoo.com/mrss/" 
      xmlns:content="http://purl.org/rss/1.0/modules/content/" 
      xmlns:dc="http://purl.org/dc/elements/1.1/" 
      version="2.0">
<channel>
<title>Yosuke Abe</title>
<link>https://yo5uke.com/pages/tips/</link>
<atom:link href="https://yo5uke.com/pages/tips/index.xml" rel="self" type="application/rss+xml"/>
<description></description>
<generator>quarto-1.9.8</generator>
<lastBuildDate>Sat, 25 Oct 2025 15:00:00 GMT</lastBuildDate>
<item>
  <title>Typst 入門</title>
  <link>https://yo5uke.com/pages/tips/251026_typst/</link>
  <description><![CDATA[ 

<div class="social-share-buttons">

  <!-- Twitter (X) -->

  <a href="" id="js-share-twitter" class="share_button ri--twitter-x-fill" target="_blank" rel="nofollow noopener noreferrer"></a>



  <!-- Bluesky -->

  <a href="" id="js-share-bluesky" class="share_button ri--bluesky-fill" target="_blank" rel="nofollow noopener noreferrer"></a>

</div>



<script>

  const twitterUsername = "@5uke_y";

  const blueskyUsername = "@5uke.bsky.social";



  const share_url = encodeURIComponent(location.href);

  const share_title = document.title;



  // Twitter (X)

  document.getElementById('js-share-twitter').setAttribute(

    "href",

    "https://twitter.com/share?url=" + share_url + "&text=" + share_title + " " + encodeURIComponent(twitterUsername) + " より" +

    "&hashtags=rstats"

  );



  // Bluesky

  document.getElementById('js-share-bluesky').setAttribute(

    "href",

    "https://bsky.app/intent/compose?text=" + share_title + " " + share_url + " " + encodeURIComponent(blueskyUsername) + " より"

  );

</script>






<section id="はじめに" class="level2">
<h2 class="anchored" data-anchor-id="はじめに">はじめに</h2>
<p>皆さん、Typstをご存知でしょうか？<br>
Typstは、LaTeXにも代わりうる新しい組版システムで、美しいドキュメントを（比較的）簡単に作成できることができます。<br>
Typstは、シンプルで直感的な構文を持ち、リアルタイムプレビュー機能も備えているため、初心者でも扱いやすいのが特徴です。</p>
<p>これまでの僕の記事では、LaTeXを中心にドキュメント作成の方法を紹介してきましたが、Typstも非常に魅力的な選択肢です。<br>
ローカルで環境を整えるというのはインターネット環境に左右されないという利点を強調してきた一方で、実際問題それほど問題になるケースが少なく、オンラインエディタで文書を作成するというのも十分に実用的です。</p>
<p>TypstはOverleafのような<strong>オンラインエディタを提供</strong>しており、なおかつ<strong>リアルタイムプレビューも備えている</strong>ため、LaTeXのようにコンパイルを待つことなく書いた内容を確認することができます。</p>
<p>この記事では、Typstの基本的な使い方を紹介します。<br>
書き方がLaTeXとは異なるので最初は戸惑うかもしれませんが、慣れれば非常に便利ですので、ぜひ試してみてください。</p>
</section>
<section id="typstの準備" class="level2">
<h2 class="anchored" data-anchor-id="typstの準備">Typstの準備</h2>
<p>Typstは<strong>ローカルにインストールする必要がなく、オンラインエディタで直接ドキュメントを作成できます</strong>。</p>
<ol type="1">
<li><a href="https://typst.app/">Typst</a>にアクセスし、アカウントを作成します。
<ul>
<li>初めてであればSign Upからアカウントを作成してください。</li>
</ul></li>
<li>ログイン後、ダッシュボードから「Empty document」をクリックして新しいドキュメントを作成します。</li>
</ol>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://yo5uke.com/pages/tips/251026_typst/image/typst_dashboard.png" class="img-fluid figure-img"></p>
<figcaption>Typstのダッシュボード</figcaption>
</figure>
</div>
<ol start="3" type="1">
<li>ドキュメントエディタが開きます。ここでTypstのコードを記述します。
<ul>
<li>ファイルの拡張子は<code>.typ</code>です。</li>
</ul></li>
</ol>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://yo5uke.com/pages/tips/251026_typst/image/typst_editor.png" class="img-fluid figure-img"></p>
<figcaption>Typstのドキュメントエディタ</figcaption>
</figure>
</div>
</section>
<section id="typstの基本的な書き方" class="level2">
<h2 class="anchored" data-anchor-id="typstの基本的な書き方">Typstの基本的な書き方</h2>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
<span class="screen-reader-only">Note</span>今回の方針
</div>
</div>
<div class="callout-body-container callout-body">
<p>今回は僕が作成したTypstテンプレートを使いながら説明します。経済学論文向けのテンプレートを作成しており、最低限の設定はテンプレート内で済ませていますが、もっと根本的に学びたい方は<a href="https://typst.app/docs/">Typstの公式ドキュメント</a>を参照してください。</p>
</div>
</div>
<p>Typstの基本的な書き方をいくつか紹介します。<br>
最初はややこしいかもしれませんが、慣れてしまえばLaTeXよりもシンプルだと思いますので、ぜひ挑戦してみてください。</p>
<section id="エディタを開く" class="level3">
<h3 class="anchored" data-anchor-id="エディタを開く">エディタを開く</h3>
<p><a href="https://typst.app/">オンラインエディタ</a>を開き、新しいドキュメントを作成します。</p>
</section>
<section id="テンプレートの準備" class="level3">
<h3 class="anchored" data-anchor-id="テンプレートの準備">テンプレートの準備</h3>
<p>今回は僕が作成したTypstテンプレートを使いますので、以下の2ファイルをダウンロードするか、GitHubからご利用ください。</p>
<ul>
<li><a href="../../..\data/251027_typst/template.typ" download="template.typ">template.typ</a></li>
<li><a href="../../..\data/251027_typst/chicago-author-date.csl" download="chicago_author_date.csl">chicago_author_date.csl</a></li>
<li><a href="https://github.com/yo5uke/typst_econ_template">GitHubリポジトリ</a></li>
</ul>
<p>2つのファイルを準備できたら、Typstのエディタにアップロードします。サイドバーの「･･･」メニューから「Upload a new file」を選択してアップロードするか、ドラッグアンドドロップでアップロードします。<br>
<code>template.typ</code>と<code>chicago_author_date.csl</code>が表示されている状態でスタートします。</p>
</section>
<section id="表紙" class="level3">
<h3 class="anchored" data-anchor-id="表紙">表紙</h3>
<p>まずは基本となる表紙の作成から始めます。表紙のイメージは以下です。</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://yo5uke.com/pages/tips/251026_typst/image/hyoshi.png" class="img-fluid figure-img" style="width:50.0%"></p>
<figcaption>Typstで作成した表紙の例</figcaption>
</figure>
</div>
<p>これを目指していきたいと思います。</p>
<ol type="1">
<li>サイドバーの <i class="fa-solid fa-file" aria-label="file"></i> アイコンから新規ファイルを作成します。
<ul>
<li>ファイル名は<code>main.typ</code>としますが、任意の名前で構いません。</li>
</ul></li>
<li><code>main.typ</code>に以下のコードを記述します。</li>
</ol>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb1" style="background: #f1f3f5;"><pre class="sourceCode typst code-with-copy"><code class="sourceCode typst"><span id="cb1-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">#</span><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"template.typ"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span> article</span></code></pre></div></div>
<p>これは<code>template.typ</code>から<code>article</code>コンポーネントをインポートするコードです。この<code>article</code>に表紙の設定が含まれています。<br>
今回は設定は既定のまま使用しますが、<code>template.typ</code>内の<code>article</code>コンポーネントを編集することで、諸々の細かい点を調整できます。</p>
<ol start="3" type="1">
<li>次に、表紙の内容を記述します。<code>main.typ</code>に以下のコードを追加します。</li>
</ol>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb2" style="background: #f1f3f5;"><pre class="sourceCode typst code-with-copy"><code class="sourceCode typst"><span id="cb2-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">#show</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span> article<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>with<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span></span>
<span id="cb2-2">  title<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>Minimal Article Template (Test)<span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">#</span>footnote<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">#</span>lorem<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">150</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)]],</span></span>
<span id="cb2-3">  authors<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span></span>
<span id="cb2-4">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span></span>
<span id="cb2-5">      name: <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Yosuke Abe"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb2-6">      affiliation: <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Example University"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb2-7">      email: <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"yosuke.abe0507@gmail.com"</span></span>
<span id="cb2-8">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">),</span></span>
<span id="cb2-9">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span></span>
<span id="cb2-10">      name: <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Taro Yamada"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb2-11">      affiliation: <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Example University"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb2-12">      email: <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"taro@example.jp"</span></span>
<span id="cb2-13">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span></span>
<span id="cb2-14">  <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">),</span></span>
<span id="cb2-15">  date<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span> datetime<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>today<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">().</span>display<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"[month repr:long] [day], [year]"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">),</span></span>
<span id="cb2-16">  abstract<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span></span>
<span id="cb2-17">    <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">#</span>lorem<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">150</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span></span>
<span id="cb2-18">  <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">],</span></span>
<span id="cb2-19">  jel-codes<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span></span>
<span id="cb2-20">    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"A1"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb2-21">    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"A2"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb2-22">    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"A3"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb2-23">    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"A4"</span></span>
<span id="cb2-24">  <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">),</span></span>
<span id="cb2-25">  keywords<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span></span>
<span id="cb2-26">    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Keyword 1"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb2-27">    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Keyword 2"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb2-28">    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Keyword 3"</span></span>
<span id="cb2-29">  <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span></span>
<span id="cb2-30"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span></span></code></pre></div></div>
<p><code>#show: article.with(...)</code>は、<code>article</code>コンポーネントを表示するためのコードです。<br>
<code>title</code>、<code>authors</code>、<code>date</code>、<code>abstract</code>、<code>jel-codes</code>、<code>keywords</code>などの引数を指定して、表紙の内容を設定します。<br>
<code>tiele</code>には<code>#footnote[...]</code>を使って脚注を追加しています。謝辞を入れたい場合などに便利です。<br>
著者は1人でも構いませんし、3人まで対応しています。また、<code>jel-codes</code>や<code>keywords</code>も任意です。<br>
<code>date</code>は現在の日付を自動的に取得して表示します。文字列で直接指定することも可能です。<br>
<code>abstract</code>内の<code>#lorem(150)</code>はダミーテキストを生成する関数ですので、実際の文章に置き換えてください。</p>
<p>Typstはコンパイルが要りませんから、コードを記述するとリアルタイムでプレビューが表示されます。上の設定で先ほどの表紙が表示されるはずです<sup>1</sup>。</p>
</section>
<section id="本文" class="level3">
<h3 class="anchored" data-anchor-id="本文">本文</h3>
<p>次に本文を追加します。</p>
<p>先に完成イメージを共有しておきます。</p>
<p><a href="../../..\data/251027_typst/sample.pdf">テンプレートを使って作成したサンプル文書（PDF）</a></p>
<p>ここからは基本的な書き方を紹介します。ここからの内容は今回のテンプレートに限らずTypst全般に共通する内容です！Updated the description for Typst and corrected the date.</p>
<section id="セクション" class="level4">
<h4 class="anchored" data-anchor-id="セクション">セクション</h4>
<p>セクションは<code>=</code>を使って作成し、サブセクションは<code>==</code>というようにイコールの数で階層を表現します<sup>2</sup>。</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb3" style="background: #f1f3f5;"><pre class="sourceCode typst code-with-copy"><code class="sourceCode typst"><span id="cb3-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">= セクション1</span></span>
<span id="cb3-2"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">== サブセクション1.1</span></span></code></pre></div></div>
<p>ちなみに今回の設定ではセクション番号が表示されるようになっているので、「1 セクション1」のように自動的に番号が振られます。</p>
</section>
<section id="段落" class="level4">
<h4 class="anchored" data-anchor-id="段落">段落</h4>
<p>段落を改める場合、2通りの方法が使えます。</p>
<ol type="1">
<li>空行を挟む</li>
</ol>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb4" style="background: #f1f3f5;"><pre class="sourceCode typst code-with-copy"><code class="sourceCode typst"><span id="cb4-1">これは1つ目の段落です。</span>
<span id="cb4-2"></span>
<span id="cb4-3">これは2つ目の段落です。</span></code></pre></div></div>
<ol start="2" type="1">
<li>バックスラッシュを使う</li>
</ol>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb5" style="background: #f1f3f5;"><pre class="sourceCode typst code-with-copy"><code class="sourceCode typst"><span id="cb5-1">これは1つ目の段落です。<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">\</span></span>
<span id="cb5-2">これは2つ目の段落です。</span></code></pre></div></div>
<p>この場合は空行を入れなくても段落が分かれます。</p>
</section>
<section id="強調" class="level4">
<h4 class="anchored" data-anchor-id="強調">強調</h4>
<p>強調したい部分は<code>*</code>で囲みます。</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb6" style="background: #f1f3f5;"><pre class="sourceCode typst code-with-copy"><code class="sourceCode typst"><span id="cb6-1">これは*強調*されたテキストです。</span></code></pre></div></div>
<p>また、イタリック体にしたい場合は<code>_</code>で囲みます。</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb7" style="background: #f1f3f5;"><pre class="sourceCode typst code-with-copy"><code class="sourceCode typst"><span id="cb7-1">これは_イタリック体_のテキストです。</span></code></pre></div></div>
</section>
<section id="箇条書き" class="level4">
<h4 class="anchored" data-anchor-id="箇条書き">箇条書き</h4>
<p>箇条書きは<code>-</code>を使って作成します。</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb8" style="background: #f1f3f5;"><pre class="sourceCode typst code-with-copy"><code class="sourceCode typst"><span id="cb8-1">- アイテム1</span>
<span id="cb8-2">- アイテム2</span>
<span id="cb8-3">  - サブアイテム2.1</span>
<span id="cb8-4">  - サブアイテム2.2</span></code></pre></div></div>
</section>
<section id="番号付きリスト" class="level4">
<h4 class="anchored" data-anchor-id="番号付きリスト">番号付きリスト</h4>
<p>番号付きリストは<code>1.</code>を使って作成します。</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb9" style="background: #f1f3f5;"><pre class="sourceCode typst code-with-copy"><code class="sourceCode typst"><span id="cb9-1">1. アイテム1</span>
<span id="cb9-2">2. アイテム2</span></code></pre></div></div>
</section>
<section id="数式" class="level4">
<h4 class="anchored" data-anchor-id="数式">数式</h4>
<p><code>$...$</code>で囲むことでインライン数式を作成できます。</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb10" style="background: #f1f3f5;"><pre class="sourceCode typst code-with-copy"><code class="sourceCode typst"><span id="cb10-1">これはインライン数式の例です：<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">$E=mc^2$</span>。</span></code></pre></div></div>
<p>ブロック数式は同じく<code>$...$</code>で囲みますが、改行をしてください。</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb11" style="background: #f1f3f5;"><pre class="sourceCode typst code-with-copy"><code class="sourceCode typst"><span id="cb11-1"><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">$</span></span>
<span id="cb11-2"><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">E = m c^2</span></span>
<span id="cb11-3"><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">$</span></span></code></pre></div></div>
<p>文字を並べる場合にはスペースを空けてください。<code>mc^2</code>と詰めて書くと表示されなくなってしまいます。</p>
</section>
<section id="図の挿入" class="level4">
<h4 class="anchored" data-anchor-id="図の挿入">図の挿入</h4>
<p>図は<code>#figure(...)</code>を使って挿入します。</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb12" style="background: #f1f3f5;"><pre class="sourceCode typst code-with-copy"><code class="sourceCode typst"><span id="cb12-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">#</span>figure<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span></span>
<span id="cb12-2">  image<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span></span>
<span id="cb12-3">    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"path_to_image.png"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb12-4">    width<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">30%</span></span>
<span id="cb12-5">  <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">),</span></span>
<span id="cb12-6">  caption<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>これは図のキャプションです。<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">]</span></span>
<span id="cb12-7"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">&lt;my-fig&gt;</span></span></code></pre></div></div>
<p><code>#figure(...)</code>内で<code>image(...)</code>を使って画像を指定し、<code>caption</code>引数でキャプションを設定します。<code>width</code>引数で画像の幅を指定できます。<br>
また、<code>&lt;my-fig&gt;</code>のように任意のラベルを付けることで、後で参照することができます。文書内で引用したい場合は<code>@my-fig</code>と書きます。</p>
</section>
<section id="表の挿入" class="level4">
<h4 class="anchored" data-anchor-id="表の挿入">表の挿入</h4>
<p>表は<code>#figure(...)</code>内で<code>table(...)</code>を使って挿入します。</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb13" style="background: #f1f3f5;"><pre class="sourceCode typst code-with-copy"><code class="sourceCode typst"><span id="cb13-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">#</span>figure<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span></span>
<span id="cb13-2">  table<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span></span>
<span id="cb13-3">    columns<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">12</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb13-4">    align<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>left<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> right<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> right<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> right<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> right<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> right<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> right<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> right<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> right<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> right<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> right<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> right<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">),</span></span>
<span id="cb13-5">    table<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>hline<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(),</span></span>
<span id="cb13-6">    table<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>header<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>repeat<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">true</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb13-7">      <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>model<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">],</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>mpg<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">],</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>cyl<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">],</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>disp<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">],</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>hp<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">],</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>drat<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">],</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>wt<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">],</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>qsec<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">],</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>vs<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">],</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>am<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">],</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>gear<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">],</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>carb<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">],</span></span>
<span id="cb13-8">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">),</span></span>
<span id="cb13-9">    table<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>hline<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(),</span></span>
<span id="cb13-10">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>Mazda RX4<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">],</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>21.0<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">],</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>6<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">],</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>160<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">],</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>110<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">],</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>3.90<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">],</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>2.620<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">],</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>16.46<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">],</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>0<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">],</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>1<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">],</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>4<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">],</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>4<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">],</span></span>
<span id="cb13-11">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>Mazda RX4 Wag<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">],</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>21.0<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">],</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>6<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">],</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>160<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">],</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>110<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">],</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>3.90<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">],</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>2.875<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">],</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>17.02<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">],</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>0<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">],</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>1<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">],</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>4<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">],</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>4<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">],</span></span>
<span id="cb13-12">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>Datsun 710<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">],</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>22.8<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">],</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>4<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">],</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>108<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">],</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>93<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">],</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>3.85<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">],</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>2.320<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">],</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>18.61<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">],</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>1<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">],</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>1<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">],</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>4<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">],</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>1<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">],</span></span>
<span id="cb13-13">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>Hornet 4 Drive<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">],</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>21.4<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">],</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>6<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">],</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>258<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">],</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>110<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">],</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>3.08<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">],</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>3.215<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">],</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>19.44<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">],</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>1<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">],</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>0<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">],</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>3<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">],</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>1<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">],</span></span>
<span id="cb13-14">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>Hornet Sportabout<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">],</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>18.7<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">],</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>8<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">],</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>360<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">],</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>175<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">],</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>3.15<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">],</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>3.440<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">],</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>17.02<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">],</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>0<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">],</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>0<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">],</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>3<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">],</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>2<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">],</span></span>
<span id="cb13-15">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>Valiant<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">],</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>18.1<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">],</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>6<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">],</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>225<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">],</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>105<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">],</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>2.76<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">],</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>3.460<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">],</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>20.22<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">],</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>1<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">],</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>0<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">],</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>3<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">],</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>1<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">],</span></span>
<span id="cb13-16">    table<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>hline<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(),</span></span>
<span id="cb13-17">    table<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>footer<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>repeat<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">false</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb13-18">      table<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>cell<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>align<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span> left<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> colspan<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">12</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb13-19">        text<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">([</span></span>
<span id="cb13-20">          <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">#</span>text<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>style<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"italic"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)[</span>Note:<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">]</span> This table shows the first few rows of the mtcars dataset.</span>
<span id="cb13-21">        <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">])</span></span>
<span id="cb13-22">      <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">),</span></span>
<span id="cb13-23">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">),</span></span>
<span id="cb13-24">  <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">),</span></span>
<span id="cb13-25">  caption<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>mtcars data<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">],</span></span>
<span id="cb13-26"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">&lt;mtcars&gt;</span></span></code></pre></div></div>
<p><code>table(...)</code>内で列数や配置、ヘッダー、フッター、データ行を指定します。<br>
<code>columns</code>引数で列数を指定し、<code>align</code>引数で各列の配置を設定します。<br>
<code>table.header(...)</code>でヘッダー行を、<code>table.footer(...)</code>でフッター行を設定します。フッターは複雑ですが、<code>colspan</code>とフッター文をうまく変えながら調整してください。<br>
データ行はカンマ区切りで各セルの内容を指定します。<br>
表も図と同様に<code>&lt;mtcars&gt;</code>のようにラベルを付けることができ、<code>@mtcars</code>で参照できます。</p>
<p>表の設定は少々ややこしいのですが、Rで作った表をTypstで出力するというのが1つ手としてあるかと思います。<br>
今回はその方法については書きませんが、必要であれば調べてみてください。</p>
<p>また、Typstの公式ドキュメントのページも参考にしてみてください。</p>
<div class="callout callout-style-simple callout-tip no-icon">
<div class="callout-body d-flex">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-body-container">
<p><a href="https://typst.app/docs/reference/model/table/">Table Function - Typst Documentation</a></p>
</div>
</div>
</div>
</section>
<section id="脚注" class="level4">
<h4 class="anchored" data-anchor-id="脚注">脚注</h4>
<p>脚注は<code>#footnote[...]</code>を使って挿入します。表紙でも挿入していましたが、本文中でも同様に使えます。</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb14" style="background: #f1f3f5;"><pre class="sourceCode typst code-with-copy"><code class="sourceCode typst"><span id="cb14-1">これは脚注の例です<span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">#</span>footnote<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>これは脚注の内容です。<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">]</span>。</span></code></pre></div></div>
</section>
<section id="引用文献" class="level4">
<h4 class="anchored" data-anchor-id="引用文献">引用文献</h4>
<p>引用文献は<code>#bibliography(...)</code>を使って挿入します。セクションタイトルも「References」と自動的に追加されるようにしてありますので、参考文献を挿入したい場所に以下のコードを追加します。</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb15" style="background: #f1f3f5;"><pre class="sourceCode typst code-with-copy"><code class="sourceCode typst"><span id="cb15-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">#</span>bibliography<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"references.bib"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span></span></code></pre></div></div>
<p><code>references.bib</code>はBibTeX形式の文献データファイルです。自分で用意した<code>.bib</code>ファイルをアップロードして指定してください。</p>
<p>文中で引用したい場合は、<code>#cite(&lt;notsu_indirect_2025&gt;, form: "prose")</code>のように書きます。<code>&lt;notsu_indirect_2025&gt;</code>は<code>.bib</code>ファイル内で指定したラベルです。<code>form: "prose"</code>は引用形式を指定するオプションで、省略可能です。この設定だと</p>
<blockquote class="blockquote">
<p>Notsu et al.&nbsp;(2025)</p>
</blockquote>
<p>のように表示されます。</p>
<blockquote class="blockquote">
<p>(Notsu et al., 2025)</p>
</blockquote>
<p>のように表示したい場合は<code>@notsu_indirect_2025</code>のように書きます。こちらは楽でいいですね。<br>
2つ以上並べたい場合は<code>@notsu_indirect_2025 @martinez_how_2022</code>のようにスペースで区切ってください。</p>
<p>引用スタイルは<code>template.typ</code>内で<code>chicago_author_date.csl</code>を指定しています。別のスタイルに変更したい場合は、他のCSLファイルをダウンロードしてアップロードし、<code>template.typ</code>内の該当部分を書き換えてください。</p>
</section>
<section id="appendix" class="level4">
<h4 class="anchored" data-anchor-id="appendix">Appendix</h4>
<p>アペンディクスは参考文献の後に差し込みたいかもしれません。その場合少々やっかいですが、以下のように記述し、その下に文章を書いていってください。</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb16" style="background: #f1f3f5;"><pre class="sourceCode typst code-with-copy"><code class="sourceCode typst"><span id="cb16-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">#</span>block<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span></span>
<span id="cb16-2">  <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">#</span>heading<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span></span>
<span id="cb16-3">    level<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb16-4">    numbering<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">none</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb16-5">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>Appendix<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">]</span></span>
<span id="cb16-6">  <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span></span>
<span id="cb16-7"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">]</span></span></code></pre></div></div>
<p>これでアペンディクスのセクションが作成されます。</p>
</section>
<section id="改ページ" class="level4">
<h4 class="anchored" data-anchor-id="改ページ">改ページ</h4>
<p>改ページは<code>#page-break()</code>を使います。改行したい場所にこのコードを追加することで新しいページに移ることができます。</p>
</section>
</section>
<section id="コード全文" class="level3">
<h3 class="anchored" data-anchor-id="コード全文">コード全文</h3>
<p>基本的な使い方は以上です。</p>
<p>ご参考までに、はじめにご紹介したPDF作成に使用したコード全文を以下に示します。長いので折りたたんで置いておきますので、開いてご確認ください。</p>
<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center collapsed" data-bs-toggle="collapse" data-bs-target=".callout-2-contents" aria-controls="callout-2" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
<span class="screen-reader-only">Tip</span>コード全文
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-2" class="callout-2-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb17" style="background: #f1f3f5;"><pre class="sourceCode typst code-with-copy"><code class="sourceCode typst"><span id="cb17-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">#</span><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"template.typ"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span> article</span>
<span id="cb17-2"></span>
<span id="cb17-3"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">#show</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span> article<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>with<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span></span>
<span id="cb17-4">  title<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>Minimal Article Template (Test)<span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">#</span>footnote<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">#</span>lorem<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">150</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)]],</span></span>
<span id="cb17-5">  authors<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span></span>
<span id="cb17-6">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span></span>
<span id="cb17-7">      name: <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Yosuke Abe"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb17-8">      affiliation: <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Example University"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb17-9">      email: <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"yosuke.abe0507@gmail.com"</span></span>
<span id="cb17-10">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">),</span></span>
<span id="cb17-11">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span></span>
<span id="cb17-12">      name: <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Taro Yamada"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb17-13">      affiliation: <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Example University"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb17-14">      email: <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"taro@example.jp"</span></span>
<span id="cb17-15">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span></span>
<span id="cb17-16">  <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">),</span></span>
<span id="cb17-17">  date<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span> datetime<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>today<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">().</span>display<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"[month repr:long] [day], [year]"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">),</span></span>
<span id="cb17-18">  abstract<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span></span>
<span id="cb17-19">    <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">#</span>lorem<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">150</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span></span>
<span id="cb17-20">  <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">],</span></span>
<span id="cb17-21">  jel-codes<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span></span>
<span id="cb17-22">    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"A1"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb17-23">    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"A2"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb17-24">    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"A3"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb17-25">    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"A4"</span></span>
<span id="cb17-26">  <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">),</span></span>
<span id="cb17-27">  keywords<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span></span>
<span id="cb17-28">    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Keyword 1"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb17-29">    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Keyword 2"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb17-30">    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Keyword 3"</span></span>
<span id="cb17-31">  <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span></span>
<span id="cb17-32"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span></span>
<span id="cb17-33"></span>
<span id="cb17-34"></span>
<span id="cb17-35"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">= Introduction</span></span>
<span id="cb17-36"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">#</span>lorem<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">500</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">#</span>footnote<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">#</span>lorem<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">100</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)]</span></span>
<span id="cb17-37"></span>
<span id="cb17-38"><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">$</span></span>
<span id="cb17-39"><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">E = m c^2</span></span>
<span id="cb17-40"><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">$</span></span>
<span id="cb17-41"></span>
<span id="cb17-42"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">#</span>lorem<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">500</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span></span>
<span id="cb17-43"></span>
<span id="cb17-44"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">= Section</span></span>
<span id="cb17-45">Insert an image. <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">#</span>lorem<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">100</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span></span>
<span id="cb17-46"></span>
<span id="cb17-47"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">#</span>figure<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span></span>
<span id="cb17-48">  image<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span></span>
<span id="cb17-49">    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"seiji_souridaijin_woman_kaiken.png"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb17-50">    width<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">30%</span></span>
<span id="cb17-51">  <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">),</span></span>
<span id="cb17-52">  caption<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>Prime Minister<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">]</span></span>
<span id="cb17-53"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">&lt;prime-minister&gt;</span></span>
<span id="cb17-54"></span>
<span id="cb17-55"><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">@prime-minister</span> depicts a _female_ prime minister. </span>
<span id="cb17-56"></span>
<span id="cb17-57">- item 1</span>
<span id="cb17-58">- item 2</span>
<span id="cb17-59">  - item2.1</span>
<span id="cb17-60"></span>
<span id="cb17-61">1. item 1</span>
<span id="cb17-62">2. item 2</span>
<span id="cb17-63"></span>
<span id="cb17-64"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">#</span>lorem<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">100</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span></span>
<span id="cb17-65"></span>
<span id="cb17-66">Insert an table. <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">#</span>lorem<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">100</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> According to  <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">@notsu_indirect_2025</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">@martinez_how_2022</span>, hogehoge.</span>
<span id="cb17-67"></span>
<span id="cb17-68"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">#</span>figure<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span></span>
<span id="cb17-69">  table<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span></span>
<span id="cb17-70">    columns<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">12</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb17-71">    align<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>left<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> right<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> right<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> right<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> right<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> right<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> right<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> right<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> right<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> right<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> right<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> right<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">),</span></span>
<span id="cb17-72">    table<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>hline<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(),</span></span>
<span id="cb17-73">    table<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>header<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>repeat<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">true</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb17-74">      <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>model<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">],</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>mpg<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">],</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>cyl<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">],</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>disp<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">],</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>hp<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">],</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>drat<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">],</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>wt<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">],</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>qsec<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">],</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>vs<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">],</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>am<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">],</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>gear<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">],</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>carb<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">],</span></span>
<span id="cb17-75">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">),</span></span>
<span id="cb17-76">    table<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>hline<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(),</span></span>
<span id="cb17-77">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>Mazda RX4<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">],</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>21.0<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">],</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>6<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">],</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>160<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">],</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>110<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">],</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>3.90<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">],</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>2.620<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">],</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>16.46<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">],</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>0<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">],</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>1<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">],</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>4<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">],</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>4<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">],</span></span>
<span id="cb17-78">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>Mazda RX4 Wag<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">],</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>21.0<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">],</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>6<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">],</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>160<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">],</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>110<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">],</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>3.90<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">],</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>2.875<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">],</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>17.02<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">],</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>0<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">],</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>1<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">],</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>4<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">],</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>4<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">],</span></span>
<span id="cb17-79">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>Datsun 710<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">],</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>22.8<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">],</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>4<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">],</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>108<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">],</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>93<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">],</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>3.85<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">],</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>2.320<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">],</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>18.61<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">],</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>1<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">],</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>1<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">],</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>4<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">],</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>1<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">],</span></span>
<span id="cb17-80">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>Hornet 4 Drive<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">],</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>21.4<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">],</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>6<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">],</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>258<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">],</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>110<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">],</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>3.08<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">],</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>3.215<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">],</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>19.44<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">],</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>1<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">],</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>0<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">],</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>3<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">],</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>1<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">],</span></span>
<span id="cb17-81">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>Hornet Sportabout<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">],</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>18.7<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">],</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>8<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">],</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>360<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">],</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>175<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">],</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>3.15<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">],</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>3.440<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">],</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>17.02<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">],</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>0<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">],</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>0<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">],</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>3<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">],</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>2<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">],</span></span>
<span id="cb17-82">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>Valiant<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">],</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>18.1<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">],</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>6<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">],</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>225<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">],</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>105<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">],</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>2.76<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">],</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>3.460<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">],</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>20.22<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">],</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>1<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">],</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>0<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">],</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>3<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">],</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>1<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">],</span></span>
<span id="cb17-83">    table<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>hline<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(),</span></span>
<span id="cb17-84">    table<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>footer<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>repeat<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">false</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb17-85">      table<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>cell<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>align<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span> left<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> colspan<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">12</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb17-86">        text<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">([</span></span>
<span id="cb17-87">          <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">#</span>text<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>style<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"italic"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)[</span>Note:<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">]</span> This table shows the first few rows of the mtcars dataset.</span>
<span id="cb17-88">        <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">])</span></span>
<span id="cb17-89">      <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">),</span></span>
<span id="cb17-90">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">),</span></span>
<span id="cb17-91">  <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">),</span></span>
<span id="cb17-92">  caption<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>mtcars data<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">],</span></span>
<span id="cb17-93"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">&lt;mtcars&gt;</span></span>
<span id="cb17-94"></span>
<span id="cb17-95"><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">@mtcars</span> is mtcars data. <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">#</span>lorem<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">500</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span></span>
<span id="cb17-96"></span>
<span id="cb17-97"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">#</span>bibliography<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"references.bib"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span></span>
<span id="cb17-98"></span>
<span id="cb17-99"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">#</span>pagebreak<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">()</span></span>
<span id="cb17-100"></span>
<span id="cb17-101"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">#</span>block<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span></span>
<span id="cb17-102">  <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">#</span>heading<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span></span>
<span id="cb17-103">    level<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb17-104">    numbering<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">none</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb17-105">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>Appendix<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">]</span></span>
<span id="cb17-106">  <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span></span>
<span id="cb17-107"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">]</span></span>
<span id="cb17-108"></span>
<span id="cb17-109"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">#</span>lorem<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">500</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span></span></code></pre></div></div>
</div>
</div>
</div>
</section>
</section>
<section id="おわりに" class="level2">
<h2 class="anchored" data-anchor-id="おわりに">おわりに</h2>
<p>ここまでTypstの基本的な使い方を紹介しました。</p>
<p>ある程度の機能はご紹介できたかと思いますが、実際論文を書くとなるともっと細かい設定が必要になることもあるかと思います。</p>
<p>Typst公式ドキュメントもご参考にしていただきつつ、気づいた点があれば随時テンプレートを更新していきたいと思います。</p>


<!-- -->

</section>


<div id="quarto-appendix" class="default"><section id="footnotes" class="footnotes footnotes-end-of-document"><h2 class="anchored quarto-appendix-heading">注</h2>

<ol>
<li id="fn1"><p>もし何も表示されない場合、<code>template.typ</code>がプレビューに表示されているかもしれません。サイドバーの<code>.typ</code>ファイルの右に目のアイコンがあると思いますが、<code>main.typ</code>横の目をクリックして表示してください。↩︎</p></li>
<li id="fn2"><p>すみません、本ページのフォントの設定上イコールの数が見にくいですが、サブセクションでは2つのイコールを使用しています。↩︎</p></li>
</ol>
</section></div> ]]></description>
  <category>Typst</category>
  <guid>https://yo5uke.com/pages/tips/251026_typst/</guid>
  <pubDate>Sat, 25 Oct 2025 15:00:00 GMT</pubDate>
</item>
<item>
  <title>【Typst】Quartoで論文を書く【PDF】</title>
  <link>https://yo5uke.com/pages/tips/251021_quarto_typst/</link>
  <description><![CDATA[ 

<div class="social-share-buttons">

  <!-- Twitter (X) -->

  <a href="" id="js-share-twitter" class="share_button ri--twitter-x-fill" target="_blank" rel="nofollow noopener noreferrer"></a>



  <!-- Bluesky -->

  <a href="" id="js-share-bluesky" class="share_button ri--bluesky-fill" target="_blank" rel="nofollow noopener noreferrer"></a>

</div>



<script>

  const twitterUsername = "@5uke_y";

  const blueskyUsername = "@5uke.bsky.social";



  const share_url = encodeURIComponent(location.href);

  const share_title = document.title;



  // Twitter (X)

  document.getElementById('js-share-twitter').setAttribute(

    "href",

    "https://twitter.com/share?url=" + share_url + "&text=" + share_title + " " + encodeURIComponent(twitterUsername) + " より" +

    "&hashtags=rstats"

  );



  // Bluesky

  document.getElementById('js-share-bluesky').setAttribute(

    "href",

    "https://bsky.app/intent/compose?text=" + share_title + " " + share_url + " " + encodeURIComponent(blueskyUsername) + " より"

  );

</script>






<section id="はじめに" class="level2">
<h2 class="anchored" data-anchor-id="はじめに">はじめに</h2>
<p>以前TinyTeXを使ってRStudio×Quartoで論文を書く方法についてご紹介しました。</p>
<div class="callout callout-style-simple callout-tip no-icon">
<div class="callout-body d-flex">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-body-container">
<p><a href="../../../pages/tips/240629_write_thesis/index.html">【PDF】Quarto で論文を書く</a></p>
</div>
</div>
</div>
<p>しかし、TinyTeXを使った方法はいくらTiny（軽量）とはいえLaTeX特有のエラーが発生することもあり、論文を書くとなると、どうせなら細かい設定をするためにローカルのTeXやOverleafで書くことが多いのではないかと思います<sup>1</sup>。</p>
<p>そこで今回は、LaTeXも代わりうる新しい組版システムであるTypstを使ってQuartoで論文を書く方法をご紹介します。</p>
<p>また、英語論文のバージョンではありますが、Quarto拡張機能を作成し経済学論文のテンプレートも用意しましたので、併せてご紹介します。</p>
<p>Rの出力をシームレスにTypstに組み込むことが可能ですので、R（Python）ユーザーの方はぜひご活用ください。</p>
</section>
<section id="typstとは" class="level2">
<h2 class="anchored" data-anchor-id="typstとは">Typstとは？</h2>
<p>Typstは、新しいマークアップベースの組版システムで、オープンソースで提供されています。</p>
<p>基本的にはLaTeXと同様に、学術論文に適した高品質なPDFを生成することができますが、TypstにはLaTeXに比べていくつかの利点があります。</p>
<ul>
<li><strong>シンプルな文法</strong>: Typstの文法はLaTeXに比べて直感的で、学びやすいという特徴があります。 ※ただし、Quarto上で利用する場合はQuartoやR Markdown同様Markdownベースの記述となるため、Typstの文法を直接学ぶ必要はありません。</li>
<li><strong>リアルタイムプレビュー</strong>: Typstの公式オンラインエディタはリアルタイムプレビュー機能を備えており、編集内容が即座に反映されるため、効率的に文書を作成できます。<br>
※ただし、Quarto上ではリアルタイムプレビューは利用できません。<br>
</li>
<li><strong>高速なコンパイル</strong>: Typstは非常に高速なコンパイルを実現しており、LaTeXの数倍の速度でPDFを生成できます。</li>
</ul>
<p>TypstにはOverleafのような公式<a href="https://typst.app/">オンラインエディタ</a>が提供されており、柔軟に文書を編集できますが、当然ながらそちらではTypstの文法を使って記述する必要があります。</p>
<p>一方で、<strong>Quartoを介してTypstを利用することで、Markdownベースの記述を保ちながらTypstの利点を活かす</strong>ことが可能です。</p>
<p>中でも特筆すべきはその<strong>コンパイル速度</strong>です。LaTeXのコンパイル時間にストレスを感じている方は、Typstの速さにきっと驚くでしょう！（ガチ）🚀</p>
</section>
<section id="quartoでtypstを使う方法" class="level2">
<h2 class="anchored" data-anchor-id="quartoでtypstを使う方法">QuartoでTypstを使う方法</h2>
<p>デフォルトの設定でよければ、以下のようにYAMLヘッダーを設定するだけでTypstを利用できます。</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb1" style="background: #f1f3f5;"><pre class="sourceCode yaml code-with-copy"><code class="sourceCode yaml"><span id="cb1-1"><span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">---</span></span>
<span id="cb1-2"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">title</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">:</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> </span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"ドキュメントのタイトル"</span></span>
<span id="cb1-3"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">author</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">:</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> </span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"著者名"</span></span>
<span id="cb1-4"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">date</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">:</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> 2025-10-21</span></span>
<span id="cb1-5"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">format</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">:</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> typst</span></span>
<span id="cb1-6"><span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">---</span></span></code></pre></div></div>
<p>課題のレポートであればこれで十分なドキュメントを生成できるはずです。{tinytex}のようなパッケージのインストールも不要です。</p>
<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
<span class="screen-reader-only">Tip</span>参考
</div>
</div>
<div class="callout-body-container callout-body">
<p>自分の記事で恐縮ですが、以下をご覧いただければQuartoでの書き方がわかるかと思います。</p>
<ul>
<li><a href="../../../pages/tips/240329_rmarkdown_pdf/index.html">【Typst】Quarto &amp; R MarkdownでPDF出力【LaTeX】</a></li>
<li><a href="../../../pages/tips/240509_chunk_option/index.html">【Quarto】チャンクオプションまとめてみた【R Markdown】</a></li>
<li><a href="../../../pages/tips/240629_write_thesis/index.html">【PDF】Quarto で論文を書く</a></li>
<li><a href="../../../pages/tips/240802_quarto_markdown/index.html">【Quarto】マークダウンでできること！</a></li>
</ul>
</div>
</div>
</section>
<section id="quarto拡張機能を使う" class="level2">
<h2 class="anchored" data-anchor-id="quarto拡張機能を使う">Quarto拡張機能を使う</h2>
<p>冒頭にも書きました通り、英語論文用のテンプレートであるQuarto拡張機能を作成しました。作成に当たっては、自分が修士論文をQuartoで書こうとしたときに対応できず挫折した部分をなるべく補うように努めました。</p>
<section id="対応環境" class="level3">
<h3 class="anchored" data-anchor-id="対応環境">対応環境</h3>
<p>はじめに拡張機能を使うための対応環境について説明します。</p>
<ul>
<li>Quarto 1.8以上</li>
</ul>
<p>Rを使っていればQuartoはデフォルトで使えるのですが、現在はバージョンが1.8にはなっていないと思います。 その場合は、<a href="https://quarto.org/docs/get-started/">Quartoの公式サイト</a>から1.8以上をインストールしてください<sup>2</sup>。</p>
<p>また、RStudioあるいはPositronの環境を想定しています。</p>
</section>
<section id="拡張機能のインストール" class="level3">
<h3 class="anchored" data-anchor-id="拡張機能のインストール">拡張機能のインストール</h3>
<p>拡張機能は以下のコマンドでインストールできます。<strong>作業フォルダを開いた状態で実行してください。</strong></p>
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>ターミナル</strong></pre>
</div>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb2" data-filename="ターミナル" style="background: #f1f3f5;"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb2-1"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">quarto</span> install extension yo5uke/econ-a4</span></code></pre></div></div>
</div>
<p>実行するとYse/Noの確認が求められますので、<code>Y</code>を入力して進めてください。最後の「? View documentation using default browser? (Y/n)」は<code>n</code>でもよいのですが、ドキュメントが見れますので<code>Y</code>から使い方を確認してください。</p>
</section>
<section id="拡張機能の利用" class="level3">
<h3 class="anchored" data-anchor-id="拡張機能の利用">拡張機能の利用</h3>
<p>拡張機能を利用するには、YAMLヘッダーの<code>format</code>フィールドを以下のように設定します。</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb3" style="background: #f1f3f5;"><pre class="sourceCode yaml code-with-copy"><code class="sourceCode yaml"><span id="cb3-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">format</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">:</span></span>
<span id="cb3-2"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">  </span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">econ-a4-typst</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">:</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> default</span></span></code></pre></div></div>
<p>これで、経済学論文用のA4サイズのTypstテンプレートが利用できます。</p>
<p>使い方はGitHubリポジトリのREADMEにも記載していますので、<a href="https://github.com/yo5uke/econ-a4#readme">そちら</a>もご覧ください。</p>
</section>
<section id="サンプルコード" class="level3">
<h3 class="anchored" data-anchor-id="サンプルコード">サンプルコード</h3>
<p>以下は、拡張機能を利用したサンプルコードです。</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb4" style="background: #f1f3f5;"><pre class="sourceCode markdown code-with-copy"><code class="sourceCode markdown"><span id="cb4-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">---</span></span>
<span id="cb4-2"><span class="an" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">title:</span><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"> "Writing Papers with Quarto and Typst"</span></span>
<span id="cb4-3"><span class="an" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">author:</span><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"> </span></span>
<span id="cb4-4"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">  - name: Your Name</span></span>
<span id="cb4-5"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    affiliation: Your Affiliation</span></span>
<span id="cb4-6"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    email: your-address@example.com</span></span>
<span id="cb4-7"><span class="an" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">date:</span><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"> 2025-10-21</span></span>
<span id="cb4-8"><span class="an" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">date-format:</span><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"> long</span></span>
<span id="cb4-9"><span class="an" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">abstract:</span><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"> |</span></span>
<span id="cb4-10"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">  This is a sample abstract.</span></span>
<span id="cb4-11"><span class="an" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">keywords:</span><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"> [Quarto, Typst, Academic Writing, PDF Generation]</span></span>
<span id="cb4-12"><span class="an" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">format:</span></span>
<span id="cb4-13"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">  econ-a4-typst:</span></span>
<span id="cb4-14"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    toc: true</span></span>
<span id="cb4-15"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    number-sections: true</span></span>
<span id="cb4-16"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">---</span></span>
<span id="cb4-17"></span>
<span id="cb4-18"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">## Introduction</span></span>
<span id="cb4-19"></span>
<span id="cb4-20">@notsu_indirect_2025</span>
<span id="cb4-21"></span>
<span id="cb4-22">This is a sample introduction text.</span>
<span id="cb4-23"></span>
<span id="cb4-24"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">## Insert Figures</span></span>
<span id="cb4-25"></span>
<span id="cb4-26"><span class="in" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">```{r}</span></span>
<span id="cb4-27"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#| echo: false</span></span>
<span id="cb4-28"></span>
<span id="cb4-29"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(ggplot2)</span>
<span id="cb4-30"></span>
<span id="cb4-31"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Create a simple plot</span></span>
<span id="cb4-32"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ggplot</span>(mtcars, <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x =</span> wt, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y =</span> mpg)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb4-33">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_point</span>() <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb4-34">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">labs</span>(</span>
<span id="cb4-35">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">title =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Scatter plot of MPG vs Weight"</span>,</span>
<span id="cb4-36">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Weight (1000 lbs)"</span>,</span>
<span id="cb4-37">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Miles per Gallon"</span></span>
<span id="cb4-38">  )</span>
<span id="cb4-39"><span class="in" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">```</span></span>
<span id="cb4-40"></span>
<span id="cb4-41"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">## Insert Tables</span></span>
<span id="cb4-42"></span>
<span id="cb4-43"><span class="in" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">```{r}</span></span>
<span id="cb4-44"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#| echo: false</span></span>
<span id="cb4-45"></span>
<span id="cb4-46"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(knitr)</span>
<span id="cb4-47"></span>
<span id="cb4-48"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Create a simple table</span></span>
<span id="cb4-49"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">kable</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">head</span>(mtcars), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">caption =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Table 1: Sample of mtcars dataset"</span>)</span>
<span id="cb4-50"><span class="in" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">```</span></span>
<span id="cb4-51"></span>
<span id="cb4-52"><span class="in" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">```{=typst}</span></span>
<span id="cb4-53"><span class="in" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#bibliography("references.bib")</span></span>
<span id="cb4-54"><span class="in" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">```</span></span></code></pre></div></div>
<p>出力結果は<a href="../../../pages/tips/251021_quarto_typst/demo/demo.html">こちら</a>からご確認ください（少しダミーテキストで文量を増やしています）。</p>
<p>参考文献のセクションについては現状生のTypstコードで指定する必要がありますので、例にあるように記述してください。“References”という見出しも自動で生成されます。</p>
<p>もちろんRコードを使って図や表を挿入することも可能です。分析の結果を一度画像等で出力することなく挿入できるため、論文作成が非常に楽になります（もちろんレポートも！）。</p>
</section>
<section id="今後の展望" class="level3">
<h3 class="anchored" data-anchor-id="今後の展望">今後の展望</h3>
<p>今回は英語論文用のテンプレートを作成しましたが、今後は日本語でも使えるテンプレートを作成したいと考えています。</p>
<p>やはり海外誌に出すような細かい設定を行う論文はQuartoを介さずTypstやLaTeXで書くことが多くなるかと思いますが、学位論文はこの拡張機能で十分対応できるようになればと考えています（とはいえ将来は細かい設定も詰めたい…！）。</p>
<p>テンプレートの限界については<a href="https://github.com/yo5uke/econ-a4#readme">README</a>にも記載していますので、ご覧ください。</p>
</section>
</section>
<section id="おわりに" class="level2">
<h2 class="anchored" data-anchor-id="おわりに">おわりに</h2>
<p>今回はQuartoの記述方法自体はほぼ説明しませんでしたが、Typst（＆作成したテンプレート）を使うことで、MarkdownベースでTypstの利点を享受できるということをお伝えできたかと思います。</p>
<p>ぜひTypstを使って快適な論文執筆ライフを送りましょう！🚀</p>
<div class="callout callout-style-simple callout-tip no-icon">
<div class="callout-body d-flex">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-body-container">
<p><a href="https://typst.app/docs/">Typst Documentation</a></p>
</div>
</div>
</div>


<!-- -->

</section>


<div id="quarto-appendix" class="default"><section id="footnotes" class="footnotes footnotes-end-of-document"><h2 class="anchored quarto-appendix-heading">注</h2>

<ol>
<li id="fn1"><p>かくいう僕も修士論文はローカルのTeXを使って書きました。↩︎</p></li>
<li id="fn2"><p>2025/10/21時点では1.8.5ですので、表示されているものをインストールすればOKです。↩︎</p></li>
</ol>
</section></div> ]]></description>
  <category>Typst</category>
  <category>Quarto</category>
  <category>R</category>
  <guid>https://yo5uke.com/pages/tips/251021_quarto_typst/</guid>
  <pubDate>Mon, 20 Oct 2025 15:00:00 GMT</pubDate>
</item>
<item>
  <title>【Positron】拡張機能「Air」を使う【フォーマッタ】</title>
  <link>https://yo5uke.com/pages/tips/251016_air/</link>
  <description><![CDATA[ 

<div class="social-share-buttons">

  <!-- Twitter (X) -->

  <a href="" id="js-share-twitter" class="share_button ri--twitter-x-fill" target="_blank" rel="nofollow noopener noreferrer"></a>



  <!-- Bluesky -->

  <a href="" id="js-share-bluesky" class="share_button ri--bluesky-fill" target="_blank" rel="nofollow noopener noreferrer"></a>

</div>



<script>

  const twitterUsername = "@5uke_y";

  const blueskyUsername = "@5uke.bsky.social";



  const share_url = encodeURIComponent(location.href);

  const share_title = document.title;



  // Twitter (X)

  document.getElementById('js-share-twitter').setAttribute(

    "href",

    "https://twitter.com/share?url=" + share_url + "&text=" + share_title + " " + encodeURIComponent(twitterUsername) + " より" +

    "&hashtags=rstats"

  );



  // Bluesky

  document.getElementById('js-share-bluesky').setAttribute(

    "href",

    "https://bsky.app/intent/compose?text=" + share_title + " " + share_url + " " + encodeURIComponent(blueskyUsername) + " より"

  );

</script>






<section id="はじめに" class="level2">
<h2 class="anchored" data-anchor-id="はじめに">はじめに</h2>
<p>Positronに標準でインストールされている拡張機能がいくつかあるのですが、その一つが「Air - R Language Support」です。</p>
<p>この拡張機能は、Rのコードを自動でフォーマットしてくれるもので、コードの可読性を向上させるのに役立ちます。</p>
<p>例えばどこで改行するのか、インデントはどうするのか、スペースをどこに入れるのかなどは人によってばらばらで、定まったルールがありません。場所によってスペースの有無が異なったり1行が長すぎたりするとコードが読みにくくなります。</p>
<p>Airは一定の規則に則りコードを整形してくれるので、コードの見た目を統一することができます。</p>
<p>これに関しては百聞は一見に如かずということで、早速使い方から実際の例まで見ていきましょう。</p>
</section>
<section id="airの使い方" class="level2">
<h2 class="anchored" data-anchor-id="airの使い方">Airの使い方</h2>
<p>AirはPositronに標準でインストールされているので、特にインストールする必要はありません。ただし、有効化はされていないので、設定から有効化していきましょう。</p>
<ol class="example" type="1">
<li>Positronの設定を開きます。
<ul>
<li>左下の歯車アイコンから開くか、<span class="visually-hidden">Ctrl-,</span>で開きます。</li>
</ul></li>
<li>画面右上の「設定 (JSON) を開く」から設定ファイルを開きます。</li>
</ol>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://yo5uke.com/pages/tips/251016_air/image/open_json.png" class="img-fluid figure-img" style="width:30.0%"></p>
<figcaption>1番左のアイコンです</figcaption>
</figure>
</div>
<ol start="3" class="example" type="1">
<li>設定ファイルに以下のコードを追加します。
<ul>
<li>既に<code>[ ]</code>の中に記載があれば、その中に追記してください。</li>
</ul></li>
</ol>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb1" style="background: #f1f3f5;"><pre class="sourceCode json code-with-copy"><code class="sourceCode json"><span id="cb1-1"><span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">[</span></span>
<span id="cb1-2">    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"[r]"</span><span class="er" style="color: #AD0000;
background-color: null;
font-style: inherit;">:</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb1-3">        <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">"editor.formatOnSave"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">:</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">true</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb1-4">        <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">"editor.defaultFormatter"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">:</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Posit.air-vscode"</span></span>
<span id="cb1-5">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb1-6"><span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">]</span></span></code></pre></div></div>
<ol start="4" class="example" type="1">
<li>保存します。</li>
</ol>
<p>これで設定は完了です。<code>.R</code>ファイル内で、Rのコードは保存するたびに自動で整形されるようになります。</p>
</section>
<section id="実際の例" class="level2">
<h2 class="anchored" data-anchor-id="実際の例">実際の例</h2>
<p>ではこのフォーマッタの力はどれほどのものなのか、実際に見ていきましょう。</p>
<p>例えば以下のようなコードがあったとします。</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb2" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1">my_function <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">function</span>(x,y){</span>
<span id="cb2-2"><span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span>(x<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span>y){<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">return</span>(x<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span>y)}<span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">else</span>{<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">return</span>(x<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>y)}</span>
<span id="cb2-3">}</span>
<span id="cb2-4">result<span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">my_function</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span>)<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">print</span>(result)</span></code></pre></div></div>
<p>このコードはインデントがなく、スペースの使い方も一貫していません。また、1行が長すぎて読みにくいです。 このコードを保存すると、Airが自動で整形してくれます。</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb3" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1">my_function <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">function</span>(x, y) {</span>
<span id="cb3-2">  <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> (x <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span> y) {</span>
<span id="cb3-3">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">return</span>(x <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> y)</span>
<span id="cb3-4">  } <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">else</span> {</span>
<span id="cb3-5">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">return</span>(x <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> y)</span>
<span id="cb3-6">  }</span>
<span id="cb3-7">}</span>
<span id="cb3-8">result <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">my_function</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span>)</span>
<span id="cb3-9"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">print</span>(result)</span></code></pre></div></div>
<p>インデントの追加やスペースの挿入など、コードが格段に読みやすくなりました。</p>
<p>リストなどで中身が多く1行に収まりきらない場合も、適切に改行してくれます。</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb4" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1">my_vector <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">6</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">7</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">8</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">9</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span>)</span>
<span id="cb4-2">my_data_frame <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">data.frame</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">id =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">value =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rnorm</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span>),</span>
<span id="cb4-3">                            <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">category =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sample</span>(letters[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>], <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">replace =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">TRUE</span>))</span></code></pre></div></div>
<p>無くはなさそうなコードですが、やや右に比重がかかっている印象ですね。これをフォーマッタにかけると以下のようになります。</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb5" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1">my_vector <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">6</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">7</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">8</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">9</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span>)</span>
<span id="cb5-2">my_data_frame <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">data.frame</span>(</span>
<span id="cb5-3">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">id =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span>,</span>
<span id="cb5-4">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">value =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rnorm</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span>),</span>
<span id="cb5-5">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">category =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sample</span>(letters[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>], <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">replace =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">TRUE</span>)</span>
<span id="cb5-6">)</span></code></pre></div></div>
<p><code>data.frame()</code>の中身が見やすくなりました。</p>
<p>ちなみに<code>my_vector</code>の方も、最初に1度だけ改行しておくと、全て改行するスタイルにしてくれます。少し中身を変えて試してみます。</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb6" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Before</span></span>
<span id="cb6-2">my_vector <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(</span>
<span id="cb6-3">  <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Jane Doe"</span>,<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"John Smith"</span>)</span>
<span id="cb6-4"></span>
<span id="cb6-5"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># After</span></span>
<span id="cb6-6">my_vector <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(</span>
<span id="cb6-7">  <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Jane Doe"</span>,</span>
<span id="cb6-8">  <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"John Smith"</span></span>
<span id="cb6-9">)</span></code></pre></div></div>
<p>このように最初だけ改行しておけば、1行が短い場合でも残りの要素を改行してくれます。フォーマッタの力を借りるのであれば、スペースも気にせず書き連ね、必要に応じて1か所改行して保存するだけで整形することができ、非常に楽かもしれません。</p>
</section>
<section id="フォーマットを回避" class="level2">
<h2 class="anchored" data-anchor-id="フォーマットを回避">フォーマットを回避</h2>
<p>場合によってはフォーマッタの力を借りたくない場合もあるかもしれません。その場合は、以下のようにコードの前後にコメントを入れることで、フォーマットを回避することができます。</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb7" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># fmt: skip</span></span>
<span id="cb7-2">my_vector <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">6</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">7</span>,</span>
<span id="cb7-3"><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">8</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">9</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span>)</span></code></pre></div></div>
<p>このように<code># fmt: skip</code>を入れることで、そのコードブロックはフォーマッタの対象外となります。</p>
<p>また、これはコードの途中に挟むこともできます。</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb8" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb8-1">df <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> tibble<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">tibble</span>(</span>
<span id="cb8-2">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span>,</span>
<span id="cb8-3">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">6</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span></span>
<span id="cb8-4">) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span></span>
<span id="cb8-5">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># fmt: skip</span></span>
<span id="cb8-6">  dplyr<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mutate</span>(</span>
<span id="cb8-7">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">z =</span> x <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> y) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span></span>
<span id="cb8-8">  dplyr<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">select</span>(</span>
<span id="cb8-9">    col1,</span>
<span id="cb8-10">    col2,</span>
<span id="cb8-11">    col3,</span>
<span id="cb8-12">    col4</span>
<span id="cb8-13">  )</span></code></pre></div></div>
<p>同様に<code># fmt: skip</code>を入れることで、その行以降はフォーマッタの対象外となります。コードの途中に挟んだ場合、その後のコードは再びフォーマッタの対象となるので注意してください。ここで言えば<code>dplyr::select()</code>の行は再びフォーマッタの対象となり、整形されています。</p>
</section>
<section id="quartoにも反映させたい" class="level2">
<h2 class="anchored" data-anchor-id="quartoにも反映させたい">Quartoにも反映させたい</h2>
<p>以上の設定は<code>.R</code>ファイルに対してのみ有効です。Quartoドキュメント内のRコードチャンクに対しても同じようにフォーマッタを適用したい場合は、以下の設定を追加してください。</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb9" style="background: #f1f3f5;"><pre class="sourceCode json code-with-copy"><code class="sourceCode json"><span id="cb9-1"><span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">[</span></span>
<span id="cb9-2">    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"[r]"</span><span class="er" style="color: #AD0000;
background-color: null;
font-style: inherit;">:</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb9-3">        <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">"editor.formatOnSave"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">:</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">true</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb9-4">        <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">"editor.defaultFormatter"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">:</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Posit.air-vscode"</span></span>
<span id="cb9-5">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">}</span><span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb9-6"></span>
<span id="cb9-7">    <span class="er" style="color: #AD0000;
background-color: null;
font-style: inherit;">//</span> <span class="er" style="color: #AD0000;
background-color: null;
font-style: inherit;">以下を追記</span></span>
<span id="cb9-8">    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"[quarto]"</span><span class="er" style="color: #AD0000;
background-color: null;
font-style: inherit;">:</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb9-9">        <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">"editor.formatOnSave"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">:</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">true</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb9-10">        <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">"editor.defaultFormatter"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">:</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"quarto.quarto"</span></span>
<span id="cb9-11">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb9-12"><span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">]</span></span></code></pre></div></div>
<p>これでQuartoドキュメント内のRコードチャンクも保存するたびに自動で整形されるようになります。</p>
</section>
<section id="おわりに" class="level2">
<h2 class="anchored" data-anchor-id="おわりに">おわりに</h2>
<p>今回はPositronに標準でインストールされている拡張機能「Air」を紹介しました。</p>
<p>個人的にはコードの書き方にはその人の癖が出てそれはそれでよいものだと思っているのですが、とはいえ生成AIが発達してきた昨今ではコードもAIに書いてもらうことが増え、コードの品質の差はなくなってきているのではないかと思いますし、フォーマッタを使用することも今後より一般的になっていくのではないかと考えています。</p>
<p>Airは非常にシンプルで使いやすい拡張機能なので、ぜひ試してみてください。</p>
</section>
<section id="参考" class="level2">
<h2 class="anchored" data-anchor-id="参考">参考</h2>
<ul>
<li><a href="https://posit-dev.github.io/air/">Air - R Language Support</a></li>
</ul>


<!-- -->

</section>

 ]]></description>
  <category>R</category>
  <category>Positron</category>
  <guid>https://yo5uke.com/pages/tips/251016_air/</guid>
  <pubDate>Wed, 15 Oct 2025 15:00:00 GMT</pubDate>
  <media:content url="https://yo5uke.com/pages/tips/251016_air/image/thumbnail.png" medium="image" type="image/png" height="108" width="144"/>
</item>
<item>
  <title>開発コンテナの環境について</title>
  <link>https://yo5uke.com/pages/tips/251011_dev_container/</link>
  <description><![CDATA[ 

<div class="social-share-buttons">

  <!-- Twitter (X) -->

  <a href="" id="js-share-twitter" class="share_button ri--twitter-x-fill" target="_blank" rel="nofollow noopener noreferrer"></a>



  <!-- Bluesky -->

  <a href="" id="js-share-bluesky" class="share_button ri--bluesky-fill" target="_blank" rel="nofollow noopener noreferrer"></a>

</div>



<script>

  const twitterUsername = "@5uke_y";

  const blueskyUsername = "@5uke.bsky.social";



  const share_url = encodeURIComponent(location.href);

  const share_title = document.title;



  // Twitter (X)

  document.getElementById('js-share-twitter').setAttribute(

    "href",

    "https://twitter.com/share?url=" + share_url + "&text=" + share_title + " " + encodeURIComponent(twitterUsername) + " より" +

    "&hashtags=rstats"

  );



  // Bluesky

  document.getElementById('js-share-bluesky').setAttribute(

    "href",

    "https://bsky.app/intent/compose?text=" + share_title + " " + share_url + " " + encodeURIComponent(blueskyUsername) + " より"

  );

</script>






<section id="はじめに" class="level2">
<h2 class="anchored" data-anchor-id="はじめに">はじめに</h2>
<p>VSCodeの開発コンテナは、開発環境をコード化し、再現性のある環境を提供する強力なツールです。</p>
<p>これまで本サイトでは開発コンテナを用いた環境構築についていくつかの記事を掲載してきました。しかし、自分にとってはややオーバースペックだった感も否めず、もう少しシンプルにできないかと考えることもありました。</p>
<p>本記事では改めて開発コンテナを用いた環境構築について検討し、Rの開発環境を構築する際に考慮すべきポイントや、実際の設定例についてまとめていきたいと思います。</p>
</section>
<section id="実行環境" class="level2">
<h2 class="anchored" data-anchor-id="実行環境">実行環境</h2>
<ul>
<li>Windows 11</li>
<li>WSL2 (Ubuntu 24.04)</li>
<li>Docker Desktop 4.47.0</li>
<li>VSCode</li>
</ul>
</section>
<section id="開発コンテナを用いるメリット" class="level2">
<h2 class="anchored" data-anchor-id="開発コンテナを用いるメリット">開発コンテナを用いるメリット</h2>
<p>開発コンテナを用いることで、以下のようなメリットがあります。</p>
<ul>
<li><strong>一貫性のある環境</strong>: 開発コンテナはコード化された設定ファイル（Dockerfileやdevcontainer.json）を使用するため、チーム全体で同じ環境を再現できます。</li>
<li><strong>依存関係の管理</strong>: 開発コンテナ内で必要なパッケージやツールをインストールすることで、依存関係の衝突を避けることができます。</li>
<li><strong>環境の分離</strong>: 開発コンテナはホストマシンから独立して動作するため、異なるプロジェクトで異なる環境を簡単に切り替えることができます。</li>
<li><strong>ポータビリティ</strong>: 開発コンテナは異なるマシンやOS間で同じ環境を提供できるため、開発者がどこでも同じ環境で作業できます。</li>
<li><strong>VSCodeとの統合</strong>: VSCodeは開発コンテナとシームレスに統合されており、コンテナ内で直接コードを編集、デバッグ、実行できます。</li>
<li><strong>RStudio Serverの利用</strong>: 開発コンテナ内にRStudio Serverをセットアップすることで、ブラウザベースでRの開発が可能になります。</li>
</ul>
<p>チームで研究・開発を行う際には非常に力を発揮することになりますが、個人で使う場合でも、環境の再現性や依存関係の管理が重要な場合には有用です。</p>
</section>
<section id="開発コンテナを用いる際の考慮点" class="level2">
<h2 class="anchored" data-anchor-id="開発コンテナを用いる際の考慮点">開発コンテナを用いる際の考慮点</h2>
<p>開発コンテナを用いる際には、以下のような点を考慮する必要があります。</p>
<ul>
<li><strong>学習コスト</strong>: Dockerや開発コンテナの設定に慣れるまでには時間がかかる場合があります。特に初心者にとっては、最初の設定が難しく感じられることがあります。</li>
<li><strong>設定の複雑さ</strong>: 開発コンテナの設定ファイルが複雑になることがあり、特に多くの依存関係やカスタム設定が必要な場合には管理が難しくなることがあります。</li>
<li><strong>チームの合意形成</strong>: 開発コンテナの使用に関して、チーム全体で合意を形成することが重要です。全員が同じツールやワークフローを使用することで、効率的な開発が可能になります。</li>
</ul>
<p>特に学習コストに関しては、互いに開発コンテナのメリットを理解していないと高くなってしまい、導入が難しくなることがあると感じています。</p>
</section>
<section id="rの開発環境構築例" class="level2">
<h2 class="anchored" data-anchor-id="rの開発環境構築例">Rの開発環境構築例</h2>
<p>Rの開発環境をDocker上で手軽に再現できるようにしたのが、rockerプロジェクトです。</p>
<p>そもそもDockerとは、アプリケーションとその依存関係をコンテナとしてパッケージ化し、どこでも同じ環境で実行できるようにする技術です。</p>
<p>rockerでは、R本体やTidyverse、RStudioなどをあらかじめ組み込んだイメージが用意されており、Dockerを使えばすぐに「同じ環境」で分析を始められます。</p>
<p>開発コンテナではこのrockerイメージをベースに設定を行うことで、VSCode上でも安定したRの実行環境を構築できます。</p>
<section id="プロジェクトフォルダの用意" class="level3">
<h3 class="anchored" data-anchor-id="プロジェクトフォルダの用意">プロジェクトフォルダの用意</h3>
<p>まず、VSCodeで開発コンテナを使用するためのプロジェクトフォルダを用意します。</p>
<p>任意のフォルダを作成し、その中に<code>.devcontainer</code>という名前のサブフォルダを作成します。ここでは仮にプロジェクトフォルダを<code>work</code>とすると、次に紹介する2つのファイルを追加して以下のような構成になります。</p>
<pre><code>work/
└── .devcontainer/
    ├── devcontainer.json
    └── Dockerfile</code></pre>
</section>
<section id="devcontainerdevcontainer.json" class="level3">
<h3 class="anchored" data-anchor-id="devcontainerdevcontainer.json">.devcontainer/devcontainer.json</h3>
<p>今回は開発コンテナを使用するということで、<code>devcontainer.json</code>と<code>Dockerfile</code>の2つのファイルを用いて設定を行います。</p>
<p>まず、<code>devcontainer.json</code>は開発コンテナの設定ファイルで、以下のような内容になります。</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb2" style="background: #f1f3f5;"><pre class="sourceCode json code-with-copy"><code class="sourceCode json"><span id="cb2-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb2-2">  <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">"name"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">:</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"yo5uke.github.io"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb2-3">  <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">"build"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">:</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb2-4">    <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">"dockerfile"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">:</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Dockerfile"</span></span>
<span id="cb2-5">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">},</span></span>
<span id="cb2-6"></span>
<span id="cb2-7">  <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">"remoteUser"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">:</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"rstudio"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb2-8">  <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">"overrideCommand"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">:</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">false</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb2-9"></span>
<span id="cb2-10">  <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">"containerEnv"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">:</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb2-11">    <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">"TZ"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">:</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Asia/Tokyo"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb2-12">    <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">"DISABLE_AUTH"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">:</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"true"</span></span>
<span id="cb2-13">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">},</span></span>
<span id="cb2-14"></span>
<span id="cb2-15">  <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">"workspaceFolder"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">:</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"/home/rstudio/${localWorkspaceFolderBasename}"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb2-16">  <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">"workspaceMount"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">:</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"source=${localWorkspaceFolder},target=/home/rstudio/${localWorkspaceFolderBasename},type=bind"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb2-17"></span>
<span id="cb2-18">  <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">"runArgs"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">:</span> <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">[</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"-p"</span><span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">,</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"8787:8787"</span><span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">]</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb2-19">  <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">"forwardPorts"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">:</span> <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">[</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">8787</span><span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">]</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb2-20">  <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">"portsAttributes"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">:</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb2-21">    <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">"8787"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">:</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">{</span> <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">"label"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">:</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"RStudio Server"</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb2-22">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">},</span></span>
<span id="cb2-23"></span>
<span id="cb2-24">  <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">"features"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">:</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb2-25">    <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">"ghcr.io/rocker-org/devcontainer-features/quarto-cli:latest"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">:</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb2-26">      <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">"version"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">:</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"1.8.25"</span></span>
<span id="cb2-27">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb2-28">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">},</span></span>
<span id="cb2-29"></span>
<span id="cb2-30">  <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">"customizations"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">:</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb2-31">    <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">"vscode"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">:</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb2-32">      <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">"extensions"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">:</span> <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">[</span></span>
<span id="cb2-33">        <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"REditorSupport.r"</span><span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb2-34">        <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Posit.air-vscode"</span><span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb2-35">        <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"ms-python.python"</span><span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb2-36">        <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"quarto.quarto"</span><span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb2-37">        <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"ms-toolsai.jupyter"</span><span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb2-38">        <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"GitHub.copilot"</span><span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb2-39">        <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"GitHub.vscode-pull-request-github"</span><span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb2-40">        <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"janisdd.vscode-edit-csv"</span><span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb2-41">        <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"James-Yu.latex-workshop"</span></span>
<span id="cb2-42">      <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">]</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb2-43">      <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">"settings"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">:</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb2-44">        <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">"python.defaultInterpreterPath"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">:</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"/home/rstudio/.venv/bin/python"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb2-45">        <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">"python.terminal.activateEnvironment"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">:</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">false</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb2-46">        <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">"r.plot.useHttpgd"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">:</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">true</span></span>
<span id="cb2-47">      <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb2-48">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb2-49">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb2-50"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">}</span></span></code></pre></div></div>
<p>この設定ファイルでは、以下のポイントに注目してください。</p>
<ul>
<li><code>build.dockerfile</code>: 使用するDockerfileを指定します。
<ul>
<li>ここでは同じディレクトリにある<code>Dockerfile</code>を指定しています。</li>
</ul></li>
<li><code>remoteUser</code>: コンテナ内で使用するユーザーを指定します。rockerイメージでは<code>rstudio</code>ユーザーがデフォルトです。</li>
<li><code>containerEnv</code>: コンテナ内の環境変数を設定します。ここではタイムゾーンとRStudio Serverの認証無効化を設定しています。
<ul>
<li>RStudio Serverでは通常ユーザー名とパスワードで認証が必要ですが、<code>DISABLE_AUTH</code>を<code>true</code>に設定することで、認証を無効化しています。</li>
</ul></li>
<li><code>workspaceFolder</code>と<code>workspaceMount</code>: ホストマシンの作業ディレクトリをコンテナ内にマウントする設定です。</li>
<li><code>runArgs</code>と<code>forwardPorts</code>: RStudio Serverのポート（8787）をホストマシンにフォワードする設定です。</li>
<li><code>features</code>: Quarto CLIをインストールするための設定です。バージョンを指定できます。</li>
<li><code>customizations.vscode</code>: VSCodeの拡張機能や設定を指定します。RやPython、Quartoなどの拡張機能をインストールしています。</li>
</ul>
<p>ここではPythonの設定も含めていますが、Pythonを使わない場合は削除しても問題ありません。具体的にはVSCodeの拡張機能と設定の部分を削除してください。</p>
</section>
<section id="devcontainerdockerfile" class="level3">
<h3 class="anchored" data-anchor-id="devcontainerdockerfile">.devcontainer/Dockerfile</h3>
<p>次に、<code>Dockerfile</code>はコンテナのベースイメージや追加のパッケージを指定するファイルです。<code>devcontainer.json</code>と同じディレクトリに配置してください。</p>
<p>以下のような内容になります。</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb3" style="background: #f1f3f5;"><pre class="sourceCode dockerfile code-with-copy"><code class="sourceCode dockerfile"><span id="cb3-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">FROM</span> rocker/verse:4.5.1</span>
<span id="cb3-2"></span>
<span id="cb3-3"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">ENV</span> DEBIAN_FRONTEND=noninteractive</span>
<span id="cb3-4"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">SHELL</span> [<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"/bin/bash"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"-o"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"pipefail"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"-c"</span>]</span>
<span id="cb3-5"></span>
<span id="cb3-6"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">RUN</span> <span class="ex" style="color: null;
background-color: null;
font-style: inherit;">R</span> <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">-q</span> <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">-e</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"install.packages(c('renv','languageserver','httpgd'))"</span></span>
<span id="cb3-7"></span>
<span id="cb3-8"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">RUN</span> <span class="ex" style="color: null;
background-color: null;
font-style: inherit;">apt-get</span> update <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">\</span></span>
<span id="cb3-9"> <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">&amp;&amp;</span> <span class="ex" style="color: null;
background-color: null;
font-style: inherit;">apt-get</span> install <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">-y</span> <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">--no-install-recommends</span> <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">\</span></span>
<span id="cb3-10">      python3 python3-venv python3-pip <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">\</span></span>
<span id="cb3-11"> <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">&amp;&amp;</span> <span class="ex" style="color: null;
background-color: null;
font-style: inherit;">apt-get</span> clean <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">\</span></span>
<span id="cb3-12"> <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">&amp;&amp;</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rm</span> <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">-rf</span> /var/lib/apt/lists/<span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">*</span></span>
<span id="cb3-13"></span>
<span id="cb3-14"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">RUN</span> <span class="ex" style="color: null;
background-color: null;
font-style: inherit;">python3</span> <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">-m</span> venv /home/rstudio/.venv <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">\</span></span>
<span id="cb3-15"> <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">&amp;&amp;</span> <span class="ex" style="color: null;
background-color: null;
font-style: inherit;">/home/rstudio/.venv/bin/python</span> <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">-m</span> pip install <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">--upgrade</span> pip <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">\</span></span>
<span id="cb3-16"> <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">&amp;&amp;</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">chown</span> <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">-R</span> rstudio:rstudio /home/rstudio/.venv</span>
<span id="cb3-17"></span>
<span id="cb3-18"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">ENV</span> VIRTUAL_ENV=/home/rstudio/.venv</span>
<span id="cb3-19"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">ENV</span> PATH=<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"${VIRTUAL_ENV}/bin:${PATH}"</span></span>
<span id="cb3-20"></span>
<span id="cb3-21"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">EXPOSE</span> 8787</span></code></pre></div></div>
<p>このDockerfileでは、以下のポイントに注目してください。</p>
<ul>
<li><code>FROM rocker/verse:4.5.1</code>: rockerのverseイメージをベースにしています。verseイメージにはR本体、Tidyverse、RStudioが含まれています。必要に応じて他のrockerイメージを選択できます。
<ul>
<li>詳しくは<a href="https://rocker-project.org/images/">rockerの公式ページ</a>を参照してください。</li>
</ul></li>
<li><code>RUN R -q -e "install.packages(c('renv','languageserver','httpgd'))"</code>: Rのパッケージをインストールしています。ここでは<code>renv</code>、<code>languageserver</code>、<code>httpgd</code>をインストールしています。
<ul>
<li>VSCode上でRを利用しない場合は<code>renv</code>のみでよいと思います。</li>
</ul></li>
<li><code>RUN apt-get install -y python3 python3-venv python3-pip</code>: Pythonの仮想環境を作成するために必要なパッケージをインストールしています。
<ul>
<li>Pythonを使わない場合はこの行を削除してください。</li>
</ul></li>
<li><code>RUN python3 -m venv /home/rstudio/.venv</code>: RStudioユーザーのホームディレクトリにPythonの仮想環境を作成しています。
<ul>
<li>Pythonを使わない場合はこの行も削除してください。</li>
</ul></li>
<li><code>EXPOSE 8787</code>: RStudio Serverのポートを公開しています。</li>
</ul>
</section>
</section>
<section id="開発コンテナの起動" class="level2">
<h2 class="anchored" data-anchor-id="開発コンテナの起動">開発コンテナの起動</h2>
<p>設定ファイルが準備できたら、VSCodeでプロジェクトフォルダを開き、コマンドパレット（<span class="visually-hidden"></span>）から「Dev Containers: Reopen in Container」を選択します。</p>
<p>これにより、VSCodeが開発コンテナをビルドし、コンテナ内で作業できるようになります。</p>
<p>コンテナのビルドには時間がかかる場合がありますが、一度ビルドが完了すれば、次回からは迅速に起動できます。</p>
</section>
<section id="rstudio-serverへのアクセス" class="level2">
<h2 class="anchored" data-anchor-id="rstudio-serverへのアクセス">RStudio Serverへのアクセス</h2>
<p>開発コンテナが起動したら、ブラウザで<code>localhost:8787</code>にアクセスします。</p>
<p>RStudio Server上でプロジェクトフォルダを開き、Rプロジェクトを作成して作業を始めましょう。</p>
</section>
<section id="おわりに" class="level2">
<h2 class="anchored" data-anchor-id="おわりに">おわりに</h2>
<p>今回は<code>devcontainer.json</code>と<code>Dockerfile</code>を紹介することがメインだったので環境構築の手順についてはごく簡単に説明しました。</p>
<p>もし興味があれば、以下の記事も参考にしてみてください。</p>
<div class="callout callout-style-simple callout-tip no-icon">
<div class="callout-body d-flex">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-body-container">
<p><a href="../../../pages/tips/241219_container/index.html">【改訂版】開発コンテナを使ってR環境を構築！</a></p>
</div>
</div>
</div>
<p>そこまで大きくないデータでしたらGitHubを通じて管理できます。もしデータが大きくなればDVCなど他のツールを利用することも検討するのがよいと思います。</p>
<p>ご参考まで。</p>


<!-- -->

</section>

 ]]></description>
  <category>R</category>
  <category>Docker</category>
  <category>VSCode</category>
  <guid>https://yo5uke.com/pages/tips/251011_dev_container/</guid>
  <pubDate>Fri, 10 Oct 2025 15:00:00 GMT</pubDate>
</item>
<item>
  <title>【R】仮想環境を設定する【Python】</title>
  <link>https://yo5uke.com/pages/tips/250926_virtual_environment/</link>
  <description><![CDATA[ 

<div class="social-share-buttons">

  <!-- Twitter (X) -->

  <a href="" id="js-share-twitter" class="share_button ri--twitter-x-fill" target="_blank" rel="nofollow noopener noreferrer"></a>



  <!-- Bluesky -->

  <a href="" id="js-share-bluesky" class="share_button ri--bluesky-fill" target="_blank" rel="nofollow noopener noreferrer"></a>

</div>



<script>

  const twitterUsername = "@5uke_y";

  const blueskyUsername = "@5uke.bsky.social";



  const share_url = encodeURIComponent(location.href);

  const share_title = document.title;



  // Twitter (X)

  document.getElementById('js-share-twitter').setAttribute(

    "href",

    "https://twitter.com/share?url=" + share_url + "&text=" + share_title + " " + encodeURIComponent(twitterUsername) + " より" +

    "&hashtags=rstats"

  );



  // Bluesky

  document.getElementById('js-share-bluesky').setAttribute(

    "href",

    "https://bsky.app/intent/compose?text=" + share_title + " " + share_url + " " + encodeURIComponent(blueskyUsername) + " より"

  );

</script>






<section id="はじめに" class="level2">
<h2 class="anchored" data-anchor-id="はじめに">はじめに</h2>
<p>みなさん、仮想環境、使っていらっしゃいますでしょうか。</p>
<p>プログラミングにおける仮想環境とは、プロジェクトごとに依存パッケージを切り分けて管理できる仕組みです。これにより、他のプロジェクトやシステム全体に影響を与えず、再現性の高い開発環境を保つことができます。研究や開発を長期に続ける上で、安定した環境を構築するために欠かせないものです。</p>
<p>例えば、仮想環境をしない場合とする場合で、以下のような違いがあります。</p>
<p>【仮想環境なし】</p>
<ul>
<li>全プロジェクトで共通のRやPythonのパッケージ（同じバージョン）を使用する。</li>
<li>あるプロジェクトのためにパッケージを更新すると、他のプロジェクトで動かなくなるリスクがある。</li>
<li>チームで共有するとき、同じ環境を再現するのが難しい。</li>
</ul>
<p>【仮想環境あり】</p>
<ul>
<li>プロジェクトごとにパッケージのバージョンを使い分ける。</li>
<li>依存関係を切り分けることで、環境が壊れるリスクを減らせる。</li>
<li>設定ファイルを共有すれば、他の人も同じ環境を簡単に再現できる。</li>
</ul>
<p>本ページでは、これらの違いについて説明しつつ、実際に導入するためのコードも掲載しますので、仮想環境になじみのない方から、知ってはいるけど毎度どうやるんだっけ…となってしまう方までご参考にしていただければと思います。</p>
</section>
<section id="仮想環境について" class="level2">
<h2 class="anchored" data-anchor-id="仮想環境について">仮想環境について</h2>
<p>仮想環境のポイントは、上で書いた通りです。もう少し詳しく書きます。</p>
<p>例えば、3年前のRと現在のRでは、バージョンも利用できるパッケージも大きく異なります。もしRやパッケージを常に最新に保っていた場合、3年前に書いたコードがそのまま期待通りに動作するとは限りません。計算方法が変わっていたり、古い関数が削除されていたりして、過去の研究を再現できない可能性があるのです。</p>
<p>この点、仮想環境では「<strong>バージョンごとに環境を保存する</strong>」ことで問題に対応できます。例えば、あるパッケージの現在のバージョンが1.2.3だとしても、3年後には1.5.4へ更新されているかもしれません。仮想環境を使えば「このプロジェクトではバージョン1.2.3を使用していますよ」とファイルに記録し、後からその環境を再現することができるのです。</p>
<p>こうすることで、研究当時の環境を正確に呼び出せるため、バージョン変更に伴うトラブルを避け、長期的に安定した再現性を確保できます。</p>
<p>ちなみに本ページではRに関してはrenv、Pythonに関してはvenvを使用します。どちらもメジャーな仮想環境であり、これを使えていれば問題ないと思います。</p>
<p>Pythonに関してはcondaなど他のメジャーな仮想環境もありますが、本ページを見てくださっている方であれば個人的にはvenvで十分だと考えています。これは目的にもよりますので、興味がある方は他の仮想環境も調べてみてください。</p>
</section>
<section id="renv" class="level2">
<h2 class="anchored" data-anchor-id="renv">renv</h2>
<p>ではRの方の説明から始めます。</p>
<p>renvは、R プロジェクトごとに使用するパッケージの情報を ロックファイル（<code>renv.lock</code>） に記録し、必要に応じて同じ環境を再現できるようにするパッケージです。このロックファイルが「このパッケージのバージョン1.2.3を使用していますよ」ということを保存しているということですね。</p>
<p>ライブラリはグローバル環境とは分離され、プロジェクト専用のフォルダに保存されます。これにより「どのパッケージを、どのバージョンで使っていたか」が明示され、数年後でも同じ環境を復元することが可能になります。</p>
<p>もし仮想環境を使ったことがない方であれば、今あなたが使っているのがグローバル環境です。グローバル環境でパッケージをアップデートした場合、もれなくすべてのプロジェクトでパッケージのバージョンが更新されます。renvを使用していれば、そのプロジェクトについてだけバージョンが更新されるという仕組みです。</p>
<section id="renvの始め方" class="level3">
<h3 class="anchored" data-anchor-id="renvの始め方">renvの始め方</h3>
<p>始め方は極めて簡単です。</p>
<p>まずはプロジェクトを作成します。プロジェクトとは？という方であれば、RStudioユーザーの方であれば<a href="../../../pages/tips/240515_rproj/index.html">こちら</a>、Positronの方であれば<a href="../../../pages/tips/250901_positron_setting/index.html#project-manager">こちら</a>をご参考になさってください。</p>
<p>そしたらコンソールで以下を実行します。</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb1" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># renvをまだインストールしていない場合は先にこちらを実行</span></span>
<span id="cb1-2"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># install.packages("renv")</span></span>
<span id="cb1-3"></span>
<span id="cb1-4">renv<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">init</span>()</span></code></pre></div></div>
<p>renvを開始する、というわかりやすい関数ですね。するとワーキングディレクトリ内にrenvというフォルダと、<code>.Rprofile</code>、<code>renv.lock</code>ファイルが作成されます。これで設定やらなにやらをしていますので、ファイルは消さないようにしてください。</p>
<p>後は通常通り作業を進めます。パッケージのインストールや、アップデートをしても、それはこのファイル内でのみ適用されます。</p>
</section>
<section id="保存の仕方" class="level3">
<h3 class="anchored" data-anchor-id="保存の仕方">保存の仕方</h3>
<p>作業を一通り終えたら、ロックファイルにパッケージのバージョンを記述しないといけません（もちろん自動でやってくれます）。以下を実行してください。</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb2" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1">renv<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">snapshot</span>()</span></code></pre></div></div>
<p><code>Do you want to proceed? [Y/n]:</code>と出てきたら<code>Y</code>を入力し、<code>- Lockfile written to "~/yo5uke.github.io/renv.lock".</code>と出てきたら保存完了です。</p>
<p>新しいパッケージを追加したらその都度スナップショットを実行してください。ちなみにインストールしただけでは記載の対象にならず、プロジェクト内のコードで使用したパッケージのみ記載されます。この点renvは賢いですよね。</p>
</section>
<section id="環境の呼び出し方" class="level3">
<h3 class="anchored" data-anchor-id="環境の呼び出し方">環境の呼び出し方</h3>
<p>例えばPCを変更して、環境が移ったとします。すると新しい環境ではパッケージが何もインストールされていない状態です。</p>
<p>しかしプロジェクトをGit経由等で新しい環境に移せたら、ロックファイルがありますので、その情報をもとに必要なパッケージをインストールすることが可能です。</p>
<p><code>renv</code>パッケージがインストールされていない場合はしてから、以下の関数を実行します。</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb3" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># install.packages("renv")</span></span>
<span id="cb3-2">renv<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">restore</span>()</span></code></pre></div></div>
<p>これでロックファイル内に記載されているパッケージが、バージョンを保ったまま新しい環境にインストールされます。これで前のPCと同じ環境が再現できるというわけです。</p>
<p>ちなみに新しいPCというわけではなくとも、GitHubにプロジェクトをアップロードしておけば、当然ロックファイルもGitHub上に保存されるわけですので、再度GitHubから引っ張ってくれば、ローカルから一度プロジェクトを削除しても後々再現ができるわけです。これは地味にうれしいですよね。</p>
</section>
<section id="まとめ" class="level3">
<h3 class="anchored" data-anchor-id="まとめ">まとめ</h3>
<p><code>init()</code>、<code>snapshot()</code>、<code>restore()</code>の3つが使えれば、renvを使いこなせていると言えるでしょう。近年は再現可能な研究への需要が高まってきていますから、Rユーザーの方はぜひrenvを使ってみてください。</p>
</section>
</section>
<section id="venv" class="level2">
<h2 class="anchored" data-anchor-id="venv">venv</h2>
<p>Pythonは少々ややこしいと個人的に感じています<sup>1</sup>。</p>
<p>renvはR上で完結する一方、venvはPowerShellないしコマンドプロンプトを使う必要があるからです<sup>2</sup>。</p>
<p>それでは改めてvenvについて説明します。</p>
<p>venvは<code>Python</code>に標準で付属している仮想環境ツールで、プロジェクトごとに独立したパッケージ環境を作成できます。</p>
<p>venvで作成した環境はプロジェクト内の<code>.venv</code>フォルダに保存され、そこにPython本体や必要なライブラリがインストールされます。そのため、システム全体のPythonに影響を与えることなく、プロジェクトごとにライブラリのバージョンを固定できます。</p>
<p>さらに、<code>requirements.txt</code>というファイルを用いれば、使用しているライブラリとそのバージョンを記録し、他の人や別の環境でも同じ構成を再現できます。これはRの<code>renv.lock</code>に相当する役割です。</p>
<section id="sec-init-venv" class="level3">
<h3 class="anchored" data-anchor-id="sec-init-venv">venvの始め方</h3>
<p>それではvenv環境を作る手順に移ります。</p>
<p>VSCodeもしくはPositronの場合、まずプロジェクト（ワークスペース）を開いたのち、<code>Ctrl</code> + <code>Shift</code> + <code>@</code>でターミナルを開きます。</p>
<p>開けたら、以下を入力して実行します。</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb4" style="background: #f1f3f5;"><pre class="sourceCode sh code-with-copy"><code class="sourceCode bash"><span id="cb4-1"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">python</span> <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">-m</span> venv .venv</span></code></pre></div></div>
<p>これは独立したPython環境を<code>.venv</code>というフォルダに作るということを意味しており、<code>.venv</code>という名前で作成すると、VSCodeやPositronが自動的に「これを仮想環境だな」と認識し、インタープリタの候補に出してくれるので必須ではないですがおすすめです<sup>3</sup>。</p>
<p>しかし、環境を作るだけでは自動でアクティベートされません（最初は自動で起動しないということです）。</p>
<p>VSCodeの場合方法は2つあります。1つ目は簡単で、ターミナルを新しくするということです。ターミナルの右上に<code>+</code>ボタンがありますので、これを押して新しいターミナルを開きます。すると以下のような表示が出ますので、これでアクティベートされています。</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://yo5uke.com/pages/tips/250926_virtual_environment/image/activate_vscode.png" class="img-fluid figure-img"></p>
<figcaption>VSCodeのターミナル</figcaption>
</figure>
</div>
<p>頭に<code>(.venv)</code>と表示されていれば、アクティベートされています。</p>
<p>2つ目は、1つ目の方法でうまくいかなかったときにも有効な方法で、ターミナルに以下を打ち込んで実行します。</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb5" style="background: #f1f3f5;"><pre class="sourceCode sh code-with-copy"><code class="sourceCode bash"><span id="cb5-1"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">.venv/Scripts/activate</span></span></code></pre></div></div>
<p>これでアクティベートされます<sup>4</sup>。上の画像と同じ表示になると思いますのでご確認ください。</p>
<p>Positronの場合は、ウィンドウ右上の「R 4.5.1」や「Python 3.13.7」と表示があるところからインタープリタを選択します。</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://yo5uke.com/pages/tips/250926_virtual_environment/image/venv_positron.gif" class="img-fluid figure-img"></p>
<figcaption>Positronのイメージ</figcaption>
</figure>
</div>
<p>「Venv: .venv」とあるものを選択すればvenv環境に移れます。こちらは簡単ですね。</p>
<p>ちなみに少し細かい話をすると、<code>.venv</code>は容量が大きい一方で、環境の再現自体は<code>requirements.txt</code>のみで担保できるため、Gitには保存せず<code>.gitignore</code>に<code>.venv/</code>と記載しておくのがよいと思います。そのため、後述しますが新しい環境では再度venv環境を作成してください。</p>
</section>
<section id="保存の仕方-1" class="level3">
<h3 class="anchored" data-anchor-id="保存の仕方-1">保存の仕方</h3>
<p>保存もターミナル上で行います（Pythonのコンソールではありません）。</p>
<p>ターミナルで以下を実行します。</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb6" style="background: #f1f3f5;"><pre class="sourceCode sh code-with-copy"><code class="sourceCode bash"><span id="cb6-1"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">pip</span> freeze <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span> requirements.txt</span></code></pre></div></div>
<p>これは先述の通り、<code>requirements.txt</code>というファイルにパッケージ名とバージョンを保存します。まさにロックファイルと同じような感じですが、中身を見てみると、<code>polars==1.33.1</code>のように、非常にシンプルな形で記載されています。</p>
<p>作業が終わったら、適宜保存してください。</p>
</section>
<section id="パッケージの呼び出し方" class="level3">
<h3 class="anchored" data-anchor-id="パッケージの呼び出し方">パッケージの呼び出し方</h3>
<p>R同様、新しい環境に移行したら、この<code>requirements.txt</code>ファイルからパッケージをバージョンごと再現する必要があります。</p>
<p>新しい環境だとまだ<code>.venv</code>が存在しないと思うので、前と同じ方法でvenv環境を作成したのち、<code>renv::restore()</code>と同じような働きをする以下のコマンドを実行します。</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb7" style="background: #f1f3f5;"><pre class="sourceCode sh code-with-copy"><code class="sourceCode bash"><span id="cb7-1"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">pip</span> install <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">-r</span> requirements.txt</span></code></pre></div></div>
<p><code>-r</code>は「ファイルに書かれたリストを読む」という意味で、これでファイル内に記載されているパッケージがまとめてインストールできます。</p>
</section>
<section id="まとめ-1" class="level3">
<h3 class="anchored" data-anchor-id="まとめ-1">まとめ</h3>
<p>renvよりはやや複雑ですが、ターミナル上で仮想環境の作成から再現まで行うことができます。必要なのは以下の3つです。</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb8" style="background: #f1f3f5;"><pre class="sourceCode sh code-with-copy"><code class="sourceCode bash"><span id="cb8-1"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">python</span> <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">-m</span> venv .venv</span>
<span id="cb8-2"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">pip</span> freeze <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span> requirements.txt</span>
<span id="cb8-3"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">pip</span> install <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">-r</span> requirements.txt</span></code></pre></div></div>
</section>
</section>
<section id="まとめ-2" class="level2">
<h2 class="anchored" data-anchor-id="まとめ-2">まとめ</h2>
<p>今回は仮想環境のrenvとvenvについて簡単にご紹介しました。簡単にとはいうものの、エンジニアでもなければこれで十分ではないかと思っています。</p>
<p>仮想環境を活用しながら、再現可能な研究を進めていきましょう！</p>
<p>（余談：サムネイルの設定をミスったのですが、でかでかと<code>.venv</code>が表示されたので、これで良しとします！）</p>


<!-- -->

</section>


<div id="quarto-appendix" class="default"><section id="footnotes" class="footnotes footnotes-end-of-document"><h2 class="anchored quarto-appendix-heading">注</h2>

<ol>
<li id="fn1"><p>Pythonはまだ勉強中ということもあり、マスターすれば大したことはないのかもしれません。↩︎</p></li>
<li id="fn2"><p>Macユーザーの方へは十分な説明になっていないかもしれませんが、ターミナルを使うことになると思います。↩︎</p></li>
<li id="fn3"><p>インタープリタというのは、使用するPythonのバージョンのようなイメージです。PCにインストールしたグローバルなPython環境と、venv環境がこの場合の選択肢です。↩︎</p></li>
<li id="fn4"><p><code>.venv</code>とは異なるフォルダ名で作成した場合はその名前に変えてください。↩︎</p></li>
</ol>
</section></div> ]]></description>
  <category>R</category>
  <category>Python</category>
  <category>VSCode</category>
  <category>Positron</category>
  <guid>https://yo5uke.com/pages/tips/250926_virtual_environment/</guid>
  <pubDate>Thu, 25 Sep 2025 15:00:00 GMT</pubDate>
  <media:content url="https://yo5uke.com/pages/tips/thumbnail/thumbnail.jpg" medium="image" type="image/jpeg"/>
</item>
<item>
  <title>DuckDBをRで使う</title>
  <link>https://yo5uke.com/pages/tips/250919_duckdb/</link>
  <description><![CDATA[ 

<div class="social-share-buttons">

  <!-- Twitter (X) -->

  <a href="" id="js-share-twitter" class="share_button ri--twitter-x-fill" target="_blank" rel="nofollow noopener noreferrer"></a>



  <!-- Bluesky -->

  <a href="" id="js-share-bluesky" class="share_button ri--bluesky-fill" target="_blank" rel="nofollow noopener noreferrer"></a>

</div>



<script>

  const twitterUsername = "@5uke_y";

  const blueskyUsername = "@5uke.bsky.social";



  const share_url = encodeURIComponent(location.href);

  const share_title = document.title;



  // Twitter (X)

  document.getElementById('js-share-twitter').setAttribute(

    "href",

    "https://twitter.com/share?url=" + share_url + "&text=" + share_title + " " + encodeURIComponent(twitterUsername) + " より" +

    "&hashtags=rstats"

  );



  // Bluesky

  document.getElementById('js-share-bluesky').setAttribute(

    "href",

    "https://bsky.app/intent/compose?text=" + share_title + " " + share_url + " " + encodeURIComponent(blueskyUsername) + " より"

  );

</script>






<section id="はじめに" class="level2">
<h2 class="anchored" data-anchor-id="はじめに">はじめに</h2>
<p>Rで大量のデータを扱う際、メモリ制限やパフォーマンスの問題に直面することがあります。そんなとき、軽量で高速な組み込み型のデータベースであるDuckDBを利用することで、効率的にデータ操作が可能になります。本記事では、RでDuckDBを使用する方法について解説します。</p>
</section>
<section id="duckdbとは" class="level2">
<h2 class="anchored" data-anchor-id="duckdbとは">DuckDBとは</h2>
<p>DuckDBは、組み込み型のSQLデータベースであり、特に分析ワークロードに最適化されています。SQLiteのように軽量でありながら、大規模なデータセットを効率的に処理できる点が特徴です。DuckDBは、列指向ストレージを採用しており、分析クエリのパフォーマンスが向上します。</p>
<p>ちなみに組み込み型データベースとは、アプリケーションに組み込まれて動作するデータベースのことを指します。サーバー型のデータベースとは異なり、外部のデータベースサーバーを必要とせず、アプリケーション内で直接データベース操作が可能です。すなわちR上で完結するということです。</p>
<p>列指向については、ブログでparquetを扱った際に少し触れています。以下もご覧ください。簡潔に言うと、列指向データベースは、データを列ごとに格納するため、特定の列に対するクエリが高速に処理されるという特徴があります。</p>
<div class="callout callout-style-simple callout-tip no-icon">
<div class="callout-body d-flex">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-body-container">
<p><a href="../../../pages/blog/250728_parquet/index.html">Parquetファイルについて調べてみる</a></p>
</div>
</div>
</div>
</section>
<section id="duckdbのインストール" class="level2">
<h2 class="anchored" data-anchor-id="duckdbのインストール">DuckDBのインストール</h2>
<p>DuckDBをRで使用するには、<code>duckdb</code>パッケージをインストールします。</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb1" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># install.packages("pak")</span></span>
<span id="cb1-2">pak<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">pak</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"duckdb"</span>)</span></code></pre></div></div>
</div>
<p>もしくは</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb2" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">install.packages</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"duckdb"</span>)</span></code></pre></div></div>
</div>
</section>
<section id="duckdbの基本的な使い方" class="level2">
<h2 class="anchored" data-anchor-id="duckdbの基本的な使い方">DuckDBの基本的な使い方</h2>
<section id="データベースへの接続" class="level3">
<h3 class="anchored" data-anchor-id="データベースへの接続">データベースへの接続</h3>
<p>まずは、DuckDBデータベースに接続します。以下のコードでは、メモリ内データベースに接続していますが、ファイルベースのデータベースを使用することも可能です。</p>
<p>メモリ内データベースはRセッションが終了すると消えてしまいますが、ファイルベースのデータベースは永続的に保存されます。</p>
<p>ファイルベースのデータベースではディスクにデータが保存されるため、Rセッションを終了してもデータが保持されます。一方、メモリ内データベースはRセッションが終了するとデータが失われてしまいますが、読み書きの速度が速いという利点があります。</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb3" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(duckdb)</span></code></pre></div></div>
</div>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb4" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># メモリ内データベースに接続</span></span>
<span id="cb4-2">con <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">dbConnect</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">duckdb</span>(), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">dbdir =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">":memory:"</span>)</span></code></pre></div></div>
</div>
<p>ファイルベースのデータベースに接続する場合は、以下のようにします。</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb5" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># ファイルベースのデータベースに接続</span></span>
<span id="cb5-2">con <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">dbConnect</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">duckdb</span>(), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">dbdir =</span> here<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">here</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"data/iris.duckdb"</span>))</span></code></pre></div></div>
</div>
<p>この方法だと、<code>data</code>フォルダに<code>iris.duckdb</code>という名前でデータベースファイルが作成されます。<code>.duckdb</code>ファイルを置くパスは自由に変更してください。</p>
</section>
<section id="データの読み込み" class="level3">
<h3 class="anchored" data-anchor-id="データの読み込み">データの読み込み</h3>
<section id="sqlを使う場合" class="level4">
<h4 class="anchored" data-anchor-id="sqlを使う場合">SQLを使う場合</h4>
<p>DuckDBは様々なデータ形式をサポートしています。ここでは、CSVファイルを読み込む例を示します。</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb6" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># CSVファイルを読み込む</span></span>
<span id="cb6-2"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">dbExecute</span>(con, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"CREATE TABLE iris AS SELECT * FROM read_csv('data/iris.csv')"</span>)</span></code></pre></div></div>
</div>
<p>さて、ここで突然SQL文が出てきましたが、なんとなく単語を見てもらえればわかる通り、<code>read_csv('data/iris.csv')</code>から全ての列を選択（<code>*</code>は全ての列を意味します）して、<code>iris</code>という名前のテーブルを作成（<code>CREATE TABLE iris AS</code>）しています。</p>
<p>ちなみに、僕はSQLはあまりわかりません。いちいち調べないと先ほどのコードも書けないレベルなのですが、この方法をとるメリットを先に説明しておきます。</p>
<p>この方法のメリットは、<strong>Rに一度もデータを読み込まずに、DuckDBが直接CSVファイルを処理できる</strong>点です。 そのため、大規模なCSVでもメモリを無駄に消費せず、高速にテーブルを作成できます。</p>
<p>また、<code>CREATE TABLE ... AS SELECT ...</code>という形で書けば、SQLの標準的な構文で柔軟に前処理（列の選択やフィルタリングなど）を行いながら、テーブルを作成できます。</p>
</section>
<section id="rを使う場合" class="level4">
<h4 class="anchored" data-anchor-id="rを使う場合">Rを使う場合</h4>
<p>とはいえ新しくSQLを覚えるのは面倒だしRで書けたらうれしいという僕なので、ここでRを使うことの意義を示します。</p>
<p>それは、今提示したコードを皆さんおなじみ<code>dplyr</code>を使って実行できる、ということです。</p>
<p>それはすなわち<code>dplyr</code>を使って書いたコードをSQLに変換して実行してくれるということを意味しています。</p>
<p>データベースやSQLはなんだかよくわからないけれども、<code>dplyr</code>が使えるならうれしいですよね<sup>1</sup>。</p>
<p>その場合のコードを見てみましょう。</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb7" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(tidyverse)  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># `dplyr`だけでもOKです。</span></span></code></pre></div></div>
</div>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb8" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb8-1">iris_data <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">read_csv</span>(here<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">here</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"data/iris.csv"</span>))</span>
<span id="cb8-2"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">duckdb_register</span>(con, iris, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"iris_data"</span>)</span></code></pre></div></div>
</div>
<p>まずはデータベースに入れたいデータを<code>read_csv()</code>で読み込みます。ここでは<code>data</code>フォルダにある<code>iris.csv</code>を読み込んでいます。</p>
<p>続いて<code>duckdb_register()</code>を使って、<code>iris_data</code>を<code>iris</code>という名前でデータベースに登録しています。これでデータベース上に<code>iris</code>テーブルが作成されました。</p>
<p>ちなみにファイルベースのデータベースを使いたい場合は、<code>duckdb_register()</code>の代わりに<code>dbWriteTable()</code>を使います。</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb9" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb9-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">dbWriteTable</span>(con, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"iris"</span>, iris_data)</span></code></pre></div></div>
</div>
<p>これで<code>.duckdb</code>ファイルに<code>iris</code>テーブルが保存されます。</p>
<p>ちなみに、データベースにはテーブルを複数作成できるので、<code>iris</code>以外のデータもも好きな名前でテーブルを追加できます<sup>2</sup>。</p>
</section>
</section>
<section id="データの操作" class="level3">
<h3 class="anchored" data-anchor-id="データの操作">データの操作</h3>
<p>ところで、データベースを使うメリットのひとつに、遅延評価（lazy evaluation） があります。これは、実際に結果を取り出すまでSQLが実行されない仕組みのことです。</p>
<p>通常のデータ処理は<br>
データの読み込み → 書いた順に処理を実行 → 結果を返す<br>
という流れですが、遅延評価では<br>
データの読み込み → 書いた順に処理を記録 → 最後にまとめて実行（SQL発行） → 結果を返す<br>
という流れになります。</p>
<p>このおかげで、大規模なデータセットでも不要な計算が省かれ、効率的に処理できます。</p>
<section id="sqlを使う場合-1" class="level4">
<h4 class="anchored" data-anchor-id="sqlを使う場合-1">SQLを使う場合</h4>
<p>SQLを使ってデータを操作する場合、以下のようにクエリを実行します。</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb10" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb10-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># データをクエリする</span></span>
<span id="cb10-2">result <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">dbGetQuery</span>(con, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"SELECT * FROM iris WHERE Species = 'setosa'"</span>)</span></code></pre></div></div>
</div>
<p>この例では、<code>iris</code>テーブルから<code>Species</code>が<code>setosa</code>の行を選択しています。</p>
</section>
<section id="dplyrを使う場合" class="level4">
<h4 class="anchored" data-anchor-id="dplyrを使う場合"><code>dplyr</code>を使う場合</h4>
<p><code>dplyr</code>を使ってデータを操作する場合、以下のように記述します（おなじみの感じですね）。</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb11" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb11-1">result <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">tbl</span>(con, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"iris"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb11-2">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">filter</span>(Species <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"setosa"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb11-3">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">collect</span>()</span></code></pre></div></div>
</div>
<p><code>tbl(con, "iris")</code>でデータベース上の<code>iris</code>テーブルを参照し、<code>filter()</code>で条件を指定しています。最後に<code>collect()</code>を使って結果をRのデータフレームとして取得します。</p>
<p>ここで重要なのは、<strong><code>collect()</code>を呼び出すまではSQLは実行されない</strong>という点です。<code>filter()</code>などの処理を追加するたびに、裏でSQLクエリが少しずつ組み立てられていき、最後に<code>collect()</code>を呼び出した時点でまとめて実行されます。</p>
<p>つまり、<code>collect()</code>を呼び出すまではデータはRに読み込まれず、操作はあくまで「SQLを組み立てているだけ」です。<code>collect()</code>を実行した瞬間に初めてSQLが発行され、結果がRにデータフレームとして取り込まれます。</p>
<p>データベースになじみがない方は違和感があるかもしれませんが（かく言う僕もですが）、<code>con</code>自体はデータそのものではなく、DuckDBデータベースへの接続（コネクション）を表すオブジェクトです。</p>
<p>普段のRではデータフレームを直接操作しますが、ここではまず接続オブジェクト<code>con</code>を通して「このデータベースの中にあるテーブルを参照しますよ」という指示を出します。</p>
<p>つまり、<code>con</code>はデータの実体ではなく、<strong>「データベースへの窓口」や「リモコン」</strong>のようなものと考えると分かりやすいです（ChatGPT曰く）。</p>
<p>とりあえず、<code>collect()</code>の前までは通常のデータ処理と同じように<code>dplyr</code>の関数を使って操作できるので、慣れ親しんだ方法でデータを扱うことができます。</p>
</section>
</section>
<section id="テーブルの削除" class="level3">
<h3 class="anchored" data-anchor-id="テーブルの削除">テーブルの削除</h3>
<p>追加したテーブルを削除する場合は、以下のようにします。</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb12" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb12-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">dbExecute</span>(con, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"DROP TABLE iris"</span>)</span></code></pre></div></div>
</div>
<p>これで<code>iris</code>テーブルがデータベースから削除されます。</p>
<p>もし安全に削除したい場合は、</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb13" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb13-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">dbExecute</span>(con, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"DROP TABLE IF EXISTS iris"</span>)</span></code></pre></div></div>
</div>
<p>とすることで、テーブルが存在しない場合でもエラーにならずに処理を続行できます。</p>
</section>
<section id="データベースからの切断" class="level3">
<h3 class="anchored" data-anchor-id="データベースからの切断">データベースからの切断</h3>
<p>データベースの操作が終わったら、接続を切断します。</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb14" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb14-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">dbDisconnect</span>(con, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">shutdown =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">TRUE</span>)</span></code></pre></div></div>
</div>
<p><code>shutdown = TRUE</code>を指定すると、メモリ内データベースの場合はデータが消去され、ファイルベースのデータベースの場合は接続が閉じられます。</p>
</section>
</section>
<section id="まとめ" class="level2">
<h2 class="anchored" data-anchor-id="まとめ">まとめ</h2>
<p>今回は、RでDuckDBを使用する方法についてまとめました。</p>
<p>DuckDBは軽量で高速な組み込み型データベースであり、大規模なデータセットを効率的に処理できます。SQLを直接使う方法と、<code>dplyr</code>を使う方法の両方が利用可能であり、遅延評価によりパフォーマンスが向上します。</p>
<p>最近は仕事ででかいデータを扱うことが増えてきたので、今後もDuckDBを活用していきたいと思います（というか活用し始めています）。ぜひ試しあれ。</p>
</section>
<section id="参考" class="level2">
<h2 class="anchored" data-anchor-id="参考">参考</h2>
<div class="callout callout-style-simple callout-tip no-icon">
<div class="callout-body d-flex">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-body-container">
<p><a href="https://duckdb.org/docs/stable/clients/r.html">R Client - DuckDB</a></p>
</div>
</div>
</div>


<!-- -->

</section>


<div id="quarto-appendix" class="default"><section id="footnotes" class="footnotes footnotes-end-of-document"><h2 class="anchored quarto-appendix-heading">注</h2>

<ol>
<li id="fn1"><p>ただ、先ほどのメリットの裏返しで、一度R上でデータを読み込んでからデータベースに送り込むことになるので、メモリを多く消費することと、データが大きいと処理速度が遅くなることには注意してください。↩︎</p></li>
<li id="fn2"><p>とはいえ、プロジェクトごとなどで<code>.duckdb</code>は分けた方が良いとは思います。↩︎</p></li>
</ol>
</section></div> ]]></description>
  <category>R</category>
  <category>SQL</category>
  <category>データ処理</category>
  <guid>https://yo5uke.com/pages/tips/250919_duckdb/</guid>
  <pubDate>Thu, 18 Sep 2025 15:00:00 GMT</pubDate>
</item>
<item>
  <title>Positronのおすすめ設定！【R | Python】</title>
  <link>https://yo5uke.com/pages/tips/250901_positron_setting/</link>
  <description><![CDATA[ 

<div class="social-share-buttons">

  <!-- Twitter (X) -->

  <a href="" id="js-share-twitter" class="share_button ri--twitter-x-fill" target="_blank" rel="nofollow noopener noreferrer"></a>



  <!-- Bluesky -->

  <a href="" id="js-share-bluesky" class="share_button ri--bluesky-fill" target="_blank" rel="nofollow noopener noreferrer"></a>

</div>



<script>

  const twitterUsername = "@5uke_y";

  const blueskyUsername = "@5uke.bsky.social";



  const share_url = encodeURIComponent(location.href);

  const share_title = document.title;



  // Twitter (X)

  document.getElementById('js-share-twitter').setAttribute(

    "href",

    "https://twitter.com/share?url=" + share_url + "&text=" + share_title + " " + encodeURIComponent(twitterUsername) + " より" +

    "&hashtags=rstats"

  );



  // Bluesky

  document.getElementById('js-share-bluesky').setAttribute(

    "href",

    "https://bsky.app/intent/compose?text=" + share_title + " " + share_url + " " + encodeURIComponent(blueskyUsername) + " より"

  );

</script>






<section id="はじめに" class="level2">
<h2 class="anchored" data-anchor-id="はじめに">はじめに</h2>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center collapsed" data-bs-toggle="collapse" data-bs-target=".callout-1-contents" aria-controls="callout-1" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
<span class="screen-reader-only">Note</span>ユーザー設定とワークスペース設定
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-1" class="callout-1-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<p>Positron（VSCode）にはユーザー設定とワークスペース設定があります。ユーザー設定はプロジェクトに依らずPositron全体に適用される設定で、ワークスペース設定は特定のワークスペース（フォルダ）にのみ適用される設定です。</p>
<p>本ページで何回か設定をいじる場面があります。全体に適用したい場合は設定を開いたのち検索窓の下にある「ユーザー」を選択したうえで設定を進め、特定のプロジェクトにのみ適用したい場合はプロジェクトを開き「ワークスペース」を選択してから設定を進めてください。</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://yo5uke.com/pages/tips/250901_positron_setting/image/setting_user_workspace.png" class="img-fluid figure-img" style="width:50.0%"></p>
<figcaption>ユーザーとワークスペースの切り替え</figcaption>
</figure>
</div>
</div>
</div>
</div>
<p>9月に入りましたが引き続き暑いですね。オフィスにこもってパソコンをカタカタしているのでまだましですが、たまに外へ出ると秋はいつ来るのかと、考えてしまいます…。</p>
<p>ところで、僕はと言えば最近も仕事でRを使う機会が多いのですが、最近はRStudioではなくPositronを主に使うようにしています。理由はシンプルで、新しいものが好きだからです。</p>
<p>VSCodeをベースに作られていることもあり、なんとなく敬遠していたのですが（RStudioユーザーがVSCodeで満足のいくRの環境を整えるのは一苦労なので…）、RStudioのキーボードショートカットが使えることに気づいたり、レイアウトを変更できることも知れたりと、ようやく新しい環境を試せそう！と思い立って一気に設定を終わらせた次第です<sup>1</sup>。</p>
<p>今回は個人的に満足がいっている設定をピックアップしてまとめていこうと思います。</p>
<p>この記事は適宜更新する予定です。</p>
</section>
<section id="positronとは" class="level2">
<h2 class="anchored" data-anchor-id="positronとは">Positronとは？</h2>
<p>そもそもPositronとは何なんだという方もいらっしゃることを想定し、ごく簡単にPositronについてまとめます。</p>
<p>PositronはPosit社（旧RStudio社）が開発している統合開発環境（IDE）で、VSCodeをベースに作られており、RとPythonのために最適化されているのが特徴です。</p>
<p>従来のVSCodeにおけるRの使い勝手はあまりよくないと個人的に感じており、例えばRStudioで使い慣れたキーボードショートカットを自分で設定しなければいけなかったり、環境変数（格納したデータ等）が見にくかったりしていましたが、PositronではRStudioの要素も取り入れつつ、これまでRStudioを使用していたユーザーにとって移行しやすいコーディング環境が提供されています<sup>2</sup>。</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://yo5uke.com/pages/tips/250901_positron_setting/image/positron.png" class="img-fluid figure-img"></p>
<figcaption>設定をいじっているのでデフォルトとは異なっています</figcaption>
</figure>
</div>
<p>Positronの画面はこんな感じで、右上の「R 4.5.1」の部分からPythonへの切り替えも可能です。</p>
<p>デフォルトでは下にコンソール、右上に変数とデフォルトのRStudioと同じ構成になっているのですが、このあたりの設定についてもこれから書いていきます。</p>
<p>インストールについては書きませんが、以下からダウンロードできます。</p>
<p><a href="https://positron.posit.co/download.html">Download Positron</a></p>
<p>Windowsの方であれば一番上のをダウンロードすればよいと思います。</p>
</section>
<section id="キーボードショートカットの設定" class="level2">
<h2 class="anchored" data-anchor-id="キーボードショートカットの設定">キーボードショートカットの設定</h2>
<section id="rstudioからの移行" class="level3">
<h3 class="anchored" data-anchor-id="rstudioからの移行">RStudioからの移行</h3>
<p>まずRStudioからの移行を検討する場合、やはりキーボードショートカットは引き続き使えた方が良いですよね。</p>
<p>画面左下歯車マークから「設定」を開きます。すると設定画面が出てきますので、上部に出てきた「設定の検索」窓に「workbench.keybindings.rstudioKeybindings」と入力します（ぜひコピペしてくださいね）。</p>
<p>すると設定が1つヒットし、チェックボックスにはチェックが入っていない状況かと思います。</p>
<p>そこにチェックを入れ、確認出来たら上部の×印から設定を閉じます。再起動が必要ですので、一度Positronを閉じてから再度開いてください。これで基本的なRStudioのキーボードショートカットが使えるようになります。</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://yo5uke.com/pages/tips/250901_positron_setting/image/rstudio_key_binding.png" class="img-fluid figure-img"></p>
<figcaption>この項目にチェックを入れてください</figcaption>
</figure>
</div>
</section>
<section id="地味にイヤな設定の解消" class="level3">
<h3 class="anchored" data-anchor-id="地味にイヤな設定の解消">地味にイヤな設定の解消</h3>
<div class="callout callout-style-default callout-caution callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
<span class="screen-reader-only">Caution</span>Macユーザーの方へ
</div>
</div>
<div class="callout-body-container callout-body">
<p>ここではWindowsのキーに基づいて説明しています。Macの方は適宜キーを置き換えながら読み進めてください。Macの正しいキーについて存じ上げず、申し訳ありません。</p>
</div>
</div>
<p>続いて、地味に困ったのがQuarto Markdownにおけるチャンク挿入についてです<sup>3</sup>。</p>
<p>RStudio上ではチャンク（```{r}で始まるコードブロック）を挿入する際に<span class="visually-hidden">Ctrl-Alt-I</span>でチャンクを挿入できるわけなのですが、これはカーソルを置いている位置から始まります。カーソルを置いているその行に```{r}が挿入されるということです。</p>
<p>しかしPositronでは、その行を空行にしたうえで、1行下に挿入される設定になっています。気にされないようであれば放置でよいのですが、僕は気になってしまったので、修正することにしました。</p>
<p>先ほどと同様画面左下歯車マークから「キーボードショートカット」（キーボードを使う場合<span class="visually-hidden">Ctrl-K+Ctrl-S</span>）を開きます。</p>
<p>するとキーボードショートカットに関する設定がずらーっと出てきますが、出てきた画面右上の「キーボードショートカットを開く（JSON）」というアイコンをクリックして開きます。</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://yo5uke.com/pages/tips/250901_positron_setting/image/keyboard_shortcut.png" class="img-fluid figure-img"></p>
<figcaption>赤で示した部分です</figcaption>
</figure>
</div>
<p>すると<code>// 既定値を上書きするには、このファイル内にキー バインドを挿入します</code>という文言とともに<code>[ ]</code>があると思います。</p>
<p>初期段階では何も記載されていないと思いますが、この中に以下を記述します（<code>[ ]</code>は一応表示しています）。</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb1" style="background: #f1f3f5;"><pre class="sourceCode json code-with-copy"><code class="sourceCode json"><span id="cb1-1"><span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">[</span></span>
<span id="cb1-2">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb1-3">    <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">"key"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">:</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"ctrl+alt+i"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb1-4">    <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">"command"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">:</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"editor.action.insertSnippet"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb1-5">    <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">"when"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">:</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"editorTextFocus &amp;&amp; editorLangId == 'quarto'"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb1-6">    <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">"args"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">:</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb1-7">      <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">"snippet"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">:</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"```{r}</span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">\n</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">$0</span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">\n</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">```</span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">\n</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span></span>
<span id="cb1-8">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb1-9">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb1-10"><span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">]</span></span></code></pre></div></div>
<p>これでデフォルトの設定が上書きされ、<span class="visually-hidden">Ctrl-Alt-I</span>でチャンクを挿入すると、カーソルを置いている行に直接チャンクが挿入されるようになります。</p>
<p>ちなみに、この設定だとRのチャンクが強制的に挿入されるので、Pythonも使う方は困る！と思うかもしれません。</p>
<p>そのような方には、同じ書き方で<span class="visually-hidden">Ctrl-Shift-I</span>を使ってPythonのチャンクを挿入するようにするのがおすすめです。そもそもPositronではデフォルトのチャンク挿入が<span class="visually-hidden">Ctrl-Shift-I</span>（<span class="visually-hidden">Alt</span>ではなく）であるため、もしRとPythonしか使わないのであれば、これをPython専用のショートカットにしてしまうのがよいのではないでしょうか。</p>
<p>上の設定に書き足す形で、カンマで区切った後ろに以下のように記述します。</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb2" style="background: #f1f3f5;"><pre class="sourceCode json code-with-copy"><code class="sourceCode json"><span id="cb2-1"><span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">[</span></span>
<span id="cb2-2">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb2-3">    <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">"key"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">:</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"ctrl+alt+i"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb2-4">    <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">"command"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">:</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"editor.action.insertSnippet"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb2-5">    <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">"when"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">:</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"editorTextFocus &amp;&amp; editorLangId == 'quarto'"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb2-6">    <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">"args"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">:</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb2-7">      <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">"snippet"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">:</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"```{r}</span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">\n</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">$0</span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">\n</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">```</span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">\n</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span></span>
<span id="cb2-8">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb2-9">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">}</span><span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb2-10"></span>
<span id="cb2-11">  <span class="er" style="color: #AD0000;
background-color: null;
font-style: inherit;">//</span> <span class="er" style="color: #AD0000;
background-color: null;
font-style: inherit;">ここから追記</span></span>
<span id="cb2-12">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb2-13">    <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">"key"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">:</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"ctrl+shift+i"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb2-14">    <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">"command"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">:</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"editor.action.insertSnippet"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb2-15">    <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">"when"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">:</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"editorTextFocus &amp;&amp; editorLangId == 'quarto'"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb2-16">    <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">"args"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">:</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb2-17">      <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">"snippet"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">:</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"```{python}</span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">\n</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">$0</span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">\n</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">```</span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">\n</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span></span>
<span id="cb2-18">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb2-19">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb2-20"><span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">]</span></span></code></pre></div></div>
<p>これで<span class="visually-hidden">Ctrl-Shift-I</span>をPython専用のショートカットに変更できました。やっていることはキーとスニペットを変えているだけで、他は一緒です。</p>
</section>
</section>
<section id="レイアウトの設定" class="level2">
<h2 class="anchored" data-anchor-id="レイアウトの設定">レイアウトの設定</h2>
<p>これは個人の好みが大きく、僕がマイナーであることもわかっているので共感いただけないかもしれませんが、僕はコードとコンソールは縦に並べたいタイプの人間です。</p>
<p>特にPositronではRStudioと違って、R MarkdownやQuartoを使っている際にチャンクの下に結果が表示されませんので、コンソールを見えるようにしておくことが重要です。縦に並べてしまうと表示できるスペースが狭く、見にくいため左右並べる設定にします。</p>
<p>また、左右に並べる以外の設定も選択肢がありますので、いろいろ試してみて気に入ったものにしてみてください。</p>
<p>まず、左下の歯車から「コマンドパレット」、あるいは<span class="visually-hidden">Ctrl-Shift-P</span>を入力します。</p>
<p>表示された画面上部の検索窓に「customize layout」と入力します。すると1件ドンピシャでヒットすると思いますので、それをクリックします。</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://yo5uke.com/pages/tips/250901_positron_setting/image/layout.png" class="img-fluid quarto-figure quarto-figure-center figure-img"></p>
</figure>
</div>
<p>いろいろな選択肢が出てきますが、デフォルトでは1番上の「Stacked Layout」です。</p>
<p>僕はコンソールを右に持っていきたいという考えから、2番目の「Side-By-Side Layout」を選択しています。同じ手順で元に戻せますので、いろいろ選択してみてください。</p>
<p>ちなみにSide-By-Sideを選択しただけだと、VARIABLESは右側に配置されています。これを僕はスクリプト画面の下に持ってきているのですが、その方法はドラッグするという原始的な方法です。</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://yo5uke.com/pages/tips/250901_positron_setting/image/replace_variables.gif" class="img-fluid quarto-figure quarto-figure-center figure-img"></p>
</figure>
</div>
<p>（2025/09/25追記）Variablesを左下に移す設定をしていましたが、右側をフルでコンソールにする必要性はないかなと思うようになってきたので右側の上半分をコンソールにし、下半分にVariablesを置くことが増えてきました。プロットをあまりしなくなったことが影響しているかもしれません…。プロットをたくさんする方は前述の設定あるいはデフォルト設定の方がスペースを有効活用できるかもしれません。</p>
</section>
<section id="project-manager" class="level2">
<h2 class="anchored" data-anchor-id="project-manager">Project Manager</h2>
<p>皆さんはR Projectを使用しているでしょうか。再現可能な研究のための1つのツールにR Projectがあります。ここではそれそのものについて詳しくは書きませんが<sup>4</sup>、PositronにはR Projectと同様のシステムがありません。</p>
<p>そこでPositron（VSCodeもですが）では、拡張機能を使用してプロジェクト管理を行います。</p>
<p>ざっくりR Projectは<code>.Rproj</code>ファイルを作成し、そのファイルが認識されることでそこをワーキングディレクトリとして設定し、<code>here::here()</code>をはじめとした相対パスを使用できるようになり、効率的なプロジェクト管理が可能になります。</p>
<p>前述のようにPositronでは<code>.Rproj</code>ファイルは作成できず、代わりにワークスペースを設定することでプロジェクト管理を行います。</p>
<p>このワークスペースとは一体何かと言えば「Positron内でワーキングディレクトリとなるフォルダを開く」ことに他ならないのですが、つまるところ<code>.Rproj</code>をダブルクリックしてそのフォルダをRStudioで開くのと同様に、そのフォルダをIDE上で「開く」ことが重要なのです。</p>
<p>ではどうやってそのフォルダを開けばよいのか。それを解決してくれるのが「Project Manager」という拡張機能です。</p>
<p>Positronの左にあるサイドバーから拡張機能のアイコンを開き、検索窓から「alefragnani.project-manager」と検索してください<sup>5</sup>。</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://yo5uke.com/pages/tips/250901_positron_setting/image/project_manager.png" class="img-fluid figure-img" style="width:80.0%"></p>
<figcaption>これです</figcaption>
</figure>
</div>
<p>これをインストールすると、サイドバーにアイコンが表示されることと思います。</p>
<p>画面左上の「ファイル」から「フォルダを開く」へと進み、何かプロジェクトを開いてみてください（なければ適当にフォルダを作ってみてください）。</p>
<p>開けたら、Project Managerのアイコンをクリックし、拡張機能の画面を開きます。すると上部に下のような表示があると思います。</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://yo5uke.com/pages/tips/250901_positron_setting/image/save_project.png" class="img-fluid quarto-figure quarto-figure-center figure-img" style="width:60.0%"></p>
</figure>
</div>
<p>そしてアイコンの一番左にあるフロッピーディスク💾をクリックすると、今開いているフォルダがワークスペースとして保存され、下に表示されると思います。つまりエクスプローラーにおけるクイックアクセスへのピン留めと同じ要領で、次回以降表示されるプロジェクトを選択すればそのフォルダを開けるようになるというわけです。</p>
<p><code>.Rproj</code>のようなファイルこそないものの、ワークスペースを開いていれば<code>here::here()</code>をはじめとしたプロジェクト管理のためのツールは同様に使用可能です。</p>
<p>ぜひプロジェクトはここから保存してみてください。</p>
<div class="callout callout-style-simple callout-tip no-icon">
<div class="callout-body d-flex">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-body-container">
<p><a href="https://positron.posit.co/migrate-rstudio-rproj.html#launch-from-the-project-manager-extension">The Rproj File - Positron</a></p>
</div>
</div>
</div>
</section>
<section id="テーマの変更" class="level2">
<h2 class="anchored" data-anchor-id="テーマの変更">テーマの変更</h2>
<section id="デフォルトのテーマ設定" class="level3">
<h3 class="anchored" data-anchor-id="デフォルトのテーマ設定">デフォルトのテーマ設定</h3>
<p>Positronではテーマも変更可能です。VSCodeと基本的な設定は同じですが、このセクションの終わりに拡張機能を利用したテーマの変更方法も書いておきます。</p>
<p>まず、左下の歯車マークから「設定」を開きます。</p>
<p>上部の検索窓に「color theme」と入力します。すると「Workbench: Color Theme」という項目がヒットすると思います。ここがデフォルトでは「Positron Light」になっていると思います。ここをクリックすると、テーマの一覧が表示されます。</p>
<p><img src="https://yo5uke.com/pages/tips/250901_positron_setting/image/color_theme.png" class="img-fluid"></p>
<p>ダーク系のテーマが好きな方は「Positron Dark」を選択してください。これでダークモードになります。</p>
<p>他にもいろいろなテーマがあるので、気に入ったものを選んでみてください。</p>
</section>
<section id="テーマの自動切換え" class="level3">
<h3 class="anchored" data-anchor-id="テーマの自動切換え">テーマの自動切換え</h3>
<p>僕はMicrosoft Storeで入手可能な「Auto Dark Mode」というアプリを使用して、日の出と日没に合わせてWindowsのテーマを自動で切り替えています。昼間ならライトモード、夜ならナイトモードに自動で切り替わるというものです。</p>
<p>PositronはデフォルトでWindowsのテーマに合わせて自動で切り替わるわけではないのですが、同じく設定から「auto detect color scheme」を検索し、「Window: Auto Detect Color Scheme」という項目にチェックを入れると、Windowsのテーマに合わせて自動で切り替わるようになります。</p>
<p>別にAuto Dark Modeを使っていない場合でも、Windowsのテーマを手動で切り替えた際にPositronもそれに合わせて切り替えてくれるようになります。</p>
<p>また、この際にライトのテーマとダークのテーマをそれぞれ設定する必要があります。「Workbench: Preferred Light Color Theme」と「Workbench: Preferred Dark Color Theme」という項目があるので、それぞれ好きなテーマを選んでください。ここで選んだものがWindowsのテーマに合わせて切り替わるようになります（Macでも同様かと思います）。</p>
</section>
<section id="拡張機能によるテーマの追加" class="level3">
<h3 class="anchored" data-anchor-id="拡張機能によるテーマの追加">拡張機能によるテーマの追加</h3>
<p>ダークモードに関して、最近1つ新しいテーマを見つけたので、ご紹介します。</p>
<div class="callout callout-style-simple callout-tip no-icon">
<div class="callout-body d-flex">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-body-container">
<p><a href="https://ivelasq.rbind.io/blog/positron-theme/">Porting my favorite RStudio color theme to Positron</a></p>
</div>
</div>
</div>
<p>こちらはRStudioの「Tomorrow Night Bright」というテーマをPositronに移植するために拡張機能を作成した、という記事です。この拡張機能を用いればRStudioのTomorrow Night BrightのテーマをPositronで使用可能になります。</p>
<p>拡張機能のインストール方法は前述のProject Managerと同様です。拡張機能のアイコンをクリックし、検索窓に「tomorrow night bright」と入力します。するとRユーザーにはおなじみ、六角形のロゴがアイコンの「Tomomorrow Night Bright (R Classic)」という拡張機能が出てくると思いますので、インストールしてください。</p>
<p>インストールできたら、先述の「Workbench: Color Theme」から「Tomorrow Night Bright (R Classic)」を選択してください。これでテーマが適用されます<sup>6</sup>。</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://yo5uke.com/pages/tips/250901_positron_setting/image/tomorrow_night_bright.png" class="img-fluid figure-img"></p>
<figcaption>Tommorw Night Bright</figcaption>
</figure>
</div>
</section>
</section>
<section id="タブのピン留め" class="level2">
<h2 class="anchored" data-anchor-id="タブのピン留め">タブのピン留め</h2>
<blockquote class="bluesky-embed blockquote" data-bluesky-uri="at://did:plc:2zcfjzyocp6kapg6jc4eacok/app.bsky.feed.post/3m3bcvqoz2k2p" data-bluesky-cid="bafyreif27w6xrud3nfgpbxmibkvs5hbmr5dfca6e5rx35zagrulhvie6cu" data-bluesky-embed-color-mode="system"><p lang="en">One of my favorite recent Positron discoveries is that you can not only (1) pin tabs, but (2) put the pinned tabs on their own dedicated row (after enabling that setting), which is glorious for workspace tab management #rstats<br><br><a href="https://bsky.app/profile/did:plc:2zcfjzyocp6kapg6jc4eacok/post/3m3bcvqoz2k2p?ref_src=embed">[image or embed]</a></p>— Andrew Heiss (<a href="https://bsky.app/profile/did:plc:2zcfjzyocp6kapg6jc4eacok?ref_src=embed">@andrew.heiss.phd</a>) <a href="https://bsky.app/profile/did:plc:2zcfjzyocp6kapg6jc4eacok/post/3m3bcvqoz2k2p?ref_src=embed">2025年10月16日 7:42</a></blockquote><script async="" src="https://embed.bsky.app/static/embed.js" charset="utf-8"></script>
<p>上記のポストにあるように、Positronではタブをピン留めし、それを2行にして固定することができます。</p>
<p>ピン留め自体は簡単にできます。タブを右クリックして「ピン留めする」をクリックするだけです。あるいはピン留めしたいタブを開いたうえで<span class="visually-hidden">Ctrl-K+Shift-Enter</span>でもピン留めできます。</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://yo5uke.com/pages/tips/250901_positron_setting/image/tab_pin.png" class="img-fluid quarto-figure quarto-figure-center figure-img" style="width:50.0%"></p>
</figure>
</div>
<p>設定方法はポストの画像にある通りですが、設定（<span class="visually-hidden">Ctrl-,</span>）から「workbench.editor.pinnedTabsOnSeparateRow」と検索し、ヒットした項目にチェックを入れます。</p>
<p>設定画面はポストにある通りですが、この設定により、ピン留めしたタブが上段に固定されるようになります。スクリプトとデータビューアを別の段に置けるようになったりして、結構便利だと思います。使いやすいように配置してみてください。</p>
</section>
<section id="rのフォーマッタ" class="level2">
<h2 class="anchored" data-anchor-id="rのフォーマッタ">Rのフォーマッタ</h2>
<p>Rのコードフォーマッタとして「Air」という拡張機能があり、Positronにはデフォルトでインストールされています。コードを整形してくれるツールですが、こちらについては単独の記事にしましたので、そちらをご覧ください。</p>
<div class="callout callout-style-simple callout-tip no-icon">
<div class="callout-body d-flex">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-body-container">
<p><a href="../../../pages/tips/251016_air/index.html">【Positron】拡張機能「Air」を使う【フォーマッタ】</a></p>
</div>
</div>
</div>
</section>
<section id="おわりに" class="level2">
<h2 class="anchored" data-anchor-id="おわりに">おわりに</h2>
<p>以上、Positronの設定について書いてきました。</p>
<p>Positronは今後も発展を続けていくはずですし、さらに便利になることは間違いないと思います。</p>
<p>個人的にはもうRStudioには戻れない、というところまでいってほしいと思っています（笑）</p>
<p>今後もアップデートがあれば更新しますので、よろしくお願いいたします。</p>


<!-- -->

</section>


<div id="quarto-appendix" class="default"><section id="footnotes" class="footnotes footnotes-end-of-document"><h2 class="anchored quarto-appendix-heading">注</h2>

<ol>
<li id="fn1"><p>新しいものが好きな割に敬遠していたのかというご指摘はごもっともですが、ご容赦ください。↩︎</p></li>
<li id="fn2"><p>とはいえ今でも使いやすいのはRStudioだと思っています。今後より便利になるという期待も込めて、Positronを使っている面が大きいです。↩︎</p></li>
<li id="fn3"><p>ここではR Markdownについては書いていませんが、Positronへの移行を考えている前衛的な皆様であれば、R MarkdownからQuartoへ乗り換えるべきです。ということにして、R Markdownの設定は僕もしていないので、説明から逃げています。↩︎</p></li>
<li id="fn4"><p>R Projectについては<a href="../../../pages/tips/240515_rproj/index.html">こちら</a>をご覧ください。↩︎</p></li>
<li id="fn5"><p>おそらく「project manager」でも一番上に出ます。↩︎</p></li>
<li id="fn6"><p>テーマの自動切換えで使用するには、Preferred Dark Color Themeに設定してください。↩︎</p></li>
</ol>
</section></div> ]]></description>
  <category>Positron</category>
  <category>R</category>
  <category>Python</category>
  <category>Quarto</category>
  <guid>https://yo5uke.com/pages/tips/250901_positron_setting/</guid>
  <pubDate>Sun, 31 Aug 2025 15:00:00 GMT</pubDate>
</item>
<item>
  <title>XMLファイルから情報を抽出する</title>
  <link>https://yo5uke.com/pages/tips/250826_xml/</link>
  <description><![CDATA[ 

<div class="social-share-buttons">

  <!-- Twitter (X) -->

  <a href="" id="js-share-twitter" class="share_button ri--twitter-x-fill" target="_blank" rel="nofollow noopener noreferrer"></a>



  <!-- Bluesky -->

  <a href="" id="js-share-bluesky" class="share_button ri--bluesky-fill" target="_blank" rel="nofollow noopener noreferrer"></a>

</div>



<script>

  const twitterUsername = "@5uke_y";

  const blueskyUsername = "@5uke.bsky.social";



  const share_url = encodeURIComponent(location.href);

  const share_title = document.title;



  // Twitter (X)

  document.getElementById('js-share-twitter').setAttribute(

    "href",

    "https://twitter.com/share?url=" + share_url + "&text=" + share_title + " " + encodeURIComponent(twitterUsername) + " より" +

    "&hashtags=rstats"

  );



  // Bluesky

  document.getElementById('js-share-bluesky').setAttribute(

    "href",

    "https://bsky.app/intent/compose?text=" + share_title + " " + share_url + " " + encodeURIComponent(blueskyUsername) + " より"

  );

</script>






<section id="はじめに" class="level2">
<h2 class="anchored" data-anchor-id="はじめに">はじめに</h2>
<p>今度は仕事でXMLファイルを扱う機会がやってきました。</p>
<p>XMLファイルは、データを「タグ」で階層的に記述するテキスト形式のファイルで、構造化された情報を表現・交換するための標準仕様であり、システム間でデータ連携や保存に広く利用されています。</p>
<p>見たことがない方にはとんとイメージがわかないと思うのですが、XMLは以下のような構造をしています。</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb1" style="background: #f1f3f5;"><pre class="sourceCode xml code-with-copy"><code class="sourceCode xml"><span id="cb1-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">&lt;?xml</span><span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;"> version=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"1.0"</span><span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;"> encoding=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"UTF-8"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">?&gt;</span></span>
<span id="cb1-2">&lt;<span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">Library</span>&gt;</span>
<span id="cb1-3">  &lt;<span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">Book</span><span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;"> id=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"B001"</span>&gt;</span>
<span id="cb1-4">    &lt;<span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">Title</span>&gt;データ分析入門&lt;/<span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">Title</span>&gt;</span>
<span id="cb1-5">    &lt;<span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">Author</span>&gt;山田太郎&lt;/<span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">Author</span>&gt;</span>
<span id="cb1-6">    &lt;<span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">Year</span>&gt;2021&lt;/<span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">Year</span>&gt;</span>
<span id="cb1-7">  &lt;/<span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">Book</span>&gt;</span>
<span id="cb1-8">  &lt;<span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">Book</span><span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;"> id=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"B002"</span>&gt;</span>
<span id="cb1-9">    &lt;<span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">Title</span>&gt;XML活用ガイド&lt;/<span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">Title</span>&gt;</span>
<span id="cb1-10">    &lt;<span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">Author</span>&gt;佐藤花子&lt;/<span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">Author</span>&gt;</span>
<span id="cb1-11">    &lt;<span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">Year</span>&gt;2023&lt;/<span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">Year</span>&gt;</span>
<span id="cb1-12">  &lt;/<span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">Book</span>&gt;</span>
<span id="cb1-13">  &lt;<span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">Magazine</span><span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;"> id=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"M001"</span><span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;"> category=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Technology"</span>&gt;</span>
<span id="cb1-14">    &lt;<span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">Title</span>&gt;Tech Monthly&lt;/<span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">Title</span>&gt;</span>
<span id="cb1-15">    &lt;<span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">Issue</span>&gt;2024-08&lt;/<span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">Issue</span>&gt;</span>
<span id="cb1-16">  &lt;/<span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">Magazine</span>&gt;</span>
<span id="cb1-17">&lt;/<span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">Library</span>&gt;</span></code></pre></div></div>
<p><code>Library</code>の中に<code>Book</code>や<code>Magazine</code>が入っていることがわかります。インデントされているので少しはわかりやすいのではないでしょうか。</p>
<p>さらにその中にはタイトルや著者等の情報が含まれています。</p>
<p>これが簡単なXMLの例です。</p>
<p>これがもっと長くずらーっと書かれているものの中から情報を取ってくる作業が仕事で必要になったので、その方法についてまとめたいと思います。</p>
</section>
<section id="準備" class="level2">
<h2 class="anchored" data-anchor-id="準備">準備</h2>
<p>必要なパッケージは<code>xml2</code>です。</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb2" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(xml2)</span></code></pre></div></div>
</div>
<p>また、解析に使用するXMLは以下です。著作権の問題で、データはいかにもそれっぽいですが、中身は架空のものに置き換えています。</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb3" style="background: #f1f3f5;"><pre class="sourceCode xml code-with-copy"><code class="sourceCode xml"><span id="cb3-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">&lt;?xml</span><span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;"> version=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"1.0"</span><span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;"> encoding=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"UTF-8"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">?&gt;</span></span>
<span id="cb3-2">&lt;<span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">Mdevices</span><span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;"> xmlns=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"http://info.pmda.go.jp/namespace/medical_devices/package_insert"</span><span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;"> version=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"1.0"</span>&gt;</span>
<span id="cb3-3">  &lt;<span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">PackageInsertNo</span>&gt;99Z9Z99999999999_1_00_01&lt;/<span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">PackageInsertNo</span>&gt;</span>
<span id="cb3-4">  &lt;<span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">CompanyIdentifier</span>&gt;999999&lt;/<span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">CompanyIdentifier</span>&gt;</span>
<span id="cb3-5">  &lt;<span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">DateOfPreparationOrRevisionArray</span>&gt;</span>
<span id="cb3-6">    &lt;<span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">DateOfPreparationOrRevisionDetail</span><span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;"> id=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"初版"</span>&gt;</span>
<span id="cb3-7">      &lt;<span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">YearMonth</span>&gt;2025-08&lt;/<span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">YearMonth</span>&gt;</span>
<span id="cb3-8">      &lt;<span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">Version</span>&gt;1.0&lt;/<span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">Version</span>&gt;</span>
<span id="cb3-9">      &lt;<span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">ReasonForRevision</span>&gt;新規作成&lt;/<span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">ReasonForRevision</span>&gt;</span>
<span id="cb3-10">    &lt;/<span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">DateOfPreparationOrRevisionDetail</span>&gt;</span>
<span id="cb3-11">  &lt;/<span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">DateOfPreparationOrRevisionArray</span>&gt;</span>
<span id="cb3-12">  &lt;<span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">ApprovalEtcArray</span>&gt;</span>
<span id="cb3-13">    &lt;<span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">ApprovalEtcDetail</span>&gt;</span>
<span id="cb3-14">      &lt;<span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">ApprovalAndLicenseNo</span><span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;"> approvalType=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"1"</span>&gt;99Z9Z99999999999&lt;/<span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">ApprovalAndLicenseNo</span>&gt;</span>
<span id="cb3-15">      &lt;<span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">ApprovalBrandNameDetail</span>&gt;</span>
<span id="cb3-16">        &lt;<span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">ApprovalBrandName</span><span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;"> id=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"BRD_ApprovalBrandName_01"</span>&gt;サンプルデバイスα&lt;/<span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">ApprovalBrandName</span>&gt;</span>
<span id="cb3-17">        &lt;<span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">AccessoriesOrCompositionArticle</span>&gt;架空データ&lt;/<span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">AccessoriesOrCompositionArticle</span>&gt;</span>
<span id="cb3-18">        &lt;<span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">ApprovalBrandNameReading</span>&gt;さんぷるでばいすあるふぁ&lt;/<span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">ApprovalBrandNameReading</span>&gt;</span>
<span id="cb3-19">      &lt;/<span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">ApprovalBrandNameDetail</span>&gt;</span>
<span id="cb3-20">      &lt;<span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">DoNotReuse</span>&gt;No&lt;/<span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">DoNotReuse</span>&gt;</span>
<span id="cb3-21">    &lt;/<span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">ApprovalEtcDetail</span>&gt;</span>
<span id="cb3-22">  &lt;/<span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">ApprovalEtcArray</span>&gt;</span>
<span id="cb3-23">  &lt;<span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">CategoryAndGeneralName</span>&gt;</span>
<span id="cb3-24">    &lt;<span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">Category</span>&gt;A9999&lt;/<span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">Category</span>&gt;</span>
<span id="cb3-25">    &lt;<span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">GeneralName</span>&gt;</span>
<span id="cb3-26">      &lt;<span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">PrimaryGeneralNameDetail</span>&gt;</span>
<span id="cb3-27">        &lt;<span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">PrimaryGeneralName</span><span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;"> id=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"GNN_Main_PrimaryGeneralName"</span>&gt;架空一般医療機器&lt;/<span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">PrimaryGeneralName</span>&gt;</span>
<span id="cb3-28">        &lt;<span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">JMDNCode</span>&gt;99999999&lt;/<span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">JMDNCode</span>&gt;</span>
<span id="cb3-29">        &lt;<span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">Classification</span>&gt;2&lt;/<span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">Classification</span>&gt;</span>
<span id="cb3-30">      &lt;/<span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">PrimaryGeneralNameDetail</span>&gt;</span>
<span id="cb3-31">    &lt;/<span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">GeneralName</span>&gt;</span>
<span id="cb3-32">    &lt;<span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">DiscernmentOfMaintenanceInstallation</span>&gt;None&lt;/<span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">DiscernmentOfMaintenanceInstallation</span>&gt;</span>
<span id="cb3-33">    &lt;<span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">DiscernmentOfTheLivingThingOriginEtc</span>&gt;None&lt;/<span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">DiscernmentOfTheLivingThingOriginEtc</span>&gt;</span>
<span id="cb3-34">    &lt;<span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">TransgenicsMaterial</span>&gt;None&lt;/<span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">TransgenicsMaterial</span>&gt;</span>
<span id="cb3-35">  &lt;/<span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">CategoryAndGeneralName</span>&gt;</span>
<span id="cb3-36">  &lt;<span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">FormAndStructureDetail</span><span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;"> id=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"HDR_FormAndStructure"</span>/&gt;</span>
<span id="cb3-37">  &lt;<span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">InfoIndicationsOrEfficacy</span><span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;"> id=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"HDR_InfoIndicationsOrEfficacy"</span><span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;"> wordingPatternOfInfoIndicationsOrEfficacy=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"1"</span>/&gt;</span>
<span id="cb3-38">  &lt;<span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">PrecautionsForUseDetail</span><span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;"> id=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"HDR_PrecautionsForUse"</span>/&gt;</span>
<span id="cb3-39">  &lt;<span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">AManufacturingAndSellingContractorsNameOrANameEtc</span><span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;"> id=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"HDR_AManufacturingAndSellingContractorsNameOrANameEtc"</span>&gt;</span>
<span id="cb3-40">    &lt;<span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">AManufacturingAndSellingContractorsNameOrANameDetail</span><span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;"> id=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"HDR_AManufacturingAndSellingContractorsNameOrAName"</span>&gt;</span>
<span id="cb3-41">      &lt;<span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">ANameOfManufacturerEtc</span>&gt;株式会社サンプル医療&lt;/<span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">ANameOfManufacturerEtc</span>&gt;</span>
<span id="cb3-42">      &lt;<span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">Phonenumber</span>&gt;000-0000-0000&lt;/<span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">Phonenumber</span>&gt;</span>
<span id="cb3-43">    &lt;/<span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">AManufacturingAndSellingContractorsNameOrANameDetail</span>&gt;</span>
<span id="cb3-44">    &lt;<span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">ANameOrAnOverseasNameEtcOfAFactoryArray</span><span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;"> id=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"HDR_ANameOrAnOverseasNameEtcOfAFactory"</span>&gt;</span>
<span id="cb3-45">      &lt;<span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">ANameOrAnOverseasNameEtcOfAFactoryDetail</span>&gt;</span>
<span id="cb3-46">        &lt;<span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">ANameOfManufacturerEtc</span>&gt;サンプル工場&lt;/<span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">ANameOfManufacturerEtc</span>&gt;</span>
<span id="cb3-47">        &lt;<span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">Phonenumber</span>&gt;000-1111-2222&lt;/<span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">Phonenumber</span>&gt;</span>
<span id="cb3-48">        &lt;<span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">TheCompanyNameOfSpecificationIntoEnglish</span>&gt;Sample Factory Inc.&lt;/<span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">TheCompanyNameOfSpecificationIntoEnglish</span>&gt;</span>
<span id="cb3-49">        &lt;<span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">TheCountryCode</span>&gt;888&lt;/<span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">TheCountryCode</span>&gt;</span>
<span id="cb3-50">        &lt;<span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">NameOfACountry</span>&gt;架空国&lt;/<span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">NameOfACountry</span>&gt;</span>
<span id="cb3-51">      &lt;/<span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">ANameOrAnOverseasNameEtcOfAFactoryDetail</span>&gt;</span>
<span id="cb3-52">    &lt;/<span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">ANameOrAnOverseasNameEtcOfAFactoryArray</span>&gt;</span>
<span id="cb3-53">  &lt;/<span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">AManufacturingAndSellingContractorsNameOrANameEtc</span>&gt;</span>
<span id="cb3-54">  &lt;<span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">PleaseSeeTechnicalManual</span>&gt;False&lt;/<span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">PleaseSeeTechnicalManual</span>&gt;</span>
<span id="cb3-55">&lt;/<span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">Mdevices</span>&gt;</span></code></pre></div></div>
<p>これを<code>sample.xml</code>とします。人によってファイルへのパスは異なるかと思いますが、今回は<code>here::here("data/xml_sample/sample.xml</code>に格納されているとして進めます。</p>
<p>一応サンプルファイルを以下からダウンロードできるようにしておきました。</p>
<p><a href="../../..\data/xml_sample/sample.zip" download="sample.zip">XMLファイル</a></p>
</section>
<section id="データの取得" class="level2">
<h2 class="anchored" data-anchor-id="データの取得">データの取得</h2>
<p>それでは早速XMLファイルを読み込んで、必要な情報を抽出したいと思います。</p>
<p>抽出したい情報は、</p>
<ul>
<li><p>承認番号（<code>&lt;ApprovalAndLicenseNo&gt;</code>）</p></li>
<li><p>一般名称（<code>&lt;PrimaryGeneralName&gt;</code>）</p></li>
<li><p>日本医療機器名コード（<code>&lt;JMDNCode&gt;</code>）</p></li>
</ul>
<p>とします。他のタグについても同様の方法で取得できるので、一旦この3つに絞ります。</p>
<p>まずはファイルを読み込みましょう。</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb4" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># ファイルのパスは適宜変更</span></span>
<span id="cb4-2">xml_sample <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">read_xml</span>(here<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">here</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"data/xml_sample/sample.xml"</span>))</span></code></pre></div></div>
</div>
<p>次に、タグを検索し、該当するものを引っ張ってきます。タグは上の括弧内で記したとおりです。</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb5" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1">xml_sample <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb5-2">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">xml_find_all</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"//*[local-name()='ApprovalAndLicenseNo']"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb5-3">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">xml_text</span>()</span></code></pre></div></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "99Z9Z99999999999"</code></pre>
</div>
</div>
<p><code>xml_find_all()</code>はXML内の要素を探してくるための関数です。複数ヒットすればすべて返してきますが、<code>xml_find_first()</code>であれば最初の一つを返します。今回はタグは重複がないのでどちらでも同じ結果が返ってきます。</p>
<p>ところで見慣れない書き方が出てきています。<code>//</code>も<code>local-name</code>などです。これらについて1つずつまとめます。</p>
<ol type="1">
<li><code>//</code>
<ul>
<li>これはXMLのタグがどの階層にあっても探す、ということです。</li>
<li>特定の階層のみを探すこともできるのですが、今回は全体から探してきたいのでこれを使います。</li>
</ul></li>
<li><code>*</code>
<ul>
<li>これはワイルドカードと呼ばれ、どんな要素でも問わない、ということを示します。</li>
<li>この後に条件を指定しているのですが、その条件を満たすあらゆる要素、ということを示すイメージです。</li>
</ul></li>
<li><code>[local-name()=]</code>
<ul>
<li>ここがややこしいのですが、XMLの冒頭2行目に<code>xmlns="http://info.pmda.go.jp/namespace/medical_devices/package_insert"</code>という表記があります。</li>
<li>これがあるとこの後に出てくるタグはこれの後に続くことになる、ということを意味します。</li>
<li>例：<code>http://info.pmda.go.jp/namespace/medical_devices/package_insert/ApprovalAndLicenseNo</code></li>
<li>すなわち、一見<code>ApprovalAndLicenseNo</code>でヒットしそうですが、実際はこの例のように長い表記が正しいので、<code>ApprovalAndLicenseNo</code>単体だとヒットしません。</li>
<li><code>xmlns</code>の部分を「名前空間」というのですが、名前空間がない場合でもこの書き方でヒットしますので、これを書いておけば間違いないといった感じです<sup>1</sup>。</li>
</ul></li>
</ol>
<p>ややこしい書き方でしたが、これで注目しているタグを引っ張ってこれます。</p>
<p>最後に<code>xml_text()</code>で、タグの中身のテキストを取得でき、今回であれば<code>99Z9Z99999999999</code>が表示できています。</p>
<p>XMLファイルから情報を取得する方法については以上です。</p>
</section>
<section id="ファイルを巡回してデータフレームを作る" class="level2">
<h2 class="anchored" data-anchor-id="ファイルを巡回してデータフレームを作る">ファイルを巡回してデータフレームを作る</h2>
<p>複数のXMLファイルを巡回して、同じ要素を引っ張ってきたいことがありますよね。</p>
<p>その方法についてもまとめます。今回はXMLファイルが2つ、<code>here::here("data/xml_sample")</code>内にあると仮定します。</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb7" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># `tibble()`や`map_dfr()`のため</span></span>
<span id="cb7-2"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(tidyverse)</span>
<span id="cb7-3"></span>
<span id="cb7-4">xml_files <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">list.files</span>(here<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">here</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"data/xml_sample"</span>), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">pattern =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"*.xml$"</span>, </span>
<span id="cb7-5">                        <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">full.names =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">TRUE</span>)</span>
<span id="cb7-6"></span>
<span id="cb7-7">extract_info <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">function</span>(fp) {</span>
<span id="cb7-8">  doc <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">read_xml</span>(fp)</span>
<span id="cb7-9">  </span>
<span id="cb7-10">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">tibble</span>(</span>
<span id="cb7-11">    承認番号 <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">xml_text</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">xml_find_all</span>(doc, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"//*[local-name()='ApprovalAndLicenseNo']"</span>)), </span>
<span id="cb7-12">    一般名称 <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">xml_text</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">xml_find_all</span>(doc, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"//*[local-name()='PrimaryGeneralName']"</span>)), </span>
<span id="cb7-13">    日本医療機器名コード <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">xml_text</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">xml_find_all</span>(doc, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"//*[local-name()='JMDNCode']"</span>))</span>
<span id="cb7-14">  )</span>
<span id="cb7-15">}</span>
<span id="cb7-16"></span>
<span id="cb7-17">df <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">map_dfr</span>(xml_files, extract_info)</span>
<span id="cb7-18"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">print</span>(df)</span></code></pre></div></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 2 × 3
  承認番号         一般名称          日本医療機器名コード
  &lt;chr&gt;            &lt;chr&gt;             &lt;chr&gt;               
1 99Z9Z99999999999 架空一般医療機器  99999999            
2 88Y8Y88888888888 架空一般医療機器B 88888888            </code></pre>
</div>
</div>
<p>ポイントをまとめます。</p>
<ol type="1">
<li><code>list.files()</code>でディレクトリ内のXMLファイルのファイル名（パス込み）を取得します。
<ul>
<li>ワイルドカード<code>*</code>が使われています。前が何であれ、<code>.xml</code>という条件にマッチする要素を取得するということです。</li>
<li>また、<code>$</code>はそれで終わるということを指します。<code>.xml.csv</code>みたいに、<code>.xml</code>の後に別の要素が続くものは取得しないということです。</li>
</ul></li>
<li><code>function</code>で要素をデータフレームに入れる関数を作ります。
<ul>
<li><code>doc</code>に読み込んだXMLを格納し、そこからこれまでに見てきた方法で要素を抽出し、<code>tibble</code>（要はデータフレーム）の各列に格納します。</li>
<li>パイプを使っていないので関数の出てくる順が先ほどと逆ですが、<code>doc |&gt; xml_find_all() |&gt; xml_text()</code>の流れと同じです。</li>
</ul></li>
<li><code>map_dfr()</code>で順番に処理しデータフレームを作成
<ul>
<li>そもそも<code>map()</code>関数はリストやベクトルに対して関数を適用するものです。</li>
<li><code>map_dfr()</code>の<code>dfr</code>はdata frame row-bindの略で、<code>map()</code>の結果を行方向に結合することを指します。</li>
<li>すなわち、各ファイルを読み込んで要素を抽出、1行3列（今回の場合）のデータフレームを作成し、それをどんどん下に結合していくというイメージです。</li>
</ul></li>
</ol>
<p>ちなみに<code>for</code>ループでもできますが、そちらは今回は省略します。</p>
</section>
<section id="おわりに" class="level2">
<h2 class="anchored" data-anchor-id="おわりに">おわりに</h2>
<p>今回はXMLファイルの扱い方について取り上げました。</p>
<p>私は繰り返し処理までこれからやることになりそうなので、出番が増えそうです。</p>
<p>ご参考になれば幸いです。</p>


<!-- -->

</section>


<div id="quarto-appendix" class="default"><section id="footnotes" class="footnotes footnotes-end-of-document"><h2 class="anchored quarto-appendix-heading">注</h2>

<ol>
<li id="fn1"><p>名前空間がない場合は<code>//ApprovalAndLicenseNo</code>でもヒットします。↩︎</p></li>
</ol>
</section></div> ]]></description>
  <category>R</category>
  <category>データ処理</category>
  <guid>https://yo5uke.com/pages/tips/250826_xml/</guid>
  <pubDate>Mon, 25 Aug 2025 15:00:00 GMT</pubDate>
  <media:content url="https://yo5uke.com/pages/tips/250826_xml/image/thumbnail.png" medium="image" type="image/png" height="97" width="144"/>
</item>
<item>
  <title>【Python】高速スクレイピングを実装する【並列化】</title>
  <link>https://yo5uke.com/pages/tips/250816_scraping_python/</link>
  <description><![CDATA[ 

<div class="social-share-buttons">

  <!-- Twitter (X) -->

  <a href="" id="js-share-twitter" class="share_button ri--twitter-x-fill" target="_blank" rel="nofollow noopener noreferrer"></a>



  <!-- Bluesky -->

  <a href="" id="js-share-bluesky" class="share_button ri--bluesky-fill" target="_blank" rel="nofollow noopener noreferrer"></a>

</div>



<script>

  const twitterUsername = "@5uke_y";

  const blueskyUsername = "@5uke.bsky.social";



  const share_url = encodeURIComponent(location.href);

  const share_title = document.title;



  // Twitter (X)

  document.getElementById('js-share-twitter').setAttribute(

    "href",

    "https://twitter.com/share?url=" + share_url + "&text=" + share_title + " " + encodeURIComponent(twitterUsername) + " より" +

    "&hashtags=rstats"

  );



  // Bluesky

  document.getElementById('js-share-bluesky').setAttribute(

    "href",

    "https://bsky.app/intent/compose?text=" + share_title + " " + share_url + " " + encodeURIComponent(blueskyUsername) + " より"

  );

</script>






<section id="はじめに" class="level2">
<h2 class="anchored" data-anchor-id="はじめに">はじめに</h2>
<p>Pythonでスクレイピングを実行したくて、ChatGPTに頼んでコードを書いてもらったということを以下の記事に書きました。</p>
<div class="callout callout-style-simple callout-tip no-icon">
<div class="callout-body d-flex">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-body-container">
<p><a href="../../../pages/blog/250812_python_scraping/index.html">Pythonでスクレイピングをやってみる</a></p>
</div>
</div>
</div>
<p>また、これまでRでスクレイピングを実行する方法についていくつか記事を書いてきましたが、1つずつファイルをダウンロード、ZIPファイルを解凍、みたいな流れで実行していたところ、今回は複数のファイルを並列してダウンロードできる方法を学ぶことができました。</p>
<p>そのコード、手順についてまとめていきたいと思います。</p>
</section>
<section id="環境" class="level2">
<h2 class="anchored" data-anchor-id="環境">環境</h2>
<ul>
<li><p>Windows 11</p></li>
<li><p>Python 3.12.3</p></li>
</ul>
</section>
<section id="ダウンロードするページ" class="level2">
<h2 class="anchored" data-anchor-id="ダウンロードするページ">ダウンロードするページ</h2>
<p><a href="../../../pages/tips/250613_scraping_pop_by_mesh/index.html">Rのコードを紹介したページ</a>と同じで、国勢調査をもとに公開しているメッシュごとの人口データをダウンロードします。URLは以下です。</p>
<p><a href="https://www.e-stat.go.jp/gis/statmap-search?page=1&amp;type=1&amp;toukeiCode=00200521&amp;toukeiYear=2020&amp;aggregateUnit=H&amp;serveyId=H002005112020&amp;statsId=T001141&amp;datum=2011" class="uri">https://www.e-stat.go.jp/gis/statmap-search?page=1&amp;type=1&amp;toukeiCode=00200521&amp;toukeiYear=2020&amp;aggregateUnit=H&amp;serveyId=H002005112020&amp;statsId=T001141&amp;datum=2011</a></p>
</section>
<section id="コード" class="level2">
<h2 class="anchored" data-anchor-id="コード">コード</h2>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb1" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb1-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># ====== Standard library ======</span></span>
<span id="cb1-2"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> re</span>
<span id="cb1-3"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> shutil</span>
<span id="cb1-4"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> threading</span>
<span id="cb1-5"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> zipfile</span>
<span id="cb1-6"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> pathlib <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> Path</span>
<span id="cb1-7"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> typing <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> Optional, Tuple</span>
<span id="cb1-8"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> urllib.parse <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> urljoin</span>
<span id="cb1-9"></span>
<span id="cb1-10"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># ====== Third-party ======</span></span>
<span id="cb1-11"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> requests</span>
<span id="cb1-12"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> bs4 <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> BeautifulSoup</span>
<span id="cb1-13"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> requests.adapters <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> HTTPAdapter</span>
<span id="cb1-14"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> tqdm <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> tqdm</span>
<span id="cb1-15"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> urllib3.util.retry <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> Retry</span>
<span id="cb1-16"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> concurrent.futures <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> ThreadPoolExecutor, as_completed</span>
<span id="cb1-17"></span>
<span id="cb1-18"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> selenium <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> webdriver</span>
<span id="cb1-19"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> selenium.webdriver.chrome.options <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> Options</span>
<span id="cb1-20"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> selenium.webdriver.common.by <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> By</span>
<span id="cb1-21"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> selenium.webdriver.support <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> expected_conditions <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">as</span> EC</span>
<span id="cb1-22"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> selenium.webdriver.support.ui <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> WebDriverWait</span>
<span id="cb1-23"></span>
<span id="cb1-24"></span>
<span id="cb1-25"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># ==============================</span></span>
<span id="cb1-26"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Settings</span></span>
<span id="cb1-27"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># ==============================</span></span>
<span id="cb1-28"></span>
<span id="cb1-29"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 保存先ディレクトリのパス（存在しない場合は作成）</span></span>
<span id="cb1-30">OUTPUT_DIR <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> Path(<span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;">r"data</span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">\250</span><span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;">813_scraping_python"</span>)</span>
<span id="cb1-31">OUTPUT_DIR.mkdir(parents<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">True</span>, exist_ok<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">True</span>)</span>
<span id="cb1-32"></span>
<span id="cb1-33"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># ベースURL（相対パスを補完するために使用）</span></span>
<span id="cb1-34">BASE_URL <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"https://www.e-stat.go.jp"</span></span>
<span id="cb1-35"></span>
<span id="cb1-36"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 並列処理設定</span></span>
<span id="cb1-37">MAX_WORKERS <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">6</span>          <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 同時DL数（回線速度・先方負荷に応じて調整）</span></span>
<span id="cb1-38">REQUEST_TIMEOUT <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">60</span>     <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># タイムアウト時間（秒）</span></span>
<span id="cb1-39"></span>
<span id="cb1-40"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># HTTPリクエスト時のUser-Agent（アクセス元をブラウザっぽく偽装）</span></span>
<span id="cb1-41">USER_AGENT <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> (</span>
<span id="cb1-42">    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Mozilla/5.0 (Windows NT 10.0; Win64; x64) "</span></span>
<span id="cb1-43">    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"AppleWebKit/537.36 (KHTML, like Gecko) "</span></span>
<span id="cb1-44">    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Chrome/126 Safari/537.36"</span></span>
<span id="cb1-45">)</span>
<span id="cb1-46"></span>
<span id="cb1-47"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># ==============================</span></span>
<span id="cb1-48"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Selenium setup</span></span>
<span id="cb1-49"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># ==============================</span></span>
<span id="cb1-50"></span>
<span id="cb1-51"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> create_chrome_driver() <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-&gt;</span> webdriver.Chrome:</span>
<span id="cb1-52">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">"""Headless Chromeのドライバーを作成"""</span></span>
<span id="cb1-53">    options <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> Options()</span>
<span id="cb1-54">    </span>
<span id="cb1-55">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># ヘッドレスモード（ブラウザ画面を表示せずにバックグラウンドで動作）</span></span>
<span id="cb1-56">    options.add_argument(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"--headless=new"</span>)</span>
<span id="cb1-57">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># GPU無効化（描画関連の不要な処理を省く）</span></span>
<span id="cb1-58">    options.add_argument(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"--disable-gpu"</span>)</span>
<span id="cb1-59">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># ウィンドウサイズ指定（幅×高さ）</span></span>
<span id="cb1-60">    options.add_argument(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"--window-size=1280,1800"</span>)</span>
<span id="cb1-61">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 自動化検知を回避（アクセスブロック対策）</span></span>
<span id="cb1-62">    options.add_argument(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"--disable-blink-features=AutomationControlled"</span>)</span>
<span id="cb1-63">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># User-Agentを上書き（アクセス元をブラウザっぽく偽装）</span></span>
<span id="cb1-64">    options.add_argument(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"user-agent=</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>USER_AGENT<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>)</span>
<span id="cb1-65"></span>
<span id="cb1-66">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Chromeドライバーを生成</span></span>
<span id="cb1-67">    driver <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> webdriver.Chrome(options<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>options)</span>
<span id="cb1-68">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># ページ読み込みのタイムアウト（秒）</span></span>
<span id="cb1-69">    driver.set_page_load_timeout(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">60</span>)</span>
<span id="cb1-70">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># JavaScript実行のタイムアウト（秒）</span></span>
<span id="cb1-71">    driver.set_script_timeout(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">60</span>)</span>
<span id="cb1-72"></span>
<span id="cb1-73">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> driver</span>
<span id="cb1-74"></span>
<span id="cb1-75"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># ==============================</span></span>
<span id="cb1-76"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Dynamic page loader</span></span>
<span id="cb1-77"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># ==============================</span></span>
<span id="cb1-78"></span>
<span id="cb1-79"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> fetch_rendered_html(</span>
<span id="cb1-80">    url: <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">str</span>,</span>
<span id="cb1-81">    driver: webdriver.Chrome,</span>
<span id="cb1-82">    wait_for_css: Optional[<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">str</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">None</span>,</span>
<span id="cb1-83">    timeout: <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">int</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">20</span>,</span>
<span id="cb1-84">) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-&gt;</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">str</span>:</span>
<span id="cb1-85">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">"""</span></span>
<span id="cb1-86"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    JavaScript実行後のHTMLを取得する関数</span></span>
<span id="cb1-87"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    必要に応じて、特定のCSSセレクタがDOMに出現するまで待機</span></span>
<span id="cb1-88"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    """</span></span>
<span id="cb1-89">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 指定したURLにアクセス</span></span>
<span id="cb1-90">    driver.get(url)</span>
<span id="cb1-91"></span>
<span id="cb1-92">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># ページの読み込み完了まで待機</span></span>
<span id="cb1-93">    WebDriverWait(driver, timeout).until(</span>
<span id="cb1-94">        <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">lambda</span> d: d.execute_script(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"return document.readyState"</span>) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"complete"</span></span>
<span id="cb1-95">    )</span>
<span id="cb1-96"></span>
<span id="cb1-97">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># もしCSSセレクタが指定されていれば、その要素が表示されるまで待機</span></span>
<span id="cb1-98">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># （JSによる非同期描画の完了を保証するため）</span></span>
<span id="cb1-99">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> wait_for_css:</span>
<span id="cb1-100">        WebDriverWait(driver, timeout).until(</span>
<span id="cb1-101">            EC.presence_of_all_elements_located((By.CSS_SELECTOR, wait_for_css))</span>
<span id="cb1-102">        )</span>
<span id="cb1-103"></span>
<span id="cb1-104">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 最終的なページのHTMLソースを返す</span></span>
<span id="cb1-105">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> driver.page_source</span>
<span id="cb1-106"></span>
<span id="cb1-107"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># ==============================</span></span>
<span id="cb1-108"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Link extraction</span></span>
<span id="cb1-109"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># ==============================</span></span>
<span id="cb1-110"></span>
<span id="cb1-111"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> find_csv_links(html: <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">str</span>, pattern: <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">str</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;">r"data</span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">\?</span><span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;">statsId=T001141"</span>) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-&gt;</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">list</span>[<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">str</span>]:</span>
<span id="cb1-112">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">"""</span></span>
<span id="cb1-113"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    HTMLから指定パターンに合致するリンク（href属性）を抽出する関数。</span></span>
<span id="cb1-114"></span>
<span id="cb1-115"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    Parameters</span></span>
<span id="cb1-116"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    ----------</span></span>
<span id="cb1-117"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    html : str</span></span>
<span id="cb1-118"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">        取得済みのHTML文字列</span></span>
<span id="cb1-119"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    pattern : str</span></span>
<span id="cb1-120"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">        hrefがこのパターンにマッチするリンクだけを抽出</span></span>
<span id="cb1-121"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">        デフォルトは 'data?statsId=T001141' を含むリンク。</span></span>
<span id="cb1-122"></span>
<span id="cb1-123"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    Returns</span></span>
<span id="cb1-124"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    -------</span></span>
<span id="cb1-125"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    list[str]</span></span>
<span id="cb1-126"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">        マッチしたhrefのリスト。</span></span>
<span id="cb1-127"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    """</span></span>
<span id="cb1-128">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># HTML文字列をBeautifulSoupでパース</span></span>
<span id="cb1-129">    soup <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> BeautifulSoup(html, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"html.parser"</span>)</span>
<span id="cb1-130"></span>
<span id="cb1-131">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># &lt;a&gt;タグの中でhref属性を持つものをすべて取得し、</span></span>
<span id="cb1-132">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># さらにhrefが正規表現patternに一致するものだけを抽出</span></span>
<span id="cb1-133">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> [</span>
<span id="cb1-134">        a[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"href"</span>]</span>
<span id="cb1-135">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> a <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> soup.find_all(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"a"</span>, href<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">True</span>)</span>
<span id="cb1-136">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> re.search(pattern, a[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"href"</span>])</span>
<span id="cb1-137">    ]</span>
<span id="cb1-138"></span>
<span id="cb1-139"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># ==============================</span></span>
<span id="cb1-140"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Thread-local requests.Session</span></span>
<span id="cb1-141"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># ==============================</span></span>
<span id="cb1-142"></span>
<span id="cb1-143"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># スレッドごとに独立したデータを持てる入れ物を作成</span></span>
<span id="cb1-144">_thread_local <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> threading.local()</span>
<span id="cb1-145"></span>
<span id="cb1-146"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> get_session() <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-&gt;</span> requests.Session:</span>
<span id="cb1-147">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">"""</span></span>
<span id="cb1-148"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    スレッドローカルに保持されるHTTPセッションを取得する関数。</span></span>
<span id="cb1-149"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    接続プーリング、リトライ設定、統一User-Agentを適用。</span></span>
<span id="cb1-150"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    </span></span>
<span id="cb1-151"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    - スレッドローカル: 各スレッドで独立したセッションを保持するための仕組み。</span></span>
<span id="cb1-152"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    - 接続プーリング: 同じホストへの接続を再利用して効率化。</span></span>
<span id="cb1-153"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    - リトライ設定: 一時的なエラー（429, 500, 502, 503, 504）に対して最大3回まで再試行。</span></span>
<span id="cb1-154"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    - User-Agent統一: リクエストの送信元情報を統一してサーバー側の認識を安定化。</span></span>
<span id="cb1-155"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    """</span></span>
<span id="cb1-156">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">getattr</span>(_thread_local, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"session"</span>, <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">None</span>) <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">is</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">None</span>:</span>
<span id="cb1-157">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 新規セッション作成</span></span>
<span id="cb1-158">        s <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> requests.Session()</span>
<span id="cb1-159">        s.headers.update({<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"User-Agent"</span>: USER_AGENT})</span>
<span id="cb1-160"></span>
<span id="cb1-161">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># リトライ戦略の設定</span></span>
<span id="cb1-162">        retries <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> Retry(</span>
<span id="cb1-163">            total<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>,                   <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 最大リトライ回数</span></span>
<span id="cb1-164">            backoff_factor<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.8</span>,        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># リトライ間隔の指数的増加係数</span></span>
<span id="cb1-165">            status_forcelist<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">429</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">500</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">502</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">503</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">504</span>),  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 再試行対象のHTTPステータスコード</span></span>
<span id="cb1-166">            allowed_methods<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"GET"</span>,),  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># リトライ対象HTTPメソッド</span></span>
<span id="cb1-167">        )</span>
<span id="cb1-168"></span>
<span id="cb1-169">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 接続アダプタの設定（プーリングとリトライ）</span></span>
<span id="cb1-170">        adapter <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> HTTPAdapter(</span>
<span id="cb1-171">            pool_connections<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>MAX_WORKERS,  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 同時接続プール数</span></span>
<span id="cb1-172">            pool_maxsize<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>MAX_WORKERS,      <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># プールの最大接続数</span></span>
<span id="cb1-173">            max_retries<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>retries,           <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 上記リトライ戦略を適用</span></span>
<span id="cb1-174">        )</span>
<span id="cb1-175">        s.mount(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"http://"</span>, adapter)</span>
<span id="cb1-176">        s.mount(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"https://"</span>, adapter)</span>
<span id="cb1-177"></span>
<span id="cb1-178">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># スレッドローカルに保存</span></span>
<span id="cb1-179">        _thread_local.session <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> s</span>
<span id="cb1-180"></span>
<span id="cb1-181">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> _thread_local.session</span>
<span id="cb1-182"></span>
<span id="cb1-183"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># ==============================</span></span>
<span id="cb1-184"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># ZIP download &amp; extract (worker)</span></span>
<span id="cb1-185"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># ==============================</span></span>
<span id="cb1-186"></span>
<span id="cb1-187"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> fetch_zip_and_extract_txt(task: Tuple[<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">str</span>, <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">str</span>]) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-&gt;</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">tuple</span>[<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">str</span>, <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">bool</span>, <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">str</span>]:</span>
<span id="cb1-188">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">"""</span></span>
<span id="cb1-189"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    指定URLからZIPをダウンロードし、中の最初の'.txt'ファイルを</span></span>
<span id="cb1-190"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    'pop_mesh{code}.txt' という名前で保存する関数。</span></span>
<span id="cb1-191"></span>
<span id="cb1-192"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    戻り値:</span></span>
<span id="cb1-193"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">        (url, success, message)</span></span>
<span id="cb1-194"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">        url     : ダウンロード元のURL</span></span>
<span id="cb1-195"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">        success : 成功した場合はTrue、失敗はFalse</span></span>
<span id="cb1-196"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">        message : 実行結果の簡易説明</span></span>
<span id="cb1-197"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    """</span></span>
<span id="cb1-198">    full_url, code <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> task</span>
<span id="cb1-199">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 一時保存用のZIPファイルパス</span></span>
<span id="cb1-200">    zip_path <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> OUTPUT_DIR <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> <span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"pop_mesh</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>code<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">.zip"</span></span>
<span id="cb1-201">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 最終的に保存するテキストファイルパス</span></span>
<span id="cb1-202">    txt_path <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> OUTPUT_DIR <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> <span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"pop_mesh</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>code<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">.txt"</span></span>
<span id="cb1-203"></span>
<span id="cb1-204">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># すでにtxtが存在する場合はスキップ</span></span>
<span id="cb1-205">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> txt_path.exists():</span>
<span id="cb1-206">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> full_url, <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">True</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"skipped (exists)"</span></span>
<span id="cb1-207"></span>
<span id="cb1-208">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">try</span>:</span>
<span id="cb1-209">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># セッションを取得（接続の再利用などを行う）</span></span>
<span id="cb1-210">        session <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> get_session()</span>
<span id="cb1-211"></span>
<span id="cb1-212">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># ZIPをダウンロード（ストリーミングで少しずつ書き込み）</span></span>
<span id="cb1-213">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">with</span> session.get(full_url, stream<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">True</span>, timeout<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>REQUEST_TIMEOUT) <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">as</span> resp:</span>
<span id="cb1-214">            resp.raise_for_status()</span>
<span id="cb1-215">            <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">with</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">open</span>(zip_path, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"wb"</span>) <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">as</span> f:</span>
<span id="cb1-216">                <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> chunk <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> resp.iter_content(chunk_size<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">8192</span>):</span>
<span id="cb1-217">                    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> chunk:</span>
<span id="cb1-218">                        f.write(chunk)</span>
<span id="cb1-219"></span>
<span id="cb1-220">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># ZIPファイルでなければ削除して終了</span></span>
<span id="cb1-221">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">not</span> zipfile.is_zipfile(zip_path):</span>
<span id="cb1-222">            zip_path.unlink(missing_ok<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">True</span>)</span>
<span id="cb1-223">            <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> full_url, <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">False</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"not a zip file"</span></span>
<span id="cb1-224"></span>
<span id="cb1-225">        found_txt <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">False</span></span>
<span id="cb1-226">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">with</span> zipfile.ZipFile(zip_path, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"r"</span>) <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">as</span> zf:</span>
<span id="cb1-227">            <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> info <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> zf.infolist():</span>
<span id="cb1-228">                <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> info.is_dir():  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># ディレクトリはスキップ</span></span>
<span id="cb1-229">                    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">continue</span></span>
<span id="cb1-230">                <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> info.filename.lower().endswith(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">".txt"</span>):</span>
<span id="cb1-231">                    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 直接上書きせず一時ファイルに保存 → 後でリネーム（競合回避）</span></span>
<span id="cb1-232">                    tmp_path <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> txt_path.with_suffix(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">".txt.part"</span>)</span>
<span id="cb1-233">                    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">with</span> zf.<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">open</span>(info) <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">as</span> src, <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">open</span>(tmp_path, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"wb"</span>) <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">as</span> dst:</span>
<span id="cb1-234">                        shutil.copyfileobj(src, dst)</span>
<span id="cb1-235">                    tmp_path.replace(txt_path)</span>
<span id="cb1-236">                    found_txt <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">True</span></span>
<span id="cb1-237">                    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">break</span></span>
<span id="cb1-238"></span>
<span id="cb1-239">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># ZIPは不要になったので削除</span></span>
<span id="cb1-240">        zip_path.unlink(missing_ok<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">True</span>)</span>
<span id="cb1-241"></span>
<span id="cb1-242">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># TXTが見つからなかった場合</span></span>
<span id="cb1-243">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">not</span> found_txt:</span>
<span id="cb1-244">            <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> full_url, <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">False</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"no .txt in zip"</span></span>
<span id="cb1-245">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> full_url, <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">True</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"ok"</span></span>
<span id="cb1-246"></span>
<span id="cb1-247">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">except</span> <span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">Exception</span> <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">as</span> e:</span>
<span id="cb1-248">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># エラー時はZIPを削除</span></span>
<span id="cb1-249">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">try</span>:</span>
<span id="cb1-250">            zip_path.unlink(missing_ok<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">True</span>)</span>
<span id="cb1-251">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">except</span> <span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">Exception</span>:</span>
<span id="cb1-252">            <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">pass</span></span>
<span id="cb1-253">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> full_url, <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">False</span>, <span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"error: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>e<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span></span>
<span id="cb1-254"></span>
<span id="cb1-255"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># ==============================</span></span>
<span id="cb1-256"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Main</span></span>
<span id="cb1-257"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># ==============================</span></span>
<span id="cb1-258"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> main() <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-&gt;</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">None</span>:</span>
<span id="cb1-259">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">"""一覧ページを巡回→リンク収集→並列ダウンロード。"""</span></span>
<span id="cb1-260">    driver <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> create_chrome_driver()  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Chromeドライバー生成</span></span>
<span id="cb1-261">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">try</span>:</span>
<span id="cb1-262">        tasks: <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">list</span>[<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">tuple</span>[<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">str</span>, <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">str</span>]] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> []  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># ダウンロード対象の (URL, code) タプルを格納</span></span>
<span id="cb1-263"></span>
<span id="cb1-264">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># ページ番号 1〜8 を巡回してリンクを収集</span></span>
<span id="cb1-265">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> i <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> tqdm(<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">range</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">9</span>), desc<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"ページ巡回"</span>):</span>
<span id="cb1-266">            <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># ページごとのURL生成</span></span>
<span id="cb1-267">            url <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> (</span>
<span id="cb1-268">                <span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"https://www.e-stat.go.jp/gis/statmap-search?page=</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>i<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span></span>
<span id="cb1-269">                <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"&amp;type=1&amp;toukeiCode=00200521&amp;toukeiYear=2020&amp;aggregateUnit=H"</span></span>
<span id="cb1-270">                <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"&amp;serveyId=H002005112020&amp;statsId=T001141&amp;datum=2011"</span></span>
<span id="cb1-271">            )</span>
<span id="cb1-272">            <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># JavaScriptレンダリング後のHTMLを取得</span></span>
<span id="cb1-273">            html <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> fetch_rendered_html(</span>
<span id="cb1-274">                url,</span>
<span id="cb1-275">                driver,</span>
<span id="cb1-276">                wait_for_css<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"a[href*='data?statsId=T001141']"</span>,  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># このCSSが出現するまで待機</span></span>
<span id="cb1-277">                timeout<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">25</span>,</span>
<span id="cb1-278">            )</span>
<span id="cb1-279">            <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># CSVリンク抽出</span></span>
<span id="cb1-280">            csv_links <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> find_csv_links(html)</span>
<span id="cb1-281">            <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 相対パスを絶対URLへ変換</span></span>
<span id="cb1-282">            full_urls <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> [urljoin(BASE_URL, link) <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> link <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> csv_links]</span>
<span id="cb1-283"></span>
<span id="cb1-284">            <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># URLとcodeをセットで保存</span></span>
<span id="cb1-285">            <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> full_url, csv_link <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">zip</span>(full_urls, csv_links):</span>
<span id="cb1-286">                m <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> re.search(<span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;">r"code=</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">(</span><span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">[0-9]</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">)</span><span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>, csv_link)</span>
<span id="cb1-287">                code <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> m.group(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>) <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> m <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">else</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"unknown"</span></span>
<span id="cb1-288">                tasks.append((full_url, code))</span>
<span id="cb1-289"></span>
<span id="cb1-290">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 成功・失敗・スキップ件数カウンタ</span></span>
<span id="cb1-291">        successes <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span></span>
<span id="cb1-292">        failures <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span></span>
<span id="cb1-293">        skipped <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span></span>
<span id="cb1-294"></span>
<span id="cb1-295">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 並列ダウンロード処理</span></span>
<span id="cb1-296">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">with</span> ThreadPoolExecutor(max_workers<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>MAX_WORKERS) <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">as</span> ex:</span>
<span id="cb1-297">            futures <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> [ex.submit(fetch_zip_and_extract_txt, t) <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> t <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> tasks]</span>
<span id="cb1-298">            <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> fut <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> tqdm(as_completed(futures), total<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">len</span>(futures), desc<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"ダウンロード"</span>):</span>
<span id="cb1-299">                url, ok, msg <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> fut.result()</span>
<span id="cb1-300">                <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> ok <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">and</span> msg.startswith(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"ok"</span>):</span>
<span id="cb1-301">                    successes <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span></span>
<span id="cb1-302">                <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">elif</span> ok <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">and</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"skipped"</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> msg:</span>
<span id="cb1-303">                    skipped <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span></span>
<span id="cb1-304">                <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">else</span>:</span>
<span id="cb1-305">                    failures <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span></span>
<span id="cb1-306"></span>
<span id="cb1-307">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 処理結果を表示</span></span>
<span id="cb1-308">        <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"</span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">\n</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">Done. ok=</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>successes<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">, skipped=</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>skipped<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">, failed=</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>failures<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>)</span>
<span id="cb1-309"></span>
<span id="cb1-310">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">finally</span>:</span>
<span id="cb1-311">        driver.quit()  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># ブラウザを閉じる</span></span>
<span id="cb1-312"></span>
<span id="cb1-313"></span>
<span id="cb1-314"><span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">__name__</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"__main__"</span>:</span>
<span id="cb1-315">    main()</span></code></pre></div></div>
</section>
<section id="ざっくり解説" class="level2">
<h2 class="anchored" data-anchor-id="ざっくり解説">ざっくり解説</h2>
<p>Setting, Selenium setupなど、いくつかのブロックに分かれているので、各ブロックでどのようなことをしているのか、ざっくり確認していきます。</p>
<section id="settings" class="level3">
<h3 class="anchored" data-anchor-id="settings">Settings</h3>
<p>スクレイピングに必要な設定をしています。URLは場合に合わせて変える必要があります。</p>
<p><code>MAX_WORKERS</code>の部分でいくつ並列でダウンロードするかを設定しているのが今回のミソだと思います。6つ平行することで高速化を図っています。</p>
<p><code>USER_AGENT</code>では、どのブラウザ、環境からアクセスしているのかを設定するもので、デフォルトだと自動化ツールからのアクセスと判断され、アクセスが拒否される可能性があるので、それを防ぐために設定をしています。</p>
</section>
<section id="selenium-setup" class="level3">
<h3 class="anchored" data-anchor-id="selenium-setup">Selenium setup</h3>
<p>細かい設定はコメントで書いている通りではあるのですが、ブラウザを自動操作できる環境を整えている部分です。</p>
<p>ブラウザをバックグラウンドで動かしたり、無駄な描画はなくしたりと、効率的な設定をここで指定しています。</p>
</section>
<section id="dynamic-page-loader" class="level3">
<h3 class="anchored" data-anchor-id="dynamic-page-loader">Dynamic page loader</h3>
<p>ここがRでいうところの<code>read_html_live()</code>に当たる部分です。</p>
<p>指定されたURLにアクセスして、HTMLソースを返すといった作業をしています。</p>
<p>コメントを読んでいただくと、JavaScriptにも対応しているのがお分かりになるかと思います。</p>
</section>
<section id="link-extraction" class="level3">
<h3 class="anchored" data-anchor-id="link-extraction">Link extraction</h3>
<p>これはRでいうところの<code>html_attrs()</code>や<code>html_elements()</code>に該当するようなことをしています。</p>
<p><code>a</code>タグを探してきて、その中に含まれる<code>href</code>を引っ張ってくるということをしています。<code>href</code>にはダウンロードのためのリンクが含まれています。</p>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
<span class="screen-reader-only">Note</span>リンクの探し方について
</div>
</div>
<div class="callout-body-container callout-body">
<p><code>a</code>タグの探し方などについては、<a href="../../../pages/tips/250319_scraping/index.html#ファイルのリンクを取得">こちら</a>で簡単に説明しています。</p>
</div>
</div>
</section>
<section id="thread-local-requests.session" class="level3">
<h3 class="anchored" data-anchor-id="thread-local-requests.session">Thread-local requests.Session</h3>
<p>ここでは、各スレッドごとに独立したHTTPセッションを用意しています。</p>
<p>これにより、並列ダウンロード時に接続が混線せず安全に動作し、さらにセッションの接続再利用（コネクションプール）によって通信が効率化されます。</p>
<p>またリトライ設定やUser-Agentの統一もここでまとめて適用しているので、安定性と速度の両立ができます。</p>
</section>
<section id="zip-download-extract-worker" class="level3">
<h3 class="anchored" data-anchor-id="zip-download-extract-worker">ZIP download &amp; extract (worker)</h3>
<p>ここではZIPファイルのダウンロードと解凍の設定をしています。</p>
<p>今回はダウンロードするものの中身はテキストファイルなので<code>.txt</code>として解凍するように設定していますが、ここはダウンロードするものに合わせて変更する必要があります。</p>
<p>変なものをダウンロードしてしまった場合の対処や、既にファイルが存在する場合の対処もしているので、ミスにもある程度対応できるようになっています。エラーメッセージも表示されるようにしているので、何のエラーが起きたのかはわかるようになっています。</p>
</section>
<section id="main" class="level3">
<h3 class="anchored" data-anchor-id="main">Main</h3>
<p>その名の通りメインのコードです。</p>
<p>今回はページ数が1～8まであるとわかっていますので、<code>range(1, 9)</code>と書かれています。Rと違うので戸惑ったのですが、Pythonでは開始値は含み、終了値は含まないようです。なので1と9が記されています。</p>
<p>流れとしては、ページを巡回してダウンロード先のURLを保存し、巡回し終わったら並列でそれらをダウンロードしていきます。ここが並列になっているので、ダウンロードの速度が向上しているというわけです。</p>
<p>ダウンロード後にはダウンロードに成功したもの、既に存在してスキップしたもの、失敗したものの件数を出力するようにしています。</p>
<p>最後には<code>driver.quit()</code>でブラウザを終了させ、プロセスやメモリが残らないようになっています。</p>
</section>
<section id="最後のif文" class="level3">
<h3 class="anchored" data-anchor-id="最後のif文">最後の<code>if</code>文</h3>
<p>1番最後の行は「このファイルを直接実行したときだけ<code>main()</code>を動かす」という役割を持っています。<br>
</p>
<p>Pythonでは同じファイルをスクリプトとして実行することも、ライブラリとして他のプログラムから読み込むこともできますが、この仕組みによって「直接実行した場合だけスクレイピング処理を走らせ、importされた場合には余計な処理をしない」ようにしています。</p>
</section>
</section>
<section id="おわりに" class="level2">
<h2 class="anchored" data-anchor-id="おわりに">おわりに</h2>
<p>今回はChatGPTに手伝ってもらいながら、RでのスクレイピングコードをPythonに書き換え、簡単にまとめました。</p>
<p>自分もPythonは勉強を始めたばかりではあるので認識の誤り等あるかもしれませんが、コメントからお寄せいただければ幸いです。</p>
<p>個人的には業務の効率化を図るうえでPythonでのスクレイピングを活用していきたいと思っているので、引き続きアップデートなどあればまた記事にしていきたいと思います。</p>


<!-- -->

</section>

 ]]></description>
  <category>Python</category>
  <category>データ処理</category>
  <guid>https://yo5uke.com/pages/tips/250816_scraping_python/</guid>
  <pubDate>Fri, 15 Aug 2025 15:00:00 GMT</pubDate>
</item>
<item>
  <title>recode関数でデータフレームの中身を置き換える</title>
  <link>https://yo5uke.com/pages/tips/250727_recode/</link>
  <description><![CDATA[ 

<div class="social-share-buttons">

  <!-- Twitter (X) -->

  <a href="" id="js-share-twitter" class="share_button ri--twitter-x-fill" target="_blank" rel="nofollow noopener noreferrer"></a>



  <!-- Bluesky -->

  <a href="" id="js-share-bluesky" class="share_button ri--bluesky-fill" target="_blank" rel="nofollow noopener noreferrer"></a>

</div>



<script>

  const twitterUsername = "@5uke_y";

  const blueskyUsername = "@5uke.bsky.social";



  const share_url = encodeURIComponent(location.href);

  const share_title = document.title;



  // Twitter (X)

  document.getElementById('js-share-twitter').setAttribute(

    "href",

    "https://twitter.com/share?url=" + share_url + "&text=" + share_title + " " + encodeURIComponent(twitterUsername) + " より" +

    "&hashtags=rstats"

  );



  // Bluesky

  document.getElementById('js-share-bluesky').setAttribute(

    "href",

    "https://bsky.app/intent/compose?text=" + share_title + " " + share_url + " " + encodeURIComponent(blueskyUsername) + " より"

  );

</script>






<section id="はじめに" class="level2">
<h2 class="anchored" data-anchor-id="はじめに">はじめに</h2>
<p>今回は{dplyr}パッケージの<code>recode()</code>関数を紹介します。</p>
<p>例えばデータフレーム内の変数がカテゴリ変数で、便宜的に数値で表されているような場合、そのまま表に出すことはできないかもしれません。</p>
<p>そんなときに中身を置き換える手段として使えるのが<code>recode()</code>関数で、イメージとしては<code>case_when()</code>と似ているかもしれません<sup>1</sup>。</p>
<p>1度きりの変換であれば<code>case_when</code>でもあまり労力は変わらないかもしれませんが、何回も繰り返し置き換えたいときは、シンプルで強みを発揮します。</p>
</section>
<section id="使い方" class="level2">
<h2 class="anchored" data-anchor-id="使い方">使い方</h2>
<section id="パッケージ" class="level3">
<h3 class="anchored" data-anchor-id="パッケージ">パッケージ</h3>
<p>{dplyr}に入っているので、{tidyverse}を読み込んでいれば使えます。</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb1" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(tidyverse)</span>
<span id="cb1-2"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># あるいは</span></span>
<span id="cb1-3"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># library(dplyr)</span></span></code></pre></div></div>
</div>
</section>
<section id="データフレーム" class="level3">
<h3 class="anchored" data-anchor-id="データフレーム">データフレーム</h3>
<p>今回は以下のようなデータフレームを想定します。</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb2" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1">df <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">tibble</span>(</span>
<span id="cb2-2">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">id =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>,</span>
<span id="cb2-3">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">sex =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rep</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">times =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>)</span>
<span id="cb2-4">)</span></code></pre></div></div>
</div>
<div class="cell">
<div id="tbl-example" class="cell quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-tbl figure">
<figcaption class="quarto-float-caption-top quarto-float-caption quarto-float-tbl" id="tbl-example-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
表&nbsp;1: テーブルの例
</figcaption>
<div aria-describedby="tbl-example-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<div class="cell-output-display">
<!-- preamble start -->

    <script>

      function styleCell_rodji0v35ypm40on8y4p(i, j, css_id) {
          var table = document.getElementById("tinytable_rodji0v35ypm40on8y4p");
          var cell = table.querySelector(`[data-row="${i}"][data-col="${j}"]`);
          if (cell) {
              console.log(`Styling cell at (${i}, ${j}) with class ${css_id}`);
              cell.classList.add(css_id);
          } else {
              console.warn(`Cell at (${i}, ${j}) not found.`);
          }
      }
      function spanCell_rodji0v35ypm40on8y4p(i, j, rowspan, colspan) {
        var table = document.getElementById("tinytable_rodji0v35ypm40on8y4p");
        const targetCell = table.querySelector(`[data-row="${i}"][data-col="${j}"]`);
        if (!targetCell) {
          console.warn(`Cell at (${i}, ${j}) not found.`);
        }

        // Get all cells that need to be removed
        const cellsToRemove = [];
        for (let r = 0; r < rowspan; r++) {
          for (let c = 0; c < colspan; c++) {
            if (r === 0 && c === 0) continue; // Skip the target cell
            const cell = table.querySelector(`[data-row="${i + r}"][data-col="${j + c}"]`);
            if (cell) {
              cellsToRemove.push(cell);
            }
          }
        }

        // Remove all cells
        cellsToRemove.forEach(cell => cell.remove());

        // Set rowspan and colspan of the target cell if it exists
        if (targetCell) {
          targetCell.rowSpan = rowspan;
          targetCell.colSpan = colspan;
        }
      }
      // tinytable span after
      window.addEventListener('load', function () {
          var cellsToStyle = [
            // tinytable style arrays after
          { positions: [ { i: '4', j: 0 }, { i: '4', j: 1 },  ], css_id: 'tinytable_css_tjjurabkw2z9g2kln1hy',}, 
          { positions: [ { i: '0', j: 0 }, { i: '0', j: 1 },  ], css_id: 'tinytable_css_o1sjgk0vl6u1z5dc2x0k',}, 
          ];

          // Loop over the arrays to style the cells
          cellsToStyle.forEach(function (group) {
              group.positions.forEach(function (cell) {
                  styleCell_rodji0v35ypm40on8y4p(cell.i, cell.j, group.css_id);
              });
          });
      });
    </script>

    <style>
      /* tinytable css entries after */
      .table td.tinytable_css_tjjurabkw2z9g2kln1hy, .table th.tinytable_css_tjjurabkw2z9g2kln1hy { border-bottom: solid #d3d8dc 0.1em; }
      .table td.tinytable_css_o1sjgk0vl6u1z5dc2x0k, .table th.tinytable_css_o1sjgk0vl6u1z5dc2x0k { border-top: solid #d3d8dc 0.1em; border-bottom: solid #d3d8dc 0.05em; }
    </style>
    <div class="container">
      <table class="table table-borderless" id="tinytable_rodji0v35ypm40on8y4p" style="width: auto; margin-left: auto; margin-right: auto;" data-quarto-disable-processing="true">
        <thead>
        
              <tr>
                <th scope="col" data-row="0" data-col="0">id</th>
                <th scope="col" data-row="0" data-col="1">sex</th>
              </tr>
        </thead>
        
        <tbody>
                <tr>
                  <td data-row="1" data-col="0">1</td>
                  <td data-row="1" data-col="1">1</td>
                </tr>
                <tr>
                  <td data-row="2" data-col="0">2</td>
                  <td data-row="2" data-col="1">2</td>
                </tr>
                <tr>
                  <td data-row="3" data-col="0">3</td>
                  <td data-row="3" data-col="1">1</td>
                </tr>
                <tr>
                  <td data-row="4" data-col="0">4</td>
                  <td data-row="4" data-col="1">2</td>
                </tr>
        </tbody>
      </table>
    </div>
<!-- hack to avoid NA insertion in last line -->
</div>
</div>
</figure>
</div>
</div>
<p>超絶簡単なデータフレームです。4人のIDと性別が1, 2の表記で含まれているだけです。ここで1を男性、2を女性とします。</p>
</section>
<section id="対応表を作る" class="level3">
<h3 class="anchored" data-anchor-id="対応表を作る">対応表を作る</h3>
<p>これを表に起こしたいとき、たとえばそのまま<code>tinytable::tt()</code>で表示したとしたら、 表&nbsp;1 がそのまま出てきてしまい、数字が誰を、何を表しているのかがわかりませんよね。</p>
<p>そこで、あらかじめ対応表を作って置きます。</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb3" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1">id_map <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(</span>
<span id="cb3-2">  <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"1"</span> <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Michael"</span>,</span>
<span id="cb3-3">  <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"2"</span> <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Emily"</span>,</span>
<span id="cb3-4">  <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"3"</span> <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"John"</span>,</span>
<span id="cb3-5">  <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"4"</span> <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Jessica"</span></span>
<span id="cb3-6">)</span>
<span id="cb3-7"></span>
<span id="cb3-8">sex_map <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(</span>
<span id="cb3-9">  <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"1"</span> <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Male"</span>,</span>
<span id="cb3-10">  <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"2"</span> <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Female"</span></span>
<span id="cb3-11">)</span></code></pre></div></div>
</div>
<p><code>c()</code>の中に、<code>=</code>の左にデータフレーム内の表記を、右に表示したい表記を書いていきます。</p>
<p>今回はIDと性別を両方書き換えたいので、2種類の対応関係を示したベクトルを作成しています。</p>
</section>
<section id="recodeを使う" class="level3">
<h3 class="anchored" data-anchor-id="recodeを使う"><code>recode()</code>を使う</h3>
<p>この対応表をもとに、<code>recode()</code>関数を使っていきます。使う際は、<code>mutate()</code>と組み合わせます。</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb4" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1">df_recode <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> df <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span></span>
<span id="cb4-2">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mutate</span>(</span>
<span id="cb4-3">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">id =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">recode</span>(id, <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">!!!</span>id_map),</span>
<span id="cb4-4">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">sex =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">recode</span>(sex, <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">!!!</span>sex_map)</span>
<span id="cb4-5">  )</span></code></pre></div></div>
</div>
<div class="cell">
<div id="tbl-recode" class="cell quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-tbl figure">
<figcaption class="quarto-float-caption-top quarto-float-caption quarto-float-tbl" id="tbl-recode-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
表&nbsp;2: <code>recode()</code>を使用した表
</figcaption>
<div aria-describedby="tbl-recode-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<div class="cell-output-display">
<!-- preamble start -->

    <script>

      function styleCell_u6yu15ehqez41jf3m8y1(i, j, css_id) {
          var table = document.getElementById("tinytable_u6yu15ehqez41jf3m8y1");
          var cell = table.querySelector(`[data-row="${i}"][data-col="${j}"]`);
          if (cell) {
              console.log(`Styling cell at (${i}, ${j}) with class ${css_id}`);
              cell.classList.add(css_id);
          } else {
              console.warn(`Cell at (${i}, ${j}) not found.`);
          }
      }
      function spanCell_u6yu15ehqez41jf3m8y1(i, j, rowspan, colspan) {
        var table = document.getElementById("tinytable_u6yu15ehqez41jf3m8y1");
        const targetCell = table.querySelector(`[data-row="${i}"][data-col="${j}"]`);
        if (!targetCell) {
          console.warn(`Cell at (${i}, ${j}) not found.`);
        }

        // Get all cells that need to be removed
        const cellsToRemove = [];
        for (let r = 0; r < rowspan; r++) {
          for (let c = 0; c < colspan; c++) {
            if (r === 0 && c === 0) continue; // Skip the target cell
            const cell = table.querySelector(`[data-row="${i + r}"][data-col="${j + c}"]`);
            if (cell) {
              cellsToRemove.push(cell);
            }
          }
        }

        // Remove all cells
        cellsToRemove.forEach(cell => cell.remove());

        // Set rowspan and colspan of the target cell if it exists
        if (targetCell) {
          targetCell.rowSpan = rowspan;
          targetCell.colSpan = colspan;
        }
      }
      // tinytable span after
      window.addEventListener('load', function () {
          var cellsToStyle = [
            // tinytable style arrays after
          { positions: [ { i: '4', j: 0 }, { i: '4', j: 1 },  ], css_id: 'tinytable_css_f36kbd2kwo8ohyumz6lr',}, 
          { positions: [ { i: '0', j: 0 }, { i: '0', j: 1 },  ], css_id: 'tinytable_css_hndok72ip4ajsnws7swe',}, 
          ];

          // Loop over the arrays to style the cells
          cellsToStyle.forEach(function (group) {
              group.positions.forEach(function (cell) {
                  styleCell_u6yu15ehqez41jf3m8y1(cell.i, cell.j, group.css_id);
              });
          });
      });
    </script>

    <style>
      /* tinytable css entries after */
      .table td.tinytable_css_f36kbd2kwo8ohyumz6lr, .table th.tinytable_css_f36kbd2kwo8ohyumz6lr { border-bottom: solid #d3d8dc 0.1em; }
      .table td.tinytable_css_hndok72ip4ajsnws7swe, .table th.tinytable_css_hndok72ip4ajsnws7swe { border-top: solid #d3d8dc 0.1em; border-bottom: solid #d3d8dc 0.05em; }
    </style>
    <div class="container">
      <table class="table table-borderless" id="tinytable_u6yu15ehqez41jf3m8y1" style="width: auto; margin-left: auto; margin-right: auto;" data-quarto-disable-processing="true">
        <thead>
        
              <tr>
                <th scope="col" data-row="0" data-col="0">id</th>
                <th scope="col" data-row="0" data-col="1">sex</th>
              </tr>
        </thead>
        
        <tbody>
                <tr>
                  <td data-row="1" data-col="0">Michael</td>
                  <td data-row="1" data-col="1">Male</td>
                </tr>
                <tr>
                  <td data-row="2" data-col="0">Emily</td>
                  <td data-row="2" data-col="1">Female</td>
                </tr>
                <tr>
                  <td data-row="3" data-col="0">John</td>
                  <td data-row="3" data-col="1">Male</td>
                </tr>
                <tr>
                  <td data-row="4" data-col="0">Jessica</td>
                  <td data-row="4" data-col="1">Female</td>
                </tr>
        </tbody>
      </table>
    </div>
<!-- hack to avoid NA insertion in last line -->
</div>
</div>
</figure>
</div>
</div>
<p>しっかり置き換えられていますね。</p>
<p><code>!!!</code>という表記は見慣れないと思いますが、<code>id_map</code>や<code>sex_map</code>で作成したベクトルをバラバラにして渡すということです<sup>2</sup>。<code>recode(sex, "1" = "Male", "2" = "Female")</code>と同じ働きをします。</p>
<p>あらかじめ対応関係を表すベクトルを作って置くことで、使いまわすことができ、特に何回も表を作る際に効率化が図れます。</p>
</section>
</section>
<section id="おまけ" class="level2">
<h2 class="anchored" data-anchor-id="おまけ">おまけ</h2>
<p>表にするなら、列名も変えたいですよね。そんなときは{purrr}パッケージの<code>set_names()</code>関数を使います。これも{tidyverse}に入っていますので、特に追加でライブラリを読み込む必要はありません。</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb5" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1">col_names <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"名前"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"性別"</span>)</span>
<span id="cb5-2"></span>
<span id="cb5-3">df_set_names <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> df_recode <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span></span>
<span id="cb5-4">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">set_names</span>(col_names)</span></code></pre></div></div>
</div>
<div class="cell">
<div id="tbl-set-names" class="cell quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-tbl figure">
<figcaption class="quarto-float-caption-top quarto-float-caption quarto-float-tbl" id="tbl-set-names-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
表&nbsp;3: 列名を変更
</figcaption>
<div aria-describedby="tbl-set-names-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<div class="cell-output-display">
<!-- preamble start -->

    <script>

      function styleCell_twos0vh2cgdcm9rjbqtn(i, j, css_id) {
          var table = document.getElementById("tinytable_twos0vh2cgdcm9rjbqtn");
          var cell = table.querySelector(`[data-row="${i}"][data-col="${j}"]`);
          if (cell) {
              console.log(`Styling cell at (${i}, ${j}) with class ${css_id}`);
              cell.classList.add(css_id);
          } else {
              console.warn(`Cell at (${i}, ${j}) not found.`);
          }
      }
      function spanCell_twos0vh2cgdcm9rjbqtn(i, j, rowspan, colspan) {
        var table = document.getElementById("tinytable_twos0vh2cgdcm9rjbqtn");
        const targetCell = table.querySelector(`[data-row="${i}"][data-col="${j}"]`);
        if (!targetCell) {
          console.warn(`Cell at (${i}, ${j}) not found.`);
        }

        // Get all cells that need to be removed
        const cellsToRemove = [];
        for (let r = 0; r < rowspan; r++) {
          for (let c = 0; c < colspan; c++) {
            if (r === 0 && c === 0) continue; // Skip the target cell
            const cell = table.querySelector(`[data-row="${i + r}"][data-col="${j + c}"]`);
            if (cell) {
              cellsToRemove.push(cell);
            }
          }
        }

        // Remove all cells
        cellsToRemove.forEach(cell => cell.remove());

        // Set rowspan and colspan of the target cell if it exists
        if (targetCell) {
          targetCell.rowSpan = rowspan;
          targetCell.colSpan = colspan;
        }
      }
      // tinytable span after
      window.addEventListener('load', function () {
          var cellsToStyle = [
            // tinytable style arrays after
          { positions: [ { i: '4', j: 0 }, { i: '4', j: 1 },  ], css_id: 'tinytable_css_oulavbhnzaz94mi51hqc',}, 
          { positions: [ { i: '0', j: 0 }, { i: '0', j: 1 },  ], css_id: 'tinytable_css_fjkdj6b2hl4eed5ofo0h',}, 
          ];

          // Loop over the arrays to style the cells
          cellsToStyle.forEach(function (group) {
              group.positions.forEach(function (cell) {
                  styleCell_twos0vh2cgdcm9rjbqtn(cell.i, cell.j, group.css_id);
              });
          });
      });
    </script>

    <style>
      /* tinytable css entries after */
      .table td.tinytable_css_oulavbhnzaz94mi51hqc, .table th.tinytable_css_oulavbhnzaz94mi51hqc { border-bottom: solid #d3d8dc 0.1em; }
      .table td.tinytable_css_fjkdj6b2hl4eed5ofo0h, .table th.tinytable_css_fjkdj6b2hl4eed5ofo0h { border-top: solid #d3d8dc 0.1em; border-bottom: solid #d3d8dc 0.05em; }
    </style>
    <div class="container">
      <table class="table table-borderless" id="tinytable_twos0vh2cgdcm9rjbqtn" style="width: auto; margin-left: auto; margin-right: auto;" data-quarto-disable-processing="true">
        <thead>
        
              <tr>
                <th scope="col" data-row="0" data-col="0">名前</th>
                <th scope="col" data-row="0" data-col="1">性別</th>
              </tr>
        </thead>
        
        <tbody>
                <tr>
                  <td data-row="1" data-col="0">Michael</td>
                  <td data-row="1" data-col="1">Male</td>
                </tr>
                <tr>
                  <td data-row="2" data-col="0">Emily</td>
                  <td data-row="2" data-col="1">Female</td>
                </tr>
                <tr>
                  <td data-row="3" data-col="0">John</td>
                  <td data-row="3" data-col="1">Male</td>
                </tr>
                <tr>
                  <td data-row="4" data-col="0">Jessica</td>
                  <td data-row="4" data-col="1">Female</td>
                </tr>
        </tbody>
      </table>
    </div>
<!-- hack to avoid NA insertion in last line -->
</div>
</div>
</figure>
</div>
</div>
<p>あらかじめ<code>col_names</code>を作成しておきましたが、ここは任意です。<code>set_names()</code>の中に直接書くのも可能です。</p>
</section>
<section id="おわりに" class="level2">
<h2 class="anchored" data-anchor-id="おわりに">おわりに</h2>
<p>今回は表を整えるための<code>recode()</code>関数とおまけの<code>set_names()</code>関数をまとめました。</p>
<p>以前<a href="../../../pages/tips/240629_write_thesis/index.html">Quartoで論文を書くという記事</a>を書きましたが、論文はLaTeXで書きたい！という方には表だけLaTeXコードにして出力するという方法もありますので、それもまたまとめようかと思います。</p>


<!-- -->

</section>


<div id="quarto-appendix" class="default"><section id="footnotes" class="footnotes footnotes-end-of-document"><h2 class="anchored quarto-appendix-heading">注</h2>

<ol>
<li id="fn1"><p>ただし、<code>case_when()</code>だと「○○以上○○以下」みたいな条件分岐に対応できるという強みがありますが、今回は想定しません。あくまでもデータフレーム内の値をある別の表記に値 = 値で置き換えるということを想定します。↩︎</p></li>
<li id="fn2"><p>ややこしいですが、<code>id_map</code>自体はベクトルなので、ベクトルを渡すのではなく、中身を展開して渡したいということです。↩︎</p></li>
</ol>
</section></div> ]]></description>
  <category>R</category>
  <category>データ処理</category>
  <guid>https://yo5uke.com/pages/tips/250727_recode/</guid>
  <pubDate>Sat, 26 Jul 2025 15:00:00 GMT</pubDate>
</item>
<item>
  <title>RStudio Serverをインストールする【リモートデスクトップも】</title>
  <link>https://yo5uke.com/pages/tips/250715_rstudio_server/</link>
  <description><![CDATA[ 

<div class="social-share-buttons">

  <!-- Twitter (X) -->

  <a href="" id="js-share-twitter" class="share_button ri--twitter-x-fill" target="_blank" rel="nofollow noopener noreferrer"></a>



  <!-- Bluesky -->

  <a href="" id="js-share-bluesky" class="share_button ri--bluesky-fill" target="_blank" rel="nofollow noopener noreferrer"></a>

</div>



<script>

  const twitterUsername = "@5uke_y";

  const blueskyUsername = "@5uke.bsky.social";



  const share_url = encodeURIComponent(location.href);

  const share_title = document.title;



  // Twitter (X)

  document.getElementById('js-share-twitter').setAttribute(

    "href",

    "https://twitter.com/share?url=" + share_url + "&text=" + share_title + " " + encodeURIComponent(twitterUsername) + " より" +

    "&hashtags=rstats"

  );



  // Bluesky

  document.getElementById('js-share-bluesky').setAttribute(

    "href",

    "https://bsky.app/intent/compose?text=" + share_title + " " + share_url + " " + encodeURIComponent(blueskyUsername) + " より"

  );

</script>






<section id="はじめに" class="level2">
<h2 class="anchored" data-anchor-id="はじめに">はじめに</h2>
<p>RStudio Serverのインストール方法や使い方についてまとめます。</p>
<p>RStudio Serverを使えば各OSの違いに左右されず、どの端末からでも同じ環境で作業を継続できるのが特徴です。複数人での分析や大規模データ処理にも適しており、環境構築の一元化と省力化が図れます。</p>
<p>僕は最近仕事でRStudio Serverを使うかも…みたいな流れがあったので、改めてまとめてみることにしました。</p>
</section>
<section id="環境" class="level2">
<h2 class="anchored" data-anchor-id="環境">環境</h2>
<ul>
<li><p>Windows 11</p></li>
<li><p>PowerShell 7がインストール済み</p></li>
</ul>
<p>PowerShellは<a href="https://learn.microsoft.com/ja-jp/powershell/scripting/whats-new/migrating-from-windows-powershell-51-to-powershell-7?view=powershell-7.5">こちら</a>からインストールできますが、よくわからない場合は標準インストールされている「ターミナル」でも大丈夫です。</p>
</section>
<section id="インストール" class="level2">
<h2 class="anchored" data-anchor-id="インストール">インストール</h2>
<section id="wsl" class="level3">
<h3 class="anchored" data-anchor-id="wsl">WSL</h3>
<p>まずはWSLからインストールします。WSLはWindows Subsystem for Linuxの略であり、Windows上でネイティブにLinux環境を動作させる機能で、開発やデータ分析をLinux向けツールで行える柔軟な作業環境を提供してくれます。</p>
<p>まずはPowerShellを管理者権限で開きます。</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://yo5uke.com/pages/tips/250715_rstudio_server/image/powershell.png" class="img-fluid figure-img" style="width:60.0%"></p>
<figcaption>管理者権限で開きます</figcaption>
</figure>
</div>
<p>次に以下のコマンドを入力し、実行します。</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb1" style="background: #f1f3f5;"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb1-1"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">wsl</span> <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">--install</span></span></code></pre></div></div>
<p>インストールが終わると、Linuxディストリビューションのユーザー名とパスワードの作成を求められます<sup>1</sup>。</p>
<p>ユーザー名は何でも大丈夫です。パスワードもめちゃくちゃ簡単で問題ありません。パスワードは<strong>画面上には表示されませんが、ちゃんと入力されています</strong>。慌てて何回も入力しないようにしてください。</p>
<p>また、ユーザー名とパスワードは後ほど使うので忘れないようにしてください。</p>
</section>
<section id="rとrstudio-server" class="level3">
<h3 class="anchored" data-anchor-id="rとrstudio-server">RとRStudio Server</h3>
<p>設定まで終わったら、アプリの一覧から<i class="fa-brands fa-ubuntu" aria-label="ubuntu"></i>Ubuntu（これがLinuxのディストリビューションです）を開いてください。</p>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
<span class="screen-reader-only">Note</span>Ubuntuのバージョンについて
</div>
</div>
<div class="callout-body-container callout-body">
<p>本ページではUbuntu 22を前提に進めています。もしインストールしたバージョンが他のバージョンであった場合は若干コードが変わる可能性がありますので、<a href="https://posit.co/download/rstudio-server/">このページ</a>でバージョンを該当するものに変更したうえで都度コードをコピーし、実行してみてください。</p>
<p>バージョンを確認するためには以下をUbuntu上で実行してください。</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb2" style="background: #f1f3f5;"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb2-1"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">lsb_release</span> <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">-a</span></span></code></pre></div></div>
</div>
</div>
<p>するとコンソール画面が出てきますので、以下のコードを順々に入力、実行していきます。</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb3" style="background: #f1f3f5;"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb3-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sudo</span> apt update</span>
<span id="cb3-2"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sudo</span> apt upgrade <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">-y</span></span></code></pre></div></div>
<p>続いてRをインストールします。<a href="https://cran.rstudio.com/bin/linux/ubuntu/">こちら</a>のページからの転用です。</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb4" style="background: #f1f3f5;"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb4-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># update indices</span></span>
<span id="cb4-2"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sudo</span> apt update <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">-qq</span></span>
<span id="cb4-3"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># install two helper packages we need</span></span>
<span id="cb4-4"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sudo</span> apt install <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">--no-install-recommends</span> software-properties-common dirmngr</span>
<span id="cb4-5"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># add the signing key (by Michael Rutter) for these repos</span></span>
<span id="cb4-6"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># To verify key, run gpg --show-keys /etc/apt/trusted.gpg.d/cran_ubuntu_key.asc </span></span>
<span id="cb4-7"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Fingerprint: E298A3A825C0D65DFD57CBB651716619E084DAB9</span></span>
<span id="cb4-8"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">wget</span> <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">-qO-</span> https://cloud.r-project.org/bin/linux/ubuntu/marutter_pubkey.asc <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">|</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sudo</span> tee <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">-a</span> /etc/apt/trusted.gpg.d/cran_ubuntu_key.asc</span>
<span id="cb4-9"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># add the repo from CRAN -- lsb_release adjusts to 'noble' or 'jammy' or ... as needed</span></span>
<span id="cb4-10"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sudo</span> add-apt-repository <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"deb https://cloud.r-project.org/bin/linux/ubuntu </span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">$(</span><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">lsb_release</span> <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">-cs</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">)</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">-cran40/"</span></span>
<span id="cb4-11"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># install R itself</span></span>
<span id="cb4-12"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sudo</span> apt install <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">--no-install-recommends</span> r-base</span></code></pre></div></div>
<p>次にRStudio Serverをインストールします。<a href="https://posit.co/download/rstudio-server/">Posit社のガイド</a>からの転用です。</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb5" style="background: #f1f3f5;"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb5-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sudo</span> apt-get install gdebi-core</span>
<span id="cb5-2"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">wget</span> https://download2.rstudio.org/server/focal/amd64/rstudio-server-2025.05.1-513-amd64.deb</span>
<span id="cb5-3"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sudo</span> gdebi rstudio-server-2025.05.1-513-amd64.deb</span></code></pre></div></div>
<p>これでインストールは完了です。続いて次のコマンドを実行し、RStudio Serverを立ち上げます。</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb6" style="background: #f1f3f5;"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb6-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sudo</span> rstudio-server start</span></code></pre></div></div>
</section>
</section>
<section id="rstudio-serverを立ち上げる" class="level2">
<h2 class="anchored" data-anchor-id="rstudio-serverを立ち上げる">RStudio Serverを立ち上げる</h2>
<p>それではRStudio Serverを立ち上げていきましょう。上のコマンドで起動までできているので、ブラウザ上で立ち上げていきます。</p>
<p>PC上の任意のブラウザを開き、アドレスバーに<code>localhost:8787</code>と入力し、開きます。</p>
<p>すると以下のような画面が出てきます。</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://yo5uke.com/pages/tips/250715_rstudio_server/image/rstudio_server_login.png" class="img-fluid quarto-figure quarto-figure-center figure-img" style="width:80.0%"></p>
</figure>
</div>
<p>ユーザー名とパスワードを求められますので、先ほどUbuntuで設定したものを入力してください。</p>
<p>そうしてサインインすることで、RStudioの画面に入ることができます。</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://yo5uke.com/pages/tips/250715_rstudio_server/image/rstudio_server.png" class="img-fluid quarto-figure quarto-figure-center figure-img" style="width:80.0%"></p>
</figure>
</div>
<p>ここからは通常のRと同様に作業を進めることができます。</p>
</section>
<section id="ファイルの扱いについて" class="level2">
<h2 class="anchored" data-anchor-id="ファイルの扱いについて">ファイルの扱いについて</h2>
<p>どのようにしてデータを入れたりファイルを追加したりすればよいかについて説明します。</p>
<p>RStudio上でできることはデスクトップ版とほとんど同じで、さらにエクスプローラー上の動作も通常と同じようにすることができます。</p>
<p>エクスプローラーを開いて左のサイドバーを一番下までスクロールすると、Linuxが作成されていることがわかります。</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://yo5uke.com/pages/tips/250715_rstudio_server/image/explorer_linux.png" class="img-fluid figure-img" style="width:70.0%"></p>
<figcaption>サイドバーの一番下です</figcaption>
</figure>
</div>
<p>するとUbuntuが中に作成されていますので、ダブルクリックで入っていきます。<code>home/[設定したユーザー名]</code>があると思うので、その中に入ると、そこがWindowsでいうところの<code>C:\Users\ユーザー\</code>に該当します。ベースとなるディレクトリです。</p>
<p>この中にプロジェクトのフォルダを作成していけば、RStudio Server上でも見ることができますし、入れたファイルを操作することが可能になります。</p>
<p>まあまあ面倒なところにあるので、クイックアクセスにピン留めしたりデスクトップにショートカットを作ったりして置くのが便利だと思います。</p>
<p>ここまでの操作で個人の作業はできるようになりました！続いては、ホストとなるPCで環境を作成し、それを別のデバイスからアクセスできるようにする方法についてまとめていきます！</p>
</section>
<section id="リモートデスクトップを活用する" class="level2">
<h2 class="anchored" data-anchor-id="リモートデスクトップを活用する">リモートデスクトップを活用する</h2>
<p>例えば扱うデータが大きすぎて個々のノートパソコンでは扱いきれず、1台高スペックのデスクトップを用意してそこにアクセスして作業をしたい、というようなケースを考えます。</p>
<p>ここで個々のPCからデスクトップにアクセスして作業をするのですが、この作業はあくまでもデスクトップ上で行われるので、各PCがハイスペックである必要はありません。デスクトップの画面を自分のPCに投影しているようなイメージです。</p>
<section id="環境-1" class="level3">
<h3 class="anchored" data-anchor-id="環境-1">環境</h3>
<ul>
<li><p>無線LAN（Wi-Fi）を使用</p></li>
<li><p>ホストと各PCは同じネットワーク（Wi-Fi）を使用</p></li>
</ul>
</section>
<section id="デスクトップの環境構築" class="level3">
<h3 class="anchored" data-anchor-id="デスクトップの環境構築">デスクトップの環境構築</h3>
<p>まずすべきことは、上で書いたような環境構築を、デスクトップPC（ホスト）で実行することです。RStudio Serverを使えるようにしておいてください。</p>
<section id="ipアドレスを確認" class="level4">
<h4 class="anchored" data-anchor-id="ipアドレスを確認">IPアドレスを確認</h4>
<p><strong>【ホストのPC】</strong></p>
<p>他のPC（クライアント）からアクセスできるようにするには、まずホストのIPアドレスを確認しておく必要があります。PowerShellを開いたら、以下のコマンドを実行します。</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb7" style="background: #f1f3f5;"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb7-1"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">ipconfig</span></span></code></pre></div></div>
<p>実行すると、なにやら長々と表示されるはずです。「Windows IP 構成」の下に例えば「イーサネット アダプター vEthernet (Default Switch):」や、「イーサネット アダプター vEthernet (WSL (Hyper-V firewall)):」などいろいろ出てきます。</p>
<p>その中の下の方に「Wireless LAN adapter Wi-Fi:」があります。この中に「IPv4 アドレス」があり、その右に数字が書かれています（例：192.xxx.x.xx）。これを後ほど使うので、押さえておいてください。</p>
<p>また、もう一度PowerShellは使うので、画面も開いておいてください。</p>
<p><strong>【ホストPCのWSL】</strong></p>
<p>次にWindowsのアプリ一覧からUbuntu <i class="fa-brands fa-ubuntu" aria-label="ubuntu"></i> を開きます。</p>
<p>開けたら次のコマンドを実行してください。</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb8" style="background: #f1f3f5;"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb8-1"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">ip</span> addr</span></code></pre></div></div>
<p>これも同様に2種類出てくると思いますが、下にある<strong>eth0</strong>が必要な方です。「inet 172.xxx.xx.xx」のような形で表示されていると思いますので、これを押さえておきます。スラッシュの前までで大丈夫です。</p>
</section>
<section id="ポートの設定" class="level4">
<h4 class="anchored" data-anchor-id="ポートの設定">ポートの設定</h4>
<p>今押さえた<strong>WSLの方</strong>のIPアドレスを使用します（後で確認した方です）。</p>
<p>PowerShellに戻って次のコマンドを実行します。</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb9" style="background: #f1f3f5;"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb9-1"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">netsh</span> interface portproxy add v4tov4 listenport=8787 listenaddress=0.0.0.0 connectport=8787 connectaddress=<span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">[</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">WSLのIPアドレス</span><span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">]</span></span></code></pre></div></div>
<p>最後の部分を四角括弧ごとWSLのIPアドレスに置き換えて下さい。</p>
</section>
<section id="ホストpcでファイアウォールの設定" class="level4">
<h4 class="anchored" data-anchor-id="ホストpcでファイアウォールの設定"><strong>ホストPCでファイアウォールの設定</strong></h4>
<p>次に引き続きホストのPC上で、ファイアウォールの設定を行います。</p>
<p>設定を開き、検索窓から「ファイアウォール」と検索し、「Windows Defender ファイアウォール」をクリックして開きます。</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://yo5uke.com/pages/tips/250715_rstudio_server/image/defender_setting.png" class="img-fluid figure-img" style="width:41.0%"></p>
<figcaption>下から2番目のです</figcaption>
</figure>
</div>
<p>開いたウィンドウの左側に「詳細設定」という項目があるのでクリックして進みます。</p>
<p>「受信の規則」→右側から「新しい規則」→「ポート」を選択して次へ進み、TCP、特定のローカルポートに「8787」を入力して次へ進み、「接続を許可する」でさらに次へ進み、すべてのチェックボックスにチェックが入った状態で次へ進みます。</p>
<p>名前を付ける必要がありますが、何でもよいと思います。RStudio Serverを使っていることがわかる名前が良いと思います。入力したら完了で終わりです。</p>
<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
<span class="screen-reader-only">Tip</span>コマンドで一発
</div>
</div>
<div class="callout-body-container callout-body">
<p>以下のコマンドをPowerShellで入力すれば同じことができます。こっちの方が楽かもですね。</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb10" style="background: #f1f3f5;"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb10-1"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">New-NetFirewallRule</span> <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">-DisplayName</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"RStudio Server"</span> <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">-Direction</span> Inbound <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">-LocalPort</span> 8787 <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">-Protocol</span> TCP <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">-Action</span> Allow</span></code></pre></div></div>
</div>
</div>
</section>
<section id="wsl側でrstudio-serverの動作を確認" class="level4">
<h4 class="anchored" data-anchor-id="wsl側でrstudio-serverの動作を確認">WSL側でRStudio Serverの動作を確認</h4>
<p>Ubuntuを再度開き、以下のコマンドを実行してRStudio Serverが起動しているかどうかを再確認します。</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb11" style="background: #f1f3f5;"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb11-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sudo</span> rstudio-server status</span></code></pre></div></div>
<p><code>sudo</code>で始まるコマンドはパスワードを求められますので適宜入力して進んでください。</p>
<p>ここで<code>active (running)</code>が記載されていればOKです。もし<code>inactive (dead)</code>となっていたら、以下のコマンドから起動してください。</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb12" style="background: #f1f3f5;"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb12-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sudo</span> rstudio-server start</span></code></pre></div></div>
</section>
<section id="ブラウザでアクセスを確認する" class="level4">
<h4 class="anchored" data-anchor-id="ブラウザでアクセスを確認する">ブラウザでアクセスを確認する</h4>
<p>それでは<strong>ホスト上で</strong>動作確認をしてみましょう。</p>
<p>ブラウザを立ち上げ<code>localhost:8787</code>を入力し開きます。先ほどと同様のサインイン画面が出てくれば問題ありません。</p>
</section>
<section id="別端末クライアントからのアクセス確認" class="level4">
<h4 class="anchored" data-anchor-id="別端末クライアントからのアクセス確認">別端末（クライアント）からのアクセス確認</h4>
<p>クライアントからは先ほど確認したローカルのIPアドレスを<code>localhost</code>の代わりに使用します。例えば<code>192.xxx.x.xx:8787</code>といった具合です。</p>
<p>これが開けてサインイン画面に移行できれば成功です。自分のPCのスペックに依存せず、ホストのPCにアクセスしてRStudioから作業を行うことができます。</p>
<p>繰り返しになりますが、<strong>実行しているのはホストのデスクトップ</strong>です。ブラウザであれば何でもよいので、同じネットワークに接続しているのであればスマホのブラウザからアクセスすることもできます。</p>
</section>
</section>
</section>
<section id="終わり" class="level2">
<h2 class="anchored" data-anchor-id="終わり">終わり！</h2>
<p>特にリモートデスクトップの説明で長くなってしまいましたが、これでRStudio Serverを使えるようになるはずです。</p>
<p>用途に合わせて、いろいろ試してみてください！</p>


<!-- -->

</section>


<div id="quarto-appendix" class="default"><section id="footnotes" class="footnotes footnotes-end-of-document"><h2 class="anchored quarto-appendix-heading">注</h2>

<ol>
<li id="fn1"><p>求められない場合は、続けて<code>wsl</code>とだけ入力して実行してください。↩︎</p></li>
</ol>
</section></div> ]]></description>
  <category>R</category>
  <category>RStudio</category>
  <category>Windows</category>
  <category>WSL</category>
  <guid>https://yo5uke.com/pages/tips/250715_rstudio_server/</guid>
  <pubDate>Mon, 14 Jul 2025 15:00:00 GMT</pubDate>
  <media:content url="https://yo5uke.com/pages/tips/250715_rstudio_server/image/rstudio_server_login.png" medium="image" type="image/png" height="74" width="144"/>
</item>
<item>
  <title>【スクレイピング】Rでe-Statのメッシュ人口データファイルを一気に取得する</title>
  <link>https://yo5uke.com/pages/tips/250613_scraping_pop_by_mesh/</link>
  <description><![CDATA[ 

<div class="social-share-buttons">

  <!-- Twitter (X) -->

  <a href="" id="js-share-twitter" class="share_button ri--twitter-x-fill" target="_blank" rel="nofollow noopener noreferrer"></a>



  <!-- Bluesky -->

  <a href="" id="js-share-bluesky" class="share_button ri--bluesky-fill" target="_blank" rel="nofollow noopener noreferrer"></a>

</div>



<script>

  const twitterUsername = "@5uke_y";

  const blueskyUsername = "@5uke.bsky.social";



  const share_url = encodeURIComponent(location.href);

  const share_title = document.title;



  // Twitter (X)

  document.getElementById('js-share-twitter').setAttribute(

    "href",

    "https://twitter.com/share?url=" + share_url + "&text=" + share_title + " " + encodeURIComponent(twitterUsername) + " より" +

    "&hashtags=rstats"

  );



  // Bluesky

  document.getElementById('js-share-bluesky').setAttribute(

    "href",

    "https://bsky.app/intent/compose?text=" + share_title + " " + share_url + " " + encodeURIComponent(blueskyUsername) + " より"

  );

</script>






<section id="はじめに" class="level2">
<h2 class="anchored" data-anchor-id="はじめに">はじめに</h2>
<p><a href="../../../pages/tips/250319_scraping/index.html">以前の記事</a>でe-Statから境界データ（シェープファイル）をスクレイピングで取得する方法をご紹介しました。</p>
<p>今回は国勢調査をもとに公開しているメッシュごとの人口データを取得するコードの覚書です。時々実行することがあるので<del>自分は忘れっぽいですし</del>残しておくことにしました。</p>
<p>詳細は前回とほぼ同じで、URL等が若干異なるくらいです。コードについては以下で詳しめに書いたので、不明点があればご覧下さい。</p>
<div class="callout callout-style-simple callout-tip no-icon">
<div class="callout-body d-flex">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-body-container">
<p><a href="../../../pages/tips/250319_scraping/index.html">【スクレイピング】rvestを使ってe-Statからファイルを取得する</a></p>
</div>
</div>
</div>
</section>
<section id="コード" class="level2">
<h2 class="anchored" data-anchor-id="コード">コード</h2>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb1" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(rvest)</span>
<span id="cb1-2"></span>
<span id="cb1-3"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># データを保存したいフォルダを指定</span></span>
<span id="cb1-4">save_dir <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> here<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">here</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"data/pop_by_mesh"</span>)</span>
<span id="cb1-5"></span>
<span id="cb1-6"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 保存したいフォルダがない場合に作成</span></span>
<span id="cb1-7"><span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> (<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">!</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">dir.exists</span>(save_dir)) {</span>
<span id="cb1-8">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">dir.create</span>(save_dir)</span>
<span id="cb1-9">}</span>
<span id="cb1-10"></span>
<span id="cb1-11">base_url <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"https://www.e-stat.go.jp"</span></span>
<span id="cb1-12"></span>
<span id="cb1-13"><span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> (i <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">8</span>) {</span>
<span id="cb1-14">  url <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">paste0</span>(</span>
<span id="cb1-15">    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"https://www.e-stat.go.jp/gis/statmap-search?page="</span>,</span>
<span id="cb1-16">    i,</span>
<span id="cb1-17">    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"&amp;type=1&amp;toukeiCode=00200521&amp;toukeiYear=2020&amp;aggregateUnit=H"</span>,</span>
<span id="cb1-18">    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"&amp;serveyId=H002005112020&amp;statsId=T001141&amp;datum=2011"</span></span>
<span id="cb1-19">  )</span>
<span id="cb1-20"></span>
<span id="cb1-21">  html <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">read_html_live</span>(url)</span>
<span id="cb1-22">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">Sys.sleep</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)</span>
<span id="cb1-23"></span>
<span id="cb1-24">  links <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> html <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span></span>
<span id="cb1-25">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">html_elements</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"a"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span></span>
<span id="cb1-26">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">html_attr</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"href"</span>)</span>
<span id="cb1-27"></span>
<span id="cb1-28">  csv_links <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> links[<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">grepl</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"data</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">\\</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">?statsId=T001141"</span>, links)]</span>
<span id="cb1-29">  full_urls <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">paste0</span>(base_url, csv_links)</span>
<span id="cb1-30"></span>
<span id="cb1-31">  <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> (j <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">seq_along</span>(full_urls)) {</span>
<span id="cb1-32">    code <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sub</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">".*code=([0-9]+).*"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">\\</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">1"</span>, csv_links[j])</span>
<span id="cb1-33">    zip_path <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">file.path</span>(save_dir, <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">paste0</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"pop_mesh"</span>, code, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">".zip"</span>))</span>
<span id="cb1-34">    txt_path <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">file.path</span>(save_dir, <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">paste0</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"pop_mesh"</span>, code, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">".txt"</span>))</span>
<span id="cb1-35">    </span>
<span id="cb1-36">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 既にファイルがある場合は次のループへ</span></span>
<span id="cb1-37">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> (<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">file.exists</span>(txt_path)) <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">next</span></span>
<span id="cb1-38"></span>
<span id="cb1-39">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">tryCatch</span>({</span>
<span id="cb1-40">      <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">download.file</span>(full_urls[j], <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">destfile =</span> zip_path, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">mode =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"wb"</span>)</span>
<span id="cb1-41">      <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">Sys.sleep</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)</span>
<span id="cb1-42"></span>
<span id="cb1-43">      unzip_files <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">unzip</span>(zip_path, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">list =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">TRUE</span>)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>Name</span>
<span id="cb1-44">      <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">unzip</span>(zip_path, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">exdir =</span> save_dir)</span>
<span id="cb1-45"></span>
<span id="cb1-46">      <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> (original_name <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> unzip_files) {</span>
<span id="cb1-47">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> (<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">grepl</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">\\</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">.txt$"</span>, original_name, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">ignore.case =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">TRUE</span>)) {</span>
<span id="cb1-48">          old_path <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">file.path</span>(save_dir, original_name)</span>
<span id="cb1-49">          new_path <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> txt_path</span>
<span id="cb1-50">          <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">file.rename</span>(old_path, new_path)</span>
<span id="cb1-51">        }</span>
<span id="cb1-52">      }</span>
<span id="cb1-53"></span>
<span id="cb1-54">      <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">file.remove</span>(zip_path)</span>
<span id="cb1-55"></span>
<span id="cb1-56">    }, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">error =</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">function</span>(e) {</span>
<span id="cb1-57">      <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">warning</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">paste</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"エラー："</span>, full_urls[j]))</span>
<span id="cb1-58">    })</span>
<span id="cb1-59"></span>
<span id="cb1-60">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">Sys.sleep</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>)</span>
<span id="cb1-61">  }</span>
<span id="cb1-62">}</span></code></pre></div></div>
<p>最初の</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb2" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1">save_dir <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> here<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">here</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"data/pop_by_mesh"</span>)</span></code></pre></div></div>
<p>の部分だけ自分のディレクトリのパスに変えれば、あとはそっくりそのまま実行できると思います。次の<code>if</code>でもしディレクトリがない場合でも作成するようにしている<sup>1</sup>ので、エクスプローラー上でフォルダを作らなくても使うことができます。</p>
<p>ダウンロードにはまあまあ時間がかかりますが、手作業よりは圧倒的に速いので、機会があれば使ってみてください。</p>


<!-- -->

</section>


<div id="quarto-appendix" class="default"><section id="footnotes" class="footnotes footnotes-end-of-document"><h2 class="anchored quarto-appendix-heading">注</h2>

<ol>
<li id="fn1"><p>ある場合はスキップするので、わざわざ消さなくても問題ありません。↩︎</p></li>
</ol>
</section></div> ]]></description>
  <category>R</category>
  <category>データ処理</category>
  <category>備忘録</category>
  <guid>https://yo5uke.com/pages/tips/250613_scraping_pop_by_mesh/</guid>
  <pubDate>Thu, 12 Jun 2025 15:00:00 GMT</pubDate>
</item>
<item>
  <title>【データ管理】DVCの設定まとめ</title>
  <link>https://yo5uke.com/pages/tips/250601_dvc/</link>
  <description><![CDATA[ 

<div class="social-share-buttons">

  <!-- Twitter (X) -->

  <a href="" id="js-share-twitter" class="share_button ri--twitter-x-fill" target="_blank" rel="nofollow noopener noreferrer"></a>



  <!-- Bluesky -->

  <a href="" id="js-share-bluesky" class="share_button ri--bluesky-fill" target="_blank" rel="nofollow noopener noreferrer"></a>

</div>



<script>

  const twitterUsername = "@5uke_y";

  const blueskyUsername = "@5uke.bsky.social";



  const share_url = encodeURIComponent(location.href);

  const share_title = document.title;



  // Twitter (X)

  document.getElementById('js-share-twitter').setAttribute(

    "href",

    "https://twitter.com/share?url=" + share_url + "&text=" + share_title + " " + encodeURIComponent(twitterUsername) + " より" +

    "&hashtags=rstats"

  );



  // Bluesky

  document.getElementById('js-share-bluesky').setAttribute(

    "href",

    "https://bsky.app/intent/compose?text=" + share_title + " " + share_url + " " + encodeURIComponent(blueskyUsername) + " より"

  );

</script>






<section id="はじめに" class="level2">
<h2 class="anchored" data-anchor-id="はじめに">はじめに</h2>
<p><a href="../../../pages/tips/241219_container/index.html">環境構築の記事</a>でDVCを使用したデータ管理についてもまとめていますが、Google Cloud Projectを使用するため若干ややこしいことに加え、定期的にトークンが切れて認証し直さないといけないという大きいデメリットがありました。</p>
<p>今回は初回の設定のみで設定がすむ方法について解説します。</p>
<p><a href="../../../pages/tips/241219_container/index.html">記事</a>と同様の流れでの作業を想定しているので、その点ご留意ください。</p>
</section>
<section id="google-cloud-console" class="level2">
<h2 class="anchored" data-anchor-id="google-cloud-console">Google Cloud Console</h2>
<ol type="1">
<li><a href="https://console.cloud.google.com/">Google Cloud Console</a>へアクセス</li>
<li>画面上部のボックスからプロジェクトを作成
<ul>
<li>左上にGoogle Cloudと書いてある部分の右です</li>
<li>出てくるウィンドウの右上から作れます</li>
</ul></li>
</ol>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://yo5uke.com/pages/tips/250601_dvc/image/new_project.png" class="img-fluid quarto-figure quarto-figure-center figure-img" style="width:60.0%"></p>
</figure>
</div>
<ol start="3" type="1">
<li>画面左のメニューから「IAMと管理」を選択
<ul>
<li>左にメニューがない場合は左上の3本線から開けます</li>
</ul></li>
<li>サイドバーの真ん中上あたりから「サービスアカウント」を選択</li>
<li>画面上部の「サービスアカウントを作成」へ進む</li>
<li>任意の名前と説明を入力し、完了を押下
<ul>
<li>権限のところはスキップで構いません</li>
</ul></li>
</ol>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://yo5uke.com/pages/tips/250601_dvc/image/create_service_account.png" class="img-fluid quarto-figure quarto-figure-center figure-img" style="width:60.0%"></p>
</figure>
</div>
<ol start="7" type="1">
<li>メールの列に書いてある、長いメールアドレスをコピーしておく
<ul>
<li>後ほどGoogle Driveのフォルダにこのアドレスを共有します</li>
</ul></li>
<li>作成したサービスアカウントの一番右にある「操作」から「鍵を管理」を選択
<ul>
<li>長ったらしいメールアドレスの右側にある点々の部分です</li>
</ul></li>
<li>「キーを追加」→「新しい鍵を作成」→「JSON」を選択、作成へ進む</li>
<li>ファイルとして保存されるので、作業ディレクトリへ保存する
<ul>
<li><code>.secrets</code>フォルダを作り、その中へ保存してください</li>
<li>ファイル名は変えて問題ありません。<code>key.json</code>とかで大丈夫です</li>
</ul></li>
</ol>
</section>
<section id="google-drive" class="level2">
<h2 class="anchored" data-anchor-id="google-drive">Google Drive</h2>
<ol type="1">
<li>Google Driveの任意の場所にプロジェクトでデータをしまうフォルダを作成する</li>
<li>フォルダの共有の設定から、先ほどコピーしたメールアドレスを貼り付け共有する</li>
</ol>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://yo5uke.com/pages/tips/250601_dvc/image/dvc_share_mail.png" class="img-fluid figure-img" style="width:50.0%"></p>
<figcaption>メールアドレスを貼り付け、権限を「編集者」にして共有します</figcaption>
</figure>
</div>
<ol start="3" type="1">
<li>Googleドライブで作成したフォルダのIDをコピー
<ul>
<li>IDは、ドライブでフォルダを開いたときのURLで、最後のスラッシュ（~/folders/）より右側の部分です</li>
</ul></li>
</ol>
</section>
<section id="vscode" class="level2">
<h2 class="anchored" data-anchor-id="vscode">VSCode</h2>
<ol type="1">
<li>VSCodeのターミナルで次のコマンドを入力して実行 - 最後の部分（四角括弧ごと）をコピーしたIDに変更してください</li>
</ol>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb1" style="background: #f1f3f5;"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb1-1"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">dvc</span> init <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">&amp;&amp;</span> <span class="ex" style="color: null;
background-color: null;
font-style: inherit;">dvc</span> remote add <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">-d</span> myremote gdrive://[Google DriveのフォルダID]</span></code></pre></div></div>
<ol start="2" type="1">
<li>サービスアカウントを有効にする
<ul>
<li>以下のコマンドを実行してください</li>
</ul></li>
</ol>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb2" style="background: #f1f3f5;"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb2-1"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">dvc</span> remote modify myremote gdrive_use_service_account true</span></code></pre></div></div>
<ol start="3" type="1">
<li>次のコマンドを実行する
<ul>
<li>フォルダ名やファイル名を自分で変えた場合、修正してから実行してください</li>
</ul></li>
</ol>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb3" style="background: #f1f3f5;"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb3-1"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">dvc</span> remote modify myremote <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">--local</span> <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">\</span></span>
<span id="cb3-2">    gdrive_service_account_json_file_path .secrets/key.json</span></code></pre></div></div>
</section>
<section id="設定ファイルをgitignore重要" class="level2">
<h2 class="anchored" data-anchor-id="設定ファイルをgitignore重要">設定ファイルをgitignore（重要！）</h2>
<p>いま<code>.secrets</code>を作りましたが、この中身はいわば個人情報であり他人に漏らしていいものではないので、<code>.gitignore</code>ファイルにしっかり記載し、Gitのトラッキングを解除しておく必要があります。</p>
<p>以下のように<code>.gitignore</code>に追記してください。</p>
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>.gitignore</strong></pre>
</div>
<pre data-filename=".gitignore"><code>/.secrets/</code></pre>
</div>
<p>これで<code>.secrets</code>フォルダの中身がGitに追跡されません。</p>
</section>
<section id="データフォルダを作ったら適宜add-push" class="level2">
<h2 class="anchored" data-anchor-id="データフォルダを作ったら適宜add-push">データフォルダを作ったら適宜<code>add</code>, <code>push</code></h2>
<p>以上で設定は終了です。</p>
<p><a href="../../../pages/tips/241219_container/index.html">環境構築の記事</a>でも説明しているように、あとは<code>data</code>などデータを入れるフォルダを作りデータを追加したら、<code>dvc add data/</code>を実行し、最後は<code>dvc push</code>でプッシュすることでデータファイルをGoogle Drive上で管理することができます。</p>
</section>
<section id="共有する場合" class="level2">
<h2 class="anchored" data-anchor-id="共有する場合">共有する場合</h2>
<p>共同研究などで他の人と作業を進める場合はこのデータフォルダも共有したいということになると思います。その場合は、<a href="../../../pages/tips/241219_container/index.html">記事</a>における共有に加え、<code>.secrets</code>は別に送る必要があります（Gitで追跡していないのでクローンしても<code>.secrets</code>は現れないからです）。</p>
<p>別に共有したうえでワーキングディレクトリに<code>.secrets</code>を置いてもらえば<code>dvc pull</code>でデータを引っ張ってくることができるようになります。</p>
<p>その際、<code>.dvc/config.local</code>ファイルを以下のように編集してもらってください。</p>
<pre><code>[remote "myremote"]
    gdrive_use_service_account = true
    gdrive_service_account_json_file_path = ../.secrets/key.json</code></pre>
<p><code>../</code>は1つ上の階層のフォルダの～という意味なので、これであっています。<code>.dvc/config.local</code>もgitignoreされているので、クローン下だけでは共有されません。</p>
</section>
<section id="感想" class="level2">
<h2 class="anchored" data-anchor-id="感想">感想</h2>
<p>今のところ結構いい感じです。例えばこのウェブサイトを作るうえではあまり新しくデータを追加することがないので、追加するたびにトークンが切れて認証のし直しということが頻発していました。今回の方法では再認証がない（はず）なので、ストレスが軽減されたかなという印象です。</p>
<p>何かあればぜひコメントまでお願いします。</p>


<!-- -->

</section>

 ]]></description>
  <category>DVC</category>
  <guid>https://yo5uke.com/pages/tips/250601_dvc/</guid>
  <pubDate>Sat, 31 May 2025 15:00:00 GMT</pubDate>
  <media:content url="https://yo5uke.com/pages/tips/250601_dvc/image/dvc_share_mail.png" medium="image" type="image/png" height="119" width="144"/>
</item>
<item>
  <title>【パッケージ開発】fixesでイベントスタディを効率化</title>
  <link>https://yo5uke.com/pages/tips/250525_fixes/</link>
  <description><![CDATA[ 

<div class="social-share-buttons">

  <!-- Twitter (X) -->

  <a href="" id="js-share-twitter" class="share_button ri--twitter-x-fill" target="_blank" rel="nofollow noopener noreferrer"></a>



  <!-- Bluesky -->

  <a href="" id="js-share-bluesky" class="share_button ri--bluesky-fill" target="_blank" rel="nofollow noopener noreferrer"></a>

</div>



<script>

  const twitterUsername = "@5uke_y";

  const blueskyUsername = "@5uke.bsky.social";



  const share_url = encodeURIComponent(location.href);

  const share_title = document.title;



  // Twitter (X)

  document.getElementById('js-share-twitter').setAttribute(

    "href",

    "https://twitter.com/share?url=" + share_url + "&text=" + share_title + " " + encodeURIComponent(twitterUsername) + " より" +

    "&hashtags=rstats"

  );



  // Bluesky

  document.getElementById('js-share-bluesky').setAttribute(

    "href",

    "https://bsky.app/intent/compose?text=" + share_title + " " + share_url + " " + encodeURIComponent(blueskyUsername) + " より"

  );

</script>






<section id="はじめに" class="level2">
<h2 class="anchored" data-anchor-id="はじめに">はじめに</h2>
<p>本ページでは、two-way fixed effectsモデルのDiDにおけるイベントスタディを行うパッケージ、<code>fixes</code>について説明します。</p>
<p>僕が今年の年始から地道に作成してきたパッケージで、一度tipsに書いたことがあるのですが、最近アップデートも重なってきたので再度書き直すことにしました。</p>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
<span class="screen-reader-only">Note</span>ご意見待ってます
</div>
</div>
<div class="callout-body-container callout-body">
<p>実戦経験が足りないパッケージなので、挙動がおかしかったり、こういう機能にも対応してほしいということがあれば、ページ下のコメントからどしどしお寄せください。こぢんまりしたページなので、いただいたものは余裕で全部対応できると思います。</p>
</div>
</div>
<p>これまでは処置個体において処置タイミングが同一のDiDにのみ対応していましたが、直近のアップデートで<strong>各個体で処置タイミングが異なる、いわゆるStaggered DiDにも対応しました</strong>。</p>
<p>果たしてあらゆるケースに対応できているか、個人開発のパッケージとしては不安ではありますが、いくつかのデータセットでテストした分には問題なかったので、そのテストコードと併せて解説していきます。</p>
</section>
<section id="使用するパッケージ" class="level2">
<h2 class="anchored" data-anchor-id="使用するパッケージ">使用するパッケージ</h2>
<p>使用するのは<code>fixes</code>です。インストールは以下のコマンドでできます。</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb1" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1">pak<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">pak</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"fixes"</span>)</span></code></pre></div></div>
<p>もしくは</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb2" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">install.packages</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"fixes"</span>)</span></code></pre></div></div>
<p>です。開発版はGitHubからインストールできます。</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb3" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1">pak<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">pak</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"yo5uke/fixes"</span>)</span></code></pre></div></div>
</section>
<section id="準備" class="level2">
<h2 class="anchored" data-anchor-id="準備">準備</h2>
<p>パッケージを読み込んで、デモに使うデータを準備します。</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb4" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(fixes)</span>
<span id="cb4-2"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(tidyverse)</span></code></pre></div></div>
</div>
<p>データは<code>fixest</code>パッケージで用意されているものと、MixtapeのStaggered DiDの章で使用されているものを使います。</p>
<p>また、不足している変数を追加し、使わない変数もあるのであらかじめ除いておきます。</p>
<p><code>df_stagg</code>は未処置の個体の処置年、処置からの相対年をNAに変更し、<code>df_castle</code>に関してはMixtape内で行われている処理をしておきます<sup>1</sup></p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb5" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1">df_base <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> fixest<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span>base_did</span>
<span id="cb5-2">df_stagg <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> fixest<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span>base_stagg</span>
<span id="cb5-3">castle <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> haven<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">read_dta</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"https://github.com/scunning1975/mixtape/raw/master/castle.dta"</span>)</span>
<span id="cb5-4"></span>
<span id="cb5-5"></span>
<span id="cb5-6">df_stagg <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> df_stagg <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb5-7">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mutate</span>(</span>
<span id="cb5-8">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">year_treated =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">if_else</span>(year_treated <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10000</span>, <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">NA_real_</span>, year_treated), </span>
<span id="cb5-9">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">time_to_treatment =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">if_else</span>(time_to_treatment <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1000</span>, <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">NA_real_</span>, time_to_treatment)</span>
<span id="cb5-10">  )</span>
<span id="cb5-11"></span>
<span id="cb5-12"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 以下Mixtape参考</span></span>
<span id="cb5-13">dropped_vars <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"r20004"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"r20014"</span>,</span>
<span id="cb5-14">                  <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"r20024"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"r20034"</span>,</span>
<span id="cb5-15">                  <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"r20044"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"r20054"</span>,</span>
<span id="cb5-16">                  <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"r20064"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"r20074"</span>,</span>
<span id="cb5-17">                  <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"r20084"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"r20094"</span>,</span>
<span id="cb5-18">                  <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"r20101"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"r20102"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"r20103"</span>,</span>
<span id="cb5-19">                  <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"r20104"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"trend_9"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"trend_46"</span>,</span>
<span id="cb5-20">                  <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"trend_49"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"trend_50"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"trend_51"</span></span>
<span id="cb5-21">)</span>
<span id="cb5-22"></span>
<span id="cb5-23">region <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> castle <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb5-24">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">select</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">starts_with</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"r20"</span>)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb5-25">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">names</span>() <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb5-26">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">setdiff</span>(dropped_vars)</span>
<span id="cb5-27"></span>
<span id="cb5-28">df_castle <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> castle <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb5-29">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">select</span>(state, sid, year, treatment_date, l_homicide, <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">all_of</span>(region), popwt) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb5-30">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mutate</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">is_treated =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">if_else</span>(<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">!</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">is.na</span>(treatment_date), <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">.after =</span> treatment_date)</span></code></pre></div></div>
</div>
<p>各データフレームは以下のような感じになっています。</p>
<div class="tabset-margin-container"></div><div class="panel-tabset">
<ul class="nav nav-tabs"><li class="nav-item"><a class="nav-link active" id="tabset-1-1-tab" data-bs-toggle="tab" data-bs-target="#tabset-1-1" aria-controls="tabset-1-1" aria-selected="true" href="">df_base</a></li><li class="nav-item"><a class="nav-link" id="tabset-1-2-tab" data-bs-toggle="tab" data-bs-target="#tabset-1-2" aria-controls="tabset-1-2" aria-selected="false" href="">df_stagg</a></li><li class="nav-item"><a class="nav-link" id="tabset-1-3-tab" data-bs-toggle="tab" data-bs-target="#tabset-1-3" aria-controls="tabset-1-3" aria-selected="false" href="">df_castle</a></li></ul>
<div class="tab-content">
<div id="tabset-1-1" class="tab-pane active" aria-labelledby="tabset-1-1-tab">
<div class="cell">
<div class="cell-output-display">
<!-- preamble start -->

    <script>

      function styleCell_zokj8uz7nlos8mecn8k0(i, j, css_id) {
          var table = document.getElementById("tinytable_zokj8uz7nlos8mecn8k0");
          var cell = table.querySelector(`[data-row="${i}"][data-col="${j}"]`);
          if (cell) {
              console.log(`Styling cell at (${i}, ${j}) with class ${css_id}`);
              cell.classList.add(css_id);
          } else {
              console.warn(`Cell at (${i}, ${j}) not found.`);
          }
      }
      function insertSpanRow(i, colspan, content) {
        var table = document.getElementById('tinytable_zokj8uz7nlos8mecn8k0');
        // Find the row with data-row attribute matching i
        var targetRow = table.querySelector(`tr [data-row="${i}"]`).closest('tr');
        var newRow = table.insertRow(targetRow.rowIndex);
        var newCell = newRow.insertCell(0);
        newCell.setAttribute("colspan", colspan);
        newCell.setAttribute("data-col", "0");
        newCell.setAttribute("data-row", i - 1);
        // newCell.innerText = content;
        // this may be unsafe, but innerText does not interpret <br>
        newCell.innerHTML = content;
      }
      function spanCell_zokj8uz7nlos8mecn8k0(i, j, rowspan, colspan) {
        var table = document.getElementById("tinytable_zokj8uz7nlos8mecn8k0");
        const targetCell = table.querySelector(`[data-row="${i}"][data-col="${j}"]`);
        if (!targetCell) {
          console.warn(`Cell at (${i}, ${j}) not found.`);
        }

        // Get all cells that need to be removed
        const cellsToRemove = [];
        for (let r = 0; r < rowspan; r++) {
          for (let c = 0; c < colspan; c++) {
            if (r === 0 && c === 0) continue; // Skip the target cell
            const cell = table.querySelector(`[data-row="${i + r}"][data-col="${j + c}"]`);
            if (cell) {
              cellsToRemove.push(cell);
            }
          }
        }

        // Remove all cells
        cellsToRemove.forEach(cell => cell.remove());

        // Set rowspan and colspan of the target cell if it exists
        if (targetCell) {
          targetCell.rowSpan = rowspan;
          targetCell.colSpan = colspan;
        }
      }
      // tinytable span after
      window.addEventListener('load', function () {
          var cellsToStyle = [
            // tinytable style arrays after
          { positions: [ { i: '6', j: 0 }, { i: '6', j: 1 }, { i: '6', j: 2 }, { i: '6', j: 3 }, { i: '6', j: 4 }, { i: '6', j: 5 },  ], css_id: 'tinytable_css_qv61i8j9t4vv0rj45nsm',}, 
          { positions: [ { i: '0', j: 0 }, { i: '0', j: 1 }, { i: '0', j: 2 }, { i: '0', j: 3 }, { i: '0', j: 4 }, { i: '0', j: 5 },  ], css_id: 'tinytable_css_ggtsjdqyjageqqresqhd',}, 
          ];

          // Loop over the arrays to style the cells
          cellsToStyle.forEach(function (group) {
              group.positions.forEach(function (cell) {
                  styleCell_zokj8uz7nlos8mecn8k0(cell.i, cell.j, group.css_id);
              });
          });
      });
    </script>

    <style>
      /* tinytable css entries after */
      .table td.tinytable_css_qv61i8j9t4vv0rj45nsm, .table th.tinytable_css_qv61i8j9t4vv0rj45nsm { border-bottom: solid #d3d8dc 0.1em; }
      .table td.tinytable_css_ggtsjdqyjageqqresqhd, .table th.tinytable_css_ggtsjdqyjageqqresqhd { border-top: solid #d3d8dc 0.1em; border-bottom: solid #d3d8dc 0.05em; }
    </style>
    <div class="container">
      <table class="table table-borderless" id="tinytable_zokj8uz7nlos8mecn8k0" style="width: auto; margin-left: auto; margin-right: auto;" data-quarto-disable-processing="true">
        <thead>
        
              <tr>
                <th scope="col" data-row="0" data-col="0">y</th>
                <th scope="col" data-row="0" data-col="1">x1</th>
                <th scope="col" data-row="0" data-col="2">id</th>
                <th scope="col" data-row="0" data-col="3">period</th>
                <th scope="col" data-row="0" data-col="4">post</th>
                <th scope="col" data-row="0" data-col="5">treat</th>
              </tr>
        </thead>
        
        <tbody>
                <tr>
                  <td data-row="1" data-col="0">2.87530627</td>
                  <td data-row="1" data-col="1">0.5365377</td>
                  <td data-row="1" data-col="2">1</td>
                  <td data-row="1" data-col="3">1</td>
                  <td data-row="1" data-col="4">0</td>
                  <td data-row="1" data-col="5">1</td>
                </tr>
                <tr>
                  <td data-row="2" data-col="0">1.86065272</td>
                  <td data-row="2" data-col="1">-3.0431894</td>
                  <td data-row="2" data-col="2">1</td>
                  <td data-row="2" data-col="3">2</td>
                  <td data-row="2" data-col="4">0</td>
                  <td data-row="2" data-col="5">1</td>
                </tr>
                <tr>
                  <td data-row="3" data-col="0">0.09416524</td>
                  <td data-row="3" data-col="1">5.5768439</td>
                  <td data-row="3" data-col="2">1</td>
                  <td data-row="3" data-col="3">3</td>
                  <td data-row="3" data-col="4">0</td>
                  <td data-row="3" data-col="5">1</td>
                </tr>
                <tr>
                  <td data-row="4" data-col="0">3.78147485</td>
                  <td data-row="4" data-col="1">-2.8300587</td>
                  <td data-row="4" data-col="2">1</td>
                  <td data-row="4" data-col="3">4</td>
                  <td data-row="4" data-col="4">0</td>
                  <td data-row="4" data-col="5">1</td>
                </tr>
                <tr>
                  <td data-row="5" data-col="0">-2.55819959</td>
                  <td data-row="5" data-col="1">-5.0443544</td>
                  <td data-row="5" data-col="2">1</td>
                  <td data-row="5" data-col="3">5</td>
                  <td data-row="5" data-col="4">0</td>
                  <td data-row="5" data-col="5">1</td>
                </tr>
                <tr>
                  <td data-row="6" data-col="0">1.72873240</td>
                  <td data-row="6" data-col="1">-0.6363849</td>
                  <td data-row="6" data-col="2">1</td>
                  <td data-row="6" data-col="3">6</td>
                  <td data-row="6" data-col="4">1</td>
                  <td data-row="6" data-col="5">1</td>
                </tr>
        </tbody>
      </table>
    </div>
<!-- hack to avoid NA insertion in last line -->
</div>
</div>
</div>
<div id="tabset-1-2" class="tab-pane" aria-labelledby="tabset-1-2-tab">
<div class="cell">
<div class="cell-output-display">
<!-- preamble start -->

    <script>

      function styleCell_9qj7wkw7cp0pxx1bw2v5(i, j, css_id) {
          var table = document.getElementById("tinytable_9qj7wkw7cp0pxx1bw2v5");
          var cell = table.querySelector(`[data-row="${i}"][data-col="${j}"]`);
          if (cell) {
              console.log(`Styling cell at (${i}, ${j}) with class ${css_id}`);
              cell.classList.add(css_id);
          } else {
              console.warn(`Cell at (${i}, ${j}) not found.`);
          }
      }
      function insertSpanRow(i, colspan, content) {
        var table = document.getElementById('tinytable_9qj7wkw7cp0pxx1bw2v5');
        // Find the row with data-row attribute matching i
        var targetRow = table.querySelector(`tr [data-row="${i}"]`).closest('tr');
        var newRow = table.insertRow(targetRow.rowIndex);
        var newCell = newRow.insertCell(0);
        newCell.setAttribute("colspan", colspan);
        newCell.setAttribute("data-col", "0");
        newCell.setAttribute("data-row", i - 1);
        // newCell.innerText = content;
        // this may be unsafe, but innerText does not interpret <br>
        newCell.innerHTML = content;
      }
      function spanCell_9qj7wkw7cp0pxx1bw2v5(i, j, rowspan, colspan) {
        var table = document.getElementById("tinytable_9qj7wkw7cp0pxx1bw2v5");
        const targetCell = table.querySelector(`[data-row="${i}"][data-col="${j}"]`);
        if (!targetCell) {
          console.warn(`Cell at (${i}, ${j}) not found.`);
        }

        // Get all cells that need to be removed
        const cellsToRemove = [];
        for (let r = 0; r < rowspan; r++) {
          for (let c = 0; c < colspan; c++) {
            if (r === 0 && c === 0) continue; // Skip the target cell
            const cell = table.querySelector(`[data-row="${i + r}"][data-col="${j + c}"]`);
            if (cell) {
              cellsToRemove.push(cell);
            }
          }
        }

        // Remove all cells
        cellsToRemove.forEach(cell => cell.remove());

        // Set rowspan and colspan of the target cell if it exists
        if (targetCell) {
          targetCell.rowSpan = rowspan;
          targetCell.colSpan = colspan;
        }
      }
      // tinytable span after
      window.addEventListener('load', function () {
          var cellsToStyle = [
            // tinytable style arrays after
          { positions: [ { i: '6', j: 0 }, { i: '6', j: 1 }, { i: '6', j: 2 }, { i: '6', j: 3 }, { i: '6', j: 4 }, { i: '6', j: 5 }, { i: '6', j: 6 }, { i: '6', j: 7 },  ], css_id: 'tinytable_css_1zgceg1yvfhxws9wcb8k',}, 
          { positions: [ { i: '0', j: 0 }, { i: '0', j: 1 }, { i: '0', j: 2 }, { i: '0', j: 3 }, { i: '0', j: 4 }, { i: '0', j: 5 }, { i: '0', j: 6 }, { i: '0', j: 7 },  ], css_id: 'tinytable_css_cpw46hyzy5t32s39wu8j',}, 
          ];

          // Loop over the arrays to style the cells
          cellsToStyle.forEach(function (group) {
              group.positions.forEach(function (cell) {
                  styleCell_9qj7wkw7cp0pxx1bw2v5(cell.i, cell.j, group.css_id);
              });
          });
      });
    </script>

    <style>
      /* tinytable css entries after */
      .table td.tinytable_css_1zgceg1yvfhxws9wcb8k, .table th.tinytable_css_1zgceg1yvfhxws9wcb8k { border-bottom: solid #d3d8dc 0.1em; }
      .table td.tinytable_css_cpw46hyzy5t32s39wu8j, .table th.tinytable_css_cpw46hyzy5t32s39wu8j { border-top: solid #d3d8dc 0.1em; border-bottom: solid #d3d8dc 0.05em; }
    </style>
    <div class="container">
      <table class="table table-borderless" id="tinytable_9qj7wkw7cp0pxx1bw2v5" style="width: auto; margin-left: auto; margin-right: auto;" data-quarto-disable-processing="true">
        <thead>
        
              <tr>
                <th scope="col" data-row="0" data-col="0">id</th>
                <th scope="col" data-row="0" data-col="1">year</th>
                <th scope="col" data-row="0" data-col="2">year_treated</th>
                <th scope="col" data-row="0" data-col="3">time_to_treatment</th>
                <th scope="col" data-row="0" data-col="4">treated</th>
                <th scope="col" data-row="0" data-col="5">treatment_effect_true</th>
                <th scope="col" data-row="0" data-col="6">x1</th>
                <th scope="col" data-row="0" data-col="7">y</th>
              </tr>
        </thead>
        
        <tbody>
                <tr>
                  <td data-row="1" data-col="0">90</td>
                  <td data-row="1" data-col="1">1</td>
                  <td data-row="1" data-col="2">2</td>
                  <td data-row="1" data-col="3">-1</td>
                  <td data-row="1" data-col="4">1</td>
                  <td data-row="1" data-col="5">0</td>
                  <td data-row="1" data-col="6">-1.0947021</td>
                  <td data-row="1" data-col="7">0.01722971</td>
                </tr>
                <tr>
                  <td data-row="2" data-col="0">89</td>
                  <td data-row="2" data-col="1">1</td>
                  <td data-row="2" data-col="2">3</td>
                  <td data-row="2" data-col="3">-2</td>
                  <td data-row="2" data-col="4">1</td>
                  <td data-row="2" data-col="5">0</td>
                  <td data-row="2" data-col="6">-3.7100676</td>
                  <td data-row="2" data-col="7">-4.58084528</td>
                </tr>
                <tr>
                  <td data-row="3" data-col="0">88</td>
                  <td data-row="3" data-col="1">1</td>
                  <td data-row="3" data-col="2">4</td>
                  <td data-row="3" data-col="3">-3</td>
                  <td data-row="3" data-col="4">1</td>
                  <td data-row="3" data-col="5">0</td>
                  <td data-row="3" data-col="6">2.5274402</td>
                  <td data-row="3" data-col="7">2.73817174</td>
                </tr>
                <tr>
                  <td data-row="4" data-col="0">87</td>
                  <td data-row="4" data-col="1">1</td>
                  <td data-row="4" data-col="2">5</td>
                  <td data-row="4" data-col="3">-4</td>
                  <td data-row="4" data-col="4">1</td>
                  <td data-row="4" data-col="5">0</td>
                  <td data-row="4" data-col="6">-0.7204263</td>
                  <td data-row="4" data-col="7">-0.65103066</td>
                </tr>
                <tr>
                  <td data-row="5" data-col="0">86</td>
                  <td data-row="5" data-col="1">1</td>
                  <td data-row="5" data-col="2">6</td>
                  <td data-row="5" data-col="3">-5</td>
                  <td data-row="5" data-col="4">1</td>
                  <td data-row="5" data-col="5">0</td>
                  <td data-row="5" data-col="6">-3.6711678</td>
                  <td data-row="5" data-col="7">-5.33381664</td>
                </tr>
                <tr>
                  <td data-row="6" data-col="0">85</td>
                  <td data-row="6" data-col="1">1</td>
                  <td data-row="6" data-col="2">7</td>
                  <td data-row="6" data-col="3">-6</td>
                  <td data-row="6" data-col="4">1</td>
                  <td data-row="6" data-col="5">0</td>
                  <td data-row="6" data-col="6">-0.3152137</td>
                  <td data-row="6" data-col="7">0.49562631</td>
                </tr>
        </tbody>
      </table>
    </div>
<!-- hack to avoid NA insertion in last line -->
</div>
</div>
</div>
<div id="tabset-1-3" class="tab-pane" aria-labelledby="tabset-1-3-tab">
<div class="cell">
<div class="cell-output-display">
<!-- preamble start -->

    <script>

      function styleCell_jtnt5p3u02tqrslr5rjd(i, j, css_id) {
          var table = document.getElementById("tinytable_jtnt5p3u02tqrslr5rjd");
          var cell = table.querySelector(`[data-row="${i}"][data-col="${j}"]`);
          if (cell) {
              console.log(`Styling cell at (${i}, ${j}) with class ${css_id}`);
              cell.classList.add(css_id);
          } else {
              console.warn(`Cell at (${i}, ${j}) not found.`);
          }
      }
      function insertSpanRow(i, colspan, content) {
        var table = document.getElementById('tinytable_jtnt5p3u02tqrslr5rjd');
        // Find the row with data-row attribute matching i
        var targetRow = table.querySelector(`tr [data-row="${i}"]`).closest('tr');
        var newRow = table.insertRow(targetRow.rowIndex);
        var newCell = newRow.insertCell(0);
        newCell.setAttribute("colspan", colspan);
        newCell.setAttribute("data-col", "0");
        newCell.setAttribute("data-row", i - 1);
        // newCell.innerText = content;
        // this may be unsafe, but innerText does not interpret <br>
        newCell.innerHTML = content;
      }
      function spanCell_jtnt5p3u02tqrslr5rjd(i, j, rowspan, colspan) {
        var table = document.getElementById("tinytable_jtnt5p3u02tqrslr5rjd");
        const targetCell = table.querySelector(`[data-row="${i}"][data-col="${j}"]`);
        if (!targetCell) {
          console.warn(`Cell at (${i}, ${j}) not found.`);
        }

        // Get all cells that need to be removed
        const cellsToRemove = [];
        for (let r = 0; r < rowspan; r++) {
          for (let c = 0; c < colspan; c++) {
            if (r === 0 && c === 0) continue; // Skip the target cell
            const cell = table.querySelector(`[data-row="${i + r}"][data-col="${j + c}"]`);
            if (cell) {
              cellsToRemove.push(cell);
            }
          }
        }

        // Remove all cells
        cellsToRemove.forEach(cell => cell.remove());

        // Set rowspan and colspan of the target cell if it exists
        if (targetCell) {
          targetCell.rowSpan = rowspan;
          targetCell.colSpan = colspan;
        }
      }
      // tinytable span after
      window.addEventListener('load', function () {
          var cellsToStyle = [
            // tinytable style arrays after
          { positions: [ { i: '6', j: 4 }, { i: '6', j: 5 }, { i: '6', j: 6 }, { i: '6', j: 0 }, { i: '6', j: 7 }, { i: '6', j: 1 }, { i: '6', j: 8 }, { i: '6', j: 2 }, { i: '6', j: 9 }, { i: '6', j: 3 }, { i: '6', j: 10 }, { i: '6', j: 17 }, { i: '6', j: 11 }, { i: '6', j: 18 }, { i: '6', j: 12 }, { i: '6', j: 19 }, { i: '6', j: 13 }, { i: '6', j: 20 }, { i: '6', j: 14 }, { i: '6', j: 21 }, { i: '6', j: 15 }, { i: '6', j: 22 }, { i: '6', j: 16 }, { i: '6', j: 23 }, { i: '6', j: 30 }, { i: '6', j: 24 }, { i: '6', j: 31 }, { i: '6', j: 25 }, { i: '6', j: 32 }, { i: '6', j: 26 }, { i: '6', j: 33 }, { i: '6', j: 27 }, { i: '6', j: 34 }, { i: '6', j: 28 }, { i: '6', j: 35 }, { i: '6', j: 29 }, { i: '6', j: 36 },  ], css_id: 'tinytable_css_z09281vnfxxh7z4n7ajw',}, 
          { positions: [ { i: '0', j: 0 }, { i: '0', j: 7 }, { i: '0', j: 1 }, { i: '0', j: 8 }, { i: '0', j: 2 }, { i: '0', j: 9 }, { i: '0', j: 3 }, { i: '0', j: 10 }, { i: '0', j: 4 }, { i: '0', j: 11 }, { i: '0', j: 5 }, { i: '0', j: 12 }, { i: '0', j: 6 }, { i: '0', j: 13 }, { i: '0', j: 20 }, { i: '0', j: 14 }, { i: '0', j: 21 }, { i: '0', j: 15 }, { i: '0', j: 22 }, { i: '0', j: 16 }, { i: '0', j: 23 }, { i: '0', j: 17 }, { i: '0', j: 24 }, { i: '0', j: 18 }, { i: '0', j: 25 }, { i: '0', j: 19 }, { i: '0', j: 26 }, { i: '0', j: 33 }, { i: '0', j: 27 }, { i: '0', j: 34 }, { i: '0', j: 28 }, { i: '0', j: 35 }, { i: '0', j: 29 }, { i: '0', j: 36 }, { i: '0', j: 30 }, { i: '0', j: 31 }, { i: '0', j: 32 },  ], css_id: 'tinytable_css_wdujpck5nibduikdx8yq',}, 
          ];

          // Loop over the arrays to style the cells
          cellsToStyle.forEach(function (group) {
              group.positions.forEach(function (cell) {
                  styleCell_jtnt5p3u02tqrslr5rjd(cell.i, cell.j, group.css_id);
              });
          });
      });
    </script>

    <style>
      /* tinytable css entries after */
      .table td.tinytable_css_z09281vnfxxh7z4n7ajw, .table th.tinytable_css_z09281vnfxxh7z4n7ajw { border-bottom: solid #d3d8dc 0.1em; }
      .table td.tinytable_css_wdujpck5nibduikdx8yq, .table th.tinytable_css_wdujpck5nibduikdx8yq { border-top: solid #d3d8dc 0.1em; border-bottom: solid #d3d8dc 0.05em; }
    </style>
    <div class="container">
      <table class="table table-borderless" id="tinytable_jtnt5p3u02tqrslr5rjd" style="width: auto; margin-left: auto; margin-right: auto;" data-quarto-disable-processing="true">
        <thead>
        
              <tr>
                <th scope="col" data-row="0" data-col="0">state</th>
                <th scope="col" data-row="0" data-col="1">sid</th>
                <th scope="col" data-row="0" data-col="2">year</th>
                <th scope="col" data-row="0" data-col="3">treatment_date</th>
                <th scope="col" data-row="0" data-col="4">is_treated</th>
                <th scope="col" data-row="0" data-col="5">l_homicide</th>
                <th scope="col" data-row="0" data-col="6">r20001</th>
                <th scope="col" data-row="0" data-col="7">r20002</th>
                <th scope="col" data-row="0" data-col="8">r20003</th>
                <th scope="col" data-row="0" data-col="9">r20011</th>
                <th scope="col" data-row="0" data-col="10">r20012</th>
                <th scope="col" data-row="0" data-col="11">r20013</th>
                <th scope="col" data-row="0" data-col="12">r20021</th>
                <th scope="col" data-row="0" data-col="13">r20022</th>
                <th scope="col" data-row="0" data-col="14">r20023</th>
                <th scope="col" data-row="0" data-col="15">r20031</th>
                <th scope="col" data-row="0" data-col="16">r20032</th>
                <th scope="col" data-row="0" data-col="17">r20033</th>
                <th scope="col" data-row="0" data-col="18">r20041</th>
                <th scope="col" data-row="0" data-col="19">r20042</th>
                <th scope="col" data-row="0" data-col="20">r20043</th>
                <th scope="col" data-row="0" data-col="21">r20051</th>
                <th scope="col" data-row="0" data-col="22">r20052</th>
                <th scope="col" data-row="0" data-col="23">r20053</th>
                <th scope="col" data-row="0" data-col="24">r20061</th>
                <th scope="col" data-row="0" data-col="25">r20062</th>
                <th scope="col" data-row="0" data-col="26">r20063</th>
                <th scope="col" data-row="0" data-col="27">r20071</th>
                <th scope="col" data-row="0" data-col="28">r20072</th>
                <th scope="col" data-row="0" data-col="29">r20073</th>
                <th scope="col" data-row="0" data-col="30">r20081</th>
                <th scope="col" data-row="0" data-col="31">r20082</th>
                <th scope="col" data-row="0" data-col="32">r20083</th>
                <th scope="col" data-row="0" data-col="33">r20091</th>
                <th scope="col" data-row="0" data-col="34">r20092</th>
                <th scope="col" data-row="0" data-col="35">r20093</th>
                <th scope="col" data-row="0" data-col="36">popwt</th>
              </tr>
        </thead>
        
        <tbody>
                <tr>
                  <td data-row="1" data-col="0">Alabama</td>
                  <td data-row="1" data-col="1">1</td>
                  <td data-row="1" data-col="2">2000</td>
                  <td data-row="1" data-col="3">2006</td>
                  <td data-row="1" data-col="4">1</td>
                  <td data-row="1" data-col="5">2.027356</td>
                  <td data-row="1" data-col="6">0</td>
                  <td data-row="1" data-col="7">0</td>
                  <td data-row="1" data-col="8">1</td>
                  <td data-row="1" data-col="9">0</td>
                  <td data-row="1" data-col="10">0</td>
                  <td data-row="1" data-col="11">0</td>
                  <td data-row="1" data-col="12">0</td>
                  <td data-row="1" data-col="13">0</td>
                  <td data-row="1" data-col="14">0</td>
                  <td data-row="1" data-col="15">0</td>
                  <td data-row="1" data-col="16">0</td>
                  <td data-row="1" data-col="17">0</td>
                  <td data-row="1" data-col="18">0</td>
                  <td data-row="1" data-col="19">0</td>
                  <td data-row="1" data-col="20">0</td>
                  <td data-row="1" data-col="21">0</td>
                  <td data-row="1" data-col="22">0</td>
                  <td data-row="1" data-col="23">0</td>
                  <td data-row="1" data-col="24">0</td>
                  <td data-row="1" data-col="25">0</td>
                  <td data-row="1" data-col="26">0</td>
                  <td data-row="1" data-col="27">0</td>
                  <td data-row="1" data-col="28">0</td>
                  <td data-row="1" data-col="29">0</td>
                  <td data-row="1" data-col="30">0</td>
                  <td data-row="1" data-col="31">0</td>
                  <td data-row="1" data-col="32">0</td>
                  <td data-row="1" data-col="33">0</td>
                  <td data-row="1" data-col="34">0</td>
                  <td data-row="1" data-col="35">0</td>
                  <td data-row="1" data-col="36">4499293</td>
                </tr>
                <tr>
                  <td data-row="2" data-col="0">Alabama</td>
                  <td data-row="2" data-col="1">1</td>
                  <td data-row="2" data-col="2">2001</td>
                  <td data-row="2" data-col="3">2006</td>
                  <td data-row="2" data-col="4">1</td>
                  <td data-row="2" data-col="5">2.164867</td>
                  <td data-row="2" data-col="6">0</td>
                  <td data-row="2" data-col="7">0</td>
                  <td data-row="2" data-col="8">0</td>
                  <td data-row="2" data-col="9">0</td>
                  <td data-row="2" data-col="10">0</td>
                  <td data-row="2" data-col="11">1</td>
                  <td data-row="2" data-col="12">0</td>
                  <td data-row="2" data-col="13">0</td>
                  <td data-row="2" data-col="14">0</td>
                  <td data-row="2" data-col="15">0</td>
                  <td data-row="2" data-col="16">0</td>
                  <td data-row="2" data-col="17">0</td>
                  <td data-row="2" data-col="18">0</td>
                  <td data-row="2" data-col="19">0</td>
                  <td data-row="2" data-col="20">0</td>
                  <td data-row="2" data-col="21">0</td>
                  <td data-row="2" data-col="22">0</td>
                  <td data-row="2" data-col="23">0</td>
                  <td data-row="2" data-col="24">0</td>
                  <td data-row="2" data-col="25">0</td>
                  <td data-row="2" data-col="26">0</td>
                  <td data-row="2" data-col="27">0</td>
                  <td data-row="2" data-col="28">0</td>
                  <td data-row="2" data-col="29">0</td>
                  <td data-row="2" data-col="30">0</td>
                  <td data-row="2" data-col="31">0</td>
                  <td data-row="2" data-col="32">0</td>
                  <td data-row="2" data-col="33">0</td>
                  <td data-row="2" data-col="34">0</td>
                  <td data-row="2" data-col="35">0</td>
                  <td data-row="2" data-col="36">4499293</td>
                </tr>
                <tr>
                  <td data-row="3" data-col="0">Alabama</td>
                  <td data-row="3" data-col="1">1</td>
                  <td data-row="3" data-col="2">2002</td>
                  <td data-row="3" data-col="3">2006</td>
                  <td data-row="3" data-col="4">1</td>
                  <td data-row="3" data-col="5">1.936334</td>
                  <td data-row="3" data-col="6">0</td>
                  <td data-row="3" data-col="7">0</td>
                  <td data-row="3" data-col="8">0</td>
                  <td data-row="3" data-col="9">0</td>
                  <td data-row="3" data-col="10">0</td>
                  <td data-row="3" data-col="11">0</td>
                  <td data-row="3" data-col="12">0</td>
                  <td data-row="3" data-col="13">0</td>
                  <td data-row="3" data-col="14">1</td>
                  <td data-row="3" data-col="15">0</td>
                  <td data-row="3" data-col="16">0</td>
                  <td data-row="3" data-col="17">0</td>
                  <td data-row="3" data-col="18">0</td>
                  <td data-row="3" data-col="19">0</td>
                  <td data-row="3" data-col="20">0</td>
                  <td data-row="3" data-col="21">0</td>
                  <td data-row="3" data-col="22">0</td>
                  <td data-row="3" data-col="23">0</td>
                  <td data-row="3" data-col="24">0</td>
                  <td data-row="3" data-col="25">0</td>
                  <td data-row="3" data-col="26">0</td>
                  <td data-row="3" data-col="27">0</td>
                  <td data-row="3" data-col="28">0</td>
                  <td data-row="3" data-col="29">0</td>
                  <td data-row="3" data-col="30">0</td>
                  <td data-row="3" data-col="31">0</td>
                  <td data-row="3" data-col="32">0</td>
                  <td data-row="3" data-col="33">0</td>
                  <td data-row="3" data-col="34">0</td>
                  <td data-row="3" data-col="35">0</td>
                  <td data-row="3" data-col="36">4499293</td>
                </tr>
                <tr>
                  <td data-row="4" data-col="0">Alabama</td>
                  <td data-row="4" data-col="1">1</td>
                  <td data-row="4" data-col="2">2003</td>
                  <td data-row="4" data-col="3">2006</td>
                  <td data-row="4" data-col="4">1</td>
                  <td data-row="4" data-col="5">1.919567</td>
                  <td data-row="4" data-col="6">0</td>
                  <td data-row="4" data-col="7">0</td>
                  <td data-row="4" data-col="8">0</td>
                  <td data-row="4" data-col="9">0</td>
                  <td data-row="4" data-col="10">0</td>
                  <td data-row="4" data-col="11">0</td>
                  <td data-row="4" data-col="12">0</td>
                  <td data-row="4" data-col="13">0</td>
                  <td data-row="4" data-col="14">0</td>
                  <td data-row="4" data-col="15">0</td>
                  <td data-row="4" data-col="16">0</td>
                  <td data-row="4" data-col="17">1</td>
                  <td data-row="4" data-col="18">0</td>
                  <td data-row="4" data-col="19">0</td>
                  <td data-row="4" data-col="20">0</td>
                  <td data-row="4" data-col="21">0</td>
                  <td data-row="4" data-col="22">0</td>
                  <td data-row="4" data-col="23">0</td>
                  <td data-row="4" data-col="24">0</td>
                  <td data-row="4" data-col="25">0</td>
                  <td data-row="4" data-col="26">0</td>
                  <td data-row="4" data-col="27">0</td>
                  <td data-row="4" data-col="28">0</td>
                  <td data-row="4" data-col="29">0</td>
                  <td data-row="4" data-col="30">0</td>
                  <td data-row="4" data-col="31">0</td>
                  <td data-row="4" data-col="32">0</td>
                  <td data-row="4" data-col="33">0</td>
                  <td data-row="4" data-col="34">0</td>
                  <td data-row="4" data-col="35">0</td>
                  <td data-row="4" data-col="36">4499293</td>
                </tr>
                <tr>
                  <td data-row="5" data-col="0">Alabama</td>
                  <td data-row="5" data-col="1">1</td>
                  <td data-row="5" data-col="2">2004</td>
                  <td data-row="5" data-col="3">2006</td>
                  <td data-row="5" data-col="4">1</td>
                  <td data-row="5" data-col="5">1.749841</td>
                  <td data-row="5" data-col="6">0</td>
                  <td data-row="5" data-col="7">0</td>
                  <td data-row="5" data-col="8">0</td>
                  <td data-row="5" data-col="9">0</td>
                  <td data-row="5" data-col="10">0</td>
                  <td data-row="5" data-col="11">0</td>
                  <td data-row="5" data-col="12">0</td>
                  <td data-row="5" data-col="13">0</td>
                  <td data-row="5" data-col="14">0</td>
                  <td data-row="5" data-col="15">0</td>
                  <td data-row="5" data-col="16">0</td>
                  <td data-row="5" data-col="17">0</td>
                  <td data-row="5" data-col="18">0</td>
                  <td data-row="5" data-col="19">0</td>
                  <td data-row="5" data-col="20">1</td>
                  <td data-row="5" data-col="21">0</td>
                  <td data-row="5" data-col="22">0</td>
                  <td data-row="5" data-col="23">0</td>
                  <td data-row="5" data-col="24">0</td>
                  <td data-row="5" data-col="25">0</td>
                  <td data-row="5" data-col="26">0</td>
                  <td data-row="5" data-col="27">0</td>
                  <td data-row="5" data-col="28">0</td>
                  <td data-row="5" data-col="29">0</td>
                  <td data-row="5" data-col="30">0</td>
                  <td data-row="5" data-col="31">0</td>
                  <td data-row="5" data-col="32">0</td>
                  <td data-row="5" data-col="33">0</td>
                  <td data-row="5" data-col="34">0</td>
                  <td data-row="5" data-col="35">0</td>
                  <td data-row="5" data-col="36">4499293</td>
                </tr>
                <tr>
                  <td data-row="6" data-col="0">Alabama</td>
                  <td data-row="6" data-col="1">1</td>
                  <td data-row="6" data-col="2">2005</td>
                  <td data-row="6" data-col="3">2006</td>
                  <td data-row="6" data-col="4">1</td>
                  <td data-row="6" data-col="5">2.130440</td>
                  <td data-row="6" data-col="6">0</td>
                  <td data-row="6" data-col="7">0</td>
                  <td data-row="6" data-col="8">0</td>
                  <td data-row="6" data-col="9">0</td>
                  <td data-row="6" data-col="10">0</td>
                  <td data-row="6" data-col="11">0</td>
                  <td data-row="6" data-col="12">0</td>
                  <td data-row="6" data-col="13">0</td>
                  <td data-row="6" data-col="14">0</td>
                  <td data-row="6" data-col="15">0</td>
                  <td data-row="6" data-col="16">0</td>
                  <td data-row="6" data-col="17">0</td>
                  <td data-row="6" data-col="18">0</td>
                  <td data-row="6" data-col="19">0</td>
                  <td data-row="6" data-col="20">0</td>
                  <td data-row="6" data-col="21">0</td>
                  <td data-row="6" data-col="22">0</td>
                  <td data-row="6" data-col="23">1</td>
                  <td data-row="6" data-col="24">0</td>
                  <td data-row="6" data-col="25">0</td>
                  <td data-row="6" data-col="26">0</td>
                  <td data-row="6" data-col="27">0</td>
                  <td data-row="6" data-col="28">0</td>
                  <td data-row="6" data-col="29">0</td>
                  <td data-row="6" data-col="30">0</td>
                  <td data-row="6" data-col="31">0</td>
                  <td data-row="6" data-col="32">0</td>
                  <td data-row="6" data-col="33">0</td>
                  <td data-row="6" data-col="34">0</td>
                  <td data-row="6" data-col="35">0</td>
                  <td data-row="6" data-col="36">4499293</td>
                </tr>
        </tbody>
      </table>
    </div>
<!-- hack to avoid NA insertion in last line -->
</div>
</div>
</div>
</div>
</div>
</section>
<section id="パッケージの説明" class="level2">
<h2 class="anchored" data-anchor-id="パッケージの説明">パッケージの説明</h2>
<p>基本的な使い方と一緒にパッケージについて説明していきます。関数はイベントスタディを実行する<code>run_es()</code>関数とイベントスタディをggplotベースでプロットする<code>plot_es()</code>です。</p>
<section id="run_es" class="level3">
<h3 class="anchored" data-anchor-id="run_es"><code>run_es()</code></h3>
<p>ひとまず、<code>run_es()</code>の基本的な引数を説明します。</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb6" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">run_es</span>(</span>
<span id="cb6-2">  data,</span>
<span id="cb6-3">  outcome,</span>
<span id="cb6-4">  treatment,</span>
<span id="cb6-5">  time,</span>
<span id="cb6-6">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">staggered =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">FALSE</span>,</span>
<span id="cb6-7">  timing,</span>
<span id="cb6-8">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">lead_range =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">NULL</span>,</span>
<span id="cb6-9">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">lag_range =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">NULL</span>,</span>
<span id="cb6-10">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">covariates =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">NULL</span>,</span>
<span id="cb6-11">  fe,</span>
<span id="cb6-12">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">cluster =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">NULL</span>,</span>
<span id="cb6-13">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">weights =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">NULL</span>,</span>
<span id="cb6-14">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">baseline =</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>,</span>
<span id="cb6-15">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">interval =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>,</span>
<span id="cb6-16">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">time_transform =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">FALSE</span>,</span>
<span id="cb6-17">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">unit =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">NULL</span></span>
<span id="cb6-18">)</span></code></pre></div></div>
<ul>
<li><code>data</code>：使用するデータフレーム</li>
<li><code>outcome</code>：アウトカム変数</li>
<li><code>treatment</code>：処置されていれば（時間によらず）1をとるダミー変数<sup>2</sup></li>
<li><code>time</code>：時間を示す変数（<code>year</code>など）</li>
<li><code>timing</code>：処置タイミングを表す変数（<code>staggered</code>がFALSEの場合は数値、TRUEの場合は処置タイミングを示す変数）</li>
<li><code>fe</code>：固定効果（<code>~ id + year</code>のように書く）</li>
<li><code>lead_range</code>：処置前の期間（処置年は含まず、デフォルトでは最大の期間をとる）</li>
<li><code>lag_range</code>：処置後の期間（処置年は含まず、デフォルトでは最大の期間をとる）</li>
<li><code>covariates</code>：共変量（<code>~ cov1 + cov2</code>のように書く）</li>
<li><code>cluster</code>：クラスタリングの単位（<code>~ id</code>のように書く）</li>
<li><code>weights</code>：ウェイト（<code>~ weight</code>のように書く）</li>
<li><code>baseline</code>：基準となる相対年（デフォルトでは処置の1期前）</li>
<li><code>interval</code>：時間のインターバル（デフォルトでは1（1年ごとのデータ）、5にすれば国勢調査に対応（5年ごと））</li>
<li><code>time_transform</code>：TRUEで時間変数に通し番号を振って処理。時間変数が文字列だったりイレギュラーな間隔の場合に対応（デフォルトはFALSE）</li>
<li><code>unit</code>：<code>time_transform</code>がTRUEの場合に個体の単位を指定（<code>id</code>など）</li>
<li><code>staggered</code>：処置タイミングが個体ごとに異なるモデルの場合はTRUE（デフォルトはFALSE）</li>
<li><code>conf.level</code>：信頼区間を指定（0.90, 0.95, 0.99のいずれか。デフォルトは0.95）</li>
</ul>
<hr>
<p>文字で見てもわかりにくいと思うので、読み込んだデータを使って関数を回してみましょう。</p>
<section id="sec-basic-es" class="level4">
<h4 class="anchored" data-anchor-id="sec-basic-es">通常のDiDにおけるイベントスタディ</h4>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb7" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1">es <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">run_es</span>(</span>
<span id="cb7-2">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">data =</span> df_base, </span>
<span id="cb7-3">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">outcome =</span> y, </span>
<span id="cb7-4">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">treatment =</span> treat, </span>
<span id="cb7-5">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">time =</span> period, </span>
<span id="cb7-6">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">timing =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">6</span>, </span>
<span id="cb7-7">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">fe =</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span> id <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> period, </span>
<span id="cb7-8">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">cluster =</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span> id</span>
<span id="cb7-9">)</span></code></pre></div></div>
</div>
<p>基本的なケースであればこれくらいの指定で済みます。プロットは後のセクションでまとめて載せます。</p>
</section>
<section id="staggered-did-1" class="level4">
<h4 class="anchored" data-anchor-id="staggered-did-1">Staggered DiD 1</h4>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb8" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb8-1">es_stagg1 <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">run_es</span>(</span>
<span id="cb8-2">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">data =</span> df_stagg, </span>
<span id="cb8-3">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">outcome =</span> y, </span>
<span id="cb8-4">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">treatment =</span> treated, </span>
<span id="cb8-5">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">time =</span> year, </span>
<span id="cb8-6">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">timing =</span> year_treated, </span>
<span id="cb8-7">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">fe =</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span> id <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> year, </span>
<span id="cb8-8">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">cluster =</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span> id, </span>
<span id="cb8-9">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">staggered =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">TRUE</span>,</span>
<span id="cb8-10">)</span></code></pre></div></div>
</div>
<p>先ほどと違う点は、<code>staggered</code>がTRUEになっており、<code>timing</code>が具体的な数値ではなく、処置年を示す変数を指定しているところです。</p>
</section>
<section id="staggered-did-2" class="level4">
<h4 class="anchored" data-anchor-id="staggered-did-2">Staggered DiD 2</h4>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb9" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb9-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 共変量の変数を式の形にしておく</span></span>
<span id="cb9-2">covariates <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">as.formula</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">paste</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"~"</span>, <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">paste</span>(region, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">collapse =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"+"</span>)))</span>
<span id="cb9-3"></span>
<span id="cb9-4">es_stagg2 <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">run_es</span>(</span>
<span id="cb9-5">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">data =</span> df_castle, </span>
<span id="cb9-6">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">outcome =</span> l_homicide, </span>
<span id="cb9-7">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">treatment =</span> is_treated, </span>
<span id="cb9-8">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">time =</span> year, </span>
<span id="cb9-9">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">timing =</span> treatment_date, </span>
<span id="cb9-10">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">fe =</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span> state <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> year, </span>
<span id="cb9-11">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">covariates =</span> covariates, </span>
<span id="cb9-12">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">cluster =</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span> sid, </span>
<span id="cb9-13">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">weights =</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span> popwt, </span>
<span id="cb9-14">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">staggered =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">TRUE</span></span>
<span id="cb9-15">)</span></code></pre></div></div>
</div>
<p>今回の例は共変量が多いので事前に<code>as.formula()</code>を使って処理してしまっていますが、関数内で<code>covariates = ~ cov1 + cov2</code>のような指定の仕方で問題ありません。</p>
</section>
</section>
<section id="plot_es" class="level3">
<h3 class="anchored" data-anchor-id="plot_es"><code>plot_es()</code></h3>
<p>こだわりがなければ、<code>plot_es(es)</code>の程度の書き方でプロットを出力することができます。引数の説明は後に回して、一旦先ほどのイベントスタディの結果をプロットしてみましょう。</p>
<section id="通常のdidにおけるイベントスタディ" class="level4">
<h4 class="anchored" data-anchor-id="通常のdidにおけるイベントスタディ">通常のDiDにおけるイベントスタディ</h4>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb10" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb10-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">plot_es</span>(es)</span></code></pre></div></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="https://yo5uke.com/pages/tips/250525_fixes/index_files/figure-html/unnamed-chunk-9-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>後の2つもそうですが、ベースラインがデフォルトのままなので、処置前年（-1）が抜けて値が0をとっています。</p>
</section>
<section id="staggered-did-1-1" class="level4">
<h4 class="anchored" data-anchor-id="staggered-did-1-1">Staggered DiD 1</h4>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb11" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb11-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">plot_es</span>(es_stagg1)</span></code></pre></div></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="https://yo5uke.com/pages/tips/250525_fixes/index_files/figure-html/unnamed-chunk-10-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="staggered-did-2-1" class="level4">
<h4 class="anchored" data-anchor-id="staggered-did-2-1">Staggered DiD 2</h4>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb12" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb12-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">plot_es</span>(es_stagg2)</span></code></pre></div></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="https://yo5uke.com/pages/tips/250525_fixes/index_files/figure-html/unnamed-chunk-11-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>Staggeredの方もいい感じにプロットできています。この図はMixtape内でlead変数とlag変数を手作業で作って実装しプロットされていますが、<a href="https://mixtape.scunning.com/09-difference_in_differences#fig-event-cheng2">その図</a>と見比べても同じ推移が示されていることがわかります。</p>
</section>
<section id="使い方" class="level4">
<h4 class="anchored" data-anchor-id="使い方">使い方</h4>
<p>基本的には上の使い方で十分ですが、ggplotベースで作ったこともあり、柔軟な対応も可能です。</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb13" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb13-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">plot_es</span>(</span>
<span id="cb13-2">  data,</span>
<span id="cb13-3">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">type =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"ribbon"</span>,</span>
<span id="cb13-4">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">vline_val =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>,</span>
<span id="cb13-5">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">vline_color =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"#000"</span>,</span>
<span id="cb13-6">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">hline_val =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>,</span>
<span id="cb13-7">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">hline_color =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"#000"</span>,</span>
<span id="cb13-8">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">linewidth =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>,</span>
<span id="cb13-9">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">pointsize =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>,</span>
<span id="cb13-10">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">alpha =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.2</span>,</span>
<span id="cb13-11">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">barwidth =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.2</span>,</span>
<span id="cb13-12">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">color =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"#B25D91FF"</span>,</span>
<span id="cb13-13">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">fill =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"#B25D91FF"</span></span>
<span id="cb13-14">)</span></code></pre></div></div>
<ul>
<li><code>data</code>：<code>run_es()</code>で作成した結果のデータフレーム</li>
<li><code>type</code>：<code>ribbon</code>と<code>errorbar</code>が指定可能</li>
<li><code>vline_val</code>：縦の破線の位置（デフォルトは0）</li>
<li><code>vline_color</code>：縦の破線の色（デフォルトは<code>#000</code>（黒））</li>
<li><code>hline_val</code>：横の破線の位置（デフォルトは0）</li>
<li><code>hline_color</code>：縦の破線の色（デフォルトは<code>#000</code>（黒））</li>
<li><code>linewidth</code>：折れ線の太さ（デフォルトは1）</li>
<li><code>pointsize</code>：点の大きさ（デフォルトは2）</li>
<li><code>alpha</code>：リボンの透明度（デフォルトは0.2）</li>
<li><code>color</code>：線と点の色（デフォルトは<code>#B25D91FF</code>（ピンク））</li>
<li><code>fill</code>リボンの色（デフォルトは<code>#B25D91FF</code>（ピンク））</li>
</ul>
<hr>
<p><code>plot_es()</code>関数内でもある程度自由度をもって設定できます。<br>
例えばプロットをエラーバーのタイプにしてみましょう。</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb14" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb14-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">plot_es</span>(es_stagg2, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">type =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"errorbar"</span>)</span></code></pre></div></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="https://yo5uke.com/pages/tips/250525_fixes/index_files/figure-html/unnamed-chunk-12-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>さらに色も変えてみます。</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb15" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb15-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">plot_es</span>(es_stagg2, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">type =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"errorbar"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">color =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"#000"</span>)</span></code></pre></div></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="https://yo5uke.com/pages/tips/250525_fixes/index_files/figure-html/unnamed-chunk-13-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>リボンタイプとエラーバータイプがあり、さらにそこからある程度の自由度もある点が他のパッケージに対する優位性にもなっています。</p>
<p>ちなみに、ggplotベースということで、<strong>ggplotの関数をつなげることも可能です</strong>！</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb16" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb16-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">plot_es</span>(es_stagg2, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">type =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"errorbar"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">color =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"#000"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> </span>
<span id="cb16-2">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_hline</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">yintercept =</span> .<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">08</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">color =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"red"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> </span>
<span id="cb16-3">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">annotate</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"text"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y =</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>.<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">label =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"DD Coefficient = 0.08</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">\n</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">(s.e. = 0.03)"</span>)</span></code></pre></div></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="https://yo5uke.com/pages/tips/250525_fixes/index_files/figure-html/unnamed-chunk-14-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>Mixtape風に係数を示す水平線と注釈を追加してみました。このようにどんどん要素を追加していくことができます。</p>
</section>
</section>
</section>
<section id="おわりに" class="level2">
<h2 class="anchored" data-anchor-id="おわりに">おわりに</h2>
<p>まだまだ開発途上ですが、staggeredまで対応できたので、これからしばらくはブラッシュアップを念頭にアップデートしていこうと思います。</p>
<p>冒頭にも書きましたが、もし使っていただいて「使いにくい」や「こんな機能が欲しい」等ありましたら、以下のコメントやGitHubの<a href="https://github.com/yo5uke/fixes/issues">Issues</a>までお願いします。</p>
</section>
<section id="データ出典" class="level2">
<h2 class="anchored" data-anchor-id="データ出典">🔗 データ出典</h2>
<p>データ出典：<a href="https://mixtape.scunning.com/">Causal Inference: The Mixtape</a>（Scott Cunnningham, 2021）<br>
データはGitHub上で公開されており、以下のリポジトリから入手可能です：</p>
<blockquote class="blockquote">
<p>https://github.com/scunning1975/mixtape</p>
</blockquote>
<p>また、データはMITライセンスのもとで提供されています。</p>


<!-- -->

</section>


<div id="quarto-appendix" class="default"><section id="footnotes" class="footnotes footnotes-end-of-document"><h2 class="anchored quarto-appendix-heading">注</h2>

<ol>
<li id="fn1"><p>参考：<a href="https://mixtape.scunning.com/09-difference_in_differences#replicating-cheng2013-sort-of">Mixtape</a>↩︎</p></li>
<li id="fn2"><p>TRUE/FALSEでも可↩︎</p></li>
</ol>
</section></div> ]]></description>
  <category>R</category>
  <guid>https://yo5uke.com/pages/tips/250525_fixes/</guid>
  <pubDate>Sat, 24 May 2025 15:00:00 GMT</pubDate>
</item>
<item>
  <title>【GIS】行政区域データを整理【ファイル有】</title>
  <link>https://yo5uke.com/pages/tips/250413_municipality/</link>
  <description><![CDATA[ 

<div class="social-share-buttons">

  <!-- Twitter (X) -->

  <a href="" id="js-share-twitter" class="share_button ri--twitter-x-fill" target="_blank" rel="nofollow noopener noreferrer"></a>



  <!-- Bluesky -->

  <a href="" id="js-share-bluesky" class="share_button ri--bluesky-fill" target="_blank" rel="nofollow noopener noreferrer"></a>

</div>



<script>

  const twitterUsername = "@5uke_y";

  const blueskyUsername = "@5uke.bsky.social";



  const share_url = encodeURIComponent(location.href);

  const share_title = document.title;



  // Twitter (X)

  document.getElementById('js-share-twitter').setAttribute(

    "href",

    "https://twitter.com/share?url=" + share_url + "&text=" + share_title + " " + encodeURIComponent(twitterUsername) + " より" +

    "&hashtags=rstats"

  );



  // Bluesky

  document.getElementById('js-share-bluesky').setAttribute(

    "href",

    "https://bsky.app/intent/compose?text=" + share_title + " " + share_url + " " + encodeURIComponent(blueskyUsername) + " より"

  );

</script>






<section id="はじめに" class="level2">
<h2 class="anchored" data-anchor-id="はじめに">はじめに</h2>
<p><a href="../../../pages/software/index.html">Software</a>のページで「<a href="https://yo5uke.shinyapps.io/japan_population_heatmap/">人口ヒートマップ</a>」などいくつかのwebアプリケーションを公開していますが、これらを作るうえで地理データを軽量化することが課題でした。</p>
<p><a href="https://nlftp.mlit.go.jp/ksj/gml/datalist/KsjTmplt-N03-2024.html">国土数値情報ダウンロードサイト</a>から行政区域データをとってきて使用しているのですが、データを読み込むだけでも時間がかかるため、<code>rmapshaper</code>パッケージを使用して軽量化することにしました。精度は落ちるのですがパッと見ただけでわかるような劣化ではなく、ファイルサイズも1/10以下になっているので、それを公開しておこうと思います。</p>
</section>
<section id="使用した関数" class="level2">
<h2 class="anchored" data-anchor-id="使用した関数">使用した関数</h2>
<p><code>rmapshaper</code>パッケージの<code>ms_simplify()</code>でポリゴンの頂点の数を5％程度にまで削減しています。</p>
</section>
<section id="ファイル" class="level2">
<h2 class="anchored" data-anchor-id="ファイル">ファイル</h2>
<p>以下のリンクからダウンロードできます。Geopackageファイルと言って、シェープファイルほど普及していませんが、シェープファイルよりも高機能かつGeoJSONほどファイルサイズが大きくない形式で提供しています。</p>
<p><a href="../../..\data/jpn_geojson/jp_muni_simplified.zip" download="jp_muni_simplified.zip">簡略化GPKGファイル</a></p>
</section>
<section id="利用規約ライセンス情報" class="level2">
<h2 class="anchored" data-anchor-id="利用規約ライセンス情報">利用規約・ライセンス情報</h2>
<p>本ウェブサイトで公開している行政区域データは、<a href="https://nlftp.mlit.go.jp/ksj/">国土交通省 国土数値情報ダウンロードサービス</a> から取得した「<a href="https://nlftp.mlit.go.jp/ksj/gml/datalist/KsjTmplt-N03-2024.html">行政区域データ</a>」をもとに加工・作成したものです。</p>
<ul>
<li>元データのライセンス： <a href="https://creativecommons.org/licenses/by/4.0/deed.ja">CC BY 4.0</a></li>
<li>加工内容：行政区域ポリゴンの簡略化処理（<code>ms_simplify()</code> による座標点の間引き）</li>
</ul>
<p>データをご利用いただく場合は、以下の条件に従ってください：</p>
<ol type="1">
<li>本データの出典として、<strong>「国土交通省『国土数値情報 行政区域データ』をもとに作成」</strong>と明記してください。</li>
<li>本データは加工済みであり、正確性・完全性を保証するものではありません。</li>
<li>本ウェブサイト上のデータは非商用・商用を問わず利用可能ですが、<strong>元データと同様にCC BY 4.0ライセンスが適用されます</strong>。</li>
</ol>
</section>
<section id="見てみる" class="level2">
<h2 class="anchored" data-anchor-id="見てみる">見てみる</h2>
<p>本データがどのようなものか見てみます。</p>
<div class="cell">
<details class="code-fold">
<summary>コード</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb1" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(tidyverse)</span>
<span id="cb1-2"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(sf)</span>
<span id="cb1-3"></span>
<span id="cb1-4">d <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">read_sf</span>(here<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">here</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"data/jpn_geojson/jp_muni_simplified.gpkg"</span>))</span>
<span id="cb1-5"></span>
<span id="cb1-6"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ggplot</span>(d) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> </span>
<span id="cb1-7">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_sf</span>() <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> </span>
<span id="cb1-8">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">theme_void</span>()</span></code></pre></div></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="https://yo5uke.com/pages/tips/250413_municipality/index_files/figure-html/unnamed-chunk-1-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>このように、見た目では違和感なくプロットできていると思います。</p>
<p>厳密な地理データを求めない場合は非常に有用だと思いますので、ぜひ使ってみてください。</p>


<!-- -->

</section>

 ]]></description>
  <category>R</category>
  <category>GIS</category>
  <category>データ処理</category>
  <guid>https://yo5uke.com/pages/tips/250413_municipality/</guid>
  <pubDate>Sat, 12 Apr 2025 15:00:00 GMT</pubDate>
</item>
<item>
  <title>【スクレイピング】rvestを使ってe-Statからファイルを取得する</title>
  <link>https://yo5uke.com/pages/tips/250319_scraping/</link>
  <description><![CDATA[ 

<div class="social-share-buttons">

  <!-- Twitter (X) -->

  <a href="" id="js-share-twitter" class="share_button ri--twitter-x-fill" target="_blank" rel="nofollow noopener noreferrer"></a>



  <!-- Bluesky -->

  <a href="" id="js-share-bluesky" class="share_button ri--bluesky-fill" target="_blank" rel="nofollow noopener noreferrer"></a>

</div>



<script>

  const twitterUsername = "@5uke_y";

  const blueskyUsername = "@5uke.bsky.social";



  const share_url = encodeURIComponent(location.href);

  const share_title = document.title;



  // Twitter (X)

  document.getElementById('js-share-twitter').setAttribute(

    "href",

    "https://twitter.com/share?url=" + share_url + "&text=" + share_title + " " + encodeURIComponent(twitterUsername) + " より" +

    "&hashtags=rstats"

  );



  // Bluesky

  document.getElementById('js-share-bluesky').setAttribute(

    "href",

    "https://bsky.app/intent/compose?text=" + share_title + " " + share_url + " " + encodeURIComponent(blueskyUsername) + " より"

  );

</script>






<section id="はじめに" class="level2">
<h2 class="anchored" data-anchor-id="はじめに">はじめに</h2>
<p>今回はRでスクレイピングを行っていきます。<code>rvest</code>パッケージを使ったスクレイピング自体は他のウェブサイトでも多数紹介されているのですが、今回JavaScriptが使われているページ（特にe-Stat）にも対応した方法をまとめます。これを行うには既に紹介されている方法からもう一工夫する必要があり、それも少々面倒です。</p>
<p>これまで僕はブラウザ拡張機能の「DownThemAll!」<sup>1</sup>を使って無理くり実行していたのですが、この手の方法は再現が難しいし手間という欠点があるので、できればR上でコードとして残しておきたいと思っていました。そんなところ友人からあるページを紹介してもらい、抱えていた課題<sup>2</sup>が解決できそうでしたので、これを機にまとめていきます。</p>
<p>紹介してもらったページはこちらです↓</p>
<div class="callout callout-style-simple callout-tip no-icon">
<div class="callout-body d-flex">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-body-container">
<p><a href="https://uchidamizuki.quarto.pub/blog/posts/2024/02/scraping-dynamic-sites-with-rvest.html">rvestで動的サイトをスクレイピングする（Seleniumを使わずに）</a></p>
</div>
</div>
</div>
<p>また、Google Chromeを使用するので、インストールしていない方はしておいてください。</p>
</section>
<section id="使用するパッケージ" class="level2">
<h2 class="anchored" data-anchor-id="使用するパッケージ">使用するパッケージ</h2>
<p>使用するパッケージは以下の通りです。Rプロジェクトを使うなり<code>setwd()</code>を使うなりでワーキングディレクトリを現在のディレクトリに設定しておいてください。プロジェクトについては<a href="../240515_rproj/index.html">こちら</a>。</p>
<p>ついでに、保存するディレクトリ（<code>data</code>フォルダ内の<code>shpfiles</code>）をあらかじめ指定しておきます。なければ作成する関数もつけておきます。</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb1" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(rvest)</span>
<span id="cb1-2"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(here)</span>
<span id="cb1-3"></span>
<span id="cb1-4">save_dir <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">here</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"data/shpfiles"</span>)</span>
<span id="cb1-5"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># ダウンロード用のフォルダがなければ作成する</span></span>
<span id="cb1-6"><span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> (<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">!</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">dir.exists</span>(save_dir)) {</span>
<span id="cb1-7">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">dir.create</span>(save_dir)</span>
<span id="cb1-8">}</span></code></pre></div></div>
</section>
<section id="ファイルをダウンロードするページ" class="level2">
<h2 class="anchored" data-anchor-id="ファイルをダウンロードするページ">ファイルをダウンロードするページ</h2>
<p>今回ファイルを取得していくのは、e-Statの「地図」→「境界データダウンロード」→「3次メッシュ」→「世界測地系平面直角座標系・Shapefile」のページです。</p>
<p><a href="https://www.e-stat.go.jp/gis/statmap-search?page=1&amp;type=2&amp;aggregateUnitForBoundary=S&amp;coordsys=2&amp;format=shape" class="uri">https://www.e-stat.go.jp/gis/statmap-search?page=1&amp;type=2&amp;aggregateUnitForBoundary=S&amp;coordsys=2&amp;format=shape</a></p>
<p>メッシュいうのは国土を例えば1km×1kmの正方形で区切ったものをいい、その中の人口等のデータを扱うことができるようになります。このあたりの詳細は以下の書籍が非常にわかりやすいのでおすすめです。RでGISを扱う方法も学べます。</p>
<div class="callout callout-style-simple callout-tip no-icon">
<div class="callout-body d-flex">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-body-container">
<p><a href="https://www.amazon.co.jp/%E4%BA%8B%E4%BE%8B%E3%81%A7%E5%AD%A6%E3%81%B6%E7%B5%8C%E6%B8%88%E3%83%BB%E6%94%BF%E7%AD%96%E5%88%86%E6%9E%90%E3%81%AE%E3%81%9F%E3%82%81%E3%81%AEGIS%E5%85%A5%E9%96%80-QGIS-GeoDa%E5%AF%BE%E5%BF%9C-%E6%B2%B3%E7%AB%AF-%E7%91%9E%E8%B2%B4/dp/4772242309">事例で学ぶ経済・政策分析のためのGIS入門: QGIS,R,GeoDa対応</a></p>
</div>
</div>
</div>
</section>
<section id="ページを取得" class="level2">
<h2 class="anchored" data-anchor-id="ページを取得">ページを取得</h2>
<p>基本的には<code>read_html()</code>関数で読み込むことができるのですが、JavaScriptを使用しているような動的なページには対応していません。そこで使用するのが<code>read_html_live()</code>関数です。これらの関数の仕組み自体は冒頭で紹介したページがわかりやすいのでそちらを読んでみてください。</p>
<p>先ほどのURLを読み込んでみましょう。</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb2" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1">html <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">read_html_live</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"https://www.e-stat.go.jp/gis/statmap-search?page=1&amp;type=2&amp;aggregateUnitForBoundary=S&amp;coordsys=2&amp;format=shape"</span>)</span></code></pre></div></div>
</section>
<section id="ファイルのリンクを取得" class="level2">
<h2 class="anchored" data-anchor-id="ファイルのリンクを取得">ファイルのリンクを取得</h2>
<p>次にいよいよファイルを取得していきます。僕もHTMLに詳しいわけではないので詳細は書きませんが、<code>a</code>タグというのがリンクを生成するためのもので、その中に<code>href</code>という属性があります。例えば</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb3" style="background: #f1f3f5;"><pre class="sourceCode html code-with-copy"><code class="sourceCode html"><span id="cb3-1"><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">&lt;</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">a</span><span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;"> class</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"stat-dl_icon stat-statistics-table_icon"</span><span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;"> tabindex</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"40"</span><span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;"> href</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"/gis/statmap-search/data?dlserveyId=S</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">&amp;amp;</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">code=3036</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">&amp;amp;</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">coordSys=2</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">&amp;amp;</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">format=shape</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">&amp;amp;</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">downloadType=5"</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">&gt;</span></span>
<span id="cb3-2"><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">&lt;</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">span</span><span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;"> class</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"stat-dl_text"</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">&gt;</span>世界測地系平面直角座標系・Shapefile<span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">&lt;/</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">span</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">&gt;</span></span>
<span id="cb3-3"><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">&lt;/</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">a</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">&gt;</span></span></code></pre></div></div>
<p>というようになっており、<code>a</code>と<code>/a</code>で囲まれている間に<code>href</code>やその他の属性が含まれていることがわかります。</p>
<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center collapsed" data-bs-toggle="collapse" data-bs-target=".callout-1-contents" aria-controls="callout-1" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
<span class="screen-reader-only">Tip</span>どうやって探す？
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-1" class="callout-1-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<p>このHTMLはどうやって探せばよいのでしょうか。実はブラウザ上から簡単に見ることができます。</p>
<p>ブラウザ上で任意のページを開いたら、<code>Ctrl</code> + <code>Shift</code> + <code>I</code>を同時に入力します。もしくはブラウザ右上の点々から「その他のツール」→「デベロッパー ツール」でも開けます。</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://yo5uke.com/pages/tips/250319_scraping/image/developer_tool.png" class="img-fluid quarto-figure quarto-figure-center figure-img" style="width:80.0%"></p>
</figure>
</div>
<p>すると画面右側になにやらぶわぁーっと出てきますね。これの上半分がHTMLコードです。ここから特定のコードを探すのは骨が折れそうですが、逆にページの要素をクリックすることで該当するコードを探すことができます。デベロッパーツール画面上部の左側にカーソルのようなアイコンがあります。</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://yo5uke.com/pages/tips/250319_scraping/image/dev_tool_bar.png" class="img-fluid figure-img" style="width:80.0%"></p>
<figcaption>一番左側です</figcaption>
</figure>
</div>
<p>これをクリックしたうえでページ上の要素にカーソルを重ねてクリックすると、該当箇所のコードが表示されます。カーソルを「世界測地系平面直角座標系・Shapefile」という文字に重ねると先ほどのコードが表示されます。</p>
</div>
</div>
</div>
<p>ここでは<code>a</code>タグを探す→<code>href</code>を探し取得する、という手順を踏みます。</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb4" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1">links <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> html <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb4-2">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">html_elements</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"a"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb4-3">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">html_attr</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"href"</span>)</span></code></pre></div></div>
<p><code>html_elements("a")</code>で<code>a</code>タグを探し、<code>html_attr("href")</code>で属性（attribute）を探しています。<code>links</code>には<code>a</code>タグの中の<code>href</code>に入っているリンクがずらーっと入っていることになります。</p>
<p>ここでは表示しませんが、<code>links</code>の中身を確認すると、想像以上にたくさんのリンクが入っていることがわかります。ここからさらにシェープファイルのダウンロードリンクを探さなければなりません。</p>
<p>上の<code>a</code>タグの例を見てもらうと、<code>/gis/statmap-search/data?dlserveyId=S&amp;code=3036&amp;coordSys=2&amp;format=shape&amp;downloadType=5</code>というのがシェープファイルのダウンロードリンクであることがわかります。他のシェープファイルのリンクと見比べてもらうと、<code>code=3036</code>の部分だけがそれぞれ異なっており、他は同じです。すなわち、まとめてダウンロードしたければこの部分さえうまいことやれば可能になるということです。</p>
<p>とりあえず、数多のリンクの中からシェープファイルのリンクだけ抽出しておきましょう。<code>links</code>の中のリンクを確認すると、<code>data?dlserveyId=S&amp;</code>という部分がシェープファイルのダウンロードリンクにのみ含まれていることがわかる、これを含むリンクを抽出すればよいことになります。</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb5" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1">shp_links <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> links[<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">grepl</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"data</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">\\</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">?dlserveyId=S&amp;"</span>, links)]</span></code></pre></div></div>
<p><strong>ポイント：</strong></p>
<ul>
<li><p><code>grepl()</code>で条件に合致するものを抽出</p>
<ul>
<li><p><code>grepl(x, y)</code>で、<code>y</code>の中で<code>x</code>を含むものに<code>TRUE</code>を返す</p></li>
<li><p><code>links</code>の中で<code>data\\?dlserveyId=S&amp;</code>を含むものに<code>TRUE</code>を返している</p></li>
<li><p><code>?</code>の前に<code>\\</code>が入っているのは、正規表現の中で<code>?</code>は特別な役割を持っているので、その役割として認識されるのを防ぐため（エスケープしている）</p></li>
</ul></li>
<li><p><code>links[ ]</code> で、<code>TRUE</code>を持つものを抽出している</p>
<ul>
<li>すなわち<code>grepl()</code>で<code>TRUE</code>を返したもの（=シェープファイルのダウンロードリンクをもつもの）だけが残る</li>
</ul></li>
</ul>
<p>短いコードでもややこしいですね。特に記号のところには気を付けていただければと思います。</p>
</section>
<section id="リンクを整形する" class="level2">
<h2 class="anchored" data-anchor-id="リンクを整形する">リンクを整形する</h2>
<p>お気づきの方もいらっしゃると思いますが、実は先ほどのリンクは相対的なものです。<code>https://</code>から始まっていません。ベースとして<code>https://www.e-stat.go.jp</code>というURLがあり、そこに続く形で<code>/gis/...</code>が入ってきます。</p>
<p>以下では取得したリンクにベースリンクをくっつけていきます。</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb6" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1">base_url <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"https://www.e-stat.go.jp"</span></span>
<span id="cb6-2">full_urls <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">paste0</span>(base_url, shp_links)</span></code></pre></div></div>
<p>これでページ内の20個のリンクを抽出することができました。次にこれらのリンクを使ってダウンロードしていきます。</p>
</section>
<section id="ファイルをダウンロード" class="level2">
<h2 class="anchored" data-anchor-id="ファイルをダウンロード">ファイルをダウンロード</h2>
<p>いよいよダウンロードをしていきます。</p>
<p>全てのリンクに対しダウンロードするコードを適用します。<code>for</code>の出番です。</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb7" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1"><span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> (i <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">seq_along</span>(full_urls)) {</span>
<span id="cb7-2">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># リンクからメッシュコードを取得</span></span>
<span id="cb7-3">  code <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sub</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">".*code=([0-9]+).*"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">\\</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">1"</span>, shp_links[i])</span>
<span id="cb7-4">  </span>
<span id="cb7-5">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># ダウンロードするファイルのパスを指定する</span></span>
<span id="cb7-6">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 例: shpfiles/shpfile_3036.zip</span></span>
<span id="cb7-7">  file_path <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">file.path</span>(save_dir, <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">paste0</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"shpfile_"</span>, code, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">".zip"</span>))</span>
<span id="cb7-8"></span>
<span id="cb7-9">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># ファイルをダウンロード</span></span>
<span id="cb7-10">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">download.file</span>(full_urls[i], <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">destfile =</span> file_path, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">mode =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"wb"</span>)</span>
<span id="cb7-11">  </span>
<span id="cb7-12">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># アクセス間隔を空ける</span></span>
<span id="cb7-13">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># サーバー負荷を考慮</span></span>
<span id="cb7-14">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">Sys.sleep</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>)</span>
<span id="cb7-15">}</span></code></pre></div></div>
<p><strong>ポイント：</strong></p>
<ul>
<li><p><code>seq_along(full_urls)</code>は<code>full_urls</code>の要素の数を取得している</p>
<ul>
<li>今回はURLが20個と分かっているが、数が多くて数えにくいような場合にも有用</li>
</ul></li>
<li><p><code>sub(".*code=([0-9]+).*", "\1", shp_links[i])</code>でメッシュコードを取得</p>
<ul>
<li><p><code>sub(pattern, replacement, x)</code>で<code>x</code>の<code>pettern</code>を<code>replacement</code>に置換する</p></li>
<li><p><code>.*code=([0-9]+).*</code>はざっくり言うと、前後が何であれ<code>code=(何らかの数字)</code>というものを探してきて、括弧内の数字を取得しているということ</p></li>
<li><p><code>\\1</code>は今取得した数字を返すということ</p></li>
<li><p><code>x</code>には<code>shp_links[i]</code>が該当するので、<code>i</code>番目のリンクで上で述べた置換をしているということ</p></li>
</ul></li>
<li><p><code>file_path &lt;- file.path(save_dir, paste0("shpfile_", code, ".zip"))</code>で保存する際のファイル名を作成</p>
<ul>
<li><p>現在のワーキングディレクトリにある<code>data</code>内の<code>shpfiles</code>というフォルダの中に<code>shpfile_3036.zip</code>というようなZipファイルを作成する</p></li>
<li><p>ダウンロードはZipファイルで行われるので拡張子は<code>.zip</code>としておく</p></li>
</ul></li>
</ul>
<pre><code>my_project/
├── data/
├── shpfiles/  ← ここにダウンロードする
└── scripts/
    ├── download_script.R
    ├── analysis.R
    └── ...</code></pre>
<ul>
<li><p><code>download.file(full_urls[i], destfile = file_path, mode = "wb")</code>でダウンロード</p>
<ul>
<li><p><code>download.file(url, destfile, mode)</code>で<code>url</code>を<code>destfile</code>に<code>mode</code>で指定したモードでダウンロードする</p></li>
<li><p>詳細は省くが、Zipファイルに対しては<code>mode="wb</code>を指定する</p></li>
</ul></li>
<li><p><code>Sys.sleep(2)</code>でサーバー負荷を軽減する</p>
<ul>
<li>作業ごとに2秒のインターバルを設けるということ</li>
</ul></li>
</ul>
<p>さすがに面倒すぎますね。最初は困ると思いますが、2回目以降大変便利に思えるはずです。</p>
<p>ひとまずこれでページ上のファイルをダウンロードすることができました！</p>
</section>
<section id="全ページまとめてダウンロード" class="level2">
<h2 class="anchored" data-anchor-id="全ページまとめてダウンロード">全ページまとめてダウンロード</h2>
<p>ここまでは1ページ内のファイルをダウンロードする方法について順を追って見てきました。</p>
<p>このセクションではシェープファイルが1～9ページにまたがって並んでいることを踏まえ、さらに<code>for</code>ループを構築し、これまでの作業を9ページにわたって実行できるようにします。</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb9" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb9-1"><span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> (i <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">9</span>) {</span>
<span id="cb9-2">  url <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">paste0</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"https://www.e-stat.go.jp/gis/statmap-search?page="</span>, i, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"&amp;type=2&amp;aggregateUnitForBoundary=S&amp;coordsys=1&amp;format=shape"</span>)</span>
<span id="cb9-3">  </span>
<span id="cb9-4">  html <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">read_html_live</span>(url)</span>
<span id="cb9-5">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">Sys.sleep</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)</span>
<span id="cb9-6">  </span>
<span id="cb9-7">  links <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> html <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb9-8">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">html_elements</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"a"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb9-9">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">html_attr</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"href"</span>)</span>
<span id="cb9-10">  </span>
<span id="cb9-11">  shp_links <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> links[<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">grepl</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"data</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">\\</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">?dlserveyId=S&amp;"</span>, links)]</span>
<span id="cb9-12">  </span>
<span id="cb9-13">  full_urls <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">paste0</span>(base_url, shp_links)</span>
<span id="cb9-14">  </span>
<span id="cb9-15">  <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> (j <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">seq_along</span>(full_urls)) {</span>
<span id="cb9-16">    code <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sub</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">".*code=([0-9]+).*"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">\\</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">1"</span>, shp_links[j])</span>
<span id="cb9-17">    file_path <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">file.path</span>(save_dir, <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">paste0</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"shpfile_"</span>, code, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">".zip"</span>))</span>
<span id="cb9-18">    </span>
<span id="cb9-19">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> (<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">!</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">file.exists</span>(file_path)) {</span>
<span id="cb9-20">      <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">tryCatch</span>({</span>
<span id="cb9-21">        <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">download.file</span>(full_urls[j], <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">destfile =</span> file_path, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">mode =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"wb"</span>)</span>
<span id="cb9-22">      }, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">error =</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">function</span>(e) {})</span>
<span id="cb9-23">      <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">Sys.sleep</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>)</span>
<span id="cb9-24">    }</span>
<span id="cb9-25">  }</span>
<span id="cb9-26">}</span></code></pre></div></div>
<p><strong>ポイント：</strong></p>
<ol type="1">
<li>URLの<code>page=</code>の部分に1から9が入るように設定
<ul>
<li>URLを分割し、ページ数の部分に<code>i</code>で数字を入れています。</li>
</ul></li>
<li>HTMLを読み込んだ後に<code>Sys.sleep(1)</code>で1秒待機
<ul>
<li>HTMLを読み込んですぐ次のコマンドに移ると、中身を最後まで読み込まないまま次を実行してしまうので、しっかり読み込めるようにするための設定です。</li>
</ul></li>
<li><code>for</code>ループ2段階目
<ul>
<li>大外の<code>for</code>で<code>i</code>を使っているので、今度は<code>j</code>にしています。</li>
<li><code>if</code>でファイルがない場合に実行するようにしている。
<ul>
<li>何らかの理由で途中エラーが発生し、再度全体を実行しても、既にダウンロードできているファイルを重複してダウンロードせずに済みます。</li>
</ul></li>
<li><code>tryCatch</code>は、途中でエラーが起きたときでもスクリプト全体を止めずに柔軟に処理を続けるための関数で、エラーが起きても一旦スキップして最後まで実行します。</li>
</ul></li>
</ol>
<p>見慣れない関数も登場しましたが、このコードを実行すれば9ページ分まとめてダウンロードすることが可能です。</p>
</section>
<section id="コードまとめ" class="level2">
<h2 class="anchored" data-anchor-id="コードまとめ">コードまとめ</h2>
<p>最後に今回のコードをまとめます。</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb10" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb10-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(rvest)</span>
<span id="cb10-2"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(here)</span>
<span id="cb10-3"></span>
<span id="cb10-4"><span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> (i <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">9</span>) {</span>
<span id="cb10-5">  url <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">paste0</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"https://www.e-stat.go.jp/gis/statmap-search?page="</span>, i, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"&amp;type=2&amp;aggregateUnitForBoundary=S&amp;coordsys=1&amp;format=shape"</span>)</span>
<span id="cb10-6">  </span>
<span id="cb10-7">  html <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">read_html_live</span>(url)</span>
<span id="cb10-8">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">Sys.sleep</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)</span>
<span id="cb10-9">  </span>
<span id="cb10-10">  links <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> html <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb10-11">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">html_elements</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"a"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb10-12">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">html_attr</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"href"</span>)</span>
<span id="cb10-13">  </span>
<span id="cb10-14">  shp_links <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> links[<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">grepl</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"data</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">\\</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">?dlserveyId=S&amp;"</span>, links)]</span>
<span id="cb10-15">  </span>
<span id="cb10-16">  full_urls <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">paste0</span>(base_url, shp_links)</span>
<span id="cb10-17">  </span>
<span id="cb10-18">  <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> (j <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">seq_along</span>(full_urls)) {</span>
<span id="cb10-19">    code <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sub</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">".*code=([0-9]+).*"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">\\</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">1"</span>, shp_links[j])</span>
<span id="cb10-20">    file_path <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">here</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"shpfiles"</span>, <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">paste0</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"shpfile_"</span>, code, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">".zip"</span>))</span>
<span id="cb10-21">    </span>
<span id="cb10-22">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> (<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">!</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">file.exists</span>(file_path)) {</span>
<span id="cb10-23">      <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">tryCatch</span>({</span>
<span id="cb10-24">        <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">download.file</span>(full_urls[j], <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">destfile =</span> file_path, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">mode =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"wb"</span>)</span>
<span id="cb10-25">      }, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">error =</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">function</span>(e) {})</span>
<span id="cb10-26">      <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">Sys.sleep</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>)</span>
<span id="cb10-27">    }</span>
<span id="cb10-28">  }</span>
<span id="cb10-29">}</span></code></pre></div></div>
</section>
<section id="おわりに" class="level2">
<h2 class="anchored" data-anchor-id="おわりに">おわりに</h2>
<p>今回はRでe-Statのシェープファイルを取得してきました。個人的にもずっとやりたいことだったので、不完全とはいえ、念願かなった感じです。</p>
<p>今後も調査して全ページを一つのループでダウンロードできるようなコードを書いていきたいと思います。</p>
</section>
<section id="おまけ" class="level2">
<h2 class="anchored" data-anchor-id="おまけ">おまけ</h2>
<p>Zipファイルでダウンロードすることになりますが、今回の流れでエクスプローラーから直接展開したりファイルを削除するのは面倒だと思います。</p>
<p>解凍し、使用済みのZipファイルを削除するには以下を実行します。</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb11" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb11-1">zip_files <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">list.files</span>(save_dir, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">pattern =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">\\</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">.zip$"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">full.names =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">TRUE</span>)</span>
<span id="cb11-2"></span>
<span id="cb11-3"><span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> (zip_path <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> zip_files) {</span>
<span id="cb11-4">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">unzip</span>(zip_path, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">exdir =</span> save_dir)</span>
<span id="cb11-5">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">file.remove</span>(zip_path)</span>
<span id="cb11-6">}</span></code></pre></div></div>
<p><code>unzip()</code>でZipファイルを解凍して、<code>file.remove()</code>でZipファイルを削除します。</p>
</section>
<section id="その他の実用例" class="level2">
<h2 class="anchored" data-anchor-id="その他の実用例">その他の実用例</h2>
<p>最近仕事の一環で時間がかかりそうな作業をスクレイピングでサクッと解決したので、地味な例ではありますがご参考までに紹介します。</p>
<section id="シーン" class="level3">
<h3 class="anchored" data-anchor-id="シーン">シーン</h3>
<p>各省庁が出している白書のリストが載っている<a href="https://www.e-gov.go.jp/about-government/white-papers.html">ページ</a>があるのですが、ここから白書名、省庁名、リンクをぱぱーっと取ってきたいという場面です。</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://yo5uke.com/pages/tips/250319_scraping/image/e-gov_list.png" class="img-fluid figure-img" style="width:60.0%"></p>
<figcaption>こんな感じでずらーっと並んでいます</figcaption>
</figure>
</div>
</section>
<section id="手順" class="level3">
<h3 class="anchored" data-anchor-id="手順">手順</h3>
<ol type="1">
<li><code>read_html()</code>でURLを読み込む（今回は<code>live</code>の方でなくてもできる例です）</li>
</ol>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb12" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb12-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(rvest)</span>
<span id="cb12-2"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(tidyverse)</span>
<span id="cb12-3"></span>
<span id="cb12-4">url <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"https://www.e-gov.go.jp/about-government/white-papers.html"</span></span>
<span id="cb12-5">html <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">read_html</span>(url)</span></code></pre></div></div>
</div>
<ol start="2" type="1">
<li>要素を確認する
<ul>
<li><code>Ctrl</code> + <code>Shift</code> + <code>I</code>でデベロッパーツールを開き、白書名やリンクなどがどうなっているか確認します</li>
</ul></li>
</ol>
<div id="hakusho-html" class="quarto-figure quarto-figure-center anchored">
<figure class="figure">
<p><img src="https://yo5uke.com/pages/tips/250319_scraping/image/developer_tool_hakusho.png" class="img-fluid figure-img"></p>
<figcaption>水循環白書はこのようになっています</figcaption>
</figure>
</div>
<ol start="3" type="1">
<li>要素を取得する</li>
</ol>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb13" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb13-1">items <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> html <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb13-2">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">html_element</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"main"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb13-3">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">html_element</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"ul"</span>)</span>
<span id="cb13-4"></span>
<span id="cb13-5">hakusho <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> items <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb13-6">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">html_elements</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"span"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb13-7">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">html_text</span>()</span>
<span id="cb13-8"></span>
<span id="cb13-9">ministry <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> items <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb13-10">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">html_elements</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"p"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb13-11">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">html_text</span>()</span>
<span id="cb13-12"></span>
<span id="cb13-13">links <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> items <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb13-14">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">html_elements</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"a"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb13-15">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">html_attr</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"href"</span>)</span></code></pre></div></div>
<ol start="4" type="1">
<li>データフレームにまとめる</li>
</ol>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb14" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb14-1">df <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> tibble<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">tibble</span>(</span>
<span id="cb14-2">  白書名 <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> hakusho, </span>
<span id="cb14-3">  省庁名 <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> ministry, </span>
<span id="cb14-4">  リンク <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> links</span>
<span id="cb14-5">)</span></code></pre></div></div>
</section>
<section id="詳細" class="level3">
<h3 class="anchored" data-anchor-id="詳細">詳細</h3>
<p>ブラウザ上でHTMLコードを下の方まで見てみるとわかるのですが、白書の情報は<code>&lt;main role="main"&gt;</code>から<code>&lt;/main&gt;</code>の間に含まれていることがわかります。さらに、画像をジーっと見てみると、欲しい要素は</p>
<ol type="1">
<li><code>span</code>で囲まれている部分</li>
<li><code>p</code>で囲まれている部分</li>
<li><code>a</code>タグの中の<code>href</code></li>
</ol>
<p>であることがわかります。試しにこれまで説明したコードを用いて取得してみると、</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb15" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb15-1">hakusho <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> html <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb15-2">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">html_elements</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"span"</span>)</span></code></pre></div></div>
</div>
<div class="cell">
<div class="cell-output cell-output-stdout">
<pre><code>{xml_nodeset (61)}
 [1] &lt;span class="egovui-title"&gt;\n        ポータル&lt;/span&gt;
 [2] &lt;span class="egovui-english-link"&gt;&lt;a href="/en/" class="egovui-textlink- ...
 [3] &lt;span class="egovui-label"&gt;サイト内検索&lt;/span&gt;
 [4] &lt;span class="egovui-label"&gt;行政機関横断検索&lt;/span&gt;
 [5] &lt;span class="egovui-search "&gt;\n          &lt;input type="text" name="q" cla ...
 [6] &lt;span&gt;水循環白書&lt;/span&gt;
 [7] &lt;span&gt;年次報告書&lt;/span&gt;
 [8] &lt;span&gt;経済財政白書&lt;/span&gt;
 [9] &lt;span&gt;原子力白書&lt;/span&gt;
[10] &lt;span&gt;防災白書&lt;/span&gt;
[11] &lt;span&gt;高齢社会白書&lt;/span&gt;
[12] &lt;span&gt;障害者白書&lt;/span&gt;
[13] &lt;span&gt;交通安全白書&lt;/span&gt;
[14] &lt;span&gt;男女共同参画白書&lt;/span&gt;
[15] &lt;span&gt;年次報告&lt;/span&gt;
[16] &lt;span&gt;警察白書&lt;/span&gt;
[17] &lt;span&gt;犯罪被害者白書&lt;/span&gt;
[18] &lt;span&gt;年次報告&lt;/span&gt;
[19] &lt;span&gt;金融庁の１年&lt;/span&gt;
[20] &lt;span&gt;消費者白書&lt;/span&gt;
...</code></pre>
</div>
</div>
<p>欲しいのは「水循環白書」みたいな白書名だけですが、<code>&lt;span&gt;</code>の文字など余計な要素も取れてしまいました。中身のテキストだけ抜きたい場合は<code>html_text()</code>を使います。</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb17" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb17-1">hakusho <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> html <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb17-2">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">html_elements</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"span"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb17-3">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">html_text</span>()</span></code></pre></div></div>
</div>
<div class="cell">
<div class="cell-output cell-output-stdout">
<pre><code> [1] "\n        ポータル"     "English"                "サイト内検索"          
 [4] "行政機関横断検索"       "\n          \n        " "水循環白書"            
 [7] "年次報告書"             "経済財政白書"           "原子力白書"            
[10] "防災白書"              </code></pre>
</div>
</div>
<p>表示しているのは一部ですが、それでも、そもそも余計なものが多いことがわかります。これは、欲しいのが<code>&lt;main&gt;</code>で囲まれている部分であるにもかかわらず、ページ全体から<code>span</code>を探して拾ってきているためです。</p>
<p>さらに画像をよーく見ると、<code>main</code>の中でも<code>p</code>は「各行政機関が～」という文言も含んでしまっていることがわかります。<code>main</code>→<code>p</code>と指定すると、この文言も拾ってきてしまいます。そのため絞り込みとしては<code>main</code>、さらには<code>ul</code>にも絞った方が良いということが考えられます<sup>3</sup>。すなわち<code>main</code>→<code>ul</code>→<code>p</code>という絞り方です。</p>
<p>まずは対象を<code>main</code>→<code>ul</code>に絞っておきます。</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb19" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb19-1">items <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> html <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb19-2">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">html_element</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"main"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb19-3">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">html_element</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"ul"</span>)</span></code></pre></div></div>
</div>
<p><code>html_elements()</code>もありますが、これは複数形なので要素が多くあり、全部取りたいような場合に使います。今回は<code>main</code>が1つでその中の<code>ul</code>も1つとわかっているので単数形です。</p>
<p>この上で<code>items</code>を用いて取得します。</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb20" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb20-1">hakusho <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> items <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb20-2">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">html_elements</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"span"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb20-3">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">html_text</span>()</span></code></pre></div></div>
</div>
<div class="cell">
<div class="cell-output cell-output-stdout">
<pre><code> [1] "水循環白書"       "年次報告書"       "経済財政白書"     "原子力白書"      
 [5] "防災白書"         "高齢社会白書"     "障害者白書"       "交通安全白書"    
 [9] "男女共同参画白書" "年次報告"        </code></pre>
</div>
</div>
<p>これも表示しているのは一部ですが、しっかりとれています。同様の手順で要素を確認しつつ取得を進めます。</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb22" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb22-1">ministry <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> items <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb22-2">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">html_elements</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"p"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb22-3">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">html_text</span>()</span>
<span id="cb22-4"></span>
<span id="cb22-5">links <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> items <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb22-6">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">html_elements</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"a"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb22-7">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">html_attr</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"href"</span>)</span></code></pre></div></div>
</div>
<p>これで全53件分そろいました。最後にデータフレーム化して終了です。</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb23" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb23-1">df <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">tibble</span>(</span>
<span id="cb23-2">  白書名 <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> hakusho, </span>
<span id="cb23-3">  省庁名 <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> ministry, </span>
<span id="cb23-4">  リンク <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> links</span>
<span id="cb23-5">)</span></code></pre></div></div>
</div>
<div class="cell">
<div class="cell-output-display">
<!-- preamble start -->

    <script>

      function styleCell_bl8iueap0kb63u6oio1r(i, j, css_id) {
          var table = document.getElementById("tinytable_bl8iueap0kb63u6oio1r");
          var cell = table.rows[i]?.cells[j];  // Safe navigation to avoid errors
          if (cell) {
              console.log(`Styling cell at (${i}, ${j}) with class ${css_id}`);
              cell.classList.add(css_id);
          } else {
              console.warn(`Cell at (${i}, ${j}) not found.`);
          }
      }
      function insertSpanRow(i, colspan, content) {
        var table = document.getElementById('tinytable_bl8iueap0kb63u6oio1r');
        var newRow = table.insertRow(i);
        var newCell = newRow.insertCell(0);
        newCell.setAttribute("colspan", colspan);
        // newCell.innerText = content;
        // this may be unsafe, but innerText does not interpret <br>
        newCell.innerHTML = content;
      }
      function spanCell_bl8iueap0kb63u6oio1r(i, j, rowspan, colspan) {
        var table = document.getElementById("tinytable_bl8iueap0kb63u6oio1r");
        const targetRow = table.rows[i];
        const targetCell = targetRow.cells[j];
        for (let r = 0; r < rowspan; r++) {
          // Only start deleting cells to the right for the first row (r == 0)
          if (r === 0) {
            // Delete cells to the right of the target cell in the first row
            for (let c = colspan - 1; c > 0; c--) {
              if (table.rows[i + r].cells[j + c]) {
                table.rows[i + r].deleteCell(j + c);
              }
            }
          }
          // For rows below the first, delete starting from the target column
          if (r > 0) {
            for (let c = colspan - 1; c >= 0; c--) {
              if (table.rows[i + r] && table.rows[i + r].cells[j]) {
                table.rows[i + r].deleteCell(j);
              }
            }
          }
        }
        // Set rowspan and colspan of the target cell
        targetCell.rowSpan = rowspan;
        targetCell.colSpan = colspan;
      }
      // tinytable span after
      window.addEventListener('load', function () {
          var cellsToStyle = [
            // tinytable style arrays after
          { positions: [ { i: 6, j: 0 }, { i: 6, j: 1 }, { i: 6, j: 2 },  ], css_id: 'tinytable_css_2ax639h89vxdhzg52ii2',}, 
          { positions: [ { i: 0, j: 0 }, { i: 0, j: 1 }, { i: 0, j: 2 },  ], css_id: 'tinytable_css_w2hgak4afsramqb9smvl',}, 
          ];

          // Loop over the arrays to style the cells
          cellsToStyle.forEach(function (group) {
              group.positions.forEach(function (cell) {
                  styleCell_bl8iueap0kb63u6oio1r(cell.i, cell.j, group.css_id);
              });
          });
      });
    </script>

    <style>
      /* tinytable css entries after */
      .table td.tinytable_css_2ax639h89vxdhzg52ii2, .table th.tinytable_css_2ax639h89vxdhzg52ii2 { border-bottom: solid #d3d8dc 0.1em; }
      .table td.tinytable_css_w2hgak4afsramqb9smvl, .table th.tinytable_css_w2hgak4afsramqb9smvl { border-top: solid #d3d8dc 0.1em; border-bottom: solid #d3d8dc 0.05em; }
    </style>
    <div class="container">
      <table class="table table-borderless" id="tinytable_bl8iueap0kb63u6oio1r" style="width: auto; margin-left: auto; margin-right: auto;" data-quarto-disable-processing="true">
        <thead>
        
              <tr>
                <th scope="col">白書名</th>
                <th scope="col">省庁名</th>
                <th scope="col">リンク</th>
              </tr>
        </thead>
        
        <tbody>
                <tr>
                  <td>水循環白書</td>
                  <td>内閣官房</td>
                  <td>https://www.cas.go.jp/jp/seisaku/mizu_junkan/materials/materials/white_paper.html</td>
                </tr>
                <tr>
                  <td>年次報告書</td>
                  <td>人事院</td>
                  <td>https://www.jinji.go.jp/hakusho/</td>
                </tr>
                <tr>
                  <td>経済財政白書</td>
                  <td>内閣府</td>
                  <td>https://www5.cao.go.jp/keizai3/whitepaper.html#keizai</td>
                </tr>
                <tr>
                  <td>原子力白書</td>
                  <td>内閣府</td>
                  <td>http://www.aec.go.jp/jicst/NC/about/hakusho/index.htm</td>
                </tr>
                <tr>
                  <td>防災白書</td>
                  <td>内閣府</td>
                  <td>http://www.bousai.go.jp/kaigirep/hakusho/index.html</td>
                </tr>
                <tr>
                  <td>高齢社会白書</td>
                  <td>内閣府</td>
                  <td>https://www8.cao.go.jp/kourei/whitepaper/index-w.html</td>
                </tr>
        </tbody>
      </table>
    </div>
<!-- hack to avoid NA insertion in last line -->
</div>
</div>
<p>いい感じに整理できました。</p>
<p>ウェブサイトからたくさんの情報を繰り返し同じ動作で集めなければならないとき、役に立ちそうですね！</p>
<p>おまけもおまけで、もはや本題には関係ありませんが、厳密に白書と明記されているもののみをとりたいならデータフレームにフィルタリングしてしまいましょう。</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb24" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb24-1">df_hakusho <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> df <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb24-2">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">filter</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">str_detect</span>(hakusho, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"白書"</span>))</span></code></pre></div></div>
</div>
<div class="cell">
<div class="cell-output-display">
<!-- preamble start -->

    <script>

      function styleCell_pmaki2o1kcmdwf0efzaw(i, j, css_id) {
          var table = document.getElementById("tinytable_pmaki2o1kcmdwf0efzaw");
          var cell = table.rows[i]?.cells[j];  // Safe navigation to avoid errors
          if (cell) {
              console.log(`Styling cell at (${i}, ${j}) with class ${css_id}`);
              cell.classList.add(css_id);
          } else {
              console.warn(`Cell at (${i}, ${j}) not found.`);
          }
      }
      function insertSpanRow(i, colspan, content) {
        var table = document.getElementById('tinytable_pmaki2o1kcmdwf0efzaw');
        var newRow = table.insertRow(i);
        var newCell = newRow.insertCell(0);
        newCell.setAttribute("colspan", colspan);
        // newCell.innerText = content;
        // this may be unsafe, but innerText does not interpret <br>
        newCell.innerHTML = content;
      }
      function spanCell_pmaki2o1kcmdwf0efzaw(i, j, rowspan, colspan) {
        var table = document.getElementById("tinytable_pmaki2o1kcmdwf0efzaw");
        const targetRow = table.rows[i];
        const targetCell = targetRow.cells[j];
        for (let r = 0; r < rowspan; r++) {
          // Only start deleting cells to the right for the first row (r == 0)
          if (r === 0) {
            // Delete cells to the right of the target cell in the first row
            for (let c = colspan - 1; c > 0; c--) {
              if (table.rows[i + r].cells[j + c]) {
                table.rows[i + r].deleteCell(j + c);
              }
            }
          }
          // For rows below the first, delete starting from the target column
          if (r > 0) {
            for (let c = colspan - 1; c >= 0; c--) {
              if (table.rows[i + r] && table.rows[i + r].cells[j]) {
                table.rows[i + r].deleteCell(j);
              }
            }
          }
        }
        // Set rowspan and colspan of the target cell
        targetCell.rowSpan = rowspan;
        targetCell.colSpan = colspan;
      }
      // tinytable span after
      window.addEventListener('load', function () {
          var cellsToStyle = [
            // tinytable style arrays after
          { positions: [ { i: 6, j: 0 }, { i: 6, j: 1 }, { i: 6, j: 2 },  ], css_id: 'tinytable_css_6kvxtmizszkn553wmv0n',}, 
          { positions: [ { i: 0, j: 0 }, { i: 0, j: 1 }, { i: 0, j: 2 },  ], css_id: 'tinytable_css_0wjk5lnf1lt0y47q8ums',}, 
          ];

          // Loop over the arrays to style the cells
          cellsToStyle.forEach(function (group) {
              group.positions.forEach(function (cell) {
                  styleCell_pmaki2o1kcmdwf0efzaw(cell.i, cell.j, group.css_id);
              });
          });
      });
    </script>

    <style>
      /* tinytable css entries after */
      .table td.tinytable_css_6kvxtmizszkn553wmv0n, .table th.tinytable_css_6kvxtmizszkn553wmv0n { border-bottom: solid #d3d8dc 0.1em; }
      .table td.tinytable_css_0wjk5lnf1lt0y47q8ums, .table th.tinytable_css_0wjk5lnf1lt0y47q8ums { border-top: solid #d3d8dc 0.1em; border-bottom: solid #d3d8dc 0.05em; }
    </style>
    <div class="container">
      <table class="table table-borderless" id="tinytable_pmaki2o1kcmdwf0efzaw" style="width: auto; margin-left: auto; margin-right: auto;" data-quarto-disable-processing="true">
        <thead>
        
              <tr>
                <th scope="col">白書名</th>
                <th scope="col">省庁名</th>
                <th scope="col">リンク</th>
              </tr>
        </thead>
        
        <tbody>
                <tr>
                  <td>水循環白書</td>
                  <td>内閣官房</td>
                  <td>https://www.cas.go.jp/jp/seisaku/mizu_junkan/materials/materials/white_paper.html</td>
                </tr>
                <tr>
                  <td>経済財政白書</td>
                  <td>内閣府</td>
                  <td>https://www5.cao.go.jp/keizai3/whitepaper.html#keizai</td>
                </tr>
                <tr>
                  <td>原子力白書</td>
                  <td>内閣府</td>
                  <td>http://www.aec.go.jp/jicst/NC/about/hakusho/index.htm</td>
                </tr>
                <tr>
                  <td>防災白書</td>
                  <td>内閣府</td>
                  <td>http://www.bousai.go.jp/kaigirep/hakusho/index.html</td>
                </tr>
                <tr>
                  <td>高齢社会白書</td>
                  <td>内閣府</td>
                  <td>https://www8.cao.go.jp/kourei/whitepaper/index-w.html</td>
                </tr>
                <tr>
                  <td>障害者白書</td>
                  <td>内閣府</td>
                  <td>https://www8.cao.go.jp/shougai/whitepaper/index-w.html</td>
                </tr>
        </tbody>
      </table>
    </div>
<!-- hack to avoid NA insertion in last line -->
</div>
</div>
<p>「年次報告書」などは抜くことができています。<code>str_detect(変数名, パターン)</code>で対応するものを抜き取ることができます。</p>


<!-- -->

</section>
</section>


<div id="quarto-appendix" class="default"><section id="footnotes" class="footnotes footnotes-end-of-document"><h2 class="anchored quarto-appendix-heading">注</h2>

<ol>
<li id="fn1"><p>Chromeではサービスが終了したみたいです。Firefoxではまだあるようです。↩︎</p></li>
<li id="fn2"><p>先述のJavaScriptが使われているページで実行できないという課題↩︎</p></li>
<li id="fn3"><p>絞り込み方はこれ以外にもいろいろあると思います。↩︎</p></li>
</ol>
</section></div> ]]></description>
  <category>R</category>
  <category>データ処理</category>
  <guid>https://yo5uke.com/pages/tips/250319_scraping/</guid>
  <pubDate>Tue, 18 Mar 2025 15:00:00 GMT</pubDate>
  <media:content url="https://yo5uke.com/pages/tips/250319_scraping/image/html_view.png" medium="image" type="image/png" height="85" width="144"/>
</item>
<item>
  <title>e-Stat APIを使ってデータを取得しよう</title>
  <link>https://yo5uke.com/pages/tips/250309_estat_api/</link>
  <description><![CDATA[ 

<div class="social-share-buttons">

  <!-- Twitter (X) -->

  <a href="" id="js-share-twitter" class="share_button ri--twitter-x-fill" target="_blank" rel="nofollow noopener noreferrer"></a>



  <!-- Bluesky -->

  <a href="" id="js-share-bluesky" class="share_button ri--bluesky-fill" target="_blank" rel="nofollow noopener noreferrer"></a>

</div>



<script>

  const twitterUsername = "@5uke_y";

  const blueskyUsername = "@5uke.bsky.social";



  const share_url = encodeURIComponent(location.href);

  const share_title = document.title;



  // Twitter (X)

  document.getElementById('js-share-twitter').setAttribute(

    "href",

    "https://twitter.com/share?url=" + share_url + "&text=" + share_title + " " + encodeURIComponent(twitterUsername) + " より" +

    "&hashtags=rstats"

  );



  // Bluesky

  document.getElementById('js-share-bluesky').setAttribute(

    "href",

    "https://bsky.app/intent/compose?text=" + share_title + " " + share_url + " " + encodeURIComponent(blueskyUsername) + " より"

  );

</script>






<section id="はじめに" class="level2">
<h2 class="anchored" data-anchor-id="はじめに">はじめに</h2>
<p>今回は説明するという言い方がおこがましい程度の備忘録的な内容です。</p>
<p>今後データを使う仕事をするにあたり、もう少し統計データに詳しくなりたいと思い、e-Statでよく目にするAPIに目を付けました。正直APIというのが何かわからないレベルからのスタートでしたが、調べながら初歩的な部分をすこーし理解できた気がしないでもありません。</p>
<p>今回はAPIの初歩の初歩をまとめていきたいと思います。</p>
</section>
<section id="e-statでの準備" class="level2">
<h2 class="anchored" data-anchor-id="e-statでの準備">e-Statでの準備</h2>
<p>まずはじめにe-Statでユーザー登録をし、アプリケーションIDを取得する必要があります。</p>
<p>ブラウザで<a href="https://www.e-stat.go.jp/">e-Stat</a>を開き、画面右上の「新規登録」から登録します。難しい点はほとんどないと思うので詳細は省略しますが、登録できたらログインした状態にしておいてください。</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://yo5uke.com/pages/tips/250309_estat_api/image/e-stat_home.png" class="img-fluid figure-img"></p>
<figcaption>右上の「新規登録」から登録します</figcaption>
</figure>
</div>
<p>ログインできたら、上部の青いナビゲーションバーに「マイページ」が出てきますので、そこをクリックしてマイページに進みます。</p>
<p>するとナビゲーションバーの少し下に水色のバーが出てきて、そこに「API機能（アプリケーションID発行）」とあるので、そこをクリックします。</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://yo5uke.com/pages/tips/250309_estat_api/image/e-stat_mypage.png" class="img-fluid figure-img"></p>
<figcaption>右から2つ目の項目です</figcaption>
</figure>
</div>
<p>するとアプリケーションIDの取得ということで3つの欄が出てきますので、1番上の欄を使用していきます。名称の部分に任意の名前を入れ、URLはそのままにしておきます。右側の「発行」をクリックすれば「appId」の部分にアプリケーションIDが表示され、これを後ほど使うことになります。</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://yo5uke.com/pages/tips/250309_estat_api/image/e-stat_get_appid.png" class="img-fluid figure-img"></p>
<figcaption>名称は何でも大丈夫です</figcaption>
</figure>
</div>
</section>
<section id="使用するパッケージ" class="level2">
<h2 class="anchored" data-anchor-id="使用するパッケージ">使用するパッケージ</h2>
<p>Rに戻ります。</p>
<p>今回は以下の3つのパッケージを使用します。</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb1" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># インストール</span></span>
<span id="cb1-2"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># pak::pak(c("httr", "xml2", "tidyverse"))</span></span>
<span id="cb1-3"></span>
<span id="cb1-4"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(httr)</span>
<span id="cb1-5"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(xml2)</span>
<span id="cb1-6"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(tidyverse)</span></code></pre></div></div>
</div>
<p>{httr}はHTTPリクエストを送信してWeb APIからデータを取得するためのパッケージで、{xml2}はXMLデータを解析して必要な情報を抽出するためのパッケージです。XMLはデータを構造化して表現するためのフォーマットであり、APIなどでデータを受け取る際によく使われるようです。</p>
<p>{tidyverse}はおなじみのデータハンドリング用です。</p>
</section>
<section id="apiでデータを取得" class="level2">
<h2 class="anchored" data-anchor-id="apiでデータを取得">APIでデータを取得</h2>
<section id="apiリクエストurlを取得格納" class="level3">
<h3 class="anchored" data-anchor-id="apiリクエストurlを取得格納">APIリクエストURLを取得、格納</h3>
<p>まずはe-Statで取得したい統計のページへアクセスします。今回は令和2年国勢調査の人口等基本集計、総人口と男女別人口のデータを取得したいと思います。今回使うページのURLは以下です。</p>
<p><a href="https://www.e-stat.go.jp/stat-search/database?page=1&amp;layout=datalist&amp;toukei=00200521&amp;tstat=000001136464&amp;cycle=0&amp;tclass1=000001136466&amp;statdisp_id=0003445078&amp;tclass2val=0" class="uri">https://www.e-stat.go.jp/stat-search/database?page=1&amp;layout=datalist&amp;toukei=00200521&amp;tstat=000001136464&amp;cycle=0&amp;tclass1=000001136466&amp;statdisp_id=0003445078&amp;tclass2val=0</a></p>
<p>ページにAPIと書かれた青いアイコンがあるので、そこをクリックします。するとURLが表示されるので、表示されたURLをコピーしておきます。</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://yo5uke.com/pages/tips/250309_estat_api/image/e-stat_api_url.png" class="img-fluid figure-img"></p>
<figcaption>左側にあるAPIと書かれた部分をクリックして出てきたURLをコピーします</figcaption>
</figure>
</div>
<p>次にRで今コピーしたURLを格納します。ダブルクォーテーションで囲んでください。</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb2" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1">url <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"https://api.e-stat.go.jp/rest/3.0/app/getStatsData?appId=&amp;lang=J&amp;statsDataId=0003445078&amp;metaGetFlg=Y&amp;cntGetFlg=N&amp;explanationGetFlg=Y&amp;annotationGetFlg=Y&amp;sectionHeaderFlg=1&amp;replaceSpChars=0"</span></span></code></pre></div></div>
<p>ここで注意ですが、<strong>URLの中に<code>appId=</code>という部分があり、ここに先ほど作成したアプリケーションIDを入れる必要があります</strong>。仮にアプリケーションIDを<code>123456789</code>とすると、</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb3" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1">url <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"https://api.e-stat.go.jp/rest/3.0/app/getStatsData?appId=123456789&amp;lang=J&amp;statsDataId=0003445078&amp;metaGetFlg=Y&amp;cntGetFlg=N&amp;explanationGetFlg=Y&amp;annotationGetFlg=Y&amp;sectionHeaderFlg=1&amp;replaceSpChars=0"</span></span></code></pre></div></div>
<p>となります。</p>
<p><code>appId</code>の部分を直接入れ替えることに不安がある方は、以下の方法でも可能です。</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb4" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1">appId <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"123456789"</span>  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># ここにアプリケーションIDを入れます</span></span>
<span id="cb4-2"></span>
<span id="cb4-3"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># コピーしてきたURL</span></span>
<span id="cb4-4">url_template <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"https://api.e-stat.go.jp/rest/3.0/app/getStatsData?appId=%s&amp;lang=J&amp;statsDataId=0003445078&amp;metaGetFlg=Y&amp;cntGetFlg=N&amp;explanationGetFlg=Y&amp;annotationGetFlg=Y&amp;sectionHeaderFlg=1&amp;replaceSpChars=0"</span></span>
<span id="cb4-5"></span>
<span id="cb4-6">url <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sprintf</span>(url_template, appId)</span></code></pre></div></div>
<p><code>sprintf()</code>は文字列の中に変数を埋め込む関数です。<code>%s</code>の部分が<code>appId</code>で置き換えられるようになっています。</p>
</section>
<section id="urlを使ってapiリクエストを実行" class="level3">
<h3 class="anchored" data-anchor-id="urlを使ってapiリクエストを実行">URLを使ってAPIリクエストを実行</h3>
<p>次に入力したURLを使ってAPIリクエストを実行します。</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb5" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1">response <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">GET</span>(url)</span></code></pre></div></div>
</div>
<p>このレスポンスの内容をテキストとして取得し、XMLとして読み込んでいきます。<code>response</code>にはステータスコードが含まれているのですが、これが200だと読み込みが成功しています。成功していれば読み込むように設定します。</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb6" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1"><span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> (<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">status_code</span>(response) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">200</span>) {</span>
<span id="cb6-2">  xml_data <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">read_xml</span>(</span>
<span id="cb6-3">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">content</span>(response, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">as =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"text"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">encoding =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"UTF-8"</span>)</span>
<span id="cb6-4">  )</span>
<span id="cb6-5"></span>
<span id="cb6-6">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">print</span>(xml_data)</span>
<span id="cb6-7">} <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">else</span> {</span>
<span id="cb6-8">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">stop</span>(</span>
<span id="cb6-9">    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"データの取得に失敗しました。HTTPステータスコード: "</span>,</span>
<span id="cb6-10">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">status_code</span>(response)</span>
<span id="cb6-11">  )</span>
<span id="cb6-12">}</span></code></pre></div></div>
<div class="cell-output cell-output-stdout">
<pre><code>{xml_document}
&lt;GET_STATS_DATA noNamespaceSchemaLocation="https://api.e-stat.go.jp/rest/3.0/schema/GetStatsData.xsd" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"&gt;
[1] &lt;RESULT&gt;\n  &lt;STATUS&gt;0&lt;/STATUS&gt;\n  &lt;ERROR_MSG&gt;正常に終了しました。&lt;/ERROR_MSG&gt;\n  &lt;D ...
[2] &lt;PARAMETER&gt;\n  &lt;LANG&gt;J&lt;/LANG&gt;\n  &lt;STATS_DATA_ID&gt;0003445078&lt;/STATS_DATA_ID ...
[3] &lt;STATISTICAL_DATA&gt;\n  &lt;RESULT_INF&gt;\n    &lt;TOTAL_NUMBER&gt;12258&lt;/TOTAL_NUMBER ...</code></pre>
</div>
</div>
<p>ステータスコードが200になっていたようなので<code>{xml_document}</code>としていろいろ出てきました。また、<code>xml_data</code>に読み込んだXMLが保存されています。</p>
</section>
<section id="xmlの構造確認" class="level3">
<h3 class="anchored" data-anchor-id="xmlの構造確認">XMLの構造確認</h3>
<p>次にXMLの構造を確認してみます。しかしこれは非常に長くなるので、結果は表示しません。実際に手元で実行してみてください。</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb8" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb8-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">xml_structure</span>(xml_data)</span></code></pre></div></div>
</div>
<p>結果の中には様々な情報が構造化されて格納されていることがわかります。僕たちが抽出したい情報は<code>{text}</code>と表示されてしまっているので、このままでは<code>{text}</code>が何か確認することができませんが、この中には統計名や更新日など、統計に関する様々な情報（タグ）が含まれます<sup>1</sup>。必要に応じてここから情報を取得することができるので、試しにいろいろやってみましょう。</p>
<ol type="1">
<li>統計表の名前</li>
</ol>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb9" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb9-1">table_name <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">xml_text</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">xml_find_first</span>(xml_data, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"//TABLE_INF/STATISTICS_NAME"</span>))</span>
<span id="cb9-2"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">print</span>(table_name)</span></code></pre></div></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "令和２年国勢調査 人口等基本集計　（主な内容：男女・年齢・配偶関係，世帯の構成，住居の状態，母子・父子世帯，国籍など）"</code></pre>
</div>
</div>
<ol start="2" type="1">
<li>調査日</li>
</ol>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb11" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb11-1">survey_date <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">xml_text</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">xml_find_first</span>(xml_data, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"//TABLE_INF/SURVEY_DATE"</span>))</span>
<span id="cb11-2"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">print</span>(survey_date)</span></code></pre></div></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "202010"</code></pre>
</div>
</div>
<ol start="3" type="1">
<li>統計表の公開日</li>
</ol>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb13" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb13-1">open_date <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">xml_text</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">xml_find_first</span>(xml_data, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"//TABLE_INF/OPEN_DATE"</span>))</span>
<span id="cb13-2"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">print</span>(open_date)</span></code></pre></div></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "2021-11-30"</code></pre>
</div>
</div>
<p>いろいろ結果が出てきました。ここで、使用していた関数について説明します。</p>
<p>まず<code>xml_text()</code>です。これはXML内の ノード<sup>2</sup>のテキストを取得する関数です。内容をテキストとして抽出するものというようなイメージだと思ってください。</p>
<p>次に<code>xml_find_first()</code>です。これは括弧内で指定したパスと合致する最初のものを抽出してくるという関数です。例えば上の1番では、<code>"//TABLE_INF/STATISTICS_NAME"</code>に一致する部分を探して、そこに書かれている内容を引っ張ってきます。最初ということは複数あるのか？と僕も最初は思ったのですが、どうやら1つしかない要素に対しても一般的に使うようです<sup>3</sup>。</p>
<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
<span class="screen-reader-only">Tip</span>XPath（XML上のパス）について
</div>
</div>
<div class="callout-body-container callout-body">
<p>XMLの構造を丁寧に見た方の中には、<code>TABLE_INF</code>は実は<code>GET_STATS_DATA</code>の中のさらに<code>STATISTICAL_DATA</code>の中に入っているがそれは指定しなくてよいのか、と思った方もいるかもしれません。そこは最初の2つのスラッシュ（<code>//</code>）で対応していて、これは全体のどこにあっても、例えば<code>TABLE_INF/STATISTICS_NAME</code>となっている部分を見つけ出して中身を抽出するということを意味しています。つまり、上記の書き方で<code>"/GET_STATS_DATA/STATISTICAL_DATA/TABLE_INF/STATISTICS_NAME"</code>をヒットさせることができるわけです。</p>
</div>
</div>
</section>
<section id="データを取得" class="level3">
<h3 class="anchored" data-anchor-id="データを取得">データを取得</h3>
<p>ではいろいろ確認できたところでデータを取得する作業に入ります。</p>
<p>データは<code>//DATA_INF/VALUE</code>というところに含まれているので、このパスを用います。また構造を確認していただけばわかるように、<code>VALUE</code>というのは大量にありますので<code>xml_find_first()</code>では最初の1つしか取得できず、不適切です。ここでは<code>xml_find_all()</code>ですべての用をを取得していきます。</p>
<p>加えて、</p>
<pre><code>&lt;VALUE [tab, cat01, area, time, unit]&gt;</code></pre>
<p>となっているように、<code>VALUE</code>には5つの属性が付与されており、それぞれ統計表のタブ（表のバージョンや種類）、統計のカテゴリ、自治体コード、時間（ここでは年）、単位を示します。これを踏まえて必要な情報を以下のコードでは取得しています。</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb16" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb16-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># データがあるノードをすべて取得</span></span>
<span id="cb16-2">value_nodes <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">xml_find_all</span>(xml_data, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"//DATA_INF/VALUE"</span>)</span>
<span id="cb16-3"></span>
<span id="cb16-4">df <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">tibble</span>(</span>
<span id="cb16-5">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># xml_attr()で特定の属性を取得</span></span>
<span id="cb16-6">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">area =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">xml_attr</span>(value_nodes, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"area"</span>),</span>
<span id="cb16-7">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">time =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">xml_attr</span>(value_nodes, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"time"</span>),</span>
<span id="cb16-8">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">category =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">xml_attr</span>(value_nodes, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"cat01"</span>),</span>
<span id="cb16-9">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># valueはテキストとして取得したのち数値に変換</span></span>
<span id="cb16-10">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">value =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">as.numeric</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">xml_text</span>(value_nodes))</span>
<span id="cb16-11">)</span>
<span id="cb16-12"></span>
<span id="cb16-13"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">print</span>(df)</span></code></pre></div></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 12,258 × 4
   area  time       category     value
   &lt;chr&gt; &lt;chr&gt;      &lt;chr&gt;        &lt;dbl&gt;
 1 00000 2020000000 0        126146099
 2 01000 2020000000 0          5224614
 3 01100 2020000000 0          1973395
 4 01101 2020000000 0           248680
 5 01102 2020000000 0           289323
 6 01103 2020000000 0           265379
 7 01104 2020000000 0           211835
 8 01105 2020000000 0           225298
 9 01106 2020000000 0           135777
10 01107 2020000000 0           217040
# ℹ 12,248 more rows</code></pre>
</div>
</div>
<p>このままだと少しわかりにくいですね。<code>time</code>は年なので上4桁だけ取り出したいし、<code>category</code>には３つの数字があるのですが、それぞれが何を意味しているのか分かりません。</p>
<p>ひとまずカテゴリについて確認しておきましょう。XMLの中に<code>CLASS_INF</code>があり、その中に情報が含まれています。カテゴリ（<code>cat01</code>がそれです）について知りたい場合は<code>"//CLASS_INF/CLASS_OBJ[@id='cat01']/CLASS"</code>で確認できます。以下のコードを実行してください。</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb18" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb18-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># xml_data内のノードを取得</span></span>
<span id="cb18-2">cat01_nodes <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">xml_find_all</span>(</span>
<span id="cb18-3">  xml_data,</span>
<span id="cb18-4">  <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"//CLASS_INF/CLASS_OBJ[@id='cat01']/CLASS"</span></span>
<span id="cb18-5">)</span>
<span id="cb18-6"></span>
<span id="cb18-7"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># cat01のコードと対応する名前を取得</span></span>
<span id="cb18-8">df_cat01 <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">tibble</span>(</span>
<span id="cb18-9">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">cat01_code =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">xml_attr</span>(cat01_nodes, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"code"</span>),</span>
<span id="cb18-10">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">cat01_name =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">xml_attr</span>(cat01_nodes, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"name"</span>)</span>
<span id="cb18-11">)</span>
<span id="cb18-12"></span>
<span id="cb18-13"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 結果を表示</span></span>
<span id="cb18-14"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">print</span>(df_cat01)</span></code></pre></div></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 3 × 2
  cat01_code cat01_name
  &lt;chr&gt;      &lt;chr&gt;     
1 0          総数      
2 1          男        
3 2          女        </code></pre>
</div>
</div>
<p>0が総数、1が男、2が女であることがわかりました。なのでここでカテゴリを書き換え、ついでに年も整理し並べ替えておきましょう。</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb20" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb20-1">df_cleaned <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> df <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span></span>
<span id="cb20-2">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">arrange</span>(area, time, category) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span></span>
<span id="cb20-3">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mutate</span>(</span>
<span id="cb20-4">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># timeは上4桁を取り出す</span></span>
<span id="cb20-5">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">time =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">as.integer</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">substr</span>(time, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>)),</span>
<span id="cb20-6">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># case_when()で条件分岐</span></span>
<span id="cb20-7">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">category =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">case_when</span>(</span>
<span id="cb20-8">      <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 文字列として格納されているので""で囲みます</span></span>
<span id="cb20-9">      category <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"0"</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"population"</span>,</span>
<span id="cb20-10">      category <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"1"</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"pop_male"</span>,</span>
<span id="cb20-11">      category <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"2"</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"pop_female"</span></span>
<span id="cb20-12">    )</span>
<span id="cb20-13">  )</span>
<span id="cb20-14"></span>
<span id="cb20-15"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">print</span>(df_cleaned)</span></code></pre></div></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 12,258 × 4
   area   time category       value
   &lt;chr&gt; &lt;int&gt; &lt;chr&gt;          &lt;dbl&gt;
 1 00000  2020 population 126146099
 2 00000  2020 pop_male    61349581
 3 00000  2020 pop_female  64796518
 4 01000  2020 population   5224614
 5 01000  2020 pop_male     2465088
 6 01000  2020 pop_female   2759526
 7 01100  2020 population   1973395
 8 01100  2020 pop_male      918682
 9 01100  2020 pop_female   1054713
10 01101  2020 population    248680
# ℹ 12,248 more rows</code></pre>
</div>
</div>
<p>もしカテゴリの各種をそれぞれ列にしたければ<code>pivot_wider()</code>でできます。</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb22" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb22-1">df_wide <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> df_cleaned <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span></span>
<span id="cb22-2">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">pivot_wider</span>(</span>
<span id="cb22-3">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">names_from =</span> category,</span>
<span id="cb22-4">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">values_from =</span> value</span>
<span id="cb22-5">  )</span>
<span id="cb22-6"></span>
<span id="cb22-7"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">print</span>(df_wide)</span></code></pre></div></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 4,086 × 5
   area   time population pop_male pop_female
   &lt;chr&gt; &lt;int&gt;      &lt;dbl&gt;    &lt;dbl&gt;      &lt;dbl&gt;
 1 00000  2020  126146099 61349581   64796518
 2 01000  2020    5224614  2465088    2759526
 3 01100  2020    1973395   918682    1054713
 4 01101  2020     248680   112853     135827
 5 01102  2020     289323   136596     152727
 6 01103  2020     265379   126023     139356
 7 01104  2020     211835   100062     111773
 8 01105  2020     225298   104154     121144
 9 01106  2020     135777    62347      73430
10 01107  2020     217040   100027     117013
# ℹ 4,076 more rows</code></pre>
</div>
</div>
<p>これでひとまずデータフレームとして整理することができました。ここからさらに整理したり、分析を回していきましょう！</p>
</section>
</section>
<section id="データベースから取得する" class="level2">
<h2 class="anchored" data-anchor-id="データベースから取得する">データベースから取得する</h2>
<p>今回は国勢調査のような既にまとめられたデータを用いましたが、e-Statのデータベースを使えば必要なデータを選択して取得することができます。</p>
<p>例えば<a href="https://www.e-stat.go.jp/regional-statistics/ssdsview">こちら</a>から「市区町村データ」を選択し「データ表示」をクリックします。</p>
<p>出てきた画面から地域を選択し、「確定」をクリックしたのち取得したいデータを選択し、再度「確定」をクリックします。</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://yo5uke.com/pages/tips/250309_estat_api/image/e-stat_database_area.png" class="img-fluid figure-img"></p>
<figcaption>地域を選択します</figcaption>
</figure>
</div>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://yo5uke.com/pages/tips/250309_estat_api/image/e-stat_database_category.png" class="img-fluid figure-img"></p>
<figcaption>取得したい統計項目を選択します</figcaption>
</figure>
</div>
<p>するとデータが画面に表示されますが、ここで右上の「API」をクリックし、表示されたURLをコピーします。ここからは上で書いてきた手順と同様です。</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://yo5uke.com/pages/tips/250309_estat_api/image/e-stat_database_api.png" class="img-fluid figure-img"></p>
<figcaption>URLの使い方はこれまでと同様です</figcaption>
</figure>
</div>
</section>
<section id="おわりに" class="level2">
<h2 class="anchored" data-anchor-id="おわりに">おわりに</h2>
<p>APIは正直初心者には難しいなと感じましたが、大体のコードはそのまま使いまわせますし、XMLの構造を少し辛抱して眺めてみればどこに何が入っているのか少しずつわかってきました。</p>
<p>CSVでダウンロードすると余計な情報量が多く分析の手間に感じていましたので、春休みを機に少しではありますが知れてよかったと思います。ぜひ活用してみて下さい。</p>


<!-- -->

</section>


<div id="quarto-appendix" class="default"><section id="footnotes" class="footnotes footnotes-end-of-document"><h2 class="anchored quarto-appendix-heading">注</h2>

<ol>
<li id="fn1"><p><a href="https://www.e-stat.go.jp/api/api-info/e-stat-manual3-0#api_3_4">こちら</a>からタグの種類を確認できます。↩︎</p></li>
<li id="fn2"><p>XMLデータの中の要素（タグ）や属性、テキストなどの構成要素のことを言います。↩︎</p></li>
<li id="fn3"><p>今回取得してきたような要素は全体を見ても1か所にしか出てきません。↩︎</p></li>
</ol>
</section></div> ]]></description>
  <category>R</category>
  <category>データ処理</category>
  <guid>https://yo5uke.com/pages/tips/250309_estat_api/</guid>
  <pubDate>Sat, 08 Mar 2025 15:00:00 GMT</pubDate>
</item>
<item>
  <title>【ウェブサイト】設定を追加する</title>
  <link>https://yo5uke.com/pages/tips/250205_website_tools/</link>
  <description><![CDATA[ 

<div class="social-share-buttons">

  <!-- Twitter (X) -->

  <a href="" id="js-share-twitter" class="share_button ri--twitter-x-fill" target="_blank" rel="nofollow noopener noreferrer"></a>



  <!-- Bluesky -->

  <a href="" id="js-share-bluesky" class="share_button ri--bluesky-fill" target="_blank" rel="nofollow noopener noreferrer"></a>

</div>



<script>

  const twitterUsername = "@5uke_y";

  const blueskyUsername = "@5uke.bsky.social";



  const share_url = encodeURIComponent(location.href);

  const share_title = document.title;



  // Twitter (X)

  document.getElementById('js-share-twitter').setAttribute(

    "href",

    "https://twitter.com/share?url=" + share_url + "&text=" + share_title + " " + encodeURIComponent(twitterUsername) + " より" +

    "&hashtags=rstats"

  );



  // Bluesky

  document.getElementById('js-share-bluesky').setAttribute(

    "href",

    "https://bsky.app/intent/compose?text=" + share_title + " " + share_url + " " + encodeURIComponent(blueskyUsername) + " より"

  );

</script>






<section id="はじめに" class="level2">
<h2 class="anchored" data-anchor-id="はじめに">はじめに</h2>
<p>2月に入りましたが、本年初の更新となります。今年は就職の年ですが、時間があるときに学びを備忘録がてら更新していきたいと思いますのでよろしくお願いします。</p>
<p>今回は以前ご紹介したウェブサイトの作り方について、さらに設定を追加していこうと思います。</p>
<p>追加する設定は、</p>
<ol type="1">
<li><p>Googleアナリティクス</p></li>
<li><p>SNSアカウント</p></li>
<li><p>フッター</p></li>
</ol>
<p>です。前提として、以下のページ等をもとにQuartoのウェブページが作成されているとします。</p>
<div class="callout callout-style-simple callout-tip no-icon">
<div class="callout-body d-flex">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-body-container">
<p><a href="../241213_create_website/index.html">【Quarto &amp; RStudio】ウェブサイトを作る！</a></p>
</div>
</div>
</div>
<p>順を追ってみていきましょう。</p>
</section>
<section id="googleアナリティクス" class="level2">
<h2 class="anchored" data-anchor-id="googleアナリティクス">Googleアナリティクス</h2>
<p>そもそもですが、Googleアナリティクスでは、ウェブサイトやアプリの訪問者の動向を分析することができます。例えば、昨日は何人がページを訪れて、どのページを見ていったか、といったことが把握できるようになります。</p>
<section id="アナリティクスページ" class="level3">
<h3 class="anchored" data-anchor-id="アナリティクスページ">アナリティクスページ</h3>
<p>まずは、Googleアナリティクスのページでの設定を行います。</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://yo5uke.com/pages/tips/250205_website_tools/image/analytics_top.png" class="img-fluid figure-img" style="width:80.0%"></p>
<figcaption>Googleアナリティクスの画面</figcaption>
</figure>
</div>
<ol type="1">
<li><a href="https://analytics.google.com/" class="uri">https://analytics.google.com/</a>へ移動し、使用するGoogleアカウントでログインする</li>
<li>「測定を開始」をクリック</li>
<li>任意のアカウント名を入力、データ共有設定で必要な項目にチェックを入れ、次へ
<ul>
<li>アカウント名は何でも大丈夫です。</li>
<li>チェックはそのままでも大丈夫です。</li>
</ul></li>
<li>任意のプロパティ名を入力し、次へ
<ul>
<li>これはウェブページ名にした方がわかりやすいと思います。</li>
<li>例：「hogehoge.github.io」</li>
</ul></li>
<li>ビジネスの説明を入力し、次へ
<ul>
<li>ここは適当で大丈夫だと思います。</li>
</ul></li>
<li>ビジネス目標を選択し、「作成」を選択
<ul>
<li>「ウェブ/アプリのトラフィックの分析」や「ユーザーエンゲージメントとユーザーの維持率の把握」あたりが該当すると思います。</li>
</ul></li>
<li>「ウェブ」を選択</li>
<li>URLとストリーム名を入力し、「作成して続行」をクリック
<ul>
<li>URLはGitHubページであれば「(ユーザー名).github.io」です。不安であればホームページからコピーしてきてください。</li>
<li>ストリーム名はプロパティ名と同じでいいと思います。</li>
</ul></li>
</ol>
<p>「Googleタグの設定」という画面が出てくると思いますが、ここは×で閉じて大丈夫です。すると、「ウェブ ストリームの詳細」の画面が出てくるので、そこの<strong>測定 ID</strong>（Gで始まる）をコピーして下さい。</p>
<p>画面を閉じてしまっても、表示されている画面で該当するページ部分をクリックすれば再度開くことができます。</p>
</section>
<section id="quartoの設定" class="level3">
<h3 class="anchored" data-anchor-id="quartoの設定">Quartoの設定</h3>
<p>エディターに戻り、<code>_quarto.yml</code>を開きます。</p>
<p>以下のように、<code>google-analytics</code>にコピーしたIDを追記してください。</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb1" style="background: #f1f3f5;"><pre class="sourceCode yaml code-with-copy"><code class="sourceCode yaml"><span id="cb1-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">project</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">:</span></span>
<span id="cb1-2"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">  </span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">type</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">:</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> website</span></span>
<span id="cb1-3"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">  </span></span>
<span id="cb1-4"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">website</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">:</span></span>
<span id="cb1-5"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">  </span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">title</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">:</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> </span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"ホームページ"</span></span>
<span id="cb1-6"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">  </span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">google-analytics</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">:</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> </span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"G-xxxxxxxxxx"</span></span>
<span id="cb1-7"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">  </span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">navbar</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">:</span></span>
<span id="cb1-8"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">    </span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">right</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">:</span></span>
<span id="cb1-9"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">      </span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">-</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> about.qmd</span></span></code></pre></div></div>
<p>これで保存して再度パブリッシュ<sup>1</sup>し、しばらくすると追跡結果がみられるようになります。すぐは見れませんが、しばらくした後再度<a href="https://analytics.google.com/">Googleアナリティクス</a>を訪れてみてください。</p>
</section>
</section>
<section id="snsアカウントを追加" class="level2">
<h2 class="anchored" data-anchor-id="snsアカウントを追加">SNSアカウントを追加</h2>
<p>ウェブサイトからXやFacebookなど他のページへ飛んでほしいこともあるかと思います。こうしたSNSアカウントやGitHubなどのアイコンの表示方法をご紹介します。</p>
<section id="ナビゲーションバー" class="level3">
<h3 class="anchored" data-anchor-id="ナビゲーションバー">ナビゲーションバー</h3>
<p>まずは画面上部のナビゲーションバーに表示する方法です（本ページも右上にGitHubアイコンがあります）。</p>
<p><code>_quarto.yml</code>を開きます。以下のように<code>tools</code>を追記して下さい。</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb2" style="background: #f1f3f5;"><pre class="sourceCode yaml code-with-copy"><code class="sourceCode yaml"><span id="cb2-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">project</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">:</span></span>
<span id="cb2-2"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">  </span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">type</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">:</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> website</span></span>
<span id="cb2-3"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">  </span></span>
<span id="cb2-4"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">website</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">:</span></span>
<span id="cb2-5"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">  </span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">title</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">:</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> </span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"ホームページ"</span></span>
<span id="cb2-6"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">  </span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">google-analytics</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">:</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> </span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"G-xxxxxxxxxx"</span></span>
<span id="cb2-7"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">  </span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">navbar</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">:</span></span>
<span id="cb2-8"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">    </span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">right</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">:</span></span>
<span id="cb2-9"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">      </span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">-</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> about.qmd</span></span>
<span id="cb2-10"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">    </span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">tools</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">:</span></span>
<span id="cb2-11"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">      </span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">-</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> </span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">icon</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">:</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> twitter-x</span></span>
<span id="cb2-12"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">        </span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">href</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">:</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> https://twitter.com/hogehoge</span></span>
<span id="cb2-13"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">        </span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">text</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">:</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> Twitter</span></span>
<span id="cb2-14"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">      </span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">-</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> </span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">icon</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">:</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> github</span></span>
<span id="cb2-15"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">        </span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">href</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">:</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> https://github.com/hogehoge</span></span>
<span id="cb2-16"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">        </span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">text</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">:</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> GitHub</span></span></code></pre></div></div>
<p><code>icon</code>、<code>href</code>、<code>text</code>の3つがあります。Xは<code>twitter-x</code>となっていることに注意してください。Twitterアイコンがよければシンプルに<code>twitter</code>で表示できます。</p>
<p>これで保存しページをレンダリングすると、アイコンが表示されていると思います。</p>
</section>
<section id="ページ内で表示" class="level3">
<h3 class="anchored" data-anchor-id="ページ内で表示">ページ内で表示</h3>
<p>僕の<a href="../../about.html">Aboutページ</a>にあるように、プロフィールとセットで表示したい場合は、次のように設定します。</p>
<p>表示したいページの<code>.qmd</code>ファイルで、YAMLヘッダーを以下のように変更します。</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb3" style="background: #f1f3f5;"><pre class="sourceCode yaml code-with-copy"><code class="sourceCode yaml"><span id="cb3-1"><span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">---</span></span>
<span id="cb3-2"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">title</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">:</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> Hogehoge</span></span>
<span id="cb3-3"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">about</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">:</span></span>
<span id="cb3-4"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">  </span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">template</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">:</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> trestles</span></span>
<span id="cb3-5"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">  </span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">links</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">:</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> </span></span>
<span id="cb3-6"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">    </span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">-</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> </span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">icon</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">:</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> twitter-x</span></span>
<span id="cb3-7"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">      </span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">text</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">:</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> X (Twitter)</span></span>
<span id="cb3-8"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">      </span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">url</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">:</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> https://x.com/5uke_y</span></span>
<span id="cb3-9"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">    </span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">-</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> </span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">text</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">:</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> </span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">" Bluesky"</span></span>
<span id="cb3-10"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">      </span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">url</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">:</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> https://bsky.app/profile/5uke.bsky.social</span></span>
<span id="cb3-11"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">    </span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">-</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> </span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">icon</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">:</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> github</span></span>
<span id="cb3-12"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">      </span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">text</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">:</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> GitHub</span></span>
<span id="cb3-13"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">      </span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">url</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">:</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> https://github.com/hogehoge</span></span>
<span id="cb3-14"><span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">---</span></span></code></pre></div></div>
<p><code>about</code>の<code>template</code>は<code>trestles</code>以外にもいろいろあります。<a href="https://quarto.org/docs/websites/website-blog.html#about-page">こちら</a>を参照して下さい。</p>
<p>肝心なのは<code>links</code>です。書き方はナビゲーションバーと同じです。<code>about</code>下に書くことで、以下のように表示できます。</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://yo5uke.com/pages/tips/250205_website_tools/image/about.png" class="img-fluid figure-img" style="width:80.0%"></p>
<figcaption>名前の下に3つのアカウントが表示されています</figcaption>
</figure>
</div>
<p>ちなみにBlueskyの部分の書き方が少々ややこしいですが、これはまだBlueskyのアイコンが提供されていないため、Iconifyのアイコンを使って代用しています。アイコンの挿入については<a href="../241201_icon/index.html">こちら</a>を参照してください。</p>
<p>以上がSNSアイコンの説明になります。概ねこの2か所に表示することが多いかと思いますので、ご参考になれば幸いです。</p>
</section>
</section>
<section id="フッターの設定" class="level2">
<h2 class="anchored" data-anchor-id="フッターの設定">フッターの設定</h2>
<p>大体のウェブページにはフッターが付いていますよね。「©2025 Hogehoge」みたいなものです。</p>
<p>これもナビゲーションバーと同様に左、真ん中、右でそれぞれ設定できます。</p>
<p>再び<code>_quarto.yml</code>を開いて、以下のように設定します。</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb4" style="background: #f1f3f5;"><pre class="sourceCode yaml code-with-copy"><code class="sourceCode yaml"><span id="cb4-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">project</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">:</span></span>
<span id="cb4-2"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">  </span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">type</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">:</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> website</span></span>
<span id="cb4-3"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">  </span></span>
<span id="cb4-4"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">website</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">:</span></span>
<span id="cb4-5"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">  </span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">title</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">:</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> </span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"ホームページ"</span></span>
<span id="cb4-6"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">  </span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">navbar</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">:</span></span>
<span id="cb4-7"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">    </span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">right</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">:</span></span>
<span id="cb4-8"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">      </span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">-</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> about.qmd</span></span>
<span id="cb4-9"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">  </span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">page-footer</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">:</span></span>
<span id="cb4-10"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">    </span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">background</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">:</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> light</span></span>
<span id="cb4-11"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">    center</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">: </span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">|</span></span>
<span id="cb4-12">      &amp;#169; 2025 Hogehoge</span></code></pre></div></div>
<p><code>background</code>はフッター部分の背景に少し色が付きます。もちろん<code>dark</code>もあります。</p>
<p><code>center</code>部分は<code>left</code>と<code>right</code>もあります。また、<code>|</code>で改行することで次の行に書くことができます。<code>center: "&amp;#169; 2025 Hogehoge"</code>みたいに1行で書くこともできるのですが、ダブルクォーテーションを忘れないで下さい。</p>
<p><code>&amp;#169;</code>はHTMLエンティティといって、これを出力すると「©」となります。別に直接「©」を入れても大丈夫です。</p>
<p>ちなみにフッター内で改行したい場合は、HTMLと同じで<code>&lt;br&gt;</code>を入れれば可能です。<code>&amp;#169; 2025 Hogehoge &lt;br&gt; This website is created with Quarto</code>のように書けます。</p>
</section>
<section id="おわりに" class="level2">
<h2 class="anchored" data-anchor-id="おわりに">おわりに</h2>
<p>今回はGoogleアナリティクス、SNSアカウント、フッターについての設定をご紹介しました。</p>
<p>これらは<a href="https://quarto.org/docs/guide/">Quarto公式ガイド</a>を読んだり、人の<code>_quarto.yml</code>を真似するのがおすすめです。</p>
<p>最後に僕がこれまで参考にした方々のコードと、僭越ながら自分のコードのリンクも並べておきます。</p>
<div class="callout callout-style-simple callout-tip no-icon">
<div class="callout-body d-flex">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-body-container">
<p><a href="https://github.com/simonpcouch/website/blob/main/_quarto.yml">Simon P. Couch</a>氏（Posit）</p>
</div>
</div>
</div>
<div class="callout callout-style-simple callout-tip no-icon">
<div class="callout-body d-flex">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-body-container">
<p><a href="https://github.com/gadenbuie/garrickadenbuie-com/blob/main/_quarto.yml">Garrick Aden-Buie</a>氏（Posit）</p>
</div>
</div>
</div>
<div class="callout callout-style-simple callout-tip no-icon">
<div class="callout-body d-flex">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-body-container">
<p><a href="https://github.com/kazuyanagimoto/kazuyanagimoto.github.io/blob/main/_quarto.yml">柳本和春</a>さん（CEMFI）</p>
</div>
</div>
</div>
<div class="callout callout-style-simple callout-tip no-icon">
<div class="callout-body d-flex">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-body-container">
<p><a href="https://github.com/yo5uke/yo5uke.github.io/blob/main/_quarto.yml">阿部洋輔</a></p>
</div>
</div>
</div>


<!-- -->

</section>


<div id="quarto-appendix" class="default"><section id="footnotes" class="footnotes footnotes-end-of-document"><h2 class="anchored quarto-appendix-heading">注</h2>

<ol>
<li id="fn1"><p><code>quarto publish gh-pages</code>など。詳しくは「<a href="../241213_create_website/index.html">【Quarto &amp; RStudio】ウェブサイトを作る！</a>」を参照してください。↩︎</p></li>
</ol>
</section></div> ]]></description>
  <category>Quarto</category>
  <guid>https://yo5uke.com/pages/tips/250205_website_tools/</guid>
  <pubDate>Tue, 04 Feb 2025 15:00:00 GMT</pubDate>
</item>
<item>
  <title>pinsでデータ管理</title>
  <link>https://yo5uke.com/pages/tips/241224_pins/</link>
  <description><![CDATA[ 

<div class="social-share-buttons">

  <!-- Twitter (X) -->

  <a href="" id="js-share-twitter" class="share_button ri--twitter-x-fill" target="_blank" rel="nofollow noopener noreferrer"></a>



  <!-- Bluesky -->

  <a href="" id="js-share-bluesky" class="share_button ri--bluesky-fill" target="_blank" rel="nofollow noopener noreferrer"></a>

</div>



<script>

  const twitterUsername = "@5uke_y";

  const blueskyUsername = "@5uke.bsky.social";



  const share_url = encodeURIComponent(location.href);

  const share_title = document.title;



  // Twitter (X)

  document.getElementById('js-share-twitter').setAttribute(

    "href",

    "https://twitter.com/share?url=" + share_url + "&text=" + share_title + " " + encodeURIComponent(twitterUsername) + " より" +

    "&hashtags=rstats"

  );



  // Bluesky

  document.getElementById('js-share-bluesky').setAttribute(

    "href",

    "https://bsky.app/intent/compose?text=" + share_title + " " + share_url + " " + encodeURIComponent(blueskyUsername) + " より"

  );

</script>






<section id="はじめに" class="level2">
<h2 class="anchored" data-anchor-id="はじめに">はじめに</h2>
<p><code>pins</code>というパッケージをご存じでしょうか。<code>pins</code>は、Rでデータやオブジェクトを簡単に共有・保存・再利用するためのパッケージです。</p>
<p>このパッケージでは、Google Driveなど、様々なツールと連携してデータを管理することができます。</p>
<p>これまでの記事<sup>1</sup>ではDVCを用いた方法を紹介してきましたが、特にGoogle Cloud projectを使用しなければならなくなって以降、正直めんどくさいです。</p>
<p>ここではなるべく簡単にデータを管理、共有できるツールとして<code>pins</code>をご紹介します。</p>
</section>
<section id="設定" class="level2">
<h2 class="anchored" data-anchor-id="設定">設定</h2>
<p>早速設定です。インストールされていない場合、以下のコードでパッケージをインストールしてください。Tidyverseを使っている場合は、<code>googledrive</code>はインストール済みです。</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb1" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># install.packages("pak")</span></span>
<span id="cb1-2">pak<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">pak</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"pins"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"googledrive"</span>))</span></code></pre></div></div>
<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center collapsed" data-bs-toggle="collapse" data-bs-target=".callout-1-contents" aria-controls="callout-1" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Tip
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-1" class="callout-1-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<p>余談ですが、最近はパッケージのインストールに<code>pak::pak()</code>をメインで使用しています。<code>pak::pak()</code>は</p>
<blockquote class="blockquote">
<p>A Fresh Approach to R Package Installation</p>
</blockquote>
<p>であり、<code>install.packages()</code>と<code>devtools::install_github()</code>を兼ね合わせています<sup>2</sup>。<del>ミーハーな僕としては使わずにはいられません。</del></p>
</div>
</div>
</div>
<p>続いて以下のコードでドライブと連携します。ブラウザ上でデータを保存したいフォルダを作成し、URLをコピーしておいてください。その後、以下のコードのリンク部分を置き換えて実行します。</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb2" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1">board <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">board_gdrive</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"https://drive.google.com/drive/u/0/folders/1F3T0SUmdKBrYUvo180KqBf00yoRrzPdP"</span>)</span></code></pre></div></div>
</div>
<p>このコマンドを実行すると、</p>
<pre><code>Is it OK to cache OAuth access credentials in the folder ~/.cache/gargle between R sessions?
1: Yes
2: No</code></pre>
<p>と出てくると思いますが、基本的に1を打って実行でいいと思います。これでセッションが切れても（RStudioを再起動しても）認証が継続されます。共用のPCなどの場合は2になると思いますが。</p>
<p>続けてブラウザでGoogleに認証を求められると思いますが、必要な権限を与え（チェックボックスにチェックを入れ）、次へと進んでいきます。</p>
<p>最後に以下の画面が出てきたら、下部のコードをコピーし、RStudioのコンソールに打ち込み、実行します。</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://yo5uke.com/pages/tips/241224_pins/image/gdrive_auth.png" class="img-fluid quarto-figure quarto-figure-center figure-img" style="width:60.0%"></p>
</figure>
</div>
<p>これで認証は完了です。</p>
</section>
<section id="データの管理" class="level2">
<h2 class="anchored" data-anchor-id="データの管理">データの管理</h2>
<section id="ピン留め" class="level3">
<h3 class="anchored" data-anchor-id="ピン留め">ピン留め</h3>
<p><code>pins</code>では、パッケージ名通りデータをピン留めすることができます。例えばデフォルトで入っている<code>mtcars</code>データを例に、データをフォルダにピン留めします。</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb4" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1">board <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb4-2">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">pin_write</span>(mtcars, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"mtcars"</span>)</span></code></pre></div></div>
<div class="cell-output cell-output-stderr">
<pre><code>Guessing `type = 'rds'`
Creating new version '20241223T131135Z-418c9'
Writing to pin 'mtcars'</code></pre>
</div>
</div>
<p>メッセージに出ている通り、デフォルトでは<code>.rds</code>ファイルとして保存されるようです。試しに<code>head()</code>で行数を絞って、csvで保存してみます。その場合、</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb6" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1">board <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">pin_write</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">head</span>(mtcars), <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"mtcars"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">type =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"csv"</span>)</span></code></pre></div></div>
<div class="cell-output cell-output-stderr">
<pre><code>Creating new version '20241223T131142Z-6a6e3'
Writing to pin 'mtcars'</code></pre>
</div>
</div>
<p>と、<code>type</code>を指定してください。</p>
</section>
<section id="読み込み" class="level3">
<h3 class="anchored" data-anchor-id="読み込み">読み込み</h3>
<p>保存したデータを読み込みたい場合は、</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb8" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb8-1">board <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">pin_read</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"mtcars"</span>)</span></code></pre></div></div>
<div class="cell-output cell-output-stdout">
<pre><code>   mpg cyl disp  hp drat    wt  qsec vs am gear carb
1 21.0   6  160 110 3.90 2.620 16.46  0  1    4    4
2 21.0   6  160 110 3.90 2.875 17.02  0  1    4    4
3 22.8   4  108  93 3.85 2.320 18.61  1  1    4    1
4 21.4   6  258 110 3.08 3.215 19.44  1  0    3    1
5 18.7   8  360 175 3.15 3.440 17.02  0  0    3    2
6 18.1   6  225 105 2.76 3.460 20.22  1  0    3    1</code></pre>
</div>
</div>
<p>で可能です。</p>
</section>
<section id="バージョン管理" class="level3">
<h3 class="anchored" data-anchor-id="バージョン管理">バージョン管理</h3>
<p>ちなみに、バージョン管理も可能です。まずは<code>pin_versions()</code>でバージョンを確認します。</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb10" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb10-1">board <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">pin_versions</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"mtcars"</span>)</span></code></pre></div></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 2 × 3
  version                created             hash 
  &lt;chr&gt;                  &lt;dttm&gt;              &lt;chr&gt;
1 20241223T131135Z-418c9 2024-12-23 22:11:35 418c9
2 20241223T131142Z-6a6e3 2024-12-23 22:11:42 6a6e3</code></pre>
</div>
</div>
<p>上は<code>mtcars</code>の全データ、下は<code>head()</code>を適用したデータです。</p>
<p>現在は下のデータで上書きされている状態ですが、ここでやはり全データを読み込みたいとします。</p>
<p>その場合、以下のようにして読み込みます。</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb12" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb12-1">board <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb12-2">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">pin_read</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"mtcars"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">version =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"20241223T131135Z-418c9"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb12-3">  tibble<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">as_tibble</span>()</span></code></pre></div></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 32 × 11
     mpg   cyl  disp    hp  drat    wt  qsec    vs    am  gear  carb
   &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;
 1  21       6  160    110  3.9   2.62  16.5     0     1     4     4
 2  21       6  160    110  3.9   2.88  17.0     0     1     4     4
 3  22.8     4  108     93  3.85  2.32  18.6     1     1     4     1
 4  21.4     6  258    110  3.08  3.22  19.4     1     0     3     1
 5  18.7     8  360    175  3.15  3.44  17.0     0     0     3     2
 6  18.1     6  225    105  2.76  3.46  20.2     1     0     3     1
 7  14.3     8  360    245  3.21  3.57  15.8     0     0     3     4
 8  24.4     4  147.    62  3.69  3.19  20       1     0     4     2
 9  22.8     4  141.    95  3.92  3.15  22.9     1     0     4     2
10  19.2     6  168.   123  3.92  3.44  18.3     1     0     4     4
# ℹ 22 more rows</code></pre>
</div>
</div>
<p><code>version</code>引数に、上で出てきたバージョンをペーストしてやれば可能です。</p>
</section>
</section>
<section id="まとめ" class="level2">
<h2 class="anchored" data-anchor-id="まとめ">まとめ</h2>
<p>今回は<code>pins</code>パッケージを使ったデータ管理の方法についてご紹介しました。</p>
<p>Google Driveは多くの人がアカウントを所持しているため、アカウント設定に時間を割かなくてよい点が魅力的だと思います。</p>
<p>僕が思う良い点としては、直接Google Driveにデータが保存されるため、PCの容量を食わなくていいことがあると思います。</p>
<p>ぜひ使ってみてください。</p>
</section>
<section id="番外編" class="level2">
<h2 class="anchored" data-anchor-id="番外編">番外編</h2>
<p>ちなみに今回はGoogle Driveでご紹介しましたが、Dropbox等でも可能です。</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb14" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb14-1">board <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">board_folder</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"~/Dropbox"</span>)</span></code></pre></div></div>
<p>Dropboxのパスは環境によって異なると思いますが、Dropboxでの共有設定をしておき、各自そのフォルダへのパスを設定しておけば、Dropboxでも<code>pins</code>を使うことができます。</p>
<p>Dropboxユーザーの方は是非お試しあれ。</p>


<!-- -->

</section>


<div id="quarto-appendix" class="default"><section id="footnotes" class="footnotes footnotes-end-of-document"><h2 class="anchored quarto-appendix-heading">注</h2>

<ol>
<li id="fn1"><p>例えば<a href="../241219_container/index.html">こちら</a>など。↩︎</p></li>
<li id="fn2"><p><a href="https://pak.r-lib.org/">pakドキュメント</a>↩︎</p></li>
</ol>
</section></div> ]]></description>
  <category>R</category>
  <guid>https://yo5uke.com/pages/tips/241224_pins/</guid>
  <pubDate>Mon, 23 Dec 2024 15:00:00 GMT</pubDate>
</item>
<item>
  <title>【改訂版】開発コンテナを使ってR環境を構築！</title>
  <link>https://yo5uke.com/pages/tips/241219_container/</link>
  <description><![CDATA[ 

<div class="social-share-buttons">

  <!-- Twitter (X) -->

  <a href="" id="js-share-twitter" class="share_button ri--twitter-x-fill" target="_blank" rel="nofollow noopener noreferrer"></a>



  <!-- Bluesky -->

  <a href="" id="js-share-bluesky" class="share_button ri--bluesky-fill" target="_blank" rel="nofollow noopener noreferrer"></a>

</div>



<script>

  const twitterUsername = "@5uke_y";

  const blueskyUsername = "@5uke.bsky.social";



  const share_url = encodeURIComponent(location.href);

  const share_title = document.title;



  // Twitter (X)

  document.getElementById('js-share-twitter').setAttribute(

    "href",

    "https://twitter.com/share?url=" + share_url + "&text=" + share_title + " " + encodeURIComponent(twitterUsername) + " より" +

    "&hashtags=rstats"

  );



  // Bluesky

  document.getElementById('js-share-bluesky').setAttribute(

    "href",

    "https://bsky.app/intent/compose?text=" + share_title + " " + share_url + " " + encodeURIComponent(blueskyUsername) + " より"

  );

</script>






<section id="はじめに" class="level2">
<h2 class="anchored" data-anchor-id="はじめに">はじめに</h2>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
<span class="screen-reader-only">Note</span>DVCの設定について
</div>
</div>
<div class="callout-body-container callout-body">
<p><a href="../../../pages/tips/250601_dvc/index.html">こちらの記事</a>でより簡便なDVCの設定について解説しました。このページを書き直す時間がないためまだ修正できていませんが、もしDVCを採用するということであれば、ぜひ参考にしてみてください。</p>
</div>
</div>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
<span class="screen-reader-only">Note</span>本記事について
</div>
</div>
<div class="callout-body-container callout-body">
<p>本記事は以前投稿した同タイトルの記事をアップデートしたものです。</p>
<p>変更点としては、</p>
<ol type="1">
<li>Dockerfileの見直し</li>
<li>Rのアップデートとそれに伴うPython仮想環境の追加</li>
<li>全体的にコードを整理</li>
</ol>
<p>です。</p>
<p>記事の構成もブラッシュアップしました。</p>
</div>
</div>
<p>DockerとVSCodeを使ってRの環境を構築する方法を説明します。</p>
<p>開発コンテナを使うメリットは、環境を簡単に共有でき、他の環境に影響を受けずに作業ができることです。</p>
<p>あまり環境構築に詳しくなくても実装できるよう意識して書いていますので、最後まで自分のPCでも実装してみてください。</p>
</section>
<section id="sec-pre" class="level2">
<h2 class="anchored" data-anchor-id="sec-pre">事前準備</h2>
<p>まず、WSL2, Ubuntu, Homebrew, VSCode, Docker, Git, そしてGitHubの準備をします。WindowsとMacでの設定が異なるため、それぞれについて説明します。</p>
<p>全体的に、導入済みの箇所は飛ばしてください。</p>
<section id="sec-wsl2-setting" class="level3">
<h3 class="anchored" data-anchor-id="sec-wsl2-setting">WSL2（Windowsユーザーのみ）</h3>
<ol type="1">
<li>PowerShellまたはWindowsコマンドプロンプトを管理者権限で開く
<ul>
<li>右クリックで管理者権限を使えます。</li>
</ul></li>
</ol>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://yo5uke.com/pages/tips/241219_container/image/powershell.png" class="img-fluid quarto-figure quarto-figure-center figure-img" style="width:70.0%"></p>
</figure>
</div>
<ol start="2" type="1">
<li>以下のコマンドを入力して実行
<ul>
<li>これでインストールはできるはずですが、詳しくは<a href="https://learn.microsoft.com/ja-jp/windows/wsl/install">こちらのサイト</a>を参照してください。</li>
</ul></li>
</ol>
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>PowerShell</strong></pre>
</div>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb1" data-filename="PowerShell" style="background: #f1f3f5;"><pre class="sourceCode sh code-with-copy"><code class="sourceCode bash"><span id="cb1-1"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">wsl</span> <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">--install</span></span></code></pre></div></div>
</div>
<ol start="3" type="1">
<li>ユーザー名とパスワードを設定
<ul>
<li>インストールが終わると、Linuxディストリビューションのユーザー名とパスワードの作成を求められます<sup>1</sup>。</li>
<li>ユーザー名は何でも大丈夫です。パスワードもめちゃくちゃ簡単で問題ありません。</li>
<li>パスワードは<strong>画面上には表示されませんが、ちゃんと入力されています</strong>。慌てて何回も入力しないようにしてください。</li>
</ul></li>
</ol>
<p>エクスプローラーからLinuxに入り<sup>2</sup>、Ubuntu→home→[ユーザー名]と入ったところがメインとなるディレクトリです。</p>
</section>
<section id="homebrewmacユーザーのみ" class="level3">
<h3 class="anchored" data-anchor-id="homebrewmacユーザーのみ">Homebrew（Macユーザーのみ）</h3>
<p>MacユーザーはHomebrewを使って諸々インストールしていくので、まだの方はここでインストールしてください。</p>
<ol type="1">
<li>ターミナルを開く
<ul>
<li>アプリ一覧から「ターミナル」を探してください。</li>
</ul></li>
<li>以下のコマンドを入力して実行
<ul>
<li>パスワードを求められるので、入力してください。</li>
</ul></li>
</ol>
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>Terminal</strong></pre>
</div>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb2" data-filename="Terminal" style="background: #f1f3f5;"><pre class="sourceCode sh code-with-copy"><code class="sourceCode bash"><span id="cb2-1"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">/bin/bash</span> <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">-c</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">$(</span><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">curl</span> <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">-fsSL</span> https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">)</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span></span></code></pre></div></div>
</div>
</section>
<section id="sec-vscode-setting" class="level3">
<h3 class="anchored" data-anchor-id="sec-vscode-setting">VSCode</h3>
<ol type="1">
<li>VSCodeの<a href="https://code.visualstudio.com/">ダウンロードサイト</a>からダウンロード、インストール
<ul>
<li>Download for Windows<sup>3</sup>をクリックしてダウンロードできます。</li>
<li>インストールができたら、VSCodeを開いてください。</li>
</ul></li>
<li>（任意）日本語の拡張機能をインストール
<ul>
<li>画面左側に拡張機能のアイコン<iconify-icon inline="" icon="gg:extension" aria-label="Icon extension from gg Iconify.design set." title="Icon extension from gg Iconify.design set."></iconify-icon>があります。ここの検索ボックスに<code>MS-CEINTL.vscode-language-pack-ja</code>と入力し、1番上に出てきたものをインストールします<sup>4</sup>。</li>
<li>インストール後、VSCodeを再起動すれば日本語が反映されていると思います。</li>
</ul></li>
</ol>
<p><img src="https://yo5uke.com/pages/tips/241219_container/image/vscode-ja.png" class="img-fluid"></p>
<ol start="3" type="1">
<li>拡張機能のインストール
<ul>
<li>拡張機能の検索ボックスで、次のIDを入力し、インストールします。</li>
<li><code>ms-vscode-remote.remote-containers</code> (Dev Containers)</li>
<li><code>ms-vscode-remote.remote-wsl</code> (WSL, Windowsユーザーのみ)<br>
</li>
</ul></li>
<li>WSLに接続（Windowsユーザーのみ）
<ul>
<li>VSCodeから先ほどインストールしたWSLに接続します。</li>
<li>画面左下の青い<iconify-icon inline="" icon="gg:remote" aria-label="Icon remote from gg Iconify.design set." title="Icon remote from gg Iconify.design set."></iconify-icon>をクリックして、「WSLへの接続」をクリックします。</li>
</ul></li>
</ol>
<p><img src="https://yo5uke.com/pages/tips/241219_container/image/vscode-wsl.png" class="img-fluid"></p>
</section>
<section id="docker" class="level3">
<h3 class="anchored" data-anchor-id="docker">Docker</h3>
<p>Dockerをインストールします。</p>
<ol type="1">
<li>Windowsの方は<a href="https://docs.docker.com/desktop/install/windows-install/">ここ</a>からDocker Desktop for Windowsを、Macの方は<a href="https://docs.docker.com/desktop/install/mac-install/">こちら</a>からダウンロード＆インストール</li>
<li>設定の確認（Windowsのみ）
<ul>
<li>インストール出来たら、画面上部の設定ボタンからResources、WSL integrationと進み、チェックボックスにチェック、Ubuntuがオンになっていることを確認してください。</li>
<li>たまに、何もしていないのにここがオフになっていて、トラブることがあります。</li>
<li>詳しくは<a href="https://docs.docker.jp/docker-for-windows/install.html">こちら</a>をご覧ください。日本語で書いてあります。</li>
</ul></li>
</ol>
<p><img src="https://yo5uke.com/pages/tips/241219_container/image/docker-desktop.png" class="img-fluid"></p>
<ol start="3" type="1">
<li>画面左側のVolumesに進み、Createからボリュームを作成
<ul>
<li>次の4つを作成します（大文字小文字に注意！）。</li>
<li><code>TinyTeX</code>, <code>cache</code>, <code>fonts</code>, <code>venv</code></li>
</ul></li>
</ol>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://yo5uke.com/pages/tips/241219_container/image/create_volume_mac.png" class="img-fluid figure-img"></p>
<figcaption>Macでの画面</figcaption>
</figure>
</div>
</section>
<section id="git" class="level3">
<h3 class="anchored" data-anchor-id="git">Git</h3>
<section id="windows" class="level4">
<h4 class="anchored" data-anchor-id="windows">Windows</h4>
<ol type="1">
<li>UbuntuでGitをインストール
<ul>
<li>Windowsのアプリ一覧からUbuntuを探し、開いてください。開いたら、以下のコマンドを入力して実行します。</li>
<li><code>sudo</code>を使うとパスワードを求められますが、最初に設定したものです。</li>
</ul></li>
</ol>
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>Ubuntu</strong></pre>
</div>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb3" data-filename="Ubuntu" style="background: #f1f3f5;"><pre class="sourceCode sh code-with-copy"><code class="sourceCode bash"><span id="cb3-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sudo</span> apt-get install git</span></code></pre></div></div>
</div>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://yo5uke.com/pages/tips/241219_container/image/ubuntu-git.png" class="img-fluid figure-img" style="width:70.0%"></p>
<figcaption>Ubuntu</figcaption>
</figure>
</div>
<ol start="2" type="1">
<li>設定
<ul>
<li>以下のコマンドを入力、実行します。ユーザー名は何でも大丈夫です。</li>
<li>ここに限らずですが、特に注意がない限り<code>[]</code>ごと置き換えてください。</li>
</ul></li>
</ol>
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>Ubuntu</strong></pre>
</div>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb4" data-filename="Ubuntu" style="background: #f1f3f5;"><pre class="sourceCode sh code-with-copy"><code class="sourceCode bash"><span id="cb4-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">git</span> config <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">--global</span> user.name <span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">[</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">任意のユーザ名</span><span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">]</span></span>
<span id="cb4-2"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">git</span> config <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">--global</span> user.email <span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">[</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">任意のメールアドレス</span><span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">]</span></span></code></pre></div></div>
</div>
</section>
<section id="mac" class="level4">
<h4 class="anchored" data-anchor-id="mac">Mac</h4>
<ol type="1">
<li>HomebrewでGitをインストール
<ul>
<li>ターミナルを開いて、以下のコマンドを入力して実行します。</li>
</ul></li>
</ol>
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>Terminal</strong></pre>
</div>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb5" data-filename="Terminal" style="background: #f1f3f5;"><pre class="sourceCode sh code-with-copy"><code class="sourceCode bash"><span id="cb5-1"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">brew</span> install git</span></code></pre></div></div>
</div>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://yo5uke.com/pages/tips/241219_container/image/homebrew.png" class="img-fluid figure-img" style="width:70.0%"></p>
<figcaption>このMacでは2回目なのでgit is already installedと表示されてます…。</figcaption>
</figure>
</div>
<ol start="2" type="1">
<li>設定
<ul>
<li>以下のコマンドを入力、実行します。ユーザー名は何でも大丈夫です。</li>
</ul></li>
</ol>
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>Terminal</strong></pre>
</div>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb6" data-filename="Terminal" style="background: #f1f3f5;"><pre class="sourceCode sh code-with-copy"><code class="sourceCode bash"><span id="cb6-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">git</span> config <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">--global</span> user.name <span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">[</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">任意のユーザ名</span><span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">]</span></span>
<span id="cb6-2"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">git</span> config <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">--global</span> user.email <span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">[</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">任意のメールアドレス</span><span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">]</span></span></code></pre></div></div>
</div>
</section>
</section>
<section id="githubアカウントの作成" class="level3">
<h3 class="anchored" data-anchor-id="githubアカウントの作成">GitHubアカウントの作成</h3>
<p>ファイルは基本的にGitHubで管理するので、<a href="https://github.com/">ここ</a>からアカウントを作成してください。</p>
<p><strong>ポイント：</strong></p>
<p>GitHubアカウントを作成したら、VSCodeにログインしておきましょう。</p>
<ol type="1">
<li>VSCodeを開く</li>
<li>画面左下のアイコンをクリック
<ul>
<li>GitHubでサインインを行う</li>
</ul></li>
</ol>
<p>GitHubにログインすることで、その後の作業がスムーズに進みます。</p>
<p>事前準備は以上です！</p>
</section>
</section>
<section id="開発環境の構築" class="level2">
<h2 class="anchored" data-anchor-id="開発環境の構築">開発環境の構築</h2>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
<span class="screen-reader-only">Note</span>RStudioで出てくる警告について
</div>
</div>
<div class="callout-body-container callout-body">
<p>RStudioでこの後作業することになりますが、コマンドを打つと以下の警告が出てくるかもしれません。</p>
<p><code>警告メッセージ: Character set is not UTF-8; please change your locale</code></p>
<p>しかし、警告は出るものの、実際の作業には特に問題ありません。これに対処しようと試みましたが、できませんでした…。</p>
<p>もし詳しくて対処できた方は、コメントから教えていただけると幸いです。</p>
</div>
</div>
<p>まずは基本設定<sup>5</sup>から説明します。</p>
<section id="基本設定" class="level3">
<h3 class="anchored" data-anchor-id="基本設定">基本設定</h3>
<section id="githubリポジトリを作成" class="level4">
<h4 class="anchored" data-anchor-id="githubリポジトリを作成">GitHubリポジトリを作成</h4>
<ol type="1">
<li>テンプレートの<a href="https://github.com/yo5uke/R-template">GitHub リポジトリ</a>にアクセス</li>
<li>画面右の「Use this template」から「Create a new repository」を選択</li>
<li>Repository nameを記入</li>
<li>Privateを選択
<ul>
<li>通常の研究プロジェクトならPrivateでOK</li>
</ul></li>
<li>「Create repository」をクリック</li>
</ol>
</section>
<section id="sec-host-vscode" class="level4">
<h4 class="anchored" data-anchor-id="sec-host-vscode">リポジトリをクローン</h4>
<ol type="1">
<li>VSCodeを開く</li>
<li>画面左側の<i class="fa-solid fa-code-branch" aria-label="code-branch"></i>を開く</li>
<li>「リポジトリの複製」を選択し、さらに「GitHubから複製」を選ぶ</li>
<li>リポジトリを選択し、クローン
<ul>
<li>リポジトリは、「ユーザー名/リポジトリ名」の形式で表示されます。</li>
<li>基本的に表示されると思いますが、表示されない場合は手入力してください。</li>
<li>クローンしたリポジトリを開くか問われるので、開いてください。</li>
</ul></li>
<li>画面右下に「コンテナーで再度開く」と出たらクリック
<ul>
<li>出ない場合、画面左下「<iconify-icon inline="" icon="gg:remote" aria-label="Icon remote from gg Iconify.design set." title="Icon remote from gg Iconify.design set."></iconify-icon> WSL: Ubuntu」<sup>6</sup>をクリックし、「コンテナーで再度開く」を選択してください。</li>
<li>初めて環境を構築する場合、ここでかなり時間がかかるので辛抱強く待ちましょう。</li>
</ul></li>
</ol>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://yo5uke.com/pages/tips/241219_container/image/reopen.png" class="img-fluid figure-img"></p>
<figcaption>「コンテナーで再度開く」をクリック</figcaption>
</figure>
</div>
<p>エクスプローラーを開き、<code>\Ubuntu\home\ユーザー名</code>の中を確認してみてください。リポジトリ名と同じフォルダができていると思います。</p>
<p>Macの場合は、ユーザー名の下にできているはずです。</p>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center collapsed" data-bs-toggle="collapse" data-bs-target=".callout-4-contents" aria-controls="callout-4" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
<span class="screen-reader-only">Note</span>Macでファイルが見当たらない？
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-4" class="callout-4-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<p>クローンしたフォルダを見てみると、リポジトリにはあるはずのファイルやフォルダが見当たらないかもしれません。</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://yo5uke.com/pages/tips/241219_container/image/finder_mac_after_clone.png" class="img-fluid figure-img" style="width:70.0%"></p>
<figcaption>ファイルが見当たらない…？</figcaption>
</figure>
</div>
<p>このようなときは、Finderの隠しファイルを表示する設定を変更する必要があります。</p>
<p>以下をターミナルで実行してください。</p>
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>Terminal</strong></pre>
</div>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb7" data-filename="Terminal" style="background: #f1f3f5;"><pre class="sourceCode sh code-with-copy"><code class="sourceCode bash"><span id="cb7-1"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">defaults</span> write com.apple.finder AppleShowAllFiles TRUE</span>
<span id="cb7-2"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">killall</span> Finder</span></code></pre></div></div>
</div>
<p>これで、隠しファイルも表示されるようになります。</p>
<p>正直なところ、この設定は隠しファイルが邪魔であればしなくてもよいと思います<sup>7</sup>。VSCode上ではきちんと表示されますので。</p>
</div>
</div>
</div>
</section>
<section id="rstudioで開く" class="level4">
<h4 class="anchored" data-anchor-id="rstudioで開く">RStudioで開く</h4>
<p>ここで、ブラウザを用いてRStudioを開きます。毎度この手順を踏む前に、VSCode上で開発コンテナに接続していることを確認してください。開いていないと、次のリンクは無効なものになってしまいます。</p>
<ol type="1">
<li>任意のブラウザで、アドレスバーに<code>localhost:8787</code>と入力して開く</li>
<li>右上の <img src="https://yo5uke.com/pages/tips/241219_container/data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAAIsUlEQVR4Xu3XeWyT5x0HcLbuaCemtaq0Tlo1oQ5UrWJtpW4tZe1GIYybkBLYAi2EK5yDhbZchUCBEcIRDAmE3LcJTuLEcew4jhM7cZzEfm2/l4/X5+szvp3Yjh2HBLz3jZMAGbBA9+ce6atXsiL/Pv49v8d5PGvW/9cLLJoi9pO15bx3F+WxUpcXcTfsbUbeolljr8RisR9M/9v/zaLRXvqIUvfuZ7cZaYkVrXdWljQbttZ2mdfWdQweYEv16yo52MoSFjehkHVmVVnbqm9Yil9JY7EfT3+bGa+5N9g/eNN2vsLb9G3rShhlawp46jSGD3qsyIMv4U6dDRTSFFvGUY380HnHVMYrbVEkEK1V53Za9TtZ0oV66u4ijWlnLplRZwjSRXti0/z8Vef2Z1FN/mzFxU2LVhcwNy1rJiVt66yDTjABoCLYr2iVOvVNtqiaJNjBGbYR2A6UbjeHEapxkF0U4fMRTUGUZppCKaZIvAdIlTjEFxNJF/pUZ8TGdG9zRJpcjUPTKxoK19X1f6PFJrg4/Qe6ytTxTfQ+LP/XsPnp3PlvMtyUzcVDyjYnvswx3cfYnmIuEbhJucI3GCNIHWWMELDQ0SCSKVhENnIlbjKdH6k2hBEqvRBhCw+Cag0RqDJlOuH4FzIozgl1PbtYUp6Nt0ViNPypfEtSm3gv3q8HfFlAXh/scZnaHSOoBzfA5AAgCz3fZDpHIXo9gi8p0ji+dtVYeDLnG5/8uXOwF9OtEbmHKCPfXKsJZJCEfovdpj05dogXGkYgioNETIgmbKJFGCDyBWZzXBKoHGkc6HABzT/L6a6kC7Qhmr0A5pc0GLL6FQGL/TqvTmo3VJlDGAN/SNQnTUCfZEj8i84zI5+mM6OLj/DC+2rABx/utUW3F0h7V/4DTvy/kFm9Hy7UVeiGYDKtCGwlMhtpU+ZJbXjGUKd+0SHMpAlsVnylAH1QYE+OKs09vIU4IAAC3f7HgBC3xjQSaTZFkYrNB79DbnJcbFXN5gtx53ZErMls1Nv+MMhVnRXkdiZr3Ijq9k9zjyFG7kFOdGPDrMiK861B65DLuySxGI7L9L7M8W4mwK58WJtGK02PQCqzTGASmRLCxp7JkBAhO8dk/Dc9yRsR0RG1fuwQsRmoUhw785K8dghOhi4Dtu0q5kiVw7qUFLk/cYDtfLwvhrp/WtSi/Mm7DIUa4fgCsMYUGkaA6rH82A8zwfw3JO0OocBln0IYJiDQJ3BK/nwUGM0nQr4c4munOxWjmSLTaEcudWWWtg38MFBZrhQFZCVYEOyMv2w9EkAsgtPBXT/B2BsHMC2hSUMSxCoxwck83fcHd6W02kvUlilf2XwHJcBE5wlNKPzdtCj6y93uUlAmSYsjQPuPS8g3gUSICAB3knA8GOAdec4niM1gOHtgtpg0rUO53t7G8Pv7WWEr/bYkUIs9BTABGImgPEuEMXJLnBJQH8cQJ8A/G57zfDb2+4Mv3a6YnTuLlp0+Vme95LQguajflkxCdBNAEzxLXisCy8CaJkG2JYjsJcpbJJPa1tc8/fTwyQgD/bKZgQg8kSAaBqgczrAPLEFO+MAcgYSGFz7rirANHdHffRQDYSTAHIGSqdtwQwBsXHA5CA+BIwAbHt4/BSMd4AAbCeGsERlBxKa2uyXAQu8/Gybl5yDKyIrEj8FZBeGnzAHMwJMdIEEeB4CmiYAvycBuV32EswJJDAJgNRKngKE7MKKczxvAToQ34ZnDOILAa62aTTHamQ4CVj6LXNgQ77A/dvC2sgWNth/ttei2l0uNc8jEJtzeh37K2FzHhKQP20bngvQRgDIGUjJavfP23F39M2t1NHXN1eNvbGlavTNK3dG0tpVpo1MmWdZbW9o/uGm8JzU2hHyO4ECeBES8KQvpCcCegjA5CCOzwEBYDui8hvKfu1hocqxhSsbIJ62TJkVK9b4oVtqD/wZs8N1QepSZMN+5LzMrdrH11mSmZAvuRn2ftVjMuaqgvCMOxAHxACi5eBtlUt7vFfn3MNH/BkSkzVX7cFqLBGoxjwEVptC8nJjQJ6vG4AWszucmXKPIhsZRB7NGalbvVtgsCY1I/4vuWrXCbFTV6SLyh8CkMcBXwv1gwVqt+6UWO86KFT7/0X8WyaKaJiuUYjhHAXp/SNgnS0qv2uNgFRrRF5hisgLDAPQEjbfeQFyoxQ0CI9HRT5D8DUi40/VEJwB+LA0Pm5LYikGt/P1ju/kHs1JidM2BVhIb/3l3g7Uewm2Wal4SMsjbkGtRDjkbSh+IQEb+kfBcrUXpfQZsBOMPvwUW6Y/36XGPq3neC5AxOtE4fO9/ar9dRL8CEejO8bVaSlEcYoqMpVrqgjyrdSr3c7HHYksReAtmiF+IfmkWvja6gZRTwZgEjLsUZjne/AYoJkANBKps4/IyWR1YRhFZlEV4QFwCbvTmQl6FBkCo+ZrFqq/JCMxZOFHM4mIwqeIbhBbgi6li5BZp2M/nNqCFB76xqoGUdqSOoFkZwfcfRvzEMVHkTjg/mOAXKI4RWpSXYds6J8Zbe6vOEpdBt+IXYF9CEUVmlZ8CM5WhJGjYodmAxtUJjJ7apObJZ/nS2M/myr+6Dodi/0omQksWtkgoiQ19cpOSgyyanNYQQLqHXFACeZFyGtXCdGBBKIDF2Afmo34kYvEaSAzWTgTCigOCnF9YpMY+7yp71oqG14w498K5B1+T7vm14mNPbuX0TvBXR0QRFE61TXmCFiNh0ByCB8FkANIIq4Sx/E7GXkCMMPaRpFmI1t85FgvPocWi700vcaMVykee/mLFnBREqMnd31zr+p4n0GdrxtEpgDEEJJH76TYpk3lQXhKC9CR0iLdmqsOvk58kIf7/H0X+SmOCu2/IfZw30ZWX2dqm1z7cRPX90+hzpTCBkxbuVLqzlZ0KQOL/fyZv4K+7yLfnOaOzd7EkSe8Q226u6ZRdPR4l/kdZv9TBuu/rH8DYKkbNvCO3j8AAAAASUVORK5CYII=" class="img-fluid"> をクリックし、「New Project…」を選択</li>
<li>「Existing Directory」を選択</li>
<li>「Browse…」より「work」を選択して「Choose」をクリック
<ul>
<li>「Create project」をクリックするとプロジェクトが作成されます。</li>
</ul></li>
<li>コンソールに以下を入力して実行
<ul>
<li><code>renv</code>はパッケージを管理するためのパッケージです。</li>
<li>Dockerfileでインストールすることを指示しているので、コンソールでインストールせずとも既に使用可能です<sup>8</sup>。</li>
</ul></li>
</ol>
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>R</strong></pre>
</div>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb8" data-filename="R" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb8-1">renv<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">init</span>()</span></code></pre></div></div>
</div>
</section>
<section id="pythonの設定任意" class="level4">
<h4 class="anchored" data-anchor-id="pythonの設定任意">Pythonの設定（任意）</h4>
<p>Pythonを使う場合、以下のパッケージをインストールしておきます。</p>
<p>使わない場合はスキップしてください。</p>
<p>使い方としては、Quarto上でPythonのコードを書く or <code>.ipynb</code>で書くことを想定しています。そのために必要なパッケージですが、その他のパッケージを使用する場合も同様の方法でインストールしてください。</p>
<ol type="1">
<li>VSCodeに戻る</li>
<li>画面上部「ターミナル」より「新しいターミナル」を選択</li>
<li>以下のコマンドを入力して実行</li>
</ol>
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>Terminal</strong></pre>
</div>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb9" data-filename="Terminal" style="background: #f1f3f5;"><pre class="sourceCode sh code-with-copy"><code class="sourceCode bash"><span id="cb9-1"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">pip</span> install ipykernel jupyter</span></code></pre></div></div>
</div>
<p>パッケージはcacheにキャッシュがあるので、1回インストールすれば、2回目以降の環境構築では不要です。</p>
</section>
<section id="sec-dvc-setting" class="level4">
<h4 class="anchored" data-anchor-id="sec-dvc-setting">DVCの設定</h4>
<p>DVCはデータを管理するためのツールです。</p>
<p>事前準備として、自分のGoogleドライブの任意の場所で、データを入れる用のフォルダを作成しておいてください。</p>
<p>また、共同プロジェクトの場合は、フォルダの共有も設定してください。</p>
<ol type="1">
<li>VSCodeに戻る</li>
<li>画面上部「ターミナル」より「新しいターミナル」を選択
<ul>
<li>既に画面下部にターミナルが表示されている場合はスキップしてください。</li>
</ul></li>
<li>以下のコマンドを入力して実行
<ul>
<li>初めて環境構築するときに1回実行しておけば、2回目以降の環境構築では不要です。</li>
</ul></li>
</ol>
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>Terminal</strong></pre>
</div>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb10" data-filename="Terminal" style="background: #f1f3f5;"><pre class="sourceCode sh code-with-copy"><code class="sourceCode bash"><span id="cb10-1"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">pip</span> install dvc dvc-gdrive</span></code></pre></div></div>
</div>
<ol start="4" type="1">
<li>Googleドライブで作成したフォルダのIDをコピー
<ul>
<li>IDは、ドライブでフォルダを開いたときのURLで、最後のスラッシュ（~/folders/）より右側の部分です。</li>
</ul></li>
<li>次のコマンドを入力して実行
<ul>
<li>最後の部分（四角括弧ごと）をコピーしたIDに変更してください。</li>
</ul></li>
</ol>
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>Terminal</strong></pre>
</div>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb11" data-filename="Terminal" style="background: #f1f3f5;"><pre class="sourceCode sh code-with-copy"><code class="sourceCode bash"><span id="cb11-1"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">dvc</span> init <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">&amp;&amp;</span> <span class="ex" style="color: null;
background-color: null;
font-style: inherit;">dvc</span> remote add <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">-d</span> myremote gdrive://[Google DriveのフォルダID]</span></code></pre></div></div>
</div>
</section>
<section id="latexの設定" class="level4">
<h4 class="anchored" data-anchor-id="latexの設定">LaTeXの設定</h4>
<p>R Markdownなどで<img src="https://latex.codecogs.com/png.latex?%5CLaTeX">を使用するために、TinyTeXをインストールします。</p>
<p>RStudioのコンソールに以下のコマンドを入力して実行してください。</p>
<p>また、TinyTeXもキャッシュされるので、1回インストールすれば、2回目以降の環境構築では実行不要です。</p>
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>R</strong></pre>
</div>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb12" data-filename="R" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb12-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">install.packages</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"tinytex"</span>)</span>
<span id="cb12-2">tinytex<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">install_tinytex</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">force =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">TRUE</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">dir =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"/home/rstudio/.TinyTeX"</span>)</span></code></pre></div></div>
</div>
<p>TinyTeXは、<img src="https://latex.codecogs.com/png.latex?%5CLaTeX">コードをコンパイルする際に必要なパッケージを自動でダウンロードしてくれるので、ローカルに面倒な設定をしなくて良いのが魅力です。</p>
<p>R MarkdownやQuartoでのPDF出力の仕方については、<a href="https://yo5uke.github.io/tips/240329_rmarkdown_pdf/">こちらの記事</a>もご覧ください。</p>
<div class="callout callout-style-default callout-warning callout-titled">
<div class="callout-header d-flex align-content-center collapsed" data-bs-toggle="collapse" data-bs-target=".callout-5-contents" aria-controls="callout-5" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
<span class="screen-reader-only">Warning</span>VSCode上でのファイル等の作成
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-5" class="callout-5-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<p>VSCode上でファイルやフォルダを作成するためには、左側のアイコン一番上の「エクスプローラー」をクリックし、その中の上部にあるアイコンの「新しいファイル…」や「新しいファイル…」を選択することでできます。</p>
<p>ここで注意点ですが、状況によっては意図せずフォルダの中に作ってしまうことがあります。</p>
<p>ワーキングディレクトリにファイルを作成したい場合は、まずエクスプローラーの空き部分をクリックします。すると、枠全体が青い線で囲まれると思います。</p>
<p>この状態であれば、ワーキングディレクトリにファイルやフォルダが新規作成されます。下の画像の左側に注目してください。</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://yo5uke.com/pages/tips/241219_container/image/vscode-explorer1.png" class="img-fluid figure-img"></p>
<figcaption>エクスプローラーの空いている部分をクリックすると、全体が青枠で囲まれます。</figcaption>
</figure>
</div>
<p>一方、特定のフォルダの中に作成したい場合は、そのフォルダをクリックしてから新規作成を行ってください。</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://yo5uke.com/pages/tips/241219_container/image/vscode-explorer2.png" class="img-fluid figure-img"></p>
<figcaption>特定のフォルダをクリックすると、そのフォルダが青枠で囲まれます。</figcaption>
</figure>
</div>
</div>
</div>
</div>
</section>
<section id="共同プロジェクトの場合" class="level4">
<h4 class="anchored" data-anchor-id="共同プロジェクトの場合">共同プロジェクトの場合</h4>
<p>共同プロジェクトの場合は、GitHubで共有するため、以下の手順を踏んでおいてください。</p>
<ul>
<li>GitHubリポジトリでコラボレーターを追加
<ul>
<li>リポジトリのSettingsからCollaboratorsに進み、コラボレーターを追加してください。</li>
<li>Add peopleから招待できます。</li>
</ul></li>
</ul>
<p>ホスト側の環境構築はここで一区切りです！</p>
</section>
</section>
<section id="共同作業者の設定" class="level3">
<h3 class="anchored" data-anchor-id="共同作業者の設定">共同作業者の設定</h3>
<p><strong>前提：</strong>事前準備を終わらせている</p>
<ol type="1">
<li>GitHubで招待を受ける
<ul>
<li>メールが届いているはずですので、そこからGitHubにログインしてください。</li>
<li>リポジトリにアクセスできるようになります。</li>
</ul></li>
<li>リポジトリをクローン
<ul>
<li>ホスト側が作成したリポジトリをクローンします。</li>
<li>ホスト側の設定と同様にしてクローンし、開いてください。</li>
</ul></li>
</ol>
<p>一旦ここまでで、共同作業者の設定は終わりです。</p>
</section>
</section>
<section id="研究作業ワークフロー" class="level2">
<h2 class="anchored" data-anchor-id="研究作業ワークフロー">研究作業（ワークフロー）</h2>
<p>研究における作業の流れについて説明します。</p>
<p>GitHub関連<sup>9</sup>については<a href="https://yo5uke.github.io/tips/240525_vscode_github/">こちらの記事</a>で詳しめに解説しましたので、そちらも参考にしてください。</p>
<section id="rのパッケージ" class="level3">
<h3 class="anchored" data-anchor-id="rのパッケージ">Rのパッケージ</h3>
<p>基本的にはブラウザ上のRStudio ServerでローカルのRStudioと同様に作業できます。ここではプロジェクトを管理する観点から説明します。</p>
<p>作業中新たにパッケージを使用した場合、それを<code>renv.lock</code>ファイルに記録することで、必要なパッケージを記録することができます。記録することで環境を移したときに必要なパッケージをすぐインストールできたり、共同研究者と必要なパッケージを（バージョン込みで）共有することができます。</p>
<p>バージョンごと記録できるので、全く同じ環境を再現することが可能です。</p>
<p>新しいパッケージをインストールし、コード内で使用したら、以下のコードを実行し、lockファイルに記録してください<sup>10</sup>。</p>
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>R</strong></pre>
</div>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb13" data-filename="R" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb13-1">renv<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">snapshot</span>()</span></code></pre></div></div>
</div>
<p>異なる環境に移行した場合、ディレクトリに<code>renv.lock</code>ファイルがあれば、以下のコードで記録したパッケージを一括インストールできます。</p>
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>R</strong></pre>
</div>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb14" data-filename="R" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb14-1">renv<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">restore</span>()</span></code></pre></div></div>
</div>
<p>これでRの開発環境を揃えることができます。PCを変えた場合などにも役立ちます。</p>
<p>また、新しいパッケージを使ったら、その作業が終わるごとに<code>renv::snapshot()</code>で記録しましょう。</p>
</section>
<section id="python-のパッケージ" class="level3">
<h3 class="anchored" data-anchor-id="python-のパッケージ">Python のパッケージ</h3>
<p>設定ではPythonの設定も加えていますので、必要に応じてPythonも使用できます。</p>
<p>また、そもそもDVCがPythonのパッケージなので、それも<code>renv</code>と同様に記録できます。Pythonの場合はvenvを用いてパッケージを管理します。</p>
<ol type="1">
<li>Pythonのパッケージを追加
<ul>
<li>先ほどと同様に、新しいターミナルを開いて、以下のコードでパッケージをインストールします。</li>
<li>DVC以外特に使うものがなければ、ここはスキップしてください。</li>
</ul></li>
</ol>
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>Terminal</strong></pre>
</div>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb15" data-filename="Terminal" style="background: #f1f3f5;"><pre class="sourceCode sh code-with-copy"><code class="sourceCode bash"><span id="cb15-1"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">pip</span> install <span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">[</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">パッケージ名</span><span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">]</span></span></code></pre></div></div>
</div>
<ol start="2" type="1">
<li>パッケージを記録
<ul>
<li>Rと同様に、作業が終わったら以下のコードでパッケージを記録します。</li>
<li><code>requirements.txt</code>は<code>renv.lock</code>と同じような役割です。</li>
</ul></li>
</ol>
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>Terminal</strong></pre>
</div>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb16" data-filename="Terminal" style="background: #f1f3f5;"><pre class="sourceCode sh code-with-copy"><code class="sourceCode bash"><span id="cb16-1"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">pip</span> freeze <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span> requirements.txt</span></code></pre></div></div>
</div>
<ol start="3" type="1">
<li>パッケージをインストール（異なる環境に移行した場合）
<ul>
<li>次のコードで、<code>requirements.txt</code>に記録したパッケージをインストールできます。</li>
<li>つまり<code>renv::restore()</code>と同じ役割です。</li>
</ul></li>
</ol>
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>Terminal</strong></pre>
</div>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb17" data-filename="Terminal" style="background: #f1f3f5;"><pre class="sourceCode sh code-with-copy"><code class="sourceCode bash"><span id="cb17-1"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">pip</span> install <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">-r</span> requirements.txt</span></code></pre></div></div>
</div>
</section>
<section id="データの管理" class="level3">
<h3 class="anchored" data-anchor-id="データの管理">データの管理</h3>
<p>データはDVCで管理、Google Drive上で保管します。</p>
<p>DVCでデータを管理するメリットとしては、GitHub上のデータ容量の制限を受けずに管理できることが大きいと思います。GitHubは100MiBを超えるデータをブロックしますので、注意が必要です。</p>
<p>まずは<a href="../240831_google_cloud_project/index.html">この記事</a>を見ていただき、Google Cloudでの設定をしてください。</p>
<ol type="1">
<li>ワーキングディレクトリに、<code>data</code>というフォルダを作成</li>
<li>データが入ったら、以下のコードを実行
<ul>
<li><code>data</code>フォルダごとドライブに追加します。</li>
<li><code>data</code>フォルダは<code>.gitignore</code>に記載されているため、GitHubにはアップロードされません。</li>
</ul></li>
</ol>
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>Terminal</strong></pre>
</div>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb18" data-filename="Terminal" style="background: #f1f3f5;"><pre class="sourceCode sh code-with-copy"><code class="sourceCode bash"><span id="cb18-1"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">dvc</span> add data/</span></code></pre></div></div>
</div>
<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center collapsed" data-bs-toggle="collapse" data-bs-target=".callout-6-contents" aria-controls="callout-6" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
<span class="screen-reader-only">Tip</span>データの入れ方
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-6" class="callout-6-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<p>データは、WindowsのエクスプローラーやMacのFinderから直接フォルダに入れて大丈夫です（通常のWindowsやMacでの作業のように）。</p>
<p>ちなみにWindowsユーザーの方で、一回ローカルに落としてからLinuxにデータやコードを入れたら<code>Zone.Identifier</code>というファイルができることがありますが、これは無視して大丈夫です。邪魔であればまとめて消してください。</p>
</div>
</div>
</div>
<ol start="3" type="1">
<li>以下のコードを実行
<ul>
<li><code>'client-id'</code>と<code>'client-secret'</code>は<a href="../240831_google_cloud_project/index.html">こちら</a>を参考に変更してください。</li>
</ul></li>
</ol>
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>Terminal</strong></pre>
</div>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb19" data-filename="Terminal" style="background: #f1f3f5;"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb19-1"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">dvc</span> remote modify <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">--local</span> myremote gdrive_client_id <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'client-id'</span></span>
<span id="cb19-2"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">dvc</span> remote modify <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">--local</span> myremote gdrive_client_secret <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'client-secret'</span></span>
<span id="cb19-3"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">dvc</span> remote modify <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">--local</span> myremote gdrive_user_credentials_file ~/.cache/myremote-credentials.json</span></code></pre></div></div>
</div>
<ol start="4" type="1">
<li><p>データをアップロード</p>
<ul>
<li>以下のコードでデータをプッシュします。</li>
<li>最初はpushをする過程でアカウントの認証が必要になりますが、表示に従って認証を進めてください。</li>
</ul></li>
</ol>
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>Terminal</strong></pre>
</div>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb20" data-filename="Terminal" style="background: #f1f3f5;"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb20-1"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">dvc</span> push</span></code></pre></div></div>
</div>
<ol start="5" type="1">
<li>データのダウンロード
<ul>
<li>プッシュしたデータをダウンロードしたい場合は、以下を実行します。</li>
</ul></li>
</ol>
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>Terminal</strong></pre>
</div>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb21" data-filename="Terminal" style="background: #f1f3f5;"><pre class="sourceCode sh code-with-copy"><code class="sourceCode bash"><span id="cb21-1"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">dvc</span> pull</span></code></pre></div></div>
</div>
</section>
<section id="juliaのパッケージ" class="level3">
<h3 class="anchored" data-anchor-id="juliaのパッケージ">Juliaのパッケージ</h3>
<p>Julia はパッケージが自動で<code>Project.toml</code>に保存されるため、共同作業者がインストールするだけで大丈夫です。</p>
<ol type="1">
<li>先ほどと同じ手順で環境をアクティベートする</li>
<li>以下のコードでパッケージをインストール</li>
</ol>
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>Julia</strong></pre>
</div>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb22" data-filename="Julia" style="background: #f1f3f5;"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb22-1"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">Pkg</span>.<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">instantiate</span>()</span></code></pre></div></div>
</div>
</section>
<section id="まとめ" class="level3">
<h3 class="anchored" data-anchor-id="まとめ">まとめ</h3>
<p>以上の作業を通じて、再現可能な研究を行うことができます。</p>
<p>環境を揃えるためには、コミット、プッシュ、プルを行い、記録したファイルを共有することが重要です。</p>
<p>以上がワークフローです。お疲れ様でした！</p>
</section>
</section>
<section id="環境構築まとめ" class="level2">
<h2 class="anchored" data-anchor-id="環境構築まとめ">環境構築まとめ</h2>
<p>作業フローは、<del>超適当にまとめると</del>次のようになります。</p>
<section id="ホスト" class="level3">
<h3 class="anchored" data-anchor-id="ホスト">ホスト</h3>
<ol start="0" type="1">
<li>必要なソフト等をインストールし、事前準備を行う。
<ul>
<li>WSL2, Ubuntu, Homebrew, VSCode, Docker, Git, GitHub</li>
</ul></li>
<li>GitHubでリポジトリをインポート、クローン</li>
<li>RStudio Serverでプロジェクトを作成
<ul>
<li><code>renv::init()</code> でrenvを開始</li>
<li><code>renv::snapshot()</code>で適宜パッケージを記録</li>
</ul></li>
<li><code>data</code>フォルダを作成し、DVCで管理
<ul>
<li>データは<code>data</code>内に追加</li>
<li><code>dvc add data/</code>と<code>dvc push</code>を使用</li>
</ul></li>
<li>VSCode上でコミット、プッシュ</li>
</ol>
</section>
<section id="共同作業者" class="level3">
<h3 class="anchored" data-anchor-id="共同作業者">共同作業者</h3>
<ol start="0" type="1">
<li>必要なソフト等をインストールし、事前準備を行う。
<ul>
<li>WSL2, Ubuntu, Homebrew, VSCode, Docker, Git, GitHub</li>
</ul></li>
<li>GitHubでリポジトリをクローン</li>
<li>RStudio Serverでプロジェクトを開く
<ul>
<li><code>renv::restore()</code> でパッケージをインストール</li>
</ul></li>
<li>VSCode上で<code>pip install -r requirements.txt</code>を実行
<ul>
<li>Pythonパッケージをインストール</li>
</ul></li>
<li><code>dvc pull</code>でデータをダウンロード</li>
<li>VSCode上でコミット、プッシュ</li>
</ol>
</section>
</section>
<section id="おわりに" class="level2">
<h2 class="anchored" data-anchor-id="おわりに">おわりに</h2>
<p>今回はDocker &amp; VSCodeを用いた開発環境を説明しました。</p>
<p>個人的な経験として、環境構築はエラーとの戦いです。できるだけエラーに遭遇しないよう丁寧に書いたつもりですが、まだまだ把握していないエラーがたくさんあると思います。</p>
<p>何かエラー等ありましたら、コメントしていただけると幸いです。</p>
</section>
<section id="参考文献" class="level2">
<h2 class="anchored" data-anchor-id="参考文献">参考文献</h2>
<div class="callout callout-style-simple callout-tip no-icon">
<div class="callout-body d-flex">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-body-container">
<p><a href="https://zenn.dev/nicetak/articles/vscode-docker-2023">VSCode + Dockerでよりミニマルでポータブルな研究環境を</a></p>
</div>
</div>
</div>
<div class="callout callout-style-simple callout-tip no-icon">
<div class="callout-body d-flex">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-body-container">
<p><a href="https://qiita.com/tommy_g/items/771ac45b89b02e8a5d64">UbuntuにGitをインストールする</a></p>
</div>
</div>
</div>
<div class="callout callout-style-simple callout-tip no-icon">
<div class="callout-body d-flex">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-body-container">
<p><a href="https://qiita.com/future_kame/items/9fa256aea09faa28b357">githubを使った共同作業の手順</a></p>
</div>
</div>
</div>


<!-- -->

</section>


<div id="quarto-appendix" class="default"><section id="footnotes" class="footnotes footnotes-end-of-document"><h2 class="anchored quarto-appendix-heading">注</h2>

<ol>
<li id="fn1"><p>求められない場合は、続けて<code>wsl</code>とだけ入力して実行してください。↩︎</p></li>
<li id="fn2"><p>左のサイドバーの1番下です。↩︎</p></li>
<li id="fn3"><p>もしくは Mac↩︎</p></li>
<li id="fn4"><p>単にJapaneseでも出てきます。笑↩︎</p></li>
<li id="fn5"><p>単独研究ならここのみでOK、共同研究ならホストが行う設定。↩︎</p></li>
<li id="fn6"><p>Mac なら<iconify-icon inline="" icon="gg:remote" aria-label="Icon remote from gg Iconify.design set." title="Icon remote from gg Iconify.design set."></iconify-icon>↩︎</p></li>
<li id="fn7"><p>TRUE のところを FALSE にして再度実行すれば消せます。↩︎</p></li>
<li id="fn8"><p>余談ですが、<code>renv::init()</code>のように<code>パッケージ名::関数</code>のような書き方をすれば、<code>library(パッケージ名)</code>をせずとも関数を使えます。1度だけ使いたいようなときに便利です。↩︎</p></li>
<li id="fn9"><p>コミット、プッシュやブランチなど↩︎</p></li>
<li id="fn10"><p>インストールしただけでコード内で使用していない場合は記録されません。↩︎</p></li>
</ol>
</section></div> ]]></description>
  <category>R</category>
  <category>Docker</category>
  <category>Windows</category>
  <category>Mac</category>
  <category>Ubuntu</category>
  <category>VSCode</category>
  <category>GitHub</category>
  <guid>https://yo5uke.com/pages/tips/241219_container/</guid>
  <pubDate>Wed, 18 Dec 2024 15:00:00 GMT</pubDate>
  <media:content url="https://yo5uke.com/pages/tips/241219_container/image/Rlogo.png" medium="image" type="image/png" height="112" width="144"/>
</item>
</channel>
</rss>
