<?xml version="1.0" encoding="UTF-8"?>
<rss  xmlns:atom="http://www.w3.org/2005/Atom" 
      xmlns:media="http://search.yahoo.com/mrss/" 
      xmlns:content="http://purl.org/rss/1.0/modules/content/" 
      xmlns:dc="http://purl.org/dc/elements/1.1/" 
      version="2.0">
<channel>
<title>Yosuke Abe</title>
<link>https://yo5uke.com/pages/tips/</link>
<atom:link href="https://yo5uke.com/pages/tips/index.xml" rel="self" type="application/rss+xml"/>
<description></description>
<generator>quarto-1.9.16</generator>
<lastBuildDate>Thu, 08 Jan 2026 15:00:00 GMT</lastBuildDate>
<item>
  <title>uv, marimo, DuckDB, Polarsで始めるPython×データ分析</title>
  <link>https://yo5uke.com/pages/tips/2026/01/marimo/</link>
  <description><![CDATA[ 

<div class="social-share-buttons">
  <!-- Twitter (X) -->
  <a href="" id="js-share-twitter" class="share_button ri--twitter-x-fill" target="_blank" rel="nofollow noopener noreferrer"></a>

  <!-- Bluesky -->
  <a href="" id="js-share-bluesky" class="share_button ri--bluesky-fill" target="_blank" rel="nofollow noopener noreferrer"></a>
</div>

<script>
  const twitterUsername = "@5uke_y";
  const blueskyUsername = "@5uke.bsky.social";

  const share_url = encodeURIComponent(location.href);
  const share_title = document.title;

  // Twitter (X)
  document.getElementById('js-share-twitter').setAttribute(
    "href",
    "https://twitter.com/share?url=" + share_url + "&text=" + share_title + " " + encodeURIComponent(twitterUsername) + " より" +
    "&hashtags=rstats"
  );

  // Bluesky
  document.getElementById('js-share-bluesky').setAttribute(
    "href",
    "https://bsky.app/intent/compose?text=" + share_title + " " + share_url + " " + encodeURIComponent(blueskyUsername) + " より"
  );
</script>





<section id="はじめに" class="level2">
<h2 class="anchored" data-anchor-id="はじめに">はじめに</h2>
<p>Pythonでデータ分析を行う際、Jupyter Notebookは非常に便利なツールですが、次世代のノートブック環境である<strong>marimo</strong>を使うことで、より再現性高く、安定した分析環境を構築できます。</p>
<p>また、これまで単発の記事で紹介してきた<strong>uv</strong>、<strong>DuckDB</strong>、<strong>Polars</strong>といったパッケージを組み合わせることで、高速かつ効率的なデータ処理が可能になると考えており、今回はそれらを活用したデータ分析環境の構築方法について書きたいと思います。</p>
<p>過去に紹介したそれぞれのツールについても改めて簡単に説明していきます。</p>
<p>また、これまでの記事については以下をご参照ください。</p>
<a href="https://yo5uke.com/pages/tips/2025/09/250926_virtual_environment/" class="linkcard linkcard--default" target="" aria-label="Link to 【renv】仮想環境を設定する【venv】: Rはrenv、Pythonはvenvを使います。注目のuvも紹介！"><img src="https://yo5uke.com/pages/tips/2025/09/250926_virtual_environment/image/thumbnail.png" alt="Preview image for 【renv】仮想環境を設定する【venv】" class="linkcard__image" loading="lazy"><div class="linkcard__content"><div class="linkcard__title">【renv】仮想環境を設定する【venv】</div><div class="linkcard__description">Rはrenv、Pythonはvenvを使います。注目のuvも紹介！</div><div class="linkcard__url">yo5uke.com</div></div></a>
<a href="https://yo5uke.com/pages/tips/2025/09/250919_duckdb/" class="linkcard linkcard--default linkcard--no-image" target="" aria-label="Link to DuckDBをRで使う【duckplyrも】: R上でデータベース操作を行うために、DuckDBを利用する方法についてまとめます。"><div class="linkcard__content"><div class="linkcard__title">DuckDBをRで使う【duckplyrも】</div><div class="linkcard__description">R上でデータベース操作を行うために、DuckDBを利用する方法についてまとめます。</div><div class="linkcard__url">yo5uke.com</div></div></a>
<a href="https://yo5uke.com/pages/tips/2025/11/251125_r_polars/" class="linkcard linkcard--default linkcard--no-image" target="" aria-label="Link to 【R】polarsでデータ処理を高速化する: Rustベースの高速データ処理ライブラリ{polars}をRで使う方法と、tidyverseライクに使える{tidypolars}について解説します。"><div class="linkcard__content"><div class="linkcard__title">【R】polarsでデータ処理を高速化する</div><div class="linkcard__description">Rustベースの高速データ処理ライブラリ{polars}をRで使う方法と、tidyverseライクに使える{tidypolars}について解説します。</div><div class="linkcard__url">yo5uke.com</div></div></a>
</section>
<section id="marimoについて" class="level2">
<h2 class="anchored" data-anchor-id="marimoについて">marimoについて</h2>
<p>今回初登場となるのは<strong>marimo</strong>です。marimoは</p>
<blockquote class="blockquote">
<p>再現性が高く、Git に優しく、スクリプトやアプリとして展開できるリアクティブな Python ノートブック</p>
</blockquote>
<p>であり、ノートブックであることからJupyter NotebookやQuartoと同様にコードと文章を組み合わせたファイルを作成できるのですが、以下のような特徴があります。</p>
<ul>
<li>⚡リアクティブ：コードセルの依存関係を自動的に解析し、依存するセルを再実行（<a href="https://docs.marimo.io/guides/reactivity/">参考</a>）</li>
<li>🛢️データのためのデザイン：データフレームやデータベースをSQLでクエリできたり、データフレームのフィルタ・検索が可能（DuckDBとの親和性。<a href="https://docs.marimo.io/guides/working_with_data/sql/">参考</a>）</li>
<li>🐍ピュアPython：ファイルは<code>.ipynb</code>などではなく、純粋なPythonファイル（<code>.py</code>）として保存（Gitでの差分管理も容易に<sup>1</sup>）</li>
</ul>
<p>この他にもインタラクティブなプロットを簡単に作成できたり、webアプリにエクスポートできたりと、Quartoと似たような機能も備えています。</p>
<a href="https://github.com/marimo-team/marimo/blob/main/README_Japanese.md" class="linkcard linkcard--default" target="" aria-label="Link to marimo-team/marimo: A reactive notebook for Python — run reproducible experiments, query with SQL, execute as a script, deploy as an app, and version with git. Stored as pure Python. All in a modern, AI-native editor...."><img src="https://opengraph.githubassets.com/42159d0db734867a8dd019619e95d3dc50adf79ec3aa39b46eabc5f75a8424d1/marimo-team/marimo" alt="Preview image for marimo-team/marimo" class="linkcard__image" loading="lazy"><div class="linkcard__content"><div class="linkcard__title">marimo-team/marimo</div><div class="linkcard__description">A reactive notebook for Python — run reproducible experiments, query with SQL, execute as a script, deploy as an app, and version with git. Stored as pure Python. All in a modern, AI-native editor....</div><div class="linkcard__url">github.com</div></div></a>
<section id="リアクティブのメリット" class="level3">
<h3 class="anchored" data-anchor-id="リアクティブのメリット">リアクティブのメリット</h3>
<p>ちなみにリアクティブというのは<strong>隠れた状態</strong>（hidden state）の問題を解決するのに役立ちます。</p>
<p>Jupyter Notebookではセルの実行順序が自由であるため、セル1でデータの整理、セル2で分析、セル3で可視化を行う場合に、セル2を実行したのだけれどやっぱりセル1が修正する必要があった、というときに、セル1を修正後セル2を実行し忘れると修正前のデータが使われたまま分析が進んでしまうという問題があります<sup>2</sup>。</p>
<p>以下のようなコードを考えてみてください。</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb1" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb1-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Cell 1</span></span>
<span id="cb1-2">x <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span></span>
<span id="cb1-3"></span>
<span id="cb1-4"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Cell 2  </span></span>
<span id="cb1-5">y <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> x <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># y = 20</span></span>
<span id="cb1-6"></span>
<span id="cb1-7"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Cell 3</span></span>
<span id="cb1-8"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(y)  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 20と表示される</span></span></code></pre></div></div>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb2" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb2-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Cell 1を修正</span></span>
<span id="cb2-2">x <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">20</span>  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># xを20に変更</span></span>
<span id="cb2-3"></span>
<span id="cb2-4"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Cell 2を実行し忘れ</span></span>
<span id="cb2-5"></span>
<span id="cb2-6"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Cell 3</span></span>
<span id="cb2-7"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(y)  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 20と表示されてしまう（y=x*2なので本来は40になるはず）</span></span></code></pre></div></div>
<p>このようにセルの実行順序を間違えると、意図しない結果が出力されてしまうことがあります。</p>
<p>しかしmarimoではセル間の依存関係を自動的に解析し、セル1が修正された場合にはセル2も自動的に再実行されるため、上記のような問題を防ぐことができます。これは魅力的ですよね…！</p>
<p>それでは、次からは分析環境の構築に入っていきます。</p>
</section>
</section>
<section id="環境構築" class="level2">
<h2 class="anchored" data-anchor-id="環境構築">環境構築</h2>
<p>今回は以下の環境で進めていきます。</p>
<ul>
<li>OS: Windows 11</li>
<li>Python: 3.14</li>
<li>エディタ: VSCode</li>
</ul>
</section>
<section id="uvの設定" class="level2">
<h2 class="anchored" data-anchor-id="uvの設定">uvの設定</h2>
<p><strong>uv</strong>はPythonの新しい仮想環境管理ツールであり、高速に仮想環境を作成できることが特徴です。</p>
<p>詳しくは<a href="../../../../../pages/tips/2025/09/250926_virtual_environment/index.html">こちら</a>。</p>
<section id="uvのインストール" class="level3">
<h3 class="anchored" data-anchor-id="uvのインストール">uvのインストール</h3>
<p>まずはuvをインストールしましょう。PowerShell<sup>3</sup>で以下のコマンドを実行してください。</p>
<div class="tabset-margin-container"></div><div class="panel-tabset">
<ul class="nav nav-tabs"><li class="nav-item"><a class="nav-link active" id="tabset-1-1-tab" data-bs-toggle="tab" data-bs-target="#tabset-1-1" aria-controls="tabset-1-1" aria-selected="true" href="">Windows</a></li><li class="nav-item"><a class="nav-link" id="tabset-1-2-tab" data-bs-toggle="tab" data-bs-target="#tabset-1-2" aria-controls="tabset-1-2" aria-selected="false" href="">macOS / Linux</a></li></ul>
<div class="tab-content">
<div id="tabset-1-1" class="tab-pane active" aria-labelledby="tabset-1-1-tab">
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb3" style="background: #f1f3f5;"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb3-1"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">powershell</span> <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">-ExecutionPolicy</span> ByPass <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">-c</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"irm https://astral.sh/uv/install.ps1 | iex"</span></span></code></pre></div></div>
</div>
<div id="tabset-1-2" class="tab-pane" aria-labelledby="tabset-1-2-tab">
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb4" style="background: #f1f3f5;"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb4-1"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">curl</span> <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">-LsSf</span> https://astral.sh/uv/install.sh <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">|</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sh</span></span></code></pre></div></div>
</div>
</div>
</div>
</section>
<section id="プロジェクトの作成" class="level3">
<h3 class="anchored" data-anchor-id="プロジェクトの作成">プロジェクトの作成</h3>
<p>uvでは<code>uv init プロジェクト名</code>でプロジェクトを作成できます。以下のコマンドを実行してください。</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb5" style="background: #f1f3f5;"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb5-1"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">uv</span> init marimo-project</span></code></pre></div></div>
<p>すると<code>marimo-project</code>というディレクトリが作成されるので、このディレクトリをVSCodeで開いてください。</p>
<p>ここからはVSCodeのターミナルでコマンドを実行していきます<sup>4</sup>。</p>
</section>
<section id="uvでパッケージをインストール" class="level3">
<h3 class="anchored" data-anchor-id="uvでパッケージをインストール">uvでパッケージをインストール</h3>
<p>uvでは<code>uv add パッケージ名</code>でパッケージをインストールできます。venv環境は裏で自動的に作成されるため、手動で仮想環境を作成する必要はありません。</p>
<p>今回使用するパッケージをインストールするには以下のコマンドを実行してください。</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb6" style="background: #f1f3f5;"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb6-1"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">uv</span> add marimo polars duckdb pyarrow sqlglot</span></code></pre></div></div>
</section>
<section id="パッケージの管理" class="level3">
<h3 class="anchored" data-anchor-id="パッケージの管理">パッケージの管理</h3>
<p>uvでは<code>requirements.txt</code>を使わずに、<code>uv.lock</code>というファイルでパッケージのバージョン管理を行います。<code>uv add</code>を実行すると自動的に<code>uv.lock</code>が生成され、自動でパッケージの依存関係も解決されます。</p>
<p>別環境などで<code>uv.lock</code>からパッケージをインストールしたい場合は、以下のコマンドを実行してください。</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb7" style="background: #f1f3f5;"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb7-1"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">uv</span> sync</span></code></pre></div></div>
</section>
</section>
<section id="marimoノートブックの作成" class="level2">
<h2 class="anchored" data-anchor-id="marimoノートブックの作成">marimoノートブックの作成</h2>
<p>ここが本日のメインです。marimoノートブックを作成していきます。</p>
<p>marimoはuvを使ってインストールすることができ、先ほどのコマンドでインストールされているので、導入は簡単です。</p>
<section id="pythonファイルの作成" class="level3">
<h3 class="anchored" data-anchor-id="pythonファイルの作成">Pythonファイルの作成</h3>
<p>先述の通り、marimoノートブックは<code>.py</code>ファイルとして保存されます。まずはファイルを任意のディレクトリに作成しましょう。例えば<code>analysis.py</code>という名前にします。</p>
<p>ディレクトリの構造は以下のようなイメージです。</p>
<pre><code>project-directory/
 ├── .venv/
 ├── .gitignore
 ├── analysis.py     ← 作成したファイル
 ├── pyproject.toml
 └── uv.lock</code></pre>
</section>
<section id="marimoの起動" class="level3">
<h3 class="anchored" data-anchor-id="marimoの起動">marimoの起動</h3>
<p>marimoはVSCode上で動作するのではなく、コマンドラインから起動してブラウザで操作します。以下のコマンドを実行してください。</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb9" style="background: #f1f3f5;"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb9-1"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">uv</span> run marimo edit analysis.py</span></code></pre></div></div>
<p>するとブラウザが起動し、以下のような画面が表示されます。</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://yo5uke.com/pages/tips/2026/01/marimo/image/marimo_browser.png" class="img-fluid figure-img"></p>
<figcaption>marimoの起動画面</figcaption>
</figure>
</div>
</section>
<section id="marimoノートブックの基本操作" class="level3">
<h3 class="anchored" data-anchor-id="marimoノートブックの基本操作">marimoノートブックの基本操作</h3>
<p>画面を見ていただいてわかる通り、<code>import marimo as mo</code>と最初に書かれており、その下にPython、Markdown、SQLのセルを追加できるようになっています。</p>
<p>まずはタイトルから書きたいとして、最初のセルに追記して以下のようにします。</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb10" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb10-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> marimo <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">as</span> mo</span>
<span id="cb10-2"></span>
<span id="cb10-3">mo.md(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"# marimoを始めよう🍃"</span>)</span></code></pre></div></div>
<p>実行ボタン（▶️）を押すと、以下のようにタイトルが表示されます。</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://yo5uke.com/pages/tips/2026/01/marimo/image/marimo_add_title.png" class="img-fluid figure-img"></p>
<figcaption>marimoでタイトル表示</figcaption>
</figure>
</div>
<p>続いてPythonコードを書いてみます。</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb11" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb11-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> polars <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">as</span> pl</span>
<span id="cb11-2"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> duckdb</span>
<span id="cb11-3"></span>
<span id="cb11-4">df <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> pl.DataFrame({</span>
<span id="cb11-5">    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Name"</span>: [<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Michel"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"James"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Daniel"</span>],</span>
<span id="cb11-6">    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Age"</span>: [<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">25</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">30</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">22</span>]</span>
<span id="cb11-7">})</span>
<span id="cb11-8"></span>
<span id="cb11-9">duckdb.sql(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"SELECT * FROM df"</span>)</span></code></pre></div></div>
<p>実行ボタンを押すと、以下のようにデータフレームが表示されます。</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://yo5uke.com/pages/tips/2026/01/marimo/image/marimo_run.png" class="img-fluid figure-img"></p>
<figcaption>marimoで結果を表示</figcaption>
</figure>
</div>
<p>また、SQLセルを追加して以下のように書くこともできます。</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb12" style="background: #f1f3f5;"><pre class="sourceCode sql code-with-copy"><code class="sourceCode sql"><span id="cb12-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">SELECT</span> Name, Age <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">FROM</span> df <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">WHERE</span> Age <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">23</span></span></code></pre></div></div>
<p>実行ボタンを押すと、以下のようにSQLの結果が表示されます。</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://yo5uke.com/pages/tips/2026/01/marimo/image/marimo_run_sql.png" class="img-fluid figure-img"></p>
<figcaption>marimoでSQL結果を表示</figcaption>
</figure>
</div>
<p>SQLセルでは<strong>自動でDuckDBが使われ</strong>、SQL用の特別な設定も不要なのでとても便利だと思っています。</p>
<p>もちろんマークダウンセルでは通常のマークダウンと同様の記述ができます。</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://yo5uke.com/pages/tips/2026/01/marimo/image/marimo_markdown.png" class="img-fluid figure-img"></p>
<figcaption>marimoでマークダウンセル</figcaption>
</figure>
</div>
</section>
<section id="エクスポート" class="level3">
<h3 class="anchored" data-anchor-id="エクスポート">エクスポート</h3>
<p>marimoノートブックは様々な形式にエクスポートできます。今回はQuartoでもおなじみのHTML形式にエクスポートしてみます。</p>
<p>コマンドラインからだと</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb13" style="background: #f1f3f5;"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb13-1"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">uv</span> run marimo export html analysis.py <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">-o</span> analysis.html</span></code></pre></div></div>
<p>で、エディタからだと</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://yo5uke.com/pages/tips/2026/01/marimo/image/marimo_export.png" class="img-fluid figure-img"></p>
<figcaption>marimoでエクスポート</figcaption>
</figure>
</div>
<p>でエクスポートできます。</p>
<p>エクスポートされたHTMLファイルをブラウザで開くと、以下のように表示されます。</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://yo5uke.com/pages/tips/2026/01/marimo/image/marimo_html.png" class="img-fluid figure-img"></p>
<figcaption>marimoでエクスポートしたHTML</figcaption>
</figure>
</div>
</section>
</section>
<section id="polarsとduckdbの活用" class="level2">
<h2 class="anchored" data-anchor-id="polarsとduckdbの活用">PolarsとDuckDBの活用</h2>
<p>今回はmarimoにフォーカスしてきたため、DuckDBとPolarsの詳細な使い方については省略しますが、<strong>uv × marimo × DuckDB × Polars</strong>の組み合わせは非常に強力だと考えています。</p>
<p>強力な点として、</p>
<ul>
<li>uvで簡単に仮想環境を管理できる</li>
<li>marimoで再現性の高いノートブックを作成できる</li>
<li>DuckDBで大規模データも効率的にSQLクエリが可能</li>
<li>Polarsで高速にデータ処理ができる</li>
</ul>
<p>が挙げられます。</p>
<p>DuckDBではデータをメモリに読み込まずにSQLクエリを実行できるため、大規模データを扱う際にメモリ不足の問題を回避できます。ローデータからの抽出等はDuckDBで行い、集計や変形はPolarsで行う、というワークフローが考えられ、しかもこれが高速というのは非常に魅力的だと考えています。</p>
</section>
<section id="おわりに" class="level2">
<h2 class="anchored" data-anchor-id="おわりに">おわりに</h2>
<p>今回はuv、marimo、DuckDB、Polarsを組み合わせたデータ分析環境の構築方法について紹介しました。</p>
<p>とは言ってもmarimoの紹介がメインになってしまいましたが、2026年のPython環境としてはだいぶモダンな構成なのではないかと考えています。</p>
<p>こちら2026年1本目の記事ですが、このこぢんまり下サイトを見てくださっている方、今年もどうぞよろしくお願いいたします。</p>
</section>
<section id="余談" class="level2">
<h2 class="anchored" data-anchor-id="余談">余談</h2>
<p>リンクカードを実装しました。</p>
<p>Quartoにはリンクカードの機能がないので、これまでは</p>
<div class="callout callout-style-simple callout-tip no-icon">
<div class="callout-body d-flex">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-body-container">
<p><a href="../../../../../pages/tips/2026/01/marimo/index.html">yo5uke.com</a></p>
</div>
</div>
</div>
<p>のようにcalloutを使ってリンクを紹介していたのですが、リンクカードの拡張機能を実装したことで</p>
<a href="https://yo5uke.com/index.html" class="linkcard linkcard--default" target="" aria-label="Link to Yosuke Abe"><img src="https://yo5uke.com/assets/images/orange_bara.jpg" alt="Preview image for Yosuke Abe" class="linkcard__image" loading="lazy"><div class="linkcard__content"><div class="linkcard__title">Yosuke Abe</div><div class="linkcard__url">yo5uke.com</div></div></a>
<p>みたいにできるようになりました。</p>
<p>まだ修正は必要そうですが、2026年はこれでいきたいと思います！</p>


<!-- -->

</section>


<div id="quarto-appendix" class="default"><section id="footnotes" class="footnotes footnotes-end-of-document"><h2 class="anchored quarto-appendix-heading">注</h2>

<ol>
<li id="fn1"><p><code>.ipynb</code>はJSON形式で保存されるため、わずかな変更でも大きな差分が発生しがちです。↩︎</p></li>
<li id="fn2"><p>これはQuartoでも同様ですが、Renderすれば上から順番通りに実行されます。手元の修正忘れの結果とレンダリングした結果が異なる、ということは起こり得ますが…。↩︎</p></li>
<li id="fn3"><p>macOS/Linuxではターミナル↩︎</p></li>
<li id="fn4"><p><span class="visually-hidden"></span>で開くことができます。↩︎</p></li>
</ol>
</section></div> ]]></description>
  <category>Python</category>
  <category>SQL</category>
  <category>データ処理</category>
  <guid>https://yo5uke.com/pages/tips/2026/01/marimo/</guid>
  <pubDate>Thu, 08 Jan 2026 15:00:00 GMT</pubDate>
  <media:content url="https://yo5uke.com/pages/tips/2026/01/marimo/image/marimo_run_sql.png" medium="image" type="image/png" height="84" width="144"/>
</item>
<item>
  <title>今年使ったツールを振り返る</title>
  <link>https://yo5uke.com/pages/tips/2025/12/251226_lookback/</link>
  <description><![CDATA[ 

<div class="social-share-buttons">
  <!-- Twitter (X) -->
  <a href="" id="js-share-twitter" class="share_button ri--twitter-x-fill" target="_blank" rel="nofollow noopener noreferrer"></a>

  <!-- Bluesky -->
  <a href="" id="js-share-bluesky" class="share_button ri--bluesky-fill" target="_blank" rel="nofollow noopener noreferrer"></a>
</div>

<script>
  const twitterUsername = "@5uke_y";
  const blueskyUsername = "@5uke.bsky.social";

  const share_url = encodeURIComponent(location.href);
  const share_title = document.title;

  // Twitter (X)
  document.getElementById('js-share-twitter').setAttribute(
    "href",
    "https://twitter.com/share?url=" + share_url + "&text=" + share_title + " " + encodeURIComponent(twitterUsername) + " より" +
    "&hashtags=rstats"
  );

  // Bluesky
  document.getElementById('js-share-bluesky').setAttribute(
    "href",
    "https://bsky.app/intent/compose?text=" + share_title + " " + share_url + " " + encodeURIComponent(blueskyUsername) + " より"
  );
</script>





<section id="はじめに" class="level2">
<h2 class="anchored" data-anchor-id="はじめに">はじめに</h2>
<p>こんにちは。クリスマスも過ぎいよいよ年末感が出てきましたので、今回は2025年に使ったツールを振り返ってみたいと思います。</p>
</section>
<section id="positron" class="level2">
<h2 class="anchored" data-anchor-id="positron">Positron</h2>
<p>まずはIDEのPositronです。Positronが正式にリリースされ、RとPythonの両方をサポートする強力なIDEとして注目を集めました。</p>
<p>RStudioからの移行も割としやすく、VSCodeベースでありながらRStudioのような使い勝手を提供してくれます。</p>
<p>個人的には拡張機能を通じてコードを書きやすくなったのが大きいと思います。GitHub Copilotも利用できますし、チャットをいちいちブラウザやアプリで開かなくてもIDE内で完結できるのは便利です。</p>
<p>Positronについては以下の記事で詳しく紹介しています。</p>
<div class="callout callout-style-simple callout-tip no-icon">
<div class="callout-body d-flex">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-body-container">
<p><a href="../../../../../pages/tips/2025/09/250901_positron_setting/index.html">Positronのおすすめ設定！【R | Python】</a></p>
</div>
</div>
</div>
</section>
<section id="duckdb" class="level2">
<h2 class="anchored" data-anchor-id="duckdb">DuckDB</h2>
<p>続いて組み込み型データベースのDuckDBです。今年Rを使う仕事ではもれなく使っていたかもしれません。</p>
<p>DuckDBはRやPythonでパッケージをインストールするだけで使うことができ、Rの場合は<code>dplyr</code>のような感覚でSQLクエリを実行できるのが魅力です。</p>
<p>Rのメモリに読み込まずにデータを読み込めるため、大規模データの処理にも向いています。</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb1" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(DBI)</span>
<span id="cb1-2"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(dplyr)</span>
<span id="cb1-3"></span>
<span id="cb1-4"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># DuckDBに接続</span></span>
<span id="cb1-5">con <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">dbConnect</span>(duckdb<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">duckdb</span>())</span>
<span id="cb1-6"></span>
<span id="cb1-7"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Rのメモリに読み込まずにCSVをクエリ可能</span></span>
<span id="cb1-8"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">tbl</span>(con, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"read_csv('data/iris.csv')"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span></span>
<span id="cb1-9">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">filter</span>(Species <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"setosa"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span></span>
<span id="cb1-10">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">collect</span>()</span></code></pre></div></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 50 × 5
   Sepal.Length Sepal.Width Petal.Length Petal.Width Species
          &lt;dbl&gt;       &lt;dbl&gt;        &lt;dbl&gt;       &lt;dbl&gt; &lt;chr&gt;  
 1          5.1         3.5          1.4         0.2 setosa 
 2          4.9         3            1.4         0.2 setosa 
 3          4.7         3.2          1.3         0.2 setosa 
 4          4.6         3.1          1.5         0.2 setosa 
 5          5           3.6          1.4         0.2 setosa 
 6          5.4         3.9          1.7         0.4 setosa 
 7          4.6         3.4          1.4         0.3 setosa 
 8          5           3.4          1.5         0.2 setosa 
 9          4.4         2.9          1.4         0.2 setosa 
10          4.9         3.1          1.5         0.1 setosa 
# ℹ 40 more rows</code></pre>
</div>
</div>
<p><code>collect()</code>を実行するまではRのメモリにデータが読み込まれず、DuckDB上で実行されるため効率的です。<code>collect()</code>をして初めてRのメモリにデータが読み込まれます。</p>
<p>DuckDBについては以下の記事で詳しく紹介していますので、よければご覧ください。</p>
<div class="callout callout-style-simple callout-tip no-icon">
<div class="callout-body d-flex">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-body-container">
<p><a href="../../../../../pages/tips/2025/09/250919_duckdb/index.html">DuckDBをRで使う【<span class="fira-code">duckplyr</span>も】</a></p>
</div>
</div>
</div>
</section>
<section id="polars" class="level2">
<h2 class="anchored" data-anchor-id="polars">Polars</h2>
<p>polarsの発見は今年の大きな収穫でした。Pythonでデータ処理を行うためのライブラリでpandasと似ていますが、<strong>爆速</strong>です。</p>
<p>速いので下処理はPythonでやってしまおうかなと思っているほどですが、幸いにもRからも<code>polars</code>および<code>tidypolars</code>パッケージを通じて利用可能です。</p>
<p>特にtidypolarsはdplyrの多くの関数をサポートしており、これまでの使い方をしているだけで処理速度が向上します。対応していない関数は自動でdplyrにフォールバックするため、使い勝手も良好です。</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb3" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(tidyverse)</span>
<span id="cb3-2"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(tidypolars) <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 後に読み込み</span></span></code></pre></div></div>
<p>polarsもtidypolarsもCRANには公開されていないのでインストールには一工夫必要ですが、以下の記事で詳しく紹介しています。</p>
<div class="callout callout-style-simple callout-tip no-icon">
<div class="callout-body d-flex">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-body-container">
<p><a href="../../../../../pages/tips/2025/11/251125_r_polars/index.html">【R】<span class="fira-code">polars</span>でデータ処理を高速化する</a></p>
</div>
</div>
</div>
<p>余談ですが、自分はpolarsを「ポーラーズ」と読むものと思っていたのですが、先日Japan.Rに参加した際に登壇者の方が「ポーラス」と読んでらっしゃり、びっくりしました。ググったところだと、イギリス英語が「ポーラス」、アメリカ英語が「ポーラーズ」に近いかなと思います。開発チームはオランダにあるようなので、イギリス英語なのかもしれません。</p>
</section>
<section id="postgresql" class="level2">
<h2 class="anchored" data-anchor-id="postgresql">PostgreSQL</h2>
<p>続いて、PostgreSQLです。学生時代はSQLに触る機会はなく、社会人になってから初めてSQLを使ったのですが、世界が広がりましたね。</p>
<p>まず使っているデータの規模が学生時代とは違うので学生が使うべきかと聞かれると別に…という感じですが、個票データを使ったりする場合にはPostgreSQLのようなRDBMS（Relational Database Management System）が便利かなと思うようになりました。</p>
<p>DuckDBとの使い分けはどうなんだよという話ですが、例えばDuckDBは組み込み型データベースなのでサーバーを立てる必要がなく、ローカルで完結するのが強みです。一方でPostgreSQLはサーバー型なので複数人でデータを共有したり、アクセス制御を行ったりするのに向いているのではないでしょうか。</p>
<p>また、PostgreSQLにはpgAdminのようなGUIツール<sup>1</sup>もあり、データのイメージを掴みやすいのも良い点です。</p>
<p>さらに、個人的にはPostGISという地理空間データを扱う拡張機能が便利で、地理空間データをSQLで処理できるのが魅力です。Rだと重い処理もSQLで実行できるので効率的です。</p>
<p>PostgreSQLについては以下の記事で詳しく紹介しています。</p>
<div class="callout callout-style-simple callout-tip no-icon">
<div class="callout-body d-flex">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-body-container">
<p><a href="../../../../../pages/tips/2025/12/251201_env/index.html">【Windows】RとPostgreSQL中心の環境構築【GISも】</a></p>
</div>
</div>
</div>
</section>
<section id="uv" class="level2">
<h2 class="anchored" data-anchor-id="uv">uv</h2>
<p>最近はPythonの仮想環境構築のため、Rust製のuvという仮想環境管理ツールを使い始めました。</p>
<p>uvは非常に高速かつシンプルな設計で、プロジェクトごとに仮想環境を簡単に作成・管理できます。</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb4" style="background: #f1f3f5;"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb4-1"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">uv</span> init my_project</span>
<span id="cb4-2"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">cd</span> my_project</span>
<span id="cb4-3"></span>
<span id="cb4-4"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">uv</span> add pandas numpy</span></code></pre></div></div>
<p>uvについては以下の記事で詳しく紹介しています。</p>
<div class="callout callout-style-simple callout-tip no-icon">
<div class="callout-body d-flex">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-body-container">
<p><a href="../../../../../pages/tips/2025/09/250926_virtual_environment/index.html#uvを使ったvenv環境の構築方法">【renv】仮想環境を設定する【venv】</a></p>
</div>
</div>
</div>
</section>
<section id="おわりに" class="level2">
<h2 class="anchored" data-anchor-id="おわりに">おわりに</h2>
<p>これまでもちょこちょこ記事にしてきたので目新しいことは特にないのですが、2025年に使ったツールを振り返ってみました。</p>
<p>新しいものはどんどん取り入れていきたいスタイルなので、来年も色々試していきたいと思います。もしおすすめのツール等あればぜひご教示いただきたいです。</p>
<p>引き続きよろしくお願いいたします！</p>


<!-- -->

</section>


<div id="quarto-appendix" class="default"><section id="footnotes" class="footnotes footnotes-end-of-document"><h2 class="anchored quarto-appendix-heading">注</h2>

<ol>
<li id="fn1"><p>GUIとはGraphical User Interfaceの略で、視覚的に操作できるインターフェースのことです。CSVファイルを生で見ても見にくいですが、Excelで開くと見やすくなるのと同じようなイメージです。↩︎</p></li>
</ol>
</section></div> ]]></description>
  <category>R</category>
  <category>Python</category>
  <category>Positron</category>
  <category>SQL</category>
  <guid>https://yo5uke.com/pages/tips/2025/12/251226_lookback/</guid>
  <pubDate>Thu, 25 Dec 2025 15:00:00 GMT</pubDate>
</item>
<item>
  <title>【Windows】RとPostgreSQL中心の環境構築【GISも】</title>
  <link>https://yo5uke.com/pages/tips/2025/12/251201_env/</link>
  <description><![CDATA[ 

<div class="social-share-buttons">
  <!-- Twitter (X) -->
  <a href="" id="js-share-twitter" class="share_button ri--twitter-x-fill" target="_blank" rel="nofollow noopener noreferrer"></a>

  <!-- Bluesky -->
  <a href="" id="js-share-bluesky" class="share_button ri--bluesky-fill" target="_blank" rel="nofollow noopener noreferrer"></a>
</div>

<script>
  const twitterUsername = "@5uke_y";
  const blueskyUsername = "@5uke.bsky.social";

  const share_url = encodeURIComponent(location.href);
  const share_title = document.title;

  // Twitter (X)
  document.getElementById('js-share-twitter').setAttribute(
    "href",
    "https://twitter.com/share?url=" + share_url + "&text=" + share_title + " " + encodeURIComponent(twitterUsername) + " より" +
    "&hashtags=rstats"
  );

  // Bluesky
  document.getElementById('js-share-bluesky').setAttribute(
    "href",
    "https://bsky.app/intent/compose?text=" + share_title + " " + share_url + " " + encodeURIComponent(blueskyUsername) + " より"
  );
</script>





<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
<span class="screen-reader-only">Note</span>データベースについて
</div>
</div>
<div class="callout-body-container callout-body">
<p>本記事ではデータベースとしてPostgreSQLを使用しますが、DuckDBもおすすめです。DuckDBは組み込み型のデータベースで、RやPythonから簡単に利用でき、大規模データの処理にも適しています。</p>
<p>使い方については<a href="../../../../../pages/tips/2025/09/250919_duckdb/index.html">こちらの記事</a>を参照してください。</p>
</div>
</div>
<section id="はじめに" class="level2">
<h2 class="anchored" data-anchor-id="はじめに">はじめに</h2>
<p>データ分析や統計処理を行う際、RやPythonといったプログラミング言語に加えて、大規模なデータを効率的に管理・処理するためのデータベースが必要になることがあります。特に、<strong>大規模なローデータがあり、そこからさまざまなデータフレームを生成・操作するような場合</strong>、PostgreSQLのような高機能なデータベースが強力な味方になります。</p>
<p>本記事では、Windows環境でWSL（Windows Subsystem for Linux）を活用し、R、PostgreSQLを中心とした開発環境を構築する方法を解説します。WSLを使うことで、Windowsの使いやすさを保ちながら、Linux環境の恩恵を受けられます。</p>
<p><strong>この記事の対象読者</strong></p>
<ul>
<li>RやPythonでデータ分析を行っている方</li>
<li>PostgreSQLを使ったデータ管理に興味がある方</li>
<li>WSLを活用した効率的な開発環境を構築したい方</li>
</ul>
<p><strong>環境構築の流れ</strong></p>
<ol type="1">
<li>Windows上でのセットアップ（基本編）</li>
<li>WSL上でのセットアップ（発展編）</li>
</ol>
<p>初めての方はまずWindows版から試してみて、より本格的な環境が必要になったらWSL版に移行するのがおすすめです。</p>
<p>結構長いページになってしまったので、目次から適宜ジャンプして読んでみてください。</p>
<p>また、本ページではSQLコードに関してはRを経由した実行方法を中心に解説します。</p>
<div class="callout callout-style-simple callout-note">
<div class="callout-body d-flex">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-body-container">
<p>Macユーザーの方も、PostgreSQLとRの組み合わせは同様に有効ですので、参考にしてみてください。</p>
</div>
</div>
</div>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
<span class="screen-reader-only">Note</span>事前準備
</div>
</div>
<div class="callout-body-container callout-body">
<ul>
<li>Windows 11</li>
<li>RとIDE（RStudioやPositron等）はインストール済み</li>
</ul>
<p>であることを前提とします。</p>
</div>
</div>
</section>
<section id="postgresqlとは" class="level2">
<h2 class="anchored" data-anchor-id="postgresqlとは">PostgreSQLとは</h2>
<p>PostgreSQLは、オープンソースの高機能なリレーショナルデータベース管理システム（RDBMS）です。「ポストグレス」と読みます<sup>1</sup>。</p>
<p><strong>PostgreSQLの特徴</strong></p>
<ul>
<li><strong>高い拡張性</strong>: GIS（地理情報システム）に対応したPostGISなど、様々な拡張機能を追加できる</li>
<li><strong>標準SQLへの準拠</strong>: 標準的なSQL構文をサポートし、複雑なクエリも実行可能</li>
<li><strong>豊富なデータ型</strong>: 配列、JSON、幾何データなど、多様なデータ型に対応</li>
<li><strong>トランザクション管理</strong>: データの整合性を保ちながら安全に操作できる</li>
</ul>
<p><strong>なぜPostgreSQLを使うのか</strong></p>
<p>RやPythonだけでもデータ分析は可能ですが、以下のような場面でPostgreSQLが役立ちます：</p>
<ul>
<li>メモリに収まりきらない大規模データの処理</li>
<li>複数のプロジェクトで共通のデータソースを利用</li>
<li>空間データ（緯度経度、ポリゴンなど）の効率的な管理と分析</li>
<li>複雑な集計やフィルタリングをSQL側で事前処理</li>
</ul>
<p>特に、PostGIS拡張を導入すれば、バス停や人口メッシュといった空間データの距離計算やバッファ分析などが高速に実行でき、GIS分析の強力な基盤となります。</p>
</section>
<section id="wslとは" class="level2">
<h2 class="anchored" data-anchor-id="wslとは">WSLとは</h2>
<p>WSL（Windows Subsystem for Linux）は、Windows上でLinux環境をネイティブに実行できる機能です。仮想マシンよりも軽量で、WindowsとLinuxのファイルシステムを相互に利用できるのが特徴です。</p>
<section id="wslのメリット" class="level3">
<h3 class="anchored" data-anchor-id="wslのメリット">WSLのメリット</h3>
<ul>
<li><strong>パッケージ管理が簡単</strong>: <code>apt</code>コマンドで必要なソフトウェアを簡単にインストール</li>
<li><strong>再現性の高い環境</strong>: LinuxベースのDockerやサーバー環境と同じOSで作業できる</li>
<li><strong>高いパフォーマンス</strong>: 特にI/O処理やデータベース操作が高速</li>
<li><strong>開発ツールが豊富</strong>: Linux標準のコマンドラインツールをそのまま利用可能</li>
</ul>
</section>
<section id="windows版とwsl版どちらを選ぶべき" class="level3">
<h3 class="anchored" data-anchor-id="windows版とwsl版どちらを選ぶべき">Windows版とWSL版、どちらを選ぶべき？</h3>
<p><strong>Windows版が向いている場合</strong></p>
<ul>
<li>初めてPostgreSQLやRを使う方</li>
<li>既存のWindows環境で素早く始めたい</li>
<li>GUIツールを中心に使いたい</li>
</ul>
<p><strong>WSL版が向いている場合</strong></p>
<ul>
<li>空間データ分析（PostGISなど）を本格的に行いたい</li>
<li>Dockerやサーバー環境との互換性を重視したい</li>
<li>コマンドラインでの作業に慣れている、または学びたい</li>
<li>より高いパフォーマンスと柔軟性が必要</li>
</ul>
<p>本記事では両方の方法を紹介しますので、お好みで選んでください。まずはWindows版で試してみて、必要に応じてWSL版に移行するのもよいと思います。</p>
</section>
</section>
<section id="windows上でのセットアップ基本編" class="level2">
<h2 class="anchored" data-anchor-id="windows上でのセットアップ基本編">1. Windows上でのセットアップ（基本編）</h2>
<p>Windows環境で直接PostgreSQL、Rをセットアップする方法を解説します。GUIツールが使いやすく、初めての方にもおすすめです。</p>
<section id="postgresqlのインストール" class="level3">
<h3 class="anchored" data-anchor-id="postgresqlのインストール">1.1 PostgreSQLのインストール</h3>
<section id="インストーラーのダウンロード" class="level4">
<h4 class="anchored" data-anchor-id="インストーラーのダウンロード">インストーラーのダウンロード</h4>
<ol type="1">
<li><a href="https://www.postgresql.org/download/windows/">PostgreSQL公式サイト</a>にアクセス</li>
<li>ページ冒頭にある「Download the installer」をクリック</li>
<li>最新の安定版（例: PostgreSQL 18）のWindowsインストーラーをダウンロード</li>
</ol>
</section>
<section id="インストール手順" class="level4">
<h4 class="anchored" data-anchor-id="インストール手順">インストール手順</h4>
<ol type="1">
<li>ダウンロードしたインストーラーを実行</li>
<li>インストールウィザードに従って進める
<ul>
<li><strong>Installation Directory</strong>：デフォルトのまま（例：<code>C:\Program Files\PostgreSQL\18</code>）</li>
<li><strong>Select Components</strong>：すべてにチェック（PostgreSQL Server、pgAdmin 4、Stack Builder、Command Line Tools）</li>
<li><strong>Data Directory</strong>: デフォルトのまま</li>
<li><strong>Password</strong>: スーパーユーザー（postgres）のパスワードを設定<sup>2</sup></li>
<li><strong>Port</strong>: デフォルトの<code>5432</code>のまま</li>
<li><strong>Locale</strong>: <code>[DEFAULT]</code>または <code>Japanese, Japan</code></li>
</ul></li>
<li>インストール完了後、Stack Builderは「Skip」してOK（あるいはキャンセルして終了）</li>
</ol>
</section>
<section id="動作確認" class="level4">
<h4 class="anchored" data-anchor-id="動作確認">動作確認</h4>
<p><img src="https://yo5uke.com/pages/tips/2025/12/251201_env/image/psql.png" class="img-fluid"></p>
<p>スタートメニューから「SQL Shell (psql)」を起動し、以下を入力：</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb1" style="background: #f1f3f5;"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb1-1"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">Server</span> <span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">[</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">localhost</span><span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">]</span>:  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Enterキーを押す</span></span>
<span id="cb1-2"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">Database</span> <span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">[</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">postgres</span><span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">]</span>:  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Enterキーを押す</span></span>
<span id="cb1-3"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">Port</span> <span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">[</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">5432</span><span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">]</span>:  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Enterキーを押す</span></span>
<span id="cb1-4"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">Username</span> <span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">[</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">postgres</span><span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">]</span>:  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Enterキーを押す</span></span>
<span id="cb1-5"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">Client</span> Encoding <span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">[</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">SJIS</span><span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">]</span>:  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Enterキーを押す</span></span>
<span id="cb1-6"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">ユーザー</span> postgres のパスワード:  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 設定したパスワードを入力</span></span></code></pre></div></div>
<p>パスワード以外は入力しなくて問題ありません！<code>postgres=#</code>と表示されれば成功です。以下のコマンドでバージョンを確認できます：</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb2" style="background: #f1f3f5;"><pre class="sourceCode sql code-with-copy"><code class="sourceCode sql"><span id="cb2-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">SELECT</span> version();</span></code></pre></div></div>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://yo5uke.com/pages/tips/2025/12/251201_env/image/psql_version.png" class="img-fluid figure-img"></p>
<figcaption>バージョン確認</figcaption>
</figure>
</div>
<p>終了する場合は <code>\q</code> と入力してEnterキーを押します。</p>
</section>
<section id="pgadmin-4の起動" class="level4">
<h4 class="anchored" data-anchor-id="pgadmin-4の起動">pgAdmin 4の起動</h4>
<p>PostgreSQLをGUIで操作できる「pgAdmin 4」も一緒にインストールされています。スタートメニューから「pgAdmin 4」を起動して、データベースの作成やテーブルの確認ができます。</p>
<p>左側のサイドバーにある「Servers」から「PostgreSQL 18」を選択、「Databases」→「postgres」→「Schemas」→「public」→「Tables」でテーブル一覧を確認できますが、今回はR上で操作することもあり、必ずしもpgAdminを使う必要はありません。一時的にGUIで確認したい場合に利用するとよいと思います。</p>
</section>
</section>
<section id="rからpostgresqlに接続" class="level3">
<h3 class="anchored" data-anchor-id="rからpostgresqlに接続">1.2 RからPostgreSQLに接続</h3>
<p>RからPostgreSQLを操作するには、<code>RPostgres</code>パッケージを使います。また、データベース全般の操作には<code>DBI</code>パッケージも必要です。</p>
<section id="パッケージのインストール" class="level4">
<h4 class="anchored" data-anchor-id="パッケージのインストール">パッケージのインストール</h4>
<p>RStudioのコンソールで以下を実行：</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb3" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">install.packages</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"RPostgres"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"DBI"</span>))</span></code></pre></div></div>
</section>
<section id="接続テスト" class="level4">
<h4 class="anchored" data-anchor-id="接続テスト">接続テスト</h4>
<p>以下のコードで接続を確認します：</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb4" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(DBI)</span>
<span id="cb4-2"></span>
<span id="cb4-3"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># データベースに接続</span></span>
<span id="cb4-4">con <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">dbConnect</span>(</span>
<span id="cb4-5">  RPostgres<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">Postgres</span>(),</span>
<span id="cb4-6">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">dbname =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"postgres"</span>,</span>
<span id="cb4-7">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">host =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"localhost"</span>,</span>
<span id="cb4-8">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">port =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5432</span>,</span>
<span id="cb4-9">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">user =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"postgres"</span>,</span>
<span id="cb4-10">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">password =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"あなたのパスワード"</span></span>
<span id="cb4-11">)</span>
<span id="cb4-12"></span>
<span id="cb4-13"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 接続確認</span></span>
<span id="cb4-14"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">dbGetQuery</span>(con, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"SELECT version();"</span>)</span>
<span id="cb4-15"></span>
<span id="cb4-16"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 切断</span></span>
<span id="cb4-17"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">dbDisconnect</span>(con)</span></code></pre></div></div>
<p>エラーが出ずに結果が表示されれば成功です。</p>
<div class="callout callout-style-default callout-important callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
<span class="screen-reader-only">Important</span>パスワードの扱いについて
</div>
</div>
<div class="callout-body-container callout-body">
<p>プロジェクトが個人用であれば問題ありませんが、チーム開発や公開リポジトリでコードを共有する場合、パスワードを直接コードに書くのは避けた方がよいです。</p>
<p>Gitを使用している場合、<code>.Renviron</code>ファイルをワーキングディレクトリに作成し、以下のように環境変数を設定する方法がおすすめです：</p>
<pre><code>PG_PASSWORD=あなたのパスワード</code></pre>
<p>Rコード内では以下のように取得します：</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb6" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1">con <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">dbConnect</span>(</span>
<span id="cb6-2">  RPostgres<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">Postgres</span>(),</span>
<span id="cb6-3">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">dbname =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"postgres"</span>,</span>
<span id="cb6-4">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">host =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"localhost"</span>,</span>
<span id="cb6-5">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">port =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5432</span>,</span>
<span id="cb6-6">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">user =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"postgres"</span>,</span>
<span id="cb6-7">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">password =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">Sys.getenv</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"PG_PASSWORD"</span>)</span>
<span id="cb6-8">)</span></code></pre></div></div>
<p><code>.Renviron</code>ファイルはGitで管理しないよう、<code>.gitignore</code>に追加しておいてください。公開しては意味がありませんので…。</p>
<p>もしくは<code>rstudioapi::askForPassword()</code>関数を使って、実行時にパスワードを入力させる方法もあります。</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb7" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1">con <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">dbConnect</span>(</span>
<span id="cb7-2">  RPostgres<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">Postgres</span>(),</span>
<span id="cb7-3">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">dbname =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"postgres"</span>,</span>
<span id="cb7-4">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">host =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"localhost"</span>,</span>
<span id="cb7-5">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">port =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5432</span>,</span>
<span id="cb7-6">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">user =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"postgres"</span>,</span>
<span id="cb7-7">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">password =</span> rstudioapi<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">askForPassword</span>()</span>
<span id="cb7-8">)</span></code></pre></div></div>
<p>この場合は、コードを共有してもパスワードは含まれません。</p>
</div>
</div>
</section>
</section>
<section id="データベースとテーブルの作成" class="level3">
<h3 class="anchored" data-anchor-id="データベースとテーブルの作成">1.3 データベースとテーブルの作成</h3>
<p>実際にデータベースとテーブルを作成してみます。</p>
<p>Rでは<code>dbExecute()</code>関数を使ってSQLコマンドを実行できます。SQLコマンドに詳しくない場合は、Rの場合のコードを書いてAIに変換してもらうのがおすすめです（笑）</p>
<section id="新しいデータベースの作成" class="level4">
<h4 class="anchored" data-anchor-id="新しいデータベースの作成">新しいデータベースの作成</h4>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb8" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb8-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(DBI)</span>
<span id="cb8-2"></span>
<span id="cb8-3">con <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">dbConnect</span>(</span>
<span id="cb8-4">  RPostgres<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">Postgres</span>(),</span>
<span id="cb8-5">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">dbname =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"postgres"</span>,</span>
<span id="cb8-6">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">host =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"localhost"</span>,</span>
<span id="cb8-7">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">port =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5432</span>,</span>
<span id="cb8-8">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">user =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"postgres"</span>,</span>
<span id="cb8-9">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">password =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"your_password"</span></span>
<span id="cb8-10">)</span>
<span id="cb8-11"></span>
<span id="cb8-12"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 新しいデータベースを作成</span></span>
<span id="cb8-13"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">dbExecute</span>(con, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"CREATE DATABASE mydb;"</span>)</span>
<span id="cb8-14"></span>
<span id="cb8-15"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 切断</span></span>
<span id="cb8-16"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">dbDisconnect</span>(con)</span></code></pre></div></div>
</section>
<section id="作成したデータベースに接続してテーブルを作成" class="level4">
<h4 class="anchored" data-anchor-id="作成したデータベースに接続してテーブルを作成">作成したデータベースに接続してテーブルを作成</h4>
<p>先ほどは<code>dbname</code>に<code>postgres</code>を指定しましたが、今回は新しく作成した<code>mydb</code>に接続します。</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb9" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb9-1">con <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">dbConnect</span>(</span>
<span id="cb9-2">  RPostgres<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">Postgres</span>(),</span>
<span id="cb9-3">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">dbname =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"mydb"</span>,</span>
<span id="cb9-4">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">host =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"localhost"</span>,</span>
<span id="cb9-5">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">port =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5432</span>,</span>
<span id="cb9-6">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">user =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"postgres"</span>,</span>
<span id="cb9-7">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">password =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"あなたのパスワード"</span></span>
<span id="cb9-8">)</span>
<span id="cb9-9"></span>
<span id="cb9-10"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># テーブルを作成</span></span>
<span id="cb9-11"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">dbExecute</span>(con, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span></span>
<span id="cb9-12"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">  CREATE TABLE users (</span></span>
<span id="cb9-13"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">    id SERIAL PRIMARY KEY,</span></span>
<span id="cb9-14"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">    name VARCHAR(100),</span></span>
<span id="cb9-15"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">    age INTEGER,</span></span>
<span id="cb9-16"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP</span></span>
<span id="cb9-17"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">  );</span></span>
<span id="cb9-18"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>)</span>
<span id="cb9-19"></span>
<span id="cb9-20"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># データを挿入</span></span>
<span id="cb9-21"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">dbExecute</span>(con, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span></span>
<span id="cb9-22"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">  INSERT INTO users (name, age) VALUES</span></span>
<span id="cb9-23"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">  ('Alice', 25),</span></span>
<span id="cb9-24"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">  ('Bob', 30),</span></span>
<span id="cb9-25"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">  ('Charlie', 35);</span></span>
<span id="cb9-26"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>)</span>
<span id="cb9-27"></span>
<span id="cb9-28"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># データを確認</span></span>
<span id="cb9-29"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">dbGetQuery</span>(con, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"SELECT * FROM users;"</span>)</span>
<span id="cb9-30"></span>
<span id="cb9-31"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 切断</span></span>
<span id="cb9-32"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">dbDisconnect</span>(con)</span></code></pre></div></div>
<p>内容は次の通りです。</p>
<ol type="1">
<li><code>users</code>という名前のテーブルを作成</li>
<li><code>id</code>, <code>name</code>, <code>age</code>, <code>created_at</code>の4つのカラムを定義
<ul>
<li>SERIAL PRIMARY KEY: 自動的に連番が振られる主キー</li>
<li>VARCHAR(100): 文字列（最大100文字）</li>
<li>INTEGER: 整数</li>
<li>TIMESTAMP DEFAULT CURRENT_TIMESTAMP: レコード作成日時（デフォルトで現在時刻が入る）</li>
</ul></li>
<li>3件のサンプルデータを挿入
<ul>
<li>Alice（25歳）、Bob（30歳）、Charlie（35歳）</li>
</ul></li>
<li>挿入したデータを取得して表示</li>
</ol>
</section>
<section id="まとめ" class="level4">
<h4 class="anchored" data-anchor-id="まとめ">まとめ</h4>
<p>ここまでで、Windows上でPostgreSQL、R、Pythonの基本的な環境が整いました。</p>
<p><strong>セットアップした内容</strong></p>
<ul>
<li>PostgreSQLのインストールと動作確認</li>
<li>Rのインストールと接続テスト</li>
<li>データベースとテーブルの作成</li>
</ul>
<p>次のセクションでは、より本格的な開発環境を構築するため、WSL上でのセットアップ方法を解説します。</p>
</section>
</section>
</section>
<section id="wsl上でのセットアップ発展編" class="level2">
<h2 class="anchored" data-anchor-id="wsl上でのセットアップ発展編">2. WSL上でのセットアップ（発展編）</h2>
<p>次にWSL（Windows Subsystem for Linux）を使って、より本格的な開発環境を構築します。Linux環境の恩恵を受けながら、Windowsとシームレスに連携できます。</p>
<section id="wslのインストール" class="level3">
<h3 class="anchored" data-anchor-id="wslのインストール">2.1 WSLのインストール</h3>
<section id="wslの有効化" class="level4">
<h4 class="anchored" data-anchor-id="wslの有効化">WSLの有効化</h4>
<p>PowerShellを<strong>管理者として</strong>実行し<sup>3</sup>、以下のコマンドを入力：</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb10" style="background: #f1f3f5;"><pre class="sourceCode powershell code-with-copy"><code class="sourceCode powershell"><span id="cb10-1">wsl <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">--</span>install</span></code></pre></div></div>
<p>インストールが終わると、Linuxディストリビューションのユーザー名とパスワードの作成を求められます。ユーザー名は何でも大丈夫です。パスワードもめちゃくちゃ簡単で問題ありません。</p>
<p>また、パスワードは<strong>画面上には表示されませんが、ちゃんと入力されています</strong>。慌てて何回も入力しないようにしてください。</p>
<p>このコマンドで以下が自動的にインストールされます：</p>
<ul>
<li>WSL 2</li>
<li>Ubuntu（デフォルトのLinuxディストリビューション）</li>
<li>必要な仮想化コンポーネント</li>
</ul>
</section>
<section id="システムの更新" class="level4">
<h4 class="anchored" data-anchor-id="システムの更新">システムの更新</h4>
<p>Ubuntu起動後、まずシステムを最新の状態に更新します：</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb11" style="background: #f1f3f5;"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb11-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sudo</span> apt update</span>
<span id="cb11-2"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sudo</span> apt upgrade <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">-y</span></span></code></pre></div></div>
<p><code>sudo</code>コマンドは管理者権限でコマンドを実行するためのものです。パスワードの入力を求められたら、先ほど設定したパスワードを入力してください。</p>
</section>
</section>
<section id="postgresql-18のインストールwslubuntu" class="level3">
<h3 class="anchored" data-anchor-id="postgresql-18のインストールwslubuntu">2.2 PostgreSQL 18のインストール（WSL/Ubuntu）</h3>
<p>Ubuntu標準のリポジトリではPostgreSQLの古いバージョン（現在は16）がインストールされるため、PostgreSQL公式のAptリポジトリを使用して最新版（PostgreSQL 18）をインストールします。</p>
<section id="postgresql公式リポジトリの設定" class="level4">
<h4 class="anchored" data-anchor-id="postgresql公式リポジトリの設定">PostgreSQL公式リポジトリの設定</h4>
<p>最も簡単な方法は、公式の自動設定スクリプトを使用することです：</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb12" style="background: #f1f3f5;"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb12-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># PostgreSQL公式リポジトリを自動設定</span></span>
<span id="cb12-2"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sudo</span> apt install <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">-y</span> postgresql-common</span>
<span id="cb12-3"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sudo</span> /usr/share/postgresql-common/pgdg/apt.postgresql.org.sh</span></code></pre></div></div>
<p>このスクリプトが自動的にリポジトリ設定とGPGキーのインストールを行います。</p>
</section>
<section id="postgresql-18のインストール" class="level4">
<h4 class="anchored" data-anchor-id="postgresql-18のインストール">PostgreSQL 18のインストール</h4>
<p>リポジトリの設定が完了したら、PostgreSQL 18をインストールします：</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb13" style="background: #f1f3f5;"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb13-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># PostgreSQL 18をインストール</span></span>
<span id="cb13-2"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sudo</span> apt install <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">-y</span> postgresql-18 postgresql-client-18</span></code></pre></div></div>
<p><strong>インストールされる主なパッケージ:</strong> - <code>postgresql-18</code>: PostgreSQLサーバー本体 - <code>postgresql-client-18</code>: クライアントツール（psqlなど）</p>
</section>
<section id="postgresqlサービスの起動" class="level4">
<h4 class="anchored" data-anchor-id="postgresqlサービスの起動">PostgreSQLサービスの起動</h4>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb14" style="background: #f1f3f5;"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb14-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># PostgreSQLサービスの起動</span></span>
<span id="cb14-2"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sudo</span> service postgresql start</span></code></pre></div></div>
</section>
<section id="動作確認-1" class="level4">
<h4 class="anchored" data-anchor-id="動作確認-1">動作確認</h4>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb15" style="background: #f1f3f5;"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb15-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># PostgreSQLのバージョンとクラスター状態を確認</span></span>
<span id="cb15-2"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">pg_lsclusters</span></span></code></pre></div></div>
<p>出力例：</p>
<pre><code>Ver Cluster Port Status Owner    Data directory              Log file
18  main    5432 online postgres /var/lib/postgresql/18/main /var/log/postgresql/postgresql-18-main.log</code></pre>
<p>PostgreSQLに接続：</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb17" style="background: #f1f3f5;"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb17-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># PostgreSQLユーザーに切り替えて接続</span></span>
<span id="cb17-2"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sudo</span> <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">-u</span> postgres psql</span></code></pre></div></div>
<p><code>postgres=#</code> プロンプトが表示されたら成功です。</p>
<p>バージョンを確認するには続けて以下を実行します：</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb18" style="background: #f1f3f5;"><pre class="sourceCode sql code-with-copy"><code class="sourceCode sql"><span id="cb18-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">SELECT</span> version();</span></code></pre></div></div>
<p>出力例：</p>
<pre><code>PostgreSQL 18.1 (Ubuntu 18.1-1.pgdg24.04+2) on x86_64-pc-linux-gnu, compiled by gcc (Ubuntu 13.3.0-6ubuntu2~24.04) 13.3.0, 64-bit</code></pre>
<p>終了する場合は <code>\q</code> と入力します。</p>
</section>
<section id="パスワードの設定" class="level4">
<h4 class="anchored" data-anchor-id="パスワードの設定">パスワードの設定</h4>
<p>PostgreSQLのスーパーユーザー（postgres）にパスワードを設定します：</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb20" style="background: #f1f3f5;"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb20-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sudo</span> <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">-u</span> postgres psql</span></code></pre></div></div>
<p><code>postgres=#</code> プロンプトで以下を実行：</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb21" style="background: #f1f3f5;"><pre class="sourceCode sql code-with-copy"><code class="sourceCode sql"><span id="cb21-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">ALTER</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">USER</span> postgres <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">WITH</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">PASSWORD</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'設定するパスワード'</span>;</span>
<span id="cb21-2">\q</span></code></pre></div></div>
</section>
</section>
<section id="rのインストールwslubuntu" class="level3">
<h3 class="anchored" data-anchor-id="rのインストールwslubuntu">2.3 Rのインストール（WSL/Ubuntu）</h3>
<section id="r本体のインストール" class="level4">
<h4 class="anchored" data-anchor-id="r本体のインストール">R本体のインストール</h4>
<p>最新版のRをインストールするため、CRANのリポジトリを追加します：</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb22" style="background: #f1f3f5;"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb22-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sudo</span> apt update <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">-qq</span></span>
<span id="cb22-2"></span>
<span id="cb22-3"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 必要なパッケージをインストール</span></span>
<span id="cb22-4"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sudo</span> apt install <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">--no-install-recommends</span> software-properties-common dirmngr</span>
<span id="cb22-5"></span>
<span id="cb22-6"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># CRANのGPGキーを追加</span></span>
<span id="cb22-7"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">wget</span> <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">-qO-</span> https://cloud.r-project.org/bin/linux/ubuntu/marutter_pubkey.asc <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">|</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sudo</span> tee <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">-a</span> /etc/apt/trusted.gpg.d/cran_ubuntu_key.asc</span>
<span id="cb22-8"></span>
<span id="cb22-9"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># CRANのリポジトリを追加</span></span>
<span id="cb22-10"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sudo</span> add-apt-repository <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"deb https://cloud.r-project.org/bin/linux/ubuntu </span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">$(</span><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">lsb_release</span> <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">-cs</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">)</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">-cran40/"</span></span>
<span id="cb22-11"></span>
<span id="cb22-12"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># パッケージリストを更新してRをインストール</span></span>
<span id="cb22-13"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sudo</span> apt install <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">--no-install-recommends</span> r-base <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">-y</span></span></code></pre></div></div>
</section>
<section id="動作確認-2" class="level4">
<h4 class="anchored" data-anchor-id="動作確認-2">動作確認</h4>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb23" style="background: #f1f3f5;"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb23-1"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">R</span> <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">--version</span></span></code></pre></div></div>
<p>バージョン情報が表示されればインストール成功です。</p>
</section>
<section id="必要なシステムライブラリのインストール" class="level4">
<h4 class="anchored" data-anchor-id="必要なシステムライブラリのインストール">必要なシステムライブラリのインストール</h4>
<p>RからPostgreSQLに接続するために必要なライブラリをインストール：</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb24" style="background: #f1f3f5;"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb24-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sudo</span> apt install <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">-y</span> libpq-dev libssl-dev libcurl4-openssl-dev libxml2-dev</span></code></pre></div></div>
</section>
</section>
<section id="rstudio-serverのインストールwslubuntu" class="level3">
<h3 class="anchored" data-anchor-id="rstudio-serverのインストールwslubuntu">2.4 RStudio Serverのインストール（WSL/Ubuntu）</h3>
<section id="rstudio-serverのダウンロードとインストール" class="level4">
<h4 class="anchored" data-anchor-id="rstudio-serverのダウンロードとインストール">RStudio Serverのダウンロードとインストール</h4>
<p>RStudio Serverの最新バージョンを<a href="https://posit.co/download/rstudio-server/">RStudio公式サイト</a>から確認し、以下のコマンドでダウンロードとインストールを行います：</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb25" style="background: #f1f3f5;"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb25-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sudo</span> apt-get install gdebi-core</span>
<span id="cb25-2"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">wget</span> https://download2.rstudio.org/server/jammy/amd64/rstudio-server-2025.09.2-418-amd64.deb</span>
<span id="cb25-3"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sudo</span> gdebi rstudio-server-2025.09.2-418-amd64.deb</span></code></pre></div></div>
</section>
<section id="rstudio-serverの起動" class="level4">
<h4 class="anchored" data-anchor-id="rstudio-serverの起動">RStudio Serverの起動</h4>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb26" style="background: #f1f3f5;"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb26-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sudo</span> rstudio-server start</span></code></pre></div></div>
</section>
<section id="rstudio-serverへのアクセス" class="level4">
<h4 class="anchored" data-anchor-id="rstudio-serverへのアクセス">RStudio Serverへのアクセス</h4>
<p>ブラウザで<code>localhost:8787</code>にアクセスし、WSLのユーザー名とパスワードでログインします。</p>
<p>すると、RStudioのウェブインターフェースが表示され、Rの開発環境が利用可能になります。</p>
</section>
</section>
<section id="rからpostgresqlに接続wsl" class="level3">
<h3 class="anchored" data-anchor-id="rからpostgresqlに接続wsl">2.5 RからPostgreSQLに接続（WSL）</h3>
<section id="rの起動とパッケージのインストール" class="level4">
<h4 class="anchored" data-anchor-id="rの起動とパッケージのインストール">Rの起動とパッケージのインストール</h4>
<p>RStudio ServerあるいはVSCodeでWSLに接続<sup>4</sup>の上Rコンソールを開き、以下を実行：</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb27" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb27-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">install.packages</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"DBI"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"RPostgres"</span>))</span></code></pre></div></div>
</section>
<section id="接続テスト-1" class="level4">
<h4 class="anchored" data-anchor-id="接続テスト-1">接続テスト</h4>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb28" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb28-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(DBI)</span>
<span id="cb28-2"></span>
<span id="cb28-3"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># データベースに接続</span></span>
<span id="cb28-4">con <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">dbConnect</span>(</span>
<span id="cb28-5">  RPostgres<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">Postgres</span>(),</span>
<span id="cb28-6">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">dbname =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"postgres"</span>,</span>
<span id="cb28-7">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">host =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"localhost"</span>,</span>
<span id="cb28-8">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">port =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5432</span>,</span>
<span id="cb28-9">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">user =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"postgres"</span>,</span>
<span id="cb28-10">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">password =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"あなたのパスワード"</span></span>
<span id="cb28-11">)</span>
<span id="cb28-12"></span>
<span id="cb28-13"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 接続確認</span></span>
<span id="cb28-14"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">dbGetQuery</span>(con, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"SELECT version();"</span>)</span>
<span id="cb28-15"></span>
<span id="cb28-16"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 切断</span></span>
<span id="cb28-17"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">dbDisconnect</span>(con)</span></code></pre></div></div>
</section>
</section>
<section id="データベースとテーブルの作成wsl" class="level3">
<h3 class="anchored" data-anchor-id="データベースとテーブルの作成wsl">2.6 データベースとテーブルの作成（WSL）</h3>
<p>Windows版と同じ手順でデータベースとテーブルを作成できます。</p>
<section id="新しいデータベースの作成-1" class="level4">
<h4 class="anchored" data-anchor-id="新しいデータベースの作成-1">新しいデータベースの作成</h4>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb29" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb29-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(DBI)</span>
<span id="cb29-2"></span>
<span id="cb29-3">con <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">dbConnect</span>(</span>
<span id="cb29-4">  RPostgres<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">Postgres</span>(),</span>
<span id="cb29-5">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">dbname =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"postgres"</span>,</span>
<span id="cb29-6">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">host =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"localhost"</span>,</span>
<span id="cb29-7">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">port =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5432</span>,</span>
<span id="cb29-8">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">user =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"postgres"</span>,</span>
<span id="cb29-9">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">password =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"あなたのパスワード"</span></span>
<span id="cb29-10">)</span>
<span id="cb29-11"></span>
<span id="cb29-12"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 新しいデータベースを作成</span></span>
<span id="cb29-13"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">dbExecute</span>(con, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"CREATE DATABASE mydb;"</span>)</span>
<span id="cb29-14"></span>
<span id="cb29-15"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 切断</span></span>
<span id="cb29-16"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">dbDisconnect</span>(con)</span></code></pre></div></div>
</section>
<section id="テーブルの作成とデータ挿入" class="level4">
<h4 class="anchored" data-anchor-id="テーブルの作成とデータ挿入">テーブルの作成とデータ挿入</h4>
<p>Windows版と同様に、usersテーブルを作成してみます：</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb30" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb30-1">con <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">dbConnect</span>(</span>
<span id="cb30-2">  RPostgres<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">Postgres</span>(),</span>
<span id="cb30-3">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">dbname =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"mydb"</span>,</span>
<span id="cb30-4">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">host =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"localhost"</span>,</span>
<span id="cb30-5">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">port =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5432</span>,</span>
<span id="cb30-6">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">user =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"postgres"</span>,</span>
<span id="cb30-7">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">password =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"あなたのパスワード"</span></span>
<span id="cb30-8">)</span>
<span id="cb30-9"></span>
<span id="cb30-10"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># テーブルを作成</span></span>
<span id="cb30-11"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">dbExecute</span>(con, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span></span>
<span id="cb30-12"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">  CREATE TABLE users (</span></span>
<span id="cb30-13"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">    id SERIAL PRIMARY KEY,</span></span>
<span id="cb30-14"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">    name VARCHAR(100),</span></span>
<span id="cb30-15"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">    age INTEGER,</span></span>
<span id="cb30-16"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP</span></span>
<span id="cb30-17"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">  );</span></span>
<span id="cb30-18"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>)</span>
<span id="cb30-19"></span>
<span id="cb30-20"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># データを挿入</span></span>
<span id="cb30-21"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">dbExecute</span>(con, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span></span>
<span id="cb30-22"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">  INSERT INTO users (name, age) VALUES</span></span>
<span id="cb30-23"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">  ('Alice', 25),</span></span>
<span id="cb30-24"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">  ('Bob', 30),</span></span>
<span id="cb30-25"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">  ('Charlie', 35);</span></span>
<span id="cb30-26"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>)</span>
<span id="cb30-27"></span>
<span id="cb30-28"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># データを確認</span></span>
<span id="cb30-29"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">dbGetQuery</span>(con, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"SELECT * FROM users;"</span>)</span>
<span id="cb30-30"></span>
<span id="cb30-31"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 切断</span></span>
<span id="cb30-32"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">dbDisconnect</span>(con)</span></code></pre></div></div>
</section>
</section>
<section id="wsl環境のファイル操作" class="level3">
<h3 class="anchored" data-anchor-id="wsl環境のファイル操作">2.7 WSL環境のファイル操作</h3>
<section id="windowsからwslのファイルにアクセス" class="level4">
<h4 class="anchored" data-anchor-id="windowsからwslのファイルにアクセス">WindowsからWSLのファイルにアクセス</h4>
<p>エクスプローラーのアドレスバーに以下を入力：</p>
<pre><code>\\wsl$\Ubuntu\home\あなたのユーザー名</code></pre>
<p>これでWSL内のファイルをWindows側から操作できます。</p>
<p>エクスプローラーのサイドバーの最下部の「Linux」からもアクセス可能です。</p>
</section>
</section>
<section id="wsl環境の便利なtips" class="level3">
<h3 class="anchored" data-anchor-id="wsl環境の便利なtips">2.8 WSL環境の便利なTips</h3>
<section id="wslの再起動" class="level4">
<h4 class="anchored" data-anchor-id="wslの再起動">WSLの再起動</h4>
<p>PostgreSQLが動かなくなった場合などは、WSLを再起動してみてください：</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb32" style="background: #f1f3f5;"><pre class="sourceCode powershell code-with-copy"><code class="sourceCode powershell"><span id="cb32-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># PowerShellで実行</span></span>
<span id="cb32-2">wsl <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">--</span>shutdown</span></code></pre></div></div>
<p>その後、Ubuntuを再起動してPostgreSQLを起動：</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb33" style="background: #f1f3f5;"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb33-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sudo</span> service postgresql start</span></code></pre></div></div>
</section>
<section id="vscodeでpostgresqlに接続" class="level4">
<h4 class="anchored" data-anchor-id="vscodeでpostgresqlに接続">VSCodeでPostgreSQLに接続</h4>
<p>Rの操作自体はRStudio Serverで行ってもVSCodeでも行ってもどちらでもよいのですが、VSCodeにはPostgreSQL拡張機能があり、データベースの管理が便利です。WindowsのようにpgAdminを使えない代わりに、VSCodeのPostgreSQL拡張機能を利用してテーブルリストなどを確認できます。</p>
<p>VSCodeサイドバーの拡張機能から「ms-ossdata.vscode-pgsql」を検索し、インストールしてください。</p>
<p>インストール終了後、サイドバーにPostgreSQLのアイコンが表示されるのでクリックし、「接続」の右にある「新しい接続を追加する」のアイコンから接続情報を入力します。</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://yo5uke.com/pages/tips/2025/12/251201_env/image/vscode_extension.png" class="img-fluid figure-img"></p>
<figcaption>VSCode PostgreSQL拡張機能から接続</figcaption>
</figure>
</div>
<ul>
<li>サーバー名：localhost</li>
<li>ユーザー名：postgres</li>
<li>パスワード：設定したパスワード</li>
<li>データベース名：（例）mydb</li>
</ul>
<p>記入したらテスト接続をクリックし、成功すれば保存して接続を選択します。</p>
<p>接続後、サイドバーのPostgreSQLアイコンをクリックすると、データベースやテーブルの一覧が表示されます。「サーバー」→「localhost」→「Dataases」→「mydb」→「Schemas」→「public」→「Tables」でテーブル一覧を確認できます。</p>
<p>新しくテーブルを追加した場合などは、右クリックして「最新の情報に更新」を選択して更新を反映してください。</p>
</section>
<section id="まとめ-1" class="level4">
<h4 class="anchored" data-anchor-id="まとめ-1">まとめ</h4>
<p>ここまでで、WSL上でPostgreSQL、Rを使った本格的な開発環境が整いました。</p>
<p><strong>セットアップした内容</strong></p>
<ul>
<li>WSL 2とUbuntuのインストール</li>
<li>PostgreSQLのインストール</li>
<li>Rのインストールと接続</li>
<li>RStudio Serverの設定</li>
<li>データベースとテーブルの作成</li>
<li>VSCodeのPostgreSQL拡張機能の利用</li>
</ul>
<p>ここまでで基本的な設定は完了です。次に実際にデータを取り込んで分析を始めてみましょう。</p>
</section>
</section>
</section>
<section id="データを投入する" class="level2">
<h2 class="anchored" data-anchor-id="データを投入する">データを投入する</h2>
<p>PostgreSQLにデータを投入する方法はいくつかありますが、Rから直接データフレームをテーブルに書き込む方法が最も簡単です。</p>
<ol type="1">
<li>Rでデータを読み込む（例：CSVファイル）</li>
<li><code>dbWriteTable()</code>関数を使ってデータフレームをPostgreSQLに書き込む</li>
</ol>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb34" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb34-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(DBI)</span>
<span id="cb34-2"></span>
<span id="cb34-3"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># データベースに接続</span></span>
<span id="cb34-4">con <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">dbConnect</span>(</span>
<span id="cb34-5">  RPostgres<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">Postgres</span>(),</span>
<span id="cb34-6">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">dbname =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"mydb"</span>,</span>
<span id="cb34-7">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">host =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"localhost"</span>,</span>
<span id="cb34-8">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">port =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5432</span>,</span>
<span id="cb34-9">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">user =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"postgres"</span>,</span>
<span id="cb34-10">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">password =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"あなたのパスワード"</span></span>
<span id="cb34-11">)</span>
<span id="cb34-12"></span>
<span id="cb34-13"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(tidyverse)</span>
<span id="cb34-14"></span>
<span id="cb34-15"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># CSVファイルを読み込む</span></span>
<span id="cb34-16">data <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">read_csv</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"path/to/your/data.csv"</span>)</span>
<span id="cb34-17"></span>
<span id="cb34-18"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># データフレームをPostgreSQLに書き込む</span></span>
<span id="cb34-19"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">dbWriteTable</span>(con, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"my_table"</span>, data, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">overwrite =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">TRUE</span>)</span>
<span id="cb34-20"></span>
<span id="cb34-21"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># データを確認</span></span>
<span id="cb34-22"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">dbGetQuery</span>(con, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"SELECT * FROM my_table LIMIT 5;"</span>)</span>
<span id="cb34-23"></span>
<span id="cb34-24"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 切断</span></span>
<span id="cb34-25"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">dbDisconnect</span>(con)</span></code></pre></div></div>
<p><code>dbWriteTable()</code>がテーブルを作成する関数で、<code>overwrite = TRUE</code>オプションを指定すると、既存のテーブルがあれば上書きされます。</p>
<p><code>dbGetQuery()</code>では、<code>my_table</code>から最初の5行を取得して表示しています。</p>
</section>
<section id="dbplyrでpostgresqlを操作する" class="level2">
<h2 class="anchored" data-anchor-id="dbplyrでpostgresqlを操作する">{dbplyr}でPostgreSQLを操作する</h2>
<p>Rのデータハンドリングではおなじみの<code>dplyr</code>パッケージを使って、PostgreSQL上のデータを操作することもできます。データベースを操作するための<code>dbplyr</code>パッケージが動いて通常の<code>dplyr</code>の文法でSQLクエリを生成してくれます。</p>
<p><code>dbplyr</code>は<code>dplyr</code>の依存パッケージであるため、<code>dplyr</code>を読み込めば自動的に利用可能です。</p>
<p>データベース上のテーブルは<code>tbl()</code>関数で参照し、<code>collect()</code>関数でRのデータフレームとして取得します。</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb35" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb35-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(DBI)</span>
<span id="cb35-2"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(dplyr)</span>
<span id="cb35-3"></span>
<span id="cb35-4"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># データベースに接続</span></span>
<span id="cb35-5">con <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">dbConnect</span>(</span>
<span id="cb35-6">  RPostgres<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">Postgres</span>(),</span>
<span id="cb35-7">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">dbname =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"mydb"</span>,</span>
<span id="cb35-8">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">host =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"localhost"</span>,</span>
<span id="cb35-9">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">port =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5432</span>,</span>
<span id="cb35-10">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">user =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"postgres"</span>,</span>
<span id="cb35-11">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">password =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"あなたのパスワード"</span></span>
<span id="cb35-12">)</span></code></pre></div></div>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb36" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb36-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># テーブルを参照</span></span>
<span id="cb36-2">my_table <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">tbl</span>(con, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"my_table"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span></span>
<span id="cb36-3">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">filter</span>(column_name <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">100</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 条件でフィルタリング</span></span>
<span id="cb36-4">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">select</span>(column1, column2) <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 必要なカラムを選択</span></span>
<span id="cb36-5"></span>
<span id="cb36-6"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Rのデータフレームとして取得</span></span>
<span id="cb36-7">result <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> my_table <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">collect</span>()</span>
<span id="cb36-8"></span>
<span id="cb36-9"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 結果を表示</span></span>
<span id="cb36-10"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">print</span>(result)</span></code></pre></div></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 2 × 2
  column1 column2
  &lt;chr&gt;     &lt;dbl&gt;
1 B            20
2 C            30</code></pre>
</div>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb38" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb38-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 切断</span></span>
<span id="cb38-2"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">dbDisconnect</span>(con)</span></code></pre></div></div>
</div>
<p>このコードでは、<code>my_table</code>テーブルから<code>column_name</code>が100より大きい行をフィルタリングし、<code>column1</code>と<code>column2</code>のカラムだけを選択しています。最後に<code>collect()</code>でRのデータフレームとして取得し、表示しています。</p>
<p>このように通常の<code>dplyr</code>の文法でPostgreSQL上のデータを操作できるため、SQLを直接書かなくても高度なデータ操作が可能です。1からSQLを学ばなくてもよいのは大きいですよね！</p>
<p>重要な点は、<strong><code>collect()</code>を呼び出すまでは実際のデータはRに取り込まれず、SQLクエリ<sup>5</sup>がデータベース側で実行される</strong>ということです。データベース側で実行されることで大規模データを効率的に処理できます。</p>
<p>また、注意点として、<strong><code>collect()</code>を呼び出すまでは<code>dplyr</code>に含まれる関数しか使うことができず、他のパッケージの関数は使えない</strong>ことが挙げられます。例えば<code>collect()</code>前に<code>pivot_longer()</code>を使おうとするとエラーになります。これは<code>tidyr</code>パッケージの関数だからです。</p>
</section>
<section id="gisのためのpostgis" class="level2">
<h2 class="anchored" data-anchor-id="gisのためのpostgis">GISのためのPostGIS</h2>
<p>PostGISは、PostgreSQLの拡張機能で、地理情報システム（GIS）データを扱うための強力なツールです。PostGISを利用することで、空間データの格納、クエリ、解析が可能になります。</p>
<p>ここからは、WSL/Ubuntu環境でPostGISをインストールする手順を解説します。</p>
<section id="postgisのインストールwslubuntu" class="level3">
<h3 class="anchored" data-anchor-id="postgisのインストールwslubuntu">PostGISのインストール（WSL/Ubuntu）</h3>
<p>PostgreSQLにPostGIS拡張を追加するには、以下のコマンドを実行します：</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb39" style="background: #f1f3f5;"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb39-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sudo</span> apt install postgresql-18-postgis-3 postgresql-18-postgis-3-scripts <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">-y</span></span></code></pre></div></div>
<section id="データベースでpostgisを有効化" class="level4">
<h4 class="anchored" data-anchor-id="データベースでpostgisを有効化">データベースでPostGISを有効化</h4>
<p>PostGISをインストールしたら、使用するデータベースでPostGIS拡張を有効にします：</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb40" style="background: #f1f3f5;"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb40-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># PostgreSQLに接続</span></span>
<span id="cb40-2"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sudo</span> <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">-u</span> postgres psql <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">-d</span> mydb</span></code></pre></div></div>
<p>データベース内で以下のSQLコマンドを実行：</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb41" style="background: #f1f3f5;"><pre class="sourceCode sql code-with-copy"><code class="sourceCode sql"><span id="cb41-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-- PostGIS拡張を有効化</span></span>
<span id="cb41-2"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">CREATE</span> EXTENSION postgis;</span>
<span id="cb41-3"></span>
<span id="cb41-4"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-- インストールされた拡張を確認</span></span>
<span id="cb41-5">\dx</span>
<span id="cb41-6"></span>
<span id="cb41-7"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-- PostGISのバージョンを確認</span></span>
<span id="cb41-8"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">SELECT</span> PostGIS_version();</span>
<span id="cb41-9"></span>
<span id="cb41-10"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-- 終了</span></span>
<span id="cb41-11">\q</span></code></pre></div></div>
<p><code>\dx</code>コマンドで<code>postgis</code>が表示されれば、拡張が正常にインストールされています。</p>
<p>記事を書いている時点での最新バージョンは3.6.1です。</p>
<pre><code>mydb=# SELECT PostGIS_version();
            postgis_version            
---------------------------------------
 3.6 USE_GEOS=1 USE_PROJ=1 USE_STATS=1</code></pre>
</section>
</section>
<section id="rからpostgisを利用する" class="level3">
<h3 class="anchored" data-anchor-id="rからpostgisを利用する">RからPostGISを利用する</h3>
<p>RからPostGIS機能を使うには、<code>sf</code>パッケージが便利です。</p>
<section id="必要なパッケージのインストール" class="level4">
<h4 class="anchored" data-anchor-id="必要なパッケージのインストール">必要なパッケージのインストール</h4>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb43" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb43-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">install.packages</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"sf"</span>)</span></code></pre></div></div>
</section>
<section id="空間データの書き込みと読み取り" class="level4">
<h4 class="anchored" data-anchor-id="空間データの書き込みと読み取り">空間データの書き込みと読み取り</h4>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb44" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb44-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(DBI)</span>
<span id="cb44-2"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(sf)</span>
<span id="cb44-3"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(dplyr)</span>
<span id="cb44-4"></span>
<span id="cb44-5"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># データベースに接続</span></span>
<span id="cb44-6">con <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">dbConnect</span>(</span>
<span id="cb44-7">  RPostgres<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">Postgres</span>(),</span>
<span id="cb44-8">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">dbname =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"mydb"</span>,</span>
<span id="cb44-9">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">host =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"localhost"</span>,</span>
<span id="cb44-10">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">port =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5432</span>,</span>
<span id="cb44-11">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">user =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"postgres"</span>,</span>
<span id="cb44-12">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">password =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"設定したパスワード"</span></span>
<span id="cb44-13">)</span>
<span id="cb44-14"></span>
<span id="cb44-15"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># サンプルの空間データを作成（東京の主要地点）</span></span>
<span id="cb44-16">points <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">data.frame</span>(</span>
<span id="cb44-17">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">name =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"東京駅"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"渋谷駅"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"新宿駅"</span>),</span>
<span id="cb44-18">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">lon =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">139.7671</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">139.7016</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">139.7006</span>),</span>
<span id="cb44-19">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">lat =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">35.6812</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">35.6580</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">35.6938</span>)</span>
<span id="cb44-20">)</span>
<span id="cb44-21"></span>
<span id="cb44-22"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># sfオブジェクトに変換（EPSG:4326はWGS84座標系）</span></span>
<span id="cb44-23">points_sf <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">st_as_sf</span>(points, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">coords =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"lon"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"lat"</span>), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">crs =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4326</span>)</span>
<span id="cb44-24"></span>
<span id="cb44-25"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># PostGISテーブルとして書き込み</span></span>
<span id="cb44-26"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">st_write</span>(points_sf, con, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"stations"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">delete_layer =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">TRUE</span>)</span>
<span id="cb44-27"></span>
<span id="cb44-28"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># データを読み取り</span></span>
<span id="cb44-29">stations <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">st_read</span>(con, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"stations"</span>)</span>
<span id="cb44-30"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">print</span>(stations)</span>
<span id="cb44-31"></span>
<span id="cb44-32"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 切断</span></span>
<span id="cb44-33"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">dbDisconnect</span>(con)</span></code></pre></div></div>
<div class="cell">
<div class="cell-output cell-output-stdout">
<pre><code>Simple feature collection with 3 features and 1 field
Geometry type: POINT
Dimension:     XY
Bounding box:  xmin: 139.7006 ymin: 35.658 xmax: 139.7671 ymax: 35.6938
Geodetic CRS:  WGS 84
    name                 geometry
1 東京駅 POINT (139.7671 35.6812)
2 渋谷駅  POINT (139.7016 35.658)
3 新宿駅 POINT (139.7006 35.6938)</code></pre>
</div>
</div>
</section>
<section id="postgisの空間関数を使う" class="level4">
<h4 class="anchored" data-anchor-id="postgisの空間関数を使う">PostGISの空間関数を使う</h4>
<p>PostGISには様々な空間分析関数があります。例えば、2点間の距離を計算：</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb46" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb46-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(DBI)</span>
<span id="cb46-2"></span>
<span id="cb46-3">con <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">dbConnect</span>(</span>
<span id="cb46-4">  RPostgres<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">Postgres</span>(),</span>
<span id="cb46-5">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">dbname =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"mydb"</span>,</span>
<span id="cb46-6">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">host =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"localhost"</span>,</span>
<span id="cb46-7">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">port =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5432</span>,</span>
<span id="cb46-8">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">user =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"postgres"</span>,</span>
<span id="cb46-9">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">password =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"設定したパスワード"</span></span>
<span id="cb46-10">)</span>
<span id="cb46-11"></span>
<span id="cb46-12"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 東京駅と渋谷駅の距離を計算（メートル単位）</span></span>
<span id="cb46-13"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># ST_Distance()の前に地理座標系に変換（::geography）</span></span>
<span id="cb46-14">query <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span></span>
<span id="cb46-15"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">  SELECT </span></span>
<span id="cb46-16"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">    a.name AS from_station,</span></span>
<span id="cb46-17"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">    b.name AS to_station,</span></span>
<span id="cb46-18"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">    ST_Distance(</span></span>
<span id="cb46-19"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">      a.geometry::geography,</span></span>
<span id="cb46-20"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">      b.geometry::geography</span></span>
<span id="cb46-21"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">    ) AS distance_meters</span></span>
<span id="cb46-22"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">  FROM stations a, stations b</span></span>
<span id="cb46-23"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">  WHERE a.name = '東京駅' AND b.name = '渋谷駅';</span></span>
<span id="cb46-24"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span></span>
<span id="cb46-25"></span>
<span id="cb46-26">result <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">dbGetQuery</span>(con, query)</span>
<span id="cb46-27"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">print</span>(result)</span>
<span id="cb46-28"></span>
<span id="cb46-29"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">dbDisconnect</span>(con)</span></code></pre></div></div>
<div class="cell">
<div class="cell-output cell-output-stdout">
<pre><code>  from_station to_station distance_meters
1       東京駅     渋谷駅        6464.826</code></pre>
</div>
</div>
<p>Query内ではSQL文を書き、<code>ST_Distance()</code>関数を使って2つの地点間の距離を計算しています。<code>::geography</code>キャストを使うことで、地理座標系での正確な距離計算が可能になります。</p>
</section>
<section id="postgisの便利な関数" class="level4">
<h4 class="anchored" data-anchor-id="postgisの便利な関数">PostGISの便利な関数</h4>
<p>PostGISには多数の空間関数があります。代表的なものを紹介します：</p>
<ul>
<li><code>ST_Distance()</code>: 2つのジオメトリ間の距離を計算</li>
<li><code>ST_Buffer()</code>: 指定した距離のバッファ（緩衝地帯）を作成</li>
<li><code>ST_Intersects()</code>: 2つのジオメトリが交差するかを判定</li>
<li><code>ST_Within()</code>: あるジオメトリが別のジオメトリ内に含まれるかを判定</li>
<li><code>ST_Area()</code>: ポリゴンの面積を計算</li>
<li><code>ST_Length()</code>: ラインの長さを計算</li>
</ul>
<p>これらの関数を組み合わせることで、複雑な空間分析が可能になります。</p>
</section>
</section>
<section id="postgisのまとめ" class="level3">
<h3 class="anchored" data-anchor-id="postgisのまとめ">PostGISのまとめ</h3>
<p>PostGISを使うことで、PostgreSQL上で以下のような空間データ分析が可能になります：</p>
<ul>
<li>緯度経度データの格納と管理</li>
<li>点・線・ポリゴンなどの幾何データの操作</li>
<li>距離計算、バッファ分析、空間結合</li>
<li>大規模な空間データの効率的な処理</li>
</ul>
<p>特に、メモリに収まりきらない大規模な空間データを扱う場合、PostGISは非常に強力なツールとなります。</p>
</section>
</section>
<section id="おわりに" class="level2">
<h2 class="anchored" data-anchor-id="おわりに">おわりに</h2>
<p>本記事では、Windows環境でRとPostgreSQLを中心とした開発環境を構築する方法を、Windows版とWSL版の2つのアプローチでまとめました。</p>
<p><strong>Windows版の特徴</strong></p>
<ul>
<li>GUIツールが使いやすく、初心者にも優しい</li>
<li>インストールが簡単で、すぐに始められる</li>
<li>pgAdmin 4でデータベースを視覚的に管理可能</li>
</ul>
<p><strong>WSL版の特徴</strong></p>
<ul>
<li>Linux環境の恩恵を受けられる</li>
<li>aptパッケージマネージャーでPostGISなどの拡張機能を簡単にインストール可能</li>
<li>Dockerやサーバー環境との互換性が高い</li>
<li>高速なI/O処理とデータベース操作</li>
</ul>
<p>どちらの環境でも、RからPostgreSQLを操作する基本的な手順は同じです。まずはWindows版で試してみて、必要に応じてWSL版に移行するのがおすすめです。</p>
<p>PostgreSQLとPostGISを活用することで、大規模データの管理や空間データの高度な分析が可能になります。ぜひ実際のプロジェクトで活用してみてください。</p>


<!-- -->

</section>


<div id="quarto-appendix" class="default"><section id="footnotes" class="footnotes footnotes-end-of-document"><h2 class="anchored quarto-appendix-heading">注</h2>

<ol>
<li id="fn1"><p>会社で教えてくださった上司・先輩がポスグレと呼んでいるので、僕もポスグレ呼びをしています。↩︎</p></li>
<li id="fn2"><p>シンプルなものでもいけます。↩︎</p></li>
<li id="fn3"><p>右クリックで「管理者として実行」を選択してください。↩︎</p></li>
<li id="fn4"><p><span class="visually-hidden">Ctrl-Shift-P</span>で「wsl: connect to wsl」と検索し選択することで接続できます。↩︎</p></li>
<li id="fn5"><p>クエリとは、データベースに対して行う問い合わせや命令のことです。↩︎</p></li>
</ol>
</section></div> ]]></description>
  <category>R</category>
  <category>WSL</category>
  <category>Windows</category>
  <category>SQL</category>
  <category>GIS</category>
  <guid>https://yo5uke.com/pages/tips/2025/12/251201_env/</guid>
  <pubDate>Sun, 30 Nov 2025 15:00:00 GMT</pubDate>
  <media:content url="https://yo5uke.com/pages/tips/2025/12/251201_env/image/thumbnail.png" medium="image" type="image/png" height="77" width="144"/>
</item>
<item>
  <title>【R】polarsでデータ処理を高速化する</title>
  <link>https://yo5uke.com/pages/tips/2025/11/251125_r_polars/</link>
  <description><![CDATA[ 

<div class="social-share-buttons">
  <!-- Twitter (X) -->
  <a href="" id="js-share-twitter" class="share_button ri--twitter-x-fill" target="_blank" rel="nofollow noopener noreferrer"></a>

  <!-- Bluesky -->
  <a href="" id="js-share-bluesky" class="share_button ri--bluesky-fill" target="_blank" rel="nofollow noopener noreferrer"></a>
</div>

<script>
  const twitterUsername = "@5uke_y";
  const blueskyUsername = "@5uke.bsky.social";

  const share_url = encodeURIComponent(location.href);
  const share_title = document.title;

  // Twitter (X)
  document.getElementById('js-share-twitter').setAttribute(
    "href",
    "https://twitter.com/share?url=" + share_url + "&text=" + share_title + " " + encodeURIComponent(twitterUsername) + " より" +
    "&hashtags=rstats"
  );

  // Bluesky
  document.getElementById('js-share-bluesky').setAttribute(
    "href",
    "https://bsky.app/intent/compose?text=" + share_title + " " + share_url + " " + encodeURIComponent(blueskyUsername) + " より"
  );
</script>





<section id="はじめに" class="level2">
<h2 class="anchored" data-anchor-id="はじめに">はじめに</h2>
<p>Rでデータ処理を行う際、メモリ不足や処理速度の問題に悩まされることがあります。特に大規模データを扱う場合、{tidyverse}の関数だけでは限界を感じることも少なくありません。</p>
<p>そこで注目されているのが<strong>{polars}</strong>です。{polars}はRustで書かれた高速なデータフレームライブラリで、大規模データの処理を効率的に行うことができます。この記事では、Rで{polars}を使う方法と、tidyverseの文法で使える{tidypolars}について解説します。</p>
</section>
<section id="polarsとは" class="level2">
<h2 class="anchored" data-anchor-id="polarsとは">polarsとは</h2>
<p>polarsは、Rustで実装されたデータフレームライブラリです。Pythonでよく知られていますが、R版も提供されており、以下のような特徴があります：</p>
<ul>
<li><strong>高速な処理</strong>: Rustベースで実装されており、{dplyr}や{data.table}よりも高速</li>
<li><strong>遅延評価</strong>: クエリを最適化してから実行するため、効率的</li>
<li><strong>メモリ効率</strong>: 列指向フォーマットのApache Arrowを内部で使用</li>
<li><strong>並列処理</strong>: マルチコアを活用した並列処理が自動的に行われる</li>
</ul>
<p>{polars}の独自の文法は、メソッドチェーンを使ったものですが、{tidyverse}に慣れた人には少し馴染みにくいかもしれません。そこで登場するのが{tidypolars}です。</p>
</section>
<section id="インストール" class="level2">
<h2 class="anchored" data-anchor-id="インストール">インストール</h2>
<section id="polarsのインストール" class="level3">
<h3 class="anchored" data-anchor-id="polarsのインストール">polarsのインストール</h3>
<p>{polars}はCRANにはまだ登録されていないため、以下のコマンドでインストールします。</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb1" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">Sys.setenv</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">NOT_CRAN =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"true"</span>)</span>
<span id="cb1-2"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">install.packages</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"polars"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">repos =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"https://community.r-multiverse.org"</span>)</span>
<span id="cb1-3"></span>
<span id="cb1-4"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># または開発版</span></span>
<span id="cb1-5"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># install.packages('polars', repos = c("https://rpolars.r-universe.dev", "https://cloud.r-project.org"))</span></span></code></pre></div></div>
</div>
</section>
<section id="tidypolarsのインストール" class="level3">
<h3 class="anchored" data-anchor-id="tidypolarsのインストール">tidypolarsのインストール</h3>
<p>{tidypolars}もCRANには登録されていないため、同様にインストールします。</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb2" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">Sys.setenv</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">NOT_CRAN =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"true"</span>)</span>
<span id="cb2-2"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">install.packages</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"tidypolars"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">repos =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"https://community.r-multiverse.org"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"https://cloud.r-project.org"</span>))</span>
<span id="cb2-3"></span>
<span id="cb2-4"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># または開発版</span></span>
<span id="cb2-5"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># pak::pak("etiennebacher/tidypolars")</span></span></code></pre></div></div>
</div>
</section>
</section>
<section id="polarsの基本的な使い方" class="level2">
<h2 class="anchored" data-anchor-id="polarsの基本的な使い方">polarsの基本的な使い方</h2>
<p>まずはpolars本来の文法で基本的な使い方を見ていきます。</p>
<p>そもそも{polars}はPythonで一般的に使われており、R版はそのラッパーとして提供されています。Rで使う場合も、Python版と似たようなメソッドチェーンのスタイルを採用しています。</p>
<p>Pythonの場合は<code>import polars as pl</code>として<code>pl.read_csv()</code>のように使いますが、Rでは<code>pl$read_csv()</code>のように<code>$</code>でアクセスします。</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb3" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(polars)</span>
<span id="cb3-2"></span>
<span id="cb3-3"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># データの読み込み（CSVファイルから）</span></span>
<span id="cb3-4">df <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> pl<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">read_csv</span>(here<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">here</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"data/251125_r_polars/data.csv"</span>))</span>
<span id="cb3-5"></span>
<span id="cb3-6"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 遅延評価を使う場合（LazyFrame）</span></span>
<span id="cb3-7">lf <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> pl<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">scan_csv</span>(here<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">here</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"data/251125_r_polars/data.csv"</span>))</span>
<span id="cb3-8"></span>
<span id="cb3-9"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># データ処理の例</span></span>
<span id="cb3-10">result <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> lf<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span></span>
<span id="cb3-11">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">filter</span>(pl<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">col</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"age"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">30</span>)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span></span>
<span id="cb3-12">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">select</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"name"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"age"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"city"</span>))<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span></span>
<span id="cb3-13">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">group_by</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"city"</span>)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span></span>
<span id="cb3-14">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">agg</span>(pl<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">col</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"age"</span>)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mean</span>())<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span></span>
<span id="cb3-15">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">collect</span>() <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># ここで初めて実行される</span></span>
<span id="cb3-16"></span>
<span id="cb3-17"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">print</span>(result)</span></code></pre></div></div>
<div class="cell-output cell-output-stdout">
<pre><code>shape: (4, 2)
┌─────────┬───────────┐
│ city    ┆ age       │
│ ---     ┆ ---       │
│ str     ┆ f64       │
╞═════════╪═══════════╡
│ Fukuoka ┆ 36.0      │
│ Osaka   ┆ 39.666667 │
│ Tokyo   ┆ 42.25     │
│ Nagoya  ┆ 39.0      │
└─────────┴───────────┘</code></pre>
</div>
</div>
<section id="主な関数" class="level3">
<h3 class="anchored" data-anchor-id="主な関数">主な関数</h3>
<ul>
<li><code>pl$read_csv()</code>: CSVファイルを即座に読み込む（Eager evaluation）</li>
<li><code>pl$scan_csv()</code>: CSVファイルをスキャンする（Lazy evaluation）</li>
<li><code>filter()</code>: 行のフィルタリング</li>
<li><code>select()</code>: 列の選択</li>
<li><code>group_by()</code>: グループ化</li>
<li><code>agg()</code>: 集計</li>
<li><code>collect()</code>: 遅延評価の結果を取得</li>
</ul>
</section>
</section>
<section id="tidypolarsで使いやすく" class="level2">
<h2 class="anchored" data-anchor-id="tidypolarsで使いやすく">tidypolarsで使いやすく</h2>
<p>{tidypolars}を使うと、{polars}の高速性を保ちながら、{tidyverse}の文法で書くことができます。</p>
<p>ここでは例として、irisデータセットを使って{tidypolars}の基本的な使い方を見ていきます<sup>1</sup>。</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb5" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(tidypolars)</span>
<span id="cb5-2"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(tidyverse)</span>
<span id="cb5-3"></span>
<span id="cb5-4"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># データの読み込み</span></span>
<span id="cb5-5">df <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">read_csv_polars</span>(here<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">here</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"data/iris.csv"</span>))</span>
<span id="cb5-6"></span>
<span id="cb5-7">result <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> df <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span></span>
<span id="cb5-8">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">filter</span>(Sepal.Length <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">5.0</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span></span>
<span id="cb5-9">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">select</span>(Sepal.Length, Sepal.Width, Species) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span></span>
<span id="cb5-10">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">group_by</span>(Species) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span></span>
<span id="cb5-11">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">summarise</span>(</span>
<span id="cb5-12">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">avg_sepal_length =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mean</span>(Sepal.Length),</span>
<span id="cb5-13">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">avg_sepal_width =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mean</span>(Sepal.Width)</span>
<span id="cb5-14">  )</span>
<span id="cb5-15"></span>
<span id="cb5-16"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">print</span>(result)</span></code></pre></div></div>
<div class="cell-output cell-output-stdout">
<pre><code>shape: (3, 3)
┌────────────┬──────────────────┬─────────────────┐
│ Species    ┆ avg_sepal_length ┆ avg_sepal_width │
│ ---        ┆ ---              ┆ ---             │
│ str        ┆ f64              ┆ f64             │
╞════════════╪══════════════════╪═════════════════╡
│ versicolor ┆ 5.997872         ┆ 2.804255        │
│ virginica  ┆ 6.622449         ┆ 2.983673        │
│ setosa     ┆ 5.313636         ┆ 3.713636        │
└────────────┴──────────────────┴─────────────────┘</code></pre>
</div>
</div>
<section id="tidypolarsの利点" class="level3">
<h3 class="anchored" data-anchor-id="tidypolarsの利点">tidypolarsの利点</h3>
<ol type="1">
<li><strong>tidyverseの文法が使える</strong>: {dplyr}に慣れている人はすぐに使える</li>
<li><strong>高速性は維持</strong>: 内部的には{polars}のエンジンを使用</li>
<li><strong>学習コストが低い</strong>: 新しい文法を覚える必要がない</li>
</ol>
</section>
<section id="対応している関数" class="level3">
<h3 class="anchored" data-anchor-id="対応している関数">対応している関数</h3>
<p>{tidypolars}は{dplyr}および{tidyr}のS3メソッドとして実装されているため、<strong>これらのパッケージを読み込む必要があります</strong>（{tidyverse}を一緒に読み込んでおけば安心です！）。 この点を踏まえた上で、{tidypolars}では以下の主要な動詞がサポートされています：</p>
<ul>
<li><code>filter()</code>: 行のフィルタリング</li>
<li><code>select()</code>: 列の選択</li>
<li><code>mutate()</code>: 列の追加・変更</li>
<li><code>summarise()</code> / <code>summarize()</code>: 集計</li>
<li><code>arrange()</code>: 並び替え</li>
<li><code>group_by()</code>: グループ化</li>
<li><code>left_join()</code>, <code>inner_join()</code>など: 結合操作</li>
</ul>
</section>
<section id="dataframeとlazyframeの使い分け" class="level3">
<h3 class="anchored" data-anchor-id="dataframeとlazyframeの使い分け">DataFrameとLazyFrameの使い分け</h3>
<p>{tidypolars}では、2つのデータ読み込み方法があります：</p>
<p><strong>DataFrame（即座に評価）</strong></p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb7" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># データを即座に読み込む</span></span>
<span id="cb7-2">df <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">read_csv_polars</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"data.csv"</span>)</span></code></pre></div></div>
<ul>
<li>小〜中規模データに適している</li>
<li>即座に結果を確認できる</li>
<li>メモリに全データが読み込まれる</li>
</ul>
<p><strong>LazyFrame（遅延評価）</strong></p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb8" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb8-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># データをスキャンするだけで、まだ読み込まれない</span></span>
<span id="cb8-2">lf <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">scan_csv_polars</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"data.csv"</span>)</span>
<span id="cb8-3"></span>
<span id="cb8-4">result <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> lf <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span></span>
<span id="cb8-5">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">filter</span>(...) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb8-6">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">collect</span>()</span></code></pre></div></div>
<ul>
<li>大規模データに適している<br>
</li>
<li>クエリ最適化の恩恵を受けられる</li>
<li>必要な部分だけメモリに読み込む</li>
</ul>
<p>大規模データの場合は<strong>LazyFrameを使うことを推奨</strong>します。この場合は、最後に<code>collect()</code>を呼び出して結果を取得してください。</p>
</section>
</section>
<section id="実践例" class="level2">
<h2 class="anchored" data-anchor-id="実践例">実践例</h2>
<section id="例1-大規模csvファイルの処理" class="level3">
<h3 class="anchored" data-anchor-id="例1-大規模csvファイルの処理">例1: 大規模CSVファイルの処理</h3>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb9" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb9-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(tidypolars)</span>
<span id="cb9-2"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(tidyverse)</span>
<span id="cb9-3"></span>
<span id="cb9-4"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 大規模CSVファイルを効率的に処理</span></span>
<span id="cb9-5">result <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">read_csv_polars</span>(here<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">here</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"data/251125_r_polars/large_dataset.csv"</span>)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span></span>
<span id="cb9-6">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">filter</span>(<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">!</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">is.na</span>(value)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span></span>
<span id="cb9-7">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mutate</span>(</span>
<span id="cb9-8">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">value_log =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">log</span>(value),</span>
<span id="cb9-9">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">value_category =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">case_when</span>(</span>
<span id="cb9-10">      value <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">100</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"small"</span>,</span>
<span id="cb9-11">      value <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1000</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"medium"</span>,</span>
<span id="cb9-12">      <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">TRUE</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"large"</span></span>
<span id="cb9-13">    )</span>
<span id="cb9-14">  ) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span></span>
<span id="cb9-15">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">summarise</span>(</span>
<span id="cb9-16">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">count =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">n</span>(),</span>
<span id="cb9-17">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">mean_value =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mean</span>(value),</span>
<span id="cb9-18">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">median_value =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">median</span>(value),</span>
<span id="cb9-19">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">.by =</span> value_category</span>
<span id="cb9-20">  ) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span></span>
<span id="cb9-21">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">arrange</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">desc</span>(mean_value))</span>
<span id="cb9-22"></span>
<span id="cb9-23"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">print</span>(result)</span></code></pre></div></div>
<div class="cell-output cell-output-stdout">
<pre><code>shape: (3, 4)
┌────────────────┬───────┬────────────┬──────────────┐
│ value_category ┆ count ┆ mean_value ┆ median_value │
│ ---            ┆ ---   ┆ ---        ┆ ---          │
│ str            ┆ u32   ┆ f64        ┆ f64          │
╞════════════════╪═══════╪════════════╪══════════════╡
│ large          ┆ 4     ┆ 1100.0     ┆ 1075.0       │
│ medium         ┆ 31    ┆ 472.741935 ┆ 490.0        │
│ small          ┆ 15    ┆ 79.6       ┆ 82.0         │
└────────────────┴───────┴────────────┴──────────────┘</code></pre>
</div>
</div>
</section>
<section id="例2-データの書き出し" class="level3">
<h3 class="anchored" data-anchor-id="例2-データの書き出し">例2: データの書き出し</h3>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb11" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb11-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 処理結果をParquet形式で保存</span></span>
<span id="cb11-2">result <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span></span>
<span id="cb11-3">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">write_parquet_polars</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"output/result.parquet"</span>)</span>
<span id="cb11-4"></span>
<span id="cb11-5"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 処理結果をCSV形式で保存</span></span>
<span id="cb11-6">result <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span></span>
<span id="cb11-7">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">write_csv_polars</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"output/result.csv"</span>)</span></code></pre></div></div>
</div>
<p>Parquet形式については以下の記事もご覧ください。</p>
<div class="callout callout-style-simple callout-tip no-icon">
<div class="callout-body d-flex">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-body-container">
<p><a href="../../../../../pages/blog/2025/07/250728_parquet/index.html">Parquetファイルについて調べてみる</a></p>
</div>
</div>
</div>
</section>
</section>
<section id="polarsとtidyverseの使い分け" class="level2">
<h2 class="anchored" data-anchor-id="polarsとtidyverseの使い分け">polarsとtidyverseの使い分け</h2>
<section id="polarstidypolarsの使用が適しているケース" class="level3">
<h3 class="anchored" data-anchor-id="polarstidypolarsの使用が適しているケース">polars/tidypolarsの使用が適しているケース</h3>
<ul>
<li><strong>大規模データ</strong>: 数百MB以上のデータを扱う場合</li>
<li><strong>処理速度が重要</strong>: パフォーマンスが求められる場合</li>
<li><strong>メモリ制限</strong>: メモリが限られている環境での処理</li>
</ul>
</section>
</section>
<section id="注意点" class="level2">
<h2 class="anchored" data-anchor-id="注意点">注意点</h2>
<section id="tidypolarsの制約" class="level3">
<h3 class="anchored" data-anchor-id="tidypolarsの制約">tidypolarsの制約</h3>
<p>{tidypolars}は{polars}のラッパーなので、一部の{dplyr}/{tidyr}機能は未対応です：</p>
<ul>
<li><code>rowwise()</code>を使った行ごとの操作</li>
<li>一部の複雑なウィンドウ関数</li>
<li>カスタム関数の中での一部の集計関数</li>
</ul>
<p>ただし、<code>across()</code>、<code>pivot_longer()</code>、<code>pivot_wider()</code>などの主要な関数は<strong>サポートされています</strong>。</p>
</section>
<section id="データ型の違い" class="level3">
<h3 class="anchored" data-anchor-id="データ型の違い">データ型の違い</h3>
<p>{polars}とRのデータフレームでは、データ型の扱いが異なる場合があります。必要に応じて<code>as.data.frame()</code>で通常のデータフレームに変換してください。</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb12" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb12-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># polarsのDataFrameをRのdata.frameに変換</span></span>
<span id="cb12-2">df_r <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">as.data.frame</span>(df_polars)</span>
<span id="cb12-3"></span>
<span id="cb12-4"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># tibbleに変換する場合</span></span>
<span id="cb12-5">df_tibble <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> tibble<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">as_tibble</span>(df_polars)</span>
<span id="cb12-6"></span>
<span id="cb12-7"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># または collect() を使う方法（LazyFrameの場合）</span></span>
<span id="cb12-8">df_r <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> df_polars <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span></span>
<span id="cb12-9">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">collect</span>() <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># まずDataFrameに変換</span></span>
<span id="cb12-10">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">as.data.frame</span>() <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 次にR data.frameに変換</span></span></code></pre></div></div>
</div>
</section>
</section>
<section id="おわりに" class="level2">
<h2 class="anchored" data-anchor-id="おわりに">おわりに</h2>
<p>この記事では、Rで{polars}を使う方法と、tidyverseライクな文法で使える{tidypolars}について解説しました。</p>
<p>大規模データを扱う際は、{polars}の高速性が大きなメリットになります。特に{tidypolars}を使えば、既存の{tidyverse}の知識を活かしながら高速なデータ処理が実現できます。</p>
<p>すべてのケースで{polars}が最適とは限りませんが、データサイズや処理内容に応じて、{tidyverse}や{polars}などを使い分けることが重要だと思います。</p>
<p>ぜひ{polars}を試してみてください！</p>
</section>
<section id="参考" class="level2">
<h2 class="anchored" data-anchor-id="参考">参考</h2>
<div class="callout callout-style-simple callout-tip no-icon">
<div class="callout-body d-flex">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-body-container">
<ul>
<li><a href="https://pola-rs.github.io/r-polars/">polars - R package</a></li>
<li><a href="https://github.com/etiennebacher/tidypolars">tidypolars</a></li>
<li><a href="https://pola-rs.github.io/polars-book/">Polars User Guide</a></li>
</ul>
</div>
</div>
</div>


<!-- -->

</section>


<div id="quarto-appendix" class="default"><section id="footnotes" class="footnotes footnotes-end-of-document"><h2 class="anchored quarto-appendix-heading">注</h2>

<ol>
<li id="fn1"><p><code>iris.csv</code>はデフォルトで使える<code>iris</code>データフレームをCSV化しただけです。↩︎</p></li>
</ol>
</section></div> ]]></description>
  <category>R</category>
  <category>データ処理</category>
  <guid>https://yo5uke.com/pages/tips/2025/11/251125_r_polars/</guid>
  <pubDate>Mon, 24 Nov 2025 15:00:00 GMT</pubDate>
</item>
<item>
  <title>【R】case_match()でデータフレームの中身を置き換える</title>
  <link>https://yo5uke.com/pages/tips/2025/11/251124_case_match/</link>
  <description><![CDATA[ 

<div class="social-share-buttons">
  <!-- Twitter (X) -->
  <a href="" id="js-share-twitter" class="share_button ri--twitter-x-fill" target="_blank" rel="nofollow noopener noreferrer"></a>

  <!-- Bluesky -->
  <a href="" id="js-share-bluesky" class="share_button ri--bluesky-fill" target="_blank" rel="nofollow noopener noreferrer"></a>
</div>

<script>
  const twitterUsername = "@5uke_y";
  const blueskyUsername = "@5uke.bsky.social";

  const share_url = encodeURIComponent(location.href);
  const share_title = document.title;

  // Twitter (X)
  document.getElementById('js-share-twitter').setAttribute(
    "href",
    "https://twitter.com/share?url=" + share_url + "&text=" + share_title + " " + encodeURIComponent(twitterUsername) + " より" +
    "&hashtags=rstats"
  );

  // Bluesky
  document.getElementById('js-share-bluesky').setAttribute(
    "href",
    "https://bsky.app/intent/compose?text=" + share_title + " " + share_url + " " + encodeURIComponent(blueskyUsername) + " より"
  );
</script>





<section id="はじめに" class="level2">
<h2 class="anchored" data-anchor-id="はじめに">はじめに</h2>
<p>この記事では、<code>dplyr</code>パッケージの<code>case_match()</code>関数を使ったデータの置き換え方法について解説します。</p>
<p>以前「<a href="../../../../../pages/tips/2025/07/250727_recode/index.html"><span class="fira-code">recode</span>関数でデータフレームの中身を置き換える</a>」という記事で<code>recode()</code>関数を紹介しましたが、現在<code>recode()</code>はsuperseded（推奨されない・代替がある）となっています。そこで、より効率的な書き方として<code>case_match()</code>関数の使い方をまとめます。</p>
</section>
<section id="dplyrcase_matchの基本" class="level2">
<h2 class="anchored" data-anchor-id="dplyrcase_matchの基本"><span class="fira-code">dplyr::case_match()</span>の基本</h2>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb1" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(tidyverse)</span>
<span id="cb1-2"></span>
<span id="cb1-3">df <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">tibble</span>(</span>
<span id="cb1-4">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span>)</span>
<span id="cb1-5">)</span>
<span id="cb1-6"></span>
<span id="cb1-7"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">print</span>(df)</span></code></pre></div></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 5 × 1
      x
  &lt;dbl&gt;
1     1
2     2
3     3
4     4
5     5</code></pre>
</div>
</div>
<p><code>case_match()</code>関数は、指定した列の値に基づいて新しい値を割り当てることができます。</p>
<p>例えば、<code>x</code>列の値が1, 2, 3の場合は”A”、4, 5の場合は”B”という新しい列<code>y</code>を作成する場合、以下のように書きます。</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb3" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1">df <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> df <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span></span>
<span id="cb3-2">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mutate</span>(</span>
<span id="cb3-3">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">case_match</span>(x, <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"A"</span>, <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"B"</span>)</span>
<span id="cb3-4">  )</span>
<span id="cb3-5"></span>
<span id="cb3-6"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">print</span>(df)</span></code></pre></div></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 5 × 2
      x y    
  &lt;dbl&gt; &lt;chr&gt;
1     1 A    
2     2 A    
3     3 A    
4     4 B    
5     5 B    </code></pre>
</div>
</div>
<p>似たような関数に<code>case_when()</code>がありますが、<code>case_when()</code>は複数の条件式を評価して条件に応じた値を返すのに対して、<code>case_match()</code>は1つの変数に着目したうえで値を置き換えるという働きをします。</p>
<section id="例文字列の置き換え都道府県コードから地域名へ" class="level3">
<h3 class="anchored" data-anchor-id="例文字列の置き換え都道府県コードから地域名へ">例：文字列の置き換え（都道府県コードから地域名へ）</h3>
<p>実務ではよく、コードを人間が読みやすい形に変換することがあります。</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb5" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 都道府県コードから地方名へ変換</span></span>
<span id="cb5-2">prefecture_df <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">tibble</span>(</span>
<span id="cb5-3">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">pref_code =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"01"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"13"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"27"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"40"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"47"</span>)</span>
<span id="cb5-4">)</span>
<span id="cb5-5"></span>
<span id="cb5-6">prefecture_df <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> prefecture_df <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span></span>
<span id="cb5-7">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mutate</span>(</span>
<span id="cb5-8">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">region =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">case_match</span>(</span>
<span id="cb5-9">      pref_code,</span>
<span id="cb5-10">      <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"01"</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"北海道"</span>,</span>
<span id="cb5-11">      <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"02"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"03"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"04"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"05"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"06"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"07"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"東北"</span>,</span>
<span id="cb5-12">      <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"08"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"09"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"10"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"11"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"12"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"13"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"14"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"関東"</span>,</span>
<span id="cb5-13">      <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"21"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"22"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"23"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"24"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"25"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"26"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"27"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"28"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"29"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"30"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"近畿"</span>,</span>
<span id="cb5-14">      <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"40"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"41"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"42"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"43"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"44"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"45"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"46"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"47"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"九州・沖縄"</span>,</span>
<span id="cb5-15">      <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">.default =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"その他"</span></span>
<span id="cb5-16">    )</span>
<span id="cb5-17">  )</span>
<span id="cb5-18"></span>
<span id="cb5-19"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">print</span>(prefecture_df)</span></code></pre></div></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 5 × 2
  pref_code region    
  &lt;chr&gt;     &lt;chr&gt;     
1 01        北海道    
2 13        関東      
3 27        近畿      
4 40        九州・沖縄
5 47        九州・沖縄</code></pre>
</div>
</div>
<p><code>.default</code>引数を使うことで、マッチしなかった値にデフォルト値を割り当てることができます。</p>
</section>
<section id="名前付きベクトルを使った方法" class="level3">
<h3 class="anchored" data-anchor-id="名前付きベクトルを使った方法">名前付きベクトルを使った方法</h3>
<p>マッピングルールが複雑な場合や再利用したい場合は、あらかじめ名前付きベクトルを定義しておくと便利です。</p>
<p>ただ、この場合は以前紹介したような<code>dplyr::recode()</code>ではなく、今回の<code>case_match()</code>でもなく、名前付きベクトルを<code>[]</code>でインデックス参照する方法で解決できます。</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb7" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 商品カテゴリコードから日本語名へのマッピングを定義</span></span>
<span id="cb7-2">category_mapping <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(</span>
<span id="cb7-3">  <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"A"</span> <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"食品"</span>,</span>
<span id="cb7-4">  <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"B"</span> <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"衣料品"</span>,</span>
<span id="cb7-5">  <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"C"</span> <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"家電"</span>,</span>
<span id="cb7-6">  <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"D"</span> <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"書籍"</span>,</span>
<span id="cb7-7">  <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"E"</span> <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"その他"</span></span>
<span id="cb7-8">)</span>
<span id="cb7-9"></span>
<span id="cb7-10">product_df <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">tibble</span>(</span>
<span id="cb7-11">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">product_id =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">6</span>,</span>
<span id="cb7-12">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">category_code =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"A"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"B"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"C"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"A"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"D"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"F"</span>)</span>
<span id="cb7-13">)</span>
<span id="cb7-14"></span>
<span id="cb7-15"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 方法1: 名前付きベクトルを使ってインデックス参照</span></span>
<span id="cb7-16">product_df <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> product_df <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span></span>
<span id="cb7-17">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mutate</span>(</span>
<span id="cb7-18">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">category_name =</span> category_mapping[category_code],</span>
<span id="cb7-19">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">category_name =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">if_else</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">is.na</span>(category_name), <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"未分類"</span>, category_name)</span>
<span id="cb7-20">  )</span>
<span id="cb7-21"></span>
<span id="cb7-22"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">print</span>(product_df)</span></code></pre></div></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 6 × 3
  product_id category_code category_name
       &lt;int&gt; &lt;chr&gt;         &lt;chr&gt;        
1          1 A             食品         
2          2 B             衣料品       
3          3 C             家電         
4          4 A             食品         
5          5 D             書籍         
6          6 F             未分類       </code></pre>
</div>
</div>
<p>意外にも簡単でした。</p>
<p>名前付きベクトルを<code>[]</code>でインデックス参照することで、キーから値への変換が簡潔に書けます。マッチしない値は<code>NA</code>になるため、<code>if_else()</code>でデフォルト値を設定します<sup>1</sup>。この方法は、マッピングルールが多い場合や、複数の場所で同じマッピングを使いたい場合に特に有効です。</p>
<section id="逆引きマッピング" class="level4">
<h4 class="anchored" data-anchor-id="逆引きマッピング">逆引きマッピング</h4>
<p>今度は同じ<code>category_mapping</code>を使って、カテゴリ名からカテゴリコードへの逆引きマッピングを行う方法についてまとめます。</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb9" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb9-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 逆引きマッピング用の名前付きベクトルを作成</span></span>
<span id="cb9-2">reverse_mapping <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">setNames</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">names</span>(category_mapping), category_mapping)</span>
<span id="cb9-3"></span>
<span id="cb9-4">df <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">tibble</span>(</span>
<span id="cb9-5">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">category_name =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"食品"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"家電"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"書籍"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"未分類"</span>)</span>
<span id="cb9-6">)</span>
<span id="cb9-7"></span>
<span id="cb9-8">df <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> df <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span></span>
<span id="cb9-9">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mutate</span>(</span>
<span id="cb9-10">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">category_code =</span> reverse_mapping[category_name],</span>
<span id="cb9-11">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">category_code =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">if_else</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">is.na</span>(category_code), <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"不明"</span>, category_code)</span>
<span id="cb9-12">  )</span>
<span id="cb9-13"></span>
<span id="cb9-14"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">print</span>(df)</span></code></pre></div></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 4 × 2
  category_name category_code
  &lt;chr&gt;         &lt;chr&gt;        
1 食品          A            
2 家電          C            
3 書籍          D            
4 未分類        不明         </code></pre>
</div>
</div>
<p>ここでは<code>setNames()</code>関数を使って、元の<code>category_mapping</code>の名前と値を入れ替えた新しい名前付きベクトル<code>reverse_mapping</code>を作成しています。</p>
<p>その後、同様に<code>[]</code>でインデックス参照を使ってカテゴリ名からカテゴリコードへの変換を行い、マッチしない場合は<code>if_else()</code>でデフォルト値を設定しています<sup>2</sup>。</p>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center collapsed" data-bs-toggle="collapse" data-bs-target=".callout-1-contents" aria-controls="callout-1" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
<span class="screen-reader-only">Note</span><span class="fira-code">setNames()</span>の動き
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-1" class="callout-1-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<p><code>setNames()</code>関数は、ベクトルに名前を付けるための関数です。以下のように使います。</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb11" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb11-1">x <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span></span>
<span id="cb11-2"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">setNames</span>(x, <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"a"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"b"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"c"</span>))</span></code></pre></div></div>
<div class="cell-output cell-output-stdout">
<pre><code>a b c 
1 2 3 </code></pre>
</div>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb13" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb13-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 結果:</span></span>
<span id="cb13-2"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#  a b c</span></span>
<span id="cb13-3"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#  1 2 3</span></span></code></pre></div></div>
</div>
<p>この例では、数値ベクトル<code>x</code>に対して、名前ベクトル<code>c("a", "b", "c")</code>を使って名前を付けています。結果として、<code>x</code>の各要素に対応する名前が付与されます。</p>
<p>さらに今回のように<code>names()</code>では<code>A</code>, <code>B</code>, <code>C</code>などの名前を取得し、それに対応する値を逆に設定する<sup>3</sup>ことで、逆引きマッピング用の名前付きベクトルを作成できます。</p>
<p>特に長いマッピングルールを扱う場合に、また1から名前付きベクトルを作成しなくてよくなるため便利だと思います。</p>
</div>
</div>
</div>
</section>
</section>
</section>
<section id="おわりに" class="level2">
<h2 class="anchored" data-anchor-id="おわりに">おわりに</h2>
<p>この記事では、<code>dplyr::case_match()</code>を使ったデータの置き換え方法について解説しました。</p>
<p><code>case_match()</code>は単一の列の値を置き換える際に直感的で読みやすいコードが書けます。また、名前付きベクトルを使ったインデックス参照を組み合わせることで、複雑なマッピングルールも効率的に管理できます。</p>
<p>データクリーニングや前処理の際にぜひ活用してみてください。</p>


<!-- -->

</section>


<div id="quarto-appendix" class="default"><section id="footnotes" class="footnotes footnotes-end-of-document"><h2 class="anchored quarto-appendix-heading">注</h2>

<ol>
<li id="fn1"><p>全部マッチすることがわかっているなら2行目は要りません。↩︎</p></li>
<li id="fn2"><p>ここも同様に全部マッチすることがわかっているなら2行目は要りません。↩︎</p></li>
<li id="fn3"><p>ここもややこしい点ですが、<code>category_mapping</code>はA→食品、B→衣料品のように対応関係が含まれているものの、値は”食品”や”衣料品”の方に該当します。データフレームのような感じで、“A”や”B”は列名、“食品”や”衣料品”は値、というイメージを持っていただければと思います。↩︎</p></li>
</ol>
</section></div> ]]></description>
  <category>R</category>
  <category>データ処理</category>
  <guid>https://yo5uke.com/pages/tips/2025/11/251124_case_match/</guid>
  <pubDate>Sun, 23 Nov 2025 15:00:00 GMT</pubDate>
</item>
<item>
  <title>【R】無名関数とmap系関数について</title>
  <link>https://yo5uke.com/pages/tips/2025/11/251106_anonymous/</link>
  <description><![CDATA[ 

<div class="social-share-buttons">
  <!-- Twitter (X) -->
  <a href="" id="js-share-twitter" class="share_button ri--twitter-x-fill" target="_blank" rel="nofollow noopener noreferrer"></a>

  <!-- Bluesky -->
  <a href="" id="js-share-bluesky" class="share_button ri--bluesky-fill" target="_blank" rel="nofollow noopener noreferrer"></a>
</div>

<script>
  const twitterUsername = "@5uke_y";
  const blueskyUsername = "@5uke.bsky.social";

  const share_url = encodeURIComponent(location.href);
  const share_title = document.title;

  // Twitter (X)
  document.getElementById('js-share-twitter').setAttribute(
    "href",
    "https://twitter.com/share?url=" + share_url + "&text=" + share_title + " " + encodeURIComponent(twitterUsername) + " より" +
    "&hashtags=rstats"
  );

  // Bluesky
  document.getElementById('js-share-bluesky').setAttribute(
    "href",
    "https://bsky.app/intent/compose?text=" + share_title + " " + share_url + " " + encodeURIComponent(blueskyUsername) + " より"
  );
</script>





<section id="はじめに" class="level2">
<h2 class="anchored" data-anchor-id="はじめに">はじめに</h2>
<p>Rでは、関数を定義する際に名前を付けることが一般的ですが、特定の場面では名前を持たない無名関数（匿名関数）を使用することがあります。無名関数は、一時的に使用される関数や、他の関数に引数として渡される関数を定義する際に便利です。</p>
<p>今回は、Rにおける無名関数の使い方についてまとめます。</p>
</section>
<section id="無名関数とは" class="level2">
<h2 class="anchored" data-anchor-id="無名関数とは">無名関数とは？</h2>
<p>無名関数は名前を持たない関数のことで、以下のように定義します。</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb1" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 無名関数の例</span></span>
<span id="cb1-2">result <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> (<span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">function</span>(x) {</span>
<span id="cb1-3">  x<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">^</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span></span>
<span id="cb1-4">})(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span>)</span></code></pre></div></div>
</div>
<p>この関数は<code>x</code>を引数として受け取り、その2乗を返します。関数定義の直後に<code>(5)</code>と続けることで、5を引数として渡し、結果を<code>result</code>に格納しています。</p>
<p>また、この例において<code>x</code>を2乗する関数には名前（<code>mutate</code>や<code>select</code>など）が付いていません。名前を付ける場合であれば、</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb2" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 名前付き関数の例</span></span>
<span id="cb2-2">square_function <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">function</span>(x) {</span>
<span id="cb2-3">  x<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">^</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span></span>
<span id="cb2-4">}</span>
<span id="cb2-5">result <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">square_function</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span>)</span></code></pre></div></div>
</div>
<p>となります。<code>square_function</code>という名前で関数を定義し、その後で呼び出しています。<code>square_function(5)</code>の<code>square_function</code>の部分に<code>function(x) { x^2 }</code>を代入すると、無名関数の例に戻ることがおわかりいただけると思います。</p>
<p>これらはともに同じことをしていますが、無名関数は一時的に使用する場合に使い捨てのように扱えるので便利です。</p>
<p>また、R 4.1.0以降では、<code>\(x) x^2</code>のように短縮記法も使用できます。</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb3" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 短縮記法の無名関数の例</span></span>
<span id="cb3-2">result <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> (\(x) x<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">^</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>)(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span>)</span></code></pre></div></div>
</div>
<p><code>function(x)</code>が<code>\(x)</code>に置き換えられていますが、機能は同じです。</p>
</section>
<section id="無名関数はどんな時に必要" class="level2">
<h2 class="anchored" data-anchor-id="無名関数はどんな時に必要">無名関数はどんな時に必要？</h2>
<p>無名関数は、以下のような場面で役立ちます。</p>
<ul>
<li><strong>一時的な処理</strong>: 一度だけ使用する関数を定義する場合。</li>
<li><strong>関数の引数として渡す</strong>: 他の関数に処理を渡す際に、簡潔に記述できる。</li>
<li><strong>コードの可読性向上</strong>: 簡単な処理を行う場合に、コードを短く保つ。</li>
</ul>
<p>これだけではよくわからないと思いますので、実例をいくつか示します。</p>
</section>
<section id="無名関数の例" class="level2">
<h2 class="anchored" data-anchor-id="無名関数の例">無名関数の例</h2>
<p>無名関数は、<code>map()</code>や<code>across()</code>などの関数と組み合わせて使用されることが多いです。先ほど簡単な例を挙げましたが、少し実用性を意識した例を示します。</p>
<p>どちらの関数も複数の値や列に対して同じ処理を適用するために使用され、それぞれの処理の内容を無名関数で定義することができます。<br>
例えば、全ての列に対して2乗して100を加える処理を行う、みたいな場合には既存の関数では対応できないため、自分で使い捨ての関数を定義して渡すことで処理します。</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb4" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(tidyverse)</span>
<span id="cb4-2"></span>
<span id="cb4-3">df <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">tibble</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">a =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">b =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">6</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span></span>
<span id="cb4-4">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mutate</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">across</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">everything</span>(), \(x) x<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">^</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">100</span>))</span>
<span id="cb4-5"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">print</span>(df)</span></code></pre></div></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 5 × 2
      a     b
  &lt;dbl&gt; &lt;dbl&gt;
1   101   136
2   104   149
3   109   164
4   116   181
5   125   200</code></pre>
</div>
</div>
<p>そもそもですが…</p>
<ul>
<li><code>across()</code>は第一引数に対象の列を指定し、第二引数に適用する関数を指定します。</li>
<li><code>everything()</code>は全ての列を選択するためのヘルパー関数です。
<ul>
<li>他の例で言えば<code>starts_with("a")</code>や<code>ends_with("b")</code>など、特定の文字列で始まったり終わったりする列を一括選択するための関数もあります。</li>
</ul></li>
</ul>
<p><code>\(x) x^2 + 100</code>の部分が無名関数で、<code>x</code>を引数として受け取り、<code>x^2 + 100</code>を返します。<code>x</code>である必要はありませんが、一般的です。</p>
<p>もっと複雑な例で言うと、<code>map()</code>関数を使ってリスト内の各要素に対して無名関数を適用することもできます。</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb6" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1">numbers <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">list</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">6</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">11</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">15</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">16</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">20</span>)</span>
<span id="cb6-2">squared_plus_ten <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">map</span>(numbers, \(x) x<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">^</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span>)</span>
<span id="cb6-3"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">print</span>(squared_plus_ten)</span></code></pre></div></div>
<div class="cell-output cell-output-stdout">
<pre><code>[[1]]
[1] 11 14 19 26 35

[[2]]
[1]  46  59  74  91 110

[[3]]
[1] 131 154 179 206 235

[[4]]
[1] 266 299 334 371 410</code></pre>
</div>
</div>
<p><code>map()</code>関数はリストの各要素に対して無名関数を適用し、その結果を新しいリストとして返します。<code>numberes</code>リストは4つの整数ベクトルを含んでおり、各ベクトルに対して2乗して10を加える処理が行われているのが確認できます。</p>
<p>実は<code>map</code>系関数には他にも色々なバリエーションがあります。</p>
</section>
<section id="map系関数" class="level2">
<h2 class="anchored" data-anchor-id="map系関数">map系関数</h2>
<p><code>map()</code>関数には、返り値の型に応じて様々なバリエーションがあります。以下に代表的なものを示します。</p>
<ul>
<li><code>map()</code>: 常にリストを返す（最も汎用的）。</li>
<li><code>map_lgl()</code>: 論理値（TRUE/FALSE）のベクトルを返す。</li>
<li><code>map_int()</code>: 整数のベクトルを返す。</li>
<li><code>map_dbl()</code>: 数値のベクトルを返す。</li>
<li><code>map_chr()</code>: 文字列のベクトルを返す。</li>
<li><code>map_dfr()</code>: 行方向に結合したデータフレームを返す。</li>
<li><code>map_dfc()</code>: 列方向に結合したデータフレームを返す。</li>
</ul>
<p>これらの関数を使うことで、返り値の型を明示的に指定でき、コードの意図がより明確になります。</p>
<p>今回はこの中で割と使用頻度が高い<code>map_dfr()</code>について簡単に説明します。</p>
<section id="map_dfr" class="level3">
<h3 class="anchored" data-anchor-id="map_dfr">map_dfr()</h3>
<p><code>map_dfr()</code>関数は、リストの各要素に対して無名関数を適用し、その結果を行方向に結合したデータフレームとして返します。例えば、複数のデータフレームを一括で処理し、結果を一つのデータフレームにまとめたい場合に便利です。</p>
<p>具体的には、国勢調査のメッシュデータなどの読み込みに役立ちます。メッシュデータは一定の範囲ごとに分割されているため、複数のファイルを一括で読み込み、結合する必要があります。<br>
一応<code>for</code>ループで読み込んで結合することもできますが、<code>map_dfr()</code>を使うとより簡潔に書けます。</p>
<p>ここでは<code>data/census_2020</code>フォルダに複数のテキストファイルがあると仮定し、それらを一括で読み込む例を示します。<br>
ファイルのリストを作るために<code>fs</code>パッケージも使用します。</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb8" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb8-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(tidyverse)</span>
<span id="cb8-2"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(fs)</span>
<span id="cb8-3"></span>
<span id="cb8-4"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># ファイルパスのリストを取得</span></span>
<span id="cb8-5"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># glob引数で特定の拡張子のファイルのみを対象にする</span></span>
<span id="cb8-6">file_paths <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">dir_ls</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"data/census_2020"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">glob =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"*.txt"</span>)</span>
<span id="cb8-7"></span>
<span id="cb8-8"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 各ファイルを読み込み、行方向に結合</span></span>
<span id="cb8-9">census_data <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">map_dfr</span>(file_paths, \(file) {</span>
<span id="cb8-10">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">read_csv</span>(</span>
<span id="cb8-11">    file,</span>
<span id="cb8-12">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">locale =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">locale</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">encoding =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"SHIFT_JIS"</span>),</span>
<span id="cb8-13">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">skip =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span></span>
<span id="cb8-14">  ) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span></span>
<span id="cb8-15">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">select</span>(</span>
<span id="cb8-16">      <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>,</span>
<span id="cb8-17">      <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"　人口（総数）"</span>,</span>
<span id="cb8-18">      <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"　０～１４歳人口　総数"</span>,</span>
<span id="cb8-19">      <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"　１５～６４歳人口　総数"</span>,</span>
<span id="cb8-20">      <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"　６５歳以上人口　総数"</span></span>
<span id="cb8-21">    ) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span></span>
<span id="cb8-22">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">filter</span>(...<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|</span> ...<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span></span>
<span id="cb8-23">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">select</span>(<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(...<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>, ...<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>, ...<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span></span>
<span id="cb8-24">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rename</span>(</span>
<span id="cb8-25">      <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">KEY_CODE =</span> ...<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>,</span>
<span id="cb8-26">      <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">pop_total =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"　人口（総数）"</span>,</span>
<span id="cb8-27">      <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">pop_young =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"　０～１４歳人口　総数"</span>,</span>
<span id="cb8-28">      <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">pop_working =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"　１５～６４歳人口　総数"</span>,</span>
<span id="cb8-29">      <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">pop_old =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"　６５歳以上人口　総数"</span></span>
<span id="cb8-30">    ) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span></span>
<span id="cb8-31">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mutate</span>(</span>
<span id="cb8-32">      <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">KEY_CODE =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">as.character</span>(KEY_CODE),</span>
<span id="cb8-33">      <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">across</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">starts_with</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"pop_"</span>), as.integer)</span>
<span id="cb8-34">    )</span>
<span id="cb8-35">})</span></code></pre></div></div>
</div>
<p>このように、<code>map_dfr()</code>を使用することで、各ファイルを読み込み、必要な列を選択・フィルタリング・リネーム・型変換などの処理を一括で行い、最終的に一つのデータフレームとしてまとめることができます。<code>file_paths</code>に<code>\(file) { ... }</code>の無名関数が適用され、各ファイルに対して同じ処理が実行されています。</p>
<p>内部的には最後に<code>bind_rows()</code>が呼ばれているので、ひと手間省けます。ただ、各ファイルで列の型が異なる<sup>1</sup>とエラーになるので注意してください。</p>
<p>ちなみに最後に<code>across(starts_with("pop_"), as.integer)</code>としており、<code>pop_</code>で始まる列全てに対して<code>as.integer</code>を適用しています。処理内容が関数名で済む場合はこのように簡潔に書けるので便利です。<br>
整数型にして1000で割りたい、みたいな場合には<code>\(x) as.integer(x) / 1000</code>のようにできますね。</p>
</section>
</section>
<section id="さらに一例" class="level2">
<h2 class="anchored" data-anchor-id="さらに一例">さらに一例</h2>
<p>パイプ処理の途中に無名関数を挟んで処理をしてみます。</p>
<p>先日仕事でこんな場面がありました。</p>
<p>「うわぁ、今処理しているところで一旦保存して、ここからフィルターかけたものを<code>bind_rows()</code>したいなあ」</p>
<p>いったいどんな場面だよと言う感じではありますが、事情はいろいろあって、実際もっと複雑ではありますがこんなシーンがあったんですね。</p>
<p>別に一旦オブジェクトを保存してから別で処理してもよいのですが、そんなにオブジェクトを増やしたくないということもあり、なんとかパイプで処理をすることにしました。</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb9" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb9-1">df <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">tibble</span>(</span>
<span id="cb9-2">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">group =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rep</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"A"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"B"</span>), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">each =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span>),</span>
<span id="cb9-3">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">value =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span></span>
<span id="cb9-4">)</span>
<span id="cb9-5"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">print</span>(df)</span></code></pre></div></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 10 × 2
   group value
   &lt;chr&gt; &lt;int&gt;
 1 A         1
 2 A         2
 3 A         3
 4 A         4
 5 A         5
 6 B         6
 7 B         7
 8 B         8
 9 B         9
10 B        10</code></pre>
</div>
</div>
<p>これを使って…</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb11" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb11-1">df <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> df <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span></span>
<span id="cb11-2">  (\(data) {</span>
<span id="cb11-3">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">bind_rows</span>(</span>
<span id="cb11-4">      data,</span>
<span id="cb11-5">      data <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">filter</span>(group <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"A"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mutate</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">value =</span> value <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span>)</span>
<span id="cb11-6">    )</span>
<span id="cb11-7">  })() <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span></span>
<span id="cb11-8">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">arrange</span>(group, value)</span>
<span id="cb11-9"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">print</span>(df)</span></code></pre></div></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 15 × 2
   group value
   &lt;chr&gt; &lt;dbl&gt;
 1 A         1
 2 A         2
 3 A         3
 4 A         4
 5 A         5
 6 A        10
 7 A        20
 8 A        30
 9 A        40
10 A        50
11 B         6
12 B         7
13 B         8
14 B         9
15 B        10</code></pre>
</div>
</div>
<p>こう。</p>
<p>おわかりいただけますでしょうか。<br>
パイプの途中で無名関数を定義し、<code>data</code>という引数でパイプの直前のデータフレームを受け取っています。<br>
その中で<code>bind_rows()</code>を使って、元のデータフレームと、<code>group</code>が<code>A</code>の行に対して<code>value</code>を10倍した行を結合しています。<br>
最後に<code>()</code>を付けることで、無名関数を即座に実行しています。</p>
<p><code>data</code>の部分にはその直前間で処理していたデータフレームが入るので、無名関数の中でそれを利用してさらに処理を行うことができます。</p>
<p>最後に<code>()</code>を付けないとコードが途中と判断され実行されませんので、注意してください。</p>
<p>（今日の目的はこの処理方法について書いておきたかったということで、実はそれまでは前振りでした！）</p>
</section>
<section id="まとめ" class="level2">
<h2 class="anchored" data-anchor-id="まとめ">まとめ</h2>
<p>無名関数は、Rにおいて一時的な処理や関数の引数として使用される便利な機能です。<code>map()</code>や<code>across()</code>などの関数と組み合わせることで、コードを簡潔かつ可読性の高いものにすることができます。</p>
<p>類似する変数がたくさんある場合や、複数のデータセットに同じ処理を適用したい場合などには、無名関数を<code>map()</code>系関数や<code>across()</code>などと組み合わせて使用していきましょう！</p>
<p>そして機会があれば、パイプの途中に無名関数を挟んで処理する方法も試してみてください。</p>


<!-- -->

</section>


<div id="quarto-appendix" class="default"><section id="footnotes" class="footnotes footnotes-end-of-document"><h2 class="anchored quarto-appendix-heading">注</h2>

<ol>
<li id="fn1"><p>例えばあるファイルは数値型、あるファイルは文字型など。特に全ての行が欠損していると勝手に型を判定されてエラーが起きる場合があるので、明示的に型を指定しておくとよいかもしれません。↩︎</p></li>
</ol>
</section></div> ]]></description>
  <category>R</category>
  <category>データ処理</category>
  <guid>https://yo5uke.com/pages/tips/2025/11/251106_anonymous/</guid>
  <pubDate>Wed, 05 Nov 2025 15:00:00 GMT</pubDate>
</item>
<item>
  <title>Typst 入門</title>
  <link>https://yo5uke.com/pages/tips/2025/10/251026_typst/</link>
  <description><![CDATA[ 

<div class="social-share-buttons">
  <!-- Twitter (X) -->
  <a href="" id="js-share-twitter" class="share_button ri--twitter-x-fill" target="_blank" rel="nofollow noopener noreferrer"></a>

  <!-- Bluesky -->
  <a href="" id="js-share-bluesky" class="share_button ri--bluesky-fill" target="_blank" rel="nofollow noopener noreferrer"></a>
</div>

<script>
  const twitterUsername = "@5uke_y";
  const blueskyUsername = "@5uke.bsky.social";

  const share_url = encodeURIComponent(location.href);
  const share_title = document.title;

  // Twitter (X)
  document.getElementById('js-share-twitter').setAttribute(
    "href",
    "https://twitter.com/share?url=" + share_url + "&text=" + share_title + " " + encodeURIComponent(twitterUsername) + " より" +
    "&hashtags=rstats"
  );

  // Bluesky
  document.getElementById('js-share-bluesky').setAttribute(
    "href",
    "https://bsky.app/intent/compose?text=" + share_title + " " + share_url + " " + encodeURIComponent(blueskyUsername) + " より"
  );
</script>





<section id="はじめに" class="level2">
<h2 class="anchored" data-anchor-id="はじめに">はじめに</h2>
<p>皆さん、Typstをご存知でしょうか？<br>
Typstは、LaTeXにも代わりうる新しい組版システムで、美しいドキュメントを（比較的）簡単に作成できることができます。<br>
Typstは、シンプルで直感的な構文を持ち、リアルタイムプレビュー機能も備えているため、初心者でも扱いやすいのが特徴です。</p>
<p>これまでの僕の記事では、LaTeXを中心にドキュメント作成の方法を紹介してきましたが、Typstも非常に魅力的な選択肢です。<br>
ローカルで環境を整えるというのはインターネット環境に左右されないという利点を強調してきた一方で、実際問題それほど問題になるケースが少なく、オンラインエディタで文書を作成するというのも十分に実用的です。</p>
<p>TypstはOverleafのような<strong>オンラインエディタを提供</strong>しており、なおかつ<strong>リアルタイムプレビューも備えている</strong>ため、LaTeXのようにコンパイルを待つことなく書いた内容を確認することができます。</p>
<p>この記事では、Typstの基本的な使い方を紹介します。<br>
書き方がLaTeXとは異なるので最初は戸惑うかもしれませんが、慣れれば非常に便利ですので、ぜひ試してみてください。</p>
</section>
<section id="typstの準備" class="level2">
<h2 class="anchored" data-anchor-id="typstの準備">Typstの準備</h2>
<p>Typstは<strong>ローカルにインストールする必要がなく、オンラインエディタで直接ドキュメントを作成できます</strong>。</p>
<ol type="1">
<li><a href="https://typst.app/">Typst</a>にアクセスし、アカウントを作成します。
<ul>
<li>初めてであればSign Upからアカウントを作成してください。</li>
</ul></li>
<li>ログイン後、ダッシュボードから「Empty document」をクリックして新しいドキュメントを作成します。</li>
</ol>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://yo5uke.com/pages/tips/2025/10/251026_typst/image/typst_dashboard.png" class="img-fluid figure-img"></p>
<figcaption>Typstのダッシュボード</figcaption>
</figure>
</div>
<ol start="3" type="1">
<li>ドキュメントエディタが開きます。ここでTypstのコードを記述します。
<ul>
<li>ファイルの拡張子は<code>.typ</code>です。</li>
</ul></li>
</ol>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://yo5uke.com/pages/tips/2025/10/251026_typst/image/typst_editor.png" class="img-fluid figure-img"></p>
<figcaption>Typstのドキュメントエディタ</figcaption>
</figure>
</div>
</section>
<section id="typstの基本的な書き方" class="level2">
<h2 class="anchored" data-anchor-id="typstの基本的な書き方">Typstの基本的な書き方</h2>
<p>Typstを使い始める前に、まずは基本的な構文から説明します。</p>
<p>ここで紹介する内容は<strong>Typst全般に共通する基本事項</strong>であり、テンプレートを使わない場合でも役立つ知識です。</p>
<p>最初はややこしいかもしれませんが、慣れてしまえばLaTeXよりもシンプルだと思いますので、ぜひ挑戦してみてください。</p>
<section id="はじめてのtypst文書" class="level3">
<h3 class="anchored" data-anchor-id="はじめてのtypst文書">はじめてのTypst文書</h3>
<p>まずは最もシンプルなTypst文書を作成してみましょう。</p>
<ol type="1">
<li><a href="https://typst.app/">オンラインエディタ</a>を開き、新しいドキュメントを作成します。</li>
<li>以下のようにシンプルなテキストを書いてみてください。</li>
</ol>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb1" style="background: #f1f3f5;"><pre class="sourceCode typst code-with-copy"><code class="sourceCode typst"><span id="cb1-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">= はじめに</span></span>
<span id="cb1-2"></span>
<span id="cb1-3">これはTypstで書いた文書です。</span>
<span id="cb1-4"></span>
<span id="cb1-5">Typstではリアルタイムでプレビューが表示されるので、すぐに結果を確認できます。</span></code></pre></div></div>
<p>たったこれだけで、セクション見出し付きの文書が完成します。LaTeXのように<code>\documentclass</code>や<code>\begin{document}</code>といった複雑な設定は不要です。</p>
<section id="セクション" class="level4">
<h4 class="anchored" data-anchor-id="セクション">セクション</h4>
<p>セクションは<code>=</code>を使って作成し、サブセクションは<code>==</code>というようにイコールの数で階層を表現します<sup>1</sup>。</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb2" style="background: #f1f3f5;"><pre class="sourceCode typst code-with-copy"><code class="sourceCode typst"><span id="cb2-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">= セクション1</span></span>
<span id="cb2-2"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">== サブセクション1.1</span></span></code></pre></div></div>
<p>ちなみに今回の設定ではセクション番号が表示されるようになっているので、「1 セクション1」のように自動的に番号が振られます。</p>
</section>
<section id="段落" class="level4">
<h4 class="anchored" data-anchor-id="段落">段落</h4>
<p>段落を改める場合、2通りの方法が使えます。</p>
<ol type="1">
<li>空行を挟む</li>
</ol>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb3" style="background: #f1f3f5;"><pre class="sourceCode typst code-with-copy"><code class="sourceCode typst"><span id="cb3-1">これは1つ目の段落です。</span>
<span id="cb3-2"></span>
<span id="cb3-3">これは2つ目の段落です。</span></code></pre></div></div>
<ol start="2" type="1">
<li>バックスラッシュを使う</li>
</ol>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb4" style="background: #f1f3f5;"><pre class="sourceCode typst code-with-copy"><code class="sourceCode typst"><span id="cb4-1">これは1つ目の段落です。<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">\</span></span>
<span id="cb4-2">これは2つ目の段落です。</span></code></pre></div></div>
<p>この場合は空行を入れなくても段落が分かれます。</p>
</section>
<section id="強調" class="level4">
<h4 class="anchored" data-anchor-id="強調">強調</h4>
<p>強調したい部分は<code>*</code>で囲みます。</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb5" style="background: #f1f3f5;"><pre class="sourceCode typst code-with-copy"><code class="sourceCode typst"><span id="cb5-1">これは*強調*されたテキストです。</span></code></pre></div></div>
<p>また、イタリック体にしたい場合は<code>_</code>で囲みます。</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb6" style="background: #f1f3f5;"><pre class="sourceCode typst code-with-copy"><code class="sourceCode typst"><span id="cb6-1">これは_イタリック体_のテキストです。</span></code></pre></div></div>
</section>
<section id="箇条書き" class="level4">
<h4 class="anchored" data-anchor-id="箇条書き">箇条書き</h4>
<p>箇条書きは<code>-</code>を使って作成します。</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb7" style="background: #f1f3f5;"><pre class="sourceCode typst code-with-copy"><code class="sourceCode typst"><span id="cb7-1">- アイテム1</span>
<span id="cb7-2">- アイテム2</span>
<span id="cb7-3">  - サブアイテム2.1</span>
<span id="cb7-4">  - サブアイテム2.2</span></code></pre></div></div>
</section>
<section id="番号付きリスト" class="level4">
<h4 class="anchored" data-anchor-id="番号付きリスト">番号付きリスト</h4>
<p>番号付きリストは<code>1.</code>を使って作成します。</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb8" style="background: #f1f3f5;"><pre class="sourceCode typst code-with-copy"><code class="sourceCode typst"><span id="cb8-1">1. アイテム1</span>
<span id="cb8-2">2. アイテム2</span></code></pre></div></div>
</section>
<section id="数式" class="level4">
<h4 class="anchored" data-anchor-id="数式">数式</h4>
<p><code>$...$</code>で囲むことでインライン数式を作成できます。</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb9" style="background: #f1f3f5;"><pre class="sourceCode typst code-with-copy"><code class="sourceCode typst"><span id="cb9-1">これはインライン数式の例です：<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">$E=mc^2$</span>。</span></code></pre></div></div>
<p>ブロック数式は同じく<code>$...$</code>で囲みますが、改行をしてください。</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb10" style="background: #f1f3f5;"><pre class="sourceCode typst code-with-copy"><code class="sourceCode typst"><span id="cb10-1"><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">$</span></span>
<span id="cb10-2"><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">E = m c^2</span></span>
<span id="cb10-3"><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">$</span></span></code></pre></div></div>
<p>文字を並べる場合にはスペースを空けてください。<code>mc^2</code>と詰めて書くと表示されなくなってしまいます。</p>
</section>
<section id="図の挿入" class="level4">
<h4 class="anchored" data-anchor-id="図の挿入">図の挿入</h4>
<p>図は<code>#figure(...)</code>を使って挿入します。</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb11" style="background: #f1f3f5;"><pre class="sourceCode typst code-with-copy"><code class="sourceCode typst"><span id="cb11-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">#</span>figure<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span></span>
<span id="cb11-2">  image<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span></span>
<span id="cb11-3">    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"path_to_image.png"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb11-4">    width<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">30%</span></span>
<span id="cb11-5">  <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">),</span></span>
<span id="cb11-6">  caption<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>これは図のキャプションです。<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">]</span></span>
<span id="cb11-7"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">&lt;my-fig&gt;</span></span></code></pre></div></div>
<p><code>#figure(...)</code>内で<code>image(...)</code>を使って画像を指定し、<code>caption</code>引数でキャプションを設定します。<code>width</code>引数で画像の幅を指定できます。</p>
<p>また、<code>&lt;my-fig&gt;</code>のように任意のラベルを付けることで、後で参照することができます。文書内で引用したい場合は<code>@my-fig</code>と書きます。</p>
</section>
<section id="表の挿入" class="level4">
<h4 class="anchored" data-anchor-id="表の挿入">表の挿入</h4>
<p>表は<code>#figure(...)</code>内で<code>table(...)</code>を使って挿入します。</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb12" style="background: #f1f3f5;"><pre class="sourceCode typst code-with-copy"><code class="sourceCode typst"><span id="cb12-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">#</span>figure<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span></span>
<span id="cb12-2">  table<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span></span>
<span id="cb12-3">    columns<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">12</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb12-4">    align<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>left<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> right<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> right<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> right<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> right<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> right<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> right<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> right<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> right<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> right<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> right<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> right<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">),</span></span>
<span id="cb12-5">    table<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>hline<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(),</span></span>
<span id="cb12-6">    table<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>header<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>repeat<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">true</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb12-7">      <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>model<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">],</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>mpg<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">],</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>cyl<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">],</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>disp<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">],</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>hp<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">],</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>drat<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">],</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>wt<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">],</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>qsec<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">],</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>vs<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">],</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>am<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">],</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>gear<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">],</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>carb<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">],</span></span>
<span id="cb12-8">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">),</span></span>
<span id="cb12-9">    table<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>hline<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(),</span></span>
<span id="cb12-10">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>Mazda RX4<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">],</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>21.0<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">],</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>6<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">],</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>160<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">],</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>110<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">],</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>3.90<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">],</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>2.620<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">],</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>16.46<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">],</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>0<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">],</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>1<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">],</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>4<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">],</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>4<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">],</span></span>
<span id="cb12-11">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>Mazda RX4 Wag<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">],</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>21.0<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">],</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>6<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">],</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>160<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">],</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>110<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">],</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>3.90<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">],</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>2.875<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">],</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>17.02<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">],</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>0<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">],</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>1<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">],</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>4<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">],</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>4<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">],</span></span>
<span id="cb12-12">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>Datsun 710<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">],</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>22.8<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">],</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>4<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">],</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>108<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">],</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>93<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">],</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>3.85<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">],</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>2.320<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">],</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>18.61<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">],</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>1<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">],</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>1<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">],</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>4<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">],</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>1<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">],</span></span>
<span id="cb12-13">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>Hornet 4 Drive<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">],</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>21.4<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">],</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>6<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">],</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>258<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">],</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>110<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">],</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>3.08<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">],</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>3.215<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">],</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>19.44<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">],</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>1<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">],</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>0<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">],</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>3<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">],</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>1<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">],</span></span>
<span id="cb12-14">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>Hornet Sportabout<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">],</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>18.7<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">],</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>8<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">],</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>360<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">],</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>175<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">],</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>3.15<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">],</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>3.440<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">],</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>17.02<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">],</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>0<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">],</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>0<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">],</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>3<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">],</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>2<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">],</span></span>
<span id="cb12-15">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>Valiant<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">],</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>18.1<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">],</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>6<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">],</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>225<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">],</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>105<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">],</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>2.76<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">],</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>3.460<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">],</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>20.22<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">],</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>1<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">],</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>0<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">],</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>3<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">],</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>1<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">],</span></span>
<span id="cb12-16">    table<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>hline<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(),</span></span>
<span id="cb12-17">    table<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>footer<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>repeat<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">false</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb12-18">      table<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>cell<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>align<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span> left<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> colspan<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">12</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb12-19">        text<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">([</span></span>
<span id="cb12-20">          <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">#</span>text<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>style<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"italic"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)[</span>Note:<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">]</span> This table shows the first few rows of the mtcars dataset.</span>
<span id="cb12-21">        <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">])</span></span>
<span id="cb12-22">      <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">),</span></span>
<span id="cb12-23">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">),</span></span>
<span id="cb12-24">  <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">),</span></span>
<span id="cb12-25">  caption<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>mtcars data<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">],</span></span>
<span id="cb12-26"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">&lt;mtcars&gt;</span></span></code></pre></div></div>
<p><strong>ポイント：</strong></p>
<ul>
<li><code>table(...)</code>内で列数や配置、ヘッダー、フッター、データ行を指定します。</li>
<li><code>columns</code>引数で列数を指定し、<code>align</code>引数で各列の配置を設定します。</li>
<li><code>table.header(...)</code>でヘッダー行を、<code>table.footer(...)</code>でフッター行を設定します。フッターは複雑ですが、<code>colspan</code>とフッター文をうまく変えながら調整してください。</li>
<li>データ行はカンマ区切りで各セルの内容を指定します。</li>
<li>表も図と同様に<code>&lt;mtcars&gt;</code>のようにラベルを付けることができ、<code>@mtcars</code>で参照できます。</li>
</ul>
<p>表の設定は少々ややこしいのですが、Rで作った表をTypstで出力するというのが1つ手としてあるかと思います。<br>
今回はその方法については書きませんが、必要であれば調べてみてください。</p>
<p>また、Typstの公式ドキュメントのページも参考にしてみてください。</p>
<div class="callout callout-style-simple callout-tip no-icon">
<div class="callout-body d-flex">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-body-container">
<p><a href="https://typst.app/docs/reference/model/table/">Table Function - Typst Documentation</a></p>
</div>
</div>
</div>
</section>
<section id="脚注" class="level4">
<h4 class="anchored" data-anchor-id="脚注">脚注</h4>
<p>脚注は<code>#footnote[...]</code>を使って挿入します。</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb13" style="background: #f1f3f5;"><pre class="sourceCode typst code-with-copy"><code class="sourceCode typst"><span id="cb13-1">これは脚注の例です<span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">#</span>footnote<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>これは脚注の内容です。<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">]</span>。</span></code></pre></div></div>
</section>
<section id="引用文献" class="level4">
<h4 class="anchored" data-anchor-id="引用文献">引用文献</h4>
<p>引用文献は<code>#bibliography(...)</code>を使って挿入します。</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb14" style="background: #f1f3f5;"><pre class="sourceCode typst code-with-copy"><code class="sourceCode typst"><span id="cb14-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">#</span>bibliography<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"references.bib"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span></span></code></pre></div></div>
<p>このセクションの見出しを変更したい場合は、以下のように前もって書いておきます。</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb15" style="background: #f1f3f5;"><pre class="sourceCode typst code-with-copy"><code class="sourceCode typst"><span id="cb15-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">#set</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">bibliography</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span></span>
<span id="cb15-2">  title<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"参考文献"</span></span>
<span id="cb15-3"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span></span>
<span id="cb15-4"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">#</span>bibliography<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"references.bib"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span></span></code></pre></div></div>
<p><code>references.bib</code>はBibTeX形式の文献データファイルです。自分で用意した<code>.bib</code>ファイルをアップロードして指定してください。</p>
<p>文中で引用したい場合は、<code>#cite(&lt;notsu_indirect_2025&gt;, form: "prose")</code>のように書きます。<code>&lt;notsu_indirect_2025&gt;</code>は<code>.bib</code>ファイル内で指定したラベルです。<code>form: "prose"</code>は引用形式を指定するオプションで、省略可能です。この設定だと</p>
<blockquote class="blockquote">
<p>Notsu et al.&nbsp;(2025)</p>
</blockquote>
<p>のように表示されます。</p>
<blockquote class="blockquote">
<p>(Notsu et al.&nbsp;2025)</p>
</blockquote>
<p>のように表示したい場合は<code>@notsu_indirect_2025</code>のように書きます。こちらは楽でいいですね。<br>
2つ以上並べたい場合は<code>@notsu_indirect_2025 @martinez_how_2022</code>のようにスペースで区切ってください。</p>
<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
<span class="screen-reader-only">Tip</span>テンプレート内の引用スタイルについて
</div>
</div>
<div class="callout-body-container callout-body">
<p>後に僕が作成したテンプレートを用いた例を示しますが、そこでは引用スタイルとして<code>template.typ</code>内で<code>chicago_author_date.csl</code>を指定しています。別のスタイルに変更したい場合は、他のCSLファイルをダウンロードしてアップロードし、<code>template.typ</code>内の該当部分を書き換えてください。</p>
</div>
</div>
</section>
</section>
<section id="typst基本文法のまとめ" class="level3">
<h3 class="anchored" data-anchor-id="typst基本文法のまとめ">Typst基本文法のまとめ</h3>
<p>ここまでで、Typstの基本的な文法を一通り学びました。</p>
<ul>
<li><strong>セクション</strong>: <code>=</code>、<code>==</code>でレベルを表現</li>
<li><strong>段落</strong>: 空行またはバックスラッシュ<code>\</code>で区切る</li>
<li><strong>強調</strong>: <code>*太字*</code>、<code>_イタリック_</code></li>
<li><strong>箇条書き</strong>: <code>-</code>で開始</li>
<li><strong>番号付きリスト</strong>: <code>1.</code>、<code>2.</code>で開始</li>
<li><strong>数式</strong>: <code>$...$</code>で囲む（インライン・ブロック両対応）</li>
<li><strong>図表</strong>: <code>#figure(...)</code>で挿入し、<code>&lt;label&gt;</code>でラベル付け、<code>@label</code>で参照</li>
<li><strong>脚注</strong>: <code>#footnote[...]</code></li>
<li><strong>引用</strong>: <code>@cite-key</code>または<code>#cite(...)</code></li>
<li><strong>改ページ</strong>: <code>#pagebreak()</code></li>
</ul>
<p>これらの基本文法は、テンプレートを使う場合も使わない場合も共通です。次のセクションでは、これらの知識を活用しながら、テンプレートを使った実践的な文書作成に進みます。</p>
</section>
</section>
<section id="テンプレートを使った実践" class="level2">
<h2 class="anchored" data-anchor-id="テンプレートを使った実践">テンプレートを使った実践</h2>
<p>基本的な書き方を学んだところで、次は僕が作成した<strong>経済学論文向けのテンプレート</strong>を使って、より本格的な文書を作成してみましょう。</p>
<p>テンプレートを使うことで、表紙のレイアウトや文献スタイル、フォーマットなどの細かい設定を自分で行う必要がなくなります。 もっと根本的に学びたい方は<a href="https://typst.app/docs/">Typstの公式ドキュメント</a>を参照してください。</p>
<section id="テンプレートの準備" class="level3">
<h3 class="anchored" data-anchor-id="テンプレートの準備">テンプレートの準備</h3>
<p>まず、以下の2ファイルをダウンロードするか、GitHubからご利用ください。</p>
<ul>
<li><a href="../../../../../data/251027_typst/template.typ" download="template.typ">template.typ</a></li>
<li><a href="../../../../../data/251027_typst/chicago-author-date.csl" download="chicago_author_date.csl">chicago_author_date.csl</a></li>
<li><a href="https://github.com/yo5uke/typst_econ_template">GitHubリポジトリ</a></li>
</ul>
<p>2つのファイルを準備できたら、Typstのエディタにアップロードします。サイドバーの「･･･」メニューから「Upload a new file」を選択してアップロードするか、ドラッグアンドドロップでアップロードします。 <code>template.typ</code>と<code>chicago_author_date.csl</code>が表示されている状態でスタートします。</p>
</section>
<section id="テンプレートを使った表紙の作成" class="level3">
<h3 class="anchored" data-anchor-id="テンプレートを使った表紙の作成">テンプレートを使った表紙の作成</h3>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<p>先に完成イメージを共有しておきます。</p>
<p><a href="../../../../../data/251027_typst/sample.pdf">テンプレートを使って作成したサンプル文書（PDF）</a></p>
</div>
</div>
<p>テンプレートの最大の利点は、複雑な表紙を簡単に作成できることです。表紙のイメージは以下です。</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://yo5uke.com/pages/tips/2025/10/251026_typst/image/hyoshi.png" class="img-fluid figure-img" style="width:50.0%"></p>
<figcaption>Typstで作成した表紙の例</figcaption>
</figure>
</div>
<p>これを目指していきたいと思います。</p>
<ol type="1">
<li>サイドバーの <i class="fa-solid fa-file" aria-label="file"></i> アイコンから新規ファイルを作成します。
<ul>
<li>ファイル名は<code>main.typ</code>としますが、任意の名前で構いません。</li>
</ul></li>
<li><code>main.typ</code>に以下のコードを記述します。</li>
</ol>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb16" style="background: #f1f3f5;"><pre class="sourceCode typst code-with-copy"><code class="sourceCode typst"><span id="cb16-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">#</span><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"template.typ"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span> article</span></code></pre></div></div>
<p>これは<code>template.typ</code>から<code>article</code>コンポーネントをインポートするコードです。この<code>article</code>に表紙の設定が含まれています。 今回は設定は既定のまま使用しますが、<code>template.typ</code>内の<code>article</code>コンポーネントを編集することで、諸々の細かい点を調整できます。</p>
<ol start="3" type="1">
<li>次に、表紙の内容を記述します。<code>main.typ</code>に以下のコードを追加します。</li>
</ol>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb17" style="background: #f1f3f5;"><pre class="sourceCode typst code-with-copy"><code class="sourceCode typst"><span id="cb17-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">#show</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span> article<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>with<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span></span>
<span id="cb17-2">  title<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>Minimal Article Template (Test)<span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">#</span>footnote<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">#</span>lorem<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">150</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)]],</span></span>
<span id="cb17-3">  authors<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span></span>
<span id="cb17-4">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span></span>
<span id="cb17-5">      name: <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Yosuke Abe"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb17-6">      affiliation: <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Example University"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb17-7">      email: <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"yosuke.abe0507@gmail.com"</span></span>
<span id="cb17-8">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">),</span></span>
<span id="cb17-9">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span></span>
<span id="cb17-10">      name: <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Taro Yamada"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb17-11">      affiliation: <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Example University"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb17-12">      email: <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"taro@example.jp"</span></span>
<span id="cb17-13">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span></span>
<span id="cb17-14">  <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">),</span></span>
<span id="cb17-15">  date<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span> datetime<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>today<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">().</span>display<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"[month repr:long] [day], [year]"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">),</span></span>
<span id="cb17-16">  abstract<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span></span>
<span id="cb17-17">    <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">#</span>lorem<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">150</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span></span>
<span id="cb17-18">  <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">],</span></span>
<span id="cb17-19">  jel-codes<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span></span>
<span id="cb17-20">    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"A1"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb17-21">    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"A2"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb17-22">    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"A3"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb17-23">    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"A4"</span></span>
<span id="cb17-24">  <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">),</span></span>
<span id="cb17-25">  keywords<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span></span>
<span id="cb17-26">    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Keyword 1"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb17-27">    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Keyword 2"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb17-28">    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Keyword 3"</span></span>
<span id="cb17-29">  <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span></span>
<span id="cb17-30"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span></span></code></pre></div></div>
<p><strong>ポイント：</strong></p>
<ul>
<li><code>#show: article.with(...)</code>は、<code>article</code>コンポーネントを表示するためのコードです。</li>
<li><code>title</code>、<code>authors</code>、<code>date</code>、<code>abstract</code>、<code>jel-codes</code>、<code>keywords</code>などの引数を指定して、表紙の内容を設定します。</li>
<li><code>title</code>には<code>#footnote[...]</code>を使って脚注を追加しています。謝辞を入れたい場合などに便利です。 著者は1人でも構いませんし、3人まで対応しています。また、<code>jel-codes</code>や<code>keywords</code>も任意です。</li>
<li><code>date</code>は現在の日付を自動的に取得して表示します。文字列で直接指定することも可能です。</li>
<li><code>abstract</code>内の<code>#lorem(150)</code>はダミーテキストを生成する関数ですので、実際の文章に置き換えてください。</li>
</ul>
<p>Typstはコンパイルが要りませんから、コードを記述するとリアルタイムでプレビューが表示されます。上の設定で先ほどの表紙が表示されるはずです<sup>2</sup>。</p>
</section>
<section id="テンプレートを使った本文の作成" class="level3">
<h3 class="anchored" data-anchor-id="テンプレートを使った本文の作成">テンプレートを使った本文の作成</h3>
<p>表紙ができたら、次は本文を書いていきます。先述の基本文法を使って、実際の文書を作成してみましょう。</p>
<p>テンプレートではセクション番号が自動的に振られるようになっているので、「1 Introduction」のように表示されます。先ほどの基本文法（セクション、数式、図表、引用など）をそのまま使えば、美しいレイアウトで文書が完成します。</p>
<section id="appendix" class="level4">
<h4 class="anchored" data-anchor-id="appendix">Appendix</h4>
<p>基本文法のところで参考文献の書き方を説明しましたが、アペンディクスを参考文献の後に差し込みたいかもしれません。参考文献はデフォルトでは1番最後のセクションになるので少々やっかいですが、以下のように記述し、その下に文章を書いていってください。</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb18" style="background: #f1f3f5;"><pre class="sourceCode typst code-with-copy"><code class="sourceCode typst"><span id="cb18-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">#</span>block<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span></span>
<span id="cb18-2">  <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">#</span>heading<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span></span>
<span id="cb18-3">    level<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb18-4">    numbering<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">none</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb18-5">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>Appendix<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">]</span></span>
<span id="cb18-6">  <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span></span>
<span id="cb18-7"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">]</span></span></code></pre></div></div>
<p>これでアペンディクスのセクションが作成されます。</p>
</section>
</section>
<section id="完成例のコード全文" class="level3">
<h3 class="anchored" data-anchor-id="完成例のコード全文">完成例のコード全文</h3>
<p>ここまでの内容をまとめた、完成版のコード全文を以下に示します。テンプレートのインポートから表紙設定、本文の記述まで、全てが含まれています。長いので折りたたんで置いておきますので、開いてご確認ください。</p>
<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center collapsed" data-bs-toggle="collapse" data-bs-target=".callout-3-contents" aria-controls="callout-3" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
<span class="screen-reader-only">Tip</span>コード全文（main.typの内容）
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-3" class="callout-3-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb19" style="background: #f1f3f5;"><pre class="sourceCode typst code-with-copy"><code class="sourceCode typst"><span id="cb19-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">#</span><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"template.typ"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span> article</span>
<span id="cb19-2"></span>
<span id="cb19-3"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">#show</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span> article<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>with<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span></span>
<span id="cb19-4">  title<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>Minimal Article Template (Test)<span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">#</span>footnote<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">#</span>lorem<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">150</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)]],</span></span>
<span id="cb19-5">  authors<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span></span>
<span id="cb19-6">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span></span>
<span id="cb19-7">      name: <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Yosuke Abe"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb19-8">      affiliation: <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Example University"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb19-9">      email: <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"yosuke.abe0507@gmail.com"</span></span>
<span id="cb19-10">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">),</span></span>
<span id="cb19-11">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span></span>
<span id="cb19-12">      name: <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Taro Yamada"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb19-13">      affiliation: <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Example University"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb19-14">      email: <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"taro@example.jp"</span></span>
<span id="cb19-15">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span></span>
<span id="cb19-16">  <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">),</span></span>
<span id="cb19-17">  date<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span> datetime<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>today<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">().</span>display<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"[month repr:long] [day], [year]"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">),</span></span>
<span id="cb19-18">  abstract<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span></span>
<span id="cb19-19">    <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">#</span>lorem<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">150</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span></span>
<span id="cb19-20">  <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">],</span></span>
<span id="cb19-21">  jel-codes<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span></span>
<span id="cb19-22">    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"A1"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb19-23">    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"A2"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb19-24">    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"A3"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb19-25">    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"A4"</span></span>
<span id="cb19-26">  <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">),</span></span>
<span id="cb19-27">  keywords<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span></span>
<span id="cb19-28">    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Keyword 1"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb19-29">    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Keyword 2"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb19-30">    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Keyword 3"</span></span>
<span id="cb19-31">  <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span></span>
<span id="cb19-32"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span></span>
<span id="cb19-33"></span>
<span id="cb19-34"></span>
<span id="cb19-35"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">= Introduction</span></span>
<span id="cb19-36"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">#</span>lorem<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">500</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">#</span>footnote<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">#</span>lorem<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">100</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)]</span></span>
<span id="cb19-37"></span>
<span id="cb19-38"><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">$</span></span>
<span id="cb19-39"><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">E = m c^2</span></span>
<span id="cb19-40"><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">$</span></span>
<span id="cb19-41"></span>
<span id="cb19-42"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">#</span>lorem<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">500</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span></span>
<span id="cb19-43"></span>
<span id="cb19-44"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">= Section</span></span>
<span id="cb19-45">Insert an image. <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">#</span>lorem<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">100</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span></span>
<span id="cb19-46"></span>
<span id="cb19-47"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">#</span>figure<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span></span>
<span id="cb19-48">  image<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span></span>
<span id="cb19-49">    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"seiji_souridaijin_woman_kaiken.png"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb19-50">    width<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">30%</span></span>
<span id="cb19-51">  <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">),</span></span>
<span id="cb19-52">  caption<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>Prime Minister<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">]</span></span>
<span id="cb19-53"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">&lt;prime-minister&gt;</span></span>
<span id="cb19-54"></span>
<span id="cb19-55"><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">@prime-minister</span> depicts a _female_ prime minister. </span>
<span id="cb19-56"></span>
<span id="cb19-57">- item 1</span>
<span id="cb19-58">- item 2</span>
<span id="cb19-59">  - item2.1</span>
<span id="cb19-60"></span>
<span id="cb19-61">1. item 1</span>
<span id="cb19-62">2. item 2</span>
<span id="cb19-63"></span>
<span id="cb19-64"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">#</span>lorem<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">100</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span></span>
<span id="cb19-65"></span>
<span id="cb19-66">Insert an table. <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">#</span>lorem<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">100</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> According to  <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">@notsu_indirect_2025</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">@martinez_how_2022</span>, hogehoge.</span>
<span id="cb19-67"></span>
<span id="cb19-68"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">#</span>figure<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span></span>
<span id="cb19-69">  table<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span></span>
<span id="cb19-70">    columns<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">12</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb19-71">    align<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>left<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> right<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> right<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> right<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> right<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> right<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> right<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> right<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> right<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> right<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> right<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> right<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">),</span></span>
<span id="cb19-72">    table<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>hline<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(),</span></span>
<span id="cb19-73">    table<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>header<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>repeat<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">true</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb19-74">      <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>model<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">],</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>mpg<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">],</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>cyl<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">],</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>disp<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">],</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>hp<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">],</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>drat<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">],</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>wt<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">],</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>qsec<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">],</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>vs<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">],</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>am<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">],</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>gear<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">],</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>carb<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">],</span></span>
<span id="cb19-75">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">),</span></span>
<span id="cb19-76">    table<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>hline<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(),</span></span>
<span id="cb19-77">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>Mazda RX4<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">],</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>21.0<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">],</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>6<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">],</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>160<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">],</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>110<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">],</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>3.90<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">],</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>2.620<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">],</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>16.46<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">],</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>0<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">],</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>1<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">],</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>4<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">],</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>4<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">],</span></span>
<span id="cb19-78">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>Mazda RX4 Wag<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">],</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>21.0<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">],</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>6<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">],</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>160<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">],</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>110<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">],</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>3.90<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">],</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>2.875<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">],</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>17.02<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">],</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>0<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">],</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>1<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">],</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>4<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">],</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>4<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">],</span></span>
<span id="cb19-79">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>Datsun 710<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">],</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>22.8<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">],</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>4<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">],</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>108<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">],</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>93<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">],</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>3.85<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">],</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>2.320<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">],</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>18.61<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">],</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>1<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">],</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>1<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">],</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>4<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">],</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>1<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">],</span></span>
<span id="cb19-80">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>Hornet 4 Drive<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">],</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>21.4<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">],</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>6<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">],</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>258<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">],</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>110<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">],</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>3.08<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">],</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>3.215<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">],</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>19.44<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">],</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>1<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">],</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>0<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">],</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>3<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">],</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>1<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">],</span></span>
<span id="cb19-81">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>Hornet Sportabout<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">],</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>18.7<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">],</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>8<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">],</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>360<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">],</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>175<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">],</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>3.15<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">],</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>3.440<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">],</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>17.02<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">],</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>0<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">],</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>0<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">],</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>3<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">],</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>2<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">],</span></span>
<span id="cb19-82">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>Valiant<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">],</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>18.1<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">],</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>6<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">],</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>225<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">],</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>105<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">],</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>2.76<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">],</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>3.460<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">],</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>20.22<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">],</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>1<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">],</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>0<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">],</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>3<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">],</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>1<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">],</span></span>
<span id="cb19-83">    table<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>hline<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(),</span></span>
<span id="cb19-84">    table<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>footer<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>repeat<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">false</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb19-85">      table<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>cell<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>align<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span> left<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> colspan<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">12</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb19-86">        text<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">([</span></span>
<span id="cb19-87">          <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">#</span>text<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>style<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"italic"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)[</span>Note:<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">]</span> This table shows the first few rows of the mtcars dataset.</span>
<span id="cb19-88">        <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">])</span></span>
<span id="cb19-89">      <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">),</span></span>
<span id="cb19-90">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">),</span></span>
<span id="cb19-91">  <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">),</span></span>
<span id="cb19-92">  caption<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>mtcars data<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">],</span></span>
<span id="cb19-93"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">&lt;mtcars&gt;</span></span>
<span id="cb19-94"></span>
<span id="cb19-95"><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">@mtcars</span> is mtcars data. <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">#</span>lorem<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">500</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span></span>
<span id="cb19-96"></span>
<span id="cb19-97"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">#</span>bibliography<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"references.bib"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span></span>
<span id="cb19-98"></span>
<span id="cb19-99"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">#</span>pagebreak<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">()</span></span>
<span id="cb19-100"></span>
<span id="cb19-101"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">#</span>block<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span></span>
<span id="cb19-102">  <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">#</span>heading<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span></span>
<span id="cb19-103">    level<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb19-104">    numbering<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">none</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb19-105">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>Appendix<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">]</span></span>
<span id="cb19-106">  <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span></span>
<span id="cb19-107"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">]</span></span>
<span id="cb19-108"></span>
<span id="cb19-109"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">#</span>lorem<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">500</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span></span></code></pre></div></div>
</div>
</div>
</div>
<p>このコードでは、前半で説明したTypstの基本文法（セクション、数式、図表、箇条書き、引用など）を活用しながら、テンプレートが提供する表紙機能や自動番号付けなどの恩恵を受けています。</p>
</section>
</section>
<section id="おわりに" class="level2">
<h2 class="anchored" data-anchor-id="おわりに">おわりに</h2>
<p>ここまでTypstの基本的な使い方と、テンプレートを使った実践的な文書作成方法を紹介しました。</p>
<section id="内容の振り返り" class="level3">
<h3 class="anchored" data-anchor-id="内容の振り返り">内容の振り返り</h3>
<p>この記事では、大きく2つに分けて説明をしました。</p>
<ol type="1">
<li><strong>Typstの基本文法</strong> - セクション、段落、強調、箇条書き、数式、図表、脚注、引用など、Typst全般で使える基本的な書き方</li>
<li><strong>テンプレートを使った応用</strong> - 経済学論文向けのテンプレートを使って、表紙や本文を効率的に作成する方法</li>
</ol>
<p>基本文法をしっかり理解しておけば、テンプレートを使わない場合や別のテンプレートを使う場合でも応用が利きます。一方、テンプレートを活用することで、複雑な設定を気にせず、内容の執筆に集中できるようになります。</p>
</section>
<section id="さらに学ぶために" class="level3">
<h3 class="anchored" data-anchor-id="さらに学ぶために">さらに学ぶために</h3>
<p>ある程度の機能はご紹介できたかと思いますが、実際に論文を書くとなるともっと細かい設定が必要になることもあるかと思います。</p>
<p>より高度な使い方を学びたい場合は、<a href="https://typst.app/docs/">Typstの公式ドキュメント</a>をご参照ください。また、気づいた点があれば随時テンプレートを更新していきたいと思います。</p>
<p>Typstは非常に強力で柔軟な組版システムです。LaTeXに比べてシンプルで直感的な構文を持ちながら、リアルタイムプレビュー機能によって執筆体験が大幅に向上します。ぜひこの記事を参考に、Typstでの文書作成にチャレンジしてみてください。</p>


<!-- -->

</section>
</section>


<div id="quarto-appendix" class="default"><section id="footnotes" class="footnotes footnotes-end-of-document"><h2 class="anchored quarto-appendix-heading">注</h2>

<ol>
<li id="fn1"><p>すみません、本ページのフォントの設定上イコールの数が見にくいですが、サブセクションでは2つのイコールを使用しています。↩︎</p></li>
<li id="fn2"><p>もし何も表示されない場合、<code>template.typ</code>がプレビューに表示されているかもしれません。サイドバーの<code>.typ</code>ファイルの右に目のアイコンがあると思いますが、<code>main.typ</code>横の目をクリックして表示してください。↩︎</p></li>
</ol>
</section></div> ]]></description>
  <category>Typst</category>
  <guid>https://yo5uke.com/pages/tips/2025/10/251026_typst/</guid>
  <pubDate>Sat, 25 Oct 2025 15:00:00 GMT</pubDate>
</item>
<item>
  <title>【Typst】Quartoで論文を書く【PDF】</title>
  <link>https://yo5uke.com/pages/tips/2025/10/251021_quarto_typst/</link>
  <description><![CDATA[ 

<div class="social-share-buttons">
  <!-- Twitter (X) -->
  <a href="" id="js-share-twitter" class="share_button ri--twitter-x-fill" target="_blank" rel="nofollow noopener noreferrer"></a>

  <!-- Bluesky -->
  <a href="" id="js-share-bluesky" class="share_button ri--bluesky-fill" target="_blank" rel="nofollow noopener noreferrer"></a>
</div>

<script>
  const twitterUsername = "@5uke_y";
  const blueskyUsername = "@5uke.bsky.social";

  const share_url = encodeURIComponent(location.href);
  const share_title = document.title;

  // Twitter (X)
  document.getElementById('js-share-twitter').setAttribute(
    "href",
    "https://twitter.com/share?url=" + share_url + "&text=" + share_title + " " + encodeURIComponent(twitterUsername) + " より" +
    "&hashtags=rstats"
  );

  // Bluesky
  document.getElementById('js-share-bluesky').setAttribute(
    "href",
    "https://bsky.app/intent/compose?text=" + share_title + " " + share_url + " " + encodeURIComponent(blueskyUsername) + " より"
  );
</script>





<section id="はじめに" class="level2">
<h2 class="anchored" data-anchor-id="はじめに">はじめに</h2>
<p>以前TinyTeXを使ってRStudio×Quartoで論文を書く方法についてご紹介しました。</p>
<div class="callout callout-style-simple callout-tip no-icon">
<div class="callout-body d-flex">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-body-container">
<p><a href="../../../../../pages/tips/2024/06/240629_write_thesis/index.html">【PDF】Quarto で論文を書く</a></p>
</div>
</div>
</div>
<p>しかし、TinyTeXを使った方法はいくらTiny（軽量）とはいえLaTeX特有のエラーが発生することもあり、論文を書くとなると、どうせなら細かい設定をするためにローカルのTeXやOverleafで書くことが多いのではないかと思います<sup>1</sup>。</p>
<p>そこで今回は、LaTeXも代わりうる新しい組版システムであるTypstを使ってQuartoで論文を書く方法をご紹介します。</p>
<p>また、英語論文のバージョンではありますが、Quarto拡張機能を作成し経済学論文のテンプレートも用意しましたので、併せてご紹介します。</p>
<p>Rの出力をシームレスにTypstに組み込むことが可能ですので、R（Python）ユーザーの方はぜひご活用ください。</p>
</section>
<section id="typstとは" class="level2">
<h2 class="anchored" data-anchor-id="typstとは">Typstとは？</h2>
<p>Typstは、新しいマークアップベースの組版システムで、オープンソースで提供されています。</p>
<p>基本的にはLaTeXと同様に、学術論文に適した高品質なPDFを生成することができますが、TypstにはLaTeXに比べていくつかの利点があります。</p>
<ul>
<li><strong>シンプルな文法</strong>: Typstの文法はLaTeXに比べて直感的で、学びやすいという特徴があります。<br>
※ただし、Quarto上で利用する場合はQuartoやR Markdown同様Markdownベースの記述となるため、Typstの文法を直接学ぶ必要はありません。</li>
<li><strong>リアルタイムプレビュー</strong>: Typstの公式オンラインエディタはリアルタイムプレビュー機能を備えており、編集内容が即座に反映されるため、効率的に文書を作成できます。<br>
※ただし、Quarto上ではリアルタイムプレビューは利用できません。<br>
</li>
<li><strong>高速なコンパイル</strong>: これはQuarto×Typstの場合ですが、Typst出力は非常に高速なコンパイルを実現しており、LaTeXの数倍の速度でPDFを生成できます。</li>
</ul>
<p>TypstにはOverleafのような公式<a href="https://typst.app/">オンラインエディタ</a>が提供されており、柔軟に文書を編集できますが、当然ながらそちらではTypstの文法を使って記述する必要があります。</p>
<p>一方で、<strong>Quartoを介してTypstを利用することで、Markdownベースの記述を保ちながらTypstの利点を活かす</strong>ことが可能です。</p>
<p>中でも特筆すべきはその<strong>コンパイル速度</strong>です。LaTeXのコンパイル時間にストレスを感じている方は、Typstの速さにきっと驚くでしょう！（ガチ）</p>
</section>
<section id="quartoでtypstを使う方法" class="level2">
<h2 class="anchored" data-anchor-id="quartoでtypstを使う方法">QuartoでTypstを使う方法</h2>
<p>デフォルトの設定でよければ、以下のようにYAMLヘッダーを設定するだけでTypstを利用できます。</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb1" style="background: #f1f3f5;"><pre class="sourceCode yaml code-with-copy"><code class="sourceCode yaml"><span id="cb1-1"><span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">---</span></span>
<span id="cb1-2"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">title</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">:</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> </span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"ドキュメントのタイトル"</span></span>
<span id="cb1-3"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">author</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">:</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> </span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"著者名"</span></span>
<span id="cb1-4"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">date</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">:</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> 2025-10-21</span></span>
<span id="cb1-5"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">format</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">:</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> typst</span></span>
<span id="cb1-6"><span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">---</span></span></code></pre></div></div>
<p>課題のレポートであればこれで十分なドキュメントを生成できるはずです。<strong>{tinytex}のようなパッケージのインストールも不要です</strong>。</p>
<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
<span class="screen-reader-only">Tip</span>参考
</div>
</div>
<div class="callout-body-container callout-body">
<p>自分の記事で恐縮ですが、以下をご覧いただければQuartoでの書き方がわかるかと思います。</p>
<ul>
<li><a href="../../../../../pages/tips/2024/03/240329_rmarkdown_pdf/index.html">【Typst】Quarto &amp; R MarkdownでPDF出力【LaTeX】</a></li>
<li><a href="../../../../../pages/tips/2024/05/240509_chunk_option/index.html">【Quarto】チャンクオプションまとめてみた【R Markdown】</a></li>
<li><a href="../../../../../pages/tips/2024/06/240629_write_thesis/index.html">【PDF】Quarto で論文を書く</a></li>
<li><a href="../../../../../pages/tips/2024/08/240802_quarto_markdown/index.html">【Quarto】マークダウンでできること！</a></li>
</ul>
</div>
</div>
</section>
<section id="quarto拡張機能を使う" class="level2">
<h2 class="anchored" data-anchor-id="quarto拡張機能を使う">Quarto拡張機能を使う</h2>
<p>冒頭にも書きました通り、英語論文用のテンプレートであるQuarto拡張機能を作成しました。作成に当たっては、自分が修士論文をQuartoで書こうとしたときに対応できず挫折した部分をなるべく補うように努めました。</p>
<section id="対応環境" class="level3">
<h3 class="anchored" data-anchor-id="対応環境">対応環境</h3>
<p>はじめに拡張機能を使うための対応環境について説明します。</p>
<ul>
<li>Quarto 1.8以上</li>
</ul>
<p>Rを使っていればQuartoはデフォルトで使えるのですが、現在はバージョンが1.8にはなっていないと思います。 その場合は、<a href="https://quarto.org/docs/get-started/">Quartoの公式サイト</a>から1.8以上をインストールしてください<sup>2</sup>。</p>
<p>また、RStudioあるいはPositronの環境を想定しています。</p>
</section>
<section id="拡張機能のインストール" class="level3">
<h3 class="anchored" data-anchor-id="拡張機能のインストール">拡張機能のインストール</h3>
<p>拡張機能は以下のコマンドでインストールできます。<strong>作業フォルダを開いた状態で実行してください。</strong></p>
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>ターミナル</strong></pre>
</div>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb2" data-filename="ターミナル" style="background: #f1f3f5;"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb2-1"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">quarto</span> install extension yo5uke/econ-a4</span></code></pre></div></div>
</div>
<p>実行するとYse/Noの確認が求められますので、<code>Y</code>を入力して進めてください。最後の「? View documentation using default browser? (Y/n)」は<code>n</code>でもよいのですが、ドキュメントが見れますので<code>Y</code>から使い方を確認してください。</p>
</section>
<section id="拡張機能の利用" class="level3">
<h3 class="anchored" data-anchor-id="拡張機能の利用">拡張機能の利用</h3>
<p>拡張機能を利用するには、YAMLヘッダーの<code>format</code>フィールドを以下のように設定します。</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb3" style="background: #f1f3f5;"><pre class="sourceCode yaml code-with-copy"><code class="sourceCode yaml"><span id="cb3-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">format</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">:</span></span>
<span id="cb3-2"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">  </span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">econ-a4-typst</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">:</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> default</span></span></code></pre></div></div>
<p>これで、経済学論文用のA4サイズのTypstテンプレートが利用できます。</p>
<p>使い方はGitHubリポジトリのREADMEにも記載していますので、<a href="https://github.com/yo5uke/econ-a4#readme">そちら</a>もご覧ください。</p>
</section>
<section id="サンプルコード" class="level3">
<h3 class="anchored" data-anchor-id="サンプルコード">サンプルコード</h3>
<p>以下は、拡張機能を利用したサンプルコードです。</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb4" style="background: #f1f3f5;"><pre class="sourceCode markdown code-with-copy"><code class="sourceCode markdown"><span id="cb4-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">---</span></span>
<span id="cb4-2"><span class="an" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">title:</span><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"> "Writing Papers with Quarto and Typst"</span></span>
<span id="cb4-3"><span class="an" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">author:</span><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"> </span></span>
<span id="cb4-4"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">  - name: Your Name</span></span>
<span id="cb4-5"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    affiliation: Your Affiliation</span></span>
<span id="cb4-6"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    email: your-address@example.com</span></span>
<span id="cb4-7"><span class="an" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">date:</span><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"> 2025-10-21</span></span>
<span id="cb4-8"><span class="an" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">date-format:</span><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"> long</span></span>
<span id="cb4-9"><span class="an" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">abstract:</span><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"> |</span></span>
<span id="cb4-10"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">  This is a sample abstract.</span></span>
<span id="cb4-11"><span class="an" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">keywords:</span><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"> [Quarto, Typst, Academic Writing, PDF Generation]</span></span>
<span id="cb4-12"><span class="an" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">format:</span></span>
<span id="cb4-13"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">  econ-a4-typst:</span></span>
<span id="cb4-14"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    toc: true</span></span>
<span id="cb4-15"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    number-sections: true</span></span>
<span id="cb4-16"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">---</span></span>
<span id="cb4-17"></span>
<span id="cb4-18"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">## Introduction</span></span>
<span id="cb4-19"></span>
<span id="cb4-20">@notsu_indirect_2025</span>
<span id="cb4-21"></span>
<span id="cb4-22">This is a sample introduction text.</span>
<span id="cb4-23"></span>
<span id="cb4-24"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">## Insert Figures</span></span>
<span id="cb4-25"></span>
<span id="cb4-26"><span class="in" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">```{r}</span></span>
<span id="cb4-27"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#| echo: false</span></span>
<span id="cb4-28"></span>
<span id="cb4-29"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(ggplot2)</span>
<span id="cb4-30"></span>
<span id="cb4-31"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Create a simple plot</span></span>
<span id="cb4-32"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ggplot</span>(mtcars, <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x =</span> wt, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y =</span> mpg)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb4-33">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_point</span>() <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb4-34">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">labs</span>(</span>
<span id="cb4-35">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">title =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Scatter plot of MPG vs Weight"</span>,</span>
<span id="cb4-36">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Weight (1000 lbs)"</span>,</span>
<span id="cb4-37">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Miles per Gallon"</span></span>
<span id="cb4-38">  )</span>
<span id="cb4-39"><span class="in" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">```</span></span>
<span id="cb4-40"></span>
<span id="cb4-41"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">## Insert Tables</span></span>
<span id="cb4-42"></span>
<span id="cb4-43"><span class="in" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">```{r}</span></span>
<span id="cb4-44"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#| echo: false</span></span>
<span id="cb4-45"></span>
<span id="cb4-46"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(knitr)</span>
<span id="cb4-47"></span>
<span id="cb4-48"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Create a simple table</span></span>
<span id="cb4-49"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">kable</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">head</span>(mtcars), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">caption =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Table 1: Sample of mtcars dataset"</span>)</span>
<span id="cb4-50"><span class="in" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">```</span></span>
<span id="cb4-51"></span>
<span id="cb4-52"><span class="in" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">```{=typst}</span></span>
<span id="cb4-53"><span class="in" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#bibliography("references.bib")</span></span>
<span id="cb4-54"><span class="in" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">```</span></span></code></pre></div></div>
<p>出力結果は<a href="demo/demo.pdf">こちら</a>からご確認ください（少しダミーテキストで文量を増やしています）。</p>
<p>参考文献のセクションについては現状生のTypstコードで指定する必要がありますので、例にあるように記述してください。“References”という見出しも自動で生成されます。</p>
<p>もちろんRコードを使って図や表を挿入することも可能です。分析の結果を一度画像等で出力することなく挿入できるため、論文作成が非常に楽になります（もちろんレポートも！）。</p>
</section>
<section id="今後の展望" class="level3">
<h3 class="anchored" data-anchor-id="今後の展望">今後の展望</h3>
<p>今回は英語論文用のテンプレートを作成しましたが、今後は日本語でも使えるテンプレートを作成したいと考えています。</p>
<p>やはり海外誌に出すような細かい設定を行う論文はQuartoを介さずTypstやLaTeXで書くことが多くなるかと思いますが、学位論文はこの拡張機能で十分対応できるようになればと考えています（とはいえ将来は細かい設定も詰めたい…！）。</p>
<p>テンプレートの限界については<a href="https://github.com/yo5uke/econ-a4#readme">README</a>にも記載していますので、ご覧ください。</p>
</section>
</section>
<section id="おわりに" class="level2">
<h2 class="anchored" data-anchor-id="おわりに">おわりに</h2>
<p>今回はQuartoの記述方法自体はほぼ説明しませんでしたが、Typst（＆作成したテンプレート）を使うことで、MarkdownベースでTypstの利点を享受できるということをお伝えできたかと思います。</p>
<p>ぜひTypstを使って快適な論文執筆ライフを送りましょう！🚀</p>
<div class="callout callout-style-simple callout-tip no-icon">
<div class="callout-body d-flex">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-body-container">
<p><a href="https://typst.app/docs/">Typst Documentation</a></p>
</div>
</div>
</div>


<!-- -->

</section>


<div id="quarto-appendix" class="default"><section id="footnotes" class="footnotes footnotes-end-of-document"><h2 class="anchored quarto-appendix-heading">注</h2>

<ol>
<li id="fn1"><p>かくいう僕も修士論文はローカルのTeXを使って書きました。↩︎</p></li>
<li id="fn2"><p>2025/10/21時点では1.8.5ですので、表示されているものをインストールすればOKです。↩︎</p></li>
</ol>
</section></div> ]]></description>
  <category>Typst</category>
  <category>Quarto</category>
  <category>R</category>
  <guid>https://yo5uke.com/pages/tips/2025/10/251021_quarto_typst/</guid>
  <pubDate>Mon, 20 Oct 2025 15:00:00 GMT</pubDate>
</item>
<item>
  <title>【Positron】拡張機能「Air」を使う【フォーマッタ】</title>
  <link>https://yo5uke.com/pages/tips/2025/10/251016_air/</link>
  <description><![CDATA[ 

<div class="social-share-buttons">
  <!-- Twitter (X) -->
  <a href="" id="js-share-twitter" class="share_button ri--twitter-x-fill" target="_blank" rel="nofollow noopener noreferrer"></a>

  <!-- Bluesky -->
  <a href="" id="js-share-bluesky" class="share_button ri--bluesky-fill" target="_blank" rel="nofollow noopener noreferrer"></a>
</div>

<script>
  const twitterUsername = "@5uke_y";
  const blueskyUsername = "@5uke.bsky.social";

  const share_url = encodeURIComponent(location.href);
  const share_title = document.title;

  // Twitter (X)
  document.getElementById('js-share-twitter').setAttribute(
    "href",
    "https://twitter.com/share?url=" + share_url + "&text=" + share_title + " " + encodeURIComponent(twitterUsername) + " より" +
    "&hashtags=rstats"
  );

  // Bluesky
  document.getElementById('js-share-bluesky').setAttribute(
    "href",
    "https://bsky.app/intent/compose?text=" + share_title + " " + share_url + " " + encodeURIComponent(blueskyUsername) + " より"
  );
</script>





<section id="はじめに" class="level2">
<h2 class="anchored" data-anchor-id="はじめに">はじめに</h2>
<p>Positronに標準でインストールされている拡張機能がいくつかあるのですが、その一つが「Air - R Language Support」です。</p>
<p>この拡張機能は、Rのコードを自動でフォーマットしてくれるもので、コードの可読性を向上させるのに役立ちます。</p>
<p>例えばどこで改行するのか、インデントはどうするのか、スペースをどこに入れるのかなどは人によってばらばらで、定まったルールがありません。場所によってスペースの有無が異なったり1行が長すぎたりするとコードが読みにくくなります。</p>
<p>Airは一定の規則に則りコードを整形してくれるので、コードの見た目を統一することができます。</p>
<p>これに関しては百聞は一見に如かずということで、早速使い方から実際の例まで見ていきましょう。</p>
</section>
<section id="airの使い方" class="level2">
<h2 class="anchored" data-anchor-id="airの使い方">Airの使い方</h2>
<p>AirはPositronに標準でインストールされているので、特にインストールする必要はありません。ただし、有効化はされていないので、設定から有効化していきましょう。</p>
<ol type="1">
<li>Positronの設定を開きます。
<ul>
<li>左下の歯車アイコンから開くか、<span class="visually-hidden">Ctrl-,</span>で開きます。</li>
</ul></li>
<li>画面右上の「設定 (JSON) を開く」から設定ファイルを開きます。</li>
</ol>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://yo5uke.com/pages/tips/2025/10/251016_air/image/open_json.png" class="img-fluid figure-img" style="width:30.0%"></p>
<figcaption>1番左のアイコンです</figcaption>
</figure>
</div>
<ol start="3" type="1">
<li>設定ファイルに以下のコードを追加します。
<ul>
<li>既に<code>[ ]</code>の中に記載があれば、その中に追記してください<sup>1</sup>。</li>
</ul></li>
</ol>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb1" style="background: #f1f3f5;"><pre class="sourceCode json code-with-copy"><code class="sourceCode json"><span id="cb1-1"><span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">[</span></span>
<span id="cb1-2">    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"[r]"</span><span class="er" style="color: #AD0000;
background-color: null;
font-style: inherit;">:</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb1-3">        <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">"editor.formatOnSave"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">:</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">true</span></span>
<span id="cb1-4">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb1-5"><span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">]</span></span></code></pre></div></div>
<ol start="4" type="1">
<li>保存します。</li>
</ol>
<p>これで設定は完了です。<code>.R</code>ファイル内で、Rのコードは<strong>保存するたびに自動で整形</strong>されるようになります。</p>
</section>
<section id="実際の例" class="level2">
<h2 class="anchored" data-anchor-id="実際の例">実際の例</h2>
<p>ではこのフォーマッタの力はどれほどのものなのか、実際に見ていきましょう。</p>
<p>例えば以下のようなコードがあったとします。</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb2" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1">my_function <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">function</span>(x,y){</span>
<span id="cb2-2"><span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span>(x<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span>y){<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">return</span>(x<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span>y)}<span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">else</span>{<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">return</span>(x<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>y)}</span>
<span id="cb2-3">}</span>
<span id="cb2-4">result<span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">my_function</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span>)<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">print</span>(result)</span></code></pre></div></div>
<p>このコードはインデントがなく、スペースの使い方も一貫していません。これを修正したいわけですが、手作業だと面倒ですし、ミスも起こり得ます。</p>
<p>フォーマッタはコードの保存時に整形してくれますから、することはただ保存するだけです。すると上のコードは以下のようになります。</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb3" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1">my_function <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">function</span>(x, y) {</span>
<span id="cb3-2">  <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> (x <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span> y) {</span>
<span id="cb3-3">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">return</span>(x <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> y)</span>
<span id="cb3-4">  } <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">else</span> {</span>
<span id="cb3-5">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">return</span>(x <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> y)</span>
<span id="cb3-6">  }</span>
<span id="cb3-7">}</span>
<span id="cb3-8">result <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">my_function</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span>)</span>
<span id="cb3-9"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">print</span>(result)</span></code></pre></div></div>
<p>インデントの追加やスペースの挿入など、コードが格段に読みやすくなりました。</p>
<p>リストなどで中身が多く1行に収まりきらない場合でも、適切に改行してくれます。</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb4" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1">my_vector <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">6</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">7</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">8</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">9</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span>)</span>
<span id="cb4-2">my_data_frame <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">data.frame</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">id =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">value =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rnorm</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span>),</span>
<span id="cb4-3">                            <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">category =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sample</span>(letters[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>], <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">replace =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">TRUE</span>))</span></code></pre></div></div>
<p>このコードも悪いコードではないのですが、やや右に比重がかかっている印象ですね。これをフォーマッタにかけると以下のようになります。</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb5" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1">my_vector <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">6</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">7</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">8</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">9</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span>)</span>
<span id="cb5-2">my_data_frame <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">data.frame</span>(</span>
<span id="cb5-3">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">id =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span>,</span>
<span id="cb5-4">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">value =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rnorm</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span>),</span>
<span id="cb5-5">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">category =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sample</span>(letters[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>], <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">replace =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">TRUE</span>)</span>
<span id="cb5-6">)</span></code></pre></div></div>
<p><code>data.frame()</code>の中身が見やすくなりました。</p>
<p>ちなみに<code>my_vector</code>の方も、最初に1度だけ改行しておくと、全て改行するスタイルにしてくれます。少し中身を変えて試してみます。</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb6" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Before</span></span>
<span id="cb6-2">my_vector <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(</span>
<span id="cb6-3">  <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Jane Doe"</span>,<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"John Smith"</span>)</span>
<span id="cb6-4"></span>
<span id="cb6-5"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># After</span></span>
<span id="cb6-6">my_vector <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(</span>
<span id="cb6-7">  <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Jane Doe"</span>,</span>
<span id="cb6-8">  <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"John Smith"</span></span>
<span id="cb6-9">)</span></code></pre></div></div>
<p>このように最初だけ改行しておけば、1行が短い場合でも残りの要素を改行してくれます。フォーマッタの力を借りるのであれば、スペースも気にせず書き連ね、必要に応じて1か所改行して保存するだけで整形することができ、非常に楽かもしれません。</p>
<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
<span class="screen-reader-only">Tip</span>コードのスタイルについて
</div>
</div>
<div class="callout-body-container callout-body">
<p>Tidyverseの生みの親であるHadley Wickhamは、『<a href="https://r4ds.hadley.nz/workflow-style.html">R for Data Science</a>』の中で、コードのスタイルについて以下のように述べています。</p>
<blockquote class="blockquote">
<p>If the function you’re piping into has named arguments (like <code>mutate()</code> or <code>summarize()</code>), put each argument on a new line. If the function doesn’t have named arguments (like <code>select()</code> or <code>filter()</code>), keep everything on one line unless it doesn’t fit, in which case you should put each argument on its own line.</p>
</blockquote>
<p>つまり、引数に名前がついている関数（<code>dplyr::mutate()</code>や<code>summarize()</code>など）では各引数を改行し、名前がついていない関数（<code>dplyr::select()</code>や<code>filter()</code>など）では1行にまとめるべきだとしています。</p>
<div class="cell">
<details class="code-fold">
<summary>コード</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb7" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(dplyr)</span>
<span id="cb7-2"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(nycflights13)</span>
<span id="cb7-3"></span>
<span id="cb7-4"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Strive for</span></span>
<span id="cb7-5">flights <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span></span>
<span id="cb7-6">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">group_by</span>(tailnum) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span></span>
<span id="cb7-7">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">summarize</span>(</span>
<span id="cb7-8">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">delay =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mean</span>(arr_delay, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">na.rm =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">TRUE</span>),</span>
<span id="cb7-9">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">n =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">n</span>()</span>
<span id="cb7-10">  )</span>
<span id="cb7-11"></span>
<span id="cb7-12"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Avoid</span></span>
<span id="cb7-13">flights <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span></span>
<span id="cb7-14">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">group_by</span>(</span>
<span id="cb7-15">    tailnum</span>
<span id="cb7-16">  ) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span></span>
<span id="cb7-17">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">summarize</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">delay =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mean</span>(arr_delay, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">na.rm =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">TRUE</span>), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">n =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">n</span>())</span></code></pre></div></div>
</details>
</div>
</div>
</div>
</section>
<section id="フォーマットを回避" class="level2">
<h2 class="anchored" data-anchor-id="フォーマットを回避">フォーマットを回避</h2>
<p>場合によってはフォーマッタの力を借りたくない場合もあるかもしれません。その場合は、以下のようにコードの前後にコメントを入れることで、フォーマットを回避することができます。</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb8" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb8-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># fmt: skip</span></span>
<span id="cb8-2">my_vector <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">6</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">7</span>,</span>
<span id="cb8-3"><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">8</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">9</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span>)</span></code></pre></div></div>
<p>このように<code># fmt: skip</code>を入れることで、そのコードブロックはフォーマッタの対象外となります。</p>
<p>また、これはコードの途中に挟むこともできます。</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb9" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb9-1">df <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> tibble<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">tibble</span>(</span>
<span id="cb9-2">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span>,</span>
<span id="cb9-3">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">6</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span></span>
<span id="cb9-4">) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span></span>
<span id="cb9-5">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># fmt: skip</span></span>
<span id="cb9-6">  dplyr<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mutate</span>(</span>
<span id="cb9-7">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">z =</span> x <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> y) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span></span>
<span id="cb9-8">  dplyr<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">select</span>(</span>
<span id="cb9-9">    col1,</span>
<span id="cb9-10">    col2,</span>
<span id="cb9-11">    col3,</span>
<span id="cb9-12">    col4</span>
<span id="cb9-13">  )</span></code></pre></div></div>
<p>同様に<code># fmt: skip</code>を入れることで、その行以降はフォーマッタの対象外となります。コードの途中に挟んだ場合、その後のコードは再びフォーマッタの対象となるので注意してください。ここで言えば<code>dplyr::select()</code>の行は再びフォーマッタの対象となり、整形されています。</p>
</section>
<section id="quartoにも反映させたい" class="level2">
<h2 class="anchored" data-anchor-id="quartoにも反映させたい">Quartoにも反映させたい</h2>
<p>以上の設定は<code>.R</code>ファイルに対してのみ有効です。Quartoドキュメント内のRコードチャンクに対しても同じようにフォーマッタを適用したい場合は、以下の設定を追加してください。</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb10" style="background: #f1f3f5;"><pre class="sourceCode json code-with-copy"><code class="sourceCode json"><span id="cb10-1"><span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">[</span></span>
<span id="cb10-2">    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"[r]"</span><span class="er" style="color: #AD0000;
background-color: null;
font-style: inherit;">:</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb10-3">        <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">"editor.formatOnSave"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">:</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">true</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb10-4">        <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">"editor.defaultFormatter"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">:</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Posit.air-vscode"</span></span>
<span id="cb10-5">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">}</span><span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb10-6"></span>
<span id="cb10-7">    <span class="er" style="color: #AD0000;
background-color: null;
font-style: inherit;">//</span> <span class="er" style="color: #AD0000;
background-color: null;
font-style: inherit;">以下を追記</span></span>
<span id="cb10-8">    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"[quarto]"</span><span class="er" style="color: #AD0000;
background-color: null;
font-style: inherit;">:</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb10-9">        <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">"editor.formatOnSave"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">:</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">true</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb10-10">        <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">"editor.defaultFormatter"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">:</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"quarto.quarto"</span></span>
<span id="cb10-11">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb10-12"><span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">]</span></span></code></pre></div></div>
<p>これでQuartoドキュメント内のRコードチャンクも保存するたびに自動で整形されるようになります。</p>
</section>
<section id="おわりに" class="level2">
<h2 class="anchored" data-anchor-id="おわりに">おわりに</h2>
<p>今回はPositronに標準でインストールされている拡張機能「Air」を紹介しました。</p>
<p>個人的にはコードの書き方にはその人の癖が出てそれはそれでよいものだと思っているのですが、とはいえ生成AIが発達してきた昨今ではコードもAIに書いてもらうことが増え、コードの品質の差はなくなってきているのではないかと思いますし、フォーマッタを使用することも今後より一般的になっていくのではないかと考えています。</p>
<p>Airは非常にシンプルで使いやすい拡張機能なので、ぜひ試してみてください。</p>
</section>
<section id="おまけpython用フォーマッタruff" class="level2">
<h2 class="anchored" data-anchor-id="おまけpython用フォーマッタruff">おまけ：Python用フォーマッタ「Ruff」</h2>
<p>PositronにはPython用のフォーマッタ「Ruff」も標準でインストールされています。こちらもAirと同様に設定から有効化することで、Pythonコードを自動で整形してくれます。</p>
<p>また、Jyputer Notebookにも適用したい場合は”notebook.formatOnSave.enabled”: true`も追加してください。</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb11" style="background: #f1f3f5;"><pre class="sourceCode json code-with-copy"><code class="sourceCode json"><span id="cb11-1"><span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">[</span></span>
<span id="cb11-2">    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"notebook.formatOnSave.enabled"</span><span class="er" style="color: #AD0000;
background-color: null;
font-style: inherit;">:</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">true</span><span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb11-3">    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"[python]"</span><span class="er" style="color: #AD0000;
background-color: null;
font-style: inherit;">:</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb11-4">        <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">"editor.formatOnSave"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">:</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">true</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb11-5">        <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">"editor.defaultFormatter"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">:</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"charliermarsh.ruff"</span></span>
<span id="cb11-6">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb11-7"><span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">]</span></span></code></pre></div></div>
</section>
<section id="参考" class="level2">
<h2 class="anchored" data-anchor-id="参考">参考</h2>
<ul>
<li><a href="https://posit-dev.github.io/air/">Air - R Language Support</a></li>
</ul>


<!-- -->

</section>


<div id="quarto-appendix" class="default"><section id="footnotes" class="footnotes footnotes-end-of-document"><h2 class="anchored quarto-appendix-heading">注</h2>

<ol>
<li id="fn1"><p>以前は<code>"editor.defaultFormatter": "Posit.air-vscode"</code>を設定する必要がありましたが、アップデートにより不要になりました。↩︎</p></li>
</ol>
</section></div> ]]></description>
  <category>R</category>
  <category>Positron</category>
  <guid>https://yo5uke.com/pages/tips/2025/10/251016_air/</guid>
  <pubDate>Wed, 15 Oct 2025 15:00:00 GMT</pubDate>
  <media:content url="https://yo5uke.com/pages/tips/2025/10/251016_air/image/thumbnail.png" medium="image" type="image/png" height="108" width="144"/>
</item>
<item>
  <title>開発コンテナの環境について</title>
  <link>https://yo5uke.com/pages/tips/2025/10/251011_dev_container/</link>
  <description><![CDATA[ 

<div class="social-share-buttons">
  <!-- Twitter (X) -->
  <a href="" id="js-share-twitter" class="share_button ri--twitter-x-fill" target="_blank" rel="nofollow noopener noreferrer"></a>

  <!-- Bluesky -->
  <a href="" id="js-share-bluesky" class="share_button ri--bluesky-fill" target="_blank" rel="nofollow noopener noreferrer"></a>
</div>

<script>
  const twitterUsername = "@5uke_y";
  const blueskyUsername = "@5uke.bsky.social";

  const share_url = encodeURIComponent(location.href);
  const share_title = document.title;

  // Twitter (X)
  document.getElementById('js-share-twitter').setAttribute(
    "href",
    "https://twitter.com/share?url=" + share_url + "&text=" + share_title + " " + encodeURIComponent(twitterUsername) + " より" +
    "&hashtags=rstats"
  );

  // Bluesky
  document.getElementById('js-share-bluesky').setAttribute(
    "href",
    "https://bsky.app/intent/compose?text=" + share_title + " " + share_url + " " + encodeURIComponent(blueskyUsername) + " より"
  );
</script>





<section id="はじめに" class="level2">
<h2 class="anchored" data-anchor-id="はじめに">はじめに</h2>
<p>VSCodeの開発コンテナは、開発環境をコード化し、再現性のある環境を提供する強力なツールです。</p>
<p>これまで本サイトでは開発コンテナを用いた環境構築についていくつかの記事を掲載してきました。しかし、自分にとってはややオーバースペックだった感も否めず、もう少しシンプルにできないかと考えることもありました。</p>
<p>本記事では改めて開発コンテナを用いた環境構築について検討し、Rの開発環境を構築する際に考慮すべきポイントや、実際の設定例についてまとめていきたいと思います。</p>
</section>
<section id="実行環境" class="level2">
<h2 class="anchored" data-anchor-id="実行環境">実行環境</h2>
<ul>
<li>Windows 11</li>
<li>WSL2 (Ubuntu 24.04)</li>
<li>Docker Desktop 4.47.0</li>
<li>VSCode</li>
</ul>
</section>
<section id="開発コンテナを用いるメリット" class="level2">
<h2 class="anchored" data-anchor-id="開発コンテナを用いるメリット">開発コンテナを用いるメリット</h2>
<p>開発コンテナを用いることで、以下のようなメリットがあります。</p>
<ul>
<li><strong>一貫性のある環境</strong>: 開発コンテナはコード化された設定ファイル（Dockerfileやdevcontainer.json）を使用するため、チーム全体で同じ環境を再現できます。</li>
<li><strong>依存関係の管理</strong>: 開発コンテナ内で必要なパッケージやツールをインストールすることで、依存関係の衝突を避けることができます。</li>
<li><strong>環境の分離</strong>: 開発コンテナはホストマシンから独立して動作するため、異なるプロジェクトで異なる環境を簡単に切り替えることができます。</li>
<li><strong>ポータビリティ</strong>: 開発コンテナは異なるマシンやOS間で同じ環境を提供できるため、開発者がどこでも同じ環境で作業できます。</li>
<li><strong>VSCodeとの統合</strong>: VSCodeは開発コンテナとシームレスに統合されており、コンテナ内で直接コードを編集、デバッグ、実行できます。</li>
<li><strong>RStudio Serverの利用</strong>: 開発コンテナ内にRStudio Serverをセットアップすることで、ブラウザベースでRの開発が可能になります。</li>
</ul>
<p>チームで研究・開発を行う際には非常に力を発揮することになりますが、個人で使う場合でも、環境の再現性や依存関係の管理が重要な場合には有用です。</p>
</section>
<section id="開発コンテナを用いる際の考慮点" class="level2">
<h2 class="anchored" data-anchor-id="開発コンテナを用いる際の考慮点">開発コンテナを用いる際の考慮点</h2>
<p>開発コンテナを用いる際には、以下のような点を考慮する必要があります。</p>
<ul>
<li><strong>学習コスト</strong>: Dockerや開発コンテナの設定に慣れるまでには時間がかかる場合があります。特に初心者にとっては、最初の設定が難しく感じられることがあります。</li>
<li><strong>設定の複雑さ</strong>: 開発コンテナの設定ファイルが複雑になることがあり、特に多くの依存関係やカスタム設定が必要な場合には管理が難しくなることがあります。</li>
<li><strong>チームの合意形成</strong>: 開発コンテナの使用に関して、チーム全体で合意を形成することが重要です。全員が同じツールやワークフローを使用することで、効率的な開発が可能になります。</li>
</ul>
<p>特に学習コストに関しては、互いに開発コンテナのメリットを理解していないと高くなってしまい、導入が難しくなることがあると感じています。</p>
</section>
<section id="rの開発環境構築例" class="level2">
<h2 class="anchored" data-anchor-id="rの開発環境構築例">Rの開発環境構築例</h2>
<p>Rの開発環境をDocker上で手軽に再現できるようにしたのが、rockerプロジェクトです。</p>
<p>そもそもDockerとは、アプリケーションとその依存関係をコンテナとしてパッケージ化し、どこでも同じ環境で実行できるようにする技術です。</p>
<p>rockerでは、R本体やTidyverse、RStudioなどをあらかじめ組み込んだイメージが用意されており、Dockerを使えばすぐに「同じ環境」で分析を始められます。</p>
<p>開発コンテナではこのrockerイメージをベースに設定を行うことで、VSCode上でも安定したRの実行環境を構築できます。</p>
<section id="プロジェクトフォルダの用意" class="level3">
<h3 class="anchored" data-anchor-id="プロジェクトフォルダの用意">プロジェクトフォルダの用意</h3>
<p>まず、VSCodeで開発コンテナを使用するためのプロジェクトフォルダを用意します。</p>
<p>任意のフォルダを作成し、その中に<code>.devcontainer</code>という名前のサブフォルダを作成します。ここでは仮にプロジェクトフォルダを<code>work</code>とすると、次に紹介する2つのファイルを追加して以下のような構成になります。</p>
<pre><code>work/
└── .devcontainer/
    ├── devcontainer.json
    └── Dockerfile</code></pre>
</section>
<section id="devcontainerdevcontainer.json" class="level3">
<h3 class="anchored" data-anchor-id="devcontainerdevcontainer.json">.devcontainer/devcontainer.json</h3>
<p>今回は開発コンテナを使用するということで、<code>devcontainer.json</code>と<code>Dockerfile</code>の2つのファイルを用いて設定を行います。</p>
<p>まず、<code>devcontainer.json</code>は開発コンテナの設定ファイルで、以下のような内容になります。</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb2" style="background: #f1f3f5;"><pre class="sourceCode json code-with-copy"><code class="sourceCode json"><span id="cb2-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb2-2">  <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">"name"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">:</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"yo5uke.github.io"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb2-3">  <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">"build"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">:</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb2-4">    <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">"dockerfile"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">:</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Dockerfile"</span></span>
<span id="cb2-5">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">},</span></span>
<span id="cb2-6"></span>
<span id="cb2-7">  <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">"remoteUser"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">:</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"rstudio"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb2-8">  <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">"overrideCommand"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">:</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">false</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb2-9"></span>
<span id="cb2-10">  <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">"containerEnv"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">:</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb2-11">    <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">"TZ"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">:</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Asia/Tokyo"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb2-12">    <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">"DISABLE_AUTH"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">:</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"true"</span></span>
<span id="cb2-13">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">},</span></span>
<span id="cb2-14"></span>
<span id="cb2-15">  <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">"workspaceFolder"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">:</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"/home/rstudio/${localWorkspaceFolderBasename}"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb2-16">  <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">"workspaceMount"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">:</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"source=${localWorkspaceFolder},target=/home/rstudio/${localWorkspaceFolderBasename},type=bind"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb2-17"></span>
<span id="cb2-18">  <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">"runArgs"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">:</span> <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">[</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"-p"</span><span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">,</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"8787:8787"</span><span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">]</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb2-19">  <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">"forwardPorts"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">:</span> <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">[</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">8787</span><span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">]</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb2-20">  <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">"portsAttributes"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">:</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb2-21">    <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">"8787"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">:</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">{</span> <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">"label"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">:</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"RStudio Server"</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb2-22">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">},</span></span>
<span id="cb2-23"></span>
<span id="cb2-24">  <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">"features"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">:</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb2-25">    <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">"ghcr.io/rocker-org/devcontainer-features/quarto-cli:latest"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">:</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb2-26">      <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">"version"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">:</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"1.8.25"</span></span>
<span id="cb2-27">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb2-28">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">},</span></span>
<span id="cb2-29"></span>
<span id="cb2-30">  <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">"customizations"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">:</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb2-31">    <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">"vscode"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">:</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb2-32">      <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">"extensions"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">:</span> <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">[</span></span>
<span id="cb2-33">        <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"REditorSupport.r"</span><span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb2-34">        <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Posit.air-vscode"</span><span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb2-35">        <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"ms-python.python"</span><span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb2-36">        <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"quarto.quarto"</span><span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb2-37">        <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"ms-toolsai.jupyter"</span><span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb2-38">        <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"GitHub.copilot"</span><span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb2-39">        <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"GitHub.vscode-pull-request-github"</span><span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb2-40">        <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"janisdd.vscode-edit-csv"</span><span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb2-41">        <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"James-Yu.latex-workshop"</span></span>
<span id="cb2-42">      <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">]</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb2-43">      <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">"settings"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">:</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb2-44">        <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">"python.defaultInterpreterPath"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">:</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"/home/rstudio/.venv/bin/python"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb2-45">        <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">"python.terminal.activateEnvironment"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">:</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">false</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb2-46">        <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">"r.plot.useHttpgd"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">:</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">true</span></span>
<span id="cb2-47">      <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb2-48">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb2-49">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb2-50"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">}</span></span></code></pre></div></div>
<p>この設定ファイルでは、以下のポイントに注目してください。</p>
<ul>
<li><code>build.dockerfile</code>: 使用するDockerfileを指定します。
<ul>
<li>ここでは同じディレクトリにある<code>Dockerfile</code>を指定しています。</li>
</ul></li>
<li><code>remoteUser</code>: コンテナ内で使用するユーザーを指定します。rockerイメージでは<code>rstudio</code>ユーザーがデフォルトです。</li>
<li><code>containerEnv</code>: コンテナ内の環境変数を設定します。ここではタイムゾーンとRStudio Serverの認証無効化を設定しています。
<ul>
<li>RStudio Serverでは通常ユーザー名とパスワードで認証が必要ですが、<code>DISABLE_AUTH</code>を<code>true</code>に設定することで、認証を無効化しています。</li>
</ul></li>
<li><code>workspaceFolder</code>と<code>workspaceMount</code>: ホストマシンの作業ディレクトリをコンテナ内にマウントする設定です。</li>
<li><code>runArgs</code>と<code>forwardPorts</code>: RStudio Serverのポート（8787）をホストマシンにフォワードする設定です。</li>
<li><code>features</code>: Quarto CLIをインストールするための設定です。バージョンを指定できます。</li>
<li><code>customizations.vscode</code>: VSCodeの拡張機能や設定を指定します。RやPython、Quartoなどの拡張機能をインストールしています。</li>
</ul>
<p>ここではPythonの設定も含めていますが、Pythonを使わない場合は削除しても問題ありません。具体的にはVSCodeの拡張機能と設定の部分を削除してください。</p>
</section>
<section id="devcontainerdockerfile" class="level3">
<h3 class="anchored" data-anchor-id="devcontainerdockerfile">.devcontainer/Dockerfile</h3>
<p>次に、<code>Dockerfile</code>はコンテナのベースイメージや追加のパッケージを指定するファイルです。<code>devcontainer.json</code>と同じディレクトリに配置してください。</p>
<p>以下のような内容になります。</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb3" style="background: #f1f3f5;"><pre class="sourceCode dockerfile code-with-copy"><code class="sourceCode dockerfile"><span id="cb3-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">FROM</span> rocker/verse:4.5.1</span>
<span id="cb3-2"></span>
<span id="cb3-3"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">ENV</span> DEBIAN_FRONTEND=noninteractive</span>
<span id="cb3-4"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">SHELL</span> [<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"/bin/bash"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"-o"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"pipefail"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"-c"</span>]</span>
<span id="cb3-5"></span>
<span id="cb3-6"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">RUN</span> <span class="ex" style="color: null;
background-color: null;
font-style: inherit;">R</span> <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">-q</span> <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">-e</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"install.packages(c('renv','languageserver','httpgd'))"</span></span>
<span id="cb3-7"></span>
<span id="cb3-8"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">RUN</span> <span class="ex" style="color: null;
background-color: null;
font-style: inherit;">apt-get</span> update <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">\</span></span>
<span id="cb3-9"> <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">&amp;&amp;</span> <span class="ex" style="color: null;
background-color: null;
font-style: inherit;">apt-get</span> install <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">-y</span> <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">--no-install-recommends</span> <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">\</span></span>
<span id="cb3-10">      python3 python3-venv python3-pip <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">\</span></span>
<span id="cb3-11"> <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">&amp;&amp;</span> <span class="ex" style="color: null;
background-color: null;
font-style: inherit;">apt-get</span> clean <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">\</span></span>
<span id="cb3-12"> <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">&amp;&amp;</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rm</span> <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">-rf</span> /var/lib/apt/lists/<span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">*</span></span>
<span id="cb3-13"></span>
<span id="cb3-14"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">RUN</span> <span class="ex" style="color: null;
background-color: null;
font-style: inherit;">python3</span> <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">-m</span> venv /home/rstudio/.venv <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">\</span></span>
<span id="cb3-15"> <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">&amp;&amp;</span> <span class="ex" style="color: null;
background-color: null;
font-style: inherit;">/home/rstudio/.venv/bin/python</span> <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">-m</span> pip install <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">--upgrade</span> pip <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">\</span></span>
<span id="cb3-16"> <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">&amp;&amp;</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">chown</span> <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">-R</span> rstudio:rstudio /home/rstudio/.venv</span>
<span id="cb3-17"></span>
<span id="cb3-18"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">ENV</span> VIRTUAL_ENV=/home/rstudio/.venv</span>
<span id="cb3-19"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">ENV</span> PATH=<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"${VIRTUAL_ENV}/bin:${PATH}"</span></span>
<span id="cb3-20"></span>
<span id="cb3-21"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">EXPOSE</span> 8787</span></code></pre></div></div>
<p>このDockerfileでは、以下のポイントに注目してください。</p>
<ul>
<li><code>FROM rocker/verse:4.5.1</code>: rockerのverseイメージをベースにしています。verseイメージにはR本体、Tidyverse、RStudioが含まれています。必要に応じて他のrockerイメージを選択できます。
<ul>
<li>詳しくは<a href="https://rocker-project.org/images/">rockerの公式ページ</a>を参照してください。</li>
</ul></li>
<li><code>RUN R -q -e "install.packages(c('renv','languageserver','httpgd'))"</code>: Rのパッケージをインストールしています。ここでは<code>renv</code>、<code>languageserver</code>、<code>httpgd</code>をインストールしています。
<ul>
<li>VSCode上でRを利用しない場合は<code>renv</code>のみでよいと思います。</li>
</ul></li>
<li><code>RUN apt-get install -y python3 python3-venv python3-pip</code>: Pythonの仮想環境を作成するために必要なパッケージをインストールしています。
<ul>
<li>Pythonを使わない場合はこの行を削除してください。</li>
</ul></li>
<li><code>RUN python3 -m venv /home/rstudio/.venv</code>: RStudioユーザーのホームディレクトリにPythonの仮想環境を作成しています。
<ul>
<li>Pythonを使わない場合はこの行も削除してください。</li>
</ul></li>
<li><code>EXPOSE 8787</code>: RStudio Serverのポートを公開しています。</li>
</ul>
</section>
</section>
<section id="開発コンテナの起動" class="level2">
<h2 class="anchored" data-anchor-id="開発コンテナの起動">開発コンテナの起動</h2>
<p>設定ファイルが準備できたら、VSCodeでプロジェクトフォルダを開き、コマンドパレット（<span class="visually-hidden"></span>）から「Dev Containers: Reopen in Container」を選択します。</p>
<p>これにより、VSCodeが開発コンテナをビルドし、コンテナ内で作業できるようになります。</p>
<p>コンテナのビルドには時間がかかる場合がありますが、一度ビルドが完了すれば、次回からは迅速に起動できます。</p>
</section>
<section id="rstudio-serverへのアクセス" class="level2">
<h2 class="anchored" data-anchor-id="rstudio-serverへのアクセス">RStudio Serverへのアクセス</h2>
<p>開発コンテナが起動したら、ブラウザで<code>localhost:8787</code>にアクセスします。</p>
<p>RStudio Server上でプロジェクトフォルダを開き、Rプロジェクトを作成して作業を始めましょう。</p>
</section>
<section id="おわりに" class="level2">
<h2 class="anchored" data-anchor-id="おわりに">おわりに</h2>
<p>今回は<code>devcontainer.json</code>と<code>Dockerfile</code>を紹介することがメインだったので環境構築の手順についてはごく簡単に説明しました。</p>
<p>もし興味があれば、以下の記事も参考にしてみてください。</p>
<div class="callout callout-style-simple callout-tip no-icon">
<div class="callout-body d-flex">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-body-container">
<p><a href="../../../../../pages/tips/2024/12/241219_container/index.html">【改訂版】開発コンテナを使ってR環境を構築！</a></p>
</div>
</div>
</div>
<p>そこまで大きくないデータでしたらGitHubを通じて管理できます。もしデータが大きくなればDVCなど他のツールを利用することも検討するのがよいと思います。</p>
<p>ご参考まで。</p>


<!-- -->

</section>

 ]]></description>
  <category>R</category>
  <category>Docker</category>
  <category>VSCode</category>
  <guid>https://yo5uke.com/pages/tips/2025/10/251011_dev_container/</guid>
  <pubDate>Fri, 10 Oct 2025 15:00:00 GMT</pubDate>
</item>
<item>
  <title>【renv】仮想環境を設定する【venv】</title>
  <link>https://yo5uke.com/pages/tips/2025/09/250926_virtual_environment/</link>
  <description><![CDATA[ 

<div class="social-share-buttons">
  <!-- Twitter (X) -->
  <a href="" id="js-share-twitter" class="share_button ri--twitter-x-fill" target="_blank" rel="nofollow noopener noreferrer"></a>

  <!-- Bluesky -->
  <a href="" id="js-share-bluesky" class="share_button ri--bluesky-fill" target="_blank" rel="nofollow noopener noreferrer"></a>
</div>

<script>
  const twitterUsername = "@5uke_y";
  const blueskyUsername = "@5uke.bsky.social";

  const share_url = encodeURIComponent(location.href);
  const share_title = document.title;

  // Twitter (X)
  document.getElementById('js-share-twitter').setAttribute(
    "href",
    "https://twitter.com/share?url=" + share_url + "&text=" + share_title + " " + encodeURIComponent(twitterUsername) + " より" +
    "&hashtags=rstats"
  );

  // Bluesky
  document.getElementById('js-share-bluesky').setAttribute(
    "href",
    "https://bsky.app/intent/compose?text=" + share_title + " " + share_url + " " + encodeURIComponent(blueskyUsername) + " より"
  );
</script>





<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
<span class="screen-reader-only">Note</span>uvを使った仮想環境の設定方法について
</div>
</div>
<div class="callout-body-container callout-body">
<p>Pythonの仮想環境としてvenvを紹介していますが、よりモダンかつ強力なuvを使った環境構築・パッケージ管理の方法を追記しました。<br>
<strong>爆速</strong>で環境構築ができるので、是非ご参考になさってください。</p>
</div>
</div>
<section id="はじめに" class="level2">
<h2 class="anchored" data-anchor-id="はじめに">はじめに</h2>
<p>みなさん、仮想環境、使っていらっしゃいますでしょうか。</p>
<p>プログラミングにおける仮想環境とは、プロジェクトごとに依存パッケージを切り分けて管理できる仕組みです。これにより、他のプロジェクトやシステム全体に影響を与えず、再現性の高い開発環境を保つことができます。研究や開発を長期に続ける上で、安定した環境を構築するために欠かせないものです。</p>
<p>例えば、仮想環境をしない場合とする場合で、以下のような違いがあります。</p>
<p>【仮想環境なし】</p>
<ul>
<li>全プロジェクトで共通のRやPythonのパッケージ（同じバージョン）を使用する。</li>
<li>あるプロジェクトのためにパッケージを更新すると、他のプロジェクトで動かなくなるリスクがある。</li>
<li>チームで共有するとき、同じ環境を再現するのが難しい。</li>
</ul>
<p>【仮想環境あり】</p>
<ul>
<li>プロジェクトごとにパッケージのバージョンを使い分ける。</li>
<li>依存関係を切り分けることで、環境が壊れるリスクを減らせる。</li>
<li>設定ファイルを共有すれば、他の人も同じ環境を簡単に再現できる。</li>
</ul>
<p>本ページでは、これらの違いについて説明しつつ、実際に導入するためのコードも掲載しますので、仮想環境になじみのない方から、知ってはいるけど毎度どうやるんだっけ…となってしまう方までご参考にしていただければと思います。</p>
</section>
<section id="仮想環境について" class="level2">
<h2 class="anchored" data-anchor-id="仮想環境について">仮想環境について</h2>
<p>仮想環境のポイントは、上で書いた通りです。もう少し詳しく書きます。</p>
<p>例えば、3年前のRと現在のRでは、バージョンも利用できるパッケージも大きく異なります。もしRやパッケージを常に最新に保っていた場合、3年前に書いたコードがそのまま期待通りに動作するとは限りません。計算方法が変わっていたり、古い関数が削除されていたりして、過去の研究を再現できない可能性があるのです。</p>
<p>この点、仮想環境では「<strong>バージョンごとに環境を保存する</strong>」ことで問題に対応できます。例えば、あるパッケージの現在のバージョンが1.2.3だとしても、3年後には1.5.4へ更新されているかもしれません。仮想環境を使えば「このプロジェクトではバージョン1.2.3を使用していますよ」とファイルに記録し、後からその環境を再現することができるのです。</p>
<p>こうすることで、研究当時の環境を正確に呼び出せるため、バージョン変更に伴うトラブルを避け、長期的に安定した再現性を確保できます。</p>
<p>ちなみに本ページではRに関してはrenv、Pythonに関してはvenvを使用します。どちらもメジャーな仮想環境であり、これを使えていれば問題ないと思います。</p>
<p>Pythonに関してはcondaなど他のメジャーな仮想環境もありますが、本ページを見てくださっている方であれば個人的にはvenvで十分だと考えています。これは目的にもよりますので、興味がある方は他の仮想環境も調べてみてください。</p>
</section>
<section id="renv" class="level2">
<h2 class="anchored" data-anchor-id="renv">renv</h2>
<p>ではRの方の説明から始めます。</p>
<p>renvは、R プロジェクトごとに使用するパッケージの情報を ロックファイル（<code>renv.lock</code>） に記録し、必要に応じて同じ環境を再現できるようにするパッケージです。このロックファイルが「このパッケージのバージョン1.2.3を使用していますよ」ということを保存しているということですね。</p>
<p>ライブラリはグローバル環境とは分離され、プロジェクト専用のフォルダに保存されます。これにより「どのパッケージを、どのバージョンで使っていたか」が明示され、数年後でも同じ環境を復元することが可能になります。</p>
<p>もし仮想環境を使ったことがない方であれば、今あなたが使っているのがグローバル環境です。グローバル環境でパッケージをアップデートした場合、もれなくすべてのプロジェクトでパッケージのバージョンが更新されます。renvを使用していれば、そのプロジェクトについてだけバージョンが更新されるという仕組みです。</p>
<section id="renvの始め方" class="level3">
<h3 class="anchored" data-anchor-id="renvの始め方">renvの始め方</h3>
<p>始め方は極めて簡単です。</p>
<p>まずはプロジェクトを作成します。プロジェクトとは？という方であれば、RStudioユーザーの方であれば<a href="../../../../../pages/tips/2024/05/240515_rproj/index.html">こちら</a>、Positronの方であれば<a href="../../../../../pages/tips/2025/09/250901_positron_setting/index.html#project-manager">こちら</a>をご参考になさってください。</p>
<p>そしたらコンソールで以下を実行します。</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb1" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># renvをまだインストールしていない場合は先にこちらを実行</span></span>
<span id="cb1-2"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># install.packages("renv")</span></span>
<span id="cb1-3"></span>
<span id="cb1-4">renv<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">init</span>()</span></code></pre></div></div>
<p>renvを開始する、というわかりやすい関数ですね。するとワーキングディレクトリ内にrenvというフォルダと、<code>.Rprofile</code>、<code>renv.lock</code>ファイルが作成されます。これで設定やらなにやらをしていますので、ファイルは消さないようにしてください。</p>
<p>後は通常通り作業を進めます。パッケージのインストールや、アップデートをしても、それはこのファイル内でのみ適用されます。</p>
</section>
<section id="保存の仕方" class="level3">
<h3 class="anchored" data-anchor-id="保存の仕方">保存の仕方</h3>
<p>作業を一通り終えたら、ロックファイルにパッケージのバージョンを記述しないといけません（もちろん自動でやってくれます）。以下を実行してください。</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb2" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1">renv<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">snapshot</span>()</span></code></pre></div></div>
<p><code>Do you want to proceed? [Y/n]:</code>と出てきたら<code>Y</code>を入力し、<code>- Lockfile written to "~/yo5uke.github.io/renv.lock".</code>と出てきたら保存完了です。</p>
<p>新しいパッケージを追加したらその都度スナップショットを実行してください。ちなみにインストールしただけでは記載の対象にならず、プロジェクト内のコードで使用したパッケージのみ記載されます。この点renvは賢いですよね。</p>
</section>
<section id="環境の呼び出し方" class="level3">
<h3 class="anchored" data-anchor-id="環境の呼び出し方">環境の呼び出し方</h3>
<p>例えばPCを変更して、環境が移ったとします。すると新しい環境ではパッケージが何もインストールされていない状態です。</p>
<p>しかしプロジェクトをGit経由等で新しい環境に移せたら、ロックファイルがありますので、その情報をもとに必要なパッケージをインストールすることが可能です。</p>
<p><code>renv</code>パッケージがインストールされていない場合はしてから、以下の関数を実行します。</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb3" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># install.packages("renv")</span></span>
<span id="cb3-2">renv<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">restore</span>()</span></code></pre></div></div>
<p>これでロックファイル内に記載されているパッケージが、バージョンを保ったまま新しい環境にインストールされます。これで前のPCと同じ環境が再現できるというわけです。</p>
<p>ちなみに新しいPCというわけではなくとも、GitHubにプロジェクトをアップロードしておけば、当然ロックファイルもGitHub上に保存されるわけですので、再度GitHubから引っ張ってくれば、ローカルから一度プロジェクトを削除しても後々再現ができるわけです。これは地味にうれしいですよね。</p>
</section>
<section id="まとめ" class="level3">
<h3 class="anchored" data-anchor-id="まとめ">まとめ</h3>
<p><code>init()</code>、<code>snapshot()</code>、<code>restore()</code>の3つが使えれば、renvを使いこなせていると言えるでしょう。近年は再現可能な研究への需要が高まってきていますから、Rユーザーの方はぜひrenvを使ってみてください。</p>
</section>
</section>
<section id="venv" class="level2">
<h2 class="anchored" data-anchor-id="venv">venv</h2>
<p>Pythonは少々ややこしいと個人的に感じています<sup>1</sup>。</p>
<p>renvはR上で完結する一方、venvはPowerShellないしコマンドプロンプトを使う必要があるからです<sup>2</sup>。</p>
<p>それでは改めてvenvについて説明します。</p>
<p>venvは<code>Python</code>に標準で付属している仮想環境ツールで、プロジェクトごとに独立したパッケージ環境を作成できます。</p>
<p>venvで作成した環境はプロジェクト内の<code>.venv</code>フォルダに保存され、そこにPython本体や必要なライブラリがインストールされます。そのため、システム全体のPythonに影響を与えることなく、プロジェクトごとにライブラリのバージョンを固定できます。</p>
<p>さらに、<code>requirements.txt</code>というファイルを用いれば、使用しているライブラリとそのバージョンを記録し、他の人や別の環境でも同じ構成を再現できます。これはRの<code>renv.lock</code>に相当する役割です。</p>
<section id="sec-init-venv" class="level3">
<h3 class="anchored" data-anchor-id="sec-init-venv">venvの始め方</h3>
<p>それではvenv環境を作る手順に移ります。</p>
<p>VSCodeもしくはPositronの場合、まずプロジェクト（ワークスペース）を開いたのち、<code>Ctrl</code> + <code>Shift</code> + <code>@</code>でターミナルを開きます。</p>
<p>開けたら、以下を入力して実行します。</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb4" style="background: #f1f3f5;"><pre class="sourceCode sh code-with-copy"><code class="sourceCode bash"><span id="cb4-1"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">python</span> <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">-m</span> venv .venv</span></code></pre></div></div>
<p>これは独立したPython環境を<code>.venv</code>というフォルダに作るということを意味しており、<code>.venv</code>という名前で作成すると、VSCodeやPositronが自動的に「これを仮想環境だな」と認識し、インタープリタの候補に出してくれるので必須ではないですがおすすめです<sup>3</sup>。</p>
<p>しかし、環境を作るだけでは自動でアクティベートされません（最初は自動で起動しないということです）。</p>
<p>VSCodeの場合方法は2つあります。1つ目は簡単で、ターミナルを新しくするということです。ターミナルの右上に<code>+</code>ボタンがありますので、これを押して新しいターミナルを開きます。すると以下のような表示が出ますので、これでアクティベートされています。</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://yo5uke.com/pages/tips/2025/09/250926_virtual_environment/image/activate_vscode.png" class="img-fluid figure-img"></p>
<figcaption>VSCodeのターミナル</figcaption>
</figure>
</div>
<p>頭に<code>(.venv)</code>と表示されていれば、アクティベートされています。</p>
<p>2つ目は、1つ目の方法でうまくいかなかったときにも有効な方法で、ターミナルに以下を打ち込んで実行します。</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb5" style="background: #f1f3f5;"><pre class="sourceCode sh code-with-copy"><code class="sourceCode bash"><span id="cb5-1"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">.venv/Scripts/activate</span></span></code></pre></div></div>
<p>これでアクティベートされます<sup>4</sup>。上の画像と同じ表示になると思いますのでご確認ください。</p>
<p>Positronの場合は、ウィンドウ右上の「R 4.5.1」や「Python 3.13.7」と表示があるところからインタープリタを選択します。</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://yo5uke.com/pages/tips/2025/09/250926_virtual_environment/image/venv_positron.gif" class="img-fluid figure-img"></p>
<figcaption>Positronのイメージ</figcaption>
</figure>
</div>
<p>「Venv: .venv」とあるものを選択すればvenv環境に移れます。こちらは簡単ですね。</p>
<p>ちなみに少し細かい話をすると、<code>.venv</code>は容量が大きい一方で、環境の再現自体は<code>requirements.txt</code>のみで担保できるため、Gitには保存せず<code>.gitignore</code>に<code>.venv/</code>と記載しておくのがよいと思います。そのため、後述しますが新しい環境では再度venv環境を作成してください。</p>
</section>
<section id="保存の仕方-1" class="level3">
<h3 class="anchored" data-anchor-id="保存の仕方-1">保存の仕方</h3>
<p>保存もターミナル上で行います（Pythonのコンソールではありません）。</p>
<p>ターミナルで以下を実行します。</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb6" style="background: #f1f3f5;"><pre class="sourceCode sh code-with-copy"><code class="sourceCode bash"><span id="cb6-1"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">pip</span> freeze <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span> requirements.txt</span></code></pre></div></div>
<p>これは先述の通り、<code>requirements.txt</code>というファイルにパッケージ名とバージョンを保存します。まさにロックファイルと同じような感じですが、中身を見てみると、<code>polars==1.33.1</code>のように、非常にシンプルな形で記載されています。</p>
<p>作業が終わったら、適宜保存してください。</p>
</section>
<section id="パッケージの呼び出し方" class="level3">
<h3 class="anchored" data-anchor-id="パッケージの呼び出し方">パッケージの呼び出し方</h3>
<p>R同様、新しい環境に移行したら、この<code>requirements.txt</code>ファイルからパッケージをバージョンごと再現する必要があります。</p>
<p>新しい環境だとまだ<code>.venv</code>が存在しないと思うので、前と同じ方法でvenv環境を作成したのち、<code>renv::restore()</code>と同じような働きをする以下のコマンドを実行します。</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb7" style="background: #f1f3f5;"><pre class="sourceCode sh code-with-copy"><code class="sourceCode bash"><span id="cb7-1"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">pip</span> install <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">-r</span> requirements.txt</span></code></pre></div></div>
<p><code>-r</code>は「ファイルに書かれたリストを読む」という意味で、これでファイル内に記載されているパッケージがまとめてインストールできます。</p>
</section>
<section id="まとめ-1" class="level3">
<h3 class="anchored" data-anchor-id="まとめ-1">まとめ</h3>
<p>renvよりはやや複雑ですが、ターミナル上で仮想環境の作成から再現まで行うことができます。必要なのは以下の3つです。</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb8" style="background: #f1f3f5;"><pre class="sourceCode sh code-with-copy"><code class="sourceCode bash"><span id="cb8-1"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">python</span> <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">-m</span> venv .venv</span>
<span id="cb8-2"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">pip</span> freeze <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span> requirements.txt</span>
<span id="cb8-3"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">pip</span> install <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">-r</span> requirements.txt</span></code></pre></div></div>
</section>
</section>
<section id="uvを使ったvenv環境の構築方法" class="level2">
<h2 class="anchored" data-anchor-id="uvを使ったvenv環境の構築方法">uvを使ったvenv環境の構築方法</h2>
<p>前述のvenvは標準的な方法ですが、よりモダンで強力な<code>uv</code>というツールを使った方法もあります。</p>
<p>uvはAstral社が開発したPythonの環境管理ツールで、裏でRust言語を使っているため非常に高速に動作します。</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://yo5uke.com/pages/tips/2025/09/250926_virtual_environment/image/uv_speed.svg" class="img-fluid figure-img"></p>
<figcaption><a href="https://docs.astral.sh/uv/">uv</a></figcaption>
</figure>
</div>
<section id="uvのインストール" class="level3">
<h3 class="anchored" data-anchor-id="uvのインストール">uvのインストール</h3>
<p>まずはuvをインストールします。以下のコマンドをターミナルで実行してください。</p>
<div class="tabset-margin-container"></div><div class="panel-tabset">
<ul class="nav nav-tabs"><li class="nav-item"><a class="nav-link active" id="tabset-1-1-tab" data-bs-toggle="tab" data-bs-target="#tabset-1-1" aria-controls="tabset-1-1" aria-selected="true" href="">Mac/Linux</a></li><li class="nav-item"><a class="nav-link" id="tabset-1-2-tab" data-bs-toggle="tab" data-bs-target="#tabset-1-2" aria-controls="tabset-1-2" aria-selected="false" href="">Windows</a></li></ul>
<div class="tab-content">
<div id="tabset-1-1" class="tab-pane active" aria-labelledby="tabset-1-1-tab">
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb9" style="background: #f1f3f5;"><pre class="sourceCode sh code-with-copy"><code class="sourceCode bash"><span id="cb9-1"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">curl</span> <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">-LsSf</span> https://astral.sh/uv/install.sh <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">|</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sh</span></span></code></pre></div></div>
</div>
<div id="tabset-1-2" class="tab-pane" aria-labelledby="tabset-1-2-tab">
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb10" style="background: #f1f3f5;"><pre class="sourceCode powershell code-with-copy"><code class="sourceCode powershell"><span id="cb10-1">powershell <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>ExecutionPolicy ByPass <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>c <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"irm https://astral.sh/uv/install.ps1 | iex"</span></span></code></pre></div></div>
</div>
</div>
</div>
</section>
<section id="まずはpip互換モード" class="level3">
<h3 class="anchored" data-anchor-id="まずはpip互換モード">まずは：pip互換モード</h3>
<p>pipとvenvに慣れている方は、まずは従来と同じ感覚でuvを使ってみましょう！</p>
<section id="仮想環境の作成" class="level4">
<h4 class="anchored" data-anchor-id="仮想環境の作成">仮想環境の作成</h4>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb11" style="background: #f1f3f5;"><pre class="sourceCode sh code-with-copy"><code class="sourceCode bash"><span id="cb11-1"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">uv</span> venv</span></code></pre></div></div>
<p>これだけでワーキングディレクトリに<code>.venv</code>フォルダが作成されます。従来の<code>python -m venv .venv</code>と同じですが、圧倒的に高速です！</p>
</section>
<section id="仮想環境の有効化" class="level4">
<h4 class="anchored" data-anchor-id="仮想環境の有効化">仮想環境の有効化</h4>
<div class="tabset-margin-container"></div><div class="panel-tabset">
<ul class="nav nav-tabs"><li class="nav-item"><a class="nav-link active" id="tabset-2-1-tab" data-bs-toggle="tab" data-bs-target="#tabset-2-1" aria-controls="tabset-2-1" aria-selected="true" href="">Mac/Linux</a></li><li class="nav-item"><a class="nav-link" id="tabset-2-2-tab" data-bs-toggle="tab" data-bs-target="#tabset-2-2" aria-controls="tabset-2-2" aria-selected="false" href="">Windows</a></li></ul>
<div class="tab-content">
<div id="tabset-2-1" class="tab-pane active" aria-labelledby="tabset-2-1-tab">
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb12" style="background: #f1f3f5;"><pre class="sourceCode sh code-with-copy"><code class="sourceCode bash"><span id="cb12-1"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">source</span> .venv/bin/activate</span></code></pre></div></div>
</div>
<div id="tabset-2-2" class="tab-pane" aria-labelledby="tabset-2-2-tab">
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb13" style="background: #f1f3f5;"><pre class="sourceCode powershell code-with-copy"><code class="sourceCode powershell"><span id="cb13-1"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">venv</span>\Scripts\activate</span></code></pre></div></div>
</div>
</div>
</div>
</section>
<section id="パッケージのインストール" class="level4">
<h4 class="anchored" data-anchor-id="パッケージのインストール">パッケージのインストール</h4>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb14" style="background: #f1f3f5;"><pre class="sourceCode sh code-with-copy"><code class="sourceCode bash"><span id="cb14-1"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">uv</span> pip install polars</span></code></pre></div></div>
<p>複数のパッケージをまとめてインストールすることもできます。</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb15" style="background: #f1f3f5;"><pre class="sourceCode sh code-with-copy"><code class="sourceCode bash"><span id="cb15-1"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">uv</span> pip install polars duckdb pandas</span></code></pre></div></div>
</section>
<section id="requirements.txtからのインストール" class="level4">
<h4 class="anchored" data-anchor-id="requirements.txtからのインストール">requirements.txtからのインストール</h4>
<p>従来の<code>requirements.txt</code>がある場合も、uvで簡単にインストールできます。</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb16" style="background: #f1f3f5;"><pre class="sourceCode sh code-with-copy"><code class="sourceCode bash"><span id="cb16-1"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">uv</span> pip install <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">-r</span> requirements.txt</span></code></pre></div></div>
</section>
<section id="パッケージのアンインストール" class="level4">
<h4 class="anchored" data-anchor-id="パッケージのアンインストール">パッケージのアンインストール</h4>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb17" style="background: #f1f3f5;"><pre class="sourceCode sh code-with-copy"><code class="sourceCode bash"><span id="cb17-1"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">uv</span> pip uninstall polars</span></code></pre></div></div>
<p>uvは通常のpipコマンドと互換性があるため、既存のワークフローにもスムーズに導入できると思います。</p>
</section>
</section>
<section id="より便利にプロジェクト管理モード" class="level3">
<h3 class="anchored" data-anchor-id="より便利にプロジェクト管理モード">より便利に：プロジェクト管理モード</h3>
<p>ここからがuvの真骨頂とも言える使い方です。</p>
<p>従来の方法では、プロジェクトごとに「venv作成 → activate → パッケージインストール」という手順を踏む必要がありました。uvのプロジェクト管理機能を使えば、<strong>この一連の流れを自動化し、環境の再現性も確保</strong>できます。</p>
<section id="プロジェクトの作成" class="level4">
<h4 class="anchored" data-anchor-id="プロジェクトの作成">プロジェクトの作成</h4>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb18" style="background: #f1f3f5;"><pre class="sourceCode sh code-with-copy"><code class="sourceCode bash"><span id="cb18-1"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">uv</span> init my-analysis</span>
<span id="cb18-2"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">cd</span> my-analysis</span></code></pre></div></div>
<p>これで<code>my-analysis</code>というフォルダが作成され、以下のファイルが自動生成されます：</p>
<ul>
<li><code>pyproject.toml</code>：プロジェクトの設定と依存パッケージを管理</li>
<li><code>.python-version</code>：使用するPythonバージョンを記録</li>
<li><code>README.md</code>：プロジェクトの説明</li>
<li><code>main.py</code>：サンプルスクリプト</li>
</ul>
</section>
<section id="パッケージの追加" class="level4">
<h4 class="anchored" data-anchor-id="パッケージの追加">パッケージの追加</h4>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb19" style="background: #f1f3f5;"><pre class="sourceCode sh code-with-copy"><code class="sourceCode bash"><span id="cb19-1"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">uv</span> add polars pandas matplotlib</span></code></pre></div></div>
<p>このコマンドを実行すると：</p>
<ol type="1">
<li>自動的に<code>.venv</code>フォルダが作成される（初回のみ）</li>
<li>パッケージがインストールされる</li>
<li><code>pyproject.toml</code>に依存関係が記録される</li>
<li><code>uv.lock</code>にバージョンが厳密に記録される</li>
</ol>
<p><strong>activateコマンドは不要です！（でかい）</strong></p>
<p>開発用のパッケージ（JupyterやPytestなど）を追加する場合は<code>--dev</code>オプションを使います。</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb20" style="background: #f1f3f5;"><pre class="sourceCode sh code-with-copy"><code class="sourceCode bash"><span id="cb20-1"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">uv</span> add <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">--dev</span> ipykernel pytest</span></code></pre></div></div>
</section>
<section id="スクリプトの実行" class="level4">
<h4 class="anchored" data-anchor-id="スクリプトの実行">スクリプトの実行</h4>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb21" style="background: #f1f3f5;"><pre class="sourceCode sh code-with-copy"><code class="sourceCode bash"><span id="cb21-1"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">uv</span> run python analysis.py</span></code></pre></div></div>
<p><code>uv run</code>を使えば、仮想環境を意識せずにスクリプトを実行できます。裏で自動的に<code>.venv</code>環境を使ってくれるので、activateし忘れる心配もありません！</p>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center collapsed" data-bs-toggle="collapse" data-bs-target=".callout-2-contents" aria-controls="callout-2" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
<span class="screen-reader-only">Note</span>VSCodeでのメリット
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-2" class="callout-2-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<p>Positronユーザーにはあまり関係ないのですが、VSCodeユーザーにとっては<strong>神機能</strong>だと思います。</p>
<p>pipの場合毎度アクティベートをするのが面倒なので、VSCodeの設定で「“python.terminal.activateEnvironment”: true」にして自動アクティベートを有効にし、<code>source .venv/bin/activate</code>を自動で実行しているのですが、困ったことにRのターミナルを開いたときにも走ってしまい、当然Rの関数でも何でもないのでエラーが出ます。別にただエラーが起きるだけなので無視しておけばよいのですが、気持ち悪さがありました。</p>
<p>しかしuvを使えばvenvを気にする必要がありませんから、「“python.terminal.activateEnvironment”: false」にしておけば自動アクティベートされず、当然Rのターミナルでもエラーが出なくなり、気分爽快です。</p>
<p>そもそもVSCodeでRを使っている人自体少ないと思うのですが、もし使っている方がいらっしゃればぜひお試しください。</p>
</div>
</div>
</div>
</section>
<section id="jupyter-notebookとの連携" class="level4">
<h4 class="anchored" data-anchor-id="jupyter-notebookとの連携">Jupyter Notebookとの連携</h4>
<p>Jupyter Notebookで分析する場合は、以下のようにします。</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb22" style="background: #f1f3f5;"><pre class="sourceCode sh code-with-copy"><code class="sourceCode bash"><span id="cb22-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># jupyterを追加</span></span>
<span id="cb22-2"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">uv</span> add jupyter</span>
<span id="cb22-3"></span>
<span id="cb22-4"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Jupyter Labを起動</span></span>
<span id="cb22-5"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">uv</span> run <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">--with</span> jupyter jupyter lab</span></code></pre></div></div>
<p>これでブラウザが立ち上がりJupyter Labが使えます。</p>
<p>Jupyter Notebook内でパッケージを新たにインストールする場合には注意が必要ですが、PowerShell/ターミナルで<code>uv add</code>をすれば問題ありませんので、基本的にインストールする場合はそちらを使いましょう。</p>
<p>Jupyter LabではなくPositron/VSCode上で<code>.ipynb</code>ファイルを編集する場合は、ファイル内右上の「カーネルの選択」よりプロジェクトの仮想環境を選択してください。</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://yo5uke.com/pages/tips/2025/09/250926_virtual_environment/image/kernel.png" class="img-fluid figure-img"></p>
<figcaption>「Uv: プロジェクト名」と書いてあるものを選びます</figcaption>
</figure>
</div>
</section>
<section id="環境の共有と再現" class="level4">
<h4 class="anchored" data-anchor-id="環境の共有と再現">環境の共有と再現</h4>
<p>プロジェクト管理モードの最大の利点は<strong>再現性</strong>です。</p>
<p>プロジェクトを作成した場合：</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb23" style="background: #f1f3f5;"><pre class="sourceCode sh code-with-copy"><code class="sourceCode bash"><span id="cb23-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># プロジェクト作成</span></span>
<span id="cb23-2"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">uv</span> init my-analysis</span>
<span id="cb23-3"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">cd</span> my-analysis</span>
<span id="cb23-4"></span>
<span id="cb23-5"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># パッケージ追加</span></span>
<span id="cb23-6"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">uv</span> add geopandas polars statsmodels matplotlib</span>
<span id="cb23-7"></span>
<span id="cb23-8"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Gitにコミット（.venvはコミットしないように注意）</span></span>
<span id="cb23-9"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">git</span> add pyproject.toml uv.lock .python-version</span>
<span id="cb23-10"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">git</span> commit <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">-m</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Initialize project"</span></span>
<span id="cb23-11"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">git</span> push</span></code></pre></div></div>
<p>Gitの操作はVSCodeやPositronのGit機能を使っても全く問題ありません。</p>
<p>共同研究者のPCなど、別のPCで同じ環境を再現する場合：</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb24" style="background: #f1f3f5;"><pre class="sourceCode sh code-with-copy"><code class="sourceCode bash"><span id="cb24-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># プロジェクトをクローン</span></span>
<span id="cb24-2"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">git</span> clone your-repository</span>
<span id="cb24-3"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">cd</span> my-analysis</span>
<span id="cb24-4"></span>
<span id="cb24-5"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 環境を完全再現</span></span>
<span id="cb24-6"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">uv</span> sync</span>
<span id="cb24-7"></span>
<span id="cb24-8"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># すぐに実行可能</span></span>
<span id="cb24-9"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">uv</span> run python analysis.py</span></code></pre></div></div>
<p><code>uv sync</code>コマンドは<code>uv.lock</code>ファイルを読み込んで、全く同じバージョンのパッケージをインストールします。これにより再現性が担保され、チーム全員が同じ環境で作業できます。</p>
</section>
<section id="パッケージの削除" class="level4">
<h4 class="anchored" data-anchor-id="パッケージの削除">パッケージの削除</h4>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb25" style="background: #f1f3f5;"><pre class="sourceCode sh code-with-copy"><code class="sourceCode bash"><span id="cb25-1"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">uv</span> remove polars</span></code></pre></div></div>
<p><code>pyproject.toml</code>と<code>uv.lock</code>から自動的に削除され、<code>.venv</code>からもアンインストールされます。</p>
</section>
</section>
<section id="つの方法の比較" class="level3">
<h3 class="anchored" data-anchor-id="つの方法の比較">2つの方法の比較</h3>
<table class="caption-top table">
<colgroup>
<col style="width: 13%">
<col style="width: 28%">
<col style="width: 57%">
</colgroup>
<thead>
<tr class="header">
<th>項目</th>
<th>pip互換モード</th>
<th>プロジェクト管理モード（推奨）</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>仮想環境作成</td>
<td><code>uv venv</code></td>
<td>自動作成</td>
</tr>
<tr class="even">
<td>環境の有効化</td>
<td><code>source .venv/bin/activate</code></td>
<td>不要（<code>uv run</code>が自動処理）</td>
</tr>
<tr class="odd">
<td>パッケージ追加</td>
<td><code>uv pip install &lt;pkg&gt;</code></td>
<td><code>uv add &lt;pkg&gt;</code></td>
</tr>
<tr class="even">
<td>依存関係の記録</td>
<td>手動（<code>requirements.txt</code>）</td>
<td>自動（<code>pyproject.toml</code>+<code>uv.lock</code>）</td>
</tr>
<tr class="odd">
<td>環境の再現</td>
<td><code>uv pip install -r requirements.txt</code></td>
<td><code>uv sync</code></td>
</tr>
<tr class="even">
<td>適している場面</td>
<td>既存のpipワークフローを維持したい</td>
<td>新規プロジェクト、チーム開発、再現性重視</td>
</tr>
</tbody>
</table>
<p><strong>研究や分析用途では、プロジェクト管理モードがおすすめです！</strong>爆速＆楽なので、ぜひ試してみてください。</p>
</section>
<section id="uvを使うメリット" class="level3">
<h3 class="anchored" data-anchor-id="uvを使うメリット">uvを使うメリット</h3>
<p>uvを使うことで以下のようなメリットがあります：</p>
<section id="圧倒的な再現性" class="level4">
<h4 class="anchored" data-anchor-id="圧倒的な再現性">1. 圧倒的な再現性</h4>
<p><code>uv.lock</code>ファイルにより、プロジェクトの依存関係が厳密に記録されます。これにより：</p>
<ul>
<li>チーム全員が完全に同じ環境を構築可能</li>
<li>数ヶ月後・数年後でも同じ環境を再現可能</li>
<li>査読者や同僚が結果を検証しやすい</li>
</ul>
<p>研究の透明性と信頼性を高める上で、非常に重要な機能かと思います。</p>
</section>
<section id="高速なインストール" class="level4">
<h4 class="anchored" data-anchor-id="高速なインストール">2. 高速なインストール</h4>
<p>Rustで実装されているため、pipと比べて<strong>10〜100倍高速</strong>にパッケージをインストールできます。</p>
<p>大規模なデータ分析プロジェクトでは、セットアップ時間を大幅に短縮できます。</p>
</section>
<section id="環境管理が楽" class="level4">
<h4 class="anchored" data-anchor-id="環境管理が楽">3. 環境管理が楽</h4>
<p><code>uv run</code>を使えば、activateコマンドを意識する必要がありません。プロジェクト間の切り替えもスムーズです。</p>
</section>
<section id="pythonバージョンも管理可能" class="level4">
<h4 class="anchored" data-anchor-id="pythonバージョンも管理可能">4. Pythonバージョンも管理可能</h4>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb26" style="background: #f1f3f5;"><pre class="sourceCode sh code-with-copy"><code class="sourceCode bash"><span id="cb26-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Python 3.12をインストール</span></span>
<span id="cb26-2"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">uv</span> python install 3.12</span>
<span id="cb26-3"></span>
<span id="cb26-4"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># プロジェクトで使用するバージョンを固定</span></span>
<span id="cb26-5"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">uv</span> python pin 3.12</span></code></pre></div></div>
<p>pyenvなどの別ツールが不要で、uvだけで完結します。</p>
</section>
</section>
<section id="どちらの方法を選ぶべき" class="level3">
<h3 class="anchored" data-anchor-id="どちらの方法を選ぶべき">どちらの方法を選ぶべき？</h3>
<ul>
<li><strong>既存プロジェクトで、すでにpip + venvのワークフローが確立している</strong> → pip互換モードで試してみる</li>
<li><strong>新しい分析プロジェクトを始める</strong> → プロジェクト管理モードを使う</li>
<li><strong>チームで開発する、または環境を共有する</strong> → プロジェクト管理モード</li>
<li><strong>論文の再現性を確保したい</strong> → プロジェクト管理モード</li>
</ul>
<p>まずはpip互換モードで速度の違いを体感し、慣れてきたらプロジェクト管理モードに移行するのがおすすめです！</p>
<p>詳細は<a href="https://docs.astral.sh/uv/">公式ドキュメント</a>をご参照ください。</p>
<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
<span class="screen-reader-only">Tip</span>参考
</div>
</div>
<div class="callout-body-container callout-body">
<p><a href="https://docs.astral.sh/uv/">uv</a> - 公式ドキュメント</p>
</div>
</div>
</section>
</section>
<section id="まとめ-2" class="level2">
<h2 class="anchored" data-anchor-id="まとめ-2">まとめ</h2>
<p>今回は仮想環境のrenvとvenvについて簡単にご紹介しました。簡単にとはいうものの、エンジニアでもなければこれで十分ではないかと思っています。</p>
<p>仮想環境を活用しながら、再現可能な研究を進めていきましょう！</p>
<p>（余談：最近Geminiがすごいということで1か月だけ有料プランを試してみました。コードに関してはClaudeの方が優れていると感じましたが、サムネイルをいい感じに作ってくれて満足です笑）</p>


<!-- -->

</section>


<div id="quarto-appendix" class="default"><section id="footnotes" class="footnotes footnotes-end-of-document"><h2 class="anchored quarto-appendix-heading">注</h2>

<ol>
<li id="fn1"><p>Pythonはまだ勉強中ということもあり、マスターすれば大したことはないのかもしれません。↩︎</p></li>
<li id="fn2"><p>Macユーザーの方へは十分な説明になっていないかもしれませんが、ターミナルを使うことになると思います。↩︎</p></li>
<li id="fn3"><p>インタープリタというのは、使用するPythonのバージョンのようなイメージです。PCにインストールしたグローバルなPython環境と、venv環境がこの場合の選択肢です。↩︎</p></li>
<li id="fn4"><p><code>.venv</code>とは異なるフォルダ名で作成した場合はその名前に変えてください。↩︎</p></li>
</ol>
</section></div> ]]></description>
  <category>R</category>
  <category>Python</category>
  <category>VSCode</category>
  <category>Positron</category>
  <guid>https://yo5uke.com/pages/tips/2025/09/250926_virtual_environment/</guid>
  <pubDate>Thu, 25 Sep 2025 15:00:00 GMT</pubDate>
  <media:content url="https://yo5uke.com/pages/tips/2025/09/250926_virtual_environment/image/thumbnail.png" medium="image" type="image/png" height="79" width="144"/>
</item>
<item>
  <title>DuckDBをRで使う【duckplyrも】</title>
  <link>https://yo5uke.com/pages/tips/2025/09/250919_duckdb/</link>
  <description><![CDATA[ 

<div class="social-share-buttons">
  <!-- Twitter (X) -->
  <a href="" id="js-share-twitter" class="share_button ri--twitter-x-fill" target="_blank" rel="nofollow noopener noreferrer"></a>

  <!-- Bluesky -->
  <a href="" id="js-share-bluesky" class="share_button ri--bluesky-fill" target="_blank" rel="nofollow noopener noreferrer"></a>
</div>

<script>
  const twitterUsername = "@5uke_y";
  const blueskyUsername = "@5uke.bsky.social";

  const share_url = encodeURIComponent(location.href);
  const share_title = document.title;

  // Twitter (X)
  document.getElementById('js-share-twitter').setAttribute(
    "href",
    "https://twitter.com/share?url=" + share_url + "&text=" + share_title + " " + encodeURIComponent(twitterUsername) + " より" +
    "&hashtags=rstats"
  );

  // Bluesky
  document.getElementById('js-share-bluesky').setAttribute(
    "href",
    "https://bsky.app/intent/compose?text=" + share_title + " " + share_url + " " + encodeURIComponent(blueskyUsername) + " より"
  );
</script>





<section id="はじめに" class="level2">
<h2 class="anchored" data-anchor-id="はじめに">はじめに</h2>
<p>Rで大量のデータを扱う際、メモリ制限やパフォーマンスの問題に直面することがあります。そんなとき、軽量で高速な組み込み型のデータベースであるDuckDBを利用することで、効率的にデータ操作が可能になります。本記事では、RでDuckDBを使用する方法について解説します。</p>
</section>
<section id="duckdbとは" class="level2">
<h2 class="anchored" data-anchor-id="duckdbとは">DuckDBとは</h2>
<p>DuckDBは、組み込み型のSQLデータベースであり、特に分析ワークロードに最適化されています。SQLiteのように軽量でありながら、大規模なデータセットを効率的に処理できる点が特徴です。DuckDBは、列指向ストレージを採用しており、分析クエリのパフォーマンスが向上します。</p>
<p>ちなみに組み込み型データベースとは、アプリケーションに組み込まれて動作するデータベースのことを指します。サーバー型のデータベースとは異なり、外部のデータベースサーバーを必要とせず、アプリケーション内で直接データベース操作が可能です。すなわちR上で完結するということです。</p>
<p>列指向については、ブログでparquetを扱った際に少し触れています。以下もご覧ください。簡潔に言うと、列指向データベースは、データを列ごとに格納するため、特定の列に対するクエリが高速に処理されるという特徴があります。</p>
<div class="callout callout-style-simple callout-tip no-icon">
<div class="callout-body d-flex">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-body-container">
<p><a href="../../../../../pages/blog/2025/07/250728_parquet/index.html">Parquetファイルについて調べてみる</a></p>
</div>
</div>
</div>
</section>
<section id="duckdbのインストール" class="level2">
<h2 class="anchored" data-anchor-id="duckdbのインストール">DuckDBのインストール</h2>
<p>DuckDBをRで使用するには、<code>duckdb</code>パッケージをインストールします。</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb1" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># install.packages("pak")</span></span>
<span id="cb1-2">pak<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">pak</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"duckdb"</span>)</span></code></pre></div></div>
</div>
<p>もしくは</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb2" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">install.packages</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"duckdb"</span>)</span></code></pre></div></div>
</div>
</section>
<section id="duckdbの基本的な使い方" class="level2">
<h2 class="anchored" data-anchor-id="duckdbの基本的な使い方">DuckDBの基本的な使い方</h2>
<section id="データベースへの接続" class="level3">
<h3 class="anchored" data-anchor-id="データベースへの接続">データベースへの接続</h3>
<p>まずは、DuckDBデータベースに接続します。以下のコードでは、メモリ内データベースに接続していますが、ファイルベースのデータベースを使用することも可能です。</p>
<p>メモリ内データベースはRセッションが終了すると消えてしまいますが、ファイルベースのデータベースは永続的に保存されます。</p>
<p>ファイルベースのデータベースではディスクにデータが保存されるため、Rセッションを終了してもデータが保持されます。一方、メモリ内データベースはRセッションが終了するとデータが失われてしまいますが、読み書きの速度が速いという利点があります。</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb3" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(duckdb)</span></code></pre></div></div>
</div>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb4" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># メモリ内データベースに接続</span></span>
<span id="cb4-2">con <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">dbConnect</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">duckdb</span>(), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">dbdir =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">":memory:"</span>)</span></code></pre></div></div>
</div>
<p>ファイルベースのデータベースに接続する場合は、以下のようにします。</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb5" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># ファイルベースのデータベースに接続</span></span>
<span id="cb5-2">con <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">dbConnect</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">duckdb</span>(), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">dbdir =</span> here<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">here</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"data/iris.duckdb"</span>))</span></code></pre></div></div>
</div>
<p>この方法だと、<code>data</code>フォルダに<code>iris.duckdb</code>という名前でデータベースファイルが作成されます。<code>.duckdb</code>ファイルを置くパスは自由に変更してください。</p>
</section>
<section id="データの読み込み" class="level3">
<h3 class="anchored" data-anchor-id="データの読み込み">データの読み込み</h3>
<section id="sqlを使う場合" class="level4">
<h4 class="anchored" data-anchor-id="sqlを使う場合">SQLを使う場合</h4>
<p>DuckDBは様々なデータ形式をサポートしています。ここでは、CSVファイルを読み込む例を示します。</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb6" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># CSVファイルを読み込む</span></span>
<span id="cb6-2"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">dbExecute</span>(con, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"CREATE TABLE iris AS SELECT * FROM read_csv('data/iris.csv')"</span>)</span></code></pre></div></div>
</div>
<p>さて、ここで突然SQL文が出てきましたが、なんとなく単語を見てもらえればわかる通り、<code>read_csv('data/iris.csv')</code>から全ての列を選択（<code>*</code>は全ての列を意味します）して、<code>iris</code>という名前のテーブルを作成（<code>CREATE TABLE iris AS</code>）しています。</p>
<p>ちなみに、僕はSQLはあまりわかりません。いちいち調べないと先ほどのコードも書けないレベルなのですが、この方法をとるメリットを先に説明しておきます。</p>
<p>この方法のメリットは、<strong>Rに一度もデータを読み込まずに、DuckDBが直接CSVファイルを処理できる</strong>点です。 そのため、大規模なCSVでもメモリを無駄に消費せず、高速にテーブルを作成できます。</p>
<p>また、<code>CREATE TABLE ... AS SELECT ...</code>という形で書けば、SQLの標準的な構文で柔軟に前処理（列の選択やフィルタリングなど）を行いながら、テーブルを作成できます。</p>
</section>
<section id="rを使う場合" class="level4">
<h4 class="anchored" data-anchor-id="rを使う場合">Rを使う場合</h4>
<p>とはいえ新しくSQLを覚えるのは面倒だしRで書けたらうれしいという僕なので、ここでRを使うことの意義を示します。</p>
<p>それは、今提示したコードを皆さんおなじみ<code>dplyr</code>を使って実行できる、ということです。</p>
<p>それはすなわち<code>dplyr</code>を使って書いたコードをSQLに変換して実行してくれるということを意味しています。</p>
<p>データベースやSQLはなんだかよくわからないけれども、<code>dplyr</code>が使えるならうれしいですよね<sup>1</sup>。</p>
<p>その場合のコードを見てみましょう。</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb7" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(tidyverse) <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># `dplyr`だけでもOKです。</span></span></code></pre></div></div>
</div>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb8" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb8-1">iris_data <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">read_csv</span>(here<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">here</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"data/iris.csv"</span>))</span>
<span id="cb8-2"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">duckdb_register</span>(con, iris, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"iris_data"</span>)</span></code></pre></div></div>
</div>
<p>まずはデータベースに入れたいデータを<code>read_csv()</code>で読み込みます。ここでは<code>data</code>フォルダにある<code>iris.csv</code>を読み込んでいます。</p>
<p>続いて<code>duckdb_register()</code>を使って、<code>iris_data</code>を<code>iris</code>という名前でデータベースに登録しています。これでデータベース上に<code>iris</code>テーブルが作成されました。</p>
<p>ちなみにファイルベースのデータベースを使いたい場合は、<code>duckdb_register()</code>の代わりに<code>dbWriteTable()</code>を使います。</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb9" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb9-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">dbWriteTable</span>(con, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"iris"</span>, iris_data)</span></code></pre></div></div>
</div>
<p>これで<code>.duckdb</code>ファイルに<code>iris</code>テーブルが保存されます。</p>
<p>ちなみに、データベースにはテーブルを複数作成できるので、<code>iris</code>以外のデータもも好きな名前でテーブルを追加できます<sup>2</sup>。</p>
</section>
</section>
<section id="データの操作" class="level3">
<h3 class="anchored" data-anchor-id="データの操作">データの操作</h3>
<p>ところで、データベースを使うメリットのひとつに、遅延評価（lazy evaluation） があります。これは、実際に結果を取り出すまでSQLが実行されない仕組みのことです。</p>
<p>通常のデータ処理は<br>
データの読み込み → 書いた順に処理を実行 → 結果を返す<br>
という流れですが、遅延評価では<br>
データの読み込み → 書いた順に処理を記録 → 最後にまとめて実行（SQL発行） → 結果を返す<br>
という流れになります。</p>
<p>このおかげで、大規模なデータセットでも不要な計算が省かれ、効率的に処理できます。</p>
<section id="sqlを使う場合-1" class="level4">
<h4 class="anchored" data-anchor-id="sqlを使う場合-1">SQLを使う場合</h4>
<p>SQLを使ってデータを操作する場合、以下のようにクエリを実行します。</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb10" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb10-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># データをクエリする</span></span>
<span id="cb10-2">result <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">dbGetQuery</span>(con, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"SELECT * FROM iris WHERE Species = 'setosa'"</span>)</span></code></pre></div></div>
</div>
<p>この例では、<code>iris</code>テーブルから<code>Species</code>が<code>setosa</code>の行を選択しています。</p>
</section>
<section id="dplyrを使う場合" class="level4">
<h4 class="anchored" data-anchor-id="dplyrを使う場合"><code>dplyr</code>を使う場合</h4>
<p><code>dplyr</code>を使ってデータを操作する場合、以下のように記述します（おなじみの感じですね）。</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb11" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb11-1">result <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">tbl</span>(con, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"iris"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span></span>
<span id="cb11-2">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">filter</span>(Species <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"setosa"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span></span>
<span id="cb11-3">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">collect</span>()</span></code></pre></div></div>
</div>
<p><code>tbl(con, "iris")</code>でデータベース上の<code>iris</code>テーブルを参照し、<code>filter()</code>で条件を指定しています。最後に<code>collect()</code>を使って結果をRのデータフレームとして取得します。</p>
<p>ここで重要なのは、<strong><code>collect()</code>を呼び出すまではSQLは実行されない</strong>という点です。<code>filter()</code>などの処理を追加するたびに、裏でSQLクエリが少しずつ組み立てられていき、最後に<code>collect()</code>を呼び出した時点でまとめて実行されます。</p>
<p>つまり、<code>collect()</code>を呼び出すまではデータはRに読み込まれず、操作はあくまで「SQLを組み立てているだけ」です。<code>collect()</code>を実行した瞬間に初めてSQLが発行され、結果がRにデータフレームとして取り込まれます。</p>
<p>データベースになじみがない方は違和感があるかもしれませんが（かく言う僕もですが）、<code>con</code>自体はデータそのものではなく、DuckDBデータベースへの接続（コネクション）を表すオブジェクトです。</p>
<p>普段のRではデータフレームを直接操作しますが、ここではまず接続オブジェクト<code>con</code>を通して「このデータベースの中にあるテーブルを参照しますよ」という指示を出します。</p>
<p>つまり、<code>con</code>はデータの実体ではなく、<strong>「データベースへの窓口」や「リモコン」</strong>のようなものと考えると分かりやすいです（ChatGPT曰く）。</p>
<p>とりあえず、<code>collect()</code>の前までは通常のデータ処理と同じように<code>dplyr</code>の関数を使って操作できるので、慣れ親しんだ方法でデータを扱うことができます。</p>
</section>
</section>
<section id="テーブルの削除" class="level3">
<h3 class="anchored" data-anchor-id="テーブルの削除">テーブルの削除</h3>
<p>追加したテーブルを削除する場合は、以下のようにします。</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb12" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb12-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">dbExecute</span>(con, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"DROP TABLE iris"</span>)</span></code></pre></div></div>
</div>
<p>これで<code>iris</code>テーブルがデータベースから削除されます。</p>
<p>もし安全に削除したい場合は、</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb13" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb13-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">dbExecute</span>(con, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"DROP TABLE IF EXISTS iris"</span>)</span></code></pre></div></div>
</div>
<p>とすることで、テーブルが存在しない場合でもエラーにならずに処理を続行できます。</p>
</section>
<section id="データベースからの切断" class="level3">
<h3 class="anchored" data-anchor-id="データベースからの切断">データベースからの切断</h3>
<p>データベースの操作が終わったら、接続を切断します。</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb14" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb14-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">dbDisconnect</span>(con, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">shutdown =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">TRUE</span>)</span></code></pre></div></div>
</div>
<p><code>shutdown = TRUE</code>を指定すると、メモリ内データベースの場合はデータが消去され、ファイルベースのデータベースの場合は接続が閉じられます。</p>
</section>
</section>
<section id="duckplyrを使う" class="level2">
<h2 class="anchored" data-anchor-id="duckplyrを使う">{duckplyr}を使う</h2>
<p><code>duckplyr</code>パッケージを使うと、DuckDBと<code>dplyr</code>の連携がさらに便利になります。<code>duckplyr</code>は、DuckDB専用の<code>dplyr</code>拡張パッケージであり、DuckDBの機能をより活用できます。</p>
<section id="duckplyrとは" class="level3">
<h3 class="anchored" data-anchor-id="duckplyrとは">duckplyrとは</h3>
<p><code>duckplyr</code>は、<strong>dplyrのドロップイン置き換え</strong>として機能するパッケージです。既存のdplyrコードをそのまま使いながら、裏側でDuckDBの高速な分析エンジンを活用できます。</p>
</section>
<section id="先述のアプローチとの違い" class="level3">
<h3 class="anchored" data-anchor-id="先述のアプローチとの違い">先述のアプローチとの違い</h3>
<p>これまで紹介してきた<code>duckdb</code>パッケージを使った方法と<code>duckplyr</code>を使った方法の違いを整理します。</p>
<p><strong>duckdb × dbplyr（データベース操作）</strong></p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb15" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb15-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(dplyr)</span>
<span id="cb15-2"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(DBI)</span>
<span id="cb15-3"></span>
<span id="cb15-4"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># データベースに接続</span></span>
<span id="cb15-5">con <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">dbConnect</span>(duckdb<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">duckdb</span>())</span>
<span id="cb15-6"></span>
<span id="cb15-7"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># データベース上のテーブルを参照</span></span>
<span id="cb15-8"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">tbl</span>(con, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"my_table"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span></span>
<span id="cb15-9">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">filter</span>(value <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">100</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span></span>
<span id="cb15-10">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">summarise</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">total =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sum</span>(value))</span></code></pre></div></div>
<ul>
<li>データベースに接続する</li>
<li>dplyrの構文を<strong>SQLに翻訳</strong>して実行</li>
<li>データは基本的にDB上に存在</li>
<li><code>collect()</code>で初めてRのメモリに読み込まれる</li>
</ul>
<p><strong>duckplyr（メモリ内データの高速化）</strong></p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb16" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb16-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(duckplyr)</span>
<span id="cb16-2"></span>
<span id="cb16-3">df <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">data.frame</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1000000</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rnorm</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1000000</span>))</span>
<span id="cb16-4"></span>
<span id="cb16-5">df <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span></span>
<span id="cb16-6">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">filter</span>(y <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span></span>
<span id="cb16-7">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">summarise</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">mean_x =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mean</span>(x))</span></code></pre></div></div>
<ul>
<li><strong>データベース接続不要</strong></li>
<li>Rのメモリ上のデータをDuckDBエンジンで高速処理</li>
<li>SQLへ翻訳はされない（データはR上に存在）</li>
<li>既存のdplyrコードがそのまま高速化される</li>
</ul>
</section>
<section id="duckplyrの特徴" class="level3">
<h3 class="anchored" data-anchor-id="duckplyrの特徴">duckplyrの特徴</h3>
<ol type="1">
<li><strong>ドロップイン置き換え</strong>
<ul>
<li><code>library(duckplyr)</code>するだけで、多くのdplyr動詞が高速化</li>
<li>既存のコードを書き換える必要がほとんどない</li>
</ul></li>
<li><strong>自動フォールバック</strong>
<ul>
<li>duckplyrで対応できない操作は、自動的に通常のdplyrにフォールバック</li>
<li>エラーで止まることなく処理が継続されます</li>
</ul></li>
<li><strong>大規模データに最適</strong>
<ul>
<li>DuckDBの並列処理エンジンを活用</li>
<li>メモリ効率の良い処理が可能</li>
</ul></li>
<li><strong>互換性</strong>
<ul>
<li>dplyrの多くの関数に対応</li>
<li>tidyverseエコシステムとシームレスに連携</li>
</ul></li>
</ol>
<section id="簡単な使用例" class="level4">
<h4 class="anchored" data-anchor-id="簡単な使用例">簡単な使用例</h4>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb17" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb17-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(tidyverse)</span>
<span id="cb17-2"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(duckplyr)</span>
<span id="cb17-3"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt; Loading required package: dplyr</span></span>
<span id="cb17-4"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt; ✔ Overwriting dplyr methods with duckplyr methods.</span></span>
<span id="cb17-5"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt; ℹ Turn off with `duckplyr::methods_restore()`.</span></span>
<span id="cb17-6"></span>
<span id="cb17-7"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 通常のdplyr構文がそのまま使えます</span></span>
<span id="cb17-8">mtcars <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span></span>
<span id="cb17-9">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">group_by</span>(cyl) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span></span>
<span id="cb17-10">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">summarise</span>(</span>
<span id="cb17-11">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">mean_mpg =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mean</span>(mpg),</span>
<span id="cb17-12">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">mean_hp =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mean</span>(hp),</span>
<span id="cb17-13">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">.groups =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"drop"</span></span>
<span id="cb17-14">  )</span></code></pre></div></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 3 × 3
    cyl mean_mpg mean_hp
  &lt;dbl&gt;    &lt;dbl&gt;   &lt;dbl&gt;
1     4     26.7    82.6
2     6     19.7   122. 
3     8     15.1   209. </code></pre>
</div>
</div>
<p>注意点として、<strong>読み込み順序が重要</strong>です。<code>library(tidyverse)</code>の後に<code>library(duckplyr)</code>を読み込むことで、dplyrのメソッドがduckplyrで上書きされます。逆の順序で読み込むと、通常のdplyrが優先されてしまいます。</p>
<p>小さいデータだとあまり速さを実感できないかもしれませんが、大きいデータを扱うときに効果を発揮します。</p>
</section>
</section>
</section>
<section id="まとめ" class="level2">
<h2 class="anchored" data-anchor-id="まとめ">まとめ</h2>
<p>今回は、RでDuckDBを使用する方法についてまとめました。</p>
<p>DuckDBは軽量で高速な組み込み型データベースであり、大規模なデータセットを効率的に処理できます。SQLを直接使う方法と、<code>dplyr</code>を使う方法の両方が利用可能であり、遅延評価によりパフォーマンスが向上します。</p>
<p>また、<code>duckplyr</code>パッケージを使うことで、既存の<code>dplyr</code>コードをほぼそのまま高速化できるため、データ処理の効率化が図れます。</p>
<p>最近は仕事ででかいデータを扱うことが増えてきたので、今後もDuckDBを活用していきたいと思います（というか活用し始めています）。ぜひお試しあれ。</p>
</section>
<section id="参考" class="level2">
<h2 class="anchored" data-anchor-id="参考">参考</h2>
<div class="callout callout-style-simple callout-tip no-icon">
<div class="callout-body d-flex">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-body-container">
<p><a href="https://duckdb.org/docs/stable/clients/r.html">R Client - DuckDB</a></p>
</div>
</div>
</div>


<!-- -->

</section>


<div id="quarto-appendix" class="default"><section id="footnotes" class="footnotes footnotes-end-of-document"><h2 class="anchored quarto-appendix-heading">注</h2>

<ol>
<li id="fn1"><p>ただ、先ほどのメリットの裏返しで、一度R上でデータを読み込んでからデータベースに送り込むことになるので、メモリを多く消費することと、データが大きいと処理速度が遅くなることには注意してください。↩︎</p></li>
<li id="fn2"><p>とはいえ、プロジェクトごとなどで<code>.duckdb</code>は分けた方が良いとは思います。↩︎</p></li>
</ol>
</section></div> ]]></description>
  <category>R</category>
  <category>SQL</category>
  <category>データ処理</category>
  <guid>https://yo5uke.com/pages/tips/2025/09/250919_duckdb/</guid>
  <pubDate>Thu, 18 Sep 2025 15:00:00 GMT</pubDate>
</item>
<item>
  <title>Positronのおすすめ設定！【R | Python】</title>
  <link>https://yo5uke.com/pages/tips/2025/09/250901_positron_setting/</link>
  <description><![CDATA[ 

<div class="social-share-buttons">
  <!-- Twitter (X) -->
  <a href="" id="js-share-twitter" class="share_button ri--twitter-x-fill" target="_blank" rel="nofollow noopener noreferrer"></a>

  <!-- Bluesky -->
  <a href="" id="js-share-bluesky" class="share_button ri--bluesky-fill" target="_blank" rel="nofollow noopener noreferrer"></a>
</div>

<script>
  const twitterUsername = "@5uke_y";
  const blueskyUsername = "@5uke.bsky.social";

  const share_url = encodeURIComponent(location.href);
  const share_title = document.title;

  // Twitter (X)
  document.getElementById('js-share-twitter').setAttribute(
    "href",
    "https://twitter.com/share?url=" + share_url + "&text=" + share_title + " " + encodeURIComponent(twitterUsername) + " より" +
    "&hashtags=rstats"
  );

  // Bluesky
  document.getElementById('js-share-bluesky').setAttribute(
    "href",
    "https://bsky.app/intent/compose?text=" + share_title + " " + share_url + " " + encodeURIComponent(blueskyUsername) + " より"
  );
</script>





<section id="はじめに" class="level2">
<h2 class="anchored" data-anchor-id="はじめに">はじめに</h2>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center collapsed" data-bs-toggle="collapse" data-bs-target=".callout-1-contents" aria-controls="callout-1" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
<span class="screen-reader-only">Note</span>ユーザー設定とワークスペース設定
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-1" class="callout-1-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<p>Positron（VSCode）にはユーザー設定とワークスペース設定があります。ユーザー設定はプロジェクトに依らずPositron全体に適用される設定で、ワークスペース設定は特定のワークスペース（フォルダ）にのみ適用される設定です。</p>
<p>本ページで何回か設定をいじる場面があります。全体に適用したい場合は設定を開いたのち検索窓の下にある「ユーザー」を選択したうえで設定を進め、特定のプロジェクトにのみ適用したい場合はプロジェクトを開き「ワークスペース」を選択してから設定を進めてください。</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://yo5uke.com/pages/tips/2025/09/250901_positron_setting/image/setting_user_workspace.png" class="img-fluid figure-img" style="width:50.0%"></p>
<figcaption>ユーザーとワークスペースの切り替え</figcaption>
</figure>
</div>
</div>
</div>
</div>
<p>9月に入りましたが引き続き暑いですね。オフィスにこもってパソコンをカタカタしているのでまだましですが、たまに外へ出ると秋はいつ来るのかと、考えてしまいます…。</p>
<p>ところで、僕はと言えば最近も仕事でRを使う機会が多いのですが、最近はRStudioではなくPositronを主に使うようにしています。理由はシンプルで、新しいものが好きだからです。</p>
<p>VSCodeをベースに作られていることもあり、なんとなく敬遠していたのですが（RStudioユーザーがVSCodeで満足のいくRの環境を整えるのは一苦労なので…）、RStudioのキーボードショートカットが使えることに気づいたり、レイアウトを変更できることも知れたりと、ようやく新しい環境を試せそう！と思い立って一気に設定を終わらせた次第です<sup>1</sup>。</p>
<p>今回は個人的に満足がいっている設定をピックアップしてまとめていこうと思います。</p>
<p>この記事は適宜更新する予定です。</p>
</section>
<section id="positronとは" class="level2">
<h2 class="anchored" data-anchor-id="positronとは">Positronとは？</h2>
<p>そもそもPositronとは何なんだという方もいらっしゃることを想定し、ごく簡単にPositronについてまとめます。</p>
<p>PositronはPosit社（旧RStudio社）が開発している統合開発環境（IDE）で、VSCodeをベースに作られており、RとPythonのために最適化されているのが特徴です。</p>
<p>従来のVSCodeにおけるRの使い勝手はあまりよくないと個人的に感じており、例えばRStudioで使い慣れたキーボードショートカットを自分で設定しなければいけなかったり、環境変数（格納したデータ等）が見にくかったりしていましたが、PositronではRStudioの要素も取り入れつつ、これまでRStudioを使用していたユーザーにとって移行しやすいコーディング環境が提供されています<sup>2</sup>。</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://yo5uke.com/pages/tips/2025/09/250901_positron_setting/image/positron.png" class="img-fluid figure-img"></p>
<figcaption>設定をいじっているのでデフォルトとは異なっています</figcaption>
</figure>
</div>
<p>Positronの画面はこんな感じで、右上の「R 4.5.1」の部分からPythonへの切り替えも可能です。</p>
<p>デフォルトでは下にコンソール、右上に変数とデフォルトのRStudioと同じ構成になっているのですが、このあたりの設定についてもこれから書いていきます。</p>
<p>インストールについては書きませんが、以下からダウンロードできます。</p>
<p><a href="https://positron.posit.co/download.html">Download Positron</a></p>
<p>Windowsの方であれば一番上のをダウンロードすればよいと思います。</p>
</section>
<section id="キーボードショートカットの設定" class="level2">
<h2 class="anchored" data-anchor-id="キーボードショートカットの設定">キーボードショートカットの設定</h2>
<section id="rstudioからの移行" class="level3">
<h3 class="anchored" data-anchor-id="rstudioからの移行">RStudioからの移行</h3>
<p>まずRStudioからの移行を検討する場合、やはりキーボードショートカットは引き続き使えた方が良いですよね。</p>
<p>画面左下歯車マークから「設定」を開きます。すると設定画面が出てきますので、上部に出てきた「設定の検索」窓に「workbench.keybindings.rstudioKeybindings」と入力します（ぜひコピペしてくださいね）。</p>
<p>すると設定が1つヒットし、チェックボックスにはチェックが入っていない状況かと思います。</p>
<p>そこにチェックを入れ、確認出来たら上部の×印から設定を閉じます。再起動が必要ですので、一度Positronを閉じてから再度開いてください。これで基本的なRStudioのキーボードショートカットが使えるようになります。</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://yo5uke.com/pages/tips/2025/09/250901_positron_setting/image/rstudio_key_binding.png" class="img-fluid figure-img"></p>
<figcaption>この項目にチェックを入れてください</figcaption>
</figure>
</div>
</section>
<section id="地味にイヤな設定の解消" class="level3">
<h3 class="anchored" data-anchor-id="地味にイヤな設定の解消">地味にイヤな設定の解消</h3>
<div class="callout callout-style-default callout-caution callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
<span class="screen-reader-only">Caution</span>Macユーザーの方へ
</div>
</div>
<div class="callout-body-container callout-body">
<p>ここではWindowsのキーに基づいて説明しています。Macの方は適宜キーを置き換えながら読み進めてください。Macの正しいキーについて存じ上げず、申し訳ありません。</p>
</div>
</div>
<p>続いて、地味に困ったのがQuarto Markdownにおけるチャンク挿入についてです<sup>3</sup>。</p>
<p>RStudio上ではチャンク（```{r}で始まるコードブロック）を挿入する際に<span class="visually-hidden">Ctrl-Alt-I</span>でチャンクを挿入できるわけなのですが、これはカーソルを置いている位置から始まります。カーソルを置いているその行に```{r}が挿入されるということです。</p>
<p>しかしPositronでは、その行を空行にしたうえで、1行下に挿入される設定になっています。気にされないようであれば放置でよいのですが、僕は気になってしまったので、修正することにしました。</p>
<p>先ほどと同様画面左下歯車マークから「キーボードショートカット」（キーボードを使う場合<span class="visually-hidden">Ctrl-K+Ctrl-S</span>）を開きます。</p>
<p>するとキーボードショートカットに関する設定がずらーっと出てきますが、出てきた画面右上の「キーボードショートカットを開く（JSON）」というアイコンをクリックして開きます。</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://yo5uke.com/pages/tips/2025/09/250901_positron_setting/image/keyboard_shortcut.png" class="img-fluid figure-img"></p>
<figcaption>赤で示した部分です</figcaption>
</figure>
</div>
<p>すると<code>// 既定値を上書きするには、このファイル内にキー バインドを挿入します</code>という文言とともに<code>[ ]</code>があると思います。</p>
<p>初期段階では何も記載されていないと思いますが、この中に以下を記述します（<code>[ ]</code>は一応表示しています）。</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb1" style="background: #f1f3f5;"><pre class="sourceCode json code-with-copy"><code class="sourceCode json"><span id="cb1-1"><span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">[</span></span>
<span id="cb1-2">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb1-3">    <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">"key"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">:</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"ctrl+alt+i"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb1-4">    <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">"command"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">:</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"editor.action.insertSnippet"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb1-5">    <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">"when"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">:</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"editorTextFocus &amp;&amp; editorLangId == 'quarto'"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb1-6">    <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">"args"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">:</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb1-7">      <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">"snippet"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">:</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"```{r}</span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">\n</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">$0</span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">\n</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">```</span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">\n</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span></span>
<span id="cb1-8">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb1-9">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb1-10"><span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">]</span></span></code></pre></div></div>
<p>これでデフォルトの設定が上書きされ、<span class="visually-hidden">Ctrl-Alt-I</span>でチャンクを挿入すると、カーソルを置いている行に直接チャンクが挿入されるようになります。</p>
<p>ちなみに、この設定だとRのチャンクが強制的に挿入されるので、Pythonも使う方は困る！と思うかもしれません。</p>
<p>そのような方には、同じ書き方で<span class="visually-hidden">Ctrl-Shift-I</span>を使ってPythonのチャンクを挿入するようにするのがおすすめです。そもそもPositronではデフォルトのチャンク挿入が<span class="visually-hidden">Ctrl-Shift-I</span>（<span class="visually-hidden">Alt</span>ではなく）であるため、もしRとPythonしか使わないのであれば、これをPython専用のショートカットにしてしまうのがよいのではないでしょうか。</p>
<p>上の設定に書き足す形で、カンマで区切った後ろに以下のように記述します。</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb2" style="background: #f1f3f5;"><pre class="sourceCode json code-with-copy"><code class="sourceCode json"><span id="cb2-1"><span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">[</span></span>
<span id="cb2-2">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb2-3">    <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">"key"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">:</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"ctrl+alt+i"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb2-4">    <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">"command"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">:</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"editor.action.insertSnippet"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb2-5">    <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">"when"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">:</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"editorTextFocus &amp;&amp; editorLangId == 'quarto'"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb2-6">    <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">"args"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">:</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb2-7">      <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">"snippet"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">:</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"```{r}</span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">\n</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">$0</span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">\n</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">```</span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">\n</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span></span>
<span id="cb2-8">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb2-9">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">}</span><span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb2-10"></span>
<span id="cb2-11">  <span class="er" style="color: #AD0000;
background-color: null;
font-style: inherit;">//</span> <span class="er" style="color: #AD0000;
background-color: null;
font-style: inherit;">ここから追記</span></span>
<span id="cb2-12">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb2-13">    <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">"key"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">:</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"ctrl+shift+i"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb2-14">    <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">"command"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">:</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"editor.action.insertSnippet"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb2-15">    <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">"when"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">:</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"editorTextFocus &amp;&amp; editorLangId == 'quarto'"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb2-16">    <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">"args"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">:</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb2-17">      <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">"snippet"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">:</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"```{python}</span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">\n</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">$0</span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">\n</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">```</span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">\n</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span></span>
<span id="cb2-18">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb2-19">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb2-20"><span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">]</span></span></code></pre></div></div>
<p>これで<span class="visually-hidden">Ctrl-Shift-I</span>をPython専用のショートカットに変更できました。やっていることはキーとスニペットを変えているだけで、他は一緒です。</p>
</section>
</section>
<section id="レイアウトの設定" class="level2">
<h2 class="anchored" data-anchor-id="レイアウトの設定">レイアウトの設定</h2>
<p>これは個人の好みが大きく、僕がマイナーであることもわかっているので共感いただけないかもしれませんが、僕はコードとコンソールは縦に並べたいタイプの人間です。</p>
<p>特にPositronではRStudioと違って、R MarkdownやQuartoを使っている際にチャンクの下に結果が表示されませんので、コンソールを見えるようにしておくことが重要です。縦に並べてしまうと表示できるスペースが狭く、見にくいため左右並べる設定にします。</p>
<p>また、左右に並べる以外の設定も選択肢がありますので、いろいろ試してみて気に入ったものにしてみてください。</p>
<p>まず、左下の歯車から「コマンドパレット」、あるいは<span class="visually-hidden">Ctrl-Shift-P</span>を入力します。</p>
<p>表示された画面上部の検索窓に「customize layout」と入力します。すると1件ドンピシャでヒットすると思いますので、それをクリックします。</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://yo5uke.com/pages/tips/2025/09/250901_positron_setting/image/layout.png" class="img-fluid quarto-figure quarto-figure-center figure-img"></p>
</figure>
</div>
<p>いろいろな選択肢が出てきますが、デフォルトでは1番上の「Stacked Layout」です。</p>
<p>僕はコンソールを右に持っていきたいという考えから、2番目の「Side-By-Side Layout」を選択しています。同じ手順で元に戻せますので、いろいろ選択してみてください。</p>
<p>ちなみにSide-By-Sideを選択しただけだと、VARIABLESは右側に配置されています。これを僕はスクリプト画面の下に持ってきているのですが、その方法はドラッグするという原始的な方法です。</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://yo5uke.com/pages/tips/2025/09/250901_positron_setting/image/replace_variables.gif" class="img-fluid quarto-figure quarto-figure-center figure-img"></p>
</figure>
</div>
<p>（2025/09/25追記）Variablesを左下に移す設定をしていましたが、右側をフルでコンソールにする必要性はないかなと思うようになってきたので右側の上半分をコンソールにし、下半分にVariablesを置くことが増えてきました。プロットをあまりしなくなったことが影響しているかもしれません…。プロットをたくさんする方は前述の設定あるいはデフォルト設定の方がスペースを有効活用できるかもしれません。</p>
</section>
<section id="project-manager" class="level2">
<h2 class="anchored" data-anchor-id="project-manager">Project Manager</h2>
<p>皆さんはR Projectを使用しているでしょうか。再現可能な研究のための1つのツールにR Projectがあります。ここではそれそのものについて詳しくは書きませんが<sup>4</sup>、PositronにはR Projectと同様のシステムがありません。</p>
<p>そこでPositron（VSCodeもですが）では、拡張機能を使用してプロジェクト管理を行います。</p>
<p>ざっくりR Projectは<code>.Rproj</code>ファイルを作成し、そのファイルが認識されることでそこをワーキングディレクトリとして設定し、<code>here::here()</code>をはじめとした相対パスを使用できるようになり、効率的なプロジェクト管理が可能になります。</p>
<p>前述のようにPositronでは<code>.Rproj</code>ファイルは作成できず、代わりにワークスペースを設定することでプロジェクト管理を行います。</p>
<p>このワークスペースとは一体何かと言えば「Positron内でワーキングディレクトリとなるフォルダを開く」ことに他ならないのですが、つまるところ<code>.Rproj</code>をダブルクリックしてそのフォルダをRStudioで開くのと同様に、そのフォルダをIDE上で「開く」ことが重要なのです。</p>
<p>ではどうやってそのフォルダを開けばよいのか。それを解決してくれるのが「Project Manager」という拡張機能です。</p>
<p>Positronの左にあるサイドバーから拡張機能のアイコンを開き、検索窓から「alefragnani.project-manager」と検索してください<sup>5</sup>。</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://yo5uke.com/pages/tips/2025/09/250901_positron_setting/image/project_manager.png" class="img-fluid figure-img" style="width:80.0%"></p>
<figcaption>これです</figcaption>
</figure>
</div>
<p>これをインストールすると、サイドバーにアイコンが表示されることと思います。</p>
<p>画面左上の「ファイル」から「フォルダを開く」へと進み、何かプロジェクトを開いてみてください（なければ適当にフォルダを作ってみてください）。</p>
<p>開けたら、Project Managerのアイコンをクリックし、拡張機能の画面を開きます。すると上部に下のような表示があると思います。</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://yo5uke.com/pages/tips/2025/09/250901_positron_setting/image/save_project.png" class="img-fluid quarto-figure quarto-figure-center figure-img" style="width:60.0%"></p>
</figure>
</div>
<p>そしてアイコンの一番左にあるフロッピーディスク💾をクリックすると、今開いているフォルダがワークスペースとして保存され、下に表示されると思います。つまりエクスプローラーにおけるクイックアクセスへのピン留めと同じ要領で、次回以降表示されるプロジェクトを選択すればそのフォルダを開けるようになるというわけです。</p>
<p><code>.Rproj</code>のようなファイルこそないものの、ワークスペースを開いていれば<code>here::here()</code>をはじめとしたプロジェクト管理のためのツールは同様に使用可能です。</p>
<p>ぜひプロジェクトはここから保存してみてください。</p>
<div class="callout callout-style-simple callout-tip no-icon">
<div class="callout-body d-flex">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-body-container">
<p><a href="https://positron.posit.co/migrate-rstudio-rproj.html#launch-from-the-project-manager-extension">The Rproj File - Positron</a></p>
</div>
</div>
</div>
</section>
<section id="テーマの変更" class="level2">
<h2 class="anchored" data-anchor-id="テーマの変更">テーマの変更</h2>
<section id="デフォルトのテーマ設定" class="level3">
<h3 class="anchored" data-anchor-id="デフォルトのテーマ設定">デフォルトのテーマ設定</h3>
<p>Positronではテーマも変更可能です。VSCodeと基本的な設定は同じですが、このセクションの終わりに拡張機能を利用したテーマの変更方法も書いておきます。</p>
<p>まず、左下の歯車マークから「設定」を開きます。</p>
<p>上部の検索窓に「color theme」と入力します。すると「Workbench: Color Theme」という項目がヒットすると思います。ここがデフォルトでは「Positron Light」になっていると思います。ここをクリックすると、テーマの一覧が表示されます。</p>
<p><img src="https://yo5uke.com/pages/tips/2025/09/250901_positron_setting/image/color_theme.png" class="img-fluid"></p>
<p>ダーク系のテーマが好きな方は「Positron Dark」を選択してください。これでダークモードになります。</p>
<p>他にもいろいろなテーマがあるので、気に入ったものを選んでみてください。</p>
</section>
<section id="テーマの自動切換え" class="level3">
<h3 class="anchored" data-anchor-id="テーマの自動切換え">テーマの自動切換え</h3>
<p>僕はMicrosoft Storeで入手可能な「Auto Dark Mode」というアプリを使用して、日の出と日没に合わせてWindowsのテーマを自動で切り替えています。昼間ならライトモード、夜ならナイトモードに自動で切り替わるというものです。</p>
<p>PositronはデフォルトでWindowsのテーマに合わせて自動で切り替わるわけではないのですが、同じく設定から「auto detect color scheme」を検索し、「Window: Auto Detect Color Scheme」という項目にチェックを入れると、Windowsのテーマに合わせて自動で切り替わるようになります。</p>
<p>別にAuto Dark Modeを使っていない場合でも、Windowsのテーマを手動で切り替えた際にPositronもそれに合わせて切り替えてくれるようになります。</p>
<p>また、この際にライトのテーマとダークのテーマをそれぞれ設定する必要があります。「Workbench: Preferred Light Color Theme」と「Workbench: Preferred Dark Color Theme」という項目があるので、それぞれ好きなテーマを選んでください。ここで選んだものがWindowsのテーマに合わせて切り替わるようになります（Macでも同様かと思います）。</p>
</section>
<section id="拡張機能によるテーマの追加" class="level3">
<h3 class="anchored" data-anchor-id="拡張機能によるテーマの追加">拡張機能によるテーマの追加</h3>
<p>ダークモードに関して、最近1つ新しいテーマを見つけたので、ご紹介します。</p>
<div class="callout callout-style-simple callout-tip no-icon">
<div class="callout-body d-flex">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-body-container">
<p><a href="https://ivelasq.rbind.io/blog/positron-theme/">Porting my favorite RStudio color theme to Positron</a></p>
</div>
</div>
</div>
<p>こちらはRStudioの「Tomorrow Night Bright」というテーマをPositronに移植するために拡張機能を作成した、という記事です。この拡張機能を用いればRStudioのTomorrow Night BrightのテーマをPositronで使用可能になります。</p>
<p>拡張機能のインストール方法は前述のProject Managerと同様です。拡張機能のアイコンをクリックし、検索窓に「tomorrow night bright」と入力します。するとRユーザーにはおなじみ、六角形のロゴがアイコンの「Tomomorrow Night Bright (R Classic)」という拡張機能が出てくると思いますので、インストールしてください。</p>
<p>インストールできたら、先述の「Workbench: Color Theme」から「Tomorrow Night Bright (R Classic)」を選択してください。これでテーマが適用されます<sup>6</sup>。</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://yo5uke.com/pages/tips/2025/09/250901_positron_setting/image/tomorrow_night_bright.png" class="img-fluid figure-img"></p>
<figcaption>Tommorw Night Bright</figcaption>
</figure>
</div>
</section>
</section>
<section id="タブのピン留め" class="level2">
<h2 class="anchored" data-anchor-id="タブのピン留め">タブのピン留め</h2>
<blockquote class="bluesky-embed blockquote" data-bluesky-uri="at://did:plc:2zcfjzyocp6kapg6jc4eacok/app.bsky.feed.post/3m3bcvqoz2k2p" data-bluesky-cid="bafyreif27w6xrud3nfgpbxmibkvs5hbmr5dfca6e5rx35zagrulhvie6cu" data-bluesky-embed-color-mode="system"><p lang="en">One of my favorite recent Positron discoveries is that you can not only (1) pin tabs, but (2) put the pinned tabs on their own dedicated row (after enabling that setting), which is glorious for workspace tab management #rstats<br><br><a href="https://bsky.app/profile/did:plc:2zcfjzyocp6kapg6jc4eacok/post/3m3bcvqoz2k2p?ref_src=embed">[image or embed]</a></p>— Andrew Heiss (<a href="https://bsky.app/profile/did:plc:2zcfjzyocp6kapg6jc4eacok?ref_src=embed">@andrew.heiss.phd</a>) <a href="https://bsky.app/profile/did:plc:2zcfjzyocp6kapg6jc4eacok/post/3m3bcvqoz2k2p?ref_src=embed">2025年10月16日 7:42</a></blockquote><script async="" src="https://embed.bsky.app/static/embed.js" charset="utf-8"></script>
<p>上記のポストにあるように、Positronではタブをピン留めし、それを2行にして固定することができます。</p>
<p>ピン留め自体は簡単にできます。タブを右クリックして「ピン留めする」をクリックするだけです。あるいはピン留めしたいタブを開いたうえで<span class="visually-hidden">Ctrl-K+Shift-Enter</span>でもピン留めできます。</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://yo5uke.com/pages/tips/2025/09/250901_positron_setting/image/tab_pin.png" class="img-fluid quarto-figure quarto-figure-center figure-img" style="width:50.0%"></p>
</figure>
</div>
<p>設定方法はポストの画像にある通りですが、設定（<span class="visually-hidden">Ctrl-,</span>）から「workbench.editor.pinnedTabsOnSeparateRow」と検索し、ヒットした項目にチェックを入れます。</p>
<p>設定画面はポストにある通りですが、この設定により、ピン留めしたタブが上段に固定されるようになります。スクリプトとデータビューアを別の段に置けるようになったりして、結構便利だと思います。使いやすいように配置してみてください。</p>
</section>
<section id="ミニマップ" class="level2">
<h2 class="anchored" data-anchor-id="ミニマップ">ミニマップ</h2>
<p>Positron（VSCode）にはミニマップという機能があり、コードの全体像を小さなウィンドウで表示してくれます。</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://yo5uke.com/pages/tips/2025/09/250901_positron_setting/image/minimap.png" class="img-fluid figure-img"></p>
<figcaption>スクロールバーの左に表示されるものです</figcaption>
</figure>
</div>
<p>ファイル内を上下に行ったり来たりする際にスクロールバーだと細くてつかみにくいのですが、ミニマップだと全体を把握しつつ、目的の場所に素早く移動できます。</p>
<p>ただ、VSCodeではデフォルトでミニマップが有効になっているのですが、Positronでは無効になっているため、必要に応じて有効化する必要があります。方法は簡単で、スクロールバーを右クリックして「ミニマップ」を選択するだけです。</p>
</section>
<section id="rのフォーマッタ" class="level2">
<h2 class="anchored" data-anchor-id="rのフォーマッタ">Rのフォーマッタ</h2>
<p>Rのコードフォーマッタとして「Air」という拡張機能があり、Positronにはデフォルトでインストールされています。コードを整形してくれるツールですが、こちらについては単独の記事にしましたので、そちらをご覧ください。</p>
<div class="callout callout-style-simple callout-tip no-icon">
<div class="callout-body d-flex">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-body-container">
<p><a href="../../../../../pages/tips/2025/10/251016_air/index.html">【Positron】拡張機能「Air」を使う【フォーマッタ】</a></p>
</div>
</div>
</div>
</section>
<section id="おわりに" class="level2">
<h2 class="anchored" data-anchor-id="おわりに">おわりに</h2>
<p>以上、Positronの設定について書いてきました。</p>
<p>Positronは今後も発展を続けていくはずですし、さらに便利になることは間違いないと思います。</p>
<p>個人的にはもうRStudioには戻れない、というところまでいってほしいと思っています（笑）</p>
<p>今後もアップデートがあれば更新しますので、よろしくお願いいたします。</p>


<!-- -->

</section>


<div id="quarto-appendix" class="default"><section id="footnotes" class="footnotes footnotes-end-of-document"><h2 class="anchored quarto-appendix-heading">注</h2>

<ol>
<li id="fn1"><p>新しいものが好きな割に敬遠していたのかというご指摘はごもっともですが、ご容赦ください。↩︎</p></li>
<li id="fn2"><p>とはいえ今でも使いやすいのはRStudioだと思っています。今後より便利になるという期待も込めて、Positronを使っている面が大きいです。↩︎</p></li>
<li id="fn3"><p>ここではR Markdownについては書いていませんが、Positronへの移行を考えている前衛的な皆様であれば、R MarkdownからQuartoへ乗り換えるべきです。ということにして、R Markdownの設定は僕もしていないので、説明から逃げています。↩︎</p></li>
<li id="fn4"><p>R Projectについては<a href="../../../../../pages/tips/2024/05/240515_rproj/index.html">こちら</a>をご覧ください。↩︎</p></li>
<li id="fn5"><p>おそらく「project manager」でも一番上に出ます。↩︎</p></li>
<li id="fn6"><p>テーマの自動切換えで使用するには、Preferred Dark Color Themeに設定してください。↩︎</p></li>
</ol>
</section></div> ]]></description>
  <category>Positron</category>
  <category>R</category>
  <category>Python</category>
  <category>Quarto</category>
  <guid>https://yo5uke.com/pages/tips/2025/09/250901_positron_setting/</guid>
  <pubDate>Sun, 31 Aug 2025 15:00:00 GMT</pubDate>
  <media:content url="https://yo5uke.com/pages/tips/2025/09/250901_positron_setting/image/interface.png" medium="image" type="image/png" height="90" width="144"/>
</item>
<item>
  <title>XMLファイルから情報を抽出する</title>
  <link>https://yo5uke.com/pages/tips/2025/08/250826_xml/</link>
  <description><![CDATA[ 

<div class="social-share-buttons">
  <!-- Twitter (X) -->
  <a href="" id="js-share-twitter" class="share_button ri--twitter-x-fill" target="_blank" rel="nofollow noopener noreferrer"></a>

  <!-- Bluesky -->
  <a href="" id="js-share-bluesky" class="share_button ri--bluesky-fill" target="_blank" rel="nofollow noopener noreferrer"></a>
</div>

<script>
  const twitterUsername = "@5uke_y";
  const blueskyUsername = "@5uke.bsky.social";

  const share_url = encodeURIComponent(location.href);
  const share_title = document.title;

  // Twitter (X)
  document.getElementById('js-share-twitter').setAttribute(
    "href",
    "https://twitter.com/share?url=" + share_url + "&text=" + share_title + " " + encodeURIComponent(twitterUsername) + " より" +
    "&hashtags=rstats"
  );

  // Bluesky
  document.getElementById('js-share-bluesky').setAttribute(
    "href",
    "https://bsky.app/intent/compose?text=" + share_title + " " + share_url + " " + encodeURIComponent(blueskyUsername) + " より"
  );
</script>





<section id="はじめに" class="level2">
<h2 class="anchored" data-anchor-id="はじめに">はじめに</h2>
<p>今度は仕事でXMLファイルを扱う機会がやってきました。</p>
<p>XMLファイルは、データを「タグ」で階層的に記述するテキスト形式のファイルで、構造化された情報を表現・交換するための標準仕様であり、システム間でデータ連携や保存に広く利用されています。</p>
<p>見たことがない方にはとんとイメージがわかないと思うのですが、XMLは以下のような構造をしています。</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb1" style="background: #f1f3f5;"><pre class="sourceCode xml code-with-copy"><code class="sourceCode xml"><span id="cb1-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">&lt;?xml</span><span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;"> version=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"1.0"</span><span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;"> encoding=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"UTF-8"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">?&gt;</span></span>
<span id="cb1-2">&lt;<span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">Library</span>&gt;</span>
<span id="cb1-3">  &lt;<span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">Book</span><span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;"> id=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"B001"</span>&gt;</span>
<span id="cb1-4">    &lt;<span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">Title</span>&gt;データ分析入門&lt;/<span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">Title</span>&gt;</span>
<span id="cb1-5">    &lt;<span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">Author</span>&gt;山田太郎&lt;/<span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">Author</span>&gt;</span>
<span id="cb1-6">    &lt;<span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">Year</span>&gt;2021&lt;/<span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">Year</span>&gt;</span>
<span id="cb1-7">  &lt;/<span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">Book</span>&gt;</span>
<span id="cb1-8">  &lt;<span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">Book</span><span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;"> id=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"B002"</span>&gt;</span>
<span id="cb1-9">    &lt;<span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">Title</span>&gt;XML活用ガイド&lt;/<span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">Title</span>&gt;</span>
<span id="cb1-10">    &lt;<span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">Author</span>&gt;佐藤花子&lt;/<span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">Author</span>&gt;</span>
<span id="cb1-11">    &lt;<span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">Year</span>&gt;2023&lt;/<span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">Year</span>&gt;</span>
<span id="cb1-12">  &lt;/<span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">Book</span>&gt;</span>
<span id="cb1-13">  &lt;<span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">Magazine</span><span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;"> id=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"M001"</span><span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;"> category=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Technology"</span>&gt;</span>
<span id="cb1-14">    &lt;<span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">Title</span>&gt;Tech Monthly&lt;/<span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">Title</span>&gt;</span>
<span id="cb1-15">    &lt;<span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">Issue</span>&gt;2024-08&lt;/<span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">Issue</span>&gt;</span>
<span id="cb1-16">  &lt;/<span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">Magazine</span>&gt;</span>
<span id="cb1-17">&lt;/<span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">Library</span>&gt;</span></code></pre></div></div>
<p><code>Library</code>の中に<code>Book</code>や<code>Magazine</code>が入っていることがわかります。インデントされているので少しはわかりやすいのではないでしょうか。</p>
<p>さらにその中にはタイトルや著者等の情報が含まれています。</p>
<p>これが簡単なXMLの例です。</p>
<p>これがもっと長くずらーっと書かれているものの中から情報を取ってくる作業が仕事で必要になったので、その方法についてまとめたいと思います。</p>
</section>
<section id="準備" class="level2">
<h2 class="anchored" data-anchor-id="準備">準備</h2>
<p>必要なパッケージは<code>xml2</code>です。</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb2" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(xml2)</span></code></pre></div></div>
</div>
<p>また、解析に使用するXMLは以下です。著作権の問題で、データはいかにもそれっぽいですが、中身は架空のものに置き換えています。</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb3" style="background: #f1f3f5;"><pre class="sourceCode xml code-with-copy"><code class="sourceCode xml"><span id="cb3-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">&lt;?xml</span><span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;"> version=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"1.0"</span><span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;"> encoding=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"UTF-8"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">?&gt;</span></span>
<span id="cb3-2">&lt;<span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">Mdevices</span><span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;"> xmlns=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"http://info.pmda.go.jp/namespace/medical_devices/package_insert"</span><span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;"> version=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"1.0"</span>&gt;</span>
<span id="cb3-3">  &lt;<span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">PackageInsertNo</span>&gt;99Z9Z99999999999_1_00_01&lt;/<span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">PackageInsertNo</span>&gt;</span>
<span id="cb3-4">  &lt;<span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">CompanyIdentifier</span>&gt;999999&lt;/<span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">CompanyIdentifier</span>&gt;</span>
<span id="cb3-5">  &lt;<span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">DateOfPreparationOrRevisionArray</span>&gt;</span>
<span id="cb3-6">    &lt;<span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">DateOfPreparationOrRevisionDetail</span><span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;"> id=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"初版"</span>&gt;</span>
<span id="cb3-7">      &lt;<span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">YearMonth</span>&gt;2025-08&lt;/<span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">YearMonth</span>&gt;</span>
<span id="cb3-8">      &lt;<span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">Version</span>&gt;1.0&lt;/<span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">Version</span>&gt;</span>
<span id="cb3-9">      &lt;<span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">ReasonForRevision</span>&gt;新規作成&lt;/<span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">ReasonForRevision</span>&gt;</span>
<span id="cb3-10">    &lt;/<span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">DateOfPreparationOrRevisionDetail</span>&gt;</span>
<span id="cb3-11">  &lt;/<span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">DateOfPreparationOrRevisionArray</span>&gt;</span>
<span id="cb3-12">  &lt;<span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">ApprovalEtcArray</span>&gt;</span>
<span id="cb3-13">    &lt;<span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">ApprovalEtcDetail</span>&gt;</span>
<span id="cb3-14">      &lt;<span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">ApprovalAndLicenseNo</span><span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;"> approvalType=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"1"</span>&gt;99Z9Z99999999999&lt;/<span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">ApprovalAndLicenseNo</span>&gt;</span>
<span id="cb3-15">      &lt;<span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">ApprovalBrandNameDetail</span>&gt;</span>
<span id="cb3-16">        &lt;<span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">ApprovalBrandName</span><span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;"> id=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"BRD_ApprovalBrandName_01"</span>&gt;サンプルデバイスα&lt;/<span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">ApprovalBrandName</span>&gt;</span>
<span id="cb3-17">        &lt;<span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">AccessoriesOrCompositionArticle</span>&gt;架空データ&lt;/<span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">AccessoriesOrCompositionArticle</span>&gt;</span>
<span id="cb3-18">        &lt;<span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">ApprovalBrandNameReading</span>&gt;さんぷるでばいすあるふぁ&lt;/<span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">ApprovalBrandNameReading</span>&gt;</span>
<span id="cb3-19">      &lt;/<span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">ApprovalBrandNameDetail</span>&gt;</span>
<span id="cb3-20">      &lt;<span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">DoNotReuse</span>&gt;No&lt;/<span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">DoNotReuse</span>&gt;</span>
<span id="cb3-21">    &lt;/<span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">ApprovalEtcDetail</span>&gt;</span>
<span id="cb3-22">  &lt;/<span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">ApprovalEtcArray</span>&gt;</span>
<span id="cb3-23">  &lt;<span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">CategoryAndGeneralName</span>&gt;</span>
<span id="cb3-24">    &lt;<span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">Category</span>&gt;A9999&lt;/<span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">Category</span>&gt;</span>
<span id="cb3-25">    &lt;<span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">GeneralName</span>&gt;</span>
<span id="cb3-26">      &lt;<span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">PrimaryGeneralNameDetail</span>&gt;</span>
<span id="cb3-27">        &lt;<span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">PrimaryGeneralName</span><span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;"> id=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"GNN_Main_PrimaryGeneralName"</span>&gt;架空一般医療機器&lt;/<span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">PrimaryGeneralName</span>&gt;</span>
<span id="cb3-28">        &lt;<span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">JMDNCode</span>&gt;99999999&lt;/<span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">JMDNCode</span>&gt;</span>
<span id="cb3-29">        &lt;<span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">Classification</span>&gt;2&lt;/<span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">Classification</span>&gt;</span>
<span id="cb3-30">      &lt;/<span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">PrimaryGeneralNameDetail</span>&gt;</span>
<span id="cb3-31">    &lt;/<span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">GeneralName</span>&gt;</span>
<span id="cb3-32">    &lt;<span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">DiscernmentOfMaintenanceInstallation</span>&gt;None&lt;/<span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">DiscernmentOfMaintenanceInstallation</span>&gt;</span>
<span id="cb3-33">    &lt;<span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">DiscernmentOfTheLivingThingOriginEtc</span>&gt;None&lt;/<span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">DiscernmentOfTheLivingThingOriginEtc</span>&gt;</span>
<span id="cb3-34">    &lt;<span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">TransgenicsMaterial</span>&gt;None&lt;/<span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">TransgenicsMaterial</span>&gt;</span>
<span id="cb3-35">  &lt;/<span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">CategoryAndGeneralName</span>&gt;</span>
<span id="cb3-36">  &lt;<span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">FormAndStructureDetail</span><span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;"> id=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"HDR_FormAndStructure"</span>/&gt;</span>
<span id="cb3-37">  &lt;<span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">InfoIndicationsOrEfficacy</span><span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;"> id=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"HDR_InfoIndicationsOrEfficacy"</span><span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;"> wordingPatternOfInfoIndicationsOrEfficacy=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"1"</span>/&gt;</span>
<span id="cb3-38">  &lt;<span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">PrecautionsForUseDetail</span><span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;"> id=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"HDR_PrecautionsForUse"</span>/&gt;</span>
<span id="cb3-39">  &lt;<span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">AManufacturingAndSellingContractorsNameOrANameEtc</span><span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;"> id=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"HDR_AManufacturingAndSellingContractorsNameOrANameEtc"</span>&gt;</span>
<span id="cb3-40">    &lt;<span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">AManufacturingAndSellingContractorsNameOrANameDetail</span><span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;"> id=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"HDR_AManufacturingAndSellingContractorsNameOrAName"</span>&gt;</span>
<span id="cb3-41">      &lt;<span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">ANameOfManufacturerEtc</span>&gt;株式会社サンプル医療&lt;/<span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">ANameOfManufacturerEtc</span>&gt;</span>
<span id="cb3-42">      &lt;<span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">Phonenumber</span>&gt;000-0000-0000&lt;/<span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">Phonenumber</span>&gt;</span>
<span id="cb3-43">    &lt;/<span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">AManufacturingAndSellingContractorsNameOrANameDetail</span>&gt;</span>
<span id="cb3-44">    &lt;<span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">ANameOrAnOverseasNameEtcOfAFactoryArray</span><span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;"> id=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"HDR_ANameOrAnOverseasNameEtcOfAFactory"</span>&gt;</span>
<span id="cb3-45">      &lt;<span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">ANameOrAnOverseasNameEtcOfAFactoryDetail</span>&gt;</span>
<span id="cb3-46">        &lt;<span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">ANameOfManufacturerEtc</span>&gt;サンプル工場&lt;/<span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">ANameOfManufacturerEtc</span>&gt;</span>
<span id="cb3-47">        &lt;<span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">Phonenumber</span>&gt;000-1111-2222&lt;/<span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">Phonenumber</span>&gt;</span>
<span id="cb3-48">        &lt;<span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">TheCompanyNameOfSpecificationIntoEnglish</span>&gt;Sample Factory Inc.&lt;/<span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">TheCompanyNameOfSpecificationIntoEnglish</span>&gt;</span>
<span id="cb3-49">        &lt;<span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">TheCountryCode</span>&gt;888&lt;/<span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">TheCountryCode</span>&gt;</span>
<span id="cb3-50">        &lt;<span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">NameOfACountry</span>&gt;架空国&lt;/<span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">NameOfACountry</span>&gt;</span>
<span id="cb3-51">      &lt;/<span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">ANameOrAnOverseasNameEtcOfAFactoryDetail</span>&gt;</span>
<span id="cb3-52">    &lt;/<span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">ANameOrAnOverseasNameEtcOfAFactoryArray</span>&gt;</span>
<span id="cb3-53">  &lt;/<span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">AManufacturingAndSellingContractorsNameOrANameEtc</span>&gt;</span>
<span id="cb3-54">  &lt;<span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">PleaseSeeTechnicalManual</span>&gt;False&lt;/<span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">PleaseSeeTechnicalManual</span>&gt;</span>
<span id="cb3-55">&lt;/<span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">Mdevices</span>&gt;</span></code></pre></div></div>
<p>これを<code>sample.xml</code>とします。人によってファイルへのパスは異なるかと思いますが、今回は<code>here::here("data/xml_sample/sample.xml</code>に格納されているとして進めます。</p>
<p>一応サンプルファイルを以下からダウンロードできるようにしておきました。</p>
<p><a href="../../../../../data/xml_sample/sample.zip" download="sample.zip">XMLファイル</a></p>
</section>
<section id="データの取得" class="level2">
<h2 class="anchored" data-anchor-id="データの取得">データの取得</h2>
<p>それでは早速XMLファイルを読み込んで、必要な情報を抽出したいと思います。</p>
<p>抽出したい情報は、</p>
<ul>
<li><p>承認番号（<code>&lt;ApprovalAndLicenseNo&gt;</code>）</p></li>
<li><p>一般名称（<code>&lt;PrimaryGeneralName&gt;</code>）</p></li>
<li><p>日本医療機器名コード（<code>&lt;JMDNCode&gt;</code>）</p></li>
</ul>
<p>とします。他のタグについても同様の方法で取得できるので、一旦この3つに絞ります。</p>
<p>まずはファイルを読み込みましょう。</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb4" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># ファイルのパスは適宜変更</span></span>
<span id="cb4-2">xml_sample <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">read_xml</span>(here<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">here</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"data/xml_sample/sample.xml"</span>))</span></code></pre></div></div>
</div>
<p>次に、タグを検索し、該当するものを引っ張ってきます。タグは上の括弧内で記したとおりです。</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb5" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1">xml_sample <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb5-2">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">xml_find_all</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"//*[local-name()='ApprovalAndLicenseNo']"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb5-3">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">xml_text</span>()</span></code></pre></div></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "99Z9Z99999999999"</code></pre>
</div>
</div>
<p><code>xml_find_all()</code>はXML内の要素を探してくるための関数です。複数ヒットすればすべて返してきますが、<code>xml_find_first()</code>であれば最初の一つを返します。今回はタグは重複がないのでどちらでも同じ結果が返ってきます。</p>
<p>ところで見慣れない書き方が出てきています。<code>//</code>も<code>local-name</code>などです。これらについて1つずつまとめます。</p>
<ol type="1">
<li><code>//</code>
<ul>
<li>これはXMLのタグがどの階層にあっても探す、ということです。</li>
<li>特定の階層のみを探すこともできるのですが、今回は全体から探してきたいのでこれを使います。</li>
</ul></li>
<li><code>*</code>
<ul>
<li>これはワイルドカードと呼ばれ、どんな要素でも問わない、ということを示します。</li>
<li>この後に条件を指定しているのですが、その条件を満たすあらゆる要素、ということを示すイメージです。</li>
</ul></li>
<li><code>[local-name()=]</code>
<ul>
<li>ここがややこしいのですが、XMLの冒頭2行目に<code>xmlns="http://info.pmda.go.jp/namespace/medical_devices/package_insert"</code>という表記があります。</li>
<li>これがあるとこの後に出てくるタグはこれの後に続くことになる、ということを意味します。</li>
<li>例：<code>http://info.pmda.go.jp/namespace/medical_devices/package_insert/ApprovalAndLicenseNo</code></li>
<li>すなわち、一見<code>ApprovalAndLicenseNo</code>でヒットしそうですが、実際はこの例のように長い表記が正しいので、<code>ApprovalAndLicenseNo</code>単体だとヒットしません。</li>
<li><code>xmlns</code>の部分を「名前空間」というのですが、名前空間がない場合でもこの書き方でヒットしますので、これを書いておけば間違いないといった感じです<sup>1</sup>。</li>
</ul></li>
</ol>
<p>ややこしい書き方でしたが、これで注目しているタグを引っ張ってこれます。</p>
<p>最後に<code>xml_text()</code>で、タグの中身のテキストを取得でき、今回であれば<code>99Z9Z99999999999</code>が表示できています。</p>
<p>XMLファイルから情報を取得する方法については以上です。</p>
</section>
<section id="ファイルを巡回してデータフレームを作る" class="level2">
<h2 class="anchored" data-anchor-id="ファイルを巡回してデータフレームを作る">ファイルを巡回してデータフレームを作る</h2>
<p>複数のXMLファイルを巡回して、同じ要素を引っ張ってきたいことがありますよね。</p>
<p>その方法についてもまとめます。今回はXMLファイルが2つ、<code>here::here("data/xml_sample")</code>内にあると仮定します。</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb7" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># `tibble()`や`map_dfr()`のため</span></span>
<span id="cb7-2"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(tidyverse)</span>
<span id="cb7-3"></span>
<span id="cb7-4">xml_files <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">list.files</span>(here<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">here</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"data/xml_sample"</span>), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">pattern =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"*.xml$"</span>, </span>
<span id="cb7-5">                        <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">full.names =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">TRUE</span>)</span>
<span id="cb7-6"></span>
<span id="cb7-7">extract_info <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">function</span>(fp) {</span>
<span id="cb7-8">  doc <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">read_xml</span>(fp)</span>
<span id="cb7-9">  </span>
<span id="cb7-10">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">tibble</span>(</span>
<span id="cb7-11">    承認番号 <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">xml_text</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">xml_find_all</span>(doc, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"//*[local-name()='ApprovalAndLicenseNo']"</span>)), </span>
<span id="cb7-12">    一般名称 <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">xml_text</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">xml_find_all</span>(doc, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"//*[local-name()='PrimaryGeneralName']"</span>)), </span>
<span id="cb7-13">    日本医療機器名コード <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">xml_text</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">xml_find_all</span>(doc, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"//*[local-name()='JMDNCode']"</span>))</span>
<span id="cb7-14">  )</span>
<span id="cb7-15">}</span>
<span id="cb7-16"></span>
<span id="cb7-17">df <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">map_dfr</span>(xml_files, extract_info)</span>
<span id="cb7-18"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">print</span>(df)</span></code></pre></div></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 2 × 3
  承認番号         一般名称          日本医療機器名コード
  &lt;chr&gt;            &lt;chr&gt;             &lt;chr&gt;               
1 99Z9Z99999999999 架空一般医療機器  99999999            
2 88Y8Y88888888888 架空一般医療機器B 88888888            </code></pre>
</div>
</div>
<p>ポイントをまとめます。</p>
<ol type="1">
<li><code>list.files()</code>でディレクトリ内のXMLファイルのファイル名（パス込み）を取得します。
<ul>
<li>ワイルドカード<code>*</code>が使われています。前が何であれ、<code>.xml</code>という条件にマッチする要素を取得するということです。</li>
<li>また、<code>$</code>はそれで終わるということを指します。<code>.xml.csv</code>みたいに、<code>.xml</code>の後に別の要素が続くものは取得しないということです。</li>
</ul></li>
<li><code>function</code>で要素をデータフレームに入れる関数を作ります。
<ul>
<li><code>doc</code>に読み込んだXMLを格納し、そこからこれまでに見てきた方法で要素を抽出し、<code>tibble</code>（要はデータフレーム）の各列に格納します。</li>
<li>パイプを使っていないので関数の出てくる順が先ほどと逆ですが、<code>doc |&gt; xml_find_all() |&gt; xml_text()</code>の流れと同じです。</li>
</ul></li>
<li><code>map_dfr()</code>で順番に処理しデータフレームを作成
<ul>
<li>そもそも<code>map()</code>関数はリストやベクトルに対して関数を適用するものです。</li>
<li><code>map_dfr()</code>の<code>dfr</code>はdata frame row-bindの略で、<code>map()</code>の結果を行方向に結合することを指します。</li>
<li>すなわち、各ファイルを読み込んで要素を抽出、1行3列（今回の場合）のデータフレームを作成し、それをどんどん下に結合していくというイメージです。</li>
</ul></li>
</ol>
<p>ちなみに<code>for</code>ループでもできますが、そちらは今回は省略します。</p>
</section>
<section id="おわりに" class="level2">
<h2 class="anchored" data-anchor-id="おわりに">おわりに</h2>
<p>今回はXMLファイルの扱い方について取り上げました。</p>
<p>私は繰り返し処理までこれからやることになりそうなので、出番が増えそうです。</p>
<p>ご参考になれば幸いです。</p>


<!-- -->

</section>


<div id="quarto-appendix" class="default"><section id="footnotes" class="footnotes footnotes-end-of-document"><h2 class="anchored quarto-appendix-heading">注</h2>

<ol>
<li id="fn1"><p>名前空間がない場合は<code>//ApprovalAndLicenseNo</code>でもヒットします。↩︎</p></li>
</ol>
</section></div> ]]></description>
  <category>R</category>
  <category>データ処理</category>
  <guid>https://yo5uke.com/pages/tips/2025/08/250826_xml/</guid>
  <pubDate>Mon, 25 Aug 2025 15:00:00 GMT</pubDate>
  <media:content url="https://yo5uke.com/pages/tips/2025/08/250826_xml/image/thumbnail.png" medium="image" type="image/png" height="97" width="144"/>
</item>
<item>
  <title>【Python】高速スクレイピングを実装する【並列化】</title>
  <link>https://yo5uke.com/pages/tips/2025/08/250816_scraping_python/</link>
  <description><![CDATA[ 

<div class="social-share-buttons">
  <!-- Twitter (X) -->
  <a href="" id="js-share-twitter" class="share_button ri--twitter-x-fill" target="_blank" rel="nofollow noopener noreferrer"></a>

  <!-- Bluesky -->
  <a href="" id="js-share-bluesky" class="share_button ri--bluesky-fill" target="_blank" rel="nofollow noopener noreferrer"></a>
</div>

<script>
  const twitterUsername = "@5uke_y";
  const blueskyUsername = "@5uke.bsky.social";

  const share_url = encodeURIComponent(location.href);
  const share_title = document.title;

  // Twitter (X)
  document.getElementById('js-share-twitter').setAttribute(
    "href",
    "https://twitter.com/share?url=" + share_url + "&text=" + share_title + " " + encodeURIComponent(twitterUsername) + " より" +
    "&hashtags=rstats"
  );

  // Bluesky
  document.getElementById('js-share-bluesky').setAttribute(
    "href",
    "https://bsky.app/intent/compose?text=" + share_title + " " + share_url + " " + encodeURIComponent(blueskyUsername) + " より"
  );
</script>





<section id="はじめに" class="level2">
<h2 class="anchored" data-anchor-id="はじめに">はじめに</h2>
<p>Pythonでスクレイピングを実行したくて、ChatGPTに頼んでコードを書いてもらったということを以下の記事に書きました。</p>
<div class="callout callout-style-simple callout-tip no-icon">
<div class="callout-body d-flex">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-body-container">
<p><a href="../../../../../pages/blog/2025/08/250812_python_scraping/index.html">Pythonでスクレイピングをやってみる</a></p>
</div>
</div>
</div>
<p>また、これまでRでスクレイピングを実行する方法についていくつか記事を書いてきましたが、1つずつファイルをダウンロード、ZIPファイルを解凍、みたいな流れで実行していたところ、今回は複数のファイルを並列してダウンロードできる方法を学ぶことができました。</p>
<p>そのコード、手順についてまとめていきたいと思います。</p>
</section>
<section id="環境" class="level2">
<h2 class="anchored" data-anchor-id="環境">環境</h2>
<ul>
<li><p>Windows 11</p></li>
<li><p>Python 3.12.3</p></li>
</ul>
</section>
<section id="ダウンロードするページ" class="level2">
<h2 class="anchored" data-anchor-id="ダウンロードするページ">ダウンロードするページ</h2>
<p><a href="../../../../../pages/tips/2025/06/250613_scraping_pop_by_mesh/index.html">Rのコードを紹介したページ</a>と同じで、国勢調査をもとに公開しているメッシュごとの人口データをダウンロードします。URLは以下です。</p>
<p><a href="https://www.e-stat.go.jp/gis/statmap-search?page=1&amp;type=1&amp;toukeiCode=00200521&amp;toukeiYear=2020&amp;aggregateUnit=H&amp;serveyId=H002005112020&amp;statsId=T001141&amp;datum=2011" class="uri">https://www.e-stat.go.jp/gis/statmap-search?page=1&amp;type=1&amp;toukeiCode=00200521&amp;toukeiYear=2020&amp;aggregateUnit=H&amp;serveyId=H002005112020&amp;statsId=T001141&amp;datum=2011</a></p>
</section>
<section id="コード" class="level2">
<h2 class="anchored" data-anchor-id="コード">コード</h2>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb1" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb1-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># ====== Standard library ======</span></span>
<span id="cb1-2"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> re</span>
<span id="cb1-3"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> shutil</span>
<span id="cb1-4"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> threading</span>
<span id="cb1-5"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> zipfile</span>
<span id="cb1-6"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> pathlib <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> Path</span>
<span id="cb1-7"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> typing <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> Optional, Tuple</span>
<span id="cb1-8"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> urllib.parse <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> urljoin</span>
<span id="cb1-9"></span>
<span id="cb1-10"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># ====== Third-party ======</span></span>
<span id="cb1-11"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> requests</span>
<span id="cb1-12"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> bs4 <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> BeautifulSoup</span>
<span id="cb1-13"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> requests.adapters <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> HTTPAdapter</span>
<span id="cb1-14"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> tqdm <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> tqdm</span>
<span id="cb1-15"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> urllib3.util.retry <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> Retry</span>
<span id="cb1-16"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> concurrent.futures <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> ThreadPoolExecutor, as_completed</span>
<span id="cb1-17"></span>
<span id="cb1-18"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> selenium <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> webdriver</span>
<span id="cb1-19"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> selenium.webdriver.chrome.options <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> Options</span>
<span id="cb1-20"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> selenium.webdriver.common.by <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> By</span>
<span id="cb1-21"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> selenium.webdriver.support <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> expected_conditions <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">as</span> EC</span>
<span id="cb1-22"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> selenium.webdriver.support.ui <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> WebDriverWait</span>
<span id="cb1-23"></span>
<span id="cb1-24"></span>
<span id="cb1-25"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># ==============================</span></span>
<span id="cb1-26"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Settings</span></span>
<span id="cb1-27"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># ==============================</span></span>
<span id="cb1-28"></span>
<span id="cb1-29"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 保存先ディレクトリのパス（存在しない場合は作成）</span></span>
<span id="cb1-30">OUTPUT_DIR <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> Path(<span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;">r"data</span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">\250</span><span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;">813_scraping_python"</span>)</span>
<span id="cb1-31">OUTPUT_DIR.mkdir(parents<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">True</span>, exist_ok<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">True</span>)</span>
<span id="cb1-32"></span>
<span id="cb1-33"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># ベースURL（相対パスを補完するために使用）</span></span>
<span id="cb1-34">BASE_URL <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"https://www.e-stat.go.jp"</span></span>
<span id="cb1-35"></span>
<span id="cb1-36"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 並列処理設定</span></span>
<span id="cb1-37">MAX_WORKERS <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">6</span>          <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 同時DL数（回線速度・先方負荷に応じて調整）</span></span>
<span id="cb1-38">REQUEST_TIMEOUT <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">60</span>     <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># タイムアウト時間（秒）</span></span>
<span id="cb1-39"></span>
<span id="cb1-40"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># HTTPリクエスト時のUser-Agent（アクセス元をブラウザっぽく偽装）</span></span>
<span id="cb1-41">USER_AGENT <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> (</span>
<span id="cb1-42">    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Mozilla/5.0 (Windows NT 10.0; Win64; x64) "</span></span>
<span id="cb1-43">    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"AppleWebKit/537.36 (KHTML, like Gecko) "</span></span>
<span id="cb1-44">    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Chrome/126 Safari/537.36"</span></span>
<span id="cb1-45">)</span>
<span id="cb1-46"></span>
<span id="cb1-47"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># ==============================</span></span>
<span id="cb1-48"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Selenium setup</span></span>
<span id="cb1-49"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># ==============================</span></span>
<span id="cb1-50"></span>
<span id="cb1-51"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> create_chrome_driver() <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-&gt;</span> webdriver.Chrome:</span>
<span id="cb1-52">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">"""Headless Chromeのドライバーを作成"""</span></span>
<span id="cb1-53">    options <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> Options()</span>
<span id="cb1-54">    </span>
<span id="cb1-55">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># ヘッドレスモード（ブラウザ画面を表示せずにバックグラウンドで動作）</span></span>
<span id="cb1-56">    options.add_argument(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"--headless=new"</span>)</span>
<span id="cb1-57">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># GPU無効化（描画関連の不要な処理を省く）</span></span>
<span id="cb1-58">    options.add_argument(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"--disable-gpu"</span>)</span>
<span id="cb1-59">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># ウィンドウサイズ指定（幅×高さ）</span></span>
<span id="cb1-60">    options.add_argument(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"--window-size=1280,1800"</span>)</span>
<span id="cb1-61">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 自動化検知を回避（アクセスブロック対策）</span></span>
<span id="cb1-62">    options.add_argument(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"--disable-blink-features=AutomationControlled"</span>)</span>
<span id="cb1-63">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># User-Agentを上書き（アクセス元をブラウザっぽく偽装）</span></span>
<span id="cb1-64">    options.add_argument(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"user-agent=</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>USER_AGENT<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>)</span>
<span id="cb1-65"></span>
<span id="cb1-66">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Chromeドライバーを生成</span></span>
<span id="cb1-67">    driver <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> webdriver.Chrome(options<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>options)</span>
<span id="cb1-68">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># ページ読み込みのタイムアウト（秒）</span></span>
<span id="cb1-69">    driver.set_page_load_timeout(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">60</span>)</span>
<span id="cb1-70">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># JavaScript実行のタイムアウト（秒）</span></span>
<span id="cb1-71">    driver.set_script_timeout(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">60</span>)</span>
<span id="cb1-72"></span>
<span id="cb1-73">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> driver</span>
<span id="cb1-74"></span>
<span id="cb1-75"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># ==============================</span></span>
<span id="cb1-76"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Dynamic page loader</span></span>
<span id="cb1-77"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># ==============================</span></span>
<span id="cb1-78"></span>
<span id="cb1-79"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> fetch_rendered_html(</span>
<span id="cb1-80">    url: <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">str</span>,</span>
<span id="cb1-81">    driver: webdriver.Chrome,</span>
<span id="cb1-82">    wait_for_css: Optional[<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">str</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">None</span>,</span>
<span id="cb1-83">    timeout: <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">int</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">20</span>,</span>
<span id="cb1-84">) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-&gt;</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">str</span>:</span>
<span id="cb1-85">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">"""</span></span>
<span id="cb1-86"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    JavaScript実行後のHTMLを取得する関数</span></span>
<span id="cb1-87"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    必要に応じて、特定のCSSセレクタがDOMに出現するまで待機</span></span>
<span id="cb1-88"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    """</span></span>
<span id="cb1-89">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 指定したURLにアクセス</span></span>
<span id="cb1-90">    driver.get(url)</span>
<span id="cb1-91"></span>
<span id="cb1-92">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># ページの読み込み完了まで待機</span></span>
<span id="cb1-93">    WebDriverWait(driver, timeout).until(</span>
<span id="cb1-94">        <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">lambda</span> d: d.execute_script(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"return document.readyState"</span>) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"complete"</span></span>
<span id="cb1-95">    )</span>
<span id="cb1-96"></span>
<span id="cb1-97">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># もしCSSセレクタが指定されていれば、その要素が表示されるまで待機</span></span>
<span id="cb1-98">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># （JSによる非同期描画の完了を保証するため）</span></span>
<span id="cb1-99">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> wait_for_css:</span>
<span id="cb1-100">        WebDriverWait(driver, timeout).until(</span>
<span id="cb1-101">            EC.presence_of_all_elements_located((By.CSS_SELECTOR, wait_for_css))</span>
<span id="cb1-102">        )</span>
<span id="cb1-103"></span>
<span id="cb1-104">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 最終的なページのHTMLソースを返す</span></span>
<span id="cb1-105">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> driver.page_source</span>
<span id="cb1-106"></span>
<span id="cb1-107"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># ==============================</span></span>
<span id="cb1-108"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Link extraction</span></span>
<span id="cb1-109"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># ==============================</span></span>
<span id="cb1-110"></span>
<span id="cb1-111"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> find_csv_links(html: <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">str</span>, pattern: <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">str</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;">r"data</span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">\?</span><span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;">statsId=T001141"</span>) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-&gt;</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">list</span>[<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">str</span>]:</span>
<span id="cb1-112">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">"""</span></span>
<span id="cb1-113"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    HTMLから指定パターンに合致するリンク（href属性）を抽出する関数。</span></span>
<span id="cb1-114"></span>
<span id="cb1-115"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    Parameters</span></span>
<span id="cb1-116"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    ----------</span></span>
<span id="cb1-117"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    html : str</span></span>
<span id="cb1-118"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">        取得済みのHTML文字列</span></span>
<span id="cb1-119"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    pattern : str</span></span>
<span id="cb1-120"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">        hrefがこのパターンにマッチするリンクだけを抽出</span></span>
<span id="cb1-121"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">        デフォルトは 'data?statsId=T001141' を含むリンク。</span></span>
<span id="cb1-122"></span>
<span id="cb1-123"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    Returns</span></span>
<span id="cb1-124"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    -------</span></span>
<span id="cb1-125"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    list[str]</span></span>
<span id="cb1-126"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">        マッチしたhrefのリスト。</span></span>
<span id="cb1-127"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    """</span></span>
<span id="cb1-128">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># HTML文字列をBeautifulSoupでパース</span></span>
<span id="cb1-129">    soup <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> BeautifulSoup(html, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"html.parser"</span>)</span>
<span id="cb1-130"></span>
<span id="cb1-131">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># &lt;a&gt;タグの中でhref属性を持つものをすべて取得し、</span></span>
<span id="cb1-132">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># さらにhrefが正規表現patternに一致するものだけを抽出</span></span>
<span id="cb1-133">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> [</span>
<span id="cb1-134">        a[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"href"</span>]</span>
<span id="cb1-135">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> a <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> soup.find_all(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"a"</span>, href<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">True</span>)</span>
<span id="cb1-136">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> re.search(pattern, a[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"href"</span>])</span>
<span id="cb1-137">    ]</span>
<span id="cb1-138"></span>
<span id="cb1-139"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># ==============================</span></span>
<span id="cb1-140"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Thread-local requests.Session</span></span>
<span id="cb1-141"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># ==============================</span></span>
<span id="cb1-142"></span>
<span id="cb1-143"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># スレッドごとに独立したデータを持てる入れ物を作成</span></span>
<span id="cb1-144">_thread_local <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> threading.local()</span>
<span id="cb1-145"></span>
<span id="cb1-146"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> get_session() <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-&gt;</span> requests.Session:</span>
<span id="cb1-147">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">"""</span></span>
<span id="cb1-148"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    スレッドローカルに保持されるHTTPセッションを取得する関数。</span></span>
<span id="cb1-149"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    接続プーリング、リトライ設定、統一User-Agentを適用。</span></span>
<span id="cb1-150"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    </span></span>
<span id="cb1-151"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    - スレッドローカル: 各スレッドで独立したセッションを保持するための仕組み。</span></span>
<span id="cb1-152"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    - 接続プーリング: 同じホストへの接続を再利用して効率化。</span></span>
<span id="cb1-153"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    - リトライ設定: 一時的なエラー（429, 500, 502, 503, 504）に対して最大3回まで再試行。</span></span>
<span id="cb1-154"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    - User-Agent統一: リクエストの送信元情報を統一してサーバー側の認識を安定化。</span></span>
<span id="cb1-155"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    """</span></span>
<span id="cb1-156">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">getattr</span>(_thread_local, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"session"</span>, <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">None</span>) <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">is</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">None</span>:</span>
<span id="cb1-157">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 新規セッション作成</span></span>
<span id="cb1-158">        s <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> requests.Session()</span>
<span id="cb1-159">        s.headers.update({<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"User-Agent"</span>: USER_AGENT})</span>
<span id="cb1-160"></span>
<span id="cb1-161">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># リトライ戦略の設定</span></span>
<span id="cb1-162">        retries <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> Retry(</span>
<span id="cb1-163">            total<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>,                   <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 最大リトライ回数</span></span>
<span id="cb1-164">            backoff_factor<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.8</span>,        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># リトライ間隔の指数的増加係数</span></span>
<span id="cb1-165">            status_forcelist<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">429</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">500</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">502</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">503</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">504</span>),  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 再試行対象のHTTPステータスコード</span></span>
<span id="cb1-166">            allowed_methods<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"GET"</span>,),  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># リトライ対象HTTPメソッド</span></span>
<span id="cb1-167">        )</span>
<span id="cb1-168"></span>
<span id="cb1-169">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 接続アダプタの設定（プーリングとリトライ）</span></span>
<span id="cb1-170">        adapter <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> HTTPAdapter(</span>
<span id="cb1-171">            pool_connections<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>MAX_WORKERS,  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 同時接続プール数</span></span>
<span id="cb1-172">            pool_maxsize<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>MAX_WORKERS,      <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># プールの最大接続数</span></span>
<span id="cb1-173">            max_retries<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>retries,           <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 上記リトライ戦略を適用</span></span>
<span id="cb1-174">        )</span>
<span id="cb1-175">        s.mount(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"http://"</span>, adapter)</span>
<span id="cb1-176">        s.mount(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"https://"</span>, adapter)</span>
<span id="cb1-177"></span>
<span id="cb1-178">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># スレッドローカルに保存</span></span>
<span id="cb1-179">        _thread_local.session <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> s</span>
<span id="cb1-180"></span>
<span id="cb1-181">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> _thread_local.session</span>
<span id="cb1-182"></span>
<span id="cb1-183"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># ==============================</span></span>
<span id="cb1-184"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># ZIP download &amp; extract (worker)</span></span>
<span id="cb1-185"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># ==============================</span></span>
<span id="cb1-186"></span>
<span id="cb1-187"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> fetch_zip_and_extract_txt(task: Tuple[<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">str</span>, <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">str</span>]) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-&gt;</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">tuple</span>[<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">str</span>, <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">bool</span>, <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">str</span>]:</span>
<span id="cb1-188">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">"""</span></span>
<span id="cb1-189"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    指定URLからZIPをダウンロードし、中の最初の'.txt'ファイルを</span></span>
<span id="cb1-190"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    'pop_mesh{code}.txt' という名前で保存する関数。</span></span>
<span id="cb1-191"></span>
<span id="cb1-192"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    戻り値:</span></span>
<span id="cb1-193"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">        (url, success, message)</span></span>
<span id="cb1-194"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">        url     : ダウンロード元のURL</span></span>
<span id="cb1-195"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">        success : 成功した場合はTrue、失敗はFalse</span></span>
<span id="cb1-196"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">        message : 実行結果の簡易説明</span></span>
<span id="cb1-197"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    """</span></span>
<span id="cb1-198">    full_url, code <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> task</span>
<span id="cb1-199">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 一時保存用のZIPファイルパス</span></span>
<span id="cb1-200">    zip_path <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> OUTPUT_DIR <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> <span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"pop_mesh</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>code<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">.zip"</span></span>
<span id="cb1-201">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 最終的に保存するテキストファイルパス</span></span>
<span id="cb1-202">    txt_path <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> OUTPUT_DIR <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> <span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"pop_mesh</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>code<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">.txt"</span></span>
<span id="cb1-203"></span>
<span id="cb1-204">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># すでにtxtが存在する場合はスキップ</span></span>
<span id="cb1-205">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> txt_path.exists():</span>
<span id="cb1-206">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> full_url, <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">True</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"skipped (exists)"</span></span>
<span id="cb1-207"></span>
<span id="cb1-208">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">try</span>:</span>
<span id="cb1-209">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># セッションを取得（接続の再利用などを行う）</span></span>
<span id="cb1-210">        session <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> get_session()</span>
<span id="cb1-211"></span>
<span id="cb1-212">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># ZIPをダウンロード（ストリーミングで少しずつ書き込み）</span></span>
<span id="cb1-213">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">with</span> session.get(full_url, stream<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">True</span>, timeout<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>REQUEST_TIMEOUT) <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">as</span> resp:</span>
<span id="cb1-214">            resp.raise_for_status()</span>
<span id="cb1-215">            <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">with</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">open</span>(zip_path, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"wb"</span>) <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">as</span> f:</span>
<span id="cb1-216">                <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> chunk <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> resp.iter_content(chunk_size<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">8192</span>):</span>
<span id="cb1-217">                    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> chunk:</span>
<span id="cb1-218">                        f.write(chunk)</span>
<span id="cb1-219"></span>
<span id="cb1-220">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># ZIPファイルでなければ削除して終了</span></span>
<span id="cb1-221">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">not</span> zipfile.is_zipfile(zip_path):</span>
<span id="cb1-222">            zip_path.unlink(missing_ok<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">True</span>)</span>
<span id="cb1-223">            <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> full_url, <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">False</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"not a zip file"</span></span>
<span id="cb1-224"></span>
<span id="cb1-225">        found_txt <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">False</span></span>
<span id="cb1-226">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">with</span> zipfile.ZipFile(zip_path, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"r"</span>) <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">as</span> zf:</span>
<span id="cb1-227">            <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> info <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> zf.infolist():</span>
<span id="cb1-228">                <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> info.is_dir():  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># ディレクトリはスキップ</span></span>
<span id="cb1-229">                    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">continue</span></span>
<span id="cb1-230">                <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> info.filename.lower().endswith(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">".txt"</span>):</span>
<span id="cb1-231">                    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 直接上書きせず一時ファイルに保存 → 後でリネーム（競合回避）</span></span>
<span id="cb1-232">                    tmp_path <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> txt_path.with_suffix(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">".txt.part"</span>)</span>
<span id="cb1-233">                    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">with</span> zf.<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">open</span>(info) <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">as</span> src, <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">open</span>(tmp_path, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"wb"</span>) <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">as</span> dst:</span>
<span id="cb1-234">                        shutil.copyfileobj(src, dst)</span>
<span id="cb1-235">                    tmp_path.replace(txt_path)</span>
<span id="cb1-236">                    found_txt <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">True</span></span>
<span id="cb1-237">                    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">break</span></span>
<span id="cb1-238"></span>
<span id="cb1-239">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># ZIPは不要になったので削除</span></span>
<span id="cb1-240">        zip_path.unlink(missing_ok<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">True</span>)</span>
<span id="cb1-241"></span>
<span id="cb1-242">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># TXTが見つからなかった場合</span></span>
<span id="cb1-243">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">not</span> found_txt:</span>
<span id="cb1-244">            <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> full_url, <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">False</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"no .txt in zip"</span></span>
<span id="cb1-245">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> full_url, <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">True</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"ok"</span></span>
<span id="cb1-246"></span>
<span id="cb1-247">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">except</span> <span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">Exception</span> <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">as</span> e:</span>
<span id="cb1-248">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># エラー時はZIPを削除</span></span>
<span id="cb1-249">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">try</span>:</span>
<span id="cb1-250">            zip_path.unlink(missing_ok<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">True</span>)</span>
<span id="cb1-251">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">except</span> <span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">Exception</span>:</span>
<span id="cb1-252">            <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">pass</span></span>
<span id="cb1-253">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> full_url, <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">False</span>, <span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"error: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>e<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span></span>
<span id="cb1-254"></span>
<span id="cb1-255"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># ==============================</span></span>
<span id="cb1-256"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Main</span></span>
<span id="cb1-257"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># ==============================</span></span>
<span id="cb1-258"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> main() <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-&gt;</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">None</span>:</span>
<span id="cb1-259">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">"""一覧ページを巡回→リンク収集→並列ダウンロード。"""</span></span>
<span id="cb1-260">    driver <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> create_chrome_driver()  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Chromeドライバー生成</span></span>
<span id="cb1-261">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">try</span>:</span>
<span id="cb1-262">        tasks: <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">list</span>[<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">tuple</span>[<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">str</span>, <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">str</span>]] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> []  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># ダウンロード対象の (URL, code) タプルを格納</span></span>
<span id="cb1-263"></span>
<span id="cb1-264">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># ページ番号 1〜8 を巡回してリンクを収集</span></span>
<span id="cb1-265">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> i <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> tqdm(<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">range</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">9</span>), desc<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"ページ巡回"</span>):</span>
<span id="cb1-266">            <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># ページごとのURL生成</span></span>
<span id="cb1-267">            url <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> (</span>
<span id="cb1-268">                <span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"https://www.e-stat.go.jp/gis/statmap-search?page=</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>i<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span></span>
<span id="cb1-269">                <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"&amp;type=1&amp;toukeiCode=00200521&amp;toukeiYear=2020&amp;aggregateUnit=H"</span></span>
<span id="cb1-270">                <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"&amp;serveyId=H002005112020&amp;statsId=T001141&amp;datum=2011"</span></span>
<span id="cb1-271">            )</span>
<span id="cb1-272">            <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># JavaScriptレンダリング後のHTMLを取得</span></span>
<span id="cb1-273">            html <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> fetch_rendered_html(</span>
<span id="cb1-274">                url,</span>
<span id="cb1-275">                driver,</span>
<span id="cb1-276">                wait_for_css<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"a[href*='data?statsId=T001141']"</span>,  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># このCSSが出現するまで待機</span></span>
<span id="cb1-277">                timeout<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">25</span>,</span>
<span id="cb1-278">            )</span>
<span id="cb1-279">            <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># CSVリンク抽出</span></span>
<span id="cb1-280">            csv_links <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> find_csv_links(html)</span>
<span id="cb1-281">            <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 相対パスを絶対URLへ変換</span></span>
<span id="cb1-282">            full_urls <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> [urljoin(BASE_URL, link) <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> link <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> csv_links]</span>
<span id="cb1-283"></span>
<span id="cb1-284">            <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># URLとcodeをセットで保存</span></span>
<span id="cb1-285">            <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> full_url, csv_link <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">zip</span>(full_urls, csv_links):</span>
<span id="cb1-286">                m <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> re.search(<span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;">r"code=</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">(</span><span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">[0-9]</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">)</span><span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>, csv_link)</span>
<span id="cb1-287">                code <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> m.group(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>) <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> m <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">else</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"unknown"</span></span>
<span id="cb1-288">                tasks.append((full_url, code))</span>
<span id="cb1-289"></span>
<span id="cb1-290">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 成功・失敗・スキップ件数カウンタ</span></span>
<span id="cb1-291">        successes <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span></span>
<span id="cb1-292">        failures <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span></span>
<span id="cb1-293">        skipped <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span></span>
<span id="cb1-294"></span>
<span id="cb1-295">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 並列ダウンロード処理</span></span>
<span id="cb1-296">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">with</span> ThreadPoolExecutor(max_workers<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>MAX_WORKERS) <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">as</span> ex:</span>
<span id="cb1-297">            futures <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> [ex.submit(fetch_zip_and_extract_txt, t) <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> t <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> tasks]</span>
<span id="cb1-298">            <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> fut <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> tqdm(as_completed(futures), total<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">len</span>(futures), desc<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"ダウンロード"</span>):</span>
<span id="cb1-299">                url, ok, msg <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> fut.result()</span>
<span id="cb1-300">                <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> ok <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">and</span> msg.startswith(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"ok"</span>):</span>
<span id="cb1-301">                    successes <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span></span>
<span id="cb1-302">                <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">elif</span> ok <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">and</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"skipped"</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> msg:</span>
<span id="cb1-303">                    skipped <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span></span>
<span id="cb1-304">                <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">else</span>:</span>
<span id="cb1-305">                    failures <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span></span>
<span id="cb1-306"></span>
<span id="cb1-307">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 処理結果を表示</span></span>
<span id="cb1-308">        <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"</span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">\n</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">Done. ok=</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>successes<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">, skipped=</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>skipped<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">, failed=</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>failures<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>)</span>
<span id="cb1-309"></span>
<span id="cb1-310">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">finally</span>:</span>
<span id="cb1-311">        driver.quit()  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># ブラウザを閉じる</span></span>
<span id="cb1-312"></span>
<span id="cb1-313"></span>
<span id="cb1-314"><span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">__name__</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"__main__"</span>:</span>
<span id="cb1-315">    main()</span></code></pre></div></div>
</section>
<section id="ざっくり解説" class="level2">
<h2 class="anchored" data-anchor-id="ざっくり解説">ざっくり解説</h2>
<p>Setting, Selenium setupなど、いくつかのブロックに分かれているので、各ブロックでどのようなことをしているのか、ざっくり確認していきます。</p>
<section id="settings" class="level3">
<h3 class="anchored" data-anchor-id="settings">Settings</h3>
<p>スクレイピングに必要な設定をしています。URLは場合に合わせて変える必要があります。</p>
<p><code>MAX_WORKERS</code>の部分でいくつ並列でダウンロードするかを設定しているのが今回のミソだと思います。6つ平行することで高速化を図っています。</p>
<p><code>USER_AGENT</code>では、どのブラウザ、環境からアクセスしているのかを設定するもので、デフォルトだと自動化ツールからのアクセスと判断され、アクセスが拒否される可能性があるので、それを防ぐために設定をしています。</p>
</section>
<section id="selenium-setup" class="level3">
<h3 class="anchored" data-anchor-id="selenium-setup">Selenium setup</h3>
<p>細かい設定はコメントで書いている通りではあるのですが、ブラウザを自動操作できる環境を整えている部分です。</p>
<p>ブラウザをバックグラウンドで動かしたり、無駄な描画はなくしたりと、効率的な設定をここで指定しています。</p>
</section>
<section id="dynamic-page-loader" class="level3">
<h3 class="anchored" data-anchor-id="dynamic-page-loader">Dynamic page loader</h3>
<p>ここがRでいうところの<code>read_html_live()</code>に当たる部分です。</p>
<p>指定されたURLにアクセスして、HTMLソースを返すといった作業をしています。</p>
<p>コメントを読んでいただくと、JavaScriptにも対応しているのがお分かりになるかと思います。</p>
</section>
<section id="link-extraction" class="level3">
<h3 class="anchored" data-anchor-id="link-extraction">Link extraction</h3>
<p>これはRでいうところの<code>html_attrs()</code>や<code>html_elements()</code>に該当するようなことをしています。</p>
<p><code>a</code>タグを探してきて、その中に含まれる<code>href</code>を引っ張ってくるということをしています。<code>href</code>にはダウンロードのためのリンクが含まれています。</p>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
<span class="screen-reader-only">Note</span>リンクの探し方について
</div>
</div>
<div class="callout-body-container callout-body">
<p><code>a</code>タグの探し方などについては、<a href="../../../../../pages/tips/2025/03/250319_scraping/index.html#ファイルのリンクを取得">こちら</a>で簡単に説明しています。</p>
</div>
</div>
</section>
<section id="thread-local-requests.session" class="level3">
<h3 class="anchored" data-anchor-id="thread-local-requests.session">Thread-local requests.Session</h3>
<p>ここでは、各スレッドごとに独立したHTTPセッションを用意しています。</p>
<p>これにより、並列ダウンロード時に接続が混線せず安全に動作し、さらにセッションの接続再利用（コネクションプール）によって通信が効率化されます。</p>
<p>またリトライ設定やUser-Agentの統一もここでまとめて適用しているので、安定性と速度の両立ができます。</p>
</section>
<section id="zip-download-extract-worker" class="level3">
<h3 class="anchored" data-anchor-id="zip-download-extract-worker">ZIP download &amp; extract (worker)</h3>
<p>ここではZIPファイルのダウンロードと解凍の設定をしています。</p>
<p>今回はダウンロードするものの中身はテキストファイルなので<code>.txt</code>として解凍するように設定していますが、ここはダウンロードするものに合わせて変更する必要があります。</p>
<p>変なものをダウンロードしてしまった場合の対処や、既にファイルが存在する場合の対処もしているので、ミスにもある程度対応できるようになっています。エラーメッセージも表示されるようにしているので、何のエラーが起きたのかはわかるようになっています。</p>
</section>
<section id="main" class="level3">
<h3 class="anchored" data-anchor-id="main">Main</h3>
<p>その名の通りメインのコードです。</p>
<p>今回はページ数が1～8まであるとわかっていますので、<code>range(1, 9)</code>と書かれています。Rと違うので戸惑ったのですが、Pythonでは開始値は含み、終了値は含まないようです。なので1と9が記されています。</p>
<p>流れとしては、ページを巡回してダウンロード先のURLを保存し、巡回し終わったら並列でそれらをダウンロードしていきます。ここが並列になっているので、ダウンロードの速度が向上しているというわけです。</p>
<p>ダウンロード後にはダウンロードに成功したもの、既に存在してスキップしたもの、失敗したものの件数を出力するようにしています。</p>
<p>最後には<code>driver.quit()</code>でブラウザを終了させ、プロセスやメモリが残らないようになっています。</p>
</section>
<section id="最後のif文" class="level3">
<h3 class="anchored" data-anchor-id="最後のif文">最後の<code>if</code>文</h3>
<p>1番最後の行は「このファイルを直接実行したときだけ<code>main()</code>を動かす」という役割を持っています。<br>
</p>
<p>Pythonでは同じファイルをスクリプトとして実行することも、ライブラリとして他のプログラムから読み込むこともできますが、この仕組みによって「直接実行した場合だけスクレイピング処理を走らせ、importされた場合には余計な処理をしない」ようにしています。</p>
</section>
</section>
<section id="おわりに" class="level2">
<h2 class="anchored" data-anchor-id="おわりに">おわりに</h2>
<p>今回はChatGPTに手伝ってもらいながら、RでのスクレイピングコードをPythonに書き換え、簡単にまとめました。</p>
<p>自分もPythonは勉強を始めたばかりではあるので認識の誤り等あるかもしれませんが、コメントからお寄せいただければ幸いです。</p>
<p>個人的には業務の効率化を図るうえでPythonでのスクレイピングを活用していきたいと思っているので、引き続きアップデートなどあればまた記事にしていきたいと思います。</p>


<!-- -->

</section>

 ]]></description>
  <category>Python</category>
  <category>データ処理</category>
  <guid>https://yo5uke.com/pages/tips/2025/08/250816_scraping_python/</guid>
  <pubDate>Fri, 15 Aug 2025 15:00:00 GMT</pubDate>
</item>
<item>
  <title>recode関数でデータフレームの中身を置き換える</title>
  <link>https://yo5uke.com/pages/tips/2025/07/250727_recode/</link>
  <description><![CDATA[ 

<div class="social-share-buttons">
  <!-- Twitter (X) -->
  <a href="" id="js-share-twitter" class="share_button ri--twitter-x-fill" target="_blank" rel="nofollow noopener noreferrer"></a>

  <!-- Bluesky -->
  <a href="" id="js-share-bluesky" class="share_button ri--bluesky-fill" target="_blank" rel="nofollow noopener noreferrer"></a>
</div>

<script>
  const twitterUsername = "@5uke_y";
  const blueskyUsername = "@5uke.bsky.social";

  const share_url = encodeURIComponent(location.href);
  const share_title = document.title;

  // Twitter (X)
  document.getElementById('js-share-twitter').setAttribute(
    "href",
    "https://twitter.com/share?url=" + share_url + "&text=" + share_title + " " + encodeURIComponent(twitterUsername) + " より" +
    "&hashtags=rstats"
  );

  // Bluesky
  document.getElementById('js-share-bluesky').setAttribute(
    "href",
    "https://bsky.app/intent/compose?text=" + share_title + " " + share_url + " " + encodeURIComponent(blueskyUsername) + " より"
  );
</script>





<div class="callout callout-style-default callout-caution callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
<span class="screen-reader-only">Caution</span>recode()関数について
</div>
</div>
<div class="callout-body-container callout-body">
<p>このページでは{dplyr}パッケージの<code>recode()</code>関数を紹介しますが、現在<code>recode()</code>はsuperseded（置き換えられた）状態にあり<sup>1</sup>、代わりに<code>case_match()</code>関数の使用が推奨されています。<br>
<code>case_match()</code>に関しては以下をご覧ください。</p>
<p><a href="../../../../../pages/tips/2025/11/251124_case_match/index.html">【R】<span class="fira-code">case_match()</span>でデータフレームの中身を置き換える</a></p>
</div>
</div>
<section id="はじめに" class="level2">
<h2 class="anchored" data-anchor-id="はじめに">はじめに</h2>
<p>今回は{dplyr}パッケージの<code>recode()</code>関数を紹介します。</p>
<p>例えばデータフレーム内の変数がカテゴリ変数で、便宜的に数値で表されているような場合、そのまま表に出すことはできないかもしれません。</p>
<p>そんなときに中身を置き換える手段として使えるのが<code>recode()</code>関数で、イメージとしては<code>case_when()</code>と似ているかもしれません<sup>2</sup>。</p>
<p>1度きりの変換であれば<code>case_when</code>でもあまり労力は変わらないかもしれませんが、何回も繰り返し置き換えたいときは、シンプルで強みを発揮します。</p>
</section>
<section id="使い方" class="level2">
<h2 class="anchored" data-anchor-id="使い方">使い方</h2>
<section id="パッケージ" class="level3">
<h3 class="anchored" data-anchor-id="パッケージ">パッケージ</h3>
<p>{dplyr}に入っているので、{tidyverse}を読み込んでいれば使えます。</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb1" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(tidyverse)</span>
<span id="cb1-2"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># あるいは</span></span>
<span id="cb1-3"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># library(dplyr)</span></span></code></pre></div></div>
</div>
</section>
<section id="データフレーム" class="level3">
<h3 class="anchored" data-anchor-id="データフレーム">データフレーム</h3>
<p>今回は以下のようなデータフレームを想定します。</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb2" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1">df <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">tibble</span>(</span>
<span id="cb2-2">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">id =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>,</span>
<span id="cb2-3">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">sex =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rep</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">times =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>)</span>
<span id="cb2-4">)</span></code></pre></div></div>
</div>
<div class="cell">
<div id="tbl-example" class="cell quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-tbl figure">
<figcaption class="quarto-float-caption-top quarto-float-caption quarto-float-tbl" id="tbl-example-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
表&nbsp;1: テーブルの例
</figcaption>
<div aria-describedby="tbl-example-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<div class="cell-output-display">
<!-- preamble start -->

    <script src="https://cdn.jsdelivr.net/gh/vincentarelbundock/tinytable@main/inst/tinytable.js"></script>

    <script>
      // Create table-specific functions using external factory
      const tableFns_eq44u4e0nrv66f6ggoyq = TinyTable.createTableFunctions("tinytable_eq44u4e0nrv66f6ggoyq");
      // tinytable span after
      window.addEventListener('load', function () {
          var cellsToStyle = [
            // tinytable style arrays after
          { positions: [ { i: '4', j: 1 }, { i: '4', j: 2 } ], css_id: 'tinytable_css_8osu6p2ndcniqz15i6b1',}, 
          { positions: [ { i: '0', j: 1 }, { i: '0', j: 2 } ], css_id: 'tinytable_css_r9kly4xm51z6b4wzdp1h',}, 
          ];

          // Loop over the arrays to style the cells
          cellsToStyle.forEach(function (group) {
              group.positions.forEach(function (cell) {
                  tableFns_eq44u4e0nrv66f6ggoyq.styleCell(cell.i, cell.j, group.css_id);
              });
          });
      });
    </script>

    <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/vincentarelbundock/tinytable@main/inst/tinytable.css">
    <style>
    /* tinytable css entries after */
    #tinytable_eq44u4e0nrv66f6ggoyq td.tinytable_css_8osu6p2ndcniqz15i6b1, #tinytable_eq44u4e0nrv66f6ggoyq th.tinytable_css_8osu6p2ndcniqz15i6b1 {  position: relative; --border-bottom: 1; --border-left: 0; --border-right: 0; --border-top: 0; --line-color-bottom: var(--tt-line-color); --line-color-left: var(--tt-line-color); --line-color-right: var(--tt-line-color); --line-color-top: var(--tt-line-color); --line-width-bottom: 0.1em; --line-width-left: 0.1em; --line-width-right: 0.1em; --line-width-top: 0.1em; --trim-bottom-left: 0%; --trim-bottom-right: 0%; --trim-left-bottom: 0%; --trim-left-top: 0%; --trim-right-bottom: 0%; --trim-right-top: 0%; --trim-top-left: 0%; --trim-top-right: 0%;  }
    #tinytable_eq44u4e0nrv66f6ggoyq td.tinytable_css_r9kly4xm51z6b4wzdp1h, #tinytable_eq44u4e0nrv66f6ggoyq th.tinytable_css_r9kly4xm51z6b4wzdp1h {  position: relative; --border-bottom: 1; --border-left: 0; --border-right: 0; --border-top: 1; --line-color-bottom: var(--tt-line-color); --line-color-left: var(--tt-line-color); --line-color-right: var(--tt-line-color); --line-color-top: var(--tt-line-color); --line-width-bottom: 0.05em; --line-width-left: 0.1em; --line-width-right: 0.1em; --line-width-top: 0.1em; --trim-bottom-left: 0%; --trim-bottom-right: 0%; --trim-left-bottom: 0%; --trim-left-top: 0%; --trim-right-bottom: 0%; --trim-right-top: 0%; --trim-top-left: 0%; --trim-top-right: 0%;  }
    </style>
    <div class="container">
      <table class="tinytable" id="tinytable_eq44u4e0nrv66f6ggoyq" style="width: auto; margin-left: auto; margin-right: auto;" data-quarto-disable-processing="true">
        
        <thead>
              <tr>
                <th scope="col" data-row="0" data-col="1">id</th>
                <th scope="col" data-row="0" data-col="2">sex</th>
              </tr>
        </thead>
        
        <tbody>
                <tr>
                  <td data-row="1" data-col="1">1</td>
                  <td data-row="1" data-col="2">1</td>
                </tr>
                <tr>
                  <td data-row="2" data-col="1">2</td>
                  <td data-row="2" data-col="2">2</td>
                </tr>
                <tr>
                  <td data-row="3" data-col="1">3</td>
                  <td data-row="3" data-col="2">1</td>
                </tr>
                <tr>
                  <td data-row="4" data-col="1">4</td>
                  <td data-row="4" data-col="2">2</td>
                </tr>
        </tbody>
      </table>
    </div>
<!-- hack to avoid NA insertion in last line -->
</div>
</div>
</figure>
</div>
</div>
<p>超絶簡単なデータフレームです。4人のIDと性別が1, 2の表記で含まれているだけです。ここで1を男性、2を女性とします。</p>
</section>
<section id="対応表を作る" class="level3">
<h3 class="anchored" data-anchor-id="対応表を作る">対応表を作る</h3>
<p>これを表に起こしたいとき、たとえばそのまま<code>tinytable::tt()</code>で表示したとしたら、 表&nbsp;1 がそのまま出てきてしまい、数字が誰を、何を表しているのかがわかりませんよね。</p>
<p>そこで、あらかじめ対応表を作って置きます。</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb3" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1">id_map <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(</span>
<span id="cb3-2">  <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"1"</span> <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Michael"</span>,</span>
<span id="cb3-3">  <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"2"</span> <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Emily"</span>,</span>
<span id="cb3-4">  <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"3"</span> <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"John"</span>,</span>
<span id="cb3-5">  <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"4"</span> <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Jessica"</span></span>
<span id="cb3-6">)</span>
<span id="cb3-7"></span>
<span id="cb3-8">sex_map <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(</span>
<span id="cb3-9">  <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"1"</span> <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Male"</span>,</span>
<span id="cb3-10">  <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"2"</span> <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Female"</span></span>
<span id="cb3-11">)</span></code></pre></div></div>
</div>
<p><code>c()</code>の中に、<code>=</code>の左にデータフレーム内の表記を、右に表示したい表記を書いていきます。</p>
<p>今回はIDと性別を両方書き換えたいので、2種類の対応関係を示したベクトルを作成しています。</p>
</section>
<section id="recodeを使う" class="level3">
<h3 class="anchored" data-anchor-id="recodeを使う"><code>recode()</code>を使う</h3>
<p>この対応表をもとに、<code>recode()</code>関数を使っていきます。使う際は、<code>mutate()</code>と組み合わせます。</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb4" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1">df_recode <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> df <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span></span>
<span id="cb4-2">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mutate</span>(</span>
<span id="cb4-3">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">id =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">recode</span>(id, <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">!!!</span>id_map),</span>
<span id="cb4-4">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">sex =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">recode</span>(sex, <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">!!!</span>sex_map)</span>
<span id="cb4-5">  )</span></code></pre></div></div>
</div>
<div class="cell">
<div id="tbl-recode" class="cell quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-tbl figure">
<figcaption class="quarto-float-caption-top quarto-float-caption quarto-float-tbl" id="tbl-recode-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
表&nbsp;2: <code>recode()</code>を使用した表
</figcaption>
<div aria-describedby="tbl-recode-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<div class="cell-output-display">
<!-- preamble start -->

    <script src="https://cdn.jsdelivr.net/gh/vincentarelbundock/tinytable@main/inst/tinytable.js"></script>

    <script>
      // Create table-specific functions using external factory
      const tableFns_ska4aa6i0trrc9uqv55q = TinyTable.createTableFunctions("tinytable_ska4aa6i0trrc9uqv55q");
      // tinytable span after
      window.addEventListener('load', function () {
          var cellsToStyle = [
            // tinytable style arrays after
          { positions: [ { i: '4', j: 1 }, { i: '4', j: 2 } ], css_id: 'tinytable_css_3igxti3frd3zh5k9bcxs',}, 
          { positions: [ { i: '0', j: 1 }, { i: '0', j: 2 } ], css_id: 'tinytable_css_1j12e52jzenbqdbvkpkq',}, 
          ];

          // Loop over the arrays to style the cells
          cellsToStyle.forEach(function (group) {
              group.positions.forEach(function (cell) {
                  tableFns_ska4aa6i0trrc9uqv55q.styleCell(cell.i, cell.j, group.css_id);
              });
          });
      });
    </script>

    <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/vincentarelbundock/tinytable@main/inst/tinytable.css">
    <style>
    /* tinytable css entries after */
    #tinytable_ska4aa6i0trrc9uqv55q td.tinytable_css_3igxti3frd3zh5k9bcxs, #tinytable_ska4aa6i0trrc9uqv55q th.tinytable_css_3igxti3frd3zh5k9bcxs {  position: relative; --border-bottom: 1; --border-left: 0; --border-right: 0; --border-top: 0; --line-color-bottom: var(--tt-line-color); --line-color-left: var(--tt-line-color); --line-color-right: var(--tt-line-color); --line-color-top: var(--tt-line-color); --line-width-bottom: 0.1em; --line-width-left: 0.1em; --line-width-right: 0.1em; --line-width-top: 0.1em; --trim-bottom-left: 0%; --trim-bottom-right: 0%; --trim-left-bottom: 0%; --trim-left-top: 0%; --trim-right-bottom: 0%; --trim-right-top: 0%; --trim-top-left: 0%; --trim-top-right: 0%;  }
    #tinytable_ska4aa6i0trrc9uqv55q td.tinytable_css_1j12e52jzenbqdbvkpkq, #tinytable_ska4aa6i0trrc9uqv55q th.tinytable_css_1j12e52jzenbqdbvkpkq {  position: relative; --border-bottom: 1; --border-left: 0; --border-right: 0; --border-top: 1; --line-color-bottom: var(--tt-line-color); --line-color-left: var(--tt-line-color); --line-color-right: var(--tt-line-color); --line-color-top: var(--tt-line-color); --line-width-bottom: 0.05em; --line-width-left: 0.1em; --line-width-right: 0.1em; --line-width-top: 0.1em; --trim-bottom-left: 0%; --trim-bottom-right: 0%; --trim-left-bottom: 0%; --trim-left-top: 0%; --trim-right-bottom: 0%; --trim-right-top: 0%; --trim-top-left: 0%; --trim-top-right: 0%;  }
    </style>
    <div class="container">
      <table class="tinytable" id="tinytable_ska4aa6i0trrc9uqv55q" style="width: auto; margin-left: auto; margin-right: auto;" data-quarto-disable-processing="true">
        
        <thead>
              <tr>
                <th scope="col" data-row="0" data-col="1">id</th>
                <th scope="col" data-row="0" data-col="2">sex</th>
              </tr>
        </thead>
        
        <tbody>
                <tr>
                  <td data-row="1" data-col="1">Michael</td>
                  <td data-row="1" data-col="2">Male</td>
                </tr>
                <tr>
                  <td data-row="2" data-col="1">Emily</td>
                  <td data-row="2" data-col="2">Female</td>
                </tr>
                <tr>
                  <td data-row="3" data-col="1">John</td>
                  <td data-row="3" data-col="2">Male</td>
                </tr>
                <tr>
                  <td data-row="4" data-col="1">Jessica</td>
                  <td data-row="4" data-col="2">Female</td>
                </tr>
        </tbody>
      </table>
    </div>
<!-- hack to avoid NA insertion in last line -->
</div>
</div>
</figure>
</div>
</div>
<p>しっかり置き換えられていますね。</p>
<p><code>!!!</code>という表記は見慣れないと思いますが、<code>id_map</code>や<code>sex_map</code>で作成したベクトルをバラバラにして渡すということです<sup>3</sup>。<code>recode(sex, "1" = "Male", "2" = "Female")</code>と同じ働きをします。</p>
<p>あらかじめ対応関係を表すベクトルを作って置くことで、使いまわすことができ、特に何回も表を作る際に効率化が図れます。</p>
</section>
</section>
<section id="おまけ" class="level2">
<h2 class="anchored" data-anchor-id="おまけ">おまけ</h2>
<p>表にするなら、列名も変えたいですよね。そんなときは{purrr}パッケージの<code>set_names()</code>関数を使います。これも{tidyverse}に入っていますので、特に追加でライブラリを読み込む必要はありません。</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb5" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1">col_names <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"名前"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"性別"</span>)</span>
<span id="cb5-2"></span>
<span id="cb5-3">df_set_names <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> df_recode <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span></span>
<span id="cb5-4">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">set_names</span>(col_names)</span></code></pre></div></div>
</div>
<div class="cell">
<div id="tbl-set-names" class="cell quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-tbl figure">
<figcaption class="quarto-float-caption-top quarto-float-caption quarto-float-tbl" id="tbl-set-names-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
表&nbsp;3: 列名を変更
</figcaption>
<div aria-describedby="tbl-set-names-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<div class="cell-output-display">
<!-- preamble start -->

    <script src="https://cdn.jsdelivr.net/gh/vincentarelbundock/tinytable@main/inst/tinytable.js"></script>

    <script>
      // Create table-specific functions using external factory
      const tableFns_h39c4bsxzan08lcak40u = TinyTable.createTableFunctions("tinytable_h39c4bsxzan08lcak40u");
      // tinytable span after
      window.addEventListener('load', function () {
          var cellsToStyle = [
            // tinytable style arrays after
          { positions: [ { i: '4', j: 1 }, { i: '4', j: 2 } ], css_id: 'tinytable_css_av4jqg090tobxjtr7nwp',}, 
          { positions: [ { i: '0', j: 1 }, { i: '0', j: 2 } ], css_id: 'tinytable_css_rxjo9mmzpbqoyxxamao7',}, 
          ];

          // Loop over the arrays to style the cells
          cellsToStyle.forEach(function (group) {
              group.positions.forEach(function (cell) {
                  tableFns_h39c4bsxzan08lcak40u.styleCell(cell.i, cell.j, group.css_id);
              });
          });
      });
    </script>

    <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/vincentarelbundock/tinytable@main/inst/tinytable.css">
    <style>
    /* tinytable css entries after */
    #tinytable_h39c4bsxzan08lcak40u td.tinytable_css_av4jqg090tobxjtr7nwp, #tinytable_h39c4bsxzan08lcak40u th.tinytable_css_av4jqg090tobxjtr7nwp {  position: relative; --border-bottom: 1; --border-left: 0; --border-right: 0; --border-top: 0; --line-color-bottom: var(--tt-line-color); --line-color-left: var(--tt-line-color); --line-color-right: var(--tt-line-color); --line-color-top: var(--tt-line-color); --line-width-bottom: 0.1em; --line-width-left: 0.1em; --line-width-right: 0.1em; --line-width-top: 0.1em; --trim-bottom-left: 0%; --trim-bottom-right: 0%; --trim-left-bottom: 0%; --trim-left-top: 0%; --trim-right-bottom: 0%; --trim-right-top: 0%; --trim-top-left: 0%; --trim-top-right: 0%;  }
    #tinytable_h39c4bsxzan08lcak40u td.tinytable_css_rxjo9mmzpbqoyxxamao7, #tinytable_h39c4bsxzan08lcak40u th.tinytable_css_rxjo9mmzpbqoyxxamao7 {  position: relative; --border-bottom: 1; --border-left: 0; --border-right: 0; --border-top: 1; --line-color-bottom: var(--tt-line-color); --line-color-left: var(--tt-line-color); --line-color-right: var(--tt-line-color); --line-color-top: var(--tt-line-color); --line-width-bottom: 0.05em; --line-width-left: 0.1em; --line-width-right: 0.1em; --line-width-top: 0.1em; --trim-bottom-left: 0%; --trim-bottom-right: 0%; --trim-left-bottom: 0%; --trim-left-top: 0%; --trim-right-bottom: 0%; --trim-right-top: 0%; --trim-top-left: 0%; --trim-top-right: 0%;  }
    </style>
    <div class="container">
      <table class="tinytable" id="tinytable_h39c4bsxzan08lcak40u" style="width: auto; margin-left: auto; margin-right: auto;" data-quarto-disable-processing="true">
        
        <thead>
              <tr>
                <th scope="col" data-row="0" data-col="1">名前</th>
                <th scope="col" data-row="0" data-col="2">性別</th>
              </tr>
        </thead>
        
        <tbody>
                <tr>
                  <td data-row="1" data-col="1">Michael</td>
                  <td data-row="1" data-col="2">Male</td>
                </tr>
                <tr>
                  <td data-row="2" data-col="1">Emily</td>
                  <td data-row="2" data-col="2">Female</td>
                </tr>
                <tr>
                  <td data-row="3" data-col="1">John</td>
                  <td data-row="3" data-col="2">Male</td>
                </tr>
                <tr>
                  <td data-row="4" data-col="1">Jessica</td>
                  <td data-row="4" data-col="2">Female</td>
                </tr>
        </tbody>
      </table>
    </div>
<!-- hack to avoid NA insertion in last line -->
</div>
</div>
</figure>
</div>
</div>
<p>あらかじめ<code>col_names</code>を作成しておきましたが、ここは任意です。<code>set_names()</code>の中に直接書くのも可能です。</p>
</section>
<section id="おわりに" class="level2">
<h2 class="anchored" data-anchor-id="おわりに">おわりに</h2>
<p>今回は表を整えるための<code>recode()</code>関数とおまけの<code>set_names()</code>関数をまとめました。</p>
<p>以前<a href="../../../../../pages/tips/2024/06/240629_write_thesis/index.html">Quartoで論文を書くという記事</a>を書きましたが、論文はLaTeXで書きたい！という方には表だけLaTeXコードにして出力するという方法もありますので、それもまたまとめようかと思います。</p>


<!-- -->

</section>


<div id="quarto-appendix" class="default"><section id="footnotes" class="footnotes footnotes-end-of-document"><h2 class="anchored quarto-appendix-heading">注</h2>

<ol>
<li id="fn1"><p>まだ関数は残っているので、使うことはできます。↩︎</p></li>
<li id="fn2"><p>ただし、<code>case_when()</code>だと「○○以上○○以下」みたいな条件分岐に対応できるという強みがありますが、今回は想定しません。あくまでもデータフレーム内の値をある別の表記に値 = 値で置き換えるということを想定します。↩︎</p></li>
<li id="fn3"><p>ややこしいですが、<code>id_map</code>自体はベクトルなので、ベクトルを渡すのではなく、中身を展開して渡したいということです。↩︎</p></li>
</ol>
</section></div> ]]></description>
  <category>R</category>
  <category>データ処理</category>
  <guid>https://yo5uke.com/pages/tips/2025/07/250727_recode/</guid>
  <pubDate>Sat, 26 Jul 2025 15:00:00 GMT</pubDate>
</item>
<item>
  <title>RStudio Serverをインストールする【リモートデスクトップも】</title>
  <link>https://yo5uke.com/pages/tips/2025/07/250715_rstudio_server/</link>
  <description><![CDATA[ 

<div class="social-share-buttons">
  <!-- Twitter (X) -->
  <a href="" id="js-share-twitter" class="share_button ri--twitter-x-fill" target="_blank" rel="nofollow noopener noreferrer"></a>

  <!-- Bluesky -->
  <a href="" id="js-share-bluesky" class="share_button ri--bluesky-fill" target="_blank" rel="nofollow noopener noreferrer"></a>
</div>

<script>
  const twitterUsername = "@5uke_y";
  const blueskyUsername = "@5uke.bsky.social";

  const share_url = encodeURIComponent(location.href);
  const share_title = document.title;

  // Twitter (X)
  document.getElementById('js-share-twitter').setAttribute(
    "href",
    "https://twitter.com/share?url=" + share_url + "&text=" + share_title + " " + encodeURIComponent(twitterUsername) + " より" +
    "&hashtags=rstats"
  );

  // Bluesky
  document.getElementById('js-share-bluesky').setAttribute(
    "href",
    "https://bsky.app/intent/compose?text=" + share_title + " " + share_url + " " + encodeURIComponent(blueskyUsername) + " より"
  );
</script>





<section id="はじめに" class="level2">
<h2 class="anchored" data-anchor-id="はじめに">はじめに</h2>
<p>RStudio Serverのインストール方法や使い方についてまとめます。</p>
<p>RStudio Serverを使えば各OSの違いに左右されず、どの端末からでも同じ環境で作業を継続できるのが特徴です。複数人での分析や大規模データ処理にも適しており、環境構築の一元化と省力化が図れます。</p>
<p>僕は最近仕事でRStudio Serverを使うかも…みたいな流れがあったので、改めてまとめてみることにしました。</p>
</section>
<section id="環境" class="level2">
<h2 class="anchored" data-anchor-id="環境">環境</h2>
<ul>
<li><p>Windows 11</p></li>
<li><p>PowerShell 7がインストール済み</p></li>
</ul>
<p>PowerShellは<a href="https://learn.microsoft.com/ja-jp/powershell/scripting/whats-new/migrating-from-windows-powershell-51-to-powershell-7?view=powershell-7.5">こちら</a>からインストールできますが、よくわからない場合は標準インストールされている「ターミナル」でも大丈夫です。</p>
</section>
<section id="インストール" class="level2">
<h2 class="anchored" data-anchor-id="インストール">インストール</h2>
<section id="wsl" class="level3">
<h3 class="anchored" data-anchor-id="wsl">WSL</h3>
<p>まずはWSLからインストールします。WSLはWindows Subsystem for Linuxの略であり、Windows上でネイティブにLinux環境を動作させる機能で、開発やデータ分析をLinux向けツールで行える柔軟な作業環境を提供してくれます。</p>
<p>まずはPowerShellを管理者権限で開きます。</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://yo5uke.com/pages/tips/2025/07/250715_rstudio_server/image/powershell.png" class="img-fluid figure-img" style="width:60.0%"></p>
<figcaption>管理者権限で開きます</figcaption>
</figure>
</div>
<p>次に以下のコマンドを入力し、実行します。</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb1" style="background: #f1f3f5;"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb1-1"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">wsl</span> <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">--install</span></span></code></pre></div></div>
<p>インストールが終わると、Linuxディストリビューションのユーザー名とパスワードの作成を求められます<sup>1</sup>。</p>
<p>ユーザー名は何でも大丈夫です。パスワードもめちゃくちゃ簡単で問題ありません。パスワードは<strong>画面上には表示されませんが、ちゃんと入力されています</strong>。慌てて何回も入力しないようにしてください。</p>
<p>また、ユーザー名とパスワードは後ほど使うので忘れないようにしてください。</p>
</section>
<section id="rとrstudio-server" class="level3">
<h3 class="anchored" data-anchor-id="rとrstudio-server">RとRStudio Server</h3>
<p>設定まで終わったら、アプリの一覧から <i class="fa-brands fa-ubuntu" aria-label="ubuntu"></i> Ubuntu（これがLinuxのディストリビューションです）を開いてください。</p>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
<span class="screen-reader-only">Note</span>Ubuntuのバージョンについて
</div>
</div>
<div class="callout-body-container callout-body">
<p>本ページではUbuntu 24を前提に進めています。もしインストールしたバージョンが他のバージョンであった場合は若干コードが変わる可能性がありますので、<a href="https://posit.co/download/rstudio-server/">このページ</a>でバージョンを該当するものに変更したうえで都度コードをコピーし、実行してみてください。</p>
<p>バージョンを確認するためには以下をUbuntu上で実行してください。</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb2" style="background: #f1f3f5;"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb2-1"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">lsb_release</span> <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">-a</span></span></code></pre></div></div>
</div>
</div>
<p>するとコンソール画面が出てきますので、以下のコードを順々に入力、実行していきます。</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb3" style="background: #f1f3f5;"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb3-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sudo</span> apt update</span>
<span id="cb3-2"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sudo</span> apt upgrade <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">-y</span></span></code></pre></div></div>
<p>続いてRをインストールします。<a href="https://cran.rstudio.com/bin/linux/ubuntu/">こちら</a>のページからの転用です。</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb4" style="background: #f1f3f5;"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb4-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># update indices</span></span>
<span id="cb4-2"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sudo</span> apt update <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">-qq</span></span>
<span id="cb4-3"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># install two helper packages we need</span></span>
<span id="cb4-4"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sudo</span> apt install <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">--no-install-recommends</span> software-properties-common dirmngr</span>
<span id="cb4-5"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># add the signing key (by Michael Rutter) for these repos</span></span>
<span id="cb4-6"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># To verify key, run gpg --show-keys /etc/apt/trusted.gpg.d/cran_ubuntu_key.asc </span></span>
<span id="cb4-7"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Fingerprint: E298A3A825C0D65DFD57CBB651716619E084DAB9</span></span>
<span id="cb4-8"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">wget</span> <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">-qO-</span> https://cloud.r-project.org/bin/linux/ubuntu/marutter_pubkey.asc <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">|</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sudo</span> tee <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">-a</span> /etc/apt/trusted.gpg.d/cran_ubuntu_key.asc</span>
<span id="cb4-9"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># add the repo from CRAN -- lsb_release adjusts to 'noble' or 'jammy' or ... as needed</span></span>
<span id="cb4-10"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sudo</span> add-apt-repository <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"deb https://cloud.r-project.org/bin/linux/ubuntu </span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">$(</span><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">lsb_release</span> <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">-cs</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">)</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">-cran40/"</span></span>
<span id="cb4-11"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># install R itself</span></span>
<span id="cb4-12"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sudo</span> apt install <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">--no-install-recommends</span> r-base</span></code></pre></div></div>
<p>次にRStudio Serverをインストールします。<a href="https://posit.co/download/rstudio-server/">Posit社のガイド</a>からの転用です。</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb5" style="background: #f1f3f5;"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb5-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sudo</span> apt-get install gdebi-core</span>
<span id="cb5-2"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">wget</span> https://download2.rstudio.org/server/jammy/amd64/rstudio-server-2025.09.2-418-amd64.deb</span>
<span id="cb5-3"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sudo</span> gdebi rstudio-server-2025.09.2-418-amd64.deb</span></code></pre></div></div>
<p>これでインストールは完了です。続いて次のコマンドを実行し、RStudio Serverを立ち上げます。</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb6" style="background: #f1f3f5;"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb6-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sudo</span> rstudio-server start</span></code></pre></div></div>
</section>
</section>
<section id="rstudio-serverを立ち上げる" class="level2">
<h2 class="anchored" data-anchor-id="rstudio-serverを立ち上げる">RStudio Serverを立ち上げる</h2>
<p>それではRStudio Serverを立ち上げていきましょう。上のコマンドで起動までできているので、ブラウザ上で立ち上げていきます。</p>
<p>PC上の任意のブラウザを開き、アドレスバーに<code>localhost:8787</code>と入力し、開きます。</p>
<p>すると以下のような画面が出てきます。</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://yo5uke.com/pages/tips/2025/07/250715_rstudio_server/image/rstudio_server_login.png" class="img-fluid quarto-figure quarto-figure-center figure-img"></p>
</figure>
</div>
<p>ユーザー名とパスワードを求められますので、先ほどUbuntuで設定したものを入力してください。</p>
<p>そうしてサインインすることで、RStudioの画面に入ることができます。</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://yo5uke.com/pages/tips/2025/07/250715_rstudio_server/image/rstudio_server.png" class="img-fluid quarto-figure quarto-figure-center figure-img"></p>
</figure>
</div>
<p>ここからは通常のRと同様に作業を進めることができます。</p>
</section>
<section id="ファイルの扱いについて" class="level2">
<h2 class="anchored" data-anchor-id="ファイルの扱いについて">ファイルの扱いについて</h2>
<p>どのようにしてデータを入れたりファイルを追加したりすればよいかについて説明します。</p>
<p>RStudio上でできることはデスクトップ版とほとんど同じで、さらにエクスプローラー上の動作も通常と同じようにすることができます。</p>
<p>エクスプローラーを開いて左のサイドバーを一番下までスクロールすると、Linuxが作成されていることがわかります。</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://yo5uke.com/pages/tips/2025/07/250715_rstudio_server/image/explorer_linux.png" class="img-fluid figure-img"></p>
<figcaption>サイドバーの一番下です</figcaption>
</figure>
</div>
<p>するとUbuntuが中に作成されていますので、ダブルクリックで入っていきます。<code>home/[設定したユーザー名]</code>があると思うので、その中に入ると、そこがWindowsでいうところの<code>C:\Users\ユーザー\</code>に該当します。ベースとなるディレクトリです。</p>
<p>この中にプロジェクトのフォルダを作成していけば、RStudio Server上でも見ることができますし、入れたファイルを操作することが可能になります。</p>
<p>まあまあ面倒なところにあるので、クイックアクセスにピン留めしたりデスクトップにショートカットを作ったりして置くのが便利だと思います。</p>
<p>ここまでの操作で個人の作業はできるようになりました！続いては、ホストとなるPCで環境を作成し、それを別のデバイスからアクセスできるようにする方法についてまとめていきます！</p>
</section>
<section id="リモートデスクトップを活用する" class="level2">
<h2 class="anchored" data-anchor-id="リモートデスクトップを活用する">リモートデスクトップを活用する</h2>
<p>例えば扱うデータが大きすぎて個々のノートパソコンでは扱いきれず、1台高スペックのデスクトップを用意してそこにアクセスして作業をしたい、というようなケースを考えます。</p>
<p>ここで個々のPCからデスクトップにアクセスして作業をするのですが、この作業はあくまでもデスクトップ上で行われるので、各PCがハイスペックである必要はありません。デスクトップの画面を自分のPCに投影しているようなイメージです。</p>
<section id="環境-1" class="level3">
<h3 class="anchored" data-anchor-id="環境-1">環境</h3>
<ul>
<li><p>無線LAN（Wi-Fi）を使用</p></li>
<li><p>ホストと各PCは同じネットワーク（Wi-Fi）を使用</p></li>
</ul>
</section>
<section id="デスクトップの環境構築" class="level3">
<h3 class="anchored" data-anchor-id="デスクトップの環境構築">デスクトップの環境構築</h3>
<p>まずすべきことは、上で書いたような環境構築を、デスクトップPC（ホスト）で実行することです。RStudio Serverを使えるようにしておいてください。</p>
<section id="ipアドレスを確認" class="level4">
<h4 class="anchored" data-anchor-id="ipアドレスを確認">IPアドレスを確認</h4>
<p><strong>【ホストのPC】</strong></p>
<p>他のPC（クライアント）からアクセスできるようにするには、まずホストのIPアドレスを確認しておく必要があります。PowerShellを開いたら、以下のコマンドを実行します。</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb7" style="background: #f1f3f5;"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb7-1"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">ipconfig</span></span></code></pre></div></div>
<p>実行すると、なにやら長々と表示されるはずです。「Windows IP 構成」の下に例えば「イーサネット アダプター vEthernet (Default Switch):」や、「イーサネット アダプター vEthernet (WSL (Hyper-V firewall)):」などいろいろ出てきます。</p>
<p>その中の下の方に「Wireless LAN adapter Wi-Fi:」があります。この中に「IPv4 アドレス」があり、その右に数字が書かれています（例：192.xxx.x.xx）。これを後ほど使うので、押さえておいてください。</p>
<p>また、もう一度PowerShellは使うので、画面も開いておいてください。</p>
<p><strong>【ホストPCのWSL】</strong></p>
<p>次にWindowsのアプリ一覧からUbuntu <i class="fa-brands fa-ubuntu" aria-label="ubuntu"></i> を開きます。</p>
<p>開けたら次のコマンドを実行してください。</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb8" style="background: #f1f3f5;"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb8-1"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">ip</span> addr</span></code></pre></div></div>
<p>これも同様に2種類出てくると思いますが、下にある<strong>eth0</strong>が必要な方です。「inet 172.xxx.xx.xx」のような形で表示されていると思いますので、これを押さえておきます。スラッシュの前までで大丈夫です。</p>
</section>
<section id="ポートの設定" class="level4">
<h4 class="anchored" data-anchor-id="ポートの設定">ポートの設定</h4>
<p>今押さえた<strong>WSLの方</strong>のIPアドレスを使用します（後で確認した方です）。</p>
<p>PowerShellに戻って次のコマンドを実行します。</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb9" style="background: #f1f3f5;"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb9-1"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">netsh</span> interface portproxy add v4tov4 listenport=8787 listenaddress=0.0.0.0 connectport=8787 connectaddress=<span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">[</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">WSLのIPアドレス</span><span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">]</span></span></code></pre></div></div>
<p>最後の部分を四角括弧ごとWSLのIPアドレスに置き換えて下さい。</p>
</section>
<section id="ホストpcでファイアウォールの設定" class="level4">
<h4 class="anchored" data-anchor-id="ホストpcでファイアウォールの設定"><strong>ホストPCでファイアウォールの設定</strong></h4>
<p>次に引き続きホストのPC上で、ファイアウォールの設定を行います。</p>
<p>設定を開き、検索窓から「ファイアウォール」と検索し、「Windows Defender ファイアウォール」をクリックして開きます。</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://yo5uke.com/pages/tips/2025/07/250715_rstudio_server/image/defender_setting.png" class="img-fluid figure-img" style="width:41.0%"></p>
<figcaption>下から2番目のです</figcaption>
</figure>
</div>
<p>開いたウィンドウの左側に「詳細設定」という項目があるのでクリックして進みます。</p>
<p>「受信の規則」→右側から「新しい規則」→「ポート」を選択して次へ進み、TCP、特定のローカルポートに「8787」を入力して次へ進み、「接続を許可する」でさらに次へ進み、すべてのチェックボックスにチェックが入った状態で次へ進みます。</p>
<p>名前を付ける必要がありますが、何でもよいと思います。RStudio Serverを使っていることがわかる名前が良いと思います。入力したら完了で終わりです。</p>
<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
<span class="screen-reader-only">Tip</span>コマンドで一発
</div>
</div>
<div class="callout-body-container callout-body">
<p>以下のコマンドをPowerShellで入力すれば同じことができます。こっちの方が楽かもですね。</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb10" style="background: #f1f3f5;"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb10-1"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">New-NetFirewallRule</span> <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">-DisplayName</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"RStudio Server"</span> <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">-Direction</span> Inbound <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">-LocalPort</span> 8787 <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">-Protocol</span> TCP <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">-Action</span> Allow</span></code></pre></div></div>
</div>
</div>
</section>
<section id="wsl側でrstudio-serverの動作を確認" class="level4">
<h4 class="anchored" data-anchor-id="wsl側でrstudio-serverの動作を確認">WSL側でRStudio Serverの動作を確認</h4>
<p>Ubuntuを再度開き、以下のコマンドを実行してRStudio Serverが起動しているかどうかを再確認します。</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb11" style="background: #f1f3f5;"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb11-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sudo</span> rstudio-server status</span></code></pre></div></div>
<p><code>sudo</code>で始まるコマンドはパスワードを求められますので適宜入力して進んでください。</p>
<p>ここで<code>active (running)</code>が記載されていればOKです。もし<code>inactive (dead)</code>となっていたら、以下のコマンドから起動してください。</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb12" style="background: #f1f3f5;"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb12-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sudo</span> rstudio-server start</span></code></pre></div></div>
</section>
<section id="ブラウザでアクセスを確認する" class="level4">
<h4 class="anchored" data-anchor-id="ブラウザでアクセスを確認する">ブラウザでアクセスを確認する</h4>
<p>それでは<strong>ホスト上で</strong>動作確認をしてみましょう。</p>
<p>ブラウザを立ち上げ<code>localhost:8787</code>を入力し開きます。先ほどと同様のサインイン画面が出てくれば問題ありません。</p>
</section>
<section id="別端末クライアントからのアクセス確認" class="level4">
<h4 class="anchored" data-anchor-id="別端末クライアントからのアクセス確認">別端末（クライアント）からのアクセス確認</h4>
<p>クライアントからは先ほど確認したローカルのIPアドレスを<code>localhost</code>の代わりに使用します。例えば<code>192.xxx.x.xx:8787</code>といった具合です。</p>
<p>これが開けてサインイン画面に移行できれば成功です。自分のPCのスペックに依存せず、ホストのPCにアクセスしてRStudioから作業を行うことができます。</p>
<p>繰り返しになりますが、<strong>実行しているのはホストのデスクトップ</strong>です。ブラウザであれば何でもよいので、同じネットワークに接続しているのであればスマホのブラウザからアクセスすることもできます。</p>
</section>
</section>
</section>
<section id="おまけquartoのインストール" class="level2">
<h2 class="anchored" data-anchor-id="おまけquartoのインストール">おまけ：Quartoのインストール</h2>
<p>以上の手順を実装していればQuartoは自動でインストールされていますが、最新バージョンを使いたい場合などは手動でインストールする必要があります。以下のコマンドをUbuntu上で実行してください。</p>
<p>2025/12/25時点の最新バージョン<sup>2</sup>で例示していますが、<a href="https://quarto.org/docs/get-started/">Quartoのダウンロードページ</a>で最新バージョンを確認のうえ、<code>QUARTO_VER</code>を適宜書き換えて実行してください。</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb13" style="background: #f1f3f5;"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb13-1"><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">QUARTO_VER</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>1.8.26</span>
<span id="cb13-2"><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">DEB</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>quarto-<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">${QUARTO_VER}</span>-linux-amd64.deb</span>
<span id="cb13-3"><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">BASE</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>https://github.com/quarto-dev/quarto-cli/releases/download/v<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">${QUARTO_VER}</span></span>
<span id="cb13-4"></span>
<span id="cb13-5"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">wget</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">${BASE}</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">/</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">${DEB}</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span></span>
<span id="cb13-6"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sudo</span> dpkg <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">-i</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">${DEB}</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span></span>
<span id="cb13-7"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rm</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">${DEB}</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span></span></code></pre></div></div>
<p>以上でインストールからインストーラーの削除まで完了です。<code>quarto --version</code>でバージョンを確認してみてください。</p>
<p>もし依存関係のエラーが出た場合には、以下のコマンドを実行してから再度<code>dpkg -i</code>のコマンドを実行してみてください。</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb14" style="background: #f1f3f5;"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb14-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sudo</span> apt install <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">-f</span></span></code></pre></div></div>
</section>
<section id="終わり" class="level2">
<h2 class="anchored" data-anchor-id="終わり">終わり！</h2>
<p>特にリモートデスクトップの説明で長くなってしまいましたが、これでRStudio Serverを使えるようになるはずです。</p>
<p>用途に合わせて、いろいろ試してみてください！</p>


<!-- -->

</section>


<div id="quarto-appendix" class="default"><section id="footnotes" class="footnotes footnotes-end-of-document"><h2 class="anchored quarto-appendix-heading">注</h2>

<ol>
<li id="fn1"><p>求められない場合は、続けて<code>wsl</code>とだけ入力して実行してください。↩︎</p></li>
<li id="fn2"><p>1.8.26↩︎</p></li>
</ol>
</section></div> ]]></description>
  <category>R</category>
  <category>RStudio</category>
  <category>Windows</category>
  <category>WSL</category>
  <guid>https://yo5uke.com/pages/tips/2025/07/250715_rstudio_server/</guid>
  <pubDate>Mon, 14 Jul 2025 15:00:00 GMT</pubDate>
  <media:content url="https://yo5uke.com/pages/tips/2025/07/250715_rstudio_server/image/rstudio_server.png" medium="image" type="image/png" height="74" width="144"/>
</item>
<item>
  <title>【スクレイピング】Rでe-Statのメッシュ人口データファイルを一気に取得する</title>
  <link>https://yo5uke.com/pages/tips/2025/06/250613_scraping_pop_by_mesh/</link>
  <description><![CDATA[ 

<div class="social-share-buttons">
  <!-- Twitter (X) -->
  <a href="" id="js-share-twitter" class="share_button ri--twitter-x-fill" target="_blank" rel="nofollow noopener noreferrer"></a>

  <!-- Bluesky -->
  <a href="" id="js-share-bluesky" class="share_button ri--bluesky-fill" target="_blank" rel="nofollow noopener noreferrer"></a>
</div>

<script>
  const twitterUsername = "@5uke_y";
  const blueskyUsername = "@5uke.bsky.social";

  const share_url = encodeURIComponent(location.href);
  const share_title = document.title;

  // Twitter (X)
  document.getElementById('js-share-twitter').setAttribute(
    "href",
    "https://twitter.com/share?url=" + share_url + "&text=" + share_title + " " + encodeURIComponent(twitterUsername) + " より" +
    "&hashtags=rstats"
  );

  // Bluesky
  document.getElementById('js-share-bluesky').setAttribute(
    "href",
    "https://bsky.app/intent/compose?text=" + share_title + " " + share_url + " " + encodeURIComponent(blueskyUsername) + " より"
  );
</script>





<section id="はじめに" class="level2">
<h2 class="anchored" data-anchor-id="はじめに">はじめに</h2>
<p><a href="../../../../../pages/tips/2025/03/250319_scraping/index.html">以前の記事</a>でe-Statから境界データ（シェープファイル）をスクレイピングで取得する方法をご紹介しました。</p>
<p>今回は国勢調査をもとに公開しているメッシュごとの人口データを取得するコードの覚書です。時々実行することがあるので<del>自分は忘れっぽいですし</del>残しておくことにしました。</p>
<p>詳細は前回とほぼ同じで、URL等が若干異なるくらいです。コードについては以下で詳しめに書いたので、不明点があればご覧下さい。</p>
<div class="callout callout-style-simple callout-tip no-icon">
<div class="callout-body d-flex">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-body-container">
<p><a href="../../../../../pages/tips/2025/03/250319_scraping/index.html">【スクレイピング】rvestを使ってe-Statからファイルを取得する</a></p>
</div>
</div>
</div>
</section>
<section id="コード" class="level2">
<h2 class="anchored" data-anchor-id="コード">コード</h2>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb1" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(rvest)</span>
<span id="cb1-2"></span>
<span id="cb1-3"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># データを保存したいフォルダを指定</span></span>
<span id="cb1-4">save_dir <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> here<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">here</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"data/pop_by_mesh"</span>)</span>
<span id="cb1-5"></span>
<span id="cb1-6"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 保存したいフォルダがない場合に作成</span></span>
<span id="cb1-7"><span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> (<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">!</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">dir.exists</span>(save_dir)) {</span>
<span id="cb1-8">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">dir.create</span>(save_dir)</span>
<span id="cb1-9">}</span>
<span id="cb1-10"></span>
<span id="cb1-11">base_url <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"https://www.e-stat.go.jp"</span></span>
<span id="cb1-12"></span>
<span id="cb1-13"><span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> (i <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">8</span>) {</span>
<span id="cb1-14">  url <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">paste0</span>(</span>
<span id="cb1-15">    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"https://www.e-stat.go.jp/gis/statmap-search?page="</span>,</span>
<span id="cb1-16">    i,</span>
<span id="cb1-17">    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"&amp;type=1&amp;toukeiCode=00200521&amp;toukeiYear=2020&amp;aggregateUnit=H"</span>,</span>
<span id="cb1-18">    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"&amp;serveyId=H002005112020&amp;statsId=T001141&amp;datum=2011"</span></span>
<span id="cb1-19">  )</span>
<span id="cb1-20"></span>
<span id="cb1-21">  html <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">read_html_live</span>(url)</span>
<span id="cb1-22">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">Sys.sleep</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)</span>
<span id="cb1-23"></span>
<span id="cb1-24">  links <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> html <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span></span>
<span id="cb1-25">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">html_elements</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"a"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span></span>
<span id="cb1-26">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">html_attr</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"href"</span>)</span>
<span id="cb1-27"></span>
<span id="cb1-28">  csv_links <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> links[<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">grepl</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"data</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">\\</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">?statsId=T001141"</span>, links)]</span>
<span id="cb1-29">  full_urls <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">paste0</span>(base_url, csv_links)</span>
<span id="cb1-30"></span>
<span id="cb1-31">  <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> (j <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">seq_along</span>(full_urls)) {</span>
<span id="cb1-32">    code <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sub</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">".*code=([0-9]+).*"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">\\</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">1"</span>, csv_links[j])</span>
<span id="cb1-33">    zip_path <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">file.path</span>(save_dir, <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">paste0</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"pop_mesh"</span>, code, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">".zip"</span>))</span>
<span id="cb1-34">    txt_path <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">file.path</span>(save_dir, <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">paste0</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"pop_mesh"</span>, code, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">".txt"</span>))</span>
<span id="cb1-35">    </span>
<span id="cb1-36">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 既にファイルがある場合は次のループへ</span></span>
<span id="cb1-37">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> (<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">file.exists</span>(txt_path)) <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">next</span></span>
<span id="cb1-38"></span>
<span id="cb1-39">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">tryCatch</span>({</span>
<span id="cb1-40">      <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">download.file</span>(full_urls[j], <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">destfile =</span> zip_path, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">mode =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"wb"</span>)</span>
<span id="cb1-41">      <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">Sys.sleep</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)</span>
<span id="cb1-42"></span>
<span id="cb1-43">      unzip_files <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">unzip</span>(zip_path, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">list =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">TRUE</span>)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>Name</span>
<span id="cb1-44">      <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">unzip</span>(zip_path, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">exdir =</span> save_dir)</span>
<span id="cb1-45"></span>
<span id="cb1-46">      <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> (original_name <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> unzip_files) {</span>
<span id="cb1-47">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> (<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">grepl</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">\\</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">.txt$"</span>, original_name, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">ignore.case =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">TRUE</span>)) {</span>
<span id="cb1-48">          old_path <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">file.path</span>(save_dir, original_name)</span>
<span id="cb1-49">          new_path <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> txt_path</span>
<span id="cb1-50">          <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">file.rename</span>(old_path, new_path)</span>
<span id="cb1-51">        }</span>
<span id="cb1-52">      }</span>
<span id="cb1-53"></span>
<span id="cb1-54">      <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">file.remove</span>(zip_path)</span>
<span id="cb1-55"></span>
<span id="cb1-56">    }, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">error =</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">function</span>(e) {</span>
<span id="cb1-57">      <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">warning</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">paste</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"エラー："</span>, full_urls[j]))</span>
<span id="cb1-58">    })</span>
<span id="cb1-59"></span>
<span id="cb1-60">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">Sys.sleep</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>)</span>
<span id="cb1-61">  }</span>
<span id="cb1-62">}</span></code></pre></div></div>
<p>最初の</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb2" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1">save_dir <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> here<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">here</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"data/pop_by_mesh"</span>)</span></code></pre></div></div>
<p>の部分だけ自分のディレクトリのパスに変えれば、あとはそっくりそのまま実行できると思います。次の<code>if</code>でもしディレクトリがない場合でも作成するようにしている<sup>1</sup>ので、エクスプローラー上でフォルダを作らなくても使うことができます。</p>
<p>ダウンロードにはまあまあ時間がかかりますが、手作業よりは圧倒的に速いので、機会があれば使ってみてください。</p>


<!-- -->

</section>


<div id="quarto-appendix" class="default"><section id="footnotes" class="footnotes footnotes-end-of-document"><h2 class="anchored quarto-appendix-heading">注</h2>

<ol>
<li id="fn1"><p>ある場合はスキップするので、わざわざ消さなくても問題ありません。↩︎</p></li>
</ol>
</section></div> ]]></description>
  <category>R</category>
  <category>データ処理</category>
  <category>備忘録</category>
  <guid>https://yo5uke.com/pages/tips/2025/06/250613_scraping_pop_by_mesh/</guid>
  <pubDate>Thu, 12 Jun 2025 15:00:00 GMT</pubDate>
</item>
<item>
  <title>【データ管理】DVCの設定まとめ</title>
  <link>https://yo5uke.com/pages/tips/2025/06/250601_dvc/</link>
  <description><![CDATA[ 

<div class="social-share-buttons">
  <!-- Twitter (X) -->
  <a href="" id="js-share-twitter" class="share_button ri--twitter-x-fill" target="_blank" rel="nofollow noopener noreferrer"></a>

  <!-- Bluesky -->
  <a href="" id="js-share-bluesky" class="share_button ri--bluesky-fill" target="_blank" rel="nofollow noopener noreferrer"></a>
</div>

<script>
  const twitterUsername = "@5uke_y";
  const blueskyUsername = "@5uke.bsky.social";

  const share_url = encodeURIComponent(location.href);
  const share_title = document.title;

  // Twitter (X)
  document.getElementById('js-share-twitter').setAttribute(
    "href",
    "https://twitter.com/share?url=" + share_url + "&text=" + share_title + " " + encodeURIComponent(twitterUsername) + " より" +
    "&hashtags=rstats"
  );

  // Bluesky
  document.getElementById('js-share-bluesky').setAttribute(
    "href",
    "https://bsky.app/intent/compose?text=" + share_title + " " + share_url + " " + encodeURIComponent(blueskyUsername) + " より"
  );
</script>





<section id="はじめに" class="level2">
<h2 class="anchored" data-anchor-id="はじめに">はじめに</h2>
<p><a href="../../../../../pages/tips/2024/12/241219_container/index.html">環境構築の記事</a>でDVCを使用したデータ管理についてもまとめていますが、Google Cloud Projectを使用するため若干ややこしいことに加え、定期的にトークンが切れて認証し直さないといけないという大きいデメリットがありました。</p>
<p>今回は初回の設定のみで設定がすむ方法について解説します。</p>
<p><a href="../../../../../pages/tips/2024/12/241219_container/index.html">記事</a>と同様の流れでの作業を想定しているので、その点ご留意ください。</p>
</section>
<section id="google-cloud-console" class="level2">
<h2 class="anchored" data-anchor-id="google-cloud-console">Google Cloud Console</h2>
<ol type="1">
<li><a href="https://console.cloud.google.com/">Google Cloud Console</a>へアクセス</li>
<li>画面上部のボックスからプロジェクトを作成
<ul>
<li>左上にGoogle Cloudと書いてある部分の右です</li>
<li>出てくるウィンドウの右上から作れます</li>
</ul></li>
</ol>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://yo5uke.com/pages/tips/2025/06/250601_dvc/image/new_project.png" class="img-fluid quarto-figure quarto-figure-center figure-img" style="width:60.0%"></p>
</figure>
</div>
<ol start="3" type="1">
<li>画面左のメニューから「IAMと管理」を選択
<ul>
<li>左にメニューがない場合は左上の3本線から開けます</li>
</ul></li>
<li>サイドバーの真ん中上あたりから「サービスアカウント」を選択</li>
<li>画面上部の「サービスアカウントを作成」へ進む</li>
<li>任意の名前と説明を入力し、完了を押下
<ul>
<li>権限のところはスキップで構いません</li>
</ul></li>
</ol>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://yo5uke.com/pages/tips/2025/06/250601_dvc/image/create_service_account.png" class="img-fluid quarto-figure quarto-figure-center figure-img" style="width:60.0%"></p>
</figure>
</div>
<ol start="7" type="1">
<li>メールの列に書いてある、長いメールアドレスをコピーしておく
<ul>
<li>後ほどGoogle Driveのフォルダにこのアドレスを共有します</li>
</ul></li>
<li>作成したサービスアカウントの一番右にある「操作」から「鍵を管理」を選択
<ul>
<li>長ったらしいメールアドレスの右側にある点々の部分です</li>
</ul></li>
<li>「キーを追加」→「新しい鍵を作成」→「JSON」を選択、作成へ進む</li>
<li>ファイルとして保存されるので、作業ディレクトリへ保存する
<ul>
<li><code>.secrets</code>フォルダを作り、その中へ保存してください</li>
<li>ファイル名は変えて問題ありません。<code>key.json</code>とかで大丈夫です</li>
</ul></li>
</ol>
</section>
<section id="google-drive" class="level2">
<h2 class="anchored" data-anchor-id="google-drive">Google Drive</h2>
<ol type="1">
<li>Google Driveの任意の場所にプロジェクトでデータをしまうフォルダを作成する</li>
<li>フォルダの共有の設定から、先ほどコピーしたメールアドレスを貼り付け共有する</li>
</ol>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://yo5uke.com/pages/tips/2025/06/250601_dvc/image/dvc_share_mail.png" class="img-fluid figure-img" style="width:50.0%"></p>
<figcaption>メールアドレスを貼り付け、権限を「編集者」にして共有します</figcaption>
</figure>
</div>
<ol start="3" type="1">
<li>Googleドライブで作成したフォルダのIDをコピー
<ul>
<li>IDは、ドライブでフォルダを開いたときのURLで、最後のスラッシュ（~/folders/）より右側の部分です</li>
</ul></li>
</ol>
</section>
<section id="vscode" class="level2">
<h2 class="anchored" data-anchor-id="vscode">VSCode</h2>
<ol type="1">
<li>VSCodeのターミナルで次のコマンドを入力して実行 - 最後の部分（四角括弧ごと）をコピーしたIDに変更してください</li>
</ol>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb1" style="background: #f1f3f5;"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb1-1"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">dvc</span> init <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">&amp;&amp;</span> <span class="ex" style="color: null;
background-color: null;
font-style: inherit;">dvc</span> remote add <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">-d</span> myremote gdrive://[Google DriveのフォルダID]</span></code></pre></div></div>
<ol start="2" type="1">
<li>サービスアカウントを有効にする
<ul>
<li>以下のコマンドを実行してください</li>
</ul></li>
</ol>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb2" style="background: #f1f3f5;"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb2-1"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">dvc</span> remote modify myremote gdrive_use_service_account true</span></code></pre></div></div>
<ol start="3" type="1">
<li>次のコマンドを実行する
<ul>
<li>フォルダ名やファイル名を自分で変えた場合、修正してから実行してください</li>
</ul></li>
</ol>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb3" style="background: #f1f3f5;"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb3-1"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">dvc</span> remote modify myremote <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">--local</span> <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">\</span></span>
<span id="cb3-2">    gdrive_service_account_json_file_path .secrets/key.json</span></code></pre></div></div>
</section>
<section id="設定ファイルをgitignore重要" class="level2">
<h2 class="anchored" data-anchor-id="設定ファイルをgitignore重要">設定ファイルをgitignore（重要！）</h2>
<p>いま<code>.secrets</code>を作りましたが、この中身はいわば個人情報であり他人に漏らしていいものではないので、<code>.gitignore</code>ファイルにしっかり記載し、Gitのトラッキングを解除しておく必要があります。</p>
<p>以下のように<code>.gitignore</code>に追記してください。</p>
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>.gitignore</strong></pre>
</div>
<pre data-filename=".gitignore"><code>/.secrets/</code></pre>
</div>
<p>これで<code>.secrets</code>フォルダの中身がGitに追跡されません。</p>
</section>
<section id="データフォルダを作ったら適宜add-push" class="level2">
<h2 class="anchored" data-anchor-id="データフォルダを作ったら適宜add-push">データフォルダを作ったら適宜<code>add</code>, <code>push</code></h2>
<p>以上で設定は終了です。</p>
<p><a href="../../../../../pages/tips/2024/12/241219_container/index.html">環境構築の記事</a>でも説明しているように、あとは<code>data</code>などデータを入れるフォルダを作りデータを追加したら、<code>dvc add data/</code>を実行し、最後は<code>dvc push</code>でプッシュすることでデータファイルをGoogle Drive上で管理することができます。</p>
</section>
<section id="共有する場合" class="level2">
<h2 class="anchored" data-anchor-id="共有する場合">共有する場合</h2>
<p>共同研究などで他の人と作業を進める場合はこのデータフォルダも共有したいということになると思います。その場合は、<a href="../../../../../pages/tips/2024/12/241219_container/index.html">記事</a>における共有に加え、<code>.secrets</code>は別に送る必要があります（Gitで追跡していないのでクローンしても<code>.secrets</code>は現れないからです）。</p>
<p>別に共有したうえでワーキングディレクトリに<code>.secrets</code>を置いてもらえば<code>dvc pull</code>でデータを引っ張ってくることができるようになります。</p>
<p>その際、<code>.dvc/config.local</code>ファイルを以下のように編集してもらってください。</p>
<pre><code>[remote "myremote"]
    gdrive_use_service_account = true
    gdrive_service_account_json_file_path = ../.secrets/key.json</code></pre>
<p><code>../</code>は1つ上の階層のフォルダの～という意味なので、これであっています。<code>.dvc/config.local</code>もgitignoreされているので、クローン下だけでは共有されません。</p>
</section>
<section id="感想" class="level2">
<h2 class="anchored" data-anchor-id="感想">感想</h2>
<p>今のところ結構いい感じです。例えばこのウェブサイトを作るうえではあまり新しくデータを追加することがないので、追加するたびにトークンが切れて認証のし直しということが頻発していました。今回の方法では再認証がない（はず）なので、ストレスが軽減されたかなという印象です。</p>
<p>何かあればぜひコメントまでお願いします。</p>


<!-- -->

</section>

 ]]></description>
  <category>DVC</category>
  <guid>https://yo5uke.com/pages/tips/2025/06/250601_dvc/</guid>
  <pubDate>Sat, 31 May 2025 15:00:00 GMT</pubDate>
  <media:content url="https://yo5uke.com/pages/tips/2025/06/250601_dvc/image/dvc_share_mail.png" medium="image" type="image/png" height="119" width="144"/>
</item>
<item>
  <title>【パッケージ開発】fixesでイベントスタディを効率化</title>
  <link>https://yo5uke.com/pages/tips/2025/05/250525_fixes/</link>
  <description><![CDATA[ 

<div class="social-share-buttons">
  <!-- Twitter (X) -->
  <a href="" id="js-share-twitter" class="share_button ri--twitter-x-fill" target="_blank" rel="nofollow noopener noreferrer"></a>

  <!-- Bluesky -->
  <a href="" id="js-share-bluesky" class="share_button ri--bluesky-fill" target="_blank" rel="nofollow noopener noreferrer"></a>
</div>

<script>
  const twitterUsername = "@5uke_y";
  const blueskyUsername = "@5uke.bsky.social";

  const share_url = encodeURIComponent(location.href);
  const share_title = document.title;

  // Twitter (X)
  document.getElementById('js-share-twitter').setAttribute(
    "href",
    "https://twitter.com/share?url=" + share_url + "&text=" + share_title + " " + encodeURIComponent(twitterUsername) + " より" +
    "&hashtags=rstats"
  );

  // Bluesky
  document.getElementById('js-share-bluesky').setAttribute(
    "href",
    "https://bsky.app/intent/compose?text=" + share_title + " " + share_url + " " + encodeURIComponent(blueskyUsername) + " より"
  );
</script>





<section id="はじめに" class="level2">
<h2 class="anchored" data-anchor-id="はじめに">はじめに</h2>
<p>本ページでは、two-way fixed effects (TWFE)モデルのDifference-in-Differences (DiD)におけるイベントスタディを行うパッケージ、<code>fixes</code>について説明します。</p>
<p>僕が今年（2025年）の年始から地道に作成してきたパッケージで、初のパッケージ作成で試行錯誤、紆余曲折を経ながらアップデートを重ねてきました。</p>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
<span class="screen-reader-only">Note</span>ご意見待ってます
</div>
</div>
<div class="callout-body-container callout-body">
<p>実戦経験が足りないパッケージなので、挙動がおかしかったり、こういう機能にも対応してほしいということがあれば、ページ下のコメントからどしどしお寄せください。こぢんまりしたページなので、いただいたものは余裕で全部対応できると思います。</p>
</div>
</div>
<p>これまでは処置個体において処置タイミングが同一のベーシックなイベントスタディにのみ対応していましたが、アップデートを経て<strong>各個体で処置タイミングが異なる、いわゆるStaggered DiDにおけるイベントスタディにも対応しました</strong>。</p>
<p>果たしてあらゆるケースに対応できているか、個人で開発しているパッケージとしては不安ではありますが、いくつかのデータセットでテストした分には問題なかったので、そのテストコードと併せて解説していきます。</p>
</section>
<section id="使用するパッケージ" class="level2">
<h2 class="anchored" data-anchor-id="使用するパッケージ">使用するパッケージ</h2>
<p>使用するのは<code>fixes</code>です。インストールは以下のコマンドでできます。</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb1" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">install.packages</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"fixes"</span>)</span>
<span id="cb1-2"></span>
<span id="cb1-3"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># or</span></span>
<span id="cb1-4"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># pak::pak("fixes")</span></span></code></pre></div></div>
<p>です。開発版はGitHubからインストールできます。</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb2" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># install.packages("pak")</span></span>
<span id="cb2-2">pak<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">pak</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"yo5uke/fixes"</span>)</span></code></pre></div></div>
</section>
<section id="準備" class="level2">
<h2 class="anchored" data-anchor-id="準備">準備</h2>
<p>パッケージを読み込んで、デモに使うデータを準備します。</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb3" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(fixes)</span>
<span id="cb3-2"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(tidyverse)</span></code></pre></div></div>
</div>
<p>データは<code>fixest</code>パッケージで用意されている<code>base_did</code>および<code>base_stagg</code>と、Mixtapeの<a href="https://mixtape.scunning.com/09-difference_in_differences#replicating-cheng2013-sort-of">Staggered DiDの章</a>で使用されている<code>castle</code>を使います。</p>
<p><code>df_castle</code>に関しては、Mixtape内で行われている処理をし、変数を使用するものに絞っておきます<sup>1</sup>。</p>
<p>また、少し後で述べる通り、never-treatedユニットの扱いに注意しながら、<code>year_treated</code>と<code>time_to_treatment</code>を作成しておきます。</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb4" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(fixest)</span>
<span id="cb4-2"></span>
<span id="cb4-3">castle <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> haven<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">read_dta</span>(</span>
<span id="cb4-4">  <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"https://github.com/scunning1975/mixtape/raw/master/castle.dta"</span></span>
<span id="cb4-5">)</span>
<span id="cb4-6"></span>
<span id="cb4-7"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 以下Mixtape参考</span></span>
<span id="cb4-8"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># fmt: skip</span></span>
<span id="cb4-9">dropped_vars <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(</span>
<span id="cb4-10">  <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"r20004"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"r20014"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"r20024"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"r20034"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"r20044"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"r20054"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"r20064"</span>,</span>
<span id="cb4-11">  <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"r20074"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"r20084"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"r20094"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"r20101"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"r20102"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"r20103"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"r20104"</span>,</span>
<span id="cb4-12">  <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"trend_9"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"trend_46"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"trend_49"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"trend_50"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"trend_51"</span></span>
<span id="cb4-13">)</span>
<span id="cb4-14"></span>
<span id="cb4-15">region <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> castle <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span></span>
<span id="cb4-16">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">select</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">starts_with</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"r20"</span>)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span></span>
<span id="cb4-17">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">names</span>() <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span></span>
<span id="cb4-18">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">setdiff</span>(dropped_vars)</span>
<span id="cb4-19"></span>
<span id="cb4-20">df_castle <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> castle <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span></span>
<span id="cb4-21">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">select</span>(state, sid, year, treatment_date, l_homicide, <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">all_of</span>(region), popwt) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span></span>
<span id="cb4-22">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mutate</span>(</span>
<span id="cb4-23">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">is_treated =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">if_else</span>(<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">!</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">is.na</span>(treatment_date), <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>),</span>
<span id="cb4-24">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">year_treated =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">if_else</span>(is_treated <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, treatment_date, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10000</span>L),</span>
<span id="cb4-25">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">time_to_treatment =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">if_else</span>(is_treated <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, year <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> treatment_date, <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1000</span>L)</span>
<span id="cb4-26">  )</span></code></pre></div></div>
</div>
<p>各データフレームは以下のような感じになっています。先頭の15行を見てみましょう。</p>
<div class="tabset-margin-container"></div><div class="panel-tabset">
<ul class="nav nav-tabs"><li class="nav-item"><a class="nav-link active" id="tabset-1-1-tab" data-bs-toggle="tab" data-bs-target="#tabset-1-1" aria-controls="tabset-1-1" aria-selected="true" href="">base_did</a></li><li class="nav-item"><a class="nav-link" id="tabset-1-2-tab" data-bs-toggle="tab" data-bs-target="#tabset-1-2" aria-controls="tabset-1-2" aria-selected="false" href="">base_stagg</a></li><li class="nav-item"><a class="nav-link" id="tabset-1-3-tab" data-bs-toggle="tab" data-bs-target="#tabset-1-3" aria-controls="tabset-1-3" aria-selected="false" href="">df_castle</a></li></ul>
<div class="tab-content">
<div id="tabset-1-1" class="tab-pane active" aria-labelledby="tabset-1-1-tab">
<div class="cell">
<div class="cell-output-display">
<!-- preamble start -->

    <script src="https://cdn.jsdelivr.net/gh/vincentarelbundock/tinytable@main/inst/tinytable.js"></script>

    <script>
      // Create table-specific functions using external factory
      const tableFns_oa8wrtcvxvpy0ru9c8zp = TinyTable.createTableFunctions("tinytable_oa8wrtcvxvpy0ru9c8zp");
      // tinytable span after
      window.addEventListener('load', function () {
          var cellsToStyle = [
            // tinytable style arrays after
          { positions: [ { i: '15', j: 1 }, { i: '15', j: 2 }, { i: '15', j: 3 }, { i: '15', j: 4 }, { i: '15', j: 5 }, { i: '15', j: 6 } ], css_id: 'tinytable_css_k2uhb3vqvf4y422p1ljz',}, 
          { positions: [ { i: '0', j: 1 }, { i: '0', j: 2 }, { i: '0', j: 3 }, { i: '0', j: 4 }, { i: '0', j: 5 }, { i: '0', j: 6 } ], css_id: 'tinytable_css_0u7ya7s9xwoat72dyz37',}, 
          ];

          // Loop over the arrays to style the cells
          cellsToStyle.forEach(function (group) {
              group.positions.forEach(function (cell) {
                  tableFns_oa8wrtcvxvpy0ru9c8zp.styleCell(cell.i, cell.j, group.css_id);
              });
          });
      });
    </script>

    <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/vincentarelbundock/tinytable@main/inst/tinytable.css">
    <style>
    /* tinytable css entries after */
    #tinytable_oa8wrtcvxvpy0ru9c8zp td.tinytable_css_k2uhb3vqvf4y422p1ljz, #tinytable_oa8wrtcvxvpy0ru9c8zp th.tinytable_css_k2uhb3vqvf4y422p1ljz {  position: relative; --border-bottom: 1; --border-left: 0; --border-right: 0; --border-top: 0; --line-color-bottom: var(--tt-line-color); --line-color-left: var(--tt-line-color); --line-color-right: var(--tt-line-color); --line-color-top: var(--tt-line-color); --line-width-bottom: 0.1em; --line-width-left: 0.1em; --line-width-right: 0.1em; --line-width-top: 0.1em; --trim-bottom-left: 0%; --trim-bottom-right: 0%; --trim-left-bottom: 0%; --trim-left-top: 0%; --trim-right-bottom: 0%; --trim-right-top: 0%; --trim-top-left: 0%; --trim-top-right: 0%;  }
    #tinytable_oa8wrtcvxvpy0ru9c8zp td.tinytable_css_0u7ya7s9xwoat72dyz37, #tinytable_oa8wrtcvxvpy0ru9c8zp th.tinytable_css_0u7ya7s9xwoat72dyz37 {  position: relative; --border-bottom: 1; --border-left: 0; --border-right: 0; --border-top: 1; --line-color-bottom: var(--tt-line-color); --line-color-left: var(--tt-line-color); --line-color-right: var(--tt-line-color); --line-color-top: var(--tt-line-color); --line-width-bottom: 0.05em; --line-width-left: 0.1em; --line-width-right: 0.1em; --line-width-top: 0.1em; --trim-bottom-left: 0%; --trim-bottom-right: 0%; --trim-left-bottom: 0%; --trim-left-top: 0%; --trim-right-bottom: 0%; --trim-right-top: 0%; --trim-top-left: 0%; --trim-top-right: 0%;  }
    </style>
    <div class="container">
      <table class="tinytable" id="tinytable_oa8wrtcvxvpy0ru9c8zp" style="width: auto; margin-left: auto; margin-right: auto;" data-quarto-disable-processing="true">
        
        <thead>
              <tr>
                <th scope="col" data-row="0" data-col="1">y</th>
                <th scope="col" data-row="0" data-col="2">x1</th>
                <th scope="col" data-row="0" data-col="3">id</th>
                <th scope="col" data-row="0" data-col="4">period</th>
                <th scope="col" data-row="0" data-col="5">post</th>
                <th scope="col" data-row="0" data-col="6">treat</th>
              </tr>
        </thead>
        
        <tbody>
                <tr>
                  <td data-row="1" data-col="1">2.87530627</td>
                  <td data-row="1" data-col="2">0.53653768</td>
                  <td data-row="1" data-col="3">1</td>
                  <td data-row="1" data-col="4">1</td>
                  <td data-row="1" data-col="5">0</td>
                  <td data-row="1" data-col="6">1</td>
                </tr>
                <tr>
                  <td data-row="2" data-col="1">1.86065272</td>
                  <td data-row="2" data-col="2">-3.04318942</td>
                  <td data-row="2" data-col="3">1</td>
                  <td data-row="2" data-col="4">2</td>
                  <td data-row="2" data-col="5">0</td>
                  <td data-row="2" data-col="6">1</td>
                </tr>
                <tr>
                  <td data-row="3" data-col="1">0.09416524</td>
                  <td data-row="3" data-col="2">5.57684387</td>
                  <td data-row="3" data-col="3">1</td>
                  <td data-row="3" data-col="4">3</td>
                  <td data-row="3" data-col="5">0</td>
                  <td data-row="3" data-col="6">1</td>
                </tr>
                <tr>
                  <td data-row="4" data-col="1">3.78147485</td>
                  <td data-row="4" data-col="2">-2.83005866</td>
                  <td data-row="4" data-col="3">1</td>
                  <td data-row="4" data-col="4">4</td>
                  <td data-row="4" data-col="5">0</td>
                  <td data-row="4" data-col="6">1</td>
                </tr>
                <tr>
                  <td data-row="5" data-col="1">-2.55819959</td>
                  <td data-row="5" data-col="2">-5.04435440</td>
                  <td data-row="5" data-col="3">1</td>
                  <td data-row="5" data-col="4">5</td>
                  <td data-row="5" data-col="5">0</td>
                  <td data-row="5" data-col="6">1</td>
                </tr>
                <tr>
                  <td data-row="6" data-col="1">1.72873240</td>
                  <td data-row="6" data-col="2">-0.63638485</td>
                  <td data-row="6" data-col="3">1</td>
                  <td data-row="6" data-col="4">6</td>
                  <td data-row="6" data-col="5">1</td>
                  <td data-row="6" data-col="6">1</td>
                </tr>
                <tr>
                  <td data-row="7" data-col="1">6.28423629</td>
                  <td data-row="7" data-col="2">-2.12988365</td>
                  <td data-row="7" data-col="3">1</td>
                  <td data-row="7" data-col="4">7</td>
                  <td data-row="7" data-col="5">1</td>
                  <td data-row="7" data-col="6">1</td>
                </tr>
                <tr>
                  <td data-row="8" data-col="1">4.76688778</td>
                  <td data-row="8" data-col="2">3.49185577</td>
                  <td data-row="8" data-col="3">1</td>
                  <td data-row="8" data-col="4">8</td>
                  <td data-row="8" data-col="5">1</td>
                  <td data-row="8" data-col="6">1</td>
                </tr>
                <tr>
                  <td data-row="9" data-col="1">5.34753392</td>
                  <td data-row="9" data-col="2">0.83798615</td>
                  <td data-row="9" data-col="3">1</td>
                  <td data-row="9" data-col="4">9</td>
                  <td data-row="9" data-col="5">1</td>
                  <td data-row="9" data-col="6">1</td>
                </tr>
                <tr>
                  <td data-row="10" data-col="1">4.95146934</td>
                  <td data-row="10" data-col="2">0.63388904</td>
                  <td data-row="10" data-col="3">1</td>
                  <td data-row="10" data-col="4">10</td>
                  <td data-row="10" data-col="5">1</td>
                  <td data-row="10" data-col="6">1</td>
                </tr>
                <tr>
                  <td data-row="11" data-col="1">-4.25798295</td>
                  <td data-row="11" data-col="2">-5.26462514</td>
                  <td data-row="11" data-col="3">2</td>
                  <td data-row="11" data-col="4">1</td>
                  <td data-row="11" data-col="5">0</td>
                  <td data-row="11" data-col="6">1</td>
                </tr>
                <tr>
                  <td data-row="12" data-col="1">0.60611067</td>
                  <td data-row="12" data-col="2">-3.70483485</td>
                  <td data-row="12" data-col="3">2</td>
                  <td data-row="12" data-col="4">2</td>
                  <td data-row="12" data-col="5">0</td>
                  <td data-row="12" data-col="6">1</td>
                </tr>
                <tr>
                  <td data-row="13" data-col="1">5.61637038</td>
                  <td data-row="13" data-col="2">-0.21742509</td>
                  <td data-row="13" data-col="3">2</td>
                  <td data-row="13" data-col="4">3</td>
                  <td data-row="13" data-col="5">0</td>
                  <td data-row="13" data-col="6">1</td>
                </tr>
                <tr>
                  <td data-row="14" data-col="1">-6.16941931</td>
                  <td data-row="14" data-col="2">-2.02699419</td>
                  <td data-row="14" data-col="3">2</td>
                  <td data-row="14" data-col="4">4</td>
                  <td data-row="14" data-col="5">0</td>
                  <td data-row="14" data-col="6">1</td>
                </tr>
                <tr>
                  <td data-row="15" data-col="1">0.71186875</td>
                  <td data-row="15" data-col="2">0.01140001</td>
                  <td data-row="15" data-col="3">2</td>
                  <td data-row="15" data-col="4">5</td>
                  <td data-row="15" data-col="5">0</td>
                  <td data-row="15" data-col="6">1</td>
                </tr>
        </tbody>
      </table>
    </div>
<!-- hack to avoid NA insertion in last line -->
</div>
</div>
</div>
<div id="tabset-1-2" class="tab-pane" aria-labelledby="tabset-1-2-tab">
<div class="cell">
<div class="cell-output-display">
<!-- preamble start -->

    <script src="https://cdn.jsdelivr.net/gh/vincentarelbundock/tinytable@main/inst/tinytable.js"></script>

    <script>
      // Create table-specific functions using external factory
      const tableFns_sqmfxcefbqbfe59d7quo = TinyTable.createTableFunctions("tinytable_sqmfxcefbqbfe59d7quo");
      // tinytable span after
      window.addEventListener('load', function () {
          var cellsToStyle = [
            // tinytable style arrays after
          { positions: [ { i: '15', j: 1 }, { i: '15', j: 2 }, { i: '15', j: 3 }, { i: '15', j: 4 }, { i: '15', j: 5 }, { i: '15', j: 6 }, { i: '15', j: 7 }, { i: '15', j: 8 } ], css_id: 'tinytable_css_ifvra9gw81xh659h3018',}, 
          { positions: [ { i: '0', j: 1 }, { i: '0', j: 2 }, { i: '0', j: 3 }, { i: '0', j: 4 }, { i: '0', j: 5 }, { i: '0', j: 6 }, { i: '0', j: 7 }, { i: '0', j: 8 } ], css_id: 'tinytable_css_q9b3bjrydgey66rdtpio',}, 
          ];

          // Loop over the arrays to style the cells
          cellsToStyle.forEach(function (group) {
              group.positions.forEach(function (cell) {
                  tableFns_sqmfxcefbqbfe59d7quo.styleCell(cell.i, cell.j, group.css_id);
              });
          });
      });
    </script>

    <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/vincentarelbundock/tinytable@main/inst/tinytable.css">
    <style>
    /* tinytable css entries after */
    #tinytable_sqmfxcefbqbfe59d7quo td.tinytable_css_ifvra9gw81xh659h3018, #tinytable_sqmfxcefbqbfe59d7quo th.tinytable_css_ifvra9gw81xh659h3018 {  position: relative; --border-bottom: 1; --border-left: 0; --border-right: 0; --border-top: 0; --line-color-bottom: var(--tt-line-color); --line-color-left: var(--tt-line-color); --line-color-right: var(--tt-line-color); --line-color-top: var(--tt-line-color); --line-width-bottom: 0.1em; --line-width-left: 0.1em; --line-width-right: 0.1em; --line-width-top: 0.1em; --trim-bottom-left: 0%; --trim-bottom-right: 0%; --trim-left-bottom: 0%; --trim-left-top: 0%; --trim-right-bottom: 0%; --trim-right-top: 0%; --trim-top-left: 0%; --trim-top-right: 0%;  }
    #tinytable_sqmfxcefbqbfe59d7quo td.tinytable_css_q9b3bjrydgey66rdtpio, #tinytable_sqmfxcefbqbfe59d7quo th.tinytable_css_q9b3bjrydgey66rdtpio {  position: relative; --border-bottom: 1; --border-left: 0; --border-right: 0; --border-top: 1; --line-color-bottom: var(--tt-line-color); --line-color-left: var(--tt-line-color); --line-color-right: var(--tt-line-color); --line-color-top: var(--tt-line-color); --line-width-bottom: 0.05em; --line-width-left: 0.1em; --line-width-right: 0.1em; --line-width-top: 0.1em; --trim-bottom-left: 0%; --trim-bottom-right: 0%; --trim-left-bottom: 0%; --trim-left-top: 0%; --trim-right-bottom: 0%; --trim-right-top: 0%; --trim-top-left: 0%; --trim-top-right: 0%;  }
    </style>
    <div class="container">
      <table class="tinytable" id="tinytable_sqmfxcefbqbfe59d7quo" style="width: auto; margin-left: auto; margin-right: auto;" data-quarto-disable-processing="true">
        
        <thead>
              <tr>
                <th scope="col" data-row="0" data-col="1">id</th>
                <th scope="col" data-row="0" data-col="2">year</th>
                <th scope="col" data-row="0" data-col="3">year_treated</th>
                <th scope="col" data-row="0" data-col="4">time_to_treatment</th>
                <th scope="col" data-row="0" data-col="5">treated</th>
                <th scope="col" data-row="0" data-col="6">treatment_effect_true</th>
                <th scope="col" data-row="0" data-col="7">x1</th>
                <th scope="col" data-row="0" data-col="8">y</th>
              </tr>
        </thead>
        
        <tbody>
                <tr>
                  <td data-row="1" data-col="1">90</td>
                  <td data-row="1" data-col="2">1</td>
                  <td data-row="1" data-col="3">2</td>
                  <td data-row="1" data-col="4">-1</td>
                  <td data-row="1" data-col="5">1</td>
                  <td data-row="1" data-col="6">0</td>
                  <td data-row="1" data-col="7">-1.09470213</td>
                  <td data-row="1" data-col="8">0.01722971</td>
                </tr>
                <tr>
                  <td data-row="2" data-col="1">89</td>
                  <td data-row="2" data-col="2">1</td>
                  <td data-row="2" data-col="3">3</td>
                  <td data-row="2" data-col="4">-2</td>
                  <td data-row="2" data-col="5">1</td>
                  <td data-row="2" data-col="6">0</td>
                  <td data-row="2" data-col="7">-3.71006765</td>
                  <td data-row="2" data-col="8">-4.58084528</td>
                </tr>
                <tr>
                  <td data-row="3" data-col="1">88</td>
                  <td data-row="3" data-col="2">1</td>
                  <td data-row="3" data-col="3">4</td>
                  <td data-row="3" data-col="4">-3</td>
                  <td data-row="3" data-col="5">1</td>
                  <td data-row="3" data-col="6">0</td>
                  <td data-row="3" data-col="7">2.52744015</td>
                  <td data-row="3" data-col="8">2.73817174</td>
                </tr>
                <tr>
                  <td data-row="4" data-col="1">87</td>
                  <td data-row="4" data-col="2">1</td>
                  <td data-row="4" data-col="3">5</td>
                  <td data-row="4" data-col="4">-4</td>
                  <td data-row="4" data-col="5">1</td>
                  <td data-row="4" data-col="6">0</td>
                  <td data-row="4" data-col="7">-0.72042631</td>
                  <td data-row="4" data-col="8">-0.65103066</td>
                </tr>
                <tr>
                  <td data-row="5" data-col="1">86</td>
                  <td data-row="5" data-col="2">1</td>
                  <td data-row="5" data-col="3">6</td>
                  <td data-row="5" data-col="4">-5</td>
                  <td data-row="5" data-col="5">1</td>
                  <td data-row="5" data-col="6">0</td>
                  <td data-row="5" data-col="7">-3.67116779</td>
                  <td data-row="5" data-col="8">-5.33381664</td>
                </tr>
                <tr>
                  <td data-row="6" data-col="1">85</td>
                  <td data-row="6" data-col="2">1</td>
                  <td data-row="6" data-col="3">7</td>
                  <td data-row="6" data-col="4">-6</td>
                  <td data-row="6" data-col="5">1</td>
                  <td data-row="6" data-col="6">0</td>
                  <td data-row="6" data-col="7">-0.31521367</td>
                  <td data-row="6" data-col="8">0.49562631</td>
                </tr>
                <tr>
                  <td data-row="7" data-col="1">84</td>
                  <td data-row="7" data-col="2">1</td>
                  <td data-row="7" data-col="3">8</td>
                  <td data-row="7" data-col="4">-7</td>
                  <td data-row="7" data-col="5">1</td>
                  <td data-row="7" data-col="6">0</td>
                  <td data-row="7" data-col="7">0.32856334</td>
                  <td data-row="7" data-col="8">-1.58378245</td>
                </tr>
                <tr>
                  <td data-row="8" data-col="1">83</td>
                  <td data-row="8" data-col="2">1</td>
                  <td data-row="8" data-col="3">9</td>
                  <td data-row="8" data-col="4">-8</td>
                  <td data-row="8" data-col="5">1</td>
                  <td data-row="8" data-col="6">0</td>
                  <td data-row="8" data-col="7">-0.08850915</td>
                  <td data-row="8" data-col="8">-1.33526257</td>
                </tr>
                <tr>
                  <td data-row="9" data-col="1">82</td>
                  <td data-row="9" data-col="2">1</td>
                  <td data-row="9" data-col="3">10</td>
                  <td data-row="9" data-col="4">-9</td>
                  <td data-row="9" data-col="5">1</td>
                  <td data-row="9" data-col="6">0</td>
                  <td data-row="9" data-col="7">-2.34951611</td>
                  <td data-row="9" data-col="8">-1.35136167</td>
                </tr>
                <tr>
                  <td data-row="10" data-col="1">81</td>
                  <td data-row="10" data-col="2">1</td>
                  <td data-row="10" data-col="3">10000</td>
                  <td data-row="10" data-col="4">-1000</td>
                  <td data-row="10" data-col="5">0</td>
                  <td data-row="10" data-col="6">0</td>
                  <td data-row="10" data-col="7">2.31318716</td>
                  <td data-row="10" data-col="8">1.77231442</td>
                </tr>
                <tr>
                  <td data-row="11" data-col="1">80</td>
                  <td data-row="11" data-col="2">1</td>
                  <td data-row="11" data-col="3">10000</td>
                  <td data-row="11" data-col="4">-1000</td>
                  <td data-row="11" data-col="5">0</td>
                  <td data-row="11" data-col="6">0</td>
                  <td data-row="11" data-col="7">-0.56561061</td>
                  <td data-row="11" data-col="8">-0.78198640</td>
                </tr>
                <tr>
                  <td data-row="12" data-col="1">79</td>
                  <td data-row="12" data-col="2">1</td>
                  <td data-row="12" data-col="3">10000</td>
                  <td data-row="12" data-col="4">-1000</td>
                  <td data-row="12" data-col="5">0</td>
                  <td data-row="12" data-col="6">0</td>
                  <td data-row="12" data-col="7">-3.15996610</td>
                  <td data-row="12" data-col="8">-4.78190340</td>
                </tr>
                <tr>
                  <td data-row="13" data-col="1">78</td>
                  <td data-row="13" data-col="2">1</td>
                  <td data-row="13" data-col="3">10000</td>
                  <td data-row="13" data-col="4">-1000</td>
                  <td data-row="13" data-col="5">0</td>
                  <td data-row="13" data-col="6">0</td>
                  <td data-row="13" data-col="7">-7.24864781</td>
                  <td data-row="13" data-col="8">-8.69961178</td>
                </tr>
                <tr>
                  <td data-row="14" data-col="1">77</td>
                  <td data-row="14" data-col="2">1</td>
                  <td data-row="14" data-col="3">10000</td>
                  <td data-row="14" data-col="4">-1000</td>
                  <td data-row="14" data-col="5">0</td>
                  <td data-row="14" data-col="6">0</td>
                  <td data-row="14" data-col="7">1.32056216</td>
                  <td data-row="14" data-col="8">1.67147189</td>
                </tr>
                <tr>
                  <td data-row="15" data-col="1">76</td>
                  <td data-row="15" data-col="2">1</td>
                  <td data-row="15" data-col="3">10000</td>
                  <td data-row="15" data-col="4">-1000</td>
                  <td data-row="15" data-col="5">0</td>
                  <td data-row="15" data-col="6">0</td>
                  <td data-row="15" data-col="7">-1.68121120</td>
                  <td data-row="15" data-col="8">-1.85575812</td>
                </tr>
        </tbody>
      </table>
    </div>
<!-- hack to avoid NA insertion in last line -->
</div>
</div>
</div>
<div id="tabset-1-3" class="tab-pane" aria-labelledby="tabset-1-3-tab">
<div class="cell">
<div class="cell-output-display">
<!-- preamble start -->

    <script src="https://cdn.jsdelivr.net/gh/vincentarelbundock/tinytable@main/inst/tinytable.js"></script>

    <script>
      // Create table-specific functions using external factory
      const tableFns_80lczp3rr2m6l9e85f05 = TinyTable.createTableFunctions("tinytable_80lczp3rr2m6l9e85f05");
      // tinytable span after
      window.addEventListener('load', function () {
          var cellsToStyle = [
            // tinytable style arrays after
          { positions: [ { i: '15', j: 1 }, { i: '15', j: 2 }, { i: '15', j: 3 }, { i: '15', j: 4 }, { i: '15', j: 5 }, { i: '15', j: 6 }, { i: '15', j: 7 }, { i: '15', j: 8 }, { i: '15', j: 9 }, { i: '15', j: 10 }, { i: '15', j: 11 }, { i: '15', j: 12 }, { i: '15', j: 13 }, { i: '15', j: 14 }, { i: '15', j: 15 }, { i: '15', j: 16 }, { i: '15', j: 17 }, { i: '15', j: 18 }, { i: '15', j: 19 }, { i: '15', j: 20 }, { i: '15', j: 21 }, { i: '15', j: 22 }, { i: '15', j: 23 }, { i: '15', j: 24 }, { i: '15', j: 25 }, { i: '15', j: 26 }, { i: '15', j: 27 }, { i: '15', j: 28 }, { i: '15', j: 29 }, { i: '15', j: 30 }, { i: '15', j: 31 }, { i: '15', j: 32 }, { i: '15', j: 33 }, { i: '15', j: 34 }, { i: '15', j: 35 }, { i: '15', j: 36 }, { i: '15', j: 37 }, { i: '15', j: 38 }, { i: '15', j: 39 } ], css_id: 'tinytable_css_hvafp084wzpd4cva3b54',}, 
          { positions: [ { i: '0', j: 1 }, { i: '0', j: 2 }, { i: '0', j: 3 }, { i: '0', j: 4 }, { i: '0', j: 5 }, { i: '0', j: 6 }, { i: '0', j: 7 }, { i: '0', j: 8 }, { i: '0', j: 9 }, { i: '0', j: 10 }, { i: '0', j: 11 }, { i: '0', j: 12 }, { i: '0', j: 13 }, { i: '0', j: 14 }, { i: '0', j: 15 }, { i: '0', j: 16 }, { i: '0', j: 17 }, { i: '0', j: 18 }, { i: '0', j: 19 }, { i: '0', j: 20 }, { i: '0', j: 21 }, { i: '0', j: 22 }, { i: '0', j: 23 }, { i: '0', j: 24 }, { i: '0', j: 25 }, { i: '0', j: 26 }, { i: '0', j: 27 }, { i: '0', j: 28 }, { i: '0', j: 29 }, { i: '0', j: 30 }, { i: '0', j: 31 }, { i: '0', j: 32 }, { i: '0', j: 33 }, { i: '0', j: 34 }, { i: '0', j: 35 }, { i: '0', j: 36 }, { i: '0', j: 37 }, { i: '0', j: 38 }, { i: '0', j: 39 } ], css_id: 'tinytable_css_4ywcx7em8jn96cg1e8c7',}, 
          ];

          // Loop over the arrays to style the cells
          cellsToStyle.forEach(function (group) {
              group.positions.forEach(function (cell) {
                  tableFns_80lczp3rr2m6l9e85f05.styleCell(cell.i, cell.j, group.css_id);
              });
          });
      });
    </script>

    <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/vincentarelbundock/tinytable@main/inst/tinytable.css">
    <style>
    /* tinytable css entries after */
    #tinytable_80lczp3rr2m6l9e85f05 td.tinytable_css_hvafp084wzpd4cva3b54, #tinytable_80lczp3rr2m6l9e85f05 th.tinytable_css_hvafp084wzpd4cva3b54 {  position: relative; --border-bottom: 1; --border-left: 0; --border-right: 0; --border-top: 0; --line-color-bottom: var(--tt-line-color); --line-color-left: var(--tt-line-color); --line-color-right: var(--tt-line-color); --line-color-top: var(--tt-line-color); --line-width-bottom: 0.1em; --line-width-left: 0.1em; --line-width-right: 0.1em; --line-width-top: 0.1em; --trim-bottom-left: 0%; --trim-bottom-right: 0%; --trim-left-bottom: 0%; --trim-left-top: 0%; --trim-right-bottom: 0%; --trim-right-top: 0%; --trim-top-left: 0%; --trim-top-right: 0%;  }
    #tinytable_80lczp3rr2m6l9e85f05 td.tinytable_css_4ywcx7em8jn96cg1e8c7, #tinytable_80lczp3rr2m6l9e85f05 th.tinytable_css_4ywcx7em8jn96cg1e8c7 {  position: relative; --border-bottom: 1; --border-left: 0; --border-right: 0; --border-top: 1; --line-color-bottom: var(--tt-line-color); --line-color-left: var(--tt-line-color); --line-color-right: var(--tt-line-color); --line-color-top: var(--tt-line-color); --line-width-bottom: 0.05em; --line-width-left: 0.1em; --line-width-right: 0.1em; --line-width-top: 0.1em; --trim-bottom-left: 0%; --trim-bottom-right: 0%; --trim-left-bottom: 0%; --trim-left-top: 0%; --trim-right-bottom: 0%; --trim-right-top: 0%; --trim-top-left: 0%; --trim-top-right: 0%;  }
    </style>
    <div class="container">
      <table class="tinytable" id="tinytable_80lczp3rr2m6l9e85f05" style="width: auto; margin-left: auto; margin-right: auto;" data-quarto-disable-processing="true">
        
        <thead>
              <tr>
                <th scope="col" data-row="0" data-col="1">state</th>
                <th scope="col" data-row="0" data-col="2">sid</th>
                <th scope="col" data-row="0" data-col="3">year</th>
                <th scope="col" data-row="0" data-col="4">treatment_date</th>
                <th scope="col" data-row="0" data-col="5">l_homicide</th>
                <th scope="col" data-row="0" data-col="6">r20001</th>
                <th scope="col" data-row="0" data-col="7">r20002</th>
                <th scope="col" data-row="0" data-col="8">r20003</th>
                <th scope="col" data-row="0" data-col="9">r20011</th>
                <th scope="col" data-row="0" data-col="10">r20012</th>
                <th scope="col" data-row="0" data-col="11">r20013</th>
                <th scope="col" data-row="0" data-col="12">r20021</th>
                <th scope="col" data-row="0" data-col="13">r20022</th>
                <th scope="col" data-row="0" data-col="14">r20023</th>
                <th scope="col" data-row="0" data-col="15">r20031</th>
                <th scope="col" data-row="0" data-col="16">r20032</th>
                <th scope="col" data-row="0" data-col="17">r20033</th>
                <th scope="col" data-row="0" data-col="18">r20041</th>
                <th scope="col" data-row="0" data-col="19">r20042</th>
                <th scope="col" data-row="0" data-col="20">r20043</th>
                <th scope="col" data-row="0" data-col="21">r20051</th>
                <th scope="col" data-row="0" data-col="22">r20052</th>
                <th scope="col" data-row="0" data-col="23">r20053</th>
                <th scope="col" data-row="0" data-col="24">r20061</th>
                <th scope="col" data-row="0" data-col="25">r20062</th>
                <th scope="col" data-row="0" data-col="26">r20063</th>
                <th scope="col" data-row="0" data-col="27">r20071</th>
                <th scope="col" data-row="0" data-col="28">r20072</th>
                <th scope="col" data-row="0" data-col="29">r20073</th>
                <th scope="col" data-row="0" data-col="30">r20081</th>
                <th scope="col" data-row="0" data-col="31">r20082</th>
                <th scope="col" data-row="0" data-col="32">r20083</th>
                <th scope="col" data-row="0" data-col="33">r20091</th>
                <th scope="col" data-row="0" data-col="34">r20092</th>
                <th scope="col" data-row="0" data-col="35">r20093</th>
                <th scope="col" data-row="0" data-col="36">popwt</th>
                <th scope="col" data-row="0" data-col="37">is_treated</th>
                <th scope="col" data-row="0" data-col="38">year_treated</th>
                <th scope="col" data-row="0" data-col="39">time_to_treatment</th>
              </tr>
        </thead>
        
        <tbody>
                <tr>
                  <td data-row="1" data-col="1">Alabama</td>
                  <td data-row="1" data-col="2">1</td>
                  <td data-row="1" data-col="3">2000</td>
                  <td data-row="1" data-col="4">2006</td>
                  <td data-row="1" data-col="5">2.027356</td>
                  <td data-row="1" data-col="6">0</td>
                  <td data-row="1" data-col="7">0</td>
                  <td data-row="1" data-col="8">1</td>
                  <td data-row="1" data-col="9">0</td>
                  <td data-row="1" data-col="10">0</td>
                  <td data-row="1" data-col="11">0</td>
                  <td data-row="1" data-col="12">0</td>
                  <td data-row="1" data-col="13">0</td>
                  <td data-row="1" data-col="14">0</td>
                  <td data-row="1" data-col="15">0</td>
                  <td data-row="1" data-col="16">0</td>
                  <td data-row="1" data-col="17">0</td>
                  <td data-row="1" data-col="18">0</td>
                  <td data-row="1" data-col="19">0</td>
                  <td data-row="1" data-col="20">0</td>
                  <td data-row="1" data-col="21">0</td>
                  <td data-row="1" data-col="22">0</td>
                  <td data-row="1" data-col="23">0</td>
                  <td data-row="1" data-col="24">0</td>
                  <td data-row="1" data-col="25">0</td>
                  <td data-row="1" data-col="26">0</td>
                  <td data-row="1" data-col="27">0</td>
                  <td data-row="1" data-col="28">0</td>
                  <td data-row="1" data-col="29">0</td>
                  <td data-row="1" data-col="30">0</td>
                  <td data-row="1" data-col="31">0</td>
                  <td data-row="1" data-col="32">0</td>
                  <td data-row="1" data-col="33">0</td>
                  <td data-row="1" data-col="34">0</td>
                  <td data-row="1" data-col="35">0</td>
                  <td data-row="1" data-col="36">4499293.0</td>
                  <td data-row="1" data-col="37">1</td>
                  <td data-row="1" data-col="38">2006</td>
                  <td data-row="1" data-col="39">-6</td>
                </tr>
                <tr>
                  <td data-row="2" data-col="1">Alabama</td>
                  <td data-row="2" data-col="2">1</td>
                  <td data-row="2" data-col="3">2001</td>
                  <td data-row="2" data-col="4">2006</td>
                  <td data-row="2" data-col="5">2.164867</td>
                  <td data-row="2" data-col="6">0</td>
                  <td data-row="2" data-col="7">0</td>
                  <td data-row="2" data-col="8">0</td>
                  <td data-row="2" data-col="9">0</td>
                  <td data-row="2" data-col="10">0</td>
                  <td data-row="2" data-col="11">1</td>
                  <td data-row="2" data-col="12">0</td>
                  <td data-row="2" data-col="13">0</td>
                  <td data-row="2" data-col="14">0</td>
                  <td data-row="2" data-col="15">0</td>
                  <td data-row="2" data-col="16">0</td>
                  <td data-row="2" data-col="17">0</td>
                  <td data-row="2" data-col="18">0</td>
                  <td data-row="2" data-col="19">0</td>
                  <td data-row="2" data-col="20">0</td>
                  <td data-row="2" data-col="21">0</td>
                  <td data-row="2" data-col="22">0</td>
                  <td data-row="2" data-col="23">0</td>
                  <td data-row="2" data-col="24">0</td>
                  <td data-row="2" data-col="25">0</td>
                  <td data-row="2" data-col="26">0</td>
                  <td data-row="2" data-col="27">0</td>
                  <td data-row="2" data-col="28">0</td>
                  <td data-row="2" data-col="29">0</td>
                  <td data-row="2" data-col="30">0</td>
                  <td data-row="2" data-col="31">0</td>
                  <td data-row="2" data-col="32">0</td>
                  <td data-row="2" data-col="33">0</td>
                  <td data-row="2" data-col="34">0</td>
                  <td data-row="2" data-col="35">0</td>
                  <td data-row="2" data-col="36">4499293.0</td>
                  <td data-row="2" data-col="37">1</td>
                  <td data-row="2" data-col="38">2006</td>
                  <td data-row="2" data-col="39">-5</td>
                </tr>
                <tr>
                  <td data-row="3" data-col="1">Alabama</td>
                  <td data-row="3" data-col="2">1</td>
                  <td data-row="3" data-col="3">2002</td>
                  <td data-row="3" data-col="4">2006</td>
                  <td data-row="3" data-col="5">1.936334</td>
                  <td data-row="3" data-col="6">0</td>
                  <td data-row="3" data-col="7">0</td>
                  <td data-row="3" data-col="8">0</td>
                  <td data-row="3" data-col="9">0</td>
                  <td data-row="3" data-col="10">0</td>
                  <td data-row="3" data-col="11">0</td>
                  <td data-row="3" data-col="12">0</td>
                  <td data-row="3" data-col="13">0</td>
                  <td data-row="3" data-col="14">1</td>
                  <td data-row="3" data-col="15">0</td>
                  <td data-row="3" data-col="16">0</td>
                  <td data-row="3" data-col="17">0</td>
                  <td data-row="3" data-col="18">0</td>
                  <td data-row="3" data-col="19">0</td>
                  <td data-row="3" data-col="20">0</td>
                  <td data-row="3" data-col="21">0</td>
                  <td data-row="3" data-col="22">0</td>
                  <td data-row="3" data-col="23">0</td>
                  <td data-row="3" data-col="24">0</td>
                  <td data-row="3" data-col="25">0</td>
                  <td data-row="3" data-col="26">0</td>
                  <td data-row="3" data-col="27">0</td>
                  <td data-row="3" data-col="28">0</td>
                  <td data-row="3" data-col="29">0</td>
                  <td data-row="3" data-col="30">0</td>
                  <td data-row="3" data-col="31">0</td>
                  <td data-row="3" data-col="32">0</td>
                  <td data-row="3" data-col="33">0</td>
                  <td data-row="3" data-col="34">0</td>
                  <td data-row="3" data-col="35">0</td>
                  <td data-row="3" data-col="36">4499293.0</td>
                  <td data-row="3" data-col="37">1</td>
                  <td data-row="3" data-col="38">2006</td>
                  <td data-row="3" data-col="39">-4</td>
                </tr>
                <tr>
                  <td data-row="4" data-col="1">Alabama</td>
                  <td data-row="4" data-col="2">1</td>
                  <td data-row="4" data-col="3">2003</td>
                  <td data-row="4" data-col="4">2006</td>
                  <td data-row="4" data-col="5">1.919567</td>
                  <td data-row="4" data-col="6">0</td>
                  <td data-row="4" data-col="7">0</td>
                  <td data-row="4" data-col="8">0</td>
                  <td data-row="4" data-col="9">0</td>
                  <td data-row="4" data-col="10">0</td>
                  <td data-row="4" data-col="11">0</td>
                  <td data-row="4" data-col="12">0</td>
                  <td data-row="4" data-col="13">0</td>
                  <td data-row="4" data-col="14">0</td>
                  <td data-row="4" data-col="15">0</td>
                  <td data-row="4" data-col="16">0</td>
                  <td data-row="4" data-col="17">1</td>
                  <td data-row="4" data-col="18">0</td>
                  <td data-row="4" data-col="19">0</td>
                  <td data-row="4" data-col="20">0</td>
                  <td data-row="4" data-col="21">0</td>
                  <td data-row="4" data-col="22">0</td>
                  <td data-row="4" data-col="23">0</td>
                  <td data-row="4" data-col="24">0</td>
                  <td data-row="4" data-col="25">0</td>
                  <td data-row="4" data-col="26">0</td>
                  <td data-row="4" data-col="27">0</td>
                  <td data-row="4" data-col="28">0</td>
                  <td data-row="4" data-col="29">0</td>
                  <td data-row="4" data-col="30">0</td>
                  <td data-row="4" data-col="31">0</td>
                  <td data-row="4" data-col="32">0</td>
                  <td data-row="4" data-col="33">0</td>
                  <td data-row="4" data-col="34">0</td>
                  <td data-row="4" data-col="35">0</td>
                  <td data-row="4" data-col="36">4499293.0</td>
                  <td data-row="4" data-col="37">1</td>
                  <td data-row="4" data-col="38">2006</td>
                  <td data-row="4" data-col="39">-3</td>
                </tr>
                <tr>
                  <td data-row="5" data-col="1">Alabama</td>
                  <td data-row="5" data-col="2">1</td>
                  <td data-row="5" data-col="3">2004</td>
                  <td data-row="5" data-col="4">2006</td>
                  <td data-row="5" data-col="5">1.749841</td>
                  <td data-row="5" data-col="6">0</td>
                  <td data-row="5" data-col="7">0</td>
                  <td data-row="5" data-col="8">0</td>
                  <td data-row="5" data-col="9">0</td>
                  <td data-row="5" data-col="10">0</td>
                  <td data-row="5" data-col="11">0</td>
                  <td data-row="5" data-col="12">0</td>
                  <td data-row="5" data-col="13">0</td>
                  <td data-row="5" data-col="14">0</td>
                  <td data-row="5" data-col="15">0</td>
                  <td data-row="5" data-col="16">0</td>
                  <td data-row="5" data-col="17">0</td>
                  <td data-row="5" data-col="18">0</td>
                  <td data-row="5" data-col="19">0</td>
                  <td data-row="5" data-col="20">1</td>
                  <td data-row="5" data-col="21">0</td>
                  <td data-row="5" data-col="22">0</td>
                  <td data-row="5" data-col="23">0</td>
                  <td data-row="5" data-col="24">0</td>
                  <td data-row="5" data-col="25">0</td>
                  <td data-row="5" data-col="26">0</td>
                  <td data-row="5" data-col="27">0</td>
                  <td data-row="5" data-col="28">0</td>
                  <td data-row="5" data-col="29">0</td>
                  <td data-row="5" data-col="30">0</td>
                  <td data-row="5" data-col="31">0</td>
                  <td data-row="5" data-col="32">0</td>
                  <td data-row="5" data-col="33">0</td>
                  <td data-row="5" data-col="34">0</td>
                  <td data-row="5" data-col="35">0</td>
                  <td data-row="5" data-col="36">4499293.0</td>
                  <td data-row="5" data-col="37">1</td>
                  <td data-row="5" data-col="38">2006</td>
                  <td data-row="5" data-col="39">-2</td>
                </tr>
                <tr>
                  <td data-row="6" data-col="1">Alabama</td>
                  <td data-row="6" data-col="2">1</td>
                  <td data-row="6" data-col="3">2005</td>
                  <td data-row="6" data-col="4">2006</td>
                  <td data-row="6" data-col="5">2.130440</td>
                  <td data-row="6" data-col="6">0</td>
                  <td data-row="6" data-col="7">0</td>
                  <td data-row="6" data-col="8">0</td>
                  <td data-row="6" data-col="9">0</td>
                  <td data-row="6" data-col="10">0</td>
                  <td data-row="6" data-col="11">0</td>
                  <td data-row="6" data-col="12">0</td>
                  <td data-row="6" data-col="13">0</td>
                  <td data-row="6" data-col="14">0</td>
                  <td data-row="6" data-col="15">0</td>
                  <td data-row="6" data-col="16">0</td>
                  <td data-row="6" data-col="17">0</td>
                  <td data-row="6" data-col="18">0</td>
                  <td data-row="6" data-col="19">0</td>
                  <td data-row="6" data-col="20">0</td>
                  <td data-row="6" data-col="21">0</td>
                  <td data-row="6" data-col="22">0</td>
                  <td data-row="6" data-col="23">1</td>
                  <td data-row="6" data-col="24">0</td>
                  <td data-row="6" data-col="25">0</td>
                  <td data-row="6" data-col="26">0</td>
                  <td data-row="6" data-col="27">0</td>
                  <td data-row="6" data-col="28">0</td>
                  <td data-row="6" data-col="29">0</td>
                  <td data-row="6" data-col="30">0</td>
                  <td data-row="6" data-col="31">0</td>
                  <td data-row="6" data-col="32">0</td>
                  <td data-row="6" data-col="33">0</td>
                  <td data-row="6" data-col="34">0</td>
                  <td data-row="6" data-col="35">0</td>
                  <td data-row="6" data-col="36">4499293.0</td>
                  <td data-row="6" data-col="37">1</td>
                  <td data-row="6" data-col="38">2006</td>
                  <td data-row="6" data-col="39">-1</td>
                </tr>
                <tr>
                  <td data-row="7" data-col="1">Alabama</td>
                  <td data-row="7" data-col="2">1</td>
                  <td data-row="7" data-col="3">2006</td>
                  <td data-row="7" data-col="4">2006</td>
                  <td data-row="7" data-col="5">2.079652</td>
                  <td data-row="7" data-col="6">0</td>
                  <td data-row="7" data-col="7">0</td>
                  <td data-row="7" data-col="8">0</td>
                  <td data-row="7" data-col="9">0</td>
                  <td data-row="7" data-col="10">0</td>
                  <td data-row="7" data-col="11">0</td>
                  <td data-row="7" data-col="12">0</td>
                  <td data-row="7" data-col="13">0</td>
                  <td data-row="7" data-col="14">0</td>
                  <td data-row="7" data-col="15">0</td>
                  <td data-row="7" data-col="16">0</td>
                  <td data-row="7" data-col="17">0</td>
                  <td data-row="7" data-col="18">0</td>
                  <td data-row="7" data-col="19">0</td>
                  <td data-row="7" data-col="20">0</td>
                  <td data-row="7" data-col="21">0</td>
                  <td data-row="7" data-col="22">0</td>
                  <td data-row="7" data-col="23">0</td>
                  <td data-row="7" data-col="24">0</td>
                  <td data-row="7" data-col="25">0</td>
                  <td data-row="7" data-col="26">1</td>
                  <td data-row="7" data-col="27">0</td>
                  <td data-row="7" data-col="28">0</td>
                  <td data-row="7" data-col="29">0</td>
                  <td data-row="7" data-col="30">0</td>
                  <td data-row="7" data-col="31">0</td>
                  <td data-row="7" data-col="32">0</td>
                  <td data-row="7" data-col="33">0</td>
                  <td data-row="7" data-col="34">0</td>
                  <td data-row="7" data-col="35">0</td>
                  <td data-row="7" data-col="36">4499293.0</td>
                  <td data-row="7" data-col="37">1</td>
                  <td data-row="7" data-col="38">2006</td>
                  <td data-row="7" data-col="39">0</td>
                </tr>
                <tr>
                  <td data-row="8" data-col="1">Alabama</td>
                  <td data-row="8" data-col="2">1</td>
                  <td data-row="8" data-col="3">2007</td>
                  <td data-row="8" data-col="4">2006</td>
                  <td data-row="8" data-col="5">2.145690</td>
                  <td data-row="8" data-col="6">0</td>
                  <td data-row="8" data-col="7">0</td>
                  <td data-row="8" data-col="8">0</td>
                  <td data-row="8" data-col="9">0</td>
                  <td data-row="8" data-col="10">0</td>
                  <td data-row="8" data-col="11">0</td>
                  <td data-row="8" data-col="12">0</td>
                  <td data-row="8" data-col="13">0</td>
                  <td data-row="8" data-col="14">0</td>
                  <td data-row="8" data-col="15">0</td>
                  <td data-row="8" data-col="16">0</td>
                  <td data-row="8" data-col="17">0</td>
                  <td data-row="8" data-col="18">0</td>
                  <td data-row="8" data-col="19">0</td>
                  <td data-row="8" data-col="20">0</td>
                  <td data-row="8" data-col="21">0</td>
                  <td data-row="8" data-col="22">0</td>
                  <td data-row="8" data-col="23">0</td>
                  <td data-row="8" data-col="24">0</td>
                  <td data-row="8" data-col="25">0</td>
                  <td data-row="8" data-col="26">0</td>
                  <td data-row="8" data-col="27">0</td>
                  <td data-row="8" data-col="28">0</td>
                  <td data-row="8" data-col="29">1</td>
                  <td data-row="8" data-col="30">0</td>
                  <td data-row="8" data-col="31">0</td>
                  <td data-row="8" data-col="32">0</td>
                  <td data-row="8" data-col="33">0</td>
                  <td data-row="8" data-col="34">0</td>
                  <td data-row="8" data-col="35">0</td>
                  <td data-row="8" data-col="36">4499293.0</td>
                  <td data-row="8" data-col="37">1</td>
                  <td data-row="8" data-col="38">2006</td>
                  <td data-row="8" data-col="39">1</td>
                </tr>
                <tr>
                  <td data-row="9" data-col="1">Alabama</td>
                  <td data-row="9" data-col="2">1</td>
                  <td data-row="9" data-col="3">2008</td>
                  <td data-row="9" data-col="4">2006</td>
                  <td data-row="9" data-col="5">2.043598</td>
                  <td data-row="9" data-col="6">0</td>
                  <td data-row="9" data-col="7">0</td>
                  <td data-row="9" data-col="8">0</td>
                  <td data-row="9" data-col="9">0</td>
                  <td data-row="9" data-col="10">0</td>
                  <td data-row="9" data-col="11">0</td>
                  <td data-row="9" data-col="12">0</td>
                  <td data-row="9" data-col="13">0</td>
                  <td data-row="9" data-col="14">0</td>
                  <td data-row="9" data-col="15">0</td>
                  <td data-row="9" data-col="16">0</td>
                  <td data-row="9" data-col="17">0</td>
                  <td data-row="9" data-col="18">0</td>
                  <td data-row="9" data-col="19">0</td>
                  <td data-row="9" data-col="20">0</td>
                  <td data-row="9" data-col="21">0</td>
                  <td data-row="9" data-col="22">0</td>
                  <td data-row="9" data-col="23">0</td>
                  <td data-row="9" data-col="24">0</td>
                  <td data-row="9" data-col="25">0</td>
                  <td data-row="9" data-col="26">0</td>
                  <td data-row="9" data-col="27">0</td>
                  <td data-row="9" data-col="28">0</td>
                  <td data-row="9" data-col="29">0</td>
                  <td data-row="9" data-col="30">0</td>
                  <td data-row="9" data-col="31">0</td>
                  <td data-row="9" data-col="32">1</td>
                  <td data-row="9" data-col="33">0</td>
                  <td data-row="9" data-col="34">0</td>
                  <td data-row="9" data-col="35">0</td>
                  <td data-row="9" data-col="36">4499293.0</td>
                  <td data-row="9" data-col="37">1</td>
                  <td data-row="9" data-col="38">2006</td>
                  <td data-row="9" data-col="39">2</td>
                </tr>
                <tr>
                  <td data-row="10" data-col="1">Alabama</td>
                  <td data-row="10" data-col="2">1</td>
                  <td data-row="10" data-col="3">2009</td>
                  <td data-row="10" data-col="4">2006</td>
                  <td data-row="10" data-col="5">1.938684</td>
                  <td data-row="10" data-col="6">0</td>
                  <td data-row="10" data-col="7">0</td>
                  <td data-row="10" data-col="8">0</td>
                  <td data-row="10" data-col="9">0</td>
                  <td data-row="10" data-col="10">0</td>
                  <td data-row="10" data-col="11">0</td>
                  <td data-row="10" data-col="12">0</td>
                  <td data-row="10" data-col="13">0</td>
                  <td data-row="10" data-col="14">0</td>
                  <td data-row="10" data-col="15">0</td>
                  <td data-row="10" data-col="16">0</td>
                  <td data-row="10" data-col="17">0</td>
                  <td data-row="10" data-col="18">0</td>
                  <td data-row="10" data-col="19">0</td>
                  <td data-row="10" data-col="20">0</td>
                  <td data-row="10" data-col="21">0</td>
                  <td data-row="10" data-col="22">0</td>
                  <td data-row="10" data-col="23">0</td>
                  <td data-row="10" data-col="24">0</td>
                  <td data-row="10" data-col="25">0</td>
                  <td data-row="10" data-col="26">0</td>
                  <td data-row="10" data-col="27">0</td>
                  <td data-row="10" data-col="28">0</td>
                  <td data-row="10" data-col="29">0</td>
                  <td data-row="10" data-col="30">0</td>
                  <td data-row="10" data-col="31">0</td>
                  <td data-row="10" data-col="32">0</td>
                  <td data-row="10" data-col="33">0</td>
                  <td data-row="10" data-col="34">0</td>
                  <td data-row="10" data-col="35">1</td>
                  <td data-row="10" data-col="36">4499293.0</td>
                  <td data-row="10" data-col="37">1</td>
                  <td data-row="10" data-col="38">2006</td>
                  <td data-row="10" data-col="39">3</td>
                </tr>
                <tr>
                  <td data-row="11" data-col="1">Alabama</td>
                  <td data-row="11" data-col="2">1</td>
                  <td data-row="11" data-col="3">2010</td>
                  <td data-row="11" data-col="4">2006</td>
                  <td data-row="11" data-col="5">1.747940</td>
                  <td data-row="11" data-col="6">0</td>
                  <td data-row="11" data-col="7">0</td>
                  <td data-row="11" data-col="8">0</td>
                  <td data-row="11" data-col="9">0</td>
                  <td data-row="11" data-col="10">0</td>
                  <td data-row="11" data-col="11">0</td>
                  <td data-row="11" data-col="12">0</td>
                  <td data-row="11" data-col="13">0</td>
                  <td data-row="11" data-col="14">0</td>
                  <td data-row="11" data-col="15">0</td>
                  <td data-row="11" data-col="16">0</td>
                  <td data-row="11" data-col="17">0</td>
                  <td data-row="11" data-col="18">0</td>
                  <td data-row="11" data-col="19">0</td>
                  <td data-row="11" data-col="20">0</td>
                  <td data-row="11" data-col="21">0</td>
                  <td data-row="11" data-col="22">0</td>
                  <td data-row="11" data-col="23">0</td>
                  <td data-row="11" data-col="24">0</td>
                  <td data-row="11" data-col="25">0</td>
                  <td data-row="11" data-col="26">0</td>
                  <td data-row="11" data-col="27">0</td>
                  <td data-row="11" data-col="28">0</td>
                  <td data-row="11" data-col="29">0</td>
                  <td data-row="11" data-col="30">0</td>
                  <td data-row="11" data-col="31">0</td>
                  <td data-row="11" data-col="32">0</td>
                  <td data-row="11" data-col="33">0</td>
                  <td data-row="11" data-col="34">0</td>
                  <td data-row="11" data-col="35">0</td>
                  <td data-row="11" data-col="36">4499293.0</td>
                  <td data-row="11" data-col="37">1</td>
                  <td data-row="11" data-col="38">2006</td>
                  <td data-row="11" data-col="39">4</td>
                </tr>
                <tr>
                  <td data-row="12" data-col="1">Alaska</td>
                  <td data-row="12" data-col="2">2</td>
                  <td data-row="12" data-col="3">2000</td>
                  <td data-row="12" data-col="4">2005</td>
                  <td data-row="12" data-col="5">1.491518</td>
                  <td data-row="12" data-col="6">0</td>
                  <td data-row="12" data-col="7">0</td>
                  <td data-row="12" data-col="8">0</td>
                  <td data-row="12" data-col="9">0</td>
                  <td data-row="12" data-col="10">0</td>
                  <td data-row="12" data-col="11">0</td>
                  <td data-row="12" data-col="12">0</td>
                  <td data-row="12" data-col="13">0</td>
                  <td data-row="12" data-col="14">0</td>
                  <td data-row="12" data-col="15">0</td>
                  <td data-row="12" data-col="16">0</td>
                  <td data-row="12" data-col="17">0</td>
                  <td data-row="12" data-col="18">0</td>
                  <td data-row="12" data-col="19">0</td>
                  <td data-row="12" data-col="20">0</td>
                  <td data-row="12" data-col="21">0</td>
                  <td data-row="12" data-col="22">0</td>
                  <td data-row="12" data-col="23">0</td>
                  <td data-row="12" data-col="24">0</td>
                  <td data-row="12" data-col="25">0</td>
                  <td data-row="12" data-col="26">0</td>
                  <td data-row="12" data-col="27">0</td>
                  <td data-row="12" data-col="28">0</td>
                  <td data-row="12" data-col="29">0</td>
                  <td data-row="12" data-col="30">0</td>
                  <td data-row="12" data-col="31">0</td>
                  <td data-row="12" data-col="32">0</td>
                  <td data-row="12" data-col="33">0</td>
                  <td data-row="12" data-col="34">0</td>
                  <td data-row="12" data-col="35">0</td>
                  <td data-row="12" data-col="36">651473.2</td>
                  <td data-row="12" data-col="37">1</td>
                  <td data-row="12" data-col="38">2005</td>
                  <td data-row="12" data-col="39">-5</td>
                </tr>
                <tr>
                  <td data-row="13" data-col="1">Alaska</td>
                  <td data-row="13" data-col="2">2</td>
                  <td data-row="13" data-col="3">2001</td>
                  <td data-row="13" data-col="4">2005</td>
                  <td data-row="13" data-col="5">1.846246</td>
                  <td data-row="13" data-col="6">0</td>
                  <td data-row="13" data-col="7">0</td>
                  <td data-row="13" data-col="8">0</td>
                  <td data-row="13" data-col="9">0</td>
                  <td data-row="13" data-col="10">0</td>
                  <td data-row="13" data-col="11">0</td>
                  <td data-row="13" data-col="12">0</td>
                  <td data-row="13" data-col="13">0</td>
                  <td data-row="13" data-col="14">0</td>
                  <td data-row="13" data-col="15">0</td>
                  <td data-row="13" data-col="16">0</td>
                  <td data-row="13" data-col="17">0</td>
                  <td data-row="13" data-col="18">0</td>
                  <td data-row="13" data-col="19">0</td>
                  <td data-row="13" data-col="20">0</td>
                  <td data-row="13" data-col="21">0</td>
                  <td data-row="13" data-col="22">0</td>
                  <td data-row="13" data-col="23">0</td>
                  <td data-row="13" data-col="24">0</td>
                  <td data-row="13" data-col="25">0</td>
                  <td data-row="13" data-col="26">0</td>
                  <td data-row="13" data-col="27">0</td>
                  <td data-row="13" data-col="28">0</td>
                  <td data-row="13" data-col="29">0</td>
                  <td data-row="13" data-col="30">0</td>
                  <td data-row="13" data-col="31">0</td>
                  <td data-row="13" data-col="32">0</td>
                  <td data-row="13" data-col="33">0</td>
                  <td data-row="13" data-col="34">0</td>
                  <td data-row="13" data-col="35">0</td>
                  <td data-row="13" data-col="36">651473.2</td>
                  <td data-row="13" data-col="37">1</td>
                  <td data-row="13" data-col="38">2005</td>
                  <td data-row="13" data-col="39">-4</td>
                </tr>
                <tr>
                  <td data-row="14" data-col="1">Alaska</td>
                  <td data-row="14" data-col="2">2</td>
                  <td data-row="14" data-col="3">2002</td>
                  <td data-row="14" data-col="4">2005</td>
                  <td data-row="14" data-col="5">1.665124</td>
                  <td data-row="14" data-col="6">0</td>
                  <td data-row="14" data-col="7">0</td>
                  <td data-row="14" data-col="8">0</td>
                  <td data-row="14" data-col="9">0</td>
                  <td data-row="14" data-col="10">0</td>
                  <td data-row="14" data-col="11">0</td>
                  <td data-row="14" data-col="12">0</td>
                  <td data-row="14" data-col="13">0</td>
                  <td data-row="14" data-col="14">0</td>
                  <td data-row="14" data-col="15">0</td>
                  <td data-row="14" data-col="16">0</td>
                  <td data-row="14" data-col="17">0</td>
                  <td data-row="14" data-col="18">0</td>
                  <td data-row="14" data-col="19">0</td>
                  <td data-row="14" data-col="20">0</td>
                  <td data-row="14" data-col="21">0</td>
                  <td data-row="14" data-col="22">0</td>
                  <td data-row="14" data-col="23">0</td>
                  <td data-row="14" data-col="24">0</td>
                  <td data-row="14" data-col="25">0</td>
                  <td data-row="14" data-col="26">0</td>
                  <td data-row="14" data-col="27">0</td>
                  <td data-row="14" data-col="28">0</td>
                  <td data-row="14" data-col="29">0</td>
                  <td data-row="14" data-col="30">0</td>
                  <td data-row="14" data-col="31">0</td>
                  <td data-row="14" data-col="32">0</td>
                  <td data-row="14" data-col="33">0</td>
                  <td data-row="14" data-col="34">0</td>
                  <td data-row="14" data-col="35">0</td>
                  <td data-row="14" data-col="36">651473.2</td>
                  <td data-row="14" data-col="37">1</td>
                  <td data-row="14" data-col="38">2005</td>
                  <td data-row="14" data-col="39">-3</td>
                </tr>
                <tr>
                  <td data-row="15" data-col="1">Alaska</td>
                  <td data-row="15" data-col="2">2</td>
                  <td data-row="15" data-col="3">2003</td>
                  <td data-row="15" data-col="4">2005</td>
                  <td data-row="15" data-col="5">1.823279</td>
                  <td data-row="15" data-col="6">0</td>
                  <td data-row="15" data-col="7">0</td>
                  <td data-row="15" data-col="8">0</td>
                  <td data-row="15" data-col="9">0</td>
                  <td data-row="15" data-col="10">0</td>
                  <td data-row="15" data-col="11">0</td>
                  <td data-row="15" data-col="12">0</td>
                  <td data-row="15" data-col="13">0</td>
                  <td data-row="15" data-col="14">0</td>
                  <td data-row="15" data-col="15">0</td>
                  <td data-row="15" data-col="16">0</td>
                  <td data-row="15" data-col="17">0</td>
                  <td data-row="15" data-col="18">0</td>
                  <td data-row="15" data-col="19">0</td>
                  <td data-row="15" data-col="20">0</td>
                  <td data-row="15" data-col="21">0</td>
                  <td data-row="15" data-col="22">0</td>
                  <td data-row="15" data-col="23">0</td>
                  <td data-row="15" data-col="24">0</td>
                  <td data-row="15" data-col="25">0</td>
                  <td data-row="15" data-col="26">0</td>
                  <td data-row="15" data-col="27">0</td>
                  <td data-row="15" data-col="28">0</td>
                  <td data-row="15" data-col="29">0</td>
                  <td data-row="15" data-col="30">0</td>
                  <td data-row="15" data-col="31">0</td>
                  <td data-row="15" data-col="32">0</td>
                  <td data-row="15" data-col="33">0</td>
                  <td data-row="15" data-col="34">0</td>
                  <td data-row="15" data-col="35">0</td>
                  <td data-row="15" data-col="36">651473.2</td>
                  <td data-row="15" data-col="37">1</td>
                  <td data-row="15" data-col="38">2005</td>
                  <td data-row="15" data-col="39">-2</td>
                </tr>
        </tbody>
      </table>
    </div>
<!-- hack to avoid NA insertion in last line -->
</div>
</div>
</div>
</div>
</div>
<p><code>base_stagg</code>に関して、<code>year_treated</code>が10000、<code>time_to_treatment</code>が-1000となっているユニットがありますが、これは<strong>処置を受けないユニット（never-treated）</strong>を示しています。</p>
<p>fixesが内部的に使用している<code>fixest::sunab()</code>関数は、<code>year_treated</code>にデータの<code>year</code>の範囲外にある大きな値（ここでは10000）を設定することで、これらを自動的にnever-treatedとして認識し、<strong>参照グループ（対照群）</strong>として扱います。<code>time_to_treatment</code>にも同様に極端に小さい負の値（-1000）を設定しています。</p>
<p>これは、Staggered DIDにおいてnever-treatedのユニットの値を<code>NA</code>にしてしまうと、推定から完全に除外されてしまい、処置群と比較する対照群が失われてしまうためです。Never-treatedは処置効果を識別するための重要な比較対象なので、データに含める必要があります。</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb5" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># never-treatedの確認</span></span>
<span id="cb5-2">base_stagg <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb5-3">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">filter</span>(year_treated <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10000</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb5-4">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">select</span>(id, year, year_treated, time_to_treatment, treated) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb5-5">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">head</span>()</span></code></pre></div></div>
<div class="cell-output cell-output-stdout">
<pre><code>  id year year_treated time_to_treatment treated
1 81    1        10000             -1000       0
2 80    1        10000             -1000       0
3 79    1        10000             -1000       0
4 78    1        10000             -1000       0
5 77    1        10000             -1000       0
6 76    1        10000             -1000       0</code></pre>
</div>
</div>
<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
<span class="screen-reader-only">Tip</span>Never-treatedユニットの扱いについて
</div>
</div>
<div class="callout-body-container callout-body">
<p>Staggered DIDのデータセットをご自分で用意される場合も、never-treatedのユニットには同様の処理が必要です：</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb7" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 例：処置年がNAのユニットをnever-treatedとして設定</span></span>
<span id="cb7-2">df <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> df <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb7-3">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mutate</span>(</span>
<span id="cb7-4">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">year_treated =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">if_else</span>(</span>
<span id="cb7-5">      <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">is.na</span>(year_treated),</span>
<span id="cb7-6">      <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">max</span>(year, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">na.rm =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">TRUE</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1000</span>,  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># または10000など</span></span>
<span id="cb7-7">      year_treated</span>
<span id="cb7-8">    ),</span>
<span id="cb7-9">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">time_to_treatment =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">if_else</span>(</span>
<span id="cb7-10">      year_treated <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">max</span>(year),  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># never-treatedの条件</span></span>
<span id="cb7-11">      <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1000</span>,</span>
<span id="cb7-12">      year <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> year_treated</span>
<span id="cb7-13">    )</span>
<span id="cb7-14">  )</span></code></pre></div></div>
<p><strong>ポイント</strong>：<code>year_treated</code>はデータの時間範囲外の大きな値（例：10000）、<code>time_to_treatment</code>は極端に小さい負の値（例：-1000）を設定します。これにより、fixesの内部処理（fixest）が適切にnever-treatedを認識します。</p>
</div>
</div>
</section>
<section id="run_es" class="level2">
<h2 class="anchored" data-anchor-id="run_es"><code>run_es()</code></h2>
<p>基本的な使い方と一緒にパッケージについて説明していきます。関数はイベントスタディを実行する<code>run_es()</code>関数とイベントスタディをggplotベースでプロットする<code>plot_es()</code>です。</p>
<p>ひとまず、<code>run_es()</code>の基本的な引数を説明します。</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb8" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb8-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">run_es</span>(</span>
<span id="cb8-2">  data,</span>
<span id="cb8-3">  outcome,</span>
<span id="cb8-4">  treatment,</span>
<span id="cb8-5">  time,</span>
<span id="cb8-6">  timing,</span>
<span id="cb8-7">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">fe =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">NULL</span>,</span>
<span id="cb8-8">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">lead_range =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">NULL</span>,</span>
<span id="cb8-9">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">lag_range =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">NULL</span>,</span>
<span id="cb8-10">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">covariates =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">NULL</span>,</span>
<span id="cb8-11">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">cluster =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">NULL</span>,</span>
<span id="cb8-12">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">weights =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">NULL</span>,</span>
<span id="cb8-13">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">baseline =</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>L,</span>
<span id="cb8-14">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">interval =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>,</span>
<span id="cb8-15">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">time_transform =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">FALSE</span>,</span>
<span id="cb8-16">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">unit =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">NULL</span>,</span>
<span id="cb8-17">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">staggered =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">FALSE</span>,</span>
<span id="cb8-18">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">method =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"classic"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"sunab"</span>),</span>
<span id="cb8-19">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">conf.level =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.95</span>,</span>
<span id="cb8-20">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">vcov =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"HC1"</span>,</span>
<span id="cb8-21">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">vcov_args =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">list</span>()</span>
<span id="cb8-22">)</span></code></pre></div></div>
<table class="caption-top table">
<colgroup>
<col style="width: 25%">
<col style="width: 75%">
</colgroup>
<thead>
<tr class="header">
<th style="text-align: left;">引数</th>
<th style="text-align: left;">説明</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;"><code>data</code></td>
<td style="text-align: left;">パネルデータを含むデータフレーム</td>
</tr>
<tr class="even">
<td style="text-align: left;"><code>outcome</code></td>
<td style="text-align: left;">結果変数（変数名または式、例：<code>log(y)</code>のように記述）</td>
</tr>
<tr class="odd">
<td style="text-align: left;"><code>treatment</code></td>
<td style="text-align: left;">処置変数（0/1または論理値）。<code>method = "classic"</code>の場合のみ使用</td>
</tr>
<tr class="even">
<td style="text-align: left;"><code>time</code></td>
<td style="text-align: left;">時間変数（数値型またはDate型）</td>
</tr>
<tr class="odd">
<td style="text-align: left;"><code>timing</code></td>
<td style="text-align: left;">classicの場合：処置タイミング（全ユニット共通の数値/Dateまたは<code>staggered = TRUE</code>時は変数名）。sunabの場合：処置採用時点を示す変数</td>
</tr>
<tr class="even">
<td style="text-align: left;"><code>fe</code></td>
<td style="text-align: left;">固定効果の指定（片側式、例：<code>~ id + year</code>）。固定効果なしの場合は<code>NULL</code></td>
</tr>
<tr class="odd">
<td style="text-align: left;"><code>lead_range</code>, <code>lag_range</code></td>
<td style="text-align: left;">処置前後の期間範囲を指定する整数。<code>NULL</code>の場合は自動決定</td>
</tr>
<tr class="even">
<td style="text-align: left;"><code>covariates</code></td>
<td style="text-align: left;">追加の共変量（片側式、例：<code>~ x1 + log(x2)</code>）</td>
</tr>
<tr class="odd">
<td style="text-align: left;"><code>cluster</code></td>
<td style="text-align: left;">クラスター指定（片側式<code>~ id + year</code>、列名の文字列、または<code>nrow(data)</code>の長さのベクトル）</td>
</tr>
<tr class="even">
<td style="text-align: left;"><code>weights</code></td>
<td style="text-align: left;">観測ウェイト（変数名/片側式または<code>nrow(data)</code>の長さの数値ベクトル）</td>
</tr>
<tr class="odd">
<td style="text-align: left;"><code>baseline</code></td>
<td style="text-align: left;">ベースライン期間（デフォルト：-1）。“classic”と”sunab”の両方で、参照期間として結果から除外される</td>
</tr>
<tr class="even">
<td style="text-align: left;"><code>interval</code></td>
<td style="text-align: left;">時間変数の間隔（デフォルト：1。Date型の場合は内部で無視される）</td>
</tr>
<tr class="odd">
<td style="text-align: left;"><code>time_transform</code></td>
<td style="text-align: left;"><code>TRUE</code>の場合、ユニット内で連続した整数時間を作成</td>
</tr>
<tr class="even">
<td style="text-align: left;"><code>unit</code></td>
<td style="text-align: left;">ユニット識別変数（<code>time_transform = TRUE</code>の場合は必須。指定時はメタデータにも使用）</td>
</tr>
<tr class="odd">
<td style="text-align: left;"><code>staggered</code></td>
<td style="text-align: left;"><code>TRUE</code>の場合、timing変数を使用（classicの場合）またはsunabで利用</td>
</tr>
<tr class="even">
<td style="text-align: left;"><code>method</code></td>
<td style="text-align: left;"><code>"classic"</code>または<code>"sunab"</code>を指定（デフォルト：<code>"classic"</code>）</td>
</tr>
<tr class="odd">
<td style="text-align: left;"><code>conf.level</code></td>
<td style="text-align: left;">信頼水準（デフォルト：0.95）。数値ベクトルで複数指定可能</td>
</tr>
<tr class="even">
<td style="text-align: left;"><code>vcov</code></td>
<td style="text-align: left;">分散共分散行列の種類。<code>fixest::vcov()</code>または<code>broom::tidy(vcov = ...)</code>に渡される（デフォルト：<code>"HC1"</code>）</td>
</tr>
<tr class="odd">
<td style="text-align: left;"><code>vcov_args</code></td>
<td style="text-align: left;"><code>fixest::vcov()</code>に渡す追加引数のリスト</td>
</tr>
</tbody>
</table>
<p>文字で見てもわかりにくいと思うので、読み込んだデータを使って関数を回してみましょう。</p>
<section id="sec-basic-es" class="level3">
<h3 class="anchored" data-anchor-id="sec-basic-es">通常のDiDにおけるイベントスタディ</h3>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb9" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb9-1">es <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">run_es</span>(</span>
<span id="cb9-2">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">data =</span> base_did,</span>
<span id="cb9-3">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">outcome =</span> y,</span>
<span id="cb9-4">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">treatment =</span> treat,</span>
<span id="cb9-5">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">time =</span> period,</span>
<span id="cb9-6">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">timing =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">6</span>,</span>
<span id="cb9-7">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">fe =</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span> id <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> period</span>
<span id="cb9-8">)</span></code></pre></div></div>
</div>
<p>基本的なケースであればこれくらいの指定で済みます。プロットは後のセクションでまとめて載せます。</p>
</section>
<section id="staggered-did-1" class="level3">
<h3 class="anchored" data-anchor-id="staggered-did-1">Staggered DiD 1</h3>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb10" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb10-1">es_stagg1 <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">run_es</span>(</span>
<span id="cb10-2">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">data =</span> base_stagg,</span>
<span id="cb10-3">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">outcome =</span> y,</span>
<span id="cb10-4">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">treatment =</span> treated,</span>
<span id="cb10-5">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">time =</span> year,</span>
<span id="cb10-6">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">timing =</span> year_treated,</span>
<span id="cb10-7">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">fe =</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span> id <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> year,</span>
<span id="cb10-8">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">staggered =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">TRUE</span>,</span>
<span id="cb10-9">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">method =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"sunab"</span></span>
<span id="cb10-10">)</span></code></pre></div></div>
</div>
<p>先ほどと違う点は、<code>staggered</code>がTRUE、<code>method</code>が”sunab”、<code>timing</code>が具体的な数値ではなく、処置年を示す変数を指定しているところです。</p>
<p>“sunab”は<a href="https://www.sciencedirect.com/science/article/abs/pii/S030440762030378X">Sun and Abraham (2021)</a>で提唱されている方法を指し、Staggered DiDにおけるイベントスタディで有用です。裏では<code>fixest::sunab()</code>関数を使っています。</p>
</section>
<section id="staggered-did-2" class="level3">
<h3 class="anchored" data-anchor-id="staggered-did-2">Staggered DiD 2</h3>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb11" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb11-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 共変量の変数を式の形にしておく</span></span>
<span id="cb11-2">covariates <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">as.formula</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">paste</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"~"</span>, <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">paste</span>(region, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">collapse =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"+"</span>)))</span>
<span id="cb11-3"></span>
<span id="cb11-4">es_stagg2 <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">run_es</span>(</span>
<span id="cb11-5">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">data =</span> df_castle,</span>
<span id="cb11-6">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">outcome =</span> l_homicide,</span>
<span id="cb11-7">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">treatment =</span> is_treated,</span>
<span id="cb11-8">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">time =</span> year,</span>
<span id="cb11-9">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">timing =</span> year_treated,</span>
<span id="cb11-10">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">fe =</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span> state <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> year,</span>
<span id="cb11-11">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">covariates =</span> covariates,</span>
<span id="cb11-12">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">cluster =</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span> sid,</span>
<span id="cb11-13">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">weights =</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span> popwt,</span>
<span id="cb11-14">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">baseline =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>,</span>
<span id="cb11-15">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">staggered =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">TRUE</span>,</span>
<span id="cb11-16">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">vcov =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"cluster"</span></span>
<span id="cb11-17">)</span></code></pre></div></div>
</div>
<p>今回の例は共変量が多いので事前に<code>as.formula()</code>を使って処理してしまっていますが、関数内で<code>covariates = ~ cov1 + cov2</code>のような指定の仕方で問題ありません。</p>
<p>また、ここでは<code>vcov</code>も”cluster”に指定して、<code>sid</code>でクラスタリングした標準誤差を計算しています。<code>vcov</code>については、<code>?fixest::feols()</code>で詳細を確認できます。</p>
</section>
</section>
<section id="plot_es" class="level2">
<h2 class="anchored" data-anchor-id="plot_es"><code>plot_es()</code></h2>
<p>こだわりがなければ、<code>plot_es(es)</code>の程度の書き方でプロットを出力することができます。引数の説明は後に回して、一旦先ほどのイベントスタディの結果をプロットしてみましょう。</p>
<section id="通常のdidにおけるイベントスタディ" class="level3">
<h3 class="anchored" data-anchor-id="通常のdidにおけるイベントスタディ">通常のDiDにおけるイベントスタディ</h3>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb12" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb12-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">plot_es</span>(es)</span></code></pre></div></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="https://yo5uke.com/pages/tips/2025/05/250525_fixes/index_files/figure-html/unnamed-chunk-10-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>後の2つもそうですが、ベースラインがデフォルトのままなので、処置前年（-1）が抜けて値が0をとっています。</p>
</section>
<section id="staggered-did-1-1" class="level3">
<h3 class="anchored" data-anchor-id="staggered-did-1-1">Staggered DiD 1</h3>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb13" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb13-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">plot_es</span>(es_stagg1)</span></code></pre></div></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="https://yo5uke.com/pages/tips/2025/05/250525_fixes/index_files/figure-html/unnamed-chunk-11-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="staggered-did-2-1" class="level3">
<h3 class="anchored" data-anchor-id="staggered-did-2-1">Staggered DiD 2</h3>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb14" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb14-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">plot_es</span>(es_stagg2)</span></code></pre></div></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="https://yo5uke.com/pages/tips/2025/05/250525_fixes/index_files/figure-html/unnamed-chunk-12-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>Staggeredの方もいい感じにプロットできています。この図はMixtape内でlead変数とlag変数を手作業で作って実装しプロットされていますが、<a href="https://mixtape.scunning.com/09-difference_in_differences#fig-event-cheng2">その図</a>と見比べても同じ推移が示されていることがわかります。</p>
</section>
<section id="使い方" class="level3">
<h3 class="anchored" data-anchor-id="使い方">使い方</h3>
<p>基本的には上の使い方で十分ですが、ggplotベースで作ったこともあり、柔軟な対応も可能です。</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb15" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb15-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">plot_es</span>(</span>
<span id="cb15-2">  data,</span>
<span id="cb15-3">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">type =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"ribbon"</span>,</span>
<span id="cb15-4">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">vline_val =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>,</span>
<span id="cb15-5">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">vline_color =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"#000"</span>,</span>
<span id="cb15-6">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">hline_val =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>,</span>
<span id="cb15-7">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">hline_color =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"#000"</span>,</span>
<span id="cb15-8">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">linewidth =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>,</span>
<span id="cb15-9">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">pointsize =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>,</span>
<span id="cb15-10">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">alpha =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.2</span>,</span>
<span id="cb15-11">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">barwidth =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.2</span>,</span>
<span id="cb15-12">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">color =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"#B25D91FF"</span>,</span>
<span id="cb15-13">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">fill =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"#B25D91FF"</span></span>
<span id="cb15-14">)</span></code></pre></div></div>
<ul>
<li><code>data</code>：<code>run_es()</code>で作成した結果のデータフレーム</li>
<li><code>type</code>：<code>ribbon</code>と<code>errorbar</code>が指定可能</li>
<li><code>vline_val</code>：縦の破線の位置（デフォルトは0）</li>
<li><code>vline_color</code>：縦の破線の色（デフォルトは<code>#000</code>（黒））</li>
<li><code>hline_val</code>：横の破線の位置（デフォルトは0）</li>
<li><code>hline_color</code>：縦の破線の色（デフォルトは<code>#000</code>（黒））</li>
<li><code>linewidth</code>：折れ線の太さ（デフォルトは1）</li>
<li><code>pointsize</code>：点の大きさ（デフォルトは2）</li>
<li><code>alpha</code>：リボンの透明度（デフォルトは0.2）</li>
<li><code>color</code>：線と点の色（デフォルトは<code>#B25D91FF</code>（ピンク））</li>
<li><code>fill</code>リボンの色（デフォルトは<code>#B25D91FF</code>（ピンク））</li>
</ul>
<hr>
<p><code>plot_es()</code>関数内でもある程度自由度をもって設定できます。<br>
例えばプロットをエラーバーのタイプにしてみましょう。</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb16" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb16-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">plot_es</span>(es_stagg2, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">type =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"errorbar"</span>)</span></code></pre></div></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="https://yo5uke.com/pages/tips/2025/05/250525_fixes/index_files/figure-html/unnamed-chunk-13-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>さらに色も変えてみます。</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb17" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb17-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">plot_es</span>(es_stagg2, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">type =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"errorbar"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">color =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"#000"</span>)</span></code></pre></div></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="https://yo5uke.com/pages/tips/2025/05/250525_fixes/index_files/figure-html/unnamed-chunk-14-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>リボンタイプとエラーバータイプがあり、さらにそこからある程度の自由度もある点が他のパッケージに対する優位性にもなっています。</p>
<p>ちなみに、ggplotベースということで、<strong>ggplotの関数をつなげることも可能です</strong>！</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb18" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb18-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">plot_es</span>(es_stagg2, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">type =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"errorbar"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">color =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"#000"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb18-2">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_hline</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">yintercept =</span> .<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">08</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">color =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"red"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb18-3">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">annotate</span>(</span>
<span id="cb18-4">    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"text"</span>,</span>
<span id="cb18-5">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>,</span>
<span id="cb18-6">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y =</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>.<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>,</span>
<span id="cb18-7">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">label =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"DD Coefficient = 0.08</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">\n</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">(s.e. = 0.03)"</span></span>
<span id="cb18-8">  )</span></code></pre></div></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="https://yo5uke.com/pages/tips/2025/05/250525_fixes/index_files/figure-html/unnamed-chunk-15-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>Mixtape風に係数を示す水平線と注釈を追加してみました。このようにどんどん要素を追加していくことができます。</p>
</section>
</section>
<section id="plot_es_interactive" class="level2">
<h2 class="anchored" data-anchor-id="plot_es_interactive"><code>plot_es_interactive()</code></h2>
<p><code>plot_es()</code>で作成したプロットをインタラクティブにする関数も用意しています。<code>plot_es_interactive()</code>です。</p>
<p>この関数で表示したプロットは、マウスオーバーで各点の推定値と信頼区間が表示されたり、ズームイン・ズームアウトができたりします。</p>
<p>論文に載せるための関数ではないものの、結果の確認やコミュニケーションの際に便利かと思います。</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb19" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb19-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">plot_es_interactive</span>(es_stagg2)</span></code></pre></div></div>
<div class="cell-output-display">
<div class="plotly html-widget html-fill-item" id="htmlwidget-d3089e693b03f3b60eeb" style="width:100%;height:464px;"></div>
<script type="application/json" data-for="htmlwidget-d3089e693b03f3b60eeb">{"x":{"visdat":{"3971753d59c39":["function () ","plotlyVisDat"],"3971769e8a447":["function () ","data"],"3971743e6c799":["function () ","data"]},"cur_data":"3971743e6c799","attrs":{"3971769e8a447":{"alpha_stroke":1,"sizes":[10,100],"spans":[1,20],"x":{},"ymin":{},"ymax":{},"type":"scatter","mode":"lines","hoveron":"points","fill":"toself","fillcolor":"#B25D91FF","opacity":0.20000000000000001,"line":{"width":0},"name":"95% CI","hoverinfo":"skip","showlegend":false,"inherit":true},"3971743e6c799":{"alpha_stroke":1,"sizes":[10,100],"spans":[1,20],"x":{},"y":{},"type":"scatter","mode":"lines+markers","line":{"color":"#B25D91FF","width":2},"marker":{"size":8,"color":"#B25D91FF","line":{"color":"#fff","width":1}},"text":{},"hoverinfo":"text","name":"Estimate","showlegend":false,"inherit":true},"3971743e6c799.1":{"x":0,"y":-0.50989931672728306,"xend":0,"yend":0.31039673759402214,"type":"scatter","mode":"lines","line":{"color":"#000","dash":"dash","width":1},"hoverinfo":"skip","showlegend":false,"inherit":false},"3971743e6c799.2":{"x":-9.5,"y":0,"xend":5.5,"yend":0,"type":"scatter","mode":"lines","line":{"color":"#000","dash":"dash","width":1},"hoverinfo":"skip","showlegend":false,"inherit":false}},"layout":{"margin":{"b":40,"l":60,"t":25,"r":10},"xaxis":{"domain":[0,1],"automargin":true,"title":"Relative Time to Treatment","zeroline":false,"gridcolor":"#eee"},"yaxis":{"domain":[0,1],"automargin":true,"title":"Estimate and 95% CI","zeroline":false,"gridcolor":"#eee"},"plot_bgcolor":"#fff","paper_bgcolor":"#fff","hovermode":"closest","font":{"family":"Arial, sans-serif","size":12},"showlegend":false},"source":"A","config":{"modeBarButtonsToAdd":["hoverclosest","hovercompare"],"showSendToCloud":false,"displayModeBar":true,"modeBarButtonsToRemove":["pan2d","select2d","lasso2d","autoScale2d","hoverClosestCartesian","hoverCompareCartesian"],"displaylogo":false},"data":[{"fillcolor":"#B25D91FF","x":[-9,-8,-7,-6,-5,-4,-3,-2,-1,0,1,2,3,4,5,5,5,4,3,2,1,0,-1,-2,-3,-4,-5,-6,-7,-8,-9],"type":"scatter","mode":"lines","hoveron":"points","fill":"toself","opacity":0.20000000000000001,"line":{"color":"rgba(31,119,180,1)","width":0},"name":"95% CI","hoverinfo":["skip","skip","skip","skip","skip","skip","skip","skip","skip","skip","skip","skip","skip","skip","skip","skip","skip","skip","skip","skip","skip","skip","skip","skip","skip","skip","skip","skip","skip","skip","skip"],"showlegend":false,"y":[-0.34889119862968465,-0.4635448333884391,-0.30635153005793792,-0.1075653381547883,-0.087207508348462942,-0.095293663933610079,-0.056318095764794573,-0.041900590706245439,-0.090185715407510539,0,0.022492298071371736,-0.006383439959123216,0.0012144854730531673,-0.036785863838321206,0.062650551310018412,0.062650551310018412,0.28217885235820195,0.19410074693115553,0.20882889735161098,0.17120528888061248,0.13293074761703191,0,0.039145684663557154,0.080065717028417402,0.080672620425189773,0.087182537629335144,0.097121962832330211,0.12614116209770954,0.031961736744468727,-0.14358021949674507,-0.17247983014924606],"marker":{"color":"rgba(31,119,180,1)","line":{"color":"rgba(31,119,180,1)"}},"error_y":{"color":"rgba(31,119,180,1)"},"error_x":{"color":"rgba(31,119,180,1)"},"xaxis":"x","yaxis":"y","frame":null},{"x":[-9,-8,-7,-6,-5,-4,-3,-2,-1,0,1,2,3,4,5],"y":[-0.26068551438946536,-0.30356252644259207,-0.13719489665673459,0.0092879119714606162,0.0049572272419336292,-0.0040555631521374674,0.012177262330197598,0.019082563161085982,-0.025520015371976689,0,0.077711522844201825,0.082410924460744633,0.10502169141233207,0.07865744154641717,0.17241470183411017],"type":"scatter","mode":"lines+markers","line":{"color":"#B25D91FF","width":2},"marker":{"color":"#B25D91FF","size":8,"line":{"color":"#fff","width":1}},"text":["<b>Relative Time:<\/b> -9<br><b>Estimate:<\/b> -0.2607<br><b>Std. Error:<\/b> 0.0450<br><b>95% CI:<\/b> [-0.3489, -0.1725]<br><b>P-value:<\/b> 0.0000","<b>Relative Time:<\/b> -8<br><b>Estimate:<\/b> -0.3036<br><b>Std. Error:<\/b> 0.0816<br><b>95% CI:<\/b> [-0.4635, -0.1436]<br><b>P-value:<\/b> 0.0002","<b>Relative Time:<\/b> -7<br><b>Estimate:<\/b> -0.1372<br><b>Std. Error:<\/b> 0.0863<br><b>95% CI:<\/b> [-0.3064, 0.0320]<br><b>P-value:<\/b> 0.1126","<b>Relative Time:<\/b> -6<br><b>Estimate:<\/b> 0.0093<br><b>Std. Error:<\/b> 0.0596<br><b>95% CI:<\/b> [-0.1076, 0.1261]<br><b>P-value:<\/b> 0.8763","<b>Relative Time:<\/b> -5<br><b>Estimate:<\/b> 0.0050<br><b>Std. Error:<\/b> 0.0470<br><b>95% CI:<\/b> [-0.0872, 0.0971]<br><b>P-value:<\/b> 0.9161","<b>Relative Time:<\/b> -4<br><b>Estimate:<\/b> -0.0041<br><b>Std. Error:<\/b> 0.0466<br><b>95% CI:<\/b> [-0.0953, 0.0872]<br><b>P-value:<\/b> 0.9306","<b>Relative Time:<\/b> -3<br><b>Estimate:<\/b> 0.0122<br><b>Std. Error:<\/b> 0.0349<br><b>95% CI:<\/b> [-0.0563, 0.0807]<br><b>P-value:<\/b> 0.7277","<b>Relative Time:<\/b> -2<br><b>Estimate:<\/b> 0.0191<br><b>Std. Error:<\/b> 0.0311<br><b>95% CI:<\/b> [-0.0419, 0.0801]<br><b>P-value:<\/b> 0.5400","<b>Relative Time:<\/b> -1<br><b>Estimate:<\/b> -0.0255<br><b>Std. Error:<\/b> 0.0330<br><b>95% CI:<\/b> [-0.0902, 0.0391]<br><b>P-value:<\/b> 0.4396","<b>Relative Time:<\/b> 0<br><b>Estimate:<\/b> 0.0000<br><b>Std. Error:<\/b> 0.0000<br><b>95% CI:<\/b> [0.0000, 0.0000]<br><b>P-value:<\/b> NA","<b>Relative Time:<\/b> 1<br><b>Estimate:<\/b> 0.0777<br><b>Std. Error:<\/b> 0.0282<br><b>95% CI:<\/b> [0.0225, 0.1329]<br><b>P-value:<\/b> 0.0060","<b>Relative Time:<\/b> 2<br><b>Estimate:<\/b> 0.0824<br><b>Std. Error:<\/b> 0.0453<br><b>95% CI:<\/b> [-0.0064, 0.1712]<br><b>P-value:<\/b> 0.0696","<b>Relative Time:<\/b> 3<br><b>Estimate:<\/b> 0.1050<br><b>Std. Error:<\/b> 0.0530<br><b>95% CI:<\/b> [0.0012, 0.2088]<br><b>P-value:<\/b> 0.0480","<b>Relative Time:<\/b> 4<br><b>Estimate:<\/b> 0.0787<br><b>Std. Error:<\/b> 0.0589<br><b>95% CI:<\/b> [-0.0368, 0.1941]<br><b>P-value:<\/b> 0.1824","<b>Relative Time:<\/b> 5<br><b>Estimate:<\/b> 0.1724<br><b>Std. Error:<\/b> 0.0560<br><b>95% CI:<\/b> [0.0627, 0.2822]<br><b>P-value:<\/b> 0.0022"],"hoverinfo":["text","text","text","text","text","text","text","text","text","text","text","text","text","text","text"],"name":"Estimate","showlegend":false,"error_y":{"color":"rgba(255,127,14,1)"},"error_x":{"color":"rgba(255,127,14,1)"},"xaxis":"x","yaxis":"y","frame":null},{"x":[0,0],"y":[-0.50989931672728306,0.31039673759402214],"type":"scatter","mode":"lines","line":{"color":"#000","dash":"dash","width":1},"hoverinfo":["skip","skip"],"showlegend":false,"marker":{"color":"rgba(44,160,44,1)","line":{"color":"rgba(44,160,44,1)"}},"error_y":{"color":"rgba(44,160,44,1)"},"error_x":{"color":"rgba(44,160,44,1)"},"xaxis":"x","yaxis":"y","frame":null},{"x":[-9.5,5.5],"y":[0,0],"type":"scatter","mode":"lines","line":{"color":"#000","dash":"dash","width":1},"hoverinfo":["skip","skip"],"showlegend":false,"marker":{"color":"rgba(214,39,40,1)","line":{"color":"rgba(214,39,40,1)"}},"error_y":{"color":"rgba(214,39,40,1)"},"error_x":{"color":"rgba(214,39,40,1)"},"xaxis":"x","yaxis":"y","frame":null}],"highlight":{"on":"plotly_click","persistent":false,"dynamic":false,"selectize":false,"opacityDim":0.20000000000000001,"selected":{"opacity":1},"debounce":0},"shinyEvents":["plotly_hover","plotly_click","plotly_selected","plotly_relayout","plotly_brushed","plotly_brushing","plotly_clickannotation","plotly_doubleclick","plotly_deselect","plotly_afterplot","plotly_sunburstclick"],"base_url":"https://plot.ly"},"evals":[],"jsHooks":[]}</script>
</div>
</div>
<p>マウスオーバーすると値が表示されます。</p>
<p>こちらも<code>plot_es()</code>と同様に、引数で色や線の太さなどを指定できますので、いろいろ試してみてください。</p>
</section>
<section id="おわりに" class="level2">
<h2 class="anchored" data-anchor-id="おわりに">おわりに</h2>
<p>まだまだ開発途上ですが、staggeredまで対応できたので、これからしばらくはブラッシュアップを念頭にアップデートしていこうと思います。</p>
<p>冒頭にも書きましたが、もし使っていただいて「使いにくい」や「こんな機能が欲しい」等ありましたら、以下のコメントやGitHubの<a href="https://github.com/yo5uke/fixes/issues">Issues</a>までお願いします。</p>
</section>
<section id="データ出典" class="level2">
<h2 class="anchored" data-anchor-id="データ出典">🔗 データ出典</h2>
<p>データ出典：<a href="https://mixtape.scunning.com/">Causal Inference: The Mixtape</a>（Scott Cunnningham, 2021）<br>
データはGitHub上で公開されており、以下のリポジトリから入手可能です：</p>
<p><a href="https://github.com/scunning1975/mixtape" class="uri">https://github.com/scunning1975/mixtape</a></p>
<p>また、データはMITライセンスのもとで提供されています。</p>


<!-- -->

</section>


<div id="quarto-appendix" class="default"><section id="footnotes" class="footnotes footnotes-end-of-document"><h2 class="anchored quarto-appendix-heading">注</h2>

<ol>
<li id="fn1"><p>参考：<a href="https://mixtape.scunning.com/09-difference_in_differences#replicating-cheng2013-sort-of">Mixtape</a>↩︎</p></li>
</ol>
</section></div> ]]></description>
  <category>R</category>
  <guid>https://yo5uke.com/pages/tips/2025/05/250525_fixes/</guid>
  <pubDate>Sat, 24 May 2025 15:00:00 GMT</pubDate>
</item>
</channel>
</rss>
